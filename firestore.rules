rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuth() {
      return request.auth != null;
    }

    /* =====================
       DONN√âES PUBLIQUES
    ===================== */
    match /villes/{id} {
      allow get, list: if true;
    }

    match /paymentMethods/{id} {
      allow get, list: if true;
    }

    /* =====================
       COMPAGNIES / AGENCES
    ===================== */
    match /companies/{companyId} {
      allow get, list: if true;

      match /agences/{agencyId} {
        allow get, list: if true;

        match /weeklyTrips/{tripId} {
          allow get, list: if true;
        }

        match /reservations/{reservationId} {

          /* üîì Lecture & cr√©ation publiques */
          allow get, list, create: if true;

          /* =============================
             UPDATE 1 ‚Äî APR√àS CR√âATION
             (publicToken / publicUrl)
          ============================= */
          allow update: if (
            request.auth == null &&
            resource.data.canal == "en_ligne" &&
            resource.data.statut == "en_attente_paiement" &&
            request.resource.data.diff(resource.data).changedKeys()
              .hasOnly([
                "publicToken",
                "publicUrl",
                "updatedAt"
              ])
          );

          /* =============================
             UPDATE 2 ‚Äî APR√àS PAIEMENT
             (preuve de paiement)
          ============================= */
          allow update: if (
            request.auth == null &&
            resource.data.canal == "en_ligne" &&
            resource.data.statut == "en_attente_paiement" &&
            request.resource.data.statut == "preuve_recue" &&
            request.resource.data.diff(resource.data).changedKeys()
              .hasOnly([
                "statut",
                "preuveVia",
                "preuveMessage",
                "paymentHint",
                "paymentTriggeredAt",
                "updatedAt"
              ])
          );

          /* üîê Utilisateurs internes */
          allow update, delete: if isAuth();
        }
      }
    }

    /* =====================
       COLLECTION GROUP
    ===================== */
    match /{path=**}/weeklyTrips/{tripId} {
      allow get, list: if true;
    }

    match /{path=**}/reservations/{reservationId} {
      allow get, list: if true;
    }

    /* =====================
       DONN√âES INTERNES
    ===================== */
    match /users/{userId} {
      allow get, list, create, update: if isAuth();
    }

    /* =====================
       COUNTERS (si utilis√©s)
    ===================== */
    match /companies/{companyId}/counters/byTrip/trips/{tripInstanceId} {
      allow get, create, update: if true;
    }

    /* =====================
       FALLBACK S√âCURIT√â
    ===================== */
    match /{path=**} {
      allow get, list, create, update, delete: if isAuth();
    }
  }
}
