rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuth() {
      return request.auth != null;
    }
    
    function uid() {
      return request.auth.uid;
    }
    
    /* =========================
       USERS - Collection globale
       ========================= */
    match /users/{userId} {
      // CRITIQUE: Autoriser la lecture √† tous les utilisateurs authentifi√©s
      // Car les comptables doivent voir les guichetiers, les chefs voient leur √©quipe, etc.
      allow read: if isAuth();
      
      // Cr√©er: seulement √† l'inscription (son propre document)
      allow create: if isAuth() && uid() == userId;
      
      // Mettre √† jour: seulement son propre document
      allow update: if isAuth() && uid() == userId;
      
      // Liste: d√©sactiv√© pour s√©curit√© (utilisation get avec ID sp√©cifique)
      allow list: if false;
    }

    /* =========================
       COMPANIES
       ========================= */
    match /companies/{companyId} {
  // Lire la compagnie seulement si l'utilisateur appartient √† cette compagnie
  allow read: if isAuth()
    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;

  // √âcriture compagnie (√† adapter plus tard)
  allow write: if false;

  match /agences/{agencyId} {
    // Lire l'agence seulement si m√™me compagnie
    allow read: if isAuth()
      && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;

    // √âcriture agence (√† adapter plus tard)
    allow write: if false;

    // üîí TOUTES les sous-collections de l'agence
    match /{collection}/{document} {
      allow read, write: if isAuth()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
    }
  }
}

    /* =========================
       INVITATIONS
       ========================= */
    match /invitations/{invitationId} {
      allow read, write: if isAuth();
    }

    /* =========================
       PUBLIC
       ========================= */
    match /publicProfiles/{hash} {
      allow read: if true;
    }
    
    match /plans/{planId} {
      allow read: if true;
      allow write: if false; // Admin seulement
    }

    /* =========================
       FALLBACK: TOUT REFUSER
       ========================= */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}