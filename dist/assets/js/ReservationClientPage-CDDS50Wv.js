import{d as Mt,u as zt,b as Dt,r as o,j as e,a,C as Et,F as te,o as ke,aH as mt,A as Pe,ar as Tt,P as _t,aI as jt,y as Rt,aA as kt,l as ut,I as Lt}from"./react-KXT1Riez.js";import{o as G,H as Ht,v as Vt,T as _e,q as me,x as je,F as Ft,t as ee,y as ot,u as oe,r as Ne,w as xe}from"./firebase-DYTOaTLw.js";import{d as C,m as ue}from"../index-CBC3XRHi.js";import{i as ct,p as we,a as Se,b as Ot,f as qt,c as Gt}from"./vendor-B27hBV_J.js";function Bt(n){return(n||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}function Jt(n){const l=Bt(n);return l?/(agence\s*)?principal(e)?/.test(l)?"AP":l.split(/\s+/).filter(Boolean).map(P=>P[0]).join("").toUpperCase().slice(0,2):""}async function Yt(n){const{companyId:l,companyCode:w,agencyCode:P,agencyName:ae,tripInstanceId:R,sellerCode:k}=n,T=P&&P.trim()?P.toUpperCase():Jt(ae)||"AG",v=G(C,`companies/${l}/counters/byTrip/trips/${R}`),B=await Ht(C,async z=>{const p=await z.get(v),L=(p.exists()&&p.data().lastSeq||0)+1;return p.exists()?z.update(v,{lastSeq:L,updatedAt:_e.now()}):z.set(v,{lastSeq:L,updatedAt:_e.now()}),L}).catch(async()=>(await Vt(v,{lastSeq:1,updatedAt:_e.now()},{merge:!0}),1));return`${w.toUpperCase()}-${T}-${k}-${String(B).padStart(4,"0")}`}async function Wt(n){return Yt({...n,sellerCode:"WEB"})}const pe="pendingReservation",Ae=n=>["preuve_recue","confirme"].includes(String(n||"").toLowerCase()),lt=n=>{try{localStorage.setItem(pe,JSON.stringify(n))}catch{}},Re=()=>{try{const n=localStorage.getItem(pe);return n?JSON.parse(n):null}catch{return null}},Qt=()=>{try{const n=localStorage.getItem(pe);if(!n)return;const l=JSON.parse(n);Ae(l==null?void 0:l.status)||localStorage.removeItem(pe)}catch{}},Xt=()=>{try{localStorage.removeItem(pe)}catch{}},Zt=(n,l)=>{try{localStorage.setItem(`lastPaymentMethod_${n}`,l)}catch{}},Kt=n=>{if(!n)return null;try{return localStorage.getItem(`lastPaymentMethod_${n}`)}catch{return null}},ea=n=>{if(n)try{localStorage.removeItem(`lastPaymentMethod_${n}`)}catch{}},ta=(n,l)=>{try{localStorage.setItem(`paymentTriggeredAt_${n}`,String(l))}catch{}},aa=n=>{if(!n)return null;try{const l=localStorage.getItem(`paymentTriggeredAt_${n}`);return l?Number(l):null}catch{return null}},ra=n=>{if(n)try{localStorage.removeItem(`paymentTriggeredAt_${n}`)}catch{}},na=()=>Math.random().toString(36).slice(2,8).toUpperCase(),Ce=n=>(n==null?void 0:n.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/-/g," ").replace(/\s+/g," "))||"",it=n=>`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`,Ie=n=>n&&n.charAt(0).toUpperCase()+n.slice(1).toLowerCase(),sa=(n,l)=>new Date(n.getTime()+l*6e4),oa=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],ca=n=>n.replace(/\D/g,"").slice(0,8).replace(/(\d{2})(?=\d)/g,"$1 ").trim(),la=n=>n.replace(/\s/g,"").length===8,dt=({reservationId:n,paymentMethods:l,paymentMethodKey:w,onChoosePayment:P,message:ae,setMessage:R,referenceInputRef:k,canConfirm:T,submitProofInline:v,uploading:B,paymentHints:z,existing:p,selectedTrip:u,seats:L,theme:h})=>{var N;const m=((p==null?void 0:p.statut)==="preuve_recue"||(p==null?void 0:p.statut)==="confirme")??!1,ge=(p==null?void 0:p.statut)==="preuve_recue",H=(p==null?void 0:p.statut)==="confirme",ce=!!w;return a("section",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:[e("h2",{className:"text-sm font-semibold text-gray-900 mb-2",children:n?"Paiement":"Preuve de paiement"}),ge&&a("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[a("div",{className:"flex items-center gap-2 text-blue-800",children:[e(ke,{className:"w-4 h-4"}),e("span",{className:"text-sm font-medium",children:"Preuve envoy√©e"})]}),e("p",{className:"text-xs text-blue-700 mt-1",children:"Votre preuve de paiement est en cours de v√©rification par la compagnie."})]}),H&&a("div",{className:"mb-4 p-3 bg-emerald-50 border border-emerald-200 rounded-lg",children:[a("div",{className:"flex items-center gap-2 text-emerald-800",children:[e(mt,{className:"w-4 h-4"}),e("span",{className:"text-sm font-medium",children:"Paiement confirm√©"})]}),e("p",{className:"text-xs text-emerald-700 mt-1",children:"Votre paiement a √©t√© valid√©. Votre billet est confirm√©."})]}),!m&&a("div",{className:"mb-3",children:[e("h3",{className:"text-sm font-semibold text-gray-900 mb-1",children:"Choisissez votre moyen de paiement"}),e("p",{className:"text-xs text-gray-600",children:"Cliquez sur un moyen de paiement pour continuer"})]}),e("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2",children:Object.entries(l).map(([$,D])=>D&&a("button",{onClick:()=>!m&&P($),disabled:m,className:`h-12 px-3 rounded-xl border flex items-center gap-2 text-sm w-full transition-all duration-200 ${m?"opacity-50 cursor-not-allowed":"cursor-pointer hover:shadow-md hover:-translate-y-0.5"} ${w===$?"bg-white shadow-sm":""}`,style:{borderColor:w===$?h.primary:"#e5e7eb",backgroundColor:!m&&!w?`${h.primary}08`:"#f9fafb",cursor:m?"not-allowed":"pointer"},title:m?"Le paiement a d√©j√† √©t√© trait√©":`Payer avec ${$.replace(/_/g," ")}`,children:[D.logoUrl?e("img",{src:D.logoUrl,alt:$,className:"h-6 w-6 object-contain rounded"}):e("div",{className:"h-6 w-6 rounded bg-gray-100"}),a("div",{className:"text-left min-w-0",children:[e("div",{className:"font-medium capitalize truncate",children:$.replace(/_/g," ")}),D.merchantNumber&&a("div",{className:"text-[11px] text-gray-500 truncate",children:["N¬∞ ",D.merchantNumber]})]}),w===$&&!m&&e("div",{className:"ml-auto h-5 w-5 rounded-full flex items-center justify-center",style:{backgroundColor:h.primary,color:"#fff"},children:e(ut,{className:"w-3 h-3"})})]},$))}),ce&&a(ue.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:"mt-4",children:[a("div",{className:"mb-3",children:[e("h3",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Preuve de paiement"}),e("p",{className:"text-xs text-gray-600 mb-3",children:z}),w&&((N=l[w])==null?void 0:N.ussdPattern)&&!m&&a("div",{className:"mt-1 text-xs text-gray-600",children:["Code USSD : ",e("span",{className:"font-mono bg-gray-50 px-2 py-1 rounded",children:l[w].ussdPattern.replace("MERCHANT",l[w].merchantNumber||"").replace("AMOUNT",String((p==null?void 0:p.montant)||(u?u.price*L:0)))})]})]}),!m&&a(te,{children:[e("div",{className:"mt-3",children:a("div",{children:[e("textarea",{ref:k,rows:3,className:"w-full border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:outline-none",placeholder:"Ex : code re√ßu par SMS (ex. 123456) ou n¬∞ de transfert",value:ae,onChange:$=>R($.target.value)}),e("div",{className:"text-xs text-gray-500 mt-1",children:"Minimum 4 caract√®res"})]})}),a("div",{className:"mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e("div",{className:"text-xs text-amber-600",children:!T&&w&&a("span",{className:"flex items-center gap-1",children:[e(Pe,{className:"w-3 h-3"}),"Entrez une r√©f√©rence (‚â• 4 caract√®res)"]})}),e("button",{onClick:v,disabled:B||!T||m,title:T?m?"Le paiement a d√©j√† √©t√© trait√©":"":"Ajoutez la r√©f√©rence",className:"h-11 px-5 rounded-xl font-semibold shadow-sm disabled:opacity-60 disabled:cursor-not-allowed transition hover:brightness-[0.98]",style:{background:`linear-gradient(135deg, ${h.primary}, ${h.secondary})`,color:"#fff"},children:B?"Envoi‚Ä¶":"Confirmer l'envoi"})]})]})]}),!ce&&!m&&e(ue.div,{initial:{opacity:0},animate:{opacity:1},className:"mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg",children:a("div",{className:"flex items-center gap-2 text-gray-700",children:[e(Lt,{className:"w-4 h-4 text-gray-500"}),e("p",{className:"text-xs",children:"Choisissez un moyen de paiement ci-dessus pour continuer."})]})})]})};function pa(){var tt;const{slug:n,id:l}=Mt(),w=zt(),P=Dt(),ae=o.useRef(null),R=o.useRef(null),k=o.useRef(null),T=o.useRef(null),v=w.state||{},B=new URLSearchParams(w.search),z=Ce(B.get("departure")||""),p=Ce(B.get("arrival")||""),[u,L]=o.useState({id:"",name:"",couleurPrimaire:"#f43f5e",couleurSecondaire:"#f97316",logoUrl:"",code:""}),h=o.useMemo(()=>({primary:u.couleurPrimaire,secondary:u.couleurSecondaire,lightPrimary:`${u.couleurPrimaire}1A`,lightSecondary:`${u.couleurSecondaire}1A`,veryLightPrimary:`${u.couleurPrimaire}08`}),[u]),[m,ge]=o.useState({}),[H,ce]=o.useState({}),[N,$]=o.useState(null),[D,Le]=o.useState(null),[He,pt]=o.useState([]),[gt,ht]=o.useState([]),[J,Ve]=o.useState(""),[le,$e]=o.useState(""),[_,Fe]=o.useState(1),[V,Oe]=o.useState({fullName:"",phone:""}),[ie,qe]=o.useState(""),[g,Ge]=o.useState(null),[he,Be]=o.useState(!1),[Ue,Je]=o.useState(!1),[ft,F]=o.useState(!0),[fe,U]=o.useState(""),[O,ye]=o.useState({}),[t,Ye]=o.useState(null),[yt,We]=o.useState(!1),[j,Y]=o.useState("personal"),re=o.useMemo(()=>{if(t){const r=String(t.statut||"").toLowerCase();return Ae(r)}return!1},[t]);o.useMemo(()=>!!g&&!t,[g,t]),o.useEffect(()=>{if(!N&&g){const r=Kt(g);r&&H[r]&&$(r)}},[N,g,H]),o.useEffect(()=>{if(!D&&g){const r=aa(g);r&&Le(r)}},[D,g]),o.useEffect(()=>{t&&(t.statut==="en_attente_paiement"&&(Y("payment"),N&&Y("proof")),(t.statut==="preuve_recue"||t.statut==="confirme")&&Y("proof"))},[t,N]),o.useEffect(()=>{Qt()},[n,P,l]),o.useEffect(()=>{(t==null?void 0:t.statut)==="confirme"&&(Xt(),ea(t.id),ra(t.id))},[t==null?void 0:t.statut,t==null?void 0:t.id]),o.useEffect(()=>{(async()=>{if(l){F(!0);try{if(!v.companyId||!v.agencyId){U("Information manquante (company/agency). Revenez en arri√®re et r√©essayez."),F(!1);return}const s=G(C,"companies",v.companyId,"agences",v.agencyId,"reservations",l),f=await me(s);if(!f.exists()){U("R√©servation introuvable."),F(!1);return}const i=f.data(),S=await me(G(C,"companies",v.companyId)),b=S.exists()?S.data():{};L({id:v.companyId,name:b.nom||b.name||"",code:(b.code||"").toString().toUpperCase(),couleurPrimaire:b.couleurPrimaire||"#f43f5e",couleurSecondaire:b.couleurSecondaire||"#f97316",logoUrl:b.logoUrl||""});const x=await me(G(C,"companies",v.companyId,"agences",v.agencyId)),y=x.exists()?x.data():{};ge({id:v.agencyId,nom:y.nomAgence||y.nom||y.name||"Agence",telephone:y.telephone,code:(y.code||y.codeAgence||"").toString().toUpperCase()||void 0});const de=await oe(Ne(ee(C,"paymentMethods"),xe("companyId","==",v.companyId))),M={};de.forEach(ne=>{const E=ne.data();E.name&&(M[E.name]={url:E.defaultPaymentUrl||"",logoUrl:E.logoUrl||"",ussdPattern:E.ussdPattern||"",merchantNumber:E.merchantNumber||""})}),ce(M),Ye({id:l,companyId:v.companyId,agencyId:v.agencyId,canal:i.canal,statut:i.statut,nomClient:i.nomClient,telephone:i.telephone,depart:i.depart,arrivee:i.arrivee||i.arrival,date:i.date,heure:i.heure,montant:i.montant??i.montant_total,seatsGo:i.seatsGo,referenceCode:i.referenceCode}),Ge(l),F(!1)}catch(s){console.error(s),U((s==null?void 0:s.message)||"Erreur de chargement"),F(!1)}}})()},[l,v.companyId,v.agencyId]),o.useEffect(()=>{if(l)return;if(!n||!z||!p){F(!1);return}(async()=>{var s,f,i,S;F(!0);try{const b=await oe(Ne(ee(C,"companies"),xe("slug","==",n)));if(b.empty)throw new Error("Compagnie introuvable");const x=b.docs[0],y=x.data();L({id:x.id,name:y.nom||y.name||"",code:(y.code||"").toString().toUpperCase(),couleurPrimaire:y.couleurPrimaire||"#f43f5e",couleurSecondaire:y.couleurSecondaire||"#f97316",logoUrl:y.logoUrl||""});const M=(await oe(ee(C,"companies",x.id,"agences"))).docs.map(d=>({id:d.id,...d.data()}));if(M[0]){const d=M[0];ge({id:d.id,nom:d.nomAgence||d.nom||d.name,telephone:d.telephone,code:(d.code||d.codeAgence||"").toString().toUpperCase()||void 0})}const ne=await oe(Ne(ee(C,"paymentMethods"),xe("companyId","==",x.id))),E={};ne.forEach(d=>{const A=d.data();A.name&&(E[A.name]={url:A.defaultPaymentUrl||"",logoUrl:A.logoUrl||"",ussdPattern:A.ussdPattern||"",merchantNumber:A.merchantNumber||""})}),ce(E);const be=Array.from({length:8},(d,A)=>{const Z=new Date;return Z.setDate(Z.getDate()+A),it(Z)}),Q=[];for(const d of M){const[A,Z]=await Promise.all([oe(Ne(ee(C,"companies",x.id,"agences",d.id,"weeklyTrips"),xe("active","==",!0))),oe(ee(C,"companies",x.id,"agences",d.id,"reservations"))]),It=A.docs.map(I=>({id:I.id,...I.data()})).filter(I=>Ce(I.depart||I.departure||"")===z&&Ce(I.arrivee||I.arrival||"")===p),Pt=Z.docs.map(I=>({id:I.id,...I.data()}));be.forEach(I=>{const At=new Date(I),$t=oa[At.getDay()];It.forEach(q=>{var at;(((at=q.horaires)==null?void 0:at[$t])||[]).forEach(Ee=>{if(I===it(new Date)){const K=new Date,Te=Se(`${String(K.getHours()).padStart(2,"0")}:${String(K.getMinutes()).padStart(2,"0")}`,"HH:mm",new Date);if(Se(Ee,"HH:mm",new Date)<=Te)return}const rt=`${q.id}_${I}_${Ee}`,nt=q.places||30,Ut=Pt.filter(K=>String(K.trajetId)===rt&&["confirme","pay√©"].includes(String(K.statut).toLowerCase())).reduce((K,Te)=>K+(Te.seatsGo||0),0),st=nt-Ut;st>0&&Q.push({id:rt,date:I,time:Ee,departure:q.depart||q.departure||"",arrival:q.arrivee||q.arrival||"",price:q.price,agencyId:d.id,companyId:x.id,places:nt,remainingSeats:st})})})})}const se=Q.sort((d,A)=>d.date.localeCompare(A.date)||d.time.localeCompare(A.time)),X=[...new Set(se.map(d=>d.date))];pt(se),ht(X),Ve(X[0]||""),sessionStorage.setItem(`preload_${n}_${z}_${p}`,JSON.stringify({company:{id:x.id,name:y.nom||"",couleurPrimaire:y.couleurPrimaire||"#f43f5e",couleurSecondaire:y.couleurSecondaire||"#f97316",logoUrl:y.logoUrl||"",code:(y.code||"MT").toString().toUpperCase()},trips:se,dates:X,agencyInfo:{nom:((s=M[0])==null?void 0:s.nomAgence)||((f=M[0])==null?void 0:f.nom)||"",telephone:((i=M[0])==null?void 0:i.telephone)||"",code:(S=M[0])==null?void 0:S.code}}))}catch(b){U((b==null?void 0:b.message)||"Erreur de chargement")}finally{F(!1)}})()},[n,z,p,l]),o.useEffect(()=>{g&&j==="personal"&&Y("payment")},[g,j]),o.useEffect(()=>{N&&j==="payment"&&Y("proof")},[N,j]);const W=o.useMemo(()=>{if(!J)return[];const r=He.filter(s=>s.date===J);if(ct(we(J))){const s=new Date,f=Se(`${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}`,"HH:mm",new Date);return r.filter(i=>Se(i.time,"HH:mm",new Date)>f)}return r},[He,J]);o.useEffect(()=>{!l&&W.length&&!le&&$e(W[0].time)},[W,le,l]);const c=W.find(r=>r.time===le),ve=(c==null?void 0:c.price)??((tt=W[0])==null?void 0:tt.price),Me=(r,s)=>{const f=r/s;return f>.7?"#16a34a":f>.3?"#f59e0b":"#dc2626"},Qe=()=>{const r={};return V.fullName.trim()||(r.fullName="Le nom complet est requis"),V.phone.trim()?la(V.phone)||(r.phone="Num√©ro invalide (format attendu : 22 22 22 22)"):r.phone="Le num√©ro de t√©l√©phone est requis",ye(r),Object.keys(r).length>0?(r.fullName&&R.current?(R.current.scrollIntoView({behavior:"smooth",block:"center"}),R.current.focus()):r.phone&&k.current&&(k.current.scrollIntoView({behavior:"smooth",block:"center"}),k.current.focus()),!1):!0},vt=o.useCallback(async()=>{if(re){const s=Re();s&&Ae(s.status)&&s.slug===n&&P(`/${n}/reservation/${s.id}`,{replace:!0,state:{companyId:s.companyId,agencyId:s.agencyId}});return}if(!Qe()){U("Veuillez corriger les erreurs ci-dessus");return}if(!c){U("Veuillez s√©lectionner un horaire");return}const r=Re();if(r&&Ae(r.status)&&r.slug===n){P(`/${n}/reservation/${r.id}`,{replace:!0,state:{companyId:r.companyId,agencyId:r.agencyId}});return}if(!he){Be(!0),U(""),ye({});try{let s=function(d){return d?d.trim().split(/\s+/).map(Z=>Z[0]).join("").toUpperCase().slice(0,3):""};const f=await me(G(C,"companies",c.companyId,"agences",c.agencyId)),i=f.exists()?f.data():{},S=i.nomAgence||i.nom||i.name||"Agence",b=(i.code||i.codeAgence||"").toString().toUpperCase()||void 0,x=await me(G(C,"companies",c.companyId)),y=x.exists()?x.data():{},de=(y.code||u.code||"").toString().trim(),M=de?de.toUpperCase():s(y.nom||y.name);console.log("Company Code utilis√© :",M);const ne=await Wt({companyId:c.companyId,companyCode:M,agencyId:c.agencyId,agencyCode:b,agencyName:S,tripInstanceId:c.id}),E=new Date,be={nomClient:V.fullName.trim(),telephone:V.phone.trim(),depart:c.departure,arrivee:c.arrival,date:c.date,heure:c.time,montant:c.price*_,seatsGo:_,seatsReturn:0,tripType:"aller_simple",statut:"en_attente_paiement",canal:"en_ligne",companyId:c.companyId,companySlug:n,companyName:u.name,agencyId:c.agencyId,agencyNom:S,nomAgence:S,referenceCode:ne,trajetId:c.id,holdUntil:sa(E,15),createdAt:je(),updatedAt:je()},Q=await Ft(ee(C,"companies",c.companyId,"agences",c.agencyId,"reservations"),be),se=na(),X=`${window.location.origin}/${n}/mon-billet?r=${encodeURIComponent(se)}`;await ot(G(C,"companies",c.companyId,"agences",c.agencyId,"reservations",Q.id),{publicToken:se,publicUrl:X});try{await navigator.clipboard.writeText(X)}catch{}Ge(Q.id),Y("payment"),setTimeout(()=>{var d;(d=ae.current)==null||d.scrollIntoView({behavior:"smooth",block:"center"})},100),We(!0),lt({slug:n,id:Q.id,referenceCode:ne,status:"en_attente_paiement",companyId:c.companyId,agencyId:c.agencyId}),sessionStorage.setItem("reservationDraft",JSON.stringify({...be,id:Q.id,publicUrl:X})),sessionStorage.setItem("companyInfo",JSON.stringify({id:u.id,name:u.name,logoUrl:u.logoUrl,couleurPrimaire:u.couleurPrimaire,couleurSecondaire:u.couleurSecondaire,slug:n}))}catch(s){U((s==null?void 0:s.message)||"Impossible de cr√©er la r√©servation")}finally{Be(!1)}}},[re,c,V,_,he,n,u,P,Qe]),Xe=o.useCallback(r=>{var S;if($(r),g){Zt(g,r);const b=Date.now();Le(b),ta(g,b)}Y("proof"),setTimeout(()=>{var b,x;(b=T.current)==null||b.scrollIntoView({behavior:"smooth",block:"center"}),(x=T.current)==null||x.focus()},300);const s=H[r||""];if(!s)return;const f=t?t.montant||0:c?c.price*_:ve||0,i=(S=s.ussdPattern)==null?void 0:S.replace("MERCHANT",s.merchantNumber||"").replace("AMOUNT",String(f));if(s.url)try{new URL(s.url),window.open(s.url,"_blank","noopener,noreferrer")}catch{}else i&&(window.location.href=`tel:${encodeURIComponent(i)}`)},[H,t,c,_,ve,g]),Ze=o.useMemo(()=>{if(!N)return"Choisissez un moyen de paiement pour voir les instructions.";switch(N){case"orangemoney":return"Apr√®s votre paiement Orange Money, copiez le code re√ßu par SMS";case"moov":return"Apr√®s votre paiement Moov Money, indiquez la r√©f√©rence re√ßue par SMS";case"wave":return"Apr√®s votre paiement Wave, copiez le code du re√ßu";case"cash":return"Paiement au guichet : entrez le n¬∞ du re√ßu";default:return"Copiez la r√©f√©rence re√ßue par SMS apr√®s paiement"}},[N]),ze=o.useMemo(()=>!g||!N?!1:ie.trim().length>=4,[g,N,ie]),Ke=async()=>{const r=(t==null?void 0:t.companyId)||u.id,s=(t==null?void 0:t.agencyId)||(m==null?void 0:m.id);if(!g||!r||!s){U("R√©servation introuvable");return}if(!N){U("S√©lectionnez un moyen de paiement");return}if(!ze){U("Ajoutez la r√©f√©rence du paiement (‚â• 4 caract√®res) avant de confirmer.");return}if(!Ue){Je(!0),U("");try{const f=t!=null&&t.canal&&t.canal.toLowerCase()!=="en_ligne"?t.canal:"en_ligne";await ot(G(C,"companies",r,"agences",s,"reservations",g),{statut:"preuve_recue",canal:f,preuveVia:N,preuveMessage:ie.trim(),paymentHint:N,paymentTriggeredAt:D?new Date(D):null,updatedAt:je()}),Ye(S=>S&&{...S,statut:"preuve_recue",canal:f}),P(`/${n}/reservation/${g}`,{replace:!0,state:{companyId:r,agencyId:s}});const i=Re();i&&i.id===g&&lt({...i,status:"preuve_recue"})}catch{U("√âchec de l'envoi de la preuve")}finally{Je(!1)}}},De=r=>e("section",{className:"bg-white rounded-2xl border border-gray-100 shadow-sm",children:a("div",{className:"flex items-center justify-between gap-4 px-4 sm:px-5 py-3",children:[a("div",{className:"flex items-center gap-3 min-w-0",children:[u.logoUrl&&e("img",{src:u.logoUrl,alt:"",className:"h-8 w-8 rounded-full object-cover ring-1 ring-gray-200"}),a("div",{className:"min-w-0",children:[a("div",{className:"flex items-center text-gray-900 font-semibold",children:[e("span",{className:"truncate",children:t!=null&&t.depart?Ie(t.depart):Ie(z)}),e("svg",{viewBox:"0 0 24 24",className:"mx-2 h-5 w-5 shrink-0",style:{color:h.primary},children:e("path",{fill:"currentColor",d:"M5 12h12l-4-4 1.4-1.4L21.8 12l-7.4 5.4L13 16l4-4H5z"})}),e("span",{className:"truncate",children:t!=null&&t.arrivee?Ie(t.arrivee):Ie(p)})]}),e("p",{className:"text-xs text-gray-500",children:t!=null&&t.date?`${t.date} ¬∑ ${t.heure||""}`:"S√©lectionnez la date et l'heure"})]})]}),e("div",{className:"text-right",children:r?e("div",{className:"text-lg sm:text-xl font-extrabold",style:{color:h.primary},children:r}):a(te,{children:[e("div",{className:"text-xs text-gray-500",children:"√Ä partir de"}),e("div",{className:"text-lg sm:text-xl font-extrabold",style:{color:h.primary},children:t!=null&&t.montant||ve?`${((t==null?void 0:t.montant)||ve).toLocaleString("fr-FR")} FCFA`:"‚Äî"})]})})]})}),bt=()=>e("div",{className:"flex items-center justify-center mb-4",children:a("div",{className:"flex items-center",children:[e("div",{className:`h-8 w-8 rounded-full flex items-center justify-center ${j==="personal"?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e("div",{className:`h-1 w-12 ${j==="personal"?"bg-gray-300":"bg-gray-200"}`}),e("div",{className:`h-8 w-8 rounded-full flex items-center justify-center ${j==="payment"?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e("div",{className:`h-1 w-12 ${j==="proof"?"bg-gray-300":"bg-gray-200"}`}),e("div",{className:`h-8 w-8 rounded-full flex items-center justify-center ${j==="proof"?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"3"})]})}),Nt=()=>yt?e("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4",children:e(ue.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},className:"bg-white rounded-t-2xl sm:rounded-2xl max-w-md w-full",children:a("div",{className:"p-6",children:[e("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"√âtape suivante : Paiement"}),a("div",{className:"space-y-3 mb-6",children:[a("div",{className:"flex items-start gap-3",children:[e("div",{className:"h-6 w-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold",children:"1"}),a("div",{children:[e("p",{className:"font-medium text-gray-900",children:"Choisissez un moyen de paiement"}),e("p",{className:"text-sm text-gray-600",children:"S√©lectionnez Orange Money, Moov Money, etc."})]})]}),a("div",{className:"flex items-start gap-3",children:[e("div",{className:"h-6 w-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold",children:"2"}),a("div",{children:[e("p",{className:"font-medium text-gray-900",children:"Effectuez le paiement"}),e("p",{className:"text-sm text-gray-600",children:"Sortez de l'app pour payer (USSD ou app externe)"})]})]}),a("div",{className:"flex items-start gap-3",children:[e("div",{className:"h-6 w-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold",children:"3"}),a("div",{children:[e("p",{className:"font-medium text-gray-900",children:"Revenez coller la r√©f√©rence"}),e("p",{className:"text-sm text-gray-600",children:"Apr√®s paiement, copiez le code re√ßu par SMS"})]})]})]}),e("div",{className:"flex gap-3",children:e("button",{onClick:()=>We(!1),className:"flex-1 h-11 border border-gray-300 rounded-xl font-medium hover:bg-gray-50 transition",children:"Compris"})})]})})}):null;if(ft)return e("div",{className:"min-h-screen grid place-items-center bg-gray-50",children:e(ue.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"bg-white/70 backdrop-blur rounded-2xl p-6 shadow-sm",children:a("div",{className:"flex items-center gap-3",children:[u.logoUrl&&e("img",{src:u.logoUrl,alt:"",className:"h-10 w-10 rounded-full object-cover ring-1 ring-gray-200"}),a("div",{children:[e("div",{className:"h-4 w-40 bg-gray-200 rounded mb-2"}),e("div",{className:"h-3 w-24 bg-gray-200 rounded"})]})]})})});const xt=e("header",{className:"sticky top-0 z-50 shadow-sm",style:{backgroundColor:h.primary},children:a("div",{className:"max-w-[1100px] mx-auto px-3 sm:px-4 py-2 flex items-center justify-between text-white",children:[e("button",{onClick:()=>P(-1),className:"p-2 rounded-full hover:bg-white/10 transition","aria-label":"Retour",children:e(Et,{className:"h-5 w-5"})}),a("div",{className:"flex items-center gap-2",children:[u.logoUrl&&e("img",{src:u.logoUrl,alt:"",className:"h-7 w-7 rounded-full object-cover ring-1 ring-white/30"}),e("span",{className:"font-semibold tracking-wide",children:u.name||"MALI TRANS"})]}),e("div",{className:"w-9"})]})}),et=String((t==null?void 0:t.canal)||"").toLowerCase();String((t==null?void 0:t.statut)||"").toLowerCase();const wt=!!t&&(t.statut==="preuve_recue"||t.statut==="confirme"||et==="guichet"),St=t&&a("div",{className:"max-w-[1100px] mx-auto px-3 sm:px-4 py-4 space-y-4",children:[De("Billet"),a("section",{className:"bg-white rounded-2xl border p-4",children:[a("div",{className:"text-sm text-gray-600 mb-3",children:[e("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200 mr-2",children:et==="guichet"?"Guichet":"En ligne"}),a("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 border",children:["R√©f√©rence: ",t.referenceCode||t.id]})]}),a("div",{className:"grid sm:grid-cols-2 gap-3 text-sm",children:[a("div",{children:[e("span",{className:"text-gray-500",children:"Passager"}),e("div",{className:"font-medium",children:t.nomClient||"‚Äî"})]}),a("div",{children:[e("span",{className:"text-gray-500",children:"T√©l√©phone"}),e("div",{className:"font-medium",children:t.telephone||"‚Äî"})]}),a("div",{children:[e("span",{className:"text-gray-500",children:"Trajet"}),a("div",{className:"font-medium",children:[t.depart," ‚Üí ",t.arrivee]})]}),a("div",{children:[e("span",{className:"text-gray-500",children:"Date & heure"}),a("div",{className:"font-medium",children:[t.date," ¬∑ ",t.heure]})]}),a("div",{children:[e("span",{className:"text-gray-500",children:"Places"}),e("div",{className:"font-medium",children:t.seatsGo||1})]}),a("div",{children:[e("span",{className:"text-gray-500",children:"Montant"}),a("div",{className:"font-medium",children:[(t.montant||0).toLocaleString("fr-FR")," FCFA"]})]})]})]})]}),Ct=a("div",{className:"max-w-[1100px] mx-auto px-3 sm:px-4 py-4 space-y-4",children:[De(),(m==null?void 0:m.nom)&&a("div",{className:"text-xs text-gray-500 px-1",children:["Agence : ",m.nom," ‚Äî ",m.telephone]}),(t==null?void 0:t.statut)&&e("div",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:a("div",{className:"flex items-center gap-3",children:[t.statut==="en_attente_paiement"&&a(te,{children:[e(ke,{className:"w-5 h-5 text-amber-500"}),a("div",{children:[e("div",{className:"font-medium text-gray-900",children:"En attente de paiement"}),e("div",{className:"text-sm text-gray-600",children:"Veuillez effectuer le paiement et envoyer la preuve"})]})]}),t.statut==="preuve_recue"&&a(te,{children:[e(ke,{className:"w-5 h-5 text-blue-500"}),a("div",{children:[e("div",{className:"font-medium text-gray-900",children:"Preuve re√ßue ‚Äì en v√©rification"}),e("div",{className:"text-sm text-gray-600",children:"Votre preuve de paiement est en cours de v√©rification par la compagnie"})]})]}),t.statut==="confirme"&&a(te,{children:[e(mt,{className:"w-5 h-5 text-emerald-500"}),a("div",{children:[e("div",{className:"font-medium text-gray-900",children:"Paiement confirm√©"}),e("div",{className:"text-sm text-gray-600",children:"Votre billet est confirm√© et valide pour le voyage"})]})]})]})}),fe&&e("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-800",children:fe}),D&&(t==null?void 0:t.statut)==="en_attente_paiement"&&!N&&e("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800",children:"üí° Apr√®s votre paiement, choisissez un moyen de paiement ci-dessous, puis collez le code re√ßu par SMS."}),e(dt,{reservationId:g,paymentMethods:H,paymentMethodKey:N,onChoosePayment:Xe,message:ie,setMessage:qe,referenceInputRef:T,canConfirm:ze,submitProofInline:Ke,uploading:Ue,paymentHints:Ze,existing:t,selectedTrip:c,seats:_,theme:h}),t&&t.statut&&e("div",{className:"text-sm text-gray-600",children:t.canal&&a("span",{className:"mr-3",children:["Canal : ",e("b",{children:t.canal})]})})]});return a("div",{className:"min-h-screen bg-gradient-to-br from-white to-gray-50",children:[xt,e(Nt,{}),t?wt?St:Ct:a("main",{className:"max-w-[1100px] mx-auto px-3 sm:px-4 py-4 space-y-4 sm:space-y-5",children:[De(),(m==null?void 0:m.nom)&&a("div",{className:"text-xs text-gray-500 px-1",children:["Agence : ",m.nom," ‚Äî ",m.telephone]}),fe&&e("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-800",children:fe}),re&&e("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4",children:a("div",{className:"flex items-start gap-3",children:[e(Pe,{className:"h-5 w-5 text-amber-600 mt-0.5"}),a("div",{className:"flex-1",children:[e("h3",{className:"font-medium text-amber-800 mb-1",children:"Une r√©servation est d√©j√† en cours"}),e("p",{className:"text-sm text-amber-700",children:"Vous avez d√©j√† une r√©servation en attente de paiement. Veuillez terminer le paiement et envoyer la preuve."})]})]})}),a("section",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:[e("h2",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Choisissez votre date de d√©part"}),e("div",{className:"flex gap-2 overflow-x-auto scrollbar-none",children:gt.map(r=>a("button",{onClick:()=>{Ve(r),$e("")},className:"h-10 px-3 rounded-xl border text-sm whitespace-nowrap transition",style:{borderColor:J===r?h.primary:"#e5e7eb",color:J===r?"#111827":"#374151",backgroundColor:J===r?h.lightPrimary:"#f9fafb"},children:[e("span",{className:"font-medium",children:qt(we(r),"EEE d",{locale:Gt})}),ct(we(r))&&e("span",{className:"ml-2 text-xs text-gray-500",children:"Aujourd'hui"}),Ot(we(r))&&e("span",{className:"ml-2 text-xs text-gray-500",children:"Demain"})]},r))})]}),!!W.length&&a("section",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:[e("h2",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Choisissez votre heure de d√©part"}),e("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2",children:W.map(r=>e("button",{onClick:()=>$e(r.time),className:"h-11 px-3 rounded-lg border text-sm text-left transition",style:{borderColor:le===r.time?h.secondary:"#e5e7eb",backgroundColor:le===r.time?h.lightSecondary:"#f9fafb"},children:a("div",{className:"flex items-center justify-between",children:[e("span",{className:"font-semibold",children:r.time}),a("span",{className:"text-[11px] px-2 h-5 rounded-md grid place-items-center whitespace-nowrap leading-none",style:{color:Me(r.remainingSeats,r.places),border:`1px solid ${Me(r.remainingSeats,r.places)}`},children:[r.remainingSeats," pl."]})]})},r.id))})]}),c&&!re&&e(te,{children:a("section",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:[e(bt,{}),e("h2",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Informations personnelles"}),a("p",{className:"text-xs text-gray-500 mb-3",children:["Entrez votre ",e("span",{className:"font-medium",children:"nom complet"})," et votre ",e("span",{className:"font-medium",children:"num√©ro de t√©l√©phone"})," utilis√©s pour voyager."]}),a("div",{className:"grid sm:grid-cols-2 gap-3",children:[a("div",{className:"relative",children:[e("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e(Tt,{className:"h-5 w-5 text-gray-400"})}),e("input",{ref:R,className:`h-11 pl-10 pr-3 w-full border rounded-lg focus:ring-2 focus:outline-none ${O.fullName?"border-red-300":"border-gray-200"}`,placeholder:"Nom complet *",value:V.fullName,onChange:r=>{Oe(s=>({...s,fullName:r.target.value})),O.fullName&&ye(s=>({...s,fullName:""}))}}),O.fullName&&a("div",{className:"text-xs text-red-600 mt-1 flex items-center gap-1",children:[e(Pe,{className:"w-3 h-3"})," ",O.fullName]})]}),a("div",{className:"relative",children:[e("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e(_t,{className:"h-5 w-5 text-gray-400"})}),e("input",{ref:k,inputMode:"numeric",autoComplete:"tel",maxLength:11,className:`h-11 pl-10 pr-3 w-full border rounded-lg focus:ring-2 focus:outline-none ${O.phone?"border-red-300":"border-gray-200"}`,placeholder:"T√©l√©phone * (ex: 22 22 22 22)",value:V.phone,onChange:r=>{const s=ca(r.target.value);Oe(f=>({...f,phone:s})),O.phone&&ye(f=>({...f,phone:""}))}}),O.phone&&a("div",{className:"text-xs text-red-600 mt-1 flex items-center gap-1",children:[e(Pe,{className:"w-3 h-3"})," ",O.phone]})]}),a("div",{className:"sm:col-span-2 flex items-center gap-4 mt-2",children:[e("span",{className:"text-sm text-gray-600",children:"Places"}),e("button",{onClick:()=>Fe(r=>Math.max(1,r-1)),className:"w-9 h-9 rounded-full border grid place-items-center hover:bg-gray-50",style:{borderColor:h.lightPrimary,color:h.primary},children:e(jt,{className:"w-4 h-4"})}),e("span",{className:"px-3 py-1.5 rounded-lg text-sm font-semibold",style:{background:h.lightPrimary,color:h.primary},children:_}),e("button",{onClick:()=>Fe(r=>Math.min(Math.min(5,c.remainingSeats),r+1)),className:"w-9 h-9 rounded-full border grid place-items-center hover:bg-gray-50",style:{borderColor:h.lightPrimary,color:h.primary},children:e(Rt,{className:"w-4 h-4"})}),a("span",{className:"text-xs",style:{color:Me(c.remainingSeats,c.places)},children:[c.remainingSeats," pl. dispo"]})]})]}),!g&&e("button",{onClick:vt,disabled:he||re,title:re?"Une r√©servation est d√©j√† en cours":"",className:"mt-4 w-full h-11 rounded-xl font-semibold shadow-sm disabled:opacity-60 transition hover:brightness-[0.98] flex items-center justify-center gap-2",style:{background:`linear-gradient(135deg, ${h.secondary}, ${h.primary})`,color:"#fff"},children:he?"Traitement‚Ä¶":a(te,{children:["Passer au paiement",e(kt,{className:"w-4 h-4"}),a("span",{className:"font-bold",children:[(c.price*_).toLocaleString("fr-FR")," FCFA"]})]})}),g&&!t&&e(ue.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-4 p-3 bg-emerald-50 border border-emerald-200 rounded-lg",children:a("div",{className:"flex items-center gap-2 text-emerald-800",children:[e(ut,{className:"w-4 h-4"}),a("div",{children:[e("p",{className:"text-sm font-medium",children:"R√©servation cr√©√©e avec succ√®s !"}),e("p",{className:"text-xs text-emerald-700 mt-0.5",children:"Choisissez maintenant un moyen de paiement ci-dessous pour continuer."})]})]})})]})}),g&&e("section",{ref:ae,className:"bg-white rounded-2xl border border-gray-100 p-4",children:e(dt,{reservationId:g,paymentMethods:H,paymentMethodKey:N,onChoosePayment:Xe,message:ie,setMessage:qe,referenceInputRef:T,canConfirm:ze,submitProofInline:Ke,uploading:Ue,paymentHints:Ze,existing:t,selectedTrip:c,seats:_,theme:h})})]})]})}export{pa as default};
