import{a as t,j as e,b as _,u as Q,d as W,r as b,b9 as q,l as T,C as Y,k as Z,M as K,_ as ee,n as re,a5 as ae,aa as te,aw as se,F as $,U as le,X as oe,L as ne}from"./react-DB_4kGOy.js";import{d as F,e as R,h as d,s as ce}from"../index-Bkmir__O.js";import{z as ie,w as de,x as me,y as ue,o as O,q as pe,R as he,S as ge,U as fe,C as ye}from"./firebase-lLzYRzUk.js";import{E as be}from"./ErrorScreen-Ckorlj77.js";import{f as xe,c as Ne,p as ve}from"./vendor-C-DAJou6.js";const we=({message:r="Chargement...",colors:a})=>t("div",{className:"flex items-center justify-center min-h-screen text-lg",style:{backgroundColor:a.background,color:a.text},children:[e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 mr-4",style:{borderColor:a.primary}}),r]}),j="[UploadPreuvePage]",i={info:(...r)=>console.log(j,...r),warn:(...r)=>console.warn(j,...r),error:(...r)=>console.error(j,...r),group:r=>console.group(`${j} ${r}`),groupEnd:()=>console.groupEnd()},Ae=()=>{const r=_(),a=Q(),{slug:o,id:y}=W(),{draft:u,companyInfo:w}=a.state||{},[s,S]=b.useState(null),[n,P]=b.useState(null),[U,E]=b.useState(!0),[g,x]=b.useState(null),[k,G]=b.useState(""),[M,B]=b.useState(null),[D,L]=b.useState(!1),[z,N]=b.useState(null),[V,I]=b.useState(!1),A=b.useCallback(async()=>{i.group("loadInitialData");try{E(!0);let l=null;if(u&&w)i.info("Init from location.state"),l=w,S(u);else{const c=sessionStorage.getItem("reservationDraft"),f=sessionStorage.getItem("companyInfo");if(i.info("Init from sessionStorage",{hasDraft:!!c,hasCompany:!!f}),c&&f){const m=JSON.parse(c);if(l=JSON.parse(f),!(m!=null&&m.depart)||!(m!=null&&m.arrivee))throw new Error("Données de réservation incomplètes");S(m)}else throw new Error("Aucune donnée de réservation valide trouvée")}if(l!=null&&l.id){const c=await ie(de(me(F,"paymentMethods"),ue("companyId","==",l.id))),f={};c.forEach(h=>{const C=h.data();C.name&&(f[C.name]={logoUrl:C.logoUrl||"",url:C.defaultPaymentUrl||"",ussdPattern:C.ussdPattern||"",merchantNumber:C.merchantNumber||""})}),i.info("Payment methods",Object.keys(f));const m=O(F,"companies",l.id),p=await pe(m);if(p.exists()){const h=p.data();P({...l,paymentMethods:f,primaryColor:h.primaryColor||h.couleurPrimaire||"#3b82f6",secondaryColor:h.secondaryColor||h.couleurSecondaire||"#93c5fd",logoUrl:h.logoUrl||""}),i.info("Company info merged",{styles:{primary:h.couleurPrimaire,secondary:h.couleurSecondaire}});return}else throw new Error("Compagnie introuvable dans Firestore")}throw new Error("Impossible de récupérer les infos de la compagnie")}catch(l){i.error("loadInitialData error",l),N(l instanceof Error?l.message:"Erreur inconnue"),r(`/${o||""}`,{replace:!0,state:{error:"Erreur de chargement des données"}})}finally{E(!1),i.groupEnd()}},[u,w,r,o,y]);b.useEffect(()=>{A()},[A]);const J=l=>{try{if(!l.target.files||!l.target.files[0]){x(null);return}const c=l.target.files[0],f=["image/jpeg","image/png","application/pdf"],m=5*1024*1024;if(!f.includes(c.type))throw new Error("Type de fichier non supporté (JPEG, PNG ou PDF uniquement)");if(c.size>m)throw new Error("Le fichier est trop volumineux (max 5MB)");x(c),N(null),i.info("File selected",{name:c.name,size:c.size,type:c.type})}catch(c){N(c instanceof Error?c.message:"Erreur lors de la sélection du fichier"),x(null),i.warn("handleFileChange error",c)}},H=l=>{var c,f,m;try{const p=(c=n==null?void 0:n.paymentMethods)==null?void 0:c[l];if(!p)throw new Error("Méthode de paiement non disponible");if(B(l),N(null),i.info("Payment method selected",l),s){const h=(m=(f=p.ussdPattern)==null?void 0:f.replace("MERCHANT",p.merchantNumber||""))==null?void 0:m.replace("AMOUNT",s.montant.toString());p.url?(window.open(p.url,"_blank","noopener,noreferrer"),i.info("Open payment URL",p.url)):h&&(window.open(`tel:${h}`,"_blank","noopener,noreferrer"),i.info("Open USSD",h))}}catch(p){N(p instanceof Error?p.message:"Erreur de sélection du paiement"),i.warn("handlePaymentMethodSelect error",p)}},X=async()=>{if(!s||!s.id){N("Réservation introuvable.");return}if(!M){N("Veuillez sélectionner un moyen de paiement.");return}if(!k&&!g){N("Veuillez fournir une preuve ou un message.");return}L(!0),N(null),i.group("handleUpload");try{let l=null;if(g){const f=g.name.split(".").pop(),m=`preuves/preuve_${Date.now()}.${f}`,p=he(ce,m),h=await ge(p,g);l=await fe(h.ref),i.info("File uploaded",{filename:m,preuveUrl:l})}const c={nomClient:s.nomClient,telephone:s.telephone,depart:s.depart,arrivee:s.arrivee,date:s.date,heure:s.heure,montant:s.montant,seatsGo:s.seatsGo,seatsReturn:s.seatsReturn||0,tripType:s.tripType,statut:"preuve_recue",canal:"en_ligne",preuveVia:M,preuveMessage:k.trim(),preuveUrl:l||null,companyId:s.companyId||"",companySlug:s.companySlug||"",updatedAt:new Date};i.info("Update payload (no ref code write)",c),await ye(O(F,"companies",s.companyId,"agences",s.agencyId,"reservations",s.id),c),sessionStorage.removeItem("reservationDraft"),sessionStorage.removeItem("companyInfo"),I(!0),i.info("Upload success → setSuccess(true)")}catch(l){i.error("handleUpload error",l),N("Une erreur est survenue lors de l'envoi.")}finally{L(!1),i.groupEnd()}};if(U){const l={colors:{primary:(n==null?void 0:n.couleurPrimaire)||"#3b82f6",text:n!=null&&n.couleurPrimaire?R(n.couleurPrimaire):"#ffffff",background:"#f9fafb"}};return e(we,{colors:l.colors})}if(!s||!n)return e(be,{slug:o,navigate:r,error:z||""});if(V)return e(Ce,{reservationDraft:s,companyInfo:n,slug:o});const v={colors:{primary:n.primaryColor||n.couleurPrimaire||"#3b82f6",secondary:n.secondaryColor||n.couleurSecondaire||"#93c5fd",text:n.primaryColor?R(n.primaryColor):"#ffffff"}};return t("div",{className:"min-h-screen bg-gray-50",children:[e(Se,{companyInfo:n,themeConfig:v,onBack:()=>r(-1)}),t("main",{className:"max-w-4xl mx-auto p-4 space-y-6 pb-24",children:[e(Ee,{reservationDraft:s,primaryColor:v.colors.primary}),e("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:t("div",{className:"p-6 space-y-6",children:[e(Ue,{amount:s.montant,primaryColor:v.colors.primary}),t("div",{children:[t("h3",{className:"text-sm font-medium text-gray-700 mb-3 flex items-center gap-2",children:[e(q,{className:"w-5 h-5",style:{color:v.colors.primary}}),e("span",{children:"Moyen de paiement"})]}),e(Pe,{paymentMethod:M,onPaymentMethodSelect:H,companyInfo:n,reservationAmount:s.montant,primaryColor:v.colors.primary,secondaryColor:v.colors.secondary})]}),e(ke,{message:k,setMessage:G,primaryColor:v.colors.primary}),e(Me,{handleFileChange:J,file:g,primaryColor:v.colors.primary}),z&&e(je,{error:z})]})})]}),e(Re,{onClick:X,disabled:D||!k.trim()||!M,themeConfig:v,uploading:D})]})},Ce=({reservationDraft:r,companyInfo:a,slug:o})=>{const y=_(),u={colors:{primary:a.primaryColor||a.couleurPrimaire||"#3b82f6",text:a.primaryColor?R(a.primaryColor):"#ffffff"}};return b.useEffect(()=>{const w=setTimeout(()=>{y(`/${o}/reservation/${r.id}`,{state:{slug:o,companyInfo:a,reservation:{...r,id:r.id,statut:"preuve_recue",preuveMessage:r.preuveMessage||""}}})},1200);return()=>clearTimeout(w)},[y,r,a,o]),e("div",{className:"min-h-screen flex items-center justify-center p-4 bg-white",children:t("div",{className:"text-center max-w-md",children:[e("div",{className:"mx-auto mb-4 flex items-center justify-center",children:e("div",{className:"p-3 rounded-full",style:{backgroundColor:d(u.colors.primary,.1)},children:e(T,{className:"h-10 w-10",style:{color:u.colors.primary}})})}),e("h1",{className:"text-xl font-bold text-gray-900 mb-2",children:"Preuve envoyée avec succès !"}),e("p",{className:"text-gray-600",children:"Vous allez être redirigé vers votre réservation..."})]})})},Se=({companyInfo:r,themeConfig:a,onBack:o})=>e("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm",style:{backgroundColor:a.colors.primary,color:a.colors.text},children:t("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e("button",{onClick:o,className:"p-2 rounded-full hover:bg-white/10 transition",children:e(Y,{className:"h-5 w-5"})}),t("div",{className:"flex items-center gap-3",children:[(r==null?void 0:r.logoUrl)&&e(Z.LazyLoadImage,{src:r.logoUrl,alt:`Logo ${r.name}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:a.colors.text}}),e("h1",{className:"text-lg font-bold",children:"Envoyer la preuve de paiement"})]})]})}),Ee=({reservationDraft:r,primaryColor:a})=>{const o=r.tripType==="aller_retour",y=r.date?xe(ve(r.date),"EEEE d MMMM yyyy",{locale:Ne}):r.date;return t("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e("div",{className:"px-6 py-4 border-b",style:{backgroundColor:d(a,.05),borderColor:d(a,.2)},children:e("h3",{className:"text-lg font-semibold",style:{color:a},children:"Récapitulatif de votre réservation"})}),e("div",{className:"p-6 space-y-4 text-sm",children:t("div",{className:"flex items-start gap-4",children:[t("div",{className:"flex-1",children:[t("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:d(a,.1)},children:e(K,{className:"w-5 h-5",style:{color:a}})}),t("div",{children:[e("p",{className:"text-gray-500",children:"Trajet"}),t("p",{className:"font-semibold text-gray-900",children:[r.depart," ",e(ee,{className:"inline mx-1 w-4 h-4 text-gray-400"})," ",r.arrivee]})]})]}),t("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:d(a,.1)},children:e(re,{className:"w-5 h-5",style:{color:a}})}),t("div",{children:[e("p",{className:"text-gray-500",children:"Date et heure"}),t("p",{className:"font-semibold text-gray-900",children:[y," à ",r.heure]})]})]})]}),t("div",{className:"flex-1",children:[t("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:d(a,.1)},children:e(ae,{className:"w-5 h-5",style:{color:a}})}),t("div",{children:[e("p",{className:"text-gray-500",children:"Passager"}),e("p",{className:"font-semibold text-gray-900",children:r.nomClient})]})]}),t("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:d(a,.1)},children:e(te,{className:"w-5 h-5",style:{color:a}})}),t("div",{children:[e("p",{className:"text-gray-500",children:"Places"}),t("p",{className:"font-semibold text-gray-900",children:[r.seatsGo," ",o&&`+ ${r.seatsReturn} retour`]})]})]})]})]})})]})},Pe=({paymentMethod:r,onPaymentMethodSelect:a,companyInfo:o,reservationAmount:y,primaryColor:u,secondaryColor:w})=>{var S,n,P,U,E;const s=(o==null?void 0:o.paymentMethods)||{};return Object.keys(s).length===0?e("div",{className:"border-l-4 p-4 rounded-lg",style:{backgroundColor:d("#f59e0b",.05),borderColor:"#f59e0b"},children:t("div",{className:"flex items-start gap-3",children:[e(se,{className:"h-5 w-5 mt-0.5",style:{color:"#f59e0b"}}),e("p",{className:"text-sm",style:{color:"#92400e"},children:"Aucun moyen de paiement configuré pour cette compagnie. Veuillez contacter l'agence."})]})}):t("div",{children:[e("div",{className:"space-y-3",children:Object.entries(s).filter(([g,x])=>x).map(([g,x])=>x?t("button",{onClick:()=>a(g),className:`w-full flex items-center gap-4 p-4 rounded-lg border transition-all ${r===g?"border-blue-500 shadow-sm":"border-gray-200 hover:border-gray-300"}`,style:{backgroundColor:r===g?d(w,.2):"white"},children:[x.logoUrl?e("img",{src:x.logoUrl,alt:g,className:"h-10 w-10 object-contain rounded-lg"}):e("div",{className:"h-10 w-10 rounded-lg flex items-center justify-center",style:{backgroundColor:d(u,.1),color:u},children:e(q,{className:"w-5 h-5"})}),t("div",{className:"text-left flex-1",children:[e("div",{className:"font-medium capitalize",children:g.replace(/_/g," ")}),x.merchantNumber&&t("div",{className:"text-xs text-gray-500",children:["Numéro: ",x.merchantNumber]})]}),r===g&&e("div",{className:"ml-auto",children:e("div",{className:"w-5 h-5 rounded-full flex items-center justify-center",style:{backgroundColor:u,color:R(u)},children:e(T,{className:"w-3 h-3"})})})]},g):null)}),r&&((S=s[r])==null?void 0:S.ussdPattern)&&t("div",{className:"mt-4 p-4 rounded-lg",style:{backgroundColor:d(u,.05),border:`1px solid ${d(u,.2)}`},children:[e("p",{className:"text-sm font-medium mb-2",style:{color:u},children:"Code USSD généré :"}),e("div",{className:"p-3 rounded-lg font-mono text-center text-sm break-all",style:{backgroundColor:d(u,.1)},children:(E=(U=(n=s[r])==null?void 0:n.ussdPattern)==null?void 0:U.replace("MERCHANT",((P=s[r])==null?void 0:P.merchantNumber)||""))==null?void 0:E.replace("AMOUNT",y.toString())}),e("p",{className:"text-xs mt-2 text-gray-500",children:"Ce code sera automatiquement utilisé si l'application n'est pas disponible"})]})]})},Ue=({amount:r,primaryColor:a})=>t("div",{children:[e("h3",{className:"text-sm font-medium text-gray-700 mb-2",children:"Montant à payer"}),t("div",{className:"text-3xl font-bold py-3 px-4 rounded-lg",style:{backgroundColor:d(a,.1),color:a},children:[(r==null?void 0:r.toLocaleString("fr-FR"))||0," FCFA"]})]}),ke=({message:r,setMessage:a,primaryColor:o})=>t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Détails du paiement *"}),e("textarea",{placeholder:"Coller les détails du paiement (ex: ID de transaction, référence, numéro MTN/Moov...)",value:r,onChange:y=>a(y.target.value),className:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:outline-none",style:{borderColor:d(o,.3)},rows:4,required:!0}),e("p",{className:"text-xs text-gray-500 mt-1",children:'Exemple: "Paiement MTN Mobile Money - Réf: 5X8T9K - 05/07/2024"'})]}),Me=({handleFileChange:r,file:a,primaryColor:o})=>t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Capture d'écran (optionnel)"}),e("div",{className:"flex items-center justify-center w-full",children:t("label",{className:"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer transition-all hover:border-gray-400",style:{borderColor:a?o:d(o,.3),backgroundColor:a?d(o,.05):"white"},children:[e("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:a?t($,{children:[e(T,{className:"h-8 w-8 mb-2",style:{color:o}}),e("p",{className:"text-sm font-medium",style:{color:o},children:a.name}),e("p",{className:"text-xs text-gray-500 mt-1",children:"Cliquez pour changer de fichier"})]}):t($,{children:[e(le,{className:"h-8 w-8 text-gray-400 mb-2"}),e("p",{className:"text-sm text-gray-500",children:"Cliquez pour sélectionner un fichier"}),e("p",{className:"text-xs text-gray-400 mt-1",children:"PNG, JPG, PDF (max. 5MB)"})]})}),e("input",{type:"file",className:"hidden",onChange:r,accept:".png,.jpg,.jpeg,.pdf"})]})})]}),je=({error:r})=>e("div",{className:"border-l-4 p-4 rounded-lg",style:{backgroundColor:d("#ef4444",.05),borderColor:"#ef4444"},children:t("div",{className:"flex items-start gap-3",children:[e(oe,{className:"h-5 w-5 mt-0.5",style:{color:"#ef4444"}}),e("p",{className:"text-sm",style:{color:"#991b1b"},children:r})]})}),Re=({onClick:r,disabled:a,themeConfig:o,uploading:y})=>e("div",{className:"fixed bottom-0 left-0 w-full z-50 border-t border-gray-200 bg-white px-4 py-3 shadow-lg",children:e("div",{className:"max-w-4xl mx-auto",children:e("button",{onClick:r,disabled:a,className:"w-full py-3 px-4 rounded-lg font-medium transition-all hover:opacity-90",style:{backgroundColor:a?"#9ca3af":o.colors.primary,color:o.colors.text},children:y?t("span",{className:"flex items-center justify-center gap-2",children:[e(ne,{className:"h-5 w-5 animate-spin"}),"Envoi en cours..."]}):t("span",{className:"flex items-center justify-center gap-2",children:[e(T,{className:"h-5 w-5"}),"Confirmer l'envoi"]})})})});export{Ae as default};
