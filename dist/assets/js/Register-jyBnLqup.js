import{b as E,r as m,j as i,a as x,u as S}from"./react-KXT1Riez.js";import{d as I,M as q,N as A,o as u,q as L,v as g,x as o}from"./firebase-DYTOaTLw.js";import{b as $,d as c}from"../index-b0dmvJTQ.js";import"./vendor-B27hBV_J.js";function j(){const{search:r}=S();return Object.fromEntries(new URLSearchParams(r).entries())}function P(){const r=I($),d=E(),n=j().companyId||"",[s,b]=m.useState(localStorage.getItem("invitedEmail")||""),[f,p]=m.useState(""),[w,l]=m.useState(!0);return m.useEffect(()=>{(async()=>{try{const e=window.location.href,h=q(r,e);if(l(!0),h&&!s){l(!1);return}if(h&&s){const v=await A(r,s,e);localStorage.removeItem("invitedEmail");const a=v.user;if(n){const y=u(c,`companies/${n}/invites/${s.toLowerCase()}`),N=await L(y);if(N.exists()){const t=N.data();await g(u(c,"users",a.uid),{uid:a.uid,email:a.email,fullName:(t==null?void 0:t.fullName)||a.displayName||"",phone:(t==null?void 0:t.phone)||null,role:"admin_compagnie",companyId:n,status:"actif",createdAt:o(),updatedAt:o()},{merge:!0}),await g(u(c,`companies/${n}/personnel/${a.uid}`),{uid:a.uid,email:a.email,fullName:(t==null?void 0:t.fullName)||a.displayName||"",phone:(t==null?void 0:t.phone)||null,role:"admin_compagnie",createdAt:o(),updatedAt:o()},{merge:!0}),p("✅ Inscription réussie. Rôle admin compagnie appliqué."),d("/compagnie/dashboard",{replace:!0});return}}await g(u(c,"users",a.uid),{uid:a.uid,email:a.email,fullName:a.displayName||"",phone:a.phoneNumber||null,role:"user",status:"actif",updatedAt:o()},{merge:!0}),p("✅ Inscription réussie."),d("/",{replace:!0})}else l(!1)}catch(e){console.error(e),p(`❌ Erreur d'inscription: ${(e==null?void 0:e.message)||(e==null?void 0:e.code)||"inconnue"}`),l(!1)}})()},[r,s,n,d]),w?i("div",{className:"p-6",children:"Traitement…"}):x("div",{className:"p-6 max-w-md mx-auto",children:[i("h1",{className:"text-xl font-bold mb-2",children:"Confirmer votre email"}),i("p",{className:"text-sm text-gray-700 mb-4",children:"Entrez l’adresse email à laquelle le lien a été envoyé pour terminer la connexion."}),f&&i("p",{className:"mb-3 text-blue-700",children:f}),x("form",{onSubmit:e=>{e.preventDefault(),localStorage.setItem("invitedEmail",s.trim()),window.location.reload()},className:"grid gap-3",children:[i("input",{className:"border rounded px-3 py-2",type:"email",value:s,onChange:e=>b(e.target.value),placeholder:"votre@email.com",required:!0}),i("button",{className:"bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700",children:"Continuer"})]})]})}export{P as default};
