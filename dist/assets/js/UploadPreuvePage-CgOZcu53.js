import{j as e,a,X as _,b as q,u as W,d as Y,r as y,af as G,l as T,C as Z,k as K,M as ee,aA as re,n as te,ar as ae,aJ as se,I as le,F as L,U as oe,L as ne}from"./react-KXT1Riez.js";import{d as z,s as R,h as d,j as ce}from"../index-b0dmvJTQ.js";import{u as ie,r as de,t as me,w as ue,o as O,q as pe,_ as he,$ as ge,a0 as fe,y as be}from"./firebase-DYTOaTLw.js";import{f as ye,c as xe,p as Ne}from"./vendor-B27hBV_J.js";const ve=({error:r,navigate:t,slug:l,onRetry:u})=>e("div",{className:"min-h-screen flex items-center justify-center p-4 bg-white",children:a("div",{className:"text-center max-w-md",children:[e(_,{className:"mx-auto h-12 w-12 text-red-500 mb-4"}),e("h1",{className:"text-xl font-bold text-red-600 mb-2",children:"Une erreur est survenue"}),e("p",{className:"text-gray-600 mb-6",children:r}),u?e("button",{onClick:u,className:"bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition",children:"Réessayer"}):e("button",{onClick:()=>t==null?void 0:t(`/${l||""}`),className:"bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition",children:"Retour à l'accueil"})]})}),we=({message:r="Chargement...",colors:t})=>a("div",{className:"flex items-center justify-center min-h-screen text-lg",style:{backgroundColor:t.background,color:t.text},children:[e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 mr-4",style:{borderColor:t.primary}}),r]}),j="[UploadPreuvePage]",i={info:(...r)=>console.log(j,...r),warn:(...r)=>console.warn(j,...r),error:(...r)=>console.error(j,...r),group:r=>console.group(`${j} ${r}`),groupEnd:()=>console.groupEnd()},Ae=()=>{const r=q(),t=W(),{slug:l,id:u}=Y(),{draft:p,companyInfo:w}=t.state||{},[s,S]=y.useState(null),[n,E]=y.useState(null),[k,P]=y.useState(!0),[f,x]=y.useState(null),[U,B]=y.useState(""),[M,I]=y.useState(null),[$,A]=y.useState(!1),[F,N]=y.useState(null),[J,V]=y.useState(!1),D=y.useCallback(async()=>{i.group("loadInitialData");try{P(!0);let o=null;if(p&&w)i.info("Init from location.state"),o=w,S(p);else{const c=sessionStorage.getItem("reservationDraft"),b=sessionStorage.getItem("companyInfo");if(i.info("Init from sessionStorage",{hasDraft:!!c,hasCompany:!!b}),c&&b){const m=JSON.parse(c);if(o=JSON.parse(b),!(m!=null&&m.depart)||!(m!=null&&m.arrivee))throw new Error("Données de réservation incomplètes");S(m)}else throw new Error("Aucune donnée de réservation valide trouvée")}if(o!=null&&o.id){const c=await ie(de(me(z,"paymentMethods"),ue("companyId","==",o.id))),b={};c.forEach(g=>{const C=g.data();C.name&&(b[C.name]={logoUrl:C.logoUrl||"",url:C.defaultPaymentUrl||"",ussdPattern:C.ussdPattern||"",merchantNumber:C.merchantNumber||""})}),i.info("Payment methods",Object.keys(b));const m=O(z,"companies",o.id),h=await pe(m);if(h.exists()){const g=h.data();E({...o,paymentMethods:b,primaryColor:g.primaryColor||g.couleurPrimaire||"#3b82f6",secondaryColor:g.secondaryColor||g.couleurSecondaire||"#93c5fd",logoUrl:g.logoUrl||""}),i.info("Company info merged",{styles:{primary:g.couleurPrimaire,secondary:g.couleurSecondaire}});return}else throw new Error("Compagnie introuvable dans Firestore")}throw new Error("Impossible de récupérer les infos de la compagnie")}catch(o){i.error("loadInitialData error",o),N(o instanceof Error?o.message:"Erreur inconnue"),r(`/${l||""}`,{replace:!0,state:{error:"Erreur de chargement des données"}})}finally{P(!1),i.groupEnd()}},[p,w,r,l,u]);y.useEffect(()=>{D()},[D]);const H=o=>{try{if(!o.target.files||!o.target.files[0]){x(null);return}const c=o.target.files[0],b=["image/jpeg","image/png","application/pdf"],m=5*1024*1024;if(!b.includes(c.type))throw new Error("Type de fichier non supporté (JPEG, PNG ou PDF uniquement)");if(c.size>m)throw new Error("Le fichier est trop volumineux (max 5MB)");x(c),N(null),i.info("File selected",{name:c.name,size:c.size,type:c.type})}catch(c){N(c instanceof Error?c.message:"Erreur lors de la sélection du fichier"),x(null),i.warn("handleFileChange error",c)}},X=o=>{var c,b,m;try{const h=(c=n==null?void 0:n.paymentMethods)==null?void 0:c[o];if(!h)throw new Error("Méthode de paiement non disponible");if(I(o),N(null),i.info("Payment method selected",o),s){const g=(m=(b=h.ussdPattern)==null?void 0:b.replace("MERCHANT",h.merchantNumber||""))==null?void 0:m.replace("AMOUNT",s.montant.toString());h.url?(window.open(h.url,"_blank","noopener,noreferrer"),i.info("Open payment URL",h.url)):g&&(window.open(`tel:${g}`,"_blank","noopener,noreferrer"),i.info("Open USSD",g))}}catch(h){N(h instanceof Error?h.message:"Erreur de sélection du paiement"),i.warn("handlePaymentMethodSelect error",h)}},Q=async()=>{if(!s||!s.id){N("Réservation introuvable.");return}if(!M){N("Veuillez sélectionner un moyen de paiement.");return}if(!U&&!f){N("Veuillez fournir une preuve ou un message.");return}A(!0),N(null),i.group("handleUpload");try{let o=null;if(f){const b=f.name.split(".").pop(),m=`preuves/preuve_${Date.now()}.${b}`,h=he(ce,m),g=await ge(h,f);o=await fe(g.ref),i.info("File uploaded",{filename:m,preuveUrl:o})}const c={nomClient:s.nomClient,telephone:s.telephone,depart:s.depart,arrivee:s.arrivee,date:s.date,heure:s.heure,montant:s.montant,seatsGo:s.seatsGo,seatsReturn:s.seatsReturn||0,tripType:s.tripType,statut:"preuve_recue",canal:"en_ligne",preuveVia:M,preuveMessage:U.trim(),preuveUrl:o||null,companyId:s.companyId||"",companySlug:s.companySlug||"",updatedAt:new Date};i.info("Update payload (no ref code write)",c),await be(O(z,"companies",s.companyId,"agences",s.agencyId,"reservations",s.id),c),sessionStorage.removeItem("reservationDraft"),sessionStorage.removeItem("companyInfo"),V(!0),i.info("Upload success → setSuccess(true)")}catch(o){i.error("handleUpload error",o),N("Une erreur est survenue lors de l'envoi.")}finally{A(!1),i.groupEnd()}};if(k){const o={colors:{primary:(n==null?void 0:n.couleurPrimaire)||"#3b82f6",text:n!=null&&n.couleurPrimaire?R(n.couleurPrimaire):"#ffffff",background:"#f9fafb"}};return e(we,{colors:o.colors})}if(!s||!n)return e(ve,{slug:l,navigate:r,error:F||""});if(J)return e(Ce,{reservationDraft:s,companyInfo:n,slug:l});const v={colors:{primary:n.primaryColor||n.couleurPrimaire||"#3b82f6",secondary:n.secondaryColor||n.couleurSecondaire||"#93c5fd",text:n.primaryColor?R(n.primaryColor):"#ffffff"}};return a("div",{className:"min-h-screen bg-gray-50",children:[e(Se,{companyInfo:n,themeConfig:v,onBack:()=>r(-1)}),a("main",{className:"max-w-4xl mx-auto p-4 space-y-6 pb-24",children:[e(Pe,{reservationDraft:s,primaryColor:v.colors.primary}),e("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:a("div",{className:"p-6 space-y-6",children:[e(ke,{amount:s.montant,primaryColor:v.colors.primary}),a("div",{children:[a("h3",{className:"text-sm font-medium text-gray-700 mb-3 flex items-center gap-2",children:[e(G,{className:"w-5 h-5",style:{color:v.colors.primary}}),e("span",{children:"Moyen de paiement"})]}),e(Ee,{paymentMethod:M,onPaymentMethodSelect:X,companyInfo:n,reservationAmount:s.montant,primaryColor:v.colors.primary,secondaryColor:v.colors.secondary})]}),e(Ue,{message:U,setMessage:B,primaryColor:v.colors.primary}),e(Me,{handleFileChange:H,file:f,primaryColor:v.colors.primary}),F&&e(je,{error:F})]})})]}),e(Re,{onClick:Q,disabled:$||!U.trim()||!M,themeConfig:v,uploading:$})]})},Ce=({reservationDraft:r,companyInfo:t,slug:l})=>{const u=q(),p={colors:{primary:t.primaryColor||t.couleurPrimaire||"#3b82f6",text:t.primaryColor?R(t.primaryColor):"#ffffff"}};return y.useEffect(()=>{const w=setTimeout(()=>{u(`/${l}/reservation/${r.id}`,{state:{slug:l,companyInfo:t,reservation:{...r,id:r.id,statut:"preuve_recue",preuveMessage:r.preuveMessage||""}}})},1200);return()=>clearTimeout(w)},[u,r,t,l]),e("div",{className:"min-h-screen flex items-center justify-center p-4 bg-white",children:a("div",{className:"text-center max-w-md",children:[e("div",{className:"mx-auto mb-4 flex items-center justify-center",children:e("div",{className:"p-3 rounded-full",style:{backgroundColor:d(p.colors.primary,.1)},children:e(T,{className:"h-10 w-10",style:{color:p.colors.primary}})})}),e("h1",{className:"text-xl font-bold text-gray-900 mb-2",children:"Preuve envoyée avec succès !"}),e("p",{className:"text-gray-600",children:"Vous allez être redirigé vers votre réservation..."})]})})},Se=({companyInfo:r,themeConfig:t,onBack:l})=>e("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm",style:{backgroundColor:t.colors.primary,color:t.colors.text},children:a("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e("button",{onClick:l,className:"p-2 rounded-full hover:bg-white/10 transition",children:e(Z,{className:"h-5 w-5"})}),a("div",{className:"flex items-center gap-3",children:[(r==null?void 0:r.logoUrl)&&e(K.LazyLoadImage,{src:r.logoUrl,alt:`Logo ${r.name}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:t.colors.text}}),e("h1",{className:"text-lg font-bold",children:"Envoyer la preuve de paiement"})]})]})}),Pe=({reservationDraft:r,primaryColor:t})=>{const l=r.tripType==="aller_retour",u=r.date?ye(Ne(r.date),"EEEE d MMMM yyyy",{locale:xe}):r.date;return a("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e("div",{className:"px-6 py-4 border-b",style:{backgroundColor:d(t,.05),borderColor:d(t,.2)},children:e("h3",{className:"text-lg font-semibold",style:{color:t},children:"Récapitulatif de votre réservation"})}),e("div",{className:"p-6 space-y-4 text-sm",children:a("div",{className:"flex items-start gap-4",children:[a("div",{className:"flex-1",children:[a("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:d(t,.1)},children:e(ee,{className:"w-5 h-5",style:{color:t}})}),a("div",{children:[e("p",{className:"text-gray-500",children:"Trajet"}),a("p",{className:"font-semibold text-gray-900",children:[r.depart," ",e(re,{className:"inline mx-1 w-4 h-4 text-gray-400"})," ",r.arrivee]})]})]}),a("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:d(t,.1)},children:e(te,{className:"w-5 h-5",style:{color:t}})}),a("div",{children:[e("p",{className:"text-gray-500",children:"Date et heure"}),a("p",{className:"font-semibold text-gray-900",children:[u," à ",r.heure]})]})]})]}),a("div",{className:"flex-1",children:[a("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:d(t,.1)},children:e(ae,{className:"w-5 h-5",style:{color:t}})}),a("div",{children:[e("p",{className:"text-gray-500",children:"Passager"}),e("p",{className:"font-semibold text-gray-900",children:r.nomClient})]})]}),a("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:d(t,.1)},children:e(se,{className:"w-5 h-5",style:{color:t}})}),a("div",{children:[e("p",{className:"text-gray-500",children:"Places"}),a("p",{className:"font-semibold text-gray-900",children:[r.seatsGo," ",l&&`+ ${r.seatsReturn} retour`]})]})]})]})]})})]})},Ee=({paymentMethod:r,onPaymentMethodSelect:t,companyInfo:l,reservationAmount:u,primaryColor:p,secondaryColor:w})=>{var S,n,E,k,P;const s=(l==null?void 0:l.paymentMethods)||{};return Object.keys(s).length===0?e("div",{className:"border-l-4 p-4 rounded-lg",style:{backgroundColor:d("#f59e0b",.05),borderColor:"#f59e0b"},children:a("div",{className:"flex items-start gap-3",children:[e(le,{className:"h-5 w-5 mt-0.5",style:{color:"#f59e0b"}}),e("p",{className:"text-sm",style:{color:"#92400e"},children:"Aucun moyen de paiement configuré pour cette compagnie. Veuillez contacter l'agence."})]})}):a("div",{children:[e("div",{className:"space-y-3",children:Object.entries(s).filter(([f,x])=>x).map(([f,x])=>x?a("button",{onClick:()=>t(f),className:`w-full flex items-center gap-4 p-4 rounded-lg border transition-all ${r===f?"border-blue-500 shadow-sm":"border-gray-200 hover:border-gray-300"}`,style:{backgroundColor:r===f?d(w,.2):"white"},children:[x.logoUrl?e("img",{src:x.logoUrl,alt:f,className:"h-10 w-10 object-contain rounded-lg"}):e("div",{className:"h-10 w-10 rounded-lg flex items-center justify-center",style:{backgroundColor:d(p,.1),color:p},children:e(G,{className:"w-5 h-5"})}),a("div",{className:"text-left flex-1",children:[e("div",{className:"font-medium capitalize",children:f.replace(/_/g," ")}),x.merchantNumber&&a("div",{className:"text-xs text-gray-500",children:["Numéro: ",x.merchantNumber]})]}),r===f&&e("div",{className:"ml-auto",children:e("div",{className:"w-5 h-5 rounded-full flex items-center justify-center",style:{backgroundColor:p,color:R(p)},children:e(T,{className:"w-3 h-3"})})})]},f):null)}),r&&((S=s[r])==null?void 0:S.ussdPattern)&&a("div",{className:"mt-4 p-4 rounded-lg",style:{backgroundColor:d(p,.05),border:`1px solid ${d(p,.2)}`},children:[e("p",{className:"text-sm font-medium mb-2",style:{color:p},children:"Code USSD généré :"}),e("div",{className:"p-3 rounded-lg font-mono text-center text-sm break-all",style:{backgroundColor:d(p,.1)},children:(P=(k=(n=s[r])==null?void 0:n.ussdPattern)==null?void 0:k.replace("MERCHANT",((E=s[r])==null?void 0:E.merchantNumber)||""))==null?void 0:P.replace("AMOUNT",u.toString())}),e("p",{className:"text-xs mt-2 text-gray-500",children:"Ce code sera automatiquement utilisé si l'application n'est pas disponible"})]})]})},ke=({amount:r,primaryColor:t})=>a("div",{children:[e("h3",{className:"text-sm font-medium text-gray-700 mb-2",children:"Montant à payer"}),a("div",{className:"text-3xl font-bold py-3 px-4 rounded-lg",style:{backgroundColor:d(t,.1),color:t},children:[(r==null?void 0:r.toLocaleString("fr-FR"))||0," FCFA"]})]}),Ue=({message:r,setMessage:t,primaryColor:l})=>a("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Détails du paiement *"}),e("textarea",{placeholder:"Coller les détails du paiement (ex: ID de transaction, référence, numéro MTN/Moov...)",value:r,onChange:u=>t(u.target.value),className:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:outline-none",style:{borderColor:d(l,.3)},rows:4,required:!0}),e("p",{className:"text-xs text-gray-500 mt-1",children:'Exemple: "Paiement MTN Mobile Money - Réf: 5X8T9K - 05/07/2024"'})]}),Me=({handleFileChange:r,file:t,primaryColor:l})=>a("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Capture d'écran (optionnel)"}),e("div",{className:"flex items-center justify-center w-full",children:a("label",{className:"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer transition-all hover:border-gray-400",style:{borderColor:t?l:d(l,.3),backgroundColor:t?d(l,.05):"white"},children:[e("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:t?a(L,{children:[e(T,{className:"h-8 w-8 mb-2",style:{color:l}}),e("p",{className:"text-sm font-medium",style:{color:l},children:t.name}),e("p",{className:"text-xs text-gray-500 mt-1",children:"Cliquez pour changer de fichier"})]}):a(L,{children:[e(oe,{className:"h-8 w-8 text-gray-400 mb-2"}),e("p",{className:"text-sm text-gray-500",children:"Cliquez pour sélectionner un fichier"}),e("p",{className:"text-xs text-gray-400 mt-1",children:"PNG, JPG, PDF (max. 5MB)"})]})}),e("input",{type:"file",className:"hidden",onChange:r,accept:".png,.jpg,.jpeg,.pdf"})]})})]}),je=({error:r})=>e("div",{className:"border-l-4 p-4 rounded-lg",style:{backgroundColor:d("#ef4444",.05),borderColor:"#ef4444"},children:a("div",{className:"flex items-start gap-3",children:[e(_,{className:"h-5 w-5 mt-0.5",style:{color:"#ef4444"}}),e("p",{className:"text-sm",style:{color:"#991b1b"},children:r})]})}),Re=({onClick:r,disabled:t,themeConfig:l,uploading:u})=>e("div",{className:"fixed bottom-0 left-0 w-full z-50 border-t border-gray-200 bg-white px-4 py-3 shadow-lg",children:e("div",{className:"max-w-4xl mx-auto",children:e("button",{onClick:r,disabled:t,className:"w-full py-3 px-4 rounded-lg font-medium transition-all hover:opacity-90",style:{backgroundColor:t?"#9ca3af":l.colors.primary,color:l.colors.text},children:u?a("span",{className:"flex items-center justify-center gap-2",children:[e(ne,{className:"h-5 w-5 animate-spin"}),"Envoi en cours..."]}):a("span",{className:"flex items-center justify-center gap-2",children:[e(T,{className:"h-5 w-5"}),"Confirmer l'envoi"]})})})});export{Ae as default};
