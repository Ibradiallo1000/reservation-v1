import{r as o,j as t,a as n,v as se,x as Te,C as Ie,X as Ve,Y as Le,T as ae,L as Fe,w as oe,ap as Ke,aq as Be,ar as Ue}from"./vendor-Bq-8_m9i.js";import{u as F,t as ne,M as qe}from"./firebase-CURBI7X6.js";import{m as ze,O as S,P as Ye,w as _e,G as Xe,B as He,l as C,d as K}from"./agence-Bsj2lp2X.js";import{a as Je}from"./router-DoGdw-3y.js";import{a9 as Qe,ad as re,ae as We,aw as ie,aI as Ze,g as et,D as tt,ar as st}from"./icons-C0JHUK9Z.js";import"./compagnie-DiuZFnHS.js";import"./courier-CoQgRaHG.js";const N=new Intl.NumberFormat("fr-FR"),le=c=>Number.isFinite(Number(c))?Number(c):0,B=c=>`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}-${String(c.getDate()).padStart(2,"0")}`,$=(c,f)=>{const u=new Date(c);return u.setDate(u.getDate()+f),u},mt=()=>{const c=Je(),f=ze(),[u,ce]=o.useState("30j"),[de,U]=o.useState(!0),[q,z]=o.useState(null),[me,ue]=o.useState(0),[R,pe]=o.useState(0),[M,he]=o.useState(0),[j,ge]=o.useState(0),[A,fe]=o.useState(0),[D,ve]=o.useState(0),[G,ye]=o.useState(0),[k,be]=o.useState(0),[p,xe]=o.useState(null),[y,we]=o.useState([]),[E,Se]=o.useState([]);o.useEffect(()=>{(async()=>{var l;U(!0),z(null);try{const i=new Date,d=$(i,-29),r=$(i,-59),O=(await F(ne(K,"companies"))).docs.map(s=>{const a=s.data();return{id:s.id,nom:a.nom||"",plan:a.plan||"free",planId:a.planId,status:a.status||"actif",pays:a.pays||"Non défini",createdAt:a.createdAt}}),_=O.filter(s=>s.status==="actif"),$e=O.filter(s=>{var w;const a=(w=s.createdAt)==null?void 0:w.seconds;return a?new Date(a*1e3)>=d:!1}),Re=await F(ne(K,"plans")),P={};Re.docs.forEach(s=>{const a=s.data();P[s.id]={id:s.id,name:a.name??a.nom??"",priceMonthly:Number(a.priceMonthly)||0}});const Me=new Set(Object.entries(P).filter(([,s])=>s.priceMonthly>0).map(([s])=>s));let X=0,H=0;_.forEach(s=>{const a=s.planId||"",m=P[a];m&&Me.has(a)&&(H++,X+=m.priceMonthly)}),pe(_.length),he($e.length),ge(H),fe(X);const je=await F(qe(K,"reservations"));let T=0,J=0,Q=0;const I=new Map,V=new Map,L={},W={};O.forEach(s=>{W[s.id]=s.pays||"Non défini"});for(const s of je.docs){const a=s.data(),m=le(a.total??a.montant),w=le(a.commission),Ee=a.companyId||"",ee=W[Ee]||"Non défini",te=(l=a.createdAt)!=null&&l.seconds?a.createdAt.seconds*1e3:null;if(!te)continue;const g=new Date(te),Oe=g>=d&&g<=i,Pe=g>=r&&g<d;if(Oe){T+=m,J+=w,Q++;const v=B(g),h=I.get(v)??{gmv:0,reservations:0};h.gmv+=m,h.reservations+=1,I.set(v,h),L[ee]=(L[ee]||0)+m}if(Pe){const v=B(g),h=V.get(v)??{gmv:0,reservations:0};h.gmv+=m,h.reservations+=1,V.set(v,h)}}ve(J),ye(T),be(Q);const Ae=T;let b=0;V.forEach(s=>b+=s.gmv);const De=b>0?(Ae-b)/b*100:null;xe(De);const Ge=u==="7j"?$(i,-6):d,Z=[];let x=new Date(Ge);for(;x<=i;){const s=B(x),a=I.get(s)??{gmv:0,reservations:0};Z.push({date:s,...a}),x=$(x,1)}Se(Z);const ke=Object.entries(L).map(([s,a])=>({name:s,value:a}));we(ke)}catch(i){console.error(i),z(f?"Erreur lors du chargement des indicateurs admin.":"Connexion indisponible. Impossible de charger le dashboard admin.")}finally{U(!1)}})()},[u,f,me]);const Ce=o.useMemo(()=>[{label:"Compagnies actives",value:N.format(R),icon:Qe,color:"text-purple-600",to:"/admin/compagnies"},{label:"Nouvelles (30j)",value:N.format(M),icon:re,color:"text-emerald-600",to:"/admin/compagnies"},{label:"Abonnements actifs",value:N.format(j),icon:We,color:"text-blue-600",to:"/admin/plans"},{label:"MRR",value:S(A),icon:ie,color:"text-green-600",to:"/admin/finances"},{label:"Commission totale",value:S(D),icon:Ze,color:"text-orange-600",to:"/admin/finances"},{label:"GMV global",value:S(G),icon:ie,color:"text-slate-600",to:void 0},{label:"Réservations totales",value:N.format(k),icon:et,color:"text-indigo-600",to:void 0},{label:"Croissance mensuelle",value:p!==null?`${p>=0?"+":""}${p.toFixed(1)}%`:"—",icon:re,color:p!==null&&p>=0?"text-green-600":"text-red-600",to:void 0}],[R,M,j,A,D,G,k,p]),Ne=()=>{const e=[];e.push("=== Métriques SaaS (Teliya) ==="),e.push(`Compagnies actives;${R}`),e.push(`Nouvelles (30j);${M}`),e.push(`Abonnements actifs;${j}`),e.push(`MRR (${C()});${A}`),e.push(`Commission totale (${C()});${D}`),e.push(""),e.push("=== Métriques macro (anonymisées) ==="),e.push(`GMV global (${C()});${G}`),e.push(`Réservations totales;${k}`),e.push(`Croissance mensuelle (%);${p??"N/A"}`),e.push(""),e.push("=== Répartition par pays (anonymisée) ==="),e.push("Pays;GMV"),y.forEach(r=>e.push(`${r.name};${r.value}`)),e.push(""),e.push("=== Tendances ==="),e.push("Date;GMV;Réservations"),E.forEach(r=>e.push(`${r.date};${r.gmv};${r.reservations}`));const l=new Blob([e.join(`
`)],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(l),d=document.createElement("a");d.href=i,d.download="teliya_dashboard_export.csv",d.click(),URL.revokeObjectURL(i)},Y=["#ea580c","#2563eb","#16a34a","#9333ea","#0d9488"];return de?t(Ye,{blocks:3}):n("div",{className:"space-y-6",children:[!f&&t(_e,{message:"Connexion instable: les données peuvent être incomplètes."}),q&&t(Xe,{message:q,onRetry:()=>ue(e=>e+1)}),n("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[n("div",{children:[t("h2",{className:"text-2xl font-bold text-gray-900",children:"Vue d’ensemble plateforme"}),t("p",{className:"text-gray-600",children:"Métriques SaaS Teliya et indicateurs macro agrégés (anonymisés)."})]}),n("div",{className:"flex flex-col sm:flex-row gap-2 sm:items-center",children:[t("div",{className:"flex gap-2",children:["7j","30j"].map(e=>t("button",{onClick:()=>ce(e),className:`px-3 py-1 rounded-full text-sm font-medium transition ${u===e?"bg-[var(--btn-primary,#FF6600)] text-white shadow-sm":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:e==="7j"?"7 jours":"30 jours"},e))}),n(He,{onClick:Ne,variant:"primary",size:"sm",children:[t(tt,{className:"h-4 w-4"})," Export CSV"]})]})]}),t("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:Ce.map(({label:e,value:l,icon:i,color:d,to:r})=>n("button",{onClick:()=>r&&c(r),disabled:!r,className:`text-left bg-white p-4 rounded-xl border shadow-sm hover:shadow-md transition focus:outline-none focus:ring-2 focus:ring-orange-200 ${r?"cursor-pointer hover:translate-y-[-1px]":"cursor-default"}`,children:[t(i,{className:`h-6 w-6 mb-2 ${d}`}),t("p",{className:"text-sm text-gray-500",children:e}),t("p",{className:"text-lg font-bold",children:l})]},e))}),n("section",{className:"bg-white p-6 rounded-xl shadow-sm border",children:[t("h3",{className:"text-lg font-semibold mb-4",children:"Tendances (macro agrégé)"}),E.length===0?t("p",{className:"text-gray-500 text-sm",children:"Pas assez de données."}):t("div",{className:"h-72 w-full",children:t(se,{width:"100%",height:"100%",children:n(Te,{data:E,children:[n("defs",{children:[n("linearGradient",{id:"gmv",x1:"0",y1:"0",x2:"0",y2:"1",children:[t("stop",{offset:"5%",stopColor:"#16a34a",stopOpacity:.25}),t("stop",{offset:"95%",stopColor:"#16a34a",stopOpacity:0})]}),n("linearGradient",{id:"bookings",x1:"0",y1:"0",x2:"0",y2:"1",children:[t("stop",{offset:"5%",stopColor:"#2563eb",stopOpacity:.25}),t("stop",{offset:"95%",stopColor:"#2563eb",stopOpacity:0})]})]}),t(Ie,{strokeDasharray:"3 3",stroke:"#e5e7eb"}),t(Ve,{dataKey:"date",tick:{fontSize:12,fill:"#64748b"}}),t(Le,{}),t(ae,{}),t(Fe,{}),t(oe,{type:"monotone",dataKey:"gmv",name:`GMV (${C()})`,stroke:"#16a34a",fill:"url(#gmv)"}),t(oe,{type:"monotone",dataKey:"reservations",name:"Réservations",stroke:"#2563eb",fill:"url(#bookings)"})]})})})]}),n("section",{className:"bg-white p-6 rounded-xl shadow-sm border",children:[n("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[t(st,{className:"h-5 w-5 text-gray-600"})," Répartition par pays (GMV agrégé)"]}),y.length===0?t("p",{className:"text-gray-500 text-sm",children:"Aucune donnée par pays."}):t("div",{className:"h-64 w-full max-w-md",children:t(se,{width:"100%",height:"100%",children:n(Ke,{children:[t(Be,{data:y,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:({name:e,percent:l})=>`${e} ${(l*100).toFixed(0)}%`,children:y.map((e,l)=>t(Ue,{fill:Y[l%Y.length]},l))}),t(ae,{formatter:e=>[S(e),"GMV"]})]})})})]})]})};export{mt as default};
