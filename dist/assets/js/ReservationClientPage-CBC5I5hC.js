import{d as Se,b as Ce,u as De,r as m,a as r,j as e,C as Ie,a3 as ke,aQ as Pe,ba as je,bb as Te}from"./react-DgrrIcw2.js";import{m as T,d as N}from"../index-p6Te0bSg.js";import{d as $e,f as Ae,A as _e,k as C,l as k,q as J,w as q}from"./firebase-eGIzIftJ.js";import{ax as ie,p as $,o as ce,ay as Ee,J as Fe,a5 as Le}from"./vendor-BHjJ2Hjk.js";const Oe=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],A=n=>n?n.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/-/g," ").replace(/\s+/g," "):"",de=n=>n.charAt(0).toUpperCase()+n.slice(1).toLowerCase(),qe=()=>{var ee,ae;const{slug:n}=Se(),me=Ce(),H=De(),B=new URLSearchParams(me.search),f=A(B.get("departure")||""),b=A(B.get("arrival")||""),[l,V]=m.useState({id:"",name:"",couleurPrimaire:"#3b82f6",couleurSecondaire:"#93c5fd",logoUrl:""}),[_,G]=m.useState({nom:"",telephone:""}),[Q,Y]=m.useState([]),[E,K]=m.useState([]),[x,F]=m.useState(""),[P,W]=m.useState(""),[u,L]=m.useState({fullName:"",phone:"",email:""}),[g,X]=m.useState(1),[w,ue]=m.useState(!0),[Z,O]=m.useState("");m.useEffect(()=>{const a=sessionStorage.getItem(`preload_${n}_${f}_${b}`);if(a)try{const{company:t,trips:p,dates:i,agencyInfo:h}=JSON.parse(a);V(t),Y(p),K(i),F(i[0]||""),G(h)}catch(t){console.error("Error parsing cached data:",t)}},[n,f,b]),m.useEffect(()=>{if(!n||!f||!b)return;(async()=>{try{const[t,p]=await Promise.all([pe(),he()]);if(t&&(V(t),sessionStorage.setItem("companyInfo",JSON.stringify(t))),p){const{trips:i,dates:h,agencyInfo:j}=p;Y(i),K(h),F(h[0]||""),G(j),sessionStorage.setItem(`preload_${n}_${f}_${b}`,JSON.stringify({company:t,trips:i,dates:h,agencyInfo:j,timestamp:Date.now()}))}}catch(t){console.error("Error loading data:",t),O("Une erreur est survenue lors du chargement des données")}finally{ue(!1)}})()},[n,f,b]);const pe=async()=>{const a=await k(J(C(N,"companies"),q("slug","==",n)));if(a.empty)return null;const t=a.docs[0];return{id:t.id,name:t.data().nom||"",couleurPrimaire:t.data().couleurPrimaire||"#3b82f6",couleurSecondaire:t.data().couleurSecondaire||"#93c5fd",logoUrl:t.data().logoUrl||"",slug:n}},he=async()=>{const a=await k(J(C(N,"companies"),q("slug","==",n)));if(a.empty)return null;const t=a.docs[0].id,i=(await k(C(N,"companies",t,"agences"))).docs.map(c=>({id:c.id,nom:c.data().nom||"",telephone:c.data().telephone||""})),h=i.length>0?{nom:i[0].nom,telephone:i[0].telephone}:{nom:"",telephone:""},j=Array.from({length:8},(c,v)=>{const I=new Date;return I.setDate(I.getDate()+v),I.toISOString().split("T")[0]}),re=[];await Promise.all(i.map(async c=>{const[v,I]=await Promise.all([k(J(C(N,"companies",t,"agences",c.id,"weeklyTrips"),q("active","==",!0))),k(C(N,"companies",t,"agences",c.id,"reservations"))]),ve=v.docs.map(d=>({id:d.id,...d.data()})).filter(d=>{const z=A(d.depart||d.departure||""),R=A(d.arrivee||d.arrival||"");return z===f&&R===b}),Ne=I.docs.map(d=>d.data());j.forEach(d=>{const z=new Date(d),R=Oe[z.getDay()];ve.forEach(y=>{var te;(((te=y.horaires)==null?void 0:te[R])||[]).forEach(M=>{const oe=`${y.id}_${d}_${M}`;if(d===new Date().toISOString().split("T")[0]){const S=new Date;if(ce(M,"HH:mm",new Date)<=S)return}const we=Ne.filter(S=>S.trajetId===oe&&["payé","preuve_recue"].includes(S.statut)).reduce((S,le)=>S+(le.seatsGo||0),0),se=y.places||30,ne=se-we;ne>0&&re.push({id:oe,date:d,time:M,departure:y.depart||y.departure||"",arrival:y.arrivee||y.arrival||"",price:y.price,agencyId:c.id,companyId:t,places:se,remainingSeats:ne})})})})}));const U=re.sort((c,v)=>c.date.localeCompare(v.date)),xe=[...new Set(U.map(c=>c.date))].filter(c=>U.some(v=>v.date===c));return{trips:U,dates:xe,agencyInfo:h}},D=m.useMemo(()=>{if(!x)return[];const a=Q.filter(t=>t.date===x);if(ie($(x))){const t=new Date;return a.filter(p=>ce(p.time,"HH:mm",new Date)>t)}return a},[Q,x]),s=D.find(a=>a.time===P),ge=a=>{const t=$(a);return Fe(t,"EEE d",{locale:Le})},ye=async()=>{if(s){if(!u.fullName||!u.phone)return O("Veuillez remplir votre nom complet et numéro de téléphone");try{const a=$e(N,"companies",s.companyId,"agences",s.agencyId),p=(await Ae(a)).data()||{},i={nomClient:u.fullName,telephone:u.phone,email:u.email||null,depart:s.departure,arrivee:s.arrival,date:s.date,heure:s.time,montant:s.price*g,seatsGo:g,statut:"en_attente",canal:"en_ligne",tripType:"aller_simple",companyId:s.companyId,agencyId:s.agencyId,agencyNom:p.nom||"",agencyTelephone:p.telephone||"",trajetId:s.id,referenceCode:`RES${Date.now()}`,companySlug:n,companyName:l.name,createdAt:new Date,updatedAt:new Date},h=await _e(C(N,"companies",s.companyId,"agences",s.agencyId,"reservations"),i);sessionStorage.setItem("reservationDraft",JSON.stringify({...i,id:h.id})),sessionStorage.setItem("companyInfo",JSON.stringify(l)),H(`/${n}/upload-preuve/${h.id}`)}catch(a){console.error("Booking error:",a),O("Une erreur est survenue lors de la réservation")}}},fe=()=>e("div",{className:"h-12 w-16 bg-gray-200 rounded-lg animate-pulse"}),be=()=>e("div",{className:"h-20 bg-gray-200 rounded-lg animate-pulse"}),o=m.useMemo(()=>({primary:l.couleurPrimaire,secondary:l.couleurSecondaire,lightPrimary:`${l.couleurPrimaire}20`,lightSecondary:`${l.couleurSecondaire}20`,textOnPrimary:"#ffffff"}),[l.couleurPrimaire,l.couleurSecondaire]);return w||!l.id||E.length===0?r("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gray-50",children:[r(T.div,{initial:{opacity:0,y:-50,scale:.5},animate:{opacity:1,y:0,scale:1},transition:{duration:.8,ease:"easeOut"},className:"relative flex items-center justify-center mb-6",children:[e(T.div,{className:"absolute w-28 h-28 rounded-full",style:{backgroundColor:l.couleurPrimaire,opacity:.2},animate:{scale:[1,1.4,1],opacity:[.2,0,.2]},transition:{duration:2,repeat:1/0}}),e(T.img,{src:l.logoUrl,alt:"Logo compagnie",className:"h-20 w-20 rounded-full object-cover border-4 shadow-lg",style:{borderColor:l.couleurSecondaire},whileHover:{scale:1.05}})]}),e(T.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.6,duration:.6},className:"text-gray-600 font-medium",children:"Recherche en cours..."})]}):r("div",{className:"min-h-screen bg-gray-50 pb-24",children:[e("header",{className:"p-4 shadow-sm sticky top-0 z-50",style:{backgroundColor:o.primary},children:r("div",{className:"max-w-5xl mx-auto flex items-center justify-between text-white",children:[e("button",{onClick:()=>H(-1),className:"hover:opacity-80 transition-opacity",children:e(Ie,{className:"w-6 h-6"})}),r("div",{className:"flex items-center gap-3",children:[l.logoUrl&&e("img",{src:l.logoUrl,alt:"logo",className:"h-8 w-8 rounded-full object-cover border border-white"}),e("span",{className:"font-semibold text-lg",children:l.name})]})]})}),_.nom&&e("div",{className:"bg-white py-2 px-4 border-b border-gray-100",children:r("div",{className:"max-w-5xl mx-auto text-sm text-gray-600",children:["Agence : ",_.nom," — ",_.telephone]})}),r("main",{className:"max-w-5xl mx-auto p-4",children:[r("section",{className:"flex items-center justify-between bg-white p-4 mb-6 rounded-xl shadow-sm border",style:{borderColor:o.primary},children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 rounded-full",style:{backgroundColor:o.lightPrimary},children:e(ke,{className:"w-5 h-5",style:{color:o.primary}})}),r("h1",{className:"font-semibold text-lg text-gray-900",children:[de(f)," → ",de(b)]})]}),e("div",{className:"text-right font-bold text-lg",style:{color:o.primary},children:(s==null?void 0:s.price)??((ee=D[0])==null?void 0:ee.price)?`${((s==null?void 0:s.price)??((ae=D[0])==null?void 0:ae.price)).toLocaleString("fr-FR")} FCFA`:"Prix non disponible"})]}),w&&r("div",{className:"space-y-6",children:[e("div",{className:"flex justify-center items-center py-12",children:e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2",style:{borderColor:o.primary}})}),e("div",{className:"flex space-x-3",children:[...Array(5)].map((a,t)=>e(fe,{},t))}),e("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3",children:[...Array(6)].map((a,t)=>e(be,{},t))})]}),Z&&e("div",{className:"mb-6 p-4 bg-red-50 rounded-lg border border-red-200",children:r("div",{className:"flex items-center gap-3 text-red-800",children:[e("svg",{className:"h-5 w-5 flex-shrink-0",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),e("span",{children:Z})]})}),!w&&E.length>0&&r("div",{className:"mb-8 p-5 rounded-xl shadow-sm border",style:{backgroundColor:o.lightPrimary,borderColor:o.primary},children:[r("div",{className:"flex items-center mb-4",children:[e("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold mr-3 text-white",style:{backgroundColor:o.primary},children:"1"}),e("h2",{className:"text-lg font-semibold text-gray-900",children:"Choisissez votre date du voyage"})]}),e("div",{className:"overflow-x-auto pb-2",children:e("div",{className:"flex space-x-3 w-max",children:E.map(a=>r("button",{onClick:()=>{F(a),W("")},className:`py-2 px-4 rounded-lg border transition-all flex flex-col items-center min-w-[80px] ${x===a?"shadow-sm":"bg-white text-gray-700 border-gray-200 hover:border-gray-300"}`,style:{borderColor:x===a?o.primary:"",backgroundColor:x===a?o.lightPrimary:"white"},children:[e("div",{className:"font-medium text-sm",children:ge(a)}),ie($(a))&&e("div",{className:"text-xs mt-1",children:"Aujourd'hui"}),Ee($(a))&&e("div",{className:"text-xs mt-1",children:"Demain"})]},a))})})]}),!w&&D.length>0&&r("div",{className:"mb-8 p-5 rounded-xl shadow-sm border",style:{backgroundColor:o.lightSecondary,borderColor:o.secondary},children:[r("div",{className:"flex items-center mb-4",children:[e("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold mr-3 text-white",style:{backgroundColor:o.secondary},children:"2"}),e("h2",{className:"text-lg font-semibold text-gray-900",children:"Choisissez votre heure de depart"})]}),e("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3",children:D.map(a=>r("button",{onClick:()=>W(a.time),className:`py-3 px-4 rounded-lg border transition-all ${P===a.time?"shadow-sm":"bg-white text-gray-700 border-gray-200 hover:border-gray-300"}`,style:{borderColor:P===a.time?o.secondary:"",backgroundColor:P===a.time?o.lightSecondary:"white"},children:[e("div",{className:"font-bold text-center text-lg",children:a.time}),r("div",{className:"text-sm text-center mt-1",children:[a.remainingSeats," place",a.remainingSeats>1?"s":""]})]},a.id))})]}),!w&&s&&r("div",{className:"bg-white p-5 rounded-xl shadow-sm border border-gray-100",children:[r("div",{className:"flex items-center mb-4",children:[e("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold mr-3 text-white",style:{backgroundColor:o.primary},children:"3"}),e("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations personnelles"})]}),r("div",{className:"space-y-4",children:[r("div",{children:[e("label",{htmlFor:"fullName",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nom complet *"}),e("input",{id:"fullName",type:"text",placeholder:"Votre nom complet",value:u.fullName,onChange:a=>L({...u,fullName:a.target.value}),className:"w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:outline-none focus:ring-blue-500",style:{borderColor:o.lightPrimary},required:!0})]}),r("div",{children:[e("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:"Numéro de téléphone *"}),r("div",{className:"relative",children:[e("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e(Pe,{className:"h-5 w-5 text-gray-400"})}),e("input",{id:"phone",type:"tel",placeholder:"Votre numéro de téléphone",value:u.phone,onChange:a=>L({...u,phone:a.target.value}),className:"w-full pl-10 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:outline-none focus:ring-blue-500",style:{borderColor:o.lightPrimary},required:!0})]})]}),r("div",{children:[e("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email (facultatif)"}),e("input",{id:"email",type:"email",placeholder:"Votre email",value:u.email,onChange:a=>L({...u,email:a.target.value}),className:"w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:outline-none focus:ring-blue-500",style:{borderColor:o.lightPrimary}})]}),r("div",{children:[r("label",{htmlFor:"seats",className:"block text-sm font-medium text-gray-700 mb-1",children:["Nombre de places (",s.remainingSeats," disponible",s.remainingSeats>1?"s":"",")"]}),r("div",{className:"flex items-center space-x-4",children:[e("button",{onClick:()=>X(Math.max(1,g-1)),className:"w-10 h-10 rounded-full flex items-center justify-center border",style:{borderColor:o.lightPrimary,color:o.primary},children:e(je,{className:"w-5 h-5"})}),e("span",{className:"text-lg font-semibold px-4 py-2 rounded-lg",style:{backgroundColor:o.lightPrimary,color:o.primary},children:g}),e("button",{onClick:()=>X(Math.min(10,s.remainingSeats,g+1)),className:"w-10 h-10 rounded-full flex items-center justify-center border",style:{borderColor:o.lightPrimary,color:o.primary},children:e(Te,{className:"w-5 h-5"})})]})]})]})]})]}),!w&&s&&e("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-3 px-4 shadow-lg",children:r("div",{className:"max-w-5xl mx-auto flex justify-between items-center",children:[r("div",{children:[r("div",{className:"text-sm text-gray-600",children:["Total pour ",g," place",g>1?"s":""]}),r("div",{className:"font-bold text-lg",style:{color:o.primary},children:[s.price*g," FCFA"]})]}),e("button",{onClick:ye,className:"py-3 px-6 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition-all",style:{backgroundColor:o.secondary},children:"Confirmer la réservation"})]})})]})};export{qe as default};
