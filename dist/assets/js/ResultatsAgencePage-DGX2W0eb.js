import{u as he,t as fe,a5 as ge,r as n,j as e,w as be,x as ye,k as ve,y as Ne,v as J,T as we,a6 as je}from"./react-A-4nP3fl.js";import{q as z,f as E,w as N,e as I}from"./firebase-CbfwkGbo.js";import{d as P}from"../index-ChphXJpr.js";import{s as A,h as g}from"./color-CDd1PckM.js";import"./vendor-CCJV4Wg0.js";const Te=()=>{const U=he(),{slug:b}=fe(),[V]=ge(),K=V.get("departure")||"",W=V.get("arrival")||"",M=r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase(),y=M(K),v=M(W),[a,X]=n.useState(null),[i,Z]=n.useState(null),[H,ee]=n.useState({}),[se,w]=n.useState(!0),[B,C]=n.useState(null),[re,ae]=n.useState([]),[x,Q]=n.useState(""),[k,F]=n.useState(""),te=n.useMemo(()=>({colors:{primary:(a==null?void 0:a.couleurPrimaire)||"#3b82f6",secondary:(a==null?void 0:a.couleurSecondaire)||"#93c5fd",text:a!=null&&a.couleurPrimaire?A(a.couleurPrimaire):"#ffffff",background:"#ffffff"},classes:{card:"bg-white rounded-xl shadow-sm border border-gray-200",button:"transition-all hover:scale-105 active:scale-95",animations:"transition-all duration-300 ease-in-out",header:"sticky top-0 z-50 px-4 py-3"}}),[a]),{colors:t,classes:h}=te,oe=r=>{const l=new Date;return Array.from({length:r},(s,d)=>{const c=new Date(l);return c.setDate(l.getDate()+d),c.toISOString().split("T")[0]})};n.useEffect(()=>{(async()=>{if(!b){C("Compagnie non trouvÃ©e"),w(!1);return}try{const l=z(E(P,"companies"),N("slug","==",b)),s=await I(l);if(s.empty){C("Compagnie non trouvÃ©e"),w(!1);return}const d=s.docs[0],c=d.data();X({id:d.id,nom:c.nom,pays:c.pays,slug:c.slug,couleurPrimaire:c.couleurPrimaire,couleurSecondaire:c.couleurSecondaire,themeStyle:c.themeStyle,logoUrl:c.logoUrl,banniereUrl:c.banniereUrl});const f=z(E(P,"agences"),N("companyId","==",d.id)),j=await I(f);if(!j.empty){const S=j.docs[0],p=S.data();Z({id:S.id,ville:p.ville,quartier:p.quartier,pays:p.pays,telephone:p.telephone,nomAgence:p.nomAgence})}}catch(l){console.error("Erreur Firestore:",l),C("Erreur lors du chargement")}finally{w(!1)}})()},[b]),n.useEffect(()=>{const r=async()=>{if(console.log("ðŸŽ¯ FETCH TRIGGERED with:",{departure:y,arrival:v,agenceId:i==null?void 0:i.id}),!y||!v||!(i!=null&&i.id)){console.warn("â›” DonnÃ©es manquantes. Abandon du fetch.",{departure:y,arrival:v,agenceId:i==null?void 0:i.id});return}w(!0);try{const l=oe(8),s=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],d=z(E(P,"weeklyTrips"),N("agencyId","==",i.id),N("departure","==",y),N("arrival","==",v),N("active","==",!0)),c=await I(d);console.log(`ðŸ“¦ ${c.docs.length} weeklyTrips rÃ©cupÃ©rÃ©s depuis Firestore`);const f=[];for(const o of c.docs){const m=o.data(),{departure:u,arrival:q,horaires:O,price:ce,places:ne=30,agencyId:de,companyId:me}=m;for(const G of l){const ue=new Date(G),pe=s[ue.getDay()],xe=(O==null?void 0:O[pe])||[];for(const _ of xe)f.push({id:`${o.id}-${G}-${_}`,departure:u,arrival:q,date:G,time:_,price:ce,places:ne,companyId:me,agencyId:de,compagnieNom:a==null?void 0:a.nom,logoUrl:a==null?void 0:a.logoUrl})}}const S=(await I(E(P,"reservations"))).docs.map(o=>o.data()),p=f.map(o=>{const m=S.filter(u=>u.trajetId===o.id&&u.statut==="payÃ©").reduce((u,q)=>u+(q.seatsGo||1),0);return{...o,places:(o.places||30)-m}}),$={};p.forEach(o=>{$[o.date]||($[o.date]=[]),$[o.date].push(o)});const Y=new Date,R=l.filter(o=>{const m=$[o];return m?m.some(u=>new Date(`${u.date}T${u.time}`)>Y):!1});ae(R),Q(o=>R.includes(o)?o:R[0]||"");const T={};for(const o of p)if(new Date(`${o.date}T${o.time}`)>Y){const m=`${o.companyId}`;T[m]||(T[m]=[]),T[m].push(o)}ee(T)}catch(l){console.error("ðŸ”¥ Erreur Firestore dans fetchTrajets:",l),C("Erreur lors du chargement des trajets")}finally{w(!1)}};i!=null&&i.id&&r()},[y,v,i==null?void 0:i.id]);const D=n.useMemo(()=>Object.fromEntries(Object.entries(H).map(([r,l])=>[r,l.filter(s=>s.date===x)])),[H,x]);n.useEffect(()=>{var l;const r=Object.values(D).flat().filter(s=>s.date===x);if(r.length>0){const d=((l=r.sort((c,f)=>c.time.localeCompare(f.time))[0])==null?void 0:l.time)||"";F(c=>r.some(j=>j.time===c)?c:d)}else F("")},[x,D]);const L=(r,l)=>new Date(`${r}T${l}`).getTime()<new Date().getTime(),le=r=>new Date(r).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"}),ie=r=>{U(`/compagnie/${b}/booking`,{state:{tripData:{id:r.id,departure:r.departure,arrival:r.arrival,date:r.date,time:r.time,price:r.price,places:r.places,companyId:r.companyId,agencyId:r.agencyId},companyInfo:{id:a==null?void 0:a.id,nom:a==null?void 0:a.nom,logoUrl:a==null?void 0:a.logoUrl,primaryColor:t.primary}}})};return se?e.jsx("div",{className:"flex items-center justify-center min-h-screen",style:{background:t.background},children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2",style:{borderColor:t.primary}})}):B?e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",style:{background:t.background,color:t.text},children:e.jsxs("div",{className:`p-4 rounded-lg max-w-md ${h.card}`,children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Erreur"}),e.jsx("p",{children:B}),e.jsx("button",{onClick:()=>U(`/compagnie/${b}`),className:`mt-4 px-4 py-2 rounded ${h.button}`,style:{backgroundColor:t.primary,color:t.text},children:"Retour Ã  la compagnie"})]})}):e.jsxs("div",{className:"min-h-screen",style:{background:t.background,color:t.text},children:[e.jsx("header",{className:h.header,style:{backgroundColor:g(t.primary,.95),backdropFilter:"blur(10px)"},children:e.jsxs("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e.jsx("button",{onClick:()=>U(`/compagnie/${b}`),className:"p-2 rounded-full hover:bg-white/10 transition",style:{color:A(t.primary)},children:e.jsx(be,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[(a==null?void 0:a.logoUrl)&&e.jsx(ye.LazyLoadImage,{src:a.logoUrl,alt:`Logo ${a.nom}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:A(t.primary),backgroundColor:g(t.primary,.2)}}),e.jsx("h1",{className:"text-lg font-bold",style:{color:A(t.primary)},children:a==null?void 0:a.nom})]})]})}),e.jsxs("main",{className:"max-w-4xl mx-auto p-4 sm:p-6",children:[e.jsxs("div",{className:`p-4 rounded-xl mb-6 ${h.card}`,children:[e.jsxs("h1",{className:"text-xl sm:text-2xl font-bold mb-2",style:{color:t.primary},children:[y," â†’ ",v]}),i&&e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("div",{className:"p-2 rounded-full",style:{backgroundColor:g(t.primary,.1)},children:e.jsx(ve,{className:"h-5 w-5",style:{color:t.primary}})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:i.nomAgence}),e.jsxs("p",{className:"text-sm opacity-80",children:[i.ville,", ",i.quartier," â€¢ â˜Ž ",i.telephone]})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5",style:{color:t.primary}}),"Dates disponibles"]}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-4 scrollbar-hide",children:re.map(r=>e.jsxs("button",{onClick:()=>Q(r),className:`flex flex-col items-center min-w-[90px] p-3 rounded-xl border transition-all flex-shrink-0 ${x===r?"text-white shadow-md":"bg-white hover:bg-gray-50 border-gray-200"}`,style:{backgroundColor:x===r?t.primary:void 0,borderColor:x===r?t.primary:void 0},children:[e.jsx("span",{className:"text-xs font-medium",children:le(r)}),e.jsx("span",{className:"text-sm mt-1",children:new Date(r).toLocaleDateString("fr-FR",{day:"numeric"})})]},r))})]}),Object.keys(D).length===0?e.jsxs("div",{className:`p-6 rounded-xl text-center ${h.card}`,children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-full inline-flex mb-3",children:e.jsx(J,{className:"h-6 w-6 text-gray-500"})}),e.jsx("h3",{className:"text-lg font-medium mb-1",children:"Aucun trajet disponible"}),e.jsx("p",{className:"text-sm opacity-80",children:"Veuillez choisir une autre date"})]}):e.jsx("div",{className:"space-y-4",children:Object.entries(D).map(([r,l])=>e.jsxs("div",{className:`rounded-xl overflow-hidden ${h.card}`,children:[e.jsxs("div",{className:"p-4 border-b",style:{borderColor:g(t.primary,.1)},children:[e.jsxs("h2",{className:"font-semibold flex items-center gap-2 mb-3",children:[e.jsx(J,{className:"h-5 w-5",style:{color:t.primary}}),"Heures de dÃ©part"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2",children:l.sort((s,d)=>s.time.localeCompare(d.time)).map(s=>e.jsxs("button",{onClick:()=>F(s.time),disabled:L(s.date,s.time),className:`p-3 rounded-lg border flex flex-col items-center transition ${k===s.time?"bg-blue-50 text-blue-600":L(s.date,s.time)?"bg-gray-50 text-gray-400":"border-gray-200 hover:border-blue-300 hover:bg-blue-50"}`,style:{borderColor:k===s.time?t.primary:void 0,backgroundColor:k===s.time?g(t.primary,.1):void 0},children:[e.jsx("span",{className:"font-medium",children:s.time}),e.jsxs("span",{className:"text-xs mt-1",children:[s.places," places"]})]},s.id))})]}),l.filter(s=>s.time===k&&!L(s.date,s.time)).map(s=>e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full",style:{backgroundColor:g(t.primary,.1)},children:e.jsx(we,{className:"h-5 w-5",style:{color:t.primary}})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium opacity-80",children:"Prix"}),e.jsxs("p",{className:"text-lg font-bold",children:[s.price.toLocaleString()," FCFA"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full",style:{backgroundColor:g(t.primary,.1)},children:e.jsx(je,{className:"h-5 w-5",style:{color:t.primary}})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium opacity-80",children:"Places disponibles"}),e.jsx("p",{className:`text-lg font-bold ${s.places===0?"text-red-600":s.places<=10?"text-yellow-600":"text-green-600"}`,children:s.places})]})]})]}),e.jsx("button",{onClick:()=>ie(s),disabled:s.places===0,className:`w-full py-3 font-bold rounded-lg ${h.button} ${s.places===0?"opacity-70 cursor-not-allowed":""}`,style:{backgroundColor:s.places===0?"#e5e7eb":t.primary,color:s.places===0?"#6b7280":t.text},children:s.places===0?"Complet":"RÃ©server maintenant"})]},s.id))]},r))})]})]})};export{Te as default};
