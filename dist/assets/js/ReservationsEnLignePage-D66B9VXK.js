import{a as s,j as a,U as B,M as F,a5 as M,ac as U,F as q,az as $,o as H,aA as V,v as z,r as i,h as G,a1 as O,aB as W,aC as J}from"./react-DgrrIcw2.js";import{l as K,k as S,q as Q,D as X,E as Y,w as A,m as Z,T as E,B as ee,d as b,u as j}from"./firebase-eGIzIftJ.js";import{m as x,u as ae,d as h}from"../index-p6Te0bSg.js";import"./vendor-BHjJ2Hjk.js";const te={payé:"bg-emerald-100 text-emerald-800",preuve_recue:"bg-amber-100 text-amber-800",annulé:"bg-red-100 text-red-800",refusé:"bg-red-100 text-red-800",en_attente:""},se=({reservation:e,onValider:f,onRefuser:o,onSupprimer:g,isLoading:c})=>{var y;return s("div",{className:"bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition",children:[a("div",{className:"grid grid-cols-1",children:s("div",{className:"p-4 flex flex-col gap-4",children:[s("div",{className:"flex justify-between items-start",children:[s("div",{className:"flex flex-col gap-1",children:[s("div",{className:"flex items-center gap-2 font-semibold text-slate-800",children:[a(B,{className:"w-4 h-4 text-slate-400"}),e.nomClient||e.clientNom||"--"]}),a("p",{className:"text-sm text-slate-500",children:e.telephone||"--"}),e.email&&a("p",{className:"text-sm text-slate-500",children:e.email}),a("span",{className:`inline-block text-xs px-2 py-1 rounded-full ${te[e.statut]}`,children:e.statut.replace("_"," ")})]}),a("div",{className:"text-right text-xs text-slate-400 font-mono",children:e.referenceCode})]}),s("div",{className:"flex justify-between items-center text-slate-700",children:[s("div",{className:"flex items-center gap-2",children:[a(F,{className:"w-4 h-4 text-slate-400"}),s("span",{className:"font-semibold",children:[e.depart," → ",e.arrivee]})]}),s("div",{className:"text-sm text-slate-500",children:[e.date," à ",e.heure]})]}),s("div",{className:"flex justify-between items-center",children:[s("div",{className:"flex items-center gap-2 text-slate-800",children:[a(M,{className:"w-4 h-4 text-slate-400"}),e.agencyNom||"--"]}),a("div",{className:"text-sm text-slate-500",children:e.agencyTelephone||"--"})]}),s("div",{className:"flex justify-between items-center",children:[s("div",{className:"flex items-center gap-2 text-slate-800",children:[a(U,{className:"w-4 h-4 text-slate-400"}),s("span",{className:"font-semibold",children:[(y=e.montant)==null?void 0:y.toLocaleString()," FCFA"]})]}),s("div",{className:"text-sm text-slate-500",children:["Places : ",e.seatsGo,e.seatsReturn?` + ${e.seatsReturn}`:""]})]}),e.preuveMessage&&s("div",{className:"text-sm text-slate-600 bg-slate-50 border p-2 rounded",children:[a("p",{className:"font-medium text-slate-700 mb-1",children:"Message :"}),e.preuveMessage]})]})}),s("div",{className:"border-t px-4 py-3 flex flex-wrap gap-2 bg-slate-50 justify-end",children:[e.statut==="preuve_recue"&&s(q,{children:[s(x.button,{disabled:c,whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>f(e.id),className:`px-3 py-2 rounded bg-emerald-600 text-white text-xs flex items-center gap-1 ${c?"opacity-50 cursor-not-allowed":"hover:bg-emerald-700"}`,children:[a($,{className:"w-4 h-4"}),c?"...":"Valider"]}),s(x.button,{disabled:c,whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>o(e.id),className:`px-3 py-2 rounded bg-red-600 text-white text-xs flex items-center gap-1 ${c?"opacity-50 cursor-not-allowed":"hover:bg-red-700"}`,children:[a(H,{className:"w-4 h-4"}),c?"...":"Refuser"]})]}),e.preuveUrl&&s("a",{href:e.preuveUrl,target:"_blank",rel:"noreferrer",className:"px-3 py-2 rounded border border-gray-300 text-xs text-slate-600 hover:bg-gray-50 flex items-center gap-1",children:[a(V,{className:"w-4 h-4"})," Voir preuve"]}),s(x.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>g(e.id),className:"px-3 py-2 rounded text-red-600 text-xs hover:text-red-800 flex items-center gap-1",children:[a(z,{className:"w-4 h-4"})," Supprimer"]})]})]})},le=8,oe=()=>{const{user:e}=ae(),[f,o]=i.useState([]),[g,c]=i.useState(!1),[y,w]=i.useState(null),[u,T]=i.useState(""),[v,L]=i.useState("preuve_recue"),R=i.useRef(null);i.useRef(Date.now()),i.useEffect(()=>{if(!(e!=null&&e.companyId))return;c(!0),(async()=>{const m=(await K(S(h,"companies",e.companyId,"agences"))).docs.map(d=>d.id).map(d=>Q(S(h,"companies",e.companyId,"agences",d,"reservations"),v?A("statut","==",v):A("statut","in",["preuve_recue","payé","annulé","refusé"]),Y("createdAt","desc"),X(le))).map(d=>Z(d,k=>{const I=k.docs.map(p=>{const N=p.data();return{id:p.id,...N,agenceId:N.agenceId||N.agencyId||""}});I.filter(p=>p.createdAt instanceof E?E.now().seconds-p.createdAt.seconds<10:!1).length>0&&R.current&&R.current.play().catch(()=>{}),o(I),c(!1)}));return()=>m.forEach(d=>d())})()},[e==null?void 0:e.companyId,v]);const _=async(t,l)=>{if(!l||!(e!=null&&e.companyId))return alert("Aucune agence associée à cette réservation");try{w(t),await j(b(h,"companies",e.companyId,"agences",l,"reservations",t),{statut:"payé",validatedAt:new Date,validatedBy:e.uid}),alert("Réservation validée ✅"),o(r=>r.filter(n=>n.id!==t))}catch(r){console.error("Erreur validation:",r),alert("Une erreur est survenue lors de la validation ❌")}finally{w(null)}},P=async(t,l)=>{if(!l||!(e!=null&&e.companyId))return alert("Aucune agence associée à cette réservation");const r=window.prompt("Raison du refus ?")||"Non spécifié";try{w(t),await j(b(h,"companies",e.companyId,"agences",l,"reservations",t),{statut:"refusé",refusalReason:r,refusedAt:new Date,refusedBy:e.uid}),alert("Réservation refusée ❌"),o(n=>n.filter(m=>m.id!==t))}catch(n){console.error("Erreur refus:",n),alert("Erreur lors du refus")}finally{w(null)}},D=async(t,l)=>{if(!l||!(e!=null&&e.companyId))return alert("Aucune agence associée à cette réservation");if(window.confirm("Supprimer cette réservation ?"))try{await ee(b(h,"companies",e.companyId,"agences",l,"reservations",t)),o(r=>r.filter(n=>n.id!==t))}catch{alert("Erreur lors de la suppression ❌")}},C=f.filter(t=>{var l,r,n,m;return((l=t.nomClient)==null?void 0:l.toLowerCase().includes(u.toLowerCase()))||((r=t.telephone)==null?void 0:r.includes(u))||((n=t.referenceCode)==null?void 0:n.toLowerCase().includes(u.toLowerCase()))||((m=t.email)==null?void 0:m.toLowerCase().includes(u.toLowerCase()))});return s("div",{className:"p-4 md:p-6 max-w-7xl mx-auto",children:[s("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6",children:[s("div",{className:"flex items-center gap-3",children:[(e==null?void 0:e.companyLogo)&&a(G.LazyLoadImage,{src:e.companyLogo,alt:"Logo",effect:"blur",className:"h-10 w-10 rounded border object-cover"}),s("div",{children:[a("h1",{className:"text-2xl font-bold text-gray-900",children:"Réservations en ligne"}),a("p",{className:"text-sm text-gray-500",children:"Preuves de paiement"})]})]}),s("div",{className:"flex flex-col sm:flex-row gap-3 w-full md:w-auto",children:[s("div",{className:"relative flex-1",children:[a("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:a(O,{className:"w-4 h-4 text-gray-400"})}),a("input",{type:"text",placeholder:"Rechercher...",className:"pl-10 pr-4 py-2 border border-gray-300 rounded-lg w-full",value:u,onChange:t=>T(t.target.value)})]}),s("select",{value:v,onChange:t=>L(t.target.value),className:"border border-gray-300 rounded-lg px-3 py-2 min-w-[180px]",children:[a("option",{value:"",children:"Tous les statuts"}),a("option",{value:"preuve_recue",children:"Preuve reçue"}),a("option",{value:"payé",children:"Payé"}),a("option",{value:"annulé",children:"Annulé"}),a("option",{value:"refusé",children:"Refusé"})]})]})]}),g&&f.length===0&&a("div",{className:"flex justify-center py-8",children:a(x.div,{animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"},children:a(W,{className:"h-8 w-8 text-blue-600"})})}),!g&&C.length===0&&s(x.div,{initial:{opacity:0},animate:{opacity:1},className:"bg-white rounded-xl border p-8 text-center",children:[a(J,{className:"mx-auto h-12 w-12 text-gray-400"}),a("h3",{className:"mt-4 text-lg font-medium text-gray-900",children:"Aucune réservation trouvée"})]}),a("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:C.map(t=>a(se,{reservation:t,onValider:()=>_(t.id,t.agenceId),onRefuser:()=>P(t.id,t.agenceId),onSupprimer:()=>D(t.id,t.agenceId),isLoading:y===t.id},t.id))})]})};export{oe as default};
