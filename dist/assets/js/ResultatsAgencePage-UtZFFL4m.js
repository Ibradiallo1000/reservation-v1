import{u as oe,k as ne,y as ce,h as ie,j as e,r as i,l as de,m as me,M as ue,n as pe,C as J,z as xe,A as he}from"./react-CdtEOh9s.js";import{q as F,f as L,w as K,h as P}from"./firebase-C3aZpI0W.js";import{d as E}from"../index-_JuAPzwQ.js";import{s as A,h as b}from"./color-DxN_zAQH.js";import"./vendor-D_1n0kdO.js";const je=()=>{const D=oe(),{slug:h}=ne(),[O]=ce(),c=ie().state,z=(c==null?void 0:c.departure)||O.get("departure")||"",M=(c==null?void 0:c.arrival)||O.get("arrival")||"";if(!h||!z||!M)return e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen text-center p-4 bg-white",children:[e.jsx("h2",{className:"text-xl font-bold mb-2 text-red-600",children:"Erreur"}),e.jsx("p",{className:"text-gray-700 mb-4",children:"Les paramètres de recherche sont incomplets ou manquants."}),e.jsx("button",{onClick:()=>D("/"),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Retour à l'accueil"})]});const V=r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase(),v=V(z),N=V(M),[t,G]=i.useState(null),[x,W]=i.useState(null),j=(x==null?void 0:x.id)||null,[B,X]=i.useState({}),[Y,w]=i.useState(!0),[H,S]=i.useState(null),[Z,ee]=i.useState([]),[g,Q]=i.useState(""),[$,U]=i.useState(""),se=i.useMemo(()=>({colors:{primary:(t==null?void 0:t.couleurPrimaire)||"#3b82f6",secondary:(t==null?void 0:t.couleurSecondaire)||"#93c5fd",text:t!=null&&t.couleurPrimaire?A(t.couleurPrimaire):"#ffffff",background:"#ffffff"},classes:{card:"bg-white rounded-xl shadow-sm border border-gray-200",button:"transition-all hover:scale-105 active:scale-95",animations:"transition-all duration-300 ease-in-out",header:"sticky top-0 z-50 px-4 py-3"}}),[t]),{colors:a,classes:f}=se,re=r=>{const o=new Date;return Array.from({length:r},(s,m)=>{const n=new Date(o);return n.setDate(o.getDate()+m),n.toISOString().split("T")[0]})};i.useEffect(()=>{(async()=>{if(c!=null&&c.companyInfo)G(c.companyInfo);else{if(!h){S("Compagnie non trouvée"),w(!1);return}try{const o=F(L(E,"companies"),K("slug","==",h)),s=await P(o);if(s.empty){S("Compagnie non trouvée"),w(!1);return}const m=s.docs[0],n=m.data();G({id:m.id,nom:n.nom,pays:n.pays,slug:n.slug,couleurPrimaire:n.couleurPrimaire,couleurSecondaire:n.couleurSecondaire,themeStyle:n.themeStyle,logoUrl:n.logoUrl,banniereUrl:n.banniereUrl});const C=F(L(E,"agences"),K("companyId","==",m.id)),y=await P(C);if(!y.empty){const k=y.docs[0],u=k.data();W({id:k.id,ville:u.ville,quartier:u.quartier,pays:u.pays,telephone:u.telephone,nomAgence:u.nomAgence})}}catch(o){console.error("Erreur Firestore:",o),S("Erreur lors du chargement")}finally{w(!1)}}})()},[h,c==null?void 0:c.companyInfo]),i.useEffect(()=>{(async()=>{if(!v||!N||!j){console.warn("Données incomplètes pour charger les trajets",{departure:v,arrival:N,agenceId:j});return}console.log("Lancement du fetch des trajets avec agenceId :",j),w(!0);try{const o=re(8),s=F(L(E,"dailyTrips")),n=(await P(s)).docs.map(l=>({id:l.id,...l.data()})),y=(await P(L(E,"reservations"))).docs.map(l=>l.data()),k=n.filter(l=>{var d,p;return((d=l.departure)==null?void 0:d.trim().toLowerCase())===v.toLowerCase()&&((p=l.arrival)==null?void 0:p.trim().toLowerCase())===N.toLowerCase()&&l.agencyId===j&&o.includes(l.date)}).map(l=>{const d=y.filter(p=>p.trajetId===l.id&&p.statut==="payé").reduce((p,le)=>p+(le.seatsGo||1),0);return{...l,places:(l.places||30)-d}}),u={};k.forEach(l=>{u[l.date]||(u[l.date]=[]),u[l.date].push(l)});const _=new Date,R=o.filter(l=>{const d=u[l];return d?d.some(p=>new Date(`${p.date}T${p.time}`)>_):!1});ee(R),Q(l=>R.includes(l)?l:R[0]||"");const I={};for(const l of k)if(new Date(`${l.date}T${l.time}`)>_){const d=`${l.companyId}`;I[d]||(I[d]=[]),I[d].push(l)}X(I)}catch(o){console.error("Erreur Firestore:",o),S("Erreur lors du chargement des trajets")}finally{w(!1)}})()},[v,N,j]);const T=i.useMemo(()=>Object.fromEntries(Object.entries(B).map(([r,o])=>[r,o.filter(s=>s.date===g)])),[B,g]);i.useEffect(()=>{var o;const r=Object.values(T).flat().filter(s=>s.date===g);if(r.length>0){const m=((o=r.sort((n,C)=>n.time.localeCompare(C.time))[0])==null?void 0:o.time)||"";U(n=>r.some(y=>y.time===n)?n:m)}else U("")},[g,T]);const q=(r,o)=>new Date(`${r}T${o}`).getTime()<new Date().getTime(),ae=r=>new Date(r).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"}),te=r=>{D(`/compagnie/${h}/booking`,{state:{tripData:{id:r.id,departure:r.departure,arrival:r.arrival,date:r.date,time:r.time,price:r.price,places:r.places,companyId:r.companyId,agencyId:r.agencyId},companyInfo:{id:t==null?void 0:t.id,nom:t==null?void 0:t.nom,logoUrl:t==null?void 0:t.logoUrl,primaryColor:a.primary}}})};return Y?e.jsx("div",{className:"flex items-center justify-center min-h-screen",style:{background:a.background},children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2",style:{borderColor:a.primary}})}):H?e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",style:{background:a.background,color:a.text},children:e.jsxs("div",{className:`p-4 rounded-lg max-w-md ${f.card}`,children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Erreur"}),e.jsx("p",{children:H}),e.jsx("button",{onClick:()=>D(`/compagnie/${h}`),className:`mt-4 px-4 py-2 rounded ${f.button}`,style:{backgroundColor:a.primary,color:a.text},children:"Retour à la compagnie"})]})}):e.jsxs("div",{className:"min-h-screen",style:{background:a.background,color:a.text},children:[e.jsx("header",{className:f.header,style:{backgroundColor:b(a.primary,.95),backdropFilter:"blur(10px)"},children:e.jsxs("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e.jsx("button",{onClick:()=>D(`/compagnie/${h}`),className:"p-2 rounded-full hover:bg-white/10 transition",style:{color:A(a.primary)},children:e.jsx(de,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[(t==null?void 0:t.logoUrl)&&e.jsx(me.LazyLoadImage,{src:t.logoUrl,alt:`Logo ${t.nom}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:A(a.primary),backgroundColor:b(a.primary,.2)}}),e.jsx("h1",{className:"text-lg font-bold",style:{color:A(a.primary)},children:t==null?void 0:t.nom})]})]})}),e.jsxs("main",{className:"max-w-4xl mx-auto p-4 sm:p-6",children:[e.jsxs("div",{className:`p-4 rounded-xl mb-6 ${f.card}`,children:[e.jsxs("h1",{className:"text-xl sm:text-2xl font-bold mb-2",style:{color:a.primary},children:[v," → ",N]}),x&&e.jsxs("div",{className:"flex items-center gap-3 mt-3",children:[e.jsx("div",{className:"p-2 rounded-full",style:{backgroundColor:b(a.primary,.1)},children:e.jsx(ue,{className:"h-5 w-5",style:{color:a.primary}})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:x.nomAgence}),e.jsxs("p",{className:"text-sm opacity-80",children:[x.ville,", ",x.quartier," • ☎ ",x.telephone]})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5",style:{color:a.primary}}),"Dates disponibles"]}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-4 scrollbar-hide",children:Z.map(r=>e.jsxs("button",{onClick:()=>Q(r),className:`flex flex-col items-center min-w-[90px] p-3 rounded-xl border transition-all flex-shrink-0 ${g===r?"text-white shadow-md":"bg-white hover:bg-gray-50 border-gray-200"}`,style:{backgroundColor:g===r?a.primary:void 0,borderColor:g===r?a.primary:void 0},children:[e.jsx("span",{className:"text-xs font-medium",children:ae(r)}),e.jsx("span",{className:"text-sm mt-1",children:new Date(r).toLocaleDateString("fr-FR",{day:"numeric"})})]},r))})]}),Object.keys(T).length===0?e.jsxs("div",{className:`p-6 rounded-xl text-center ${f.card}`,children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-full inline-flex mb-3",children:e.jsx(J,{className:"h-6 w-6 text-gray-500"})}),e.jsx("h3",{className:"text-lg font-medium mb-1",children:"Aucun trajet disponible"}),e.jsx("p",{className:"text-sm opacity-80",children:"Veuillez choisir une autre date"})]}):e.jsx("div",{className:"space-y-4",children:Object.entries(T).map(([r,o])=>e.jsxs("div",{className:`rounded-xl overflow-hidden ${f.card}`,children:[e.jsxs("div",{className:"p-4 border-b",style:{borderColor:b(a.primary,.1)},children:[e.jsxs("h2",{className:"font-semibold flex items-center gap-2 mb-3",children:[e.jsx(J,{className:"h-5 w-5",style:{color:a.primary}}),"Heures de départ"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2",children:o.sort((s,m)=>s.time.localeCompare(m.time)).map(s=>e.jsxs("button",{onClick:()=>U(s.time),disabled:q(s.date,s.time),className:`p-3 rounded-lg border flex flex-col items-center transition ${$===s.time?"bg-blue-50 text-blue-600":q(s.date,s.time)?"bg-gray-50 text-gray-400":"border-gray-200 hover:border-blue-300 hover:bg-blue-50"}`,style:{borderColor:$===s.time?a.primary:void 0,backgroundColor:$===s.time?b(a.primary,.1):void 0},children:[e.jsx("span",{className:"font-medium",children:s.time}),e.jsxs("span",{className:"text-xs mt-1",children:[s.places," places"]})]},s.id))})]}),o.filter(s=>s.time===$&&!q(s.date,s.time)).map(s=>e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full",style:{backgroundColor:b(a.primary,.1)},children:e.jsx(xe,{className:"h-5 w-5",style:{color:a.primary}})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium opacity-80",children:"Prix"}),e.jsxs("p",{className:"text-lg font-bold",children:[s.price.toLocaleString()," FCFA"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full",style:{backgroundColor:b(a.primary,.1)},children:e.jsx(he,{className:"h-5 w-5",style:{color:a.primary}})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium opacity-80",children:"Places disponibles"}),e.jsx("p",{className:`text-lg font-bold ${s.places===0?"text-red-600":s.places<=10?"text-yellow-600":"text-green-600"}`,children:s.places})]})]})]}),e.jsx("button",{onClick:()=>te(s),disabled:s.places===0,className:`w-full py-3 font-bold rounded-lg ${f.button} ${s.places===0?"opacity-70 cursor-not-allowed":""}`,style:{backgroundColor:s.places===0?"#e5e7eb":a.primary,color:s.places===0?"#6b7280":a.text},children:s.places===0?"Complet":"Réserver maintenant"})]},s.id))]},r))})]})]})};export{je as default};
