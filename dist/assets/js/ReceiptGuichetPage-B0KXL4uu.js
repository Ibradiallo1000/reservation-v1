import{j as e,a as t,ap as X,d as K,b as Q,u as W,r as c,C as Y,ao as Z,t as ee,ab as te,M as ae,a5 as re,T as se,_ as ne,p as le,aX as oe}from"./react-DB_4kGOy.js";import{w as A,J as E,y as M,L as P,z as I,q as ce,o as ie}from"./firebase-lLzYRzUk.js";import{d as w,e as U,h as C}from"../index-Bkmir__O.js";import{h as de}from"./html2pdf-DQqgx56O.js";import{p as me,f as z,c as $}from"./vendor-C-DAJou6.js";import"./jspdf.es.min-Gs4S7Zlz.js";import"./html2canvas-BI8K_7w5.js";const pe=({fullScreen:m=!1,className:i=""})=>e("div",{className:`flex items-center justify-center ${m?"min-h-screen":""} ${i}`,children:e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}),he=({message:m,onRetry:i,onHome:h})=>e("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:e("div",{className:"p-6 rounded-lg max-w-md bg-white shadow-sm border border-red-200",children:t("div",{className:"flex flex-col items-center",children:[e(X,{className:"h-12 w-12 text-red-500 mb-4"}),e("h2",{className:"text-xl font-bold mb-2 text-red-600",children:"Erreur"}),e("p",{className:"mb-6 text-gray-700",children:m}),t("div",{className:"flex gap-3",children:[i&&e("button",{onClick:i,className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition",children:"Réessayer"}),h&&e("button",{onClick:h,className:"px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300 transition",children:"Accueil"})]})]})})}),ve=()=>{const{id:m}=K(),i=Q(),h=W(),{companyInfo:u,reservation:x,from:f}=h.state||{},[a,T]=c.useState(x||null),[o,F]=c.useState(u||null),[L,k]=c.useState(!0),[R,q]=c.useState(null),y=c.useRef(null),_=c.useCallback((r,s)=>{try{let n;return typeof r=="string"?n=me(r):r instanceof Date?n=r:n=new Date(r.seconds*1e3),z(n,s,{locale:$})}catch{return"--/--/----"}},[]),D=c.useCallback(async()=>{var j;if(!m)throw new Error("ID manquant");let r=A(P(w,"reservations"),M("referenceCode","==",m),E(1)),s=await I(r);if(s.empty&&(r=A(P(w,"reservations"),M("__name__","==",m),E(1)),s=await I(r)),s.empty)throw new Error("Réservation introuvable");const n=s.docs[0],d=n.data(),p=n.ref.path.split("/"),O=p[1],J=p[3];return{...d,id:n.id,compagnieId:d.compagnieId||O,agencyId:d.agencyId||J,createdAt:d.createdAt instanceof Date?d.createdAt:(j=d.createdAt)!=null&&j.seconds?new Date(d.createdAt.seconds*1e3):void 0}},[m]),S=c.useCallback(async r=>{var d,p;const s=await ce(ie(w,"companies",r));if(!s.exists())throw new Error("Compagnie non trouvée");const n=s.data();return{id:s.id,nom:n.nom||n.name,logoUrl:n.logoUrl,couleurPrimaire:((d=n.theme)==null?void 0:d.primary)||n.couleurPrimaire||"#3b82f6",couleurSecondaire:((p=n.theme)==null?void 0:p.secondary)||n.couleurSecondaire||"#93c5fd",slug:n.slug,telephone:n.telephone}},[]);c.useEffect(()=>{(async()=>{try{k(!0);let r=x||null,s=u||null;r||(r=await D()),s||(s=await S(r.compagnieId)),T(r),F(s)}catch(r){q((r==null?void 0:r.message)||"Erreur de chargement")}finally{k(!1)}})()},[S,D,x,u]);const b=c.useMemo(()=>{if(!a)return"BIL-000000";if(a.referenceCode)return a.referenceCode;const r=(a.depart||"DEP").slice(0,3).toUpperCase(),s=(a.arrivee||"ARR").slice(0,3).toUpperCase(),n=a.id.slice(-6).toUpperCase();return`AGC-${r}${s}-${n}`},[a]),G=c.useMemo(()=>{const r=window.location.origin,s=(a==null?void 0:a.referenceCode)||(a==null?void 0:a.id);return`${r}/r/${encodeURIComponent(s||"")}`},[a==null?void 0:a.referenceCode,a==null?void 0:a.id]),H=c.useMemo(()=>{const r=a==null?void 0:a.createdAt;let s;return r?r instanceof Date?s=r:typeof r=="object"&&r.seconds?s=new Date(r.seconds*1e3):s=new Date:s=new Date,z(s,"dd/MM/yyyy",{locale:$})},[a==null?void 0:a.createdAt]),V=c.useCallback(()=>{if(!y.current)return;const r={margin:2,filename:`recu-${b}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,letterRendering:!0,width:340},jsPDF:{unit:"mm",format:[81,200],orientation:"portrait"}};de().set(r).from(y.current).save()},[b]),B=c.useCallback(()=>{i(f||"/agence/guichet")},[i,f]);if(L||!o)return e(pe,{fullScreen:!0});if(R||!a||!o)return e(he,{message:R||"Erreur de chargement",onRetry:()=>window.location.reload(),onHome:()=>i("/")});const l=o.couleurPrimaire,N=o.couleurSecondaire,g=U(l),v=({copy:r})=>{var s;return t("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",style:{width:"81mm",margin:"0 auto"},children:[t("div",{className:"flex justify-between items-center border-b pb-2 mb-2 px-3",style:{borderColor:C(l,.3)},children:[t("div",{className:"flex items-center gap-2",children:[o.logoUrl&&e("img",{src:o.logoUrl,alt:o.nom,className:"h-9 w-9 object-contain rounded border",style:{borderColor:l},onError:n=>n.target.src="/default-company.png"}),t("div",{className:"leading-tight",children:[e("h2",{className:"text-sm font-bold",style:{color:l},children:o.nom}),t("p",{className:"text-[11px] text-gray-700 flex items-center gap-1",children:[e(ae,{className:"h-3 w-3 text-gray-500"}),(a.agencyNom||a.nomAgence||"Agence").trim()]})]})]}),t("div",{className:"text-right leading-tight pr-2",children:[e("div",{className:"badge-copy",children:r}),t("p",{className:"text-[11px] font-mono tracking-tight text-gray-700 mt-1",children:["N° ",b]}),e("span",{className:"px-2 py-0.5 rounded text-[10px] font-medium",style:{backgroundColor:C(l,.15),color:l},children:(a.statut||"payé").toString().toUpperCase()})]})]}),t("div",{className:"px-3 pb-2 space-y-2",children:[t("div",{children:[t("div",{className:"flex items-center gap-1 mb-1",children:[e(re,{className:"h-3 w-3",style:{color:l}}),e("h3",{className:"text-xs font-semibold",style:{color:l},children:"Client"})]}),t("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Nom"}),e("p",{className:"truncate",children:a.nomClient})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Téléphone"}),e("p",{children:a.telephone})]})]})]}),t("div",{children:[t("div",{className:"flex items-center gap-1 mb-1",children:[e(se,{className:"h-3 w-3",style:{color:l}}),e("h3",{className:"text-xs font-semibold",style:{color:l},children:"Voyage"})]}),t("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[t("div",{className:"col-span-2",children:[e("p",{className:"text-[10px] text-gray-600",children:"Trajet"}),t("div",{className:"flex items-center gap-1",children:[e("p",{className:"font-medium",children:a.depart}),e(ne,{className:"h-3 w-3 text-gray-500"}),e("p",{className:"font-medium",children:a.arrivee})]})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Date"}),e("p",{children:_(a.date,"dd/MM/yyyy")})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Heure"}),e("p",{children:a.heure})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Places"}),t("p",{children:[a.seatsGo,a.seatsReturn?` (+${a.seatsReturn} retour)`:""]})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Canal"}),e("p",{className:"capitalize",children:a.canal})]})]})]}),t("div",{children:[t("div",{className:"flex items-center gap-1 mb-1",children:[e(le,{className:"h-3 w-3",style:{color:l}}),e("h3",{className:"text-xs font-semibold",style:{color:l},children:"Paiement"})]}),t("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Montant"}),t("p",{className:"font-bold",style:{color:l},children:[(s=a.montant)==null?void 0:s.toLocaleString("fr-FR")," FCFA"]})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Méthode"}),e("p",{className:"capitalize",children:a.paiement})]})]})]}),t("div",{className:"mt-2 p-1 rounded border border-gray-200 flex flex-col items-center",children:[e("h3",{className:"text-xs font-semibold mb-1",style:{color:l},children:"Code d'embarquement"}),e("div",{className:"bg-white p-1 rounded border",style:{borderColor:l},children:e(oe,{value:G,size:80,fgColor:"#000000",bgColor:"#ffffff",level:"H"})}),t("p",{className:"mt-2 text-[10px] text-gray-600 text-center",children:["Date d’émission : ",H]}),e("p",{className:"text-[10px] text-gray-600 text-center",children:"Validité : 1 mois à compter de la date d’émission."})]}),t("div",{className:"mt-2 pt-2 border-t border-gray-200 text-center",style:{fontSize:"10px",color:"#4b5563"},children:[t("p",{className:"mb-1",children:["Merci d'avoir choisi ",o.nom]}),e("p",{className:"italic mb-1",children:"Présentez-vous 1H avant le départ"}),t("p",{className:"font-medium mb-0.5",children:["Infos : ",a.agenceTelephone||o.telephone||"—"]}),t("p",{className:"mt-0.5 text-[9px] text-gray-400",children:["Ref ",a.referenceCode||a.id," • Guichetier ",a.guichetierCode||"—"," • Shift ",a.shiftId||"—"]}),e("p",{className:"mt-1 text-[9px] text-gray-500",children:"À découper et conserver selon le volet."})]})]})]})};return t("div",{className:"min-h-screen bg-gray-50 print:bg-white",style:{"--primary":l,"--secondary":N,"--text-on-primary":g},children:[e("style",{children:`
        @media print {
          body * { visibility: hidden !important; }
          #print-receipt, #print-receipt * { visibility: visible !important; }
          #print-receipt {
            position: fixed; inset: 0;
            display: flex; align-items: flex-start; justify-content: center;
            background: white; margin: 0; padding: 0;
          }
          .no-print { display: none !important; }
        }
        @page { size: 80mm auto; margin: 4mm; }
        .perf { border-top: 1px dashed #9ca3af; margin: 8px 0 12px; position: relative; height: 1px; }
        .perf::after { content: "✂︎"; position: absolute; right: -2px; top: -10px; font-size: 10px; color: #9ca3af; }
        .badge-copy { font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 6px; border: 1px solid #e5e7eb; background: #f9fafb; }
      `}),e("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm no-print",style:{backgroundColor:l,color:g},children:t("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e("button",{onClick:B,className:"p-2 rounded-full hover:bg-white/10 transition","aria-label":"Retour",children:e(Y,{className:"h-5 w-5"})}),t("div",{className:"flex items-center gap-3",children:[o.logoUrl&&e("img",{src:o.logoUrl,alt:`Logo ${o.nom}`,className:"h-10 w-10 rounded-full object-cover border-2",style:{borderColor:g},onError:r=>r.target.src="/default-company.png"}),t("div",{className:"flex flex-col",children:[e("h1",{className:"text-sm font-bold",children:"Reçu de voyage"}),e("p",{className:"text-xs opacity-90",children:o.nom})]})]})]})}),t("div",{className:"max-w-[81mm] mx-auto p-2 print:p-0",id:"print-receipt",children:[t("div",{ref:y,style:{width:"81mm",margin:"0 auto"},children:[e(v,{copy:"Comptabilité",note:""}),e("div",{className:"perf"}),e(v,{copy:"Contrôle",note:""}),e("div",{className:"perf"}),e(v,{copy:"Client",note:""})]}),t("div",{className:"no-print mt-3 grid grid-cols-1 gap-2",style:{width:"81mm",margin:"0 auto"},children:[t("button",{onClick:V,className:"flex items-center justify-center gap-2 px-4 py-2 rounded-lg shadow text-xs",style:{backgroundColor:l,color:g},children:[e(Z,{className:"h-4 w-4"})," Télécharger"]}),t("button",{onClick:()=>window.print(),className:"flex items-center justify-center gap-2 px-4 py-2 rounded-lg shadow text-xs",style:{backgroundColor:N||C(l,.8),color:U(N||l)},children:[e(ee,{className:"h-4 w-4"})," Imprimer"]}),t("button",{onClick:()=>i("/agence/guichet"),className:"flex items-center justify-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow hover:bg-gray-300 text-xs",children:[e(te,{className:"h-4 w-4"})," Retour au guichet"]})]})]})]})};export{ve as default};
