import{u as $,r as i,a,j as e,ag as O,ah as Q,ai as Z,F as _,aj as J,ak as I}from"./react-DgrrIcw2.js";import{k as A,l as E,d as w,u as P,y as K,A as X,t as Y,B as ee,q as te,w as re}from"./firebase-eGIzIftJ.js";import{u as ae,d as u,a as ne}from"../index-p6Te0bSg.js";import"./vendor-BHjJ2Hjk.js";delete I.Icon.Default.prototype._getIconUrl;I.Icon.Default.mergeOptions({iconRetinaUrl:"/leaflet/marker-icon-2x.png",iconUrl:"/leaflet/marker-icon.png",shadowUrl:"/leaflet/marker-shadow.png"});const me=()=>{const{user:o}=ae(),S=$(),[c,D]=i.useState([]),[N,f]=i.useState(!1),[t,b]=i.useState({nomAgence:"",ville:"",pays:"",quartier:"",type:"",emailGerant:"",nomGerant:"",telephone:"",motDePasse:"",latitude:"",longitude:""}),[d,j]=i.useState(null),[h,y]=i.useState(1),[p,L]=i.useState(6),[oe,q]=i.useState(!1),[le,k]=i.useState(""),g=(o==null?void 0:o.companyColor)||"#2563eb",F=({onPositionChange:r})=>(J({click(n){r(n.latlng.lat,n.latlng.lng)}}),null),x=async()=>{if(o!=null&&o.companyId)try{const r=A(u,"companies",o.companyId,"agences"),l=(await E(r)).docs.map(m=>({id:m.id,...m.data()}));D(l),y(1)}catch(r){console.error("Erreur lors du chargement des agences:",r),alert("Une erreur est survenue lors du chargement des agences")}},z=async r=>{try{const n=A(u,"users"),l=te(n,re("email","==",r));return!(await E(l)).empty}catch(n){return console.error("Erreur lors de la vÃ©rification de l'email:",n),!1}};i.useEffect(()=>{x()},[o]);const C=h*p,G=C-p,H=c.slice(G,C),v=Math.ceil(c.length/p),s=r=>{const{name:n,value:l}=r.target;b(m=>({...m,[n]:l})),n==="emailGerant"&&k("")},U=(r,n)=>{b(l=>({...l,latitude:r.toString(),longitude:n.toString()}))},M=()=>{b({nomAgence:"",ville:"",pays:"",quartier:"",type:"",emailGerant:"",nomGerant:"",telephone:"",motDePasse:"",latitude:"",longitude:""}),j(null),f(!1),k("")},W=async r=>{r.preventDefault(),console.log("ğŸ“¤ Soumission du formulaire",t);try{if(!(o!=null&&o.companyId))throw new Error("Aucune compagnie associÃ©e Ã  cet utilisateur");if(!d){console.log("ğŸ” VÃ©rification email dÃ©jÃ  utilisÃ©..."),q(!0);const n=await z(t.emailGerant);if(q(!1),n){console.warn("âŒ Email dÃ©jÃ  utilisÃ© :",t.emailGerant),k("Cet email est dÃ©jÃ  utilisÃ© par un autre utilisateur");return}if(!t.motDePasse||t.motDePasse.length<6){console.warn("âŒ Mot de passe trop court ou manquant"),alert("Le mot de passe doit contenir au moins 6 caractÃ¨res.");return}}if(d){console.log("âœï¸ Mise Ã  jour agence...");const n=w(u,"companies",o.companyId,"agences",d);await P(n,{nomAgence:t.nomAgence,ville:t.ville,pays:t.pays,quartier:t.quartier,type:t.type,nomGerant:t.nomGerant,telephone:t.telephone,latitude:t.latitude?parseFloat(t.latitude):null,longitude:t.longitude?parseFloat(t.longitude):null}),alert("âœ… Agence mise Ã  jour avec succÃ¨s")}else{console.log("ğŸ‘¤ CrÃ©ation utilisateur Firebase Auth...");const n=await K(ne,t.emailGerant,t.motDePasse);console.log("âœ… Utilisateur crÃ©Ã© :",n.user.uid),console.log("ğŸ¢ Ajout de lâ€™agence Firestore...");const l=A(u,"companies",o.companyId,"agences"),m=await X(l,{nomAgence:t.nomAgence,ville:t.ville,pays:t.pays,quartier:t.quartier,type:t.type,statut:"active",emailGerant:t.emailGerant,nomGerant:t.nomGerant,telephone:t.telephone,latitude:t.latitude?parseFloat(t.latitude):null,longitude:t.longitude?parseFloat(t.longitude):null});console.log("ğŸ“¦ Mise Ã  jour collection users..."),await Y(w(u,"users",n.user.uid),{uid:n.user.uid,email:t.emailGerant,nom:t.nomGerant,telephone:t.telephone,role:"chefAgence",companyId:o.companyId,agencyId:m.id}),alert("âœ… Agence et gÃ©rant crÃ©Ã©s avec succÃ¨s")}M(),x()}catch(n){console.error("ğŸ”¥ Erreur pendant handleSubmit:",n),alert(`Erreur: ${(n==null?void 0:n.message)??(n==null?void 0:n.code)??"Erreur inconnue"}`)}},B=r=>{var n,l;b({nomAgence:r.nomAgence,ville:r.ville,pays:r.pays,quartier:r.quartier||"",type:r.type||"",emailGerant:r.emailGerant,nomGerant:r.nomGerant,telephone:r.telephone,motDePasse:"",latitude:((n=r.latitude)==null?void 0:n.toString())||"",longitude:((l=r.longitude)==null?void 0:l.toString())||""}),j(r.id),f(!0),window.scrollTo({top:0,behavior:"smooth"})},V=async r=>{if(o!=null&&o.companyId&&window.confirm("ÃŠtes-vous sÃ»r de vouloir supprimer cette agence ?"))try{await ee(w(u,"companies",o.companyId,"agences",r)),x()}catch(n){console.error("Erreur lors de la suppression:",n),alert("Une erreur est survenue lors de la suppression")}},R=async r=>{if(!(o!=null&&o.companyId)||!r.id)return;const n=r.statut==="active"?"inactive":"active";try{await P(w(u,"companies",o.companyId,"agences",r.id),{statut:n}),x()}catch(l){console.error("Erreur lors du changement de statut:",l),alert("Une erreur est survenue lors du changement de statut")}},T=r=>{S(`/compagnie/agence/${r}/dashboard`)};return a("div",{className:"p-6 max-w-6xl mx-auto",children:[a("div",{className:"flex justify-between items-center mb-8",children:[e("h2",{className:"text-2xl font-bold",style:{color:g},children:"Gestion des agences"}),a("button",{onClick:()=>f(!N),className:"flex items-center px-4 py-2 rounded-md shadow-sm text-white font-medium",style:{backgroundColor:g},children:[e("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),N?"Masquer le formulaire":"Ajouter une nouvelle agence"]})]}),N&&a("form",{onSubmit:W,className:"bg-white p-6 rounded-lg shadow-md mb-8 border border-gray-200",children:[e("h3",{className:"text-lg font-semibold mb-4",style:{color:g},children:d?"Modifier une agence":"Ajouter une nouvelle agence"}),a("div",{className:"grid md:grid-cols-2 gap-6",children:[a("div",{className:"space-y-4",children:[a("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Nom de l'agence *"}),e("input",{name:"nomAgence",value:t.nomAgence,onChange:s,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),a("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Ville *"}),e("input",{name:"ville",value:t.ville,onChange:s,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),a("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Pays *"}),e("input",{name:"pays",value:t.pays,onChange:s,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),a("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Quartier"}),e("input",{name:"quartier",value:t.quartier,onChange:s,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),a("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Type"}),e("input",{name:"type",value:t.type,onChange:s,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),a("div",{className:"space-y-4",children:[a("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Nom du gÃ©rant *"}),e("input",{name:"nomGerant",value:t.nomGerant,onChange:s,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),a("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Email du gÃ©rant *"}),e("input",{name:"emailGerant",type:"email",value:t.emailGerant,onChange:s,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),a("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:d?"Nouveau mot de passe":"Mot de passe *"}),e("input",{name:"motDePasse",type:"password",value:t.motDePasse,onChange:s,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!d,placeholder:d?"Laisser vide pour ne pas changer":""})]}),a("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"TÃ©lÃ©phone *"}),e("input",{name:"telephone",value:t.telephone,onChange:s,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]})]})]}),a("div",{className:"mt-6",children:[a("label",{className:"block text-sm font-medium mb-1",children:["ğŸ“ Position gÃ©ographique ",t.latitude&&t.longitude&&a("span",{className:"text-gray-500 ml-2",children:["(",t.latitude,", ",t.longitude,")"]})]}),e("p",{className:"text-sm text-gray-500 mb-2",children:"Cliquez sur la carte pour positionner l'agence"}),e("div",{className:"h-64 rounded-lg border border-gray-300 overflow-hidden",children:a(O,{center:[t.latitude?parseFloat(t.latitude):12.6392,t.longitude?parseFloat(t.longitude):-8.0029],zoom:t.latitude?15:12,className:"h-full w-full",scrollWheelZoom:!0,children:[e(Q,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e(F,{onPositionChange:U}),t.latitude&&t.longitude&&e(Z,{position:[parseFloat(t.latitude),parseFloat(t.longitude)]})]})})]}),a("div",{className:"flex justify-end space-x-3 mt-6",children:[e("button",{type:"button",onClick:M,className:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Annuler"}),e("button",{type:"submit",className:"px-4 py-2 rounded-md shadow-sm text-sm font-medium text-white hover:bg-opacity-90",style:{backgroundColor:g},children:d?"Mettre Ã  jour l'agence":"Ajouter l'agence"})]})]}),a("div",{className:"flex justify-between items-center mb-4",children:[a("h3",{className:"text-xl font-semibold",children:["Liste des agences (",c.length,")"]}),a("div",{className:"flex items-center",children:[e("label",{className:"mr-2 text-sm",children:"Agences par page:"}),a("select",{value:p,onChange:r=>{L(Number(r.target.value)),y(1)},className:"border rounded p-1 text-sm",children:[e("option",{value:6,children:"6"}),e("option",{value:12,children:"12"}),e("option",{value:24,children:"24"})]})]})]}),c.length===0?a("div",{className:"bg-white p-8 rounded-lg shadow-sm border border-gray-200 text-center",children:[e("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})}),e("h3",{className:"mt-2 text-lg font-medium text-gray-900",children:"Aucune agence enregistrÃ©e"}),e("p",{className:"mt-1 text-sm text-gray-500",children:"Commencez par ajouter votre premiÃ¨re agence."}),e("div",{className:"mt-6",children:a("button",{onClick:()=>f(!0),className:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white",style:{backgroundColor:g},children:[e("svg",{className:"-ml-1 mr-2 h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Ajouter une agence"]})})]}):a(_,{children:[e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:H.map(r=>e("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200 hover:shadow-md transition-shadow",children:a("div",{className:"p-5",children:[a("div",{className:"flex justify-between items-start",children:[a("div",{children:[e("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:r.nomAgence}),a("p",{className:"text-sm text-gray-500",children:[r.ville,", ",r.pays]})]}),e("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${r.statut==="active"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:r.statut==="active"?"Active":"Inactive"})]}),a("div",{className:"mt-4 border-t border-gray-200 pt-4",children:[a("div",{className:"flex items-center text-sm text-gray-500 mb-2",children:[e("svg",{className:"flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})}),r.emailGerant]}),a("div",{className:"flex items-center text-sm text-gray-500",children:[e("svg",{className:"flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"})}),r.telephone]})]}),a("div",{className:"mt-5 flex justify-between space-x-2",children:[a("button",{onClick:()=>T(r.id),className:"flex-1 inline-flex justify-center items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:[e("svg",{className:"-ml-1 mr-2 h-5 w-5 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})}),"Dashboard"]}),a("button",{onClick:()=>B(r),className:"inline-flex justify-center items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white",style:{backgroundColor:g},children:[e("svg",{className:"-ml-1 mr-2 h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Modifier"]})]}),a("div",{className:"mt-3 flex space-x-2",children:[e("button",{onClick:()=>R(r),className:`flex-1 px-3 py-2 border rounded-md text-sm font-medium ${r.statut==="active"?"border-yellow-300 text-yellow-700 bg-yellow-100 hover:bg-yellow-200":"border-green-300 text-green-700 bg-green-100 hover:bg-green-200"}`,children:r.statut==="active"?"DÃ©sactiver":"Activer"}),e("button",{onClick:()=>V(r.id),className:"flex-1 px-3 py-2 border border-red-300 rounded-md text-sm font-medium text-red-700 bg-red-100 hover:bg-red-200",children:"Supprimer"})]})]})},r.id))}),c.length>p&&a("div",{className:"flex justify-between items-center mt-6",children:[a("div",{className:"text-sm text-gray-500",children:["Affichage ",G+1,"-",Math.min(C,c.length)," sur ",c.length," agences"]}),a("div",{className:"flex space-x-2",children:[e("button",{onClick:()=>y(r=>Math.max(r-1,1)),disabled:h===1,className:`px-4 py-2 rounded-md ${h===1?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:"PrÃ©cÃ©dent"}),a("span",{className:"px-4 py-2 text-gray-700",children:["Page ",h," sur ",v]}),e("button",{onClick:()=>y(r=>Math.min(r+1,v)),disabled:h===v,className:`px-4 py-2 rounded-md ${h===v?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:"Suivant"})]})]})]})]})};export{me as default};
