import{r as o,j as e,t as yi,c as bi,a as r,F as bt,f as Je,b as Et,d as xi,E as vi,e as Ni,_ as wi,h as In,p as Ci,g as Si,B as zn}from"./vendor-Bq-8_m9i.js";import{u as Aa,N as Rr,O as gr,a as aa,b as js,c as kt,d as Ai,L as En}from"./router-DoGdw-3y.js";import{g as Ii,a as Ei,i as ki,b as Ri,c as Ti,m as Di,p as $i,s as Mi,d as Os,e as _i,f as Li,h as Pi,j as Fi,k as ji,l as Oi,n as Vi,R as qi,o as pe,q as He,r as Te,w as ae,t as he,u as Ee,v as jt,x as Re,y as gt,z as Bi,A as Gi,B as Ui,C as zi,T as We,D as Vs,E as kn,F as Ge,G as Tt,H as Ut,I as Rt,J as Hi,K as Ki,L as qe,M as Hn,N as Kn}from"./firebase-CURBI7X6.js";import{U as Rn,P as Yi,a as Wi,C as Xi,b as Qi,L as dr,X as Ia,M as Ji,W as qs,A as Ha,I as Zi,c as ur,d as sr,e as eo,B as Mt,f as _t,g as Tn,F as Bs,h as wa,i as Or,T as xa,G as to,j as Tr,k as ao,l as Gt,m as rt,n as ea,o as Ca,p as ro,q as vn,r as ir,R as or,s as Gs,t as no,u as so,D as Dn,v as mr,w as io,x as oo,y as Dr,z as Mr,E as Jt,H as Nn,S as _r,J as lo,K as Yn,N as co,O as Ka,Q as uo,V as Vr,Y as mo,Z as $n,_ as va,$ as Us,a0 as Wn,a1 as zs,a2 as ho,a3 as po,a4 as qa,a5 as go,a6 as fo,a7 as yo,a8 as bo,a9 as Hs,aa as xo,ab as Xn,ac as nn,ad as vo,ae as No,af as wo,ag as Co,ah as So,ai as Ao,aj as Io,ak as Qn}from"./icons-C0JHUK9Z.js";import{e as fr,l as qr,a as hr,b as tr,c as wn,O as Ua,A as It,T as Lr,d as Ks,f as Ys,g as Eo,h as ko,i as Ws,r as Ro,j as To,k as Do,m as $o,n as Mo,o as _o,p as Lo}from"./compagnie-DiuZFnHS.js";import{a as Jn,c as Br,b as Po,v as Fo,d as jo,s as ia,e as Oo,f as Vo,g as qo,r as Bo,m as Go,h as Uo,i as Xs,j as zo,k as Ho,l as Ko,n as Yo,o as Wo,p as Xo,q as Qo,t as Jo,u as Zo,w as el}from"./courier-CoQgRaHG.js";const ba={apiKey:"AIzaSyB9sGzgvdzhxxhIshtPprPix7oBfCB2OuM",authDomain:"monbillet-95b77.firebaseapp.com",projectId:"monbillet-95b77",storageBucket:"monbillet-95b77.appspot.com",messagingSenderId:"337289733382",appId:"1:337289733382:web:bb99ee8f48861b47226a87",measurementId:"G-G96GYRYS76"},yr=Ii().length?Ei():ki(ba);var ks,Rs;const Zn=(Rs=(ks=import.meta)==null?void 0:ks.env)==null?void 0:Rs.VITE_RECAPTCHA_V3_KEY;var Ts,Ds;if(typeof window<"u"){if(((Ds=(Ts=import.meta)==null?void 0:Ts.env)==null?void 0:Ds.VITE_APPCHECK_DEBUG)==="true"&&["localhost","127.0.0.1"].includes(window.location.hostname)){self.FIREBASE_APPCHECK_DEBUG_TOKEN=!0;try{localStorage.setItem("FIREBASE_APPCHECK_DEBUG_TOKEN","true")}catch{}}Zn&&Ri(yr,{provider:new qi(Zn),isTokenAutoRefreshEnabled:!0})}var $s,Ms;const es=((Ms=($s=import.meta)==null?void 0:$s.env)==null?void 0:Ms.VITE_FIRESTORE_FORCE_LONG_POLLING)==="true";var _s,Ls;const tl=((Ls=(_s=import.meta)==null?void 0:_s.env)==null?void 0:Ls.VITE_FIRESTORE_DISABLE_PERSISTENCE)==="true",$=Ti(yr,{localCache:tl?Di():$i({tabManager:Pi()}),ignoreUndefinedProperties:!0,experimentalAutoDetectLongPolling:!es,experimentalForceLongPolling:es});Mi("error");const Ba=Os(yr),al=_i(yr),rl=Li(yr,"europe-west1");var Ps,Fs;const nl=((Fs=(Ps=import.meta)==null?void 0:Ps.env)==null?void 0:Fs.VITE_USE_EMULATORS)==="true",sl=typeof window<"u"&&["localhost","127.0.0.1"].includes(window.location.hostname),il=nl&&sl;async function Iu(){try{il?(console.info("‚ö° Connexion aux √©mulateurs Firebase‚Ä¶"),Fi($,"127.0.0.1",8080),ji(Ba,"http://127.0.0.1:9099",{disableWarnings:!0}),Oi(al,"127.0.0.1",9199),Vi(rl,"127.0.0.1",5001),console.info("üî• √âmulateurs connect√©s.")):console.info("‚ÑπÔ∏è Emulateurs d√©sactiv√©s (mode cloud).")}catch(a){console.warn("‚ö†Ô∏è initFirebase() erreur :",a)}}const Eu=(async()=>{})(),ts=["https://identitytoolkit.googleapis.com","https://securetoken.googleapis.com"];function ku(){if(typeof window>"u")return;const a=!!(ba.apiKey&&ba.authDomain&&ba.projectId);console.info("[Firebase Auth] config check:",{hasApiKey:!!ba.apiKey,authDomain:ba.authDomain,projectId:ba.projectId,configOk:a})}async function Ru(){if(typeof window>"u")return!1;for(const a of ts)try{const t=await fetch(a,{method:"HEAD",mode:"no-cors"});return console.info("[Firebase Auth] connectivity:",a,"ok"),!0}catch(t){console.warn("[Firebase Auth] connectivity failed:",a,t)}return console.warn("[Firebase Auth] All endpoints unreachable. Check proxy/firewall for:",ts),!1}const ol={admin_platforme:["dashboard","statistiques","parametres"],admin_compagnie:["dashboard","statistiques","agences","personnel","parametres"],financial_director:["dashboard","reservations","finances","depenses","statistiques"],company_accountant:["dashboard","reservations","finances","depenses","statistiques"],chef_garage:["dashboard","fleet"],chefAgence:["dashboard","reservations","finances","guichet","embarquement","fleet","personnel"],superviseur:["dashboard","reservations","finances","guichet","embarquement","fleet","personnel"],agentCourrier:["dashboard","reservations"],agency_accountant:["dashboard","finances","depenses","statistiques"],guichetier:["guichet","reservations"],chefEmbarquement:["boarding","embarquement","reservations"],agency_fleet_controller:["fleet"],unauthenticated:[],user:[]},Qs=o.createContext(null),ll=new Set(["admin_platforme","admin_compagnie","company_accountant","agency_accountant","chef_garage","chefagence","chefembarquement","guichetier","agency_fleet_controller","financial_director","agentcourrier"]),sn=a=>{if(!a||typeof a!="string")return"unauthenticated";const t=a.trim().toLowerCase();switch(t){case"chefagence":return"chefAgence";case"chefgarage":return"chef_garage";case"chefembarquement":return"chefEmbarquement";case"company_ceo":return"admin_compagnie";case"agentcourrier":return"agentCourrier";default:return ll.has(t)?t:t==="agency_boarding_officer"||t==="embarquement"?"chefEmbarquement":(console.error("Unknown role in AuthContext:",a),"unauthenticated")}},cl=a=>{if(!a)return null;if(a instanceof Date)return a;if(a instanceof We)return a.toDate();const t=new Date(a);return isNaN(t.getTime())?null:t},Tu=({children:a})=>{const[t,i]=o.useState(null),[s,n]=o.useState(null),[l,d]=o.useState(!0),[g,f]=o.useState(!1),b=o.useRef(!1),I=o.useCallback(async L=>{if(g||!L.email)return;const E=pe($,"users",L.uid);if((await He(E)).exists())return;const c=Te(he($,"invitations"),ae("email","==",L.email),ae("status","==","pending")),w=await Ee(c);if(w.empty)return;const N=w.docs[0],R=N.data(),H=R.role??"chefAgence",M=H==="comptable"&&R.agencyId?"agency_accountant":H==="comptable"?"company_accountant":H==="company_ceo"?"admin_compagnie":H;if(await jt(E,{uid:L.uid,email:L.email,role:M,companyId:R.companyId,agencyId:R.agencyId??"",nom:R.fullName??"",createdAt:Re(),lastLogin:Re()}),await gt(N.ref,{status:"accepted",uid:L.uid,acceptedAt:Re()}),R.companyId&&R.agencyId){const K=pe($,"companies",R.companyId,"agences",R.agencyId,"users",N.ref.id);try{await gt(K,{invitationPending:!1,uid:L.uid})}catch{}}},[g]),C=o.useCallback(async L=>{if(g)return;await I(L);const E=pe($,"users",L.uid),m=await He(E);if(!m.exists()){i({uid:L.uid,email:L.email||"",role:"unauthenticated",companyId:"",nom:""}),n(null);return}const c=m.data(),w=c.role,N=w==="comptable"&&c.agencyId?"agency_accountant":w==="comptable"?"company_accountant":w,R=sn(N),H=Array.from(new Set([...c.permissions||[],...ol[R]||[]])),M={uid:L.uid,email:L.email||c.email||"",displayName:L.displayName||c.nom||"",companyId:c.companyId||"",role:R,nom:c.nom||"",ville:c.ville||"",agencyId:c.agencyId||"",agencyName:c.agencyName,lastLogin:cl(c.lastLogin),permissions:H,companyLogo:c.companyLogo,companyColor:c.companyColor,agencyTelephone:c.agencyTelephone,agencyNom:c.agencyNom,agencyLogoUrl:c.agencyLogoUrl};if(i(M),M.companyId){const K=await He(pe($,"companies",M.companyId));n(K.exists()?{...K.data(),id:K.id}:null)}else n(null)},[I,g]),A=o.useCallback(async()=>{Ba.currentUser&&!g&&await C(Ba.currentUser)},[C,g]),u=o.useCallback(async()=>{f(!0),i(null),n(null);try{await Bi(Ba)}finally{f(!1)}},[]),x=o.useCallback(L=>{var m;if(!t)return!1;const E=sn(t.role);return E==="unauthenticated"?!1:E==="admin_platforme"?!0:!!((m=t.permissions)!=null&&m.includes(L))},[t]);o.useEffect(()=>{b.current||(b.current=!0,Gi(Ba,Ui).then(()=>{zi(Ba,async L=>{if(!g){if(d(!0),!L){i(null),n(null),d(!1);return}try{await C(L)}catch(E){(E==null?void 0:E.code)!=="permission-denied"&&console.error("‚ùå AuthContext error:",E)}finally{d(!1)}}})}))},[C,g]);const h=o.useMemo(()=>sn(t==null?void 0:t.role)==="admin_platforme",[t]);return e(Qs.Provider,{value:{user:t,loading:l,logout:u,refreshUser:A,hasPermission:x,companyId:(t==null?void 0:t.companyId)||null,company:s,isPlatformAdmin:h,isLoggingOut:g},children:a})},Ke=()=>o.useContext(Qs),Js={XOF:"FCFA",XAF:"FCFA",GHS:"GH‚Çµ",NGN:"‚Ç¶",GNF:"GNF",CVE:"CVE",GMD:"GMD",MRU:"MRU",LRD:"LRD",SLE:"SLE",EUR:"‚Ç¨",USD:"$"},dl=new Intl.NumberFormat("fr-FR");function ul(a,t){const i=Number(a)||0,s=(t||"XOF").toUpperCase(),n=Js[s]??s;return`${dl.format(i)} ${n}`}function Zs(a){const t=(a||"XOF").toUpperCase();return Js[t]??t}const Cn="XOF",Mn=o.createContext({currency:Cn,symbol:Zs(Cn)}),ei=({currency:a,children:t})=>{const i=a||Cn,s=o.useMemo(()=>({currency:i,symbol:Zs(i)}),[i]);return e(Mn.Provider,{value:s,children:t})};function ti(){return o.useContext(Mn).symbol}function Nt(){const{currency:a}=o.useContext(Mn);return o.useCallback(t=>ul(t,a),[a])}const Du=({children:a})=>{const{company:t}=Ke();return e(ei,{currency:t==null?void 0:t.devise,children:a})};function ml(){const[a,t]=o.useState(typeof navigator<"u"?navigator.onLine:!0);return o.useEffect(()=>{const i=()=>t(!0),s=()=>t(!1);return window.addEventListener("online",i),window.addEventListener("offline",s),()=>{window.removeEventListener("online",i),window.removeEventListener("offline",s)}},[]),a}function Qe(...a){return yi(bi(a))}const tt={pagePadding:"p-4 md:p-6",pageWidth:"max-w-7xl mx-auto",button:{height:"h-10",heightSm:"h-8",heightLg:"h-12",radius:"rounded-lg",fontWeight:"font-medium",fontSize:"text-sm",transition:"transition-colors duration-200",focusRing:"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2"},layout:{sidebarWidth:"w-64",sidebarWidthCollapsed:"w-20",headerHeight:"h-14"},zIndex:{header:"z-30",sidebar:"z-40"},defaultTheme:{primary:"#FF6600"}},hl={primary:"bg-[var(--btn-primary,#FF6600)] text-white hover:brightness-90 active:brightness-85",secondary:"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 active:bg-gray-100",ghost:"bg-transparent text-gray-700 hover:bg-gray-100 active:bg-gray-200",danger:"bg-red-600 text-white hover:bg-red-700 active:bg-red-800"},pl={default:`${tt.button.height} px-4 py-2 ${tt.button.fontSize}`,sm:`${tt.button.heightSm} px-3 text-sm`,lg:`${tt.button.heightLg} px-6 text-base`,icon:`${tt.button.height} w-10 justify-center`},pt=o.forwardRef(({className:a,variant:t="primary",size:i="default",disabled:s,...n},l)=>e("button",{ref:l,disabled:s,className:Qe("inline-flex items-center justify-center gap-2",tt.button.radius,tt.button.fontWeight,tt.button.transition,tt.button.focusRing,"disabled:pointer-events-none disabled:opacity-50",hl[t],pl[i],a),...n}));pt.displayName="Button";const gl=({blocks:a=2})=>e("div",{className:"p-6 space-y-3 animate-fadein",children:Array.from({length:a}).map((t,i)=>e("div",{className:"h-24 rounded-xl skeleton"},`loading-block-${i}`))}),fl=({message:a="Connexion instable: certaines donn√©es peuvent √™tre incompl√®tes."})=>e("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800",children:a}),yl=({message:a,onRetry:t,retryLabel:i="R√©essayer"})=>r("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700 flex items-center justify-between gap-3",children:[e("span",{children:a}),e("button",{type:"button",onClick:t,className:"px-3 py-1.5 rounded border border-red-300 hover:bg-red-100",children:i})]}),as=(a,t=1)=>{const i=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;a=a.replace(i,(g,f,b,I)=>f+f+b+b+I+I);const s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);if(!s)return`rgba(0, 0, 0, ${t})`;const[n,l,d]=[parseInt(s[1],16),parseInt(s[2],16),parseInt(s[3],16)];return`rgba(${n}, ${l}, ${d}, ${t})`},lr=a=>{const t=a.replace("#","");if(t.length!==6)return"#1e293b";const i=parseInt(t.substring(0,2),16),s=parseInt(t.substring(2,4),16),n=parseInt(t.substring(4,6),16),l=(.299*i+.587*s+.114*n)/255,d=l>.6?"#1e293b":"#FFFFFF";return d==="#FFFFFF"&&l>.8?"#1e293b":d},Pr=(a,t=.55)=>{const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a.replace("#",""));if(!i)return"#fdba74";const s=Math.round(parseInt(i[1],16)*(1-t)+255*t),n=Math.round(parseInt(i[2],16)*(1-t)+255*t),l=Math.round(parseInt(i[3],16)*(1-t)+255*t);return"#"+[s,n,l].map(d=>Math.min(255,Math.max(0,d)).toString(16).padStart(2,"0")).join("")},bl=a=>(a??"").toString().toLowerCase().trim().replace(/\s+/g,"_");function Ot(a){const t=bl(a);return t==="pay√©"?"paye":t==="embarqu√©"?"embarque":t==="annul√©"?"annule":t==="refus√©"?"refuse":t==="valid√©"?"confirme":t}const pr=["confirme","paye","pay√©","embarque","embarqu√©"],xl=new Map([["en_attente_paiement",new Set(["preuve_recue"])],["preuve_recue",new Set(["confirme","refuse"])],["verification",new Set(["confirme","refuse"])],["confirme",new Set(["embarque","annulation_en_attente","expire"])],["paye",new Set(["embarque","annulation_en_attente","expire"])],["annulation_en_attente",new Set(["annule"])],["annule",new Set(["rembourse"])]]);function vl(a,t){const i=Ot(a),s=Ot(t);if(!i||!s)return!1;if(i===s)return!0;const n=xl.get(i);return n?n.has(s):!1}const Nl=30;function wl(a){if(!a)return;const t=Ot(a.statut);if(t!=="confirme"&&t!=="paye")return a.statut?Ot(a.statut):void 0;const i=a.date;if(!i)return t;const s=typeof i=="string"?new Date(i):typeof i=="object"&&i&&"seconds"in i?new Date(i.seconds*1e3):null;if(!s||isNaN(s.getTime()))return t;const n=new Date(s);return n.setDate(n.getDate()+Nl),n<new Date?"expire":t}const Cl=new Set(["confirme","paye"]),Sl=new Set(["preuve_recue","verification"]),Al=new Set(["en_attente_paiement"]);function Il(a){const t=Ot(a);return Al.has(t)?null:t==="embarque"?{label:"Voyage effectu√©",section:"voyages_effectues"}:t==="annule"||t==="refuse"?{label:"Annul√©",section:"annules"}:t==="rembourse"?{label:"Rembours√©",section:"annules"}:t==="expire"?{label:"Expir√©",section:"annules"}:t==="annulation_en_attente"?{label:"En attente d'annulation",section:"en_verification"}:t==="preuve_recue"||t==="verification"?{label:"En v√©rification",section:"en_verification"}:t==="confirme"||t==="paye"?{label:"Valide",section:"a_venir"}:null}function $u(a){return Il(a)!==null}function Mu(a){return Cl.has(Ot(a))}function El(a){const t=Ot(a);return t==="confirme"||t==="paye"}function kl(a){if(!a)return!1;const t=(a.canal??"").toString().toLowerCase(),i=Ot(a.statut);return t==="guichet"||i==="confirme"}function _u(a){return a?kl(a)?!0:Sl.has(Ot(a.statut)):!1}const Rl=(a,t)=>{const i={moderne:{colors:{primary:"#3B82F6",secondary:"#10B981",accent:"#8B5CF6",background:"#F9FAFB",text:"#111827"},typography:"sans-serif",buttons:"rounded-lg",effects:"shadow-md hover:shadow-lg",borders:"rounded-lg",animations:"transition-all duration-300"},classique:{colors:{primary:"#2563EB",secondary:"#1E40AF",accent:"#4B5563",background:"#FFFFFF",text:"#1F2937"},typography:"serif",buttons:"rounded-sm",effects:"shadow-sm",borders:"border",animations:"transition-colors duration-200"},sombre:{colors:{primary:"#F59E0B",secondary:"#F97316",accent:"#F43F5E",background:"#111827",text:"#F3F4F6"},typography:"sans-serif",buttons:"rounded-md",effects:"shadow-lg",borders:"border border-gray-700",animations:"transition-transform duration-300"},contraste:{colors:{primary:"#EF4444",secondary:"#F59E0B",accent:"#22D3EE",background:"#FFFFFF",text:"#000000"},typography:"sans-serif",buttons:"rounded-full",effects:"shadow-xl",borders:"border-2 border-black",animations:"hover:scale-105 transition-transform"},minimaliste:{colors:{primary:"#6B7280",secondary:"#9CA3AF",accent:"#D1D5DB",background:"#FFFFFF",text:"#374151"},typography:"sans-serif",buttons:"",effects:"",borders:"",animations:""},glassmorphism:{colors:{primary:"rgba(59, 130, 246, 0.8)",secondary:"rgba(16, 185, 129, 0.8)",accent:"rgba(255, 255, 255, 0.3)",background:"rgba(255, 255, 255, 0.1)",text:"#FFFFFF"},typography:"sans-serif",buttons:"rounded-lg backdrop-blur-md",effects:"backdrop-filter backdrop-blur-lg bg-opacity-20",borders:"border border-white border-opacity-20",animations:"transition-all duration-500"}},s=i[a]||i.moderne;return{...s,colors:{...s.colors,primary:(t==null?void 0:t.couleurPrimaire)||s.colors.primary,secondary:(t==null?void 0:t.couleurSecondaire)||s.colors.secondary,accent:s.colors.accent||s.colors.primary}}},rs="companyTheme",Lt=a=>{const[t,i]=o.useState(()=>{const n=sessionStorage.getItem(rs);return n?JSON.parse(n):null}),s=o.useMemo(()=>{var c,w,N,R,H,M,K,B;const n=Rl((a==null?void 0:a.themeStyle)||"moderne"),l=((c=a==null?void 0:a.couleurPrimaire)==null?void 0:c.trim())||((w=t==null?void 0:t.colors)==null?void 0:w.primary)||n.colors.primary||"#3B82F6",d=((N=a==null?void 0:a.couleurSecondaire)==null?void 0:N.trim())||((R=t==null?void 0:t.colors)==null?void 0:R.secondary)||n.colors.secondary||"#6366F1",g=((H=a==null?void 0:a.couleurAccent)==null?void 0:H.trim())||((M=t==null?void 0:t.colors)==null?void 0:M.accent)||"#FBBF24",f=((K=a==null?void 0:a.couleurTertiaire)==null?void 0:K.trim())||((B=t==null?void 0:t.colors)==null?void 0:B.tertiary)||"#6366F1",b=as(l,.15),I=as(l,.85),C=lr(l),A=lr(d),u=C==="#FFFFFF"?"#1e293b":C,x=A==="#FFFFFF"?"#64748b":A,h=lr(l),L=l,E=I,m={config:n,colors:{primary:l,secondary:d,accent:g,tertiary:f,primaryLight:b,primaryDark:I,textPrimary:u,textSecondary:x,buttonText:h,buttonBg:L,buttonBorder:E,background:n.colors.background,text:u},classes:{background:n.colors.background,text:n.colors.text,card:`bg-white ${n.effects} ${n.borders}`,button:`text-[${h}] bg-[${L}] border-[${E}] ${n.buttons} ${n.animations}`,input:`${n.borders} ${n.animations}`,header:`bg-white ${n.effects} ${n.borders}`,animations:n.animations}};return{...m,primary:m.colors.primary,secondary:m.colors.secondary,primaryLight:m.colors.primaryLight,primaryDark:m.colors.primaryDark,textPrimary:m.colors.textPrimary,textSecondary:m.colors.textSecondary}},[a,t]);return o.useEffect(()=>{a!=null&&a.couleurPrimaire&&(a!=null&&a.couleurSecondaire)&&sessionStorage.setItem(rs,JSON.stringify(s))},[a,s]),s},Tl={admin_platforme:"Admin Plateforme",admin_compagnie:"CEO",chef_garage:"Chef garage",chefAgence:"Chef d'agence",superviseur:"Superviseur",guichetier:"Guichetier",company_accountant:"Chef Comptable",financial_director:"Directeur Financier",agency_accountant:"Comptable Agence"},_n=({sections:a,role:t,userName:i,userEmail:s,brandName:n="Teliya",logoUrl:l,primaryColor:d,secondaryColor:g,headerLeft:f,headerRight:b,onLogout:I,banner:C,children:A,mainClassName:u})=>{const x=d||tt.defaultTheme.primary,h=g||x,L=a.length>4,E=i||s||"Utilisateur",m=Tl[t]??t,c=E.charAt(0).toUpperCase();return L?e(Dl,{sections:a,role:m,displayName:E,userInitial:c,brandName:n,logoUrl:l,primary:x,secondary:h,headerLeft:f,headerRight:b,onLogout:I,banner:C,mainClassName:u,children:A}):e($l,{sections:a,role:m,displayName:E,userInitial:c,brandName:n,logoUrl:l,primary:x,secondary:h,headerLeft:f,headerRight:b,onLogout:I,banner:C,mainClassName:u,children:A})};function ns(a,t){var i;return a===t.path?!0:(i=t.children)!=null&&i.length?t.children.some(s=>s.end?a===s.path:a===s.path||a.startsWith(s.path+"/")):!1}const Dl=({sections:a,role:t,displayName:i,userInitial:s,brandName:n,logoUrl:l,primary:d,secondary:g,headerLeft:f,headerRight:b,onLogout:I,banner:C,children:A,mainClassName:u})=>{const[x,h]=o.useState(!1),[L,E]=o.useState(!1),c=Aa().pathname,[w,N]=o.useState(()=>{const M=new Set;return a.forEach(K=>{var B;(B=K.children)!=null&&B.length&&ns(c,K)&&M.add(K.path)}),M});o.useEffect(()=>{a.forEach(M=>{var K;(K=M.children)!=null&&K.length&&ns(c,M)&&N(B=>B.has(M.path)?B:new Set(B).add(M.path))})},[c,a]);const R=M=>{N(K=>{const B=new Set(K);return B.has(M)?B.delete(M):B.add(M),B})},H=r("div",{className:"flex-1 flex flex-col",children:[r("div",{className:"px-4 py-4 border-b border-white/15 flex items-center justify-between",children:[r("div",{className:"flex items-center gap-2 overflow-hidden",children:[l?e("img",{src:l,alt:n,className:"w-9 h-9 rounded-full bg-white object-cover shrink-0 p-[2px]"}):e("div",{className:"w-9 h-9 rounded-full bg-white/20 grid place-items-center shrink-0",children:e(Rn,{className:"w-5 h-5"})}),!x&&e("span",{className:"text-lg font-semibold tracking-wide truncate",children:n})]}),e("button",{onClick:()=>h(M=>!M),className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 hidden md:block",title:x?"Expand":"Collapse",children:x?e(Yi,{className:"w-5 h-5"}):e(Wi,{className:"w-5 h-5"})})]}),e("nav",{className:"flex-1 overflow-y-auto overflow-x-hidden px-2 pt-3 pb-24",children:a.map(({label:M,icon:K,path:B,badge:le,end:Q,children:Z})=>{const j=Z&&Z.length>0,k=w.has(B);return j?r("div",{className:"my-1",children:[r("div",{className:"flex items-center gap-1 rounded-xl overflow-hidden",children:[r(Rr,{to:B,end:Q,className:({isActive:W})=>Qe("group flex flex-1 items-center gap-3 rounded-xl px-3 py-2.5 transition-all duration-200 min-w-0","whitespace-nowrap overflow-hidden",W?"font-semibold text-white shadow-sm":"text-white/80 hover:text-white hover:bg-white/10"),style:({isActive:W})=>W?{backgroundColor:g,borderLeftWidth:"4px",borderLeftColor:"rgba(255,255,255,0.6)"}:{borderLeftWidth:"4px",borderLeftColor:"transparent"},title:M,onClick:()=>E(!1),children:[e(K,{className:"w-5 h-5 shrink-0"}),!x&&e("span",{className:"truncate flex-1 text-sm",children:M}),!x&&typeof le=="number"&&le>0&&e("span",{className:"bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full leading-none",children:le>99?"99+":le})]}),!x&&e("button",{type:"button",onClick:W=>{W.preventDefault(),R(B)},className:"p-2 rounded-lg text-white/80 hover:text-white hover:bg-white/10 transition-all duration-200","aria-expanded":k,"aria-label":k?"R√©duire":"D√©velopper",children:k?e(Xi,{className:"w-4 h-4"}):e(Qi,{className:"w-4 h-4"})})]}),!x&&e("div",{className:"grid transition-[grid-template-rows] duration-200 ease-in-out",style:{gridTemplateRows:k?"1fr":"0fr"},"aria-hidden":!k,children:e("div",{className:"overflow-hidden",children:e("div",{className:"pl-4 pr-2 py-1 space-y-0.5 border-l-2 border-white/20 ml-3 mt-0.5",children:Z.map(W=>e(Rr,{to:W.path,end:W.end,className:({isActive:q})=>Qe("flex items-center gap-2 rounded-lg px-3 py-2 text-sm transition-all duration-200",q?"font-medium text-white bg-white/20":"text-white/70 hover:text-white hover:bg-white/10"),onClick:()=>E(!1),children:W.label},W.path))})})})]},B):r(Rr,{to:B,end:Q,className:({isActive:W})=>Qe("group flex items-center gap-3 my-1 rounded-xl px-3 py-2.5 transition-all duration-200","whitespace-nowrap overflow-hidden",W?"font-semibold text-white shadow-sm":"text-white/80 hover:text-white hover:bg-white/10"),style:({isActive:W})=>W?{backgroundColor:g,borderLeftWidth:"4px",borderLeftColor:"rgba(255,255,255,0.6)"}:{borderLeftWidth:"4px",borderLeftColor:"transparent"},title:M,onClick:()=>E(!1),children:[e(K,{className:"w-5 h-5 shrink-0"}),!x&&e("span",{className:"truncate flex-1 text-sm",children:M}),!x&&typeof le=="number"&&le>0&&e("span",{className:"bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full leading-none",children:le>99?"99+":le})]},B)})}),e("div",{className:"px-4 py-3 border-t border-white/15",style:{backgroundColor:`${d}DD`},children:r("div",{className:"flex items-center justify-between",children:[r("div",{className:"flex items-center gap-3 min-w-0",children:[e("div",{className:"w-9 h-9 rounded-full bg-white/20 grid place-items-center shrink-0 text-sm font-bold",children:s}),!x&&r("div",{className:"min-w-0",children:[e("p",{className:"text-sm font-semibold truncate",children:i}),e("p",{className:"text-[11px] text-white/80 leading-tight truncate",children:t})]})]}),e("button",{onClick:I,className:"w-9 h-9 rounded-full bg-white/20 hover:bg-white/30 grid place-items-center transition",title:"Logout",children:e(dr,{className:"w-4 h-4"})})]})})]});return r("div",{className:"h-screen overflow-hidden bg-gray-50",children:[L&&e("div",{className:"fixed inset-0 bg-black/40 z-40 md:hidden",onClick:()=>E(!1)}),r("div",{className:"flex h-full",children:[e("aside",{className:Qe("hidden md:flex fixed inset-y-0 left-0 flex-col text-white transition-all duration-300",tt.zIndex.sidebar,x?tt.layout.sidebarWidthCollapsed:tt.layout.sidebarWidth),style:{backgroundColor:d},children:H}),r("aside",{className:Qe("md:hidden fixed inset-y-0 left-0 w-64 flex flex-col text-white transition-transform duration-300",tt.zIndex.sidebar,L?"translate-x-0":"-translate-x-full"),style:{backgroundColor:d},children:[e("button",{onClick:()=>E(!1),className:"absolute top-4 right-4 p-1 rounded-lg bg-white/10 hover:bg-white/20",children:e(Ia,{className:"w-5 h-5"})}),H]}),r("div",{className:Qe("flex-1 flex flex-col min-w-0 transition-all duration-300",x?"md:ml-20":"md:ml-64"),children:[r("header",{className:Qe("sticky top-0 bg-white border-b shadow-sm flex items-center px-4 md:px-6 gap-4",tt.zIndex.header,tt.layout.headerHeight),children:[e("button",{onClick:()=>E(!0),className:"md:hidden p-2 -ml-2 rounded-lg hover:bg-gray-100",children:e(Ji,{className:"w-5 h-5"})}),e("div",{className:"flex-1 min-w-0",children:f}),r("div",{className:"flex items-center gap-2",children:[!f&&r("div",{className:"hidden sm:block text-right mr-1",children:[e("p",{className:"text-sm font-medium text-gray-900 leading-tight",children:i}),e("p",{className:"text-xs text-gray-500 leading-tight",children:t})]}),b,e("button",{onClick:I,className:"p-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 transition",title:"Se d√©connecter",children:e(dr,{className:"w-4 h-4 text-gray-600"})})]})]}),C,e("main",{className:Qe("flex-1 overflow-y-auto",tt.pagePadding),children:e("div",{className:Qe(tt.pageWidth,u),children:A??e(gr,{})})})]})]})]})},$l=({sections:a,role:t,displayName:i,userInitial:s,brandName:n,logoUrl:l,primary:d,secondary:g,headerLeft:f,headerRight:b,onLogout:I,banner:C,children:A,mainClassName:u})=>r("div",{className:"min-h-screen bg-gray-50",children:[r("header",{className:Qe("sticky top-0 border-b bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70",tt.zIndex.header),children:[r("div",{className:Qe(tt.pageWidth,"px-4 md:px-6 py-3 flex items-center justify-between gap-4"),children:[r("div",{className:"flex items-center gap-3 min-w-0",children:[l?e("img",{src:l,alt:n,className:"w-9 h-9 rounded-full object-cover border bg-white p-0.5 shrink-0",onError:x=>{x.currentTarget.style.display="none"}}):e("div",{className:"w-9 h-9 rounded-full bg-gray-100 grid place-items-center shrink-0",children:e(Rn,{className:"w-5 h-5 text-gray-500"})}),e("div",{className:"min-w-0",children:e("div",{className:"font-bold tracking-tight truncate text-base",style:{color:d},children:n})})]}),r("div",{className:"flex items-center gap-2",children:[r("div",{className:"hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-50 border",children:[e("div",{className:"w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold shrink-0",style:{backgroundColor:d},children:s}),r("div",{className:"min-w-0",children:[e("div",{className:"text-xs font-medium text-gray-900 truncate",children:i}),e("div",{className:"text-xs text-gray-500 truncate",children:t})]})]}),e("button",{onClick:I,className:"p-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 transition",title:"Logout",children:e(dr,{className:"w-4 h-4 text-gray-600"})})]})]}),e("div",{className:"border-t bg-white",children:e("div",{className:Qe(tt.pageWidth,"px-4 md:px-6 py-2"),children:e("div",{className:"flex flex-wrap gap-2 overflow-x-auto",children:a.map(({label:x,icon:h,path:L,badge:E,end:m})=>r(Rr,{to:L,end:m,className:({isActive:c})=>Qe("inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition",c?"text-white shadow-sm":"text-gray-600 bg-white border hover:bg-gray-50"),style:({isActive:c})=>c?{background:`linear-gradient(135deg, ${d}, ${g})`}:void 0,children:[e(h,{className:"w-4 h-4"}),x,typeof E=="number"&&E>0&&e("span",{className:"bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full leading-none ml-1",children:E>99?"99+":E})]},L))})})})]}),C,e("main",{className:Qe(tt.pagePadding,"pb-8"),children:e("div",{className:Qe(tt.pageWidth,u),children:A??e(gr,{})})})]});function br(){const[a,t]=o.useState(typeof navigator<"u"?navigator.onLine:!0);return o.useEffect(()=>{const i=()=>t(!0),s=()=>t(!1);return window.addEventListener("online",i),window.addEventListener("offline",s),()=>{window.removeEventListener("online",i),window.removeEventListener("offline",s)}},[]),a}const ss="theme";function Gr(){const[a,t]=o.useState(!1);return o.useEffect(()=>{try{let s=localStorage.getItem(ss);s===null&&(s=localStorage.getItem("agency-dark-mode")==="1"?"dark":"light"),t(s==="dark")}catch{t(!1)}},[]),o.useEffect(()=>{document.documentElement.classList.toggle("dark",a)},[a]),[a,()=>{t(s=>{const n=!s;try{localStorage.setItem(ss,n?"dark":"light")}catch{}return n})}]}function Ln(a){const t=aa(),i=Aa();o.useEffect(()=>{const s=n=>{if(n.key==="F2"){n.preventDefault();const l=i.pathname,d=a.findIndex(b=>b.path===l||b.end&&l===b.path||!b.end&&l.startsWith(b.path+"/")),g=d<0?0:(d+1)%a.length,f=a[g];f&&t(f.path)}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[a,i.pathname,t])}const Pn=({isOnline:a,darkMode:t,onDarkModeToggle:i})=>r(bt,{children:[!a&&r("div",{className:"flex items-center gap-1 px-2 py-1 rounded-full bg-red-50 text-red-700 text-[10px] font-semibold",title:"Connexion perdue",children:[e(qs,{className:"w-3 h-3"}),e("span",{className:"hidden sm:inline",children:"Hors-ligne"})]}),e("button",{type:"button",onClick:i,className:"flex items-center justify-center w-9 h-9 rounded-full border-2 border-slate-300 dark:border-slate-500 bg-white dark:bg-slate-700 text-slate-700 dark:text-gray-200 hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors",title:t?"Mode jour (‚òÄÔ∏è)":"Mode nuit (üåô)",children:t?e("span",{className:"text-base","aria-hidden":!0,children:"‚òÄÔ∏è"}):e("span",{className:"text-base","aria-hidden":!0,children:"üåô"})})]});function ai(a,t,i){return{action:"transition_statut",ancienStatut:a,nouveauStatut:t,effectuePar:i.userId,role:i.userRole,date:Re()}}async function Ml(a,t,i,s={}){const n=await He(a);if(!n.exists())throw new Error("R√©servation introuvable.");const l=n.data(),d=(l==null?void 0:l.statut)??"";if(!vl(d,t))throw new Error(`Transition non autoris√©e : ${d} ‚Üí ${t}`);const g=ai(d,t,i);await gt(a,{statut:t,auditLog:Vs(g),updatedAt:Re(),...s})}const _l=()=>{const t=Aa().state,i=Nt(),s=Je(new Date,"dd/MM/yyyy");return r("div",{className:"bg-white text-black p-6 print:p-0 print:m-0",children:[e("div",{className:"print:hidden flex justify-end mb-4",children:e(pt,{onClick:()=>{window.print(),setTimeout(()=>window.history.back(),500)},variant:"primary",children:"üñ®Ô∏è Imprimer"})}),r("div",{className:"print:block print:w-full print:max-w-4xl print:mx-auto print:my-0 print:bg-white print:text-black",children:[r("header",{className:"text-center border-b border-gray-300 pb-4 mb-6 print:pb-2 print:mb-4",children:[t.logoUrl&&e("img",{src:t.logoUrl,alt:"logo",className:"h-16 mx-auto mb-2 print:h-14"}),e("h1",{className:"text-xl font-bold print:text-lg",children:t.companyName}),r("div",{className:"text-xs text-gray-600 print:text-xs",children:[t.agencyName&&r("span",{children:[t.agencyName," - "]}),r("span",{children:["Imprim√© le ",s]})]}),r("h2",{className:"text-lg font-semibold mt-2 print:mt-1 print:text-base",children:["Liste des r√©servations pour le trajet :"," ",e("span",{className:"text-blue-600",children:t.trajet})]}),r("p",{className:"text-sm text-gray-700 print:text-xs",children:["D√©part le ",t.date," √† ",t.heure]})]}),r("table",{className:"w-full text-xs border border-gray-300 print:text-xs",children:[e("thead",{className:"bg-gray-100 print:bg-gray-100",children:r("tr",{children:[e("th",{className:"border px-2 py-1 w-8",children:"#"}),e("th",{className:"border px-2 py-1 text-left",children:"Nom du client"}),e("th",{className:"border px-2 py-1 text-left",children:"T√©l√©phone"}),e("th",{className:"border px-2 py-1 w-12",children:"Places"}),e("th",{className:"border px-2 py-1 text-right",children:"Montant"}),e("th",{className:"border px-2 py-1 text-center",children:"Statut"})]})}),e("tbody",{children:t.reservations.map((n,l)=>r("tr",{className:"break-inside-avoid",children:[e("td",{className:"border px-2 py-1 text-center",children:l+1}),e("td",{className:"border px-2 py-1",children:n.nomClient}),e("td",{className:"border px-2 py-1",children:n.telephone}),e("td",{className:"border px-2 py-1 text-center",children:n.seatsGo||1}),e("td",{className:"border px-2 py-1 text-right",children:i(n.montant)}),e("td",{className:"border px-2 py-1 text-center",children:e("span",{className:`inline-block px-1 rounded ${n.statut==="Confirm√©"?"bg-green-100 text-green-800":n.statut==="En attente"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"}`,children:n.statut})})]},n.id))})]}),r("div",{className:"mt-2 text-right text-xs",children:["Total r√©servations: ",t.reservations.length," | Places totales: ",t.reservations.reduce((n,l)=>n+(l.seatsGo||1),0)," | Montant total: ",i(t.reservations.reduce((n,l)=>n+(l.montant||0),0))]}),r("div",{className:"mt-6 text-right text-xs italic text-gray-700 print:mt-4",children:[e("div",{className:"border-t border-dashed border-gray-400 w-32 mb-1 ml-auto"}),"Signature du responsable"]}),r("footer",{className:"mt-8 text-center text-xs text-gray-500 print:mt-4",children:[r("p",{children:["Document imprim√© le ",s," - ",t.companyName]}),e("p",{className:"mt-1",children:"Merci pour votre confiance"})]})]})]})},Lu=Object.freeze(Object.defineProperty({__proto__:null,default:_l},Symbol.toStringTag,{value:"Module"}));function Ll(){if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID();const a=new Uint8Array(16);return crypto.getRandomValues(a),Array.from(a,t=>t.toString(16).padStart(2,"0")).join("")}async function Pl(a){var I,C,A,u;const t=a.email.trim().toLowerCase();if(!t)throw new Error("Email est requis.");if(!a.role)throw new Error("R√¥le est requis.");const i=await Ee(Te(he($,"invitations"),ae("email","==",t),ae("status","==","pending"))),s=((I=a.companyId)==null?void 0:I.trim())||"",n=((C=a.agencyId)==null?void 0:C.trim())||"";if(i.docs.find(x=>{const h=x.data();return(h.companyId??"")===s&&(h.agencyId??"")===n}))throw Object.assign(new Error("Une invitation en attente existe d√©j√† pour cet email dans ce p√©rim√®tre."),{code:"already-exists"});const d=Ll(),g={email:t,role:a.role,status:"pending",token:d,createdAt:Re(),createdBy:a.createdBy||"admin"};s&&(g.companyId=s),n&&(g.agencyId=n),(A=a.fullName)!=null&&A.trim()&&(g.fullName=a.fullName.trim()),(u=a.phone)!=null&&u.trim()&&(g.phone=a.phone.trim());const f=await kn(he($,"invitations"),g),b=`${window.location.origin}/accept-invitation/${d}`;return{inviteId:f.id,token:d,activationUrl:b}}const Fl={trial:{CREATE_RESERVATION:"allow",CREATE_AGENCY:"allow",ACCESS_DASHBOARD:"allow",RECEIVE_ONLINE_BOOKING:"allow",MANAGE_SETTINGS:"allow"},active:{CREATE_RESERVATION:"allow",CREATE_AGENCY:"allow",ACCESS_DASHBOARD:"allow",RECEIVE_ONLINE_BOOKING:"allow",MANAGE_SETTINGS:"allow"},grace:{CREATE_RESERVATION:"warn",CREATE_AGENCY:"warn",ACCESS_DASHBOARD:"warn",RECEIVE_ONLINE_BOOKING:"warn",MANAGE_SETTINGS:"warn"},restricted:{CREATE_RESERVATION:"block",CREATE_AGENCY:"block",ACCESS_DASHBOARD:"allow",RECEIVE_ONLINE_BOOKING:"block",MANAGE_SETTINGS:"allow"},suspended:{CREATE_RESERVATION:"block",CREATE_AGENCY:"block",ACCESS_DASHBOARD:"block",RECEIVE_ONLINE_BOOKING:"block",MANAGE_SETTINGS:"block"}},jl="Votre abonnement a expir√©. Veuillez effectuer un paiement pour √©viter la restriction de votre compte.",Ol="Votre compte est restreint. La cr√©ation de r√©servations et d'agences est d√©sactiv√©e. Veuillez r√©gulariser votre paiement.",Vl="Votre compte est suspendu. Seul l'acc√®s au paiement est disponible. Contactez le support Teliya.";function ql(a,t){var n;const i=a??"active";switch(((n=Fl[i])==null?void 0:n[t])??"block"){case"allow":return{allowed:!0};case"warn":return{allowed:!0,warning:jl};case"block":return{allowed:!1,reason:i==="suspended"?Vl:Ol};default:return{allowed:!1,reason:"Action non autoris√©e."}}}const Bl="fr-FR";function Gl(a){return a?typeof(a==null?void 0:a.toDate)=="function"?a.toDate():a instanceof Date?a:typeof a=="number"?new Date(a):typeof a=="string"?new Date(a):null:null}function ri(a){const t=Gl(a);return t?new Intl.DateTimeFormat(Bl,{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(t):"‚Äî"}const _={page:"max-w-7xl mx-auto p-4 md:p-6 space-y-6",h1:"text-2xl font-bold text-gray-900",h2:"text-lg font-semibold text-gray-900",muted:"text-sm text-gray-500",card:"rounded-xl border border-gray-200 bg-white shadow-sm",kpi:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm flex flex-col justify-between min-h-[110px]",kpiCritical:"rounded-xl border-2 border-red-400 bg-red-50/50 p-5 shadow-sm flex flex-col justify-between min-h-[110px]",table:{wrapper:"overflow-x-auto",base:"w-full text-sm",head:"border-b border-gray-200 bg-gray-50/60",th:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",thRight:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",body:"divide-y divide-gray-100",td:"px-4 py-3 text-gray-700",tdRight:"px-4 py-3 text-right text-gray-700",row:"hover:bg-gray-50/50 transition-colors"},alert:{green:"bg-emerald-50 text-emerald-800",yellow:"bg-amber-50 text-amber-800",red:"bg-red-50 text-red-800"},dot:{green:"bg-emerald-500",yellow:"bg-amber-500",red:"bg-red-500"},input:"border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-gray-300",btnPrimary:"inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium bg-emerald-600 text-white hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",btnSecondary:"inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",btnDanger:"inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium bg-red-600 text-white hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"},Fn=({text:a})=>{const[t,i]=o.useState(!1),s=o.useRef(null);return o.useEffect(()=>{if(!t)return;const n=d=>{s.current&&!s.current.contains(d.target)&&i(!1)},l=d=>{d.key==="Escape"&&i(!1)};return document.addEventListener("mousedown",n),document.addEventListener("touchstart",n),document.addEventListener("keydown",l),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("touchstart",n),document.removeEventListener("keydown",l)}},[t]),r("span",{ref:s,className:"relative inline-flex items-center ml-1",children:[e("button",{type:"button",onClick:()=>i(n=>!n),onMouseEnter:()=>i(!0),onMouseLeave:()=>i(!1),className:"text-gray-400 hover:text-gray-600 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-gray-400 rounded-full","aria-label":"Aide",tabIndex:0,children:e(Zi,{className:"w-3.5 h-3.5"})}),r("span",{className:Qe("absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-gray-800 text-white text-xs rounded-lg","px-3 py-2 w-56 shadow-lg z-50 leading-relaxed text-center","transition-all duration-150 origin-bottom",t?"opacity-100 scale-100 pointer-events-auto":"opacity-0 scale-95 pointer-events-none"),role:"tooltip",children:[a,e("span",{className:"absolute top-full left-1/2 -translate-x-1/2 -mt-px border-4 border-transparent border-t-gray-800"})]})]})},dt=({label:a,value:t,icon:i,accent:s="text-gray-900",help:n,critical:l})=>r("div",{className:l?_.kpiCritical:_.kpi,children:[r("div",{className:"flex items-center justify-between",children:[r("p",{className:Qe(_.muted,"flex items-center"),children:[a,n&&e(Fn,{text:n})]}),l?e(Ha,{className:"w-5 h-5 text-red-500"}):i&&e(i,{className:"w-5 h-5 text-gray-400"})]}),e("p",{className:Qe("text-2xl font-bold mt-1",l?"text-red-700":s),children:t}),l&&e("p",{className:"text-xs text-red-600 font-medium mt-0.5",children:"√âcart de caisse d√©tect√©"})]}),Zt=({title:a,icon:t,right:i,children:s,noPad:n,help:l})=>r("section",{className:_.card,children:[r("div",{className:"px-5 py-4 border-b border-gray-100 flex items-center justify-between gap-3",children:[r("h2",{className:Qe(_.h2,"flex items-center gap-2"),children:[t&&e(t,{className:"w-5 h-5 text-gray-500"}),a,l&&e(Fn,{text:l})]}),i]}),e("div",{className:n?"":"p-5",children:s})]}),Ul=({severity:a,message:t})=>r("div",{className:Qe("flex items-start gap-3 px-4 py-3 rounded-lg",_.alert[a]),children:[e("span",{className:Qe("w-2 h-2 rounded-full mt-1.5 shrink-0",_.dot[a])}),e("p",{className:"text-sm",children:t})]}),is={green:{bg:"bg-emerald-100",fg:"text-emerald-800"},yellow:{bg:"bg-amber-100",fg:"text-amber-800"},red:{bg:"bg-red-100",fg:"text-red-800"},gray:{bg:"bg-gray-100",fg:"text-gray-700"},blue:{bg:"bg-blue-100",fg:"text-blue-800"},purple:{bg:"bg-purple-100",fg:"text-purple-800"}},xt=({color:a,children:t})=>{const i=is[a]??is.gray;return e("span",{className:Qe("inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",i.bg,i.fg),children:t})},Sa=({message:a})=>e("div",{className:"py-8 text-center text-sm text-gray-500",children:a}),zl=({open:a,title:t,message:i,confirmLabel:s="Confirmer",cancelLabel:n="Annuler",variant:l="primary",onConfirm:d,onCancel:g})=>{const f=o.useRef(null);return o.useEffect(()=>{if(!a)return;const b=I=>{I.key==="Escape"&&g()};return document.addEventListener("keydown",b),()=>document.removeEventListener("keydown",b)},[a,g]),a?r("div",{ref:f,className:"fixed inset-0 z-[100] flex items-center justify-center p-4",onClick:b=>{b.target===f.current&&g()},children:[e("div",{className:"fixed inset-0 bg-black/40"}),r("div",{className:"relative bg-white rounded-xl shadow-xl max-w-sm w-full p-6 space-y-4 animate-in fade-in zoom-in-95",children:[r("div",{className:"flex items-start justify-between",children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:t}),e("button",{onClick:g,className:"p-1 rounded-lg hover:bg-gray-100 transition",children:e(Ia,{className:"w-4 h-4 text-gray-500"})})]}),e("p",{className:"text-sm text-gray-600",children:i}),r("div",{className:"flex items-center justify-end gap-2 pt-2",children:[e("button",{onClick:g,className:_.btnSecondary,children:n}),e("button",{onClick:d,className:l==="danger"?_.btnDanger:_.btnPrimary,children:s})]})]})]}):null},os={today:"Aujourd'hui","7d":"7 jours","30d":"30 jours",month:"Ce mois",custom:"Personnalis√©"};function Pa(a){const t=new Date(a);return t.setHours(0,0,0,0),t}function Fa(a){const t=new Date(a);return t.setHours(23,59,59,999),t}function Hl(a,t,i){const s=new Date;switch(a){case"today":return{start:Pa(s),end:Fa(s)};case"7d":{const n=new Date;return n.setDate(n.getDate()-7),{start:Pa(n),end:Fa(s)}}case"30d":{const n=new Date;return n.setDate(n.getDate()-30),{start:Pa(n),end:Fa(s)}}case"month":{const n=new Date;return n.setDate(1),{start:Pa(n),end:Fa(s)}}case"custom":return{start:Pa(t?new Date(t):s),end:Fa(i?new Date(i):s)}}}const jn=({preset:a,onPresetChange:t,customStart:i,customEnd:s,onCustomStartChange:n,onCustomEndChange:l})=>r("div",{className:"flex items-center flex-wrap gap-2",children:[Object.keys(os).map(d=>e("button",{onClick:()=>t(d),className:Qe("px-3 py-1.5 rounded-lg text-sm font-medium transition-colors",a===d?"bg-gray-900 text-white":"border border-gray-300 bg-white text-gray-600 hover:bg-gray-50"),children:os[d]},d)),a==="custom"&&r("div",{className:"flex items-center gap-2 ml-1",children:[e("input",{type:"date",value:i,onChange:d=>n(d.target.value),className:_.input}),e("span",{className:"text-gray-400",children:"‚Üí"}),e("input",{type:"date",value:s,onChange:d=>l(d.target.value),className:_.input})]})]}),Kl=({alerts:a,totalCount:t})=>{const[i,s]=o.useState(!1),n=o.useRef(null);return o.useEffect(()=>{if(!i)return;const l=d=>{n.current&&!n.current.contains(d.target)&&s(!1)};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[i]),r("div",{ref:n,className:"relative",children:[r("button",{onClick:()=>s(l=>!l),className:"relative p-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 transition",title:"Notifications",children:[e("svg",{className:"w-4 h-4 text-gray-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})}),t>0&&e("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full leading-none min-w-[18px] text-center",children:t>99?"99+":t})]}),i&&r("div",{className:"absolute right-0 top-full mt-2 w-80 max-h-96 overflow-y-auto bg-white rounded-xl shadow-xl border border-gray-200 z-50",children:[e("div",{className:"px-4 py-3 border-b border-gray-100",children:r("p",{className:"text-sm font-semibold text-gray-900",children:["Alertes (",t,")"]})}),a.length===0?e("div",{className:"px-4 py-6 text-center text-sm text-gray-500",children:"Aucune alerte"}):e("div",{className:"divide-y divide-gray-100",children:a.slice(0,15).map(l=>e("a",{href:l.link,onClick:()=>s(!1),className:"block px-4 py-3 hover:bg-gray-50 transition-colors",children:r("div",{className:"flex items-start gap-2",children:[e("span",{className:Qe("w-2 h-2 rounded-full mt-1.5 shrink-0",l.severity==="critical"?"bg-red-500":l.severity==="warning"?"bg-amber-500":"bg-blue-500")}),r("div",{className:"min-w-0",children:[e("p",{className:"text-sm font-medium text-gray-900",children:l.title}),e("p",{className:"text-xs text-gray-500 mt-0.5",children:l.description})]})]})},l.id))})]})]})},ni=o.createContext(null),ls="range",on="from",ln="to",Yl=["today","7d","30d","month","custom"],Wl=({children:a})=>{const[t,i]=js(),s=t.get(ls),n=s&&Yl.includes(s)?s:"today",[l,d]=o.useState(n),[g,f]=o.useState(t.get(on)||""),[b,I]=o.useState(t.get(ln)||""),C=o.useCallback(L=>{d(L),i(E=>{const m=new URLSearchParams(E);return m.set(ls,L),L!=="custom"&&(m.delete(on),m.delete(ln)),m},{replace:!0})},[i]),A=o.useCallback(L=>{f(L),i(E=>{const m=new URLSearchParams(E);return m.set(on,L),m},{replace:!0})},[i]),u=o.useCallback(L=>{I(L),i(E=>{const m=new URLSearchParams(E);return m.set(ln,L),m},{replace:!0})},[i]),x=o.useMemo(()=>Hl(l,g,b),[l,g,b]),h=o.useMemo(()=>({preset:l,customStart:g,customEnd:b,range:x,setPreset:C,setCustomStart:A,setCustomEnd:u}),[l,g,b,x,C,A,u]);return e(ni.Provider,{value:h,children:a})};function On(){const a=o.useContext(ni);if(!a)throw new Error("useDateFilterContext must be used within DateFilterProvider");return a}const cn=8;function Xl(a){return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`}const Ql=a=>a.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase();function si(){const{user:a,company:t}=Ke(),i=(a==null?void 0:a.companyId)??"",s=(a==null?void 0:a.agencyId)??"",[n,l]=o.useState([]),[d,g]=o.useState(0),[f,b]=o.useState(0),[I,C]=o.useState(0),[A,u]=o.useState([]),[x,h]=o.useState(!0),L=o.useRef([]);o.useEffect(()=>{if(!i||!s){h(!1);return}const w=[],N=Xl(new Date),R=Ql(new Date);w.push(Ge(Te(he($,`companies/${i}/agences/${s}/shifts`),ae("status","in",["active","paused","closed","validated"]),Tt(100)),Z=>l(Z.docs.map(j=>({id:j.id,...j.data()})))));const H=he($,`companies/${i}/agences/${s}/reservations`),M=he($,`companies/${i}/agences/${s}/boardingClosures`);let K=new Set;w.push(Ge(M,Z=>{K=new Set(Z.docs.map(j=>j.id))})),Ee(he($,`companies/${i}/agences/${s}/weeklyTrips`)).then(Z=>{L.current=Z.docs.map(j=>({id:j.id,...j.data()})).filter(j=>{var k,W;return(((W=(k=j.horaires)==null?void 0:k[R])==null?void 0:W.length)??0)>0})}),w.push(Ge(Te(H,ae("date","==",N),ae("statut","in",[...pr,"valid√©"])),Z=>{const j=Z.docs.map(W=>({id:W.id,...W.data()}));b(j.reduce((W,q)=>W+(q.montant??0),0));const k=[];L.current.forEach(W=>{var q;(((q=W.horaires)==null?void 0:q[R])??[]).forEach(ye=>{const se=`${W.departure}_${W.arrival}_${ye}_${N}`.replace(/\s+/g,"-"),ue=j.filter(T=>T.depart===W.departure&&T.arrivee===W.arrival&&T.heure===ye).reduce((T,ce)=>T+(ce.statutEmbarquement==="embarqu√©"?ce.seatsGo??1:0),0);k.push({key:se,departure:W.departure,arrival:W.arrival,heure:ye,embarked:ue,capacity:50,closed:K.has(se)})})}),u(k)}));const B=(t==null?void 0:t.devise)??"XOF";fr(i,s,B,t==null?void 0:t.nom).then(()=>{qr(i,{agencyId:s}).then(Z=>g(Z.reduce((j,k)=>j+k.currentBalance,0)))});const le=new Date;le.setHours(0,0,0,0);const Q=new Date;return Q.setHours(23,59,59,999),hr(i,{agencyId:s,status:"pending",limitCount:200}).then(Z=>{const j=Z.filter(k=>{var q,ye;const W=((ye=(q=k.createdAt)==null?void 0:q.toDate)==null?void 0:ye.call(q))??new Date;return W>=le&&W<=Q});C(j.reduce((k,W)=>k+W.amount,0))}),h(!1),()=>w.forEach(Z=>Z())},[i,s,t]);const E=o.useMemo(()=>{const w=[];let N=0;const R=n.filter(k=>k.status==="closed"),H=n.filter(k=>k.status==="validated"&&k.lockedComptable&&!k.lockedChef);R.length>0&&w.push({id:`pending-compta-${N++}`,severity:"warning",module:"finances",title:`${R.length} rapport(s) en attente du comptable`,description:"Des sessions cl√¥tur√©es attendent la validation comptable.",link:"/agence/finances"}),H.length>0&&w.push({id:`pending-chef-${N++}`,severity:"critical",module:"finances",title:`${H.length} rapport(s) √† approuver`,description:"Des rapports valid√©s par le comptable attendent votre approbation.",link:"/agence/finances"}),d-f+I!==0&&w.push({id:`cash-variance-${N++}`,severity:"critical",module:"finances",title:"√âcart de caisse d√©tect√©",description:"La caisse pr√©sente un √©cart. V√©rifiez les mouvements financiers.",link:"/agence/finances"});const K=Date.now();n.filter(k=>k.status==="active").length===0&&A.some(k=>!k.closed)&&w.push({id:`no-counter-${N++}`,severity:"critical",module:"dashboard",title:"Aucun guichet actif",description:"Des d√©parts sont ouverts mais aucun guichet n'est en service.",link:"/agence/dashboard"});const le=(t==null?void 0:t.delayThresholdMinutes)??30,Q=A.filter(k=>{if(k.closed)return!1;const[W,q]=k.heure.split(":").map(Number),ye=new Date;return ye.setHours(W||0,q||0,0,0),Date.now()>ye.getTime()+le*6e4});Q.length>0&&w.push({id:`delayed-agg-${N++}`,severity:"warning",module:"operations",title:Q.length===1?"1 d√©part en retard":`${Q.length} d√©parts en retard`,description:Q.length<=3?Q.map(k=>`${k.departure} ‚Üí ${k.arrival} ${k.heure}`).join(" ¬∑ "):`${Q.slice(0,2).map(k=>`${k.departure} ‚Üí ${k.arrival}`).join(", ")} et ${Q.length-2} autre(s)`,link:"/agence/operations"});const Z=A.filter(k=>k.closed?!1:(k.capacity?Math.round(k.embarked/k.capacity*100):0)<30);Z.length>0&&w.push({id:`low-occ-agg-${N++}`,severity:"warning",module:"operations",title:Z.length===1?"1 d√©part avec faible remplissage":`${Z.length} d√©parts avec faible remplissage`,description:Z.length<=3?Z.map(k=>`${k.departure} ‚Üí ${k.arrival} ${k.heure}`).join(" ¬∑ "):`${Z.slice(0,2).map(k=>`${k.departure} ‚Üí ${k.arrival}`).join(", ")} et ${Z.length-2} autre(s)`,link:"/agence/operations"});const j=n.filter(k=>{var q,ye,se,Y;if(k.status!=="active"&&k.status!=="paused")return!1;const W=((ye=(q=k.startTime)==null?void 0:q.toMillis)==null?void 0:ye.call(q))??((Y=(se=k.createdAt)==null?void 0:se.toMillis)==null?void 0:Y.call(se))??K;return K-W>cn*36e5});return j.length>0&&w.push({id:`long-session-agg-${N++}`,severity:"warning",module:"dashboard",title:j.length===1?`1 session ouverte > ${cn}h`:`${j.length} sessions ouvertes > ${cn}h`,description:j.map(k=>k.userName??k.userId).join(", "),link:"/agence/dashboard"}),w},[n,d,f,I,A,t]),m=o.useMemo(()=>{const w={dashboard:[],operations:[],finances:[],team:[],reports:[]};return E.forEach(N=>w[N.module].push(N)),w},[E]),c=o.useMemo(()=>{const w={dashboard:0,operations:0,finances:0,team:0,reports:0};return E.forEach(N=>w[N.module]++),w},[E]);return{alerts:E,totalAlertCount:E.length,alertsByModule:m,badgeByModule:c,loading:x}}const Jl=[{label:"Vue g√©n√©rale",path:"/agence/courrier",end:!0},{label:"Nouvel envoi",path:"/agence/courrier/nouveau"},{label:"Lots",path:"/agence/courrier/lots"},{label:"R√©ception",path:"/agence/courrier/reception"},{label:"Remise",path:"/agence/courrier/remise"},{label:"Rapports courrier",path:"/agence/courrier/rapport"}],Zl=[{label:"Dashboard",icon:ur,path:"/agence/dashboard",end:!0,moduleKey:"dashboard"},{label:"Op√©rations",icon:sr,path:"/agence/operations",moduleKey:"operations"},{label:"Trajets",icon:eo,path:"/agence/trajets",moduleKey:"trajets"},{label:"Finances",icon:Mt,path:"/agence/finances",moduleKey:"finances"},{label:"Tr√©sorerie",icon:_t,path:"/agence/treasury",moduleKey:"treasury"},{label:"√âquipe",icon:Tn,path:"/agence/team",moduleKey:"team"},{label:"Rapports",icon:Bs,path:"/agence/reports",moduleKey:"reports"}],ec=()=>{var M,K,B,le;const{user:a,company:t,logout:i}=Ke(),s=aa(),{pathname:n}=Aa(),l=Lt(t),{alerts:d,totalAlertCount:g,badgeByModule:f}=si(),b=br(),[I,C]=Gr(),A=Array.isArray(a==null?void 0:a.role)?a.role:a!=null&&a.role?[a.role]:[],u=new Set(A),x=Q=>u.has(Q),h=o.useMemo(()=>{const Q=Zl.map(Z=>({label:Z.label,icon:Z.icon,path:Z.path,end:Z.end,badge:f[Z.moduleKey]||void 0}));return(x("chefAgence")||x("admin_compagnie")||x("agentCourrier"))&&Q.push({label:"Courrier",icon:wa,path:"/agence/courrier",end:!1,badge:f.courrier,children:Jl}),Q},[f,A]);Ln(h);const L=x("chefAgence")||x("superviseur")||x("admin_compagnie")||x("agentCourrier");if(x("agentCourrier")&&!n.startsWith("/agence/courrier"))return e(kt,{to:"/agence/courrier",replace:!0});if(!L)return x("chefEmbarquement")?e(kt,{to:"/agence/boarding",replace:!0}):x("agency_fleet_controller")?e(kt,{to:"/agence/fleet",replace:!0}):x("guichetier")?e(kt,{to:"/agence/guichet",replace:!0}):x("agency_accountant")?e(kt,{to:"/agence/comptabilite",replace:!0}):e(kt,{to:"/login",replace:!0});const E=async()=>{try{await i(),s("/login")}catch(Q){console.error(Q)}};t==null||t.subscriptionStatus;const m=t==null?void 0:t.trialEndsAt;m instanceof We?m.toDate():m instanceof Date;const c=(t==null?void 0:t.nom)||"Compagnie",w=(a==null?void 0:a.agencyNom)||(a==null?void 0:a.agencyName)||"Agence",N=(((M=l==null?void 0:l.colors)==null?void 0:M.primary)??"#FF6600").trim(),R=(((K=l==null?void 0:l.colors)==null?void 0:K.secondary)??"#FFFFFF").trim(),H=o.useMemo(()=>I?{"--teliya-primary":Pr(N),"--teliya-secondary":Pr(R)}:{"--teliya-primary":N,"--teliya-secondary":R},[I,N,R]);return e("div",{className:I?"agency-dark":"",style:H,children:e(_n,{sections:h,role:A[0]||"chefAgence",userName:(a==null?void 0:a.displayName)||void 0,userEmail:(a==null?void 0:a.email)||void 0,brandName:c,logoUrl:t==null?void 0:t.logoUrl,primaryColor:(B=l==null?void 0:l.colors)==null?void 0:B.primary,secondaryColor:(le=l==null?void 0:l.colors)==null?void 0:le.secondary,onLogout:E,headerLeft:r("div",{className:"hidden sm:flex items-center gap-2 text-sm min-w-0",children:[e("span",{className:"font-semibold text-gray-900 truncate",children:c}),e("span",{className:"text-gray-300",children:"/"}),e("span",{className:"text-gray-600 truncate",children:w}),e("span",{className:"text-gray-300",children:"/"}),e("span",{className:"text-gray-500",children:"Chef d'agence"})]}),headerRight:r(bt,{children:[e(Kl,{alerts:d,totalCount:g}),e(Pn,{isOnline:b,darkMode:I,onDarkModeToggle:C})]}),mainClassName:"agency-content-transition",banner:null})})},tc=()=>{const{company:a}=Ke();return e(ei,{currency:a==null?void 0:a.devise,children:e(Wl,{children:e(ec,{})})})},Pu=Object.freeze(Object.defineProperty({__proto__:null,default:tc},Symbol.toStringTag,{value:"Module"}));function ac(a){return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`}const rc=a=>a.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase();function nc(){const{user:a,company:t}=Ke(),i=Nt(),s=(a==null?void 0:a.companyId)??"",n=(a==null?void 0:a.agencyId)??"",l=o.useMemo(()=>ac(new Date),[]),d=o.useMemo(()=>rc(new Date),[]),g=On(),{alerts:f}=si(),[b,I]=o.useState(null),[C,A]=o.useState(null),[u,x]=o.useState([]),[h,L]=o.useState([]),[E,m]=o.useState(0),[c,w]=o.useState(0),[N,R]=o.useState(0),[H,M]=o.useState([]),[K,B]=o.useState(new Set),[le,Q]=o.useState(!0);o.useEffect(()=>{if(!s||!n){Q(!1);return}const Y=[];Y.push(Ge(pe($,`companies/${s}/agences/${n}/dailyStats/${l}`),T=>I(T.exists()?T.data():null))),Y.push(Ge(pe($,`companies/${s}/agences/${n}/agencyLiveState/current`),T=>A(T.exists()?T.data():null))),Y.push(Ge(Te(he($,`companies/${s}/agences/${n}/shifts`),ae("status","in",["active","paused","closed","validated"]),Tt(100)),T=>x(T.docs.map(ce=>({id:ce.id,...ce.data()}))))),Y.push(Ge(Te(he($,`companies/${s}/agences/${n}/reservations`),ae("date","==",l),ae("statut","in",[...pr,"valid√©"])),T=>L(T.docs.map(ce=>({id:ce.id,...ce.data()}))))),Y.push(Ge(he($,`companies/${s}/agences/${n}/boardingClosures`),T=>B(new Set(T.docs.map(ce=>ce.id))))),Ee(he($,`companies/${s}/agences/${n}/weeklyTrips`)).then(T=>{M(T.docs.map(ce=>({id:ce.id,...ce.data()})).filter(ce=>{var Ie,Ve;return(((Ve=(Ie=ce.horaires)==null?void 0:Ie[d])==null?void 0:Ve.length)??0)>0}))});const ue=(t==null?void 0:t.devise)??"XOF";return fr(s,n,ue,t==null?void 0:t.nom).then(()=>{qr(s,{agencyId:n}).then(T=>R(T.reduce((ce,Ie)=>ce+Ie.currentBalance,0)))}),Q(!1),()=>Y.forEach(T=>T())},[s,n,l,d,t]),o.useEffect(()=>{if(!s||!n)return;if(g.preset==="today"){m((b==null?void 0:b.totalRevenue)??h.reduce((ue,T)=>ue+(T.montant??0),0)),w((b==null?void 0:b.totalPassengers)??h.reduce((ue,T)=>ue+(T.seatsGo??1),0));return}const Y=he($,`companies/${s}/agences/${n}/reservations`);Ee(Te(Y,ae("createdAt",">=",We.fromDate(g.range.start)),ae("createdAt","<=",We.fromDate(g.range.end)),ae("statut","in",["paye","pay√©"]))).then(ue=>{m(ue.docs.reduce((T,ce)=>T+(ce.data().montant??0),0)),w(ue.size)})},[s,n,g.preset,g.range.start.getTime(),g.range.end.getTime(),b,h]);const Z=o.useMemo(()=>{const Y=[];return H.forEach(ue=>{var T;(((T=ue.horaires)==null?void 0:T[d])??[]).forEach(ce=>{const Ie=`${ue.departure}_${ue.arrival}_${ce}_${l}`.replace(/\s+/g,"-"),Fe=h.filter(te=>te.depart===ue.departure&&te.arrivee===ue.arrival&&te.heure===ce).reduce((te,Ae)=>te+(Ae.statutEmbarquement==="embarqu√©"?Ae.seatsGo??1:0),0);Y.push({key:Ie,departure:ue.departure,arrival:ue.arrival,heure:ce,embarked:Fe,capacity:50,closed:K.has(Ie)})})}),Y},[H,d,l,h,K]),j=Z.length>0?Math.round(Z.reduce((Y,ue)=>Y+ue.embarked,0)/Math.max(1,Z.reduce((Y,ue)=>Y+ue.capacity,0))*100):0,k=Z.filter(Y=>!Y.closed).length,W=o.useMemo(()=>u.filter(Y=>Y.status==="closed"),[u]),q=o.useMemo(()=>u.filter(Y=>Y.status==="validated"&&Y.lockedComptable&&!Y.lockedChef),[u]),ye=o.useMemo(()=>u.filter(Y=>Y.status==="active"||Y.status==="paused").map(Y=>{const ue=h.filter(T=>T.shiftId===Y.id);return{id:Y.id,name:Y.userName??Y.userId,tickets:ue.reduce((T,ce)=>T+(ce.seatsGo??1),0),revenue:ue.reduce((T,ce)=>T+(ce.montant??0),0),status:Y.status}}),[u,h]),se=o.useMemo(()=>f.filter(Y=>Y.module==="dashboard"||Y.module==="finances"||Y.module==="operations").map(Y=>({severity:Y.severity==="critical"?"red":Y.severity==="warning"?"yellow":"green",message:`${Y.title} ‚Äî ${Y.description}`})),[f]);return le?e("div",{className:_.page,children:e("p",{className:_.muted,children:"Chargement du cockpit‚Ä¶"})}):r("div",{className:_.page,children:[r("div",{className:"flex items-start justify-between flex-wrap gap-3",children:[r("div",{children:[e("h1",{className:_.h1,children:"Dashboard"}),e("p",{className:_.muted,children:Je(new Date,"EEEE d MMMM yyyy",{locale:Et})})]}),e(jn,{preset:g.preset,onPresetChange:g.setPreset,customStart:g.customStart,customEnd:g.customEnd,onCustomStartChange:g.setCustomStart,onCustomEndChange:g.setCustomEnd})]}),r("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4",children:[e(dt,{label:"Revenu",value:i(E),icon:Mt,accent:"text-emerald-700",help:"Total des revenus encaiss√©s sur la p√©riode s√©lectionn√©e (billets pay√©s)."}),e(dt,{label:"Billets vendus",value:c,icon:xa,accent:"text-blue-700"}),e(dt,{label:"Taux de remplissage",value:`${j}%`,icon:to,accent:"text-purple-700",help:"Pourcentage moyen de places occup√©es par rapport √† la capacit√© totale des d√©parts du jour."}),e(dt,{label:"Position caisse",value:i(N),icon:_t,accent:"text-indigo-700",help:"Solde actuel de tous les comptes de caisse de l'agence."}),e(dt,{label:"D√©parts restants",value:k,icon:Tr,accent:"text-orange-700"})]}),e(Zt,{title:"Guichets actifs",icon:ao,help:"Vue en temps r√©el de l'activit√© de chaque guichet ouvert. Les donn√©es se mettent √† jour automatiquement.",right:r(xt,{color:"green",children:[ye.length," actif",ye.length>1?"s":""]}),noPad:!0,children:ye.length===0?e(Sa,{message:"Aucun guichet actif en ce moment."}):e("div",{className:_.table.wrapper,children:r("table",{className:_.table.base,children:[e("thead",{className:_.table.head,children:r("tr",{children:[e("th",{className:_.table.th,children:"Guichetier"}),e("th",{className:_.table.thRight,children:"Billets (session)"}),e("th",{className:_.table.thRight,children:"Revenu (session)"}),e("th",{className:_.table.th,children:"Statut"})]})}),e("tbody",{className:_.table.body,children:ye.map(Y=>r("tr",{className:_.table.row,children:[e("td",{className:_.table.td,children:e("span",{className:"font-medium text-gray-900",children:Y.name})}),e("td",{className:_.table.tdRight,children:Y.tickets}),e("td",{className:_.table.tdRight,children:i(Y.revenue)}),e("td",{className:_.table.td,children:Y.status==="active"?e(xt,{color:"green",children:"Actif"}):e(xt,{color:"yellow",children:"En pause"})})]},Y.id))})]})})}),se.length>0&&e(Zt,{title:"Alertes",icon:Ha,children:e("div",{className:"space-y-2",children:se.slice(0,10).map((Y,ue)=>e(Ul,{severity:Y.severity,message:Y.message},ue))})}),e(Zt,{title:"Validations en attente",icon:Gt,noPad:!0,help:"Rapports de session guichet en attente de validation. Le comptable valide en premier, puis le chef d'agence approuve d√©finitivement.",children:W.length===0&&q.length===0?e(Sa,{message:"Aucune validation en attente."}):e("div",{className:_.table.wrapper,children:r("table",{className:_.table.base,children:[e("thead",{className:_.table.head,children:r("tr",{children:[e("th",{className:_.table.th,children:"Guichetier"}),e("th",{className:_.table.th,children:"Statut"}),e("th",{className:_.table.th,children:"D√©but"}),e("th",{className:_.table.thRight,children:"Revenu"})]})}),e("tbody",{className:_.table.body,children:[...W,...q].map(Y=>{var T;const ue=h.filter(ce=>ce.shiftId===Y.id).reduce((ce,Ie)=>ce+(Ie.montant??0),0);return r("tr",{className:_.table.row,children:[e("td",{className:_.table.td,children:Y.userName??Y.userId}),e("td",{className:_.table.td,children:Y.status==="closed"?e(xt,{color:"yellow",children:"En attente compta"}):e(xt,{color:"blue",children:"Valid√© compta ‚Äî √† approuver"})}),e("td",{className:_.table.td,children:r("span",{className:"flex items-center gap-1",children:[e(Or,{className:"w-3.5 h-3.5 text-gray-400"}),(T=Y.startTime)!=null&&T.toMillis?Je(new Date(Y.startTime.toMillis()),"HH:mm"):"‚Äî"]})}),e("td",{className:_.table.tdRight,children:i(ue)})]},Y.id)})})]})})})]})}const Fu=Object.freeze(Object.defineProperty({__proto__:null,default:nc},Symbol.toStringTag,{value:"Module"}));function ar(a){return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`}const sc=a=>a.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase();function ic(a){if(a.closed&&a.embarked===0&&a.booked===0)return"cancelled";if(a.closed)return"departed";const t=a.delayThresholdMinutes??30,i=new Date,[s,n]=a.heure.split(":").map(Number),l=new Date;return l.setHours(s||0,n||0,0,0),i>new Date(l.getTime()+t*6e4)&&!a.closed?"delayed":a.embarked>0?"boarding":"ready"}const oc={boarding:{label:"Embarquement",color:"blue"},ready:{label:"Pr√™t",color:"green"},departed:{label:"Parti",color:"gray"},delayed:{label:"En retard",color:"red"},cancelled:{label:"Annul√©",color:"red"}};function lc(){const{user:a,company:t}=Ke(),i=(t==null?void 0:t.delayThresholdMinutes)??30,s=(a==null?void 0:a.companyId)??"",n=(a==null?void 0:a.agencyId)??"",[l,d]=o.useState(()=>ar(new Date)),[g,f]=o.useState([]),[b,I]=o.useState([]),[C,A]=o.useState(new Set),[u,x]=o.useState({auGarage:0,affectes:0,enRoute:0,enApproche:0}),[h,L]=o.useState([]),[E,m]=o.useState(!0),[c,w]=o.useState(null),[N,R]=o.useState(null),[H,M]=o.useState({tripId:"",driverName:"",driverPhone:"",convoyeurName:"",convoyeurPhone:""}),[K,B]=o.useState(!1),[le,Q]=o.useState(null),[Z,j]=o.useState(null),[k,W]=o.useState("");o.useEffect(()=>{if(!s||!n){m(!1);return}const D=[];return D.push(Ge(Te(he($,`companies/${s}/agences/${n}/reservations`),ae("date","==",l),ae("statut","in",[...pr,"valid√©"])),G=>f(G.docs.map(y=>({id:y.id,...y.data()}))))),D.push(Ge(he($,`companies/${s}/agences/${n}/boardingClosures`),G=>A(new Set(G.docs.map(y=>y.id))))),Ee(he($,`companies/${s}/agences/${n}/weeklyTrips`)).then(G=>{I(G.docs.map(y=>({id:y.id,...y.data()})))}),tr(s,n).then(G=>{L(G.map(y=>({id:y.id,agencyId:n,vehicleId:y.vehicleId,vehiclePlate:y.vehiclePlate??"",vehicleModel:y.vehicleModel??"",status:y.status??"",departureCity:y.departureCity??"",arrivalCity:y.arrivalCity??"",departureTime:y.departureTime,driverName:y.driverName,driverPhone:y.driverPhone,convoyeurName:y.convoyeurName,convoyeurPhone:y.convoyeurPhone})))}).catch(()=>L([])),m(!1),()=>D.forEach(G=>G())},[s,n,l]),o.useEffect(()=>{!s||!n||He(pe($,`companies/${s}/agences/${n}`)).then(D=>{const G=D.exists()?D.data():null,y=((G==null?void 0:G.villeNorm)??(G==null?void 0:G.ville)??"").trim();W(y)}).catch(()=>W(""))},[s,n]);const q=o.useCallback(async()=>{if(!(!s||!n||!k))try{const[D,G]=await Promise.all([wn(s),tr(s,n)]),y=k.trim().toLowerCase(),P=D.filter(ne=>(ne.operationalStatus??Ua.GARAGE)===Ua.GARAGE&&(ne.currentCity??"").trim().toLowerCase()===y&&!ne.isArchived).length,F=G.filter(ne=>ne.status===It.AFFECTE&&(ne.departureCity??"").trim().toLowerCase()===y).length,z=G.filter(ne=>ne.status===It.DEPART_CONFIRME&&(ne.departureCity??"").trim().toLowerCase()===y).length,ee=G.filter(ne=>ne.status===It.DEPART_CONFIRME&&(ne.arrivalCity??"").trim().toLowerCase()===y).length;x({auGarage:P,affectes:F,enRoute:z,enApproche:ee})}catch{x({auGarage:0,affectes:0,enRoute:0,enApproche:0})}},[s,n,k]);o.useEffect(()=>{q()},[q]);const ye=o.useMemo(()=>sc(new Date(l+"T12:00:00")),[l]),se=o.useMemo(()=>b.filter(D=>{var G,y;return(((y=(G=D.horaires)==null?void 0:G[ye])==null?void 0:y.length)??0)>0}),[b,ye]),Y=o.useMemo(()=>{const D=[];return se.forEach(G=>{var y;(((y=G.horaires)==null?void 0:y[ye])??[]).forEach(P=>{var fe,Ce;const F=`${G.departure}_${G.arrival}_${P}_${l}`.replace(/\s+/g,"-"),z=g.filter(Se=>Se.date===l&&Se.depart===G.departure&&Se.arrivee===G.arrival&&Se.heure===P),ee=z.reduce((Se,De)=>Se+(De.seatsGo??1),0),ne=z.reduce((Se,De)=>Se+(De.statutEmbarquement==="embarqu√©"?De.seatsGo??1:0),0),Ne=z.reduce((Se,De)=>Se+(De.statutEmbarquement==="absent"?De.seatsGo??1:0),0),ge=((fe=z.find(Se=>Se.vehiclePlate))==null?void 0:fe.vehiclePlate)??"",p=((Ce=z.find(Se=>Se.driverName))==null?void 0:Ce.driverName)??"",V=C.has(F),re=ic({closed:V,embarked:ne,booked:ee,heure:P,delayThresholdMinutes:i});D.push({key:F,departure:G.departure,arrival:G.arrival,heure:P,booked:ee,embarked:ne,absent:Ne,capacity:50,closed:V,vehicle:ge,driver:p,status:re})})}),D.sort((G,y)=>G.heure.localeCompare(y.heure))},[se,ye,l,g,C]),ue=o.useMemo(()=>{const D=new Set;for(const G of h){if(G.status!==It.DEPART_CONFIRME)continue;const y=G.departureTime;let P="",F="";if(typeof y=="string")P=y.slice(0,10),F=(y.slice(11,16)||y.slice(11,13)+":00").trim();else if(y&&typeof y=="object"&&"seconds"in y){const ee=new Date(y.seconds*1e3);P=ar(ee),F=Je(ee,"HH:mm")}if(P!==l)continue;const z=`${(G.departureCity||"").trim()}_${(G.arrivalCity||"").trim()}_${F}_${l}`.replace(/\s+/g,"-");D.add(z)}return D},[h,l]),T=o.useMemo(()=>Y.filter(D=>!ue.has(D.key)),[Y,ue]),ce=o.useMemo(()=>{const D={};for(const G of T)for(const y of h){if(y.status!==It.AFFECTE&&y.status!==It.DEPART_CONFIRME||(y.departureCity||"").trim().toLowerCase()!==(G.departure||"").trim().toLowerCase()||(y.arrivalCity||"").trim().toLowerCase()!==(G.arrival||"").trim().toLowerCase())continue;const P=y.departureTime;let F="",z="";if(typeof P=="string")F=P.slice(0,10),z=(P.slice(11,16)||P.slice(11,13)+":00").trim();else if(P&&typeof P=="object"&&"seconds"in P){const ne=new Date(P.seconds*1e3);F=ar(ne),z=Je(ne,"HH:mm")}const ee=(G.heure||"").trim();if(F===l&&(z===ee||!ee||!z)){D[G.key]=y;break}}return D},[h,T,l]),[Ie,Ve]=o.useState([]),[Fe,te]=o.useState(!1),Ae=o.useCallback(async()=>{if(!(!s||!k)){te(!0);try{const D=await wn(s),G=new Set(h.filter(F=>F.status===It.AFFECTE||F.status===It.DEPART_CONFIRME).map(F=>F.vehicleId)),y=k.trim().toLowerCase(),P=D.filter(F=>{const z=F.operationalStatus??Ua.GARAGE,ee=F.technicalStatus??Lr.NORMAL,ne=(F.currentCity??"").trim().toLowerCase()===y;return z===Ua.GARAGE&&ee===Lr.NORMAL&&ne&&!G.has(F.id)});Ve(P.map(F=>({id:F.id,plateNumber:F.plateNumber??"",model:F.model??""})))}catch{Ve([])}finally{te(!1)}}},[s,k,h]);o.useEffect(()=>{c&&Ae()},[c,Ae]);const ke=o.useCallback(async D=>{if(D.preventDefault(),!(!s||!n||!c||!N||!k)){B(!0),j(null);try{const G=`${c.departure.replace(/\s+/g,"-")}_${c.arrival.replace(/\s+/g,"-")}_${c.heure}_${l}`;await Ks(s,n,N,k,{tripId:H.tripId.trim()||G,departureCity:c.departure,arrivalCity:c.arrival,departureTime:new Date(`${l}T${c.heure}:00`).toISOString().slice(0,16),driverName:H.driverName.trim()||void 0,driverPhone:H.driverPhone.trim()||void 0,convoyeurName:H.convoyeurName.trim()||void 0,convoyeurPhone:H.convoyeurPhone.trim()||void 0,assignedBy:(a==null?void 0:a.uid)??""},(a==null?void 0:a.uid)??"",(a==null?void 0:a.role)??"chefAgence"),w(null),R(null),M({tripId:"",driverName:"",driverPhone:"",convoyeurName:"",convoyeurPhone:""}),tr(s,n).then(y=>{L(y.map(P=>({id:P.id,agencyId:n,vehicleId:P.vehicleId,vehiclePlate:P.vehiclePlate??"",vehicleModel:P.vehicleModel??"",status:P.status??"",departureCity:P.departureCity??"",arrivalCity:P.arrivalCity??"",departureTime:P.departureTime,driverName:P.driverName,driverPhone:P.driverPhone,convoyeurName:P.convoyeurName,convoyeurPhone:P.convoyeurPhone})))}),await q()}catch(G){j(G instanceof Error?G.message:"Erreur affectation.")}finally{B(!1)}}},[s,n,k,c,N,H,l,a,q]),Pe=o.useCallback(async(D,G,y)=>{if(!(!s||!(a!=null&&a.uid))){Q(y),j(null);try{await Ys(s,G,D,a.uid,a.role??"chefAgence"),tr(s,n).then(P=>{L(P.map(F=>({id:F.id,agencyId:n,vehicleId:F.vehicleId,vehiclePlate:F.vehiclePlate??"",vehicleModel:F.vehicleModel??"",status:F.status??"",departureCity:F.departureCity??"",arrivalCity:F.arrivalCity??"",departureTime:F.departureTime,driverName:F.driverName,driverPhone:F.driverPhone,convoyeurName:F.convoyeurName,convoyeurPhone:F.convoyeurPhone})))}),await q()}catch(P){j(P instanceof Error?P.message:"Erreur confirmation d√©part.")}finally{Q(null)}}},[s,n,a,q]),je=o.useCallback(async(D,G,y)=>{if(!(!s||!(a!=null&&a.uid))){Q(y),j(null);try{await Eo(s,G,D,a.uid,a.role??"chefAgence"),tr(s,n).then(P=>{L(P.map(F=>({id:F.id,agencyId:n,vehicleId:F.vehicleId,vehiclePlate:F.vehiclePlate??"",vehicleModel:F.vehicleModel??"",status:F.status??"",departureCity:F.departureCity??"",arrivalCity:F.arrivalCity??"",departureTime:F.departureTime,driverName:F.driverName,driverPhone:F.driverPhone,convoyeurName:F.convoyeurName,convoyeurPhone:F.convoyeurPhone})))}),await q()}catch(P){j(P instanceof Error?P.message:"Erreur annulation.")}finally{Q(null)}}},[s,n,a,q]);return E?e("div",{className:_.page,children:e("p",{className:_.muted,children:"Chargement‚Ä¶"})}):r("div",{className:_.page,children:[r("div",{children:[e("h1",{className:_.h1,children:"Op√©rations"}),r("p",{className:_.muted,children:[Je(new Date,"EEEE d MMMM yyyy",{locale:Et})," ‚Äî Vue lecture seule"]})]}),r("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e(dt,{label:"Au garage",value:u.auGarage,icon:ea}),e(dt,{label:"Affect√©s",value:u.affectes,icon:Tr}),e(dt,{label:"En route",value:u.enRoute,icon:Ca}),e(dt,{label:"En approche",value:u.enApproche,icon:Tr})]}),r(Zt,{title:"D√©parts du jour",icon:Tr,noPad:!0,children:[r("div",{className:"flex flex-wrap items-center gap-2 p-4 border-b border-slate-200",children:[e("span",{className:"text-sm text-slate-600",children:"Date :"}),e("button",{type:"button",onClick:()=>d(ar(new Date)),className:"text-sm px-3 py-1.5 rounded border border-slate-300 hover:bg-slate-50 text-slate-700",children:"Aujourd'hui"}),e("button",{type:"button",onClick:()=>d(ar(xi(new Date,1))),className:"text-sm px-3 py-1.5 rounded border border-slate-300 hover:bg-slate-50 text-slate-700",children:"Demain"}),e("input",{type:"date",value:l,onChange:D=>d(D.target.value||l),className:"text-sm border border-slate-300 rounded px-2 py-1.5 text-slate-700"}),e("span",{className:"text-sm text-slate-500",children:Je(new Date(l+"T12:00:00"),"EEEE d MMMM yyyy",{locale:Et})})]}),T.length===0?e(Sa,{message:"Aucun d√©part planifi√© pour cette date."}):e("div",{className:_.table.wrapper,children:r("table",{className:_.table.base,children:[e("thead",{className:_.table.head,children:r("tr",{children:[e("th",{className:_.table.th,children:"Itin√©raire"}),e("th",{className:_.table.th,children:"Heure"}),e("th",{className:_.table.thRight,children:"R√©serv√©s"}),e("th",{className:_.table.thRight,children:"Embarqu√©s"}),e("th",{className:_.table.thRight,children:"Absents"}),e("th",{className:_.table.thRight,children:"Remplissage"}),e("th",{className:_.table.th,children:"Statut"}),e("th",{className:_.table.th,children:"V√©hicule"}),e("th",{className:_.table.th,children:"Chauffeur"}),e("th",{className:_.table.th,children:"Affectation"})]})}),e("tbody",{className:_.table.body,children:T.map(D=>{const G=D.capacity?Math.round(D.embarked/D.capacity*100):0,y=oc[D.status],P=ce[D.key],F=P?`${P.vehiclePlate||"‚Äî"} / ${P.vehicleModel||"‚Äî"}`:D.vehicle||"‚Äî",z=P?P.driverName||"‚Äî":D.driver||"‚Äî",ee=le===D.key;return r("tr",{className:_.table.row,children:[r("td",{className:_.table.td,children:[D.departure," ‚Üí ",D.arrival]}),e("td",{className:_.table.td,children:D.heure}),e("td",{className:_.table.tdRight,children:D.booked}),e("td",{className:_.table.tdRight,children:D.embarked}),e("td",{className:_.table.tdRight,children:D.absent}),e("td",{className:_.table.tdRight,children:r("span",{className:G<30?"text-red-600 font-medium":G<70?"text-amber-600":"text-emerald-600 font-medium",children:[G,"%"]})}),e("td",{className:_.table.td,children:e(xt,{color:y.color,children:y.label})}),e("td",{className:_.table.td,children:F}),e("td",{className:_.table.td,children:z}),e("td",{className:_.table.td,children:P?P.status===It.AFFECTE?r("div",{className:"flex flex-wrap gap-1 items-center",children:[r("span",{className:"text-xs text-slate-600",children:[P.vehiclePlate," / ",P.vehicleModel]}),e("button",{type:"button",onClick:()=>Pe(P.id,P.agencyId,D.key),disabled:ee,className:"text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-800 hover:bg-blue-200 disabled:opacity-50",children:ee?"‚Ä¶":"Confirmer d√©part"}),e("a",{href:"/agence/fleet/operations",className:"text-xs px-2 py-0.5 rounded border border-slate-300 hover:bg-slate-50 text-slate-700",children:"Modifier affectation"}),e("button",{type:"button",onClick:()=>je(P.id,P.agencyId,D.key),disabled:ee,className:"text-xs px-2 py-0.5 rounded bg-red-50 text-red-700 hover:bg-red-100 disabled:opacity-50",children:"Annuler affectation"})]}):P.status===It.DEPART_CONFIRME?r("span",{className:"text-xs text-slate-600",children:[P.vehiclePlate," / ",P.vehicleModel," ‚Äî En transit"]}):null:e("button",{type:"button",onClick:()=>w({key:D.key,departure:D.departure,arrival:D.arrival,heure:D.heure}),className:"text-sm px-2 py-1 rounded border border-slate-300 hover:bg-slate-50 text-slate-700",children:"Affecter un v√©hicule"})})]},D.key)})})]})})]}),Z&&e("div",{className:"mt-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm",children:Z}),c&&e("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:r("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] flex flex-col",children:[r("div",{className:"flex items-center justify-between p-4 border-b",children:[e("h3",{className:"text-lg font-semibold",children:"Affecter un v√©hicule"}),e("button",{type:"button",onClick:()=>{w(null),R(null),M({tripId:"",driverName:"",driverPhone:"",convoyeurName:"",convoyeurPhone:""})},className:"p-1 rounded hover:bg-gray-100",children:e(Ia,{className:"w-5 h-5"})})]}),r("p",{className:"px-4 py-2 text-sm text-gray-600",children:[c.departure," ‚Üí ",c.arrival," ‚Ä¢ ",c.heure]}),r("form",{onSubmit:ke,className:"flex flex-col flex-1 min-h-0 overflow-hidden",children:[r("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"V√©hicule"}),Fe?r("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e(rt,{className:"w-4 h-4 animate-spin"})," Chargement‚Ä¶"]}):r("select",{value:N??"",onChange:D=>R(D.target.value||null),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",required:!0,children:[e("option",{value:"",children:"‚Äî Choisir ‚Äî"}),Ie.map(D=>r("option",{value:D.id,children:[D.plateNumber," ‚Äî ",D.model]},D.id))]})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Chauffeur (optionnel)"}),e("input",{type:"text",value:H.driverName,onChange:D=>M(G=>({...G,driverName:D.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",placeholder:"Nom"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"T√©l. chauffeur"}),e("input",{type:"text",value:H.driverPhone,onChange:D=>M(G=>({...G,driverPhone:D.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",placeholder:"T√©l√©phone"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Convoyeur (optionnel)"}),e("input",{type:"text",value:H.convoyeurName,onChange:D=>M(G=>({...G,convoyeurName:D.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",placeholder:"Nom"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"T√©l. convoyeur"}),e("input",{type:"text",value:H.convoyeurPhone,onChange:D=>M(G=>({...G,convoyeurPhone:D.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",placeholder:"T√©l√©phone"})]})]}),r("div",{className:"flex gap-2 p-4 border-t",children:[e("button",{type:"button",onClick:()=>{w(null),R(null)},className:"flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 text-sm font-medium hover:bg-gray-50",children:"Annuler"}),e("button",{type:"submit",disabled:K||!N,className:"flex-1 px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700 disabled:opacity-50",children:K?"‚Ä¶":"Affecter"})]})]})]})})]})}const ju=Object.freeze(Object.defineProperty({__proto__:null,default:lc},Symbol.toStringTag,{value:"Module"}));async function cc(a){const t=pe($,"companies",a.companyId,"agences",a.agencyId,"shifts",a.shiftId);await Ut($,async i=>{var l;const s=await i.get(t);if(!s.exists())throw new Error("Session introuvable");const n=s.data();if(!n.lockedComptable||!((l=n.comptable)!=null&&l.validated))throw new Error("En attente de la validation comptable.");if(n.lockedChef)throw new Error("D√©j√† approuv√©e par le chef d'agence");if(n.status!=="validated")throw new Error("Le poste doit √™tre valid√© par la comptabilit√©.");i.update(t,{chef:{validated:!0,at:Re(),by:{id:a.userId,name:a.userName},note:a.note??null},lockedChef:!0,updatedAt:Re()})})}function dc(){const{user:a,company:t}=Ke(),i=Nt(),s=(a==null?void 0:a.companyId)??"",n=(a==null?void 0:a.agencyId)??"",l=On(),[d,g]=o.useState(0),[f,b]=o.useState(0),[I,C]=o.useState(0),[A,u]=o.useState(0),[x,h]=o.useState(0),[L,E]=o.useState(0),[m,c]=o.useState([]),[w,N]=o.useState([]),[R,H]=o.useState(null),[M,K]=o.useState(!0);o.useEffect(()=>{if(!s||!n){K(!1);return}const k=[],W=(t==null?void 0:t.devise)??"XOF";return fr(s,n,W,t==null?void 0:t.nom).then(()=>{qr(s,{agencyId:n}).then(q=>C(q.reduce((ye,se)=>ye+se.currentBalance,0)))}),k.push(Ge(Te(he($,`companies/${s}/financialMovements`),ae("agencyId","==",n),Rt("performedAt","desc"),Tt(20)),q=>c(q.docs.map(ye=>({id:ye.id,...ye.data()}))))),k.push(Ge(Te(he($,`companies/${s}/agences/${n}/shifts`),ae("status","in",["closed","validated"]),Tt(100)),q=>N(q.docs.map(ye=>({id:ye.id,...ye.data()}))))),K(!1),()=>k.forEach(q=>q())},[s,n,t]),o.useEffect(()=>{if(!s||!n)return;const{start:k,end:W}=l.range,q=he($,`companies/${s}/agences/${n}/reservations`);Ee(Te(q,ae("createdAt",">=",We.fromDate(k)),ae("createdAt","<=",We.fromDate(W)),ae("statut","in",["paye","pay√©"]))).then(ye=>{g(ye.docs.reduce((se,Y)=>se+(Y.data().montant??0),0)),b(ye.size)}),hr(s,{agencyId:n,status:"pending",limitCount:200}).then(ye=>{const se=ye.filter(Y=>{var T,ce;const ue=((ce=(T=Y.createdAt)==null?void 0:T.toDate)==null?void 0:ce.call(T))??new Date;return ue>=k&&ue<=W});u(se.reduce((Y,ue)=>Y+ue.amount,0))})},[s,n,l.range.start.getTime(),l.range.end.getTime()]),o.useEffect(()=>{if(!s||!n)return;const k=new Date,W=new Date(k);W.setHours(0,0,0,0);const q=new Date(k);q.setHours(23,59,59,999);const ye=he($,`companies/${s}/agences/${n}/reservations`);Ee(Te(ye,ae("createdAt",">=",We.fromDate(W)),ae("createdAt","<=",We.fromDate(q)),ae("statut","in",["paye","pay√©"]))).then(se=>h(se.docs.reduce((Y,ue)=>Y+(ue.data().montant??0),0))),hr(s,{agencyId:n,status:"pending",limitCount:200}).then(se=>{const Y=se.filter(ue=>{var ce,Ie;const T=((Ie=(ce=ue.createdAt)==null?void 0:ce.toDate)==null?void 0:Ie.call(ce))??new Date;return T>=W&&T<=q});E(Y.reduce((ue,T)=>ue+T.amount,0))})},[s,n]);const B=I-x+L,le=B!==0,Q=o.useMemo(()=>w.filter(k=>k.status==="validated"&&k.lockedComptable&&!k.lockedChef),[w]),Z=o.useMemo(()=>w.filter(k=>k.status==="closed"),[w]),j=async k=>{H(k);try{await cc({companyId:s,agencyId:n,shiftId:k,userId:(a==null?void 0:a.uid)??"",userName:(a==null?void 0:a.displayName)??""})}catch(W){alert((W==null?void 0:W.message)??"Erreur lors de la validation")}finally{H(null)}};return M?e("div",{className:_.page,children:e("p",{className:_.muted,children:"Chargement‚Ä¶"})}):r("div",{className:_.page,children:[r("div",{className:"flex items-start justify-between flex-wrap gap-3",children:[r("div",{children:[e("h1",{className:_.h1,children:"Finances"}),e("p",{className:_.muted,children:Je(new Date,"EEEE d MMMM yyyy",{locale:Et})})]}),e(jn,{preset:l.preset,onPresetChange:l.setPreset,customStart:l.customStart,customEnd:l.customEnd,onCustomStartChange:l.setCustomStart,onCustomEndChange:l.setCustomEnd})]}),r("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4",children:[e(dt,{label:"Revenu",value:i(d),icon:Mt,accent:"text-emerald-700",help:"Total des paiements encaiss√©s sur la p√©riode s√©lectionn√©e."}),e(dt,{label:"Billets",value:f,icon:Mt,accent:"text-blue-700"}),e(dt,{label:"D√©penses",value:i(A),icon:ro,accent:"text-red-700",help:"Total des d√©penses enregistr√©es sur la p√©riode s√©lectionn√©e."}),e(dt,{label:"Position caisse",value:i(I),icon:_t,accent:"text-indigo-700",help:"Solde actuel de tous les comptes de caisse de l'agence. Ind√©pendant de la p√©riode."}),e(dt,{label:"√âcart caisse",value:i(Math.abs(B)),icon:vn,accent:le?"text-red-700":"text-emerald-700",critical:le,help:"Diff√©rence entre la position caisse attendue et la position r√©elle. Un √©cart nul signifie que la caisse est √©quilibr√©e."})]}),e(Zt,{title:"Rapports √† valider",icon:Gt,noPad:!0,help:"Rapports de session cl√¥tur√©s par les guichetiers. Flux : Guichetier cl√¥ture ‚Üí Comptable valide ‚Üí Chef d'agence approuve.",children:Q.length===0&&Z.length===0?e(Sa,{message:"Aucun rapport en attente de validation."}):e("div",{className:_.table.wrapper,children:r("table",{className:_.table.base,children:[e("thead",{className:_.table.head,children:r("tr",{children:[e("th",{className:_.table.th,children:"Guichetier"}),e("th",{className:_.table.th,children:"D√©but"}),e("th",{className:_.table.th,children:"Fin"}),e("th",{className:_.table.th,children:"Statut"}),e("th",{className:_.table.thRight,children:"Action"})]})}),r("tbody",{className:_.table.body,children:[Z.map(k=>{var W,q;return r("tr",{className:_.table.row,children:[e("td",{className:_.table.td,children:k.userName??k.userId}),e("td",{className:_.table.td,children:(W=k.startTime)!=null&&W.toDate?Je(k.startTime.toDate(),"HH:mm",{locale:Et}):"‚Äî"}),e("td",{className:_.table.td,children:(q=k.endTime)!=null&&q.toDate?Je(k.endTime.toDate(),"HH:mm",{locale:Et}):"‚Äî"}),e("td",{className:_.table.td,children:e(xt,{color:"yellow",children:"En attente du comptable"})}),e("td",{className:_.table.tdRight,children:e("span",{className:_.muted,children:"En attente"})})]},k.id)}),Q.map(k=>{var W,q;return r("tr",{className:_.table.row,children:[e("td",{className:_.table.td,children:k.userName??k.userId}),e("td",{className:_.table.td,children:(W=k.startTime)!=null&&W.toDate?Je(k.startTime.toDate(),"HH:mm",{locale:Et}):"‚Äî"}),e("td",{className:_.table.td,children:(q=k.endTime)!=null&&q.toDate?Je(k.endTime.toDate(),"HH:mm",{locale:Et}):"‚Äî"}),e("td",{className:_.table.td,children:e(xt,{color:"blue",children:"Valid√© compta ‚Äî √† approuver"})}),e("td",{className:_.table.tdRight,children:r("button",{disabled:R===k.id,onClick:()=>j(k.id),className:_.btnPrimary,children:[R===k.id?e(rt,{className:"w-4 h-4 animate-spin"}):e(Gt,{className:"w-4 h-4"}),"Approuver"]})})]},k.id)})]})]})})}),e(Zt,{title:"Derniers mouvements",icon:vn,noPad:!0,children:m.length===0?e(Sa,{message:"Aucun mouvement r√©cent."}):e("div",{className:_.table.wrapper,children:r("table",{className:_.table.base,children:[e("thead",{className:_.table.head,children:r("tr",{children:[e("th",{className:_.table.th,children:"Type"}),e("th",{className:_.table.th,children:"Description"}),e("th",{className:_.table.thRight,children:"Montant"})]})}),e("tbody",{className:_.table.body,children:m.map(k=>r("tr",{className:_.table.row,children:[e("td",{className:_.table.td,children:e(xt,{color:k.movementType==="credit"?"green":"red",children:k.movementType==="credit"?"Cr√©dit":"D√©bit"})}),e("td",{className:_.table.td,children:k.description||"‚Äî"}),e("td",{className:_.table.tdRight,children:i(k.amount)})]},k.id))})]})})})]})}const Ou=Object.freeze(Object.defineProperty({__proto__:null,default:dc},Symbol.toStringTag,{value:"Module"})),uc={chefAgence:"Chef d'agence",superviseur:"Superviseur",guichetier:"Guichetier",controleur:"Contr√¥leur",agency_accountant:"Comptable",chefEmbarquement:"Chef embarquement",agentCourrier:"Agent courrier"},cs=[{value:"guichetier",label:"Guichetier"},{value:"controleur",label:"Contr√¥leur"},{value:"agency_accountant",label:"Comptable"},{value:"chefAgence",label:"Chef d'agence"},{value:"chefEmbarquement",label:"Chef embarquement"},{value:"agentCourrier",label:"Agent courrier"}];async function mc(a,t,i){if(!["guichetier","agency_accountant"].includes(i))return;const s=pe($,"companies",a,"agences",t,"counters",i);try{const n=await He(s);let l=1;return n.exists()&&(l=(n.data().lastSeq||0)+1),await jt(s,{lastSeq:l,updatedAt:We.now()},{merge:!0}),i==="guichetier"?`G${String(l).padStart(3,"0")}`:i==="agency_accountant"?`ACC${String(l).padStart(3,"0")}`:void 0}catch{return}}async function ds(a,t){return!(await Ee(Te(he($,"users"),ae("companyId","==",a),ae("agencyId","==",t),ae("role","==","agency_accountant"),Tt(1)))).empty}async function hc(a,t){const i=await Ee(Te(he($,"users"),ae("companyId","==",a),ae("agencyId","==",t)));for(const s of i.docs){const n=s.data();n.role!=="admin_platforme"&&await jt(pe($,"companies",a,"agences",t,"users",s.id),{...n,uid:s.id,displayName:n.displayName||"Nom inconnu",email:n.email||"",role:n.role||"guichetier",active:n.active!==!1,companyId:a,agencyId:t,createdAt:n.createdAt||We.now()},{merge:!0})}}function pc(){const{user:a}=Ke(),t=(a==null?void 0:a.companyId)??"",i=(a==null?void 0:a.agencyId)??"",[s,n]=o.useState([]),[l,d]=o.useState(!0),[g,f]=o.useState(null),[b,I]=o.useState(!1),[C,A]=o.useState(null),[u,x]=o.useState(!1),[h,L]=o.useState(""),[E,m]=o.useState(""),[c,w]=o.useState(""),[N,R]=o.useState("guichetier"),[H,M]=o.useState(""),[K,B]=o.useState(null),[le,Q]=o.useState(""),[Z,j]=o.useState(""),[k,W]=o.useState("guichetier"),[q,ye]=o.useState(null),se=(a==null?void 0:a.role)==="chefAgence",Y=o.useMemo(()=>se?cs.filter(D=>D.value!=="chefAgence"):cs,[se]),ue=async()=>{if(!(!t||!i)){d(!0);try{const D=he($,"companies",t,"agences",i,"users");let G=await Ee(D);G.empty&&(a==null?void 0:a.role)==="chefAgence"&&(await hc(t,i),G=await Ee(D));const y=G.docs.map(P=>{const F=P.data();return{id:P.id,uid:F.uid||P.id,displayName:F.displayName||"Nom inconnu",email:F.email||"",telephone:F.telephone||"",role:F.role||"guichetier",active:F.active!==!1,staffCode:F.staffCode||F.codeCourt||"",invitationPending:F.invitationPending||!1,invitationToken:F.invitationToken||""}}).filter(P=>P.displayName).sort((P,F)=>P.displayName.localeCompare(F.displayName));for(const P of y)if(P.role==="agentCourrier"&&!P.staffCode&&P.uid)try{const F=await Jn({companyId:t,agencyId:i}),z=pe($,"companies",t,"agences",i,"users",P.id);await gt(z,{staffCode:F,codeCourt:F});const ee=pe($,"users",P.uid);(await He(ee)).exists()&&await gt(ee,{staffCode:F,codeCourt:F}),P.staffCode=F}catch(F){console.error("allocateCourierAgentCode backfill:",F)}n(y)}catch(D){console.error("loadAgents error:",D)}finally{d(!1)}}};o.useEffect(()=>{ue()},[t,i]);const T=(D,G)=>{A({type:D,text:G}),setTimeout(()=>A(null),6e3)},ce=async()=>{if(!t||!i)return T("error","Contexte agence manquant.");if(!h.trim()||!E.trim())return T("warn","Nom et email sont obligatoires.");f("add");try{if(N==="agency_accountant"&&await ds(t,i))return f(null),T("warn","Un comptable existe d√©j√† pour cette agence.");const D=await Pl({email:E.trim().toLowerCase(),role:N,companyId:t,agencyId:i,fullName:h.trim(),...c.trim()?{phone:c.trim()}:{},createdBy:a==null?void 0:a.uid});await jt(pe($,"companies",t,"agences",i,"users",D.inviteId),{displayName:h.trim(),email:E.trim().toLowerCase(),telephone:c.trim()||"",role:N,active:!1,invitationPending:!0,invitationToken:D.token,companyId:t,agencyId:i,createdAt:We.now()}),M(D.activationUrl),T("success","Invitation envoy√©e avec succ√®s."),L(""),m(""),w(""),R("guichetier"),ue()}catch(D){T("error",(D==null?void 0:D.code)==="already-exists"?"Une invitation en attente existe d√©j√† pour cet email.":(D==null?void 0:D.message)??"Erreur lors de la cr√©ation.")}finally{f(null)}},Ie=async(D,G)=>{f(D.id);try{const y=pe($,"companies",t,"agences",i,"users",D.id);if(await gt(y,{active:G}),D.uid){const P=pe($,"users",D.uid);(await He(P)).exists()&&await gt(P,{active:G})}n(P=>P.map(F=>F.id===D.id?{...F,active:G}:F)),T("success",`${D.displayName} ${G?"activ√©":"d√©sactiv√©"}.`)}catch{T("error","Erreur lors du changement de statut.")}finally{f(null)}},Ve=D=>{B(D.id),Q(D.displayName),j(D.telephone||""),W(D.role)},Fe=()=>B(null),te=async()=>{if(K){f(K);try{if(k==="agency_accountant"){const y=s.find(P=>P.id===K);if(y&&y.role!=="agency_accountant"&&await ds(t,i))return f(null),T("warn","Un comptable existe d√©j√†.")}const D=pe($,"companies",t,"agences",i,"users",K);await gt(D,{displayName:le,telephone:Z,role:k});const G=s.find(y=>y.id===K);if(G!=null&&G.uid){const y=pe($,"users",G.uid),P=await He(y);if(P.exists()&&await gt(y,{displayName:le,telephone:Z,role:k}),(k==="guichetier"||k==="agency_accountant")&&!G.staffCode){const F=await mc(t,i,k);F&&(await gt(D,{staffCode:F,codeCourt:F}),P.exists()&&await gt(pe($,"users",G.uid),{staffCode:F,codeCourt:F}))}if(k==="agentCourrier"&&!G.staffCode){const F=await Jn({companyId:t,agencyId:i});await gt(D,{staffCode:F,codeCourt:F}),P.exists()&&await gt(pe($,"users",G.uid),{staffCode:F,codeCourt:F})}}n(y=>y.map(P=>P.id===K?{...P,displayName:le,telephone:Z,role:k}:P)),B(null),T("success","Agent modifi√©.")}catch{T("error","Erreur lors de la modification.")}finally{f(null)}}},Ae=async()=>{const D=q;if(!(D!=null&&D.email)){ye(null);return}ye(null),f(D.id);try{const G=Os();await Hi(G,D.email),T("success",`Email de r√©initialisation envoy√© √† ${D.email}.`)}catch{T("error","Impossible d'envoyer l'email de r√©initialisation.")}finally{f(null)}},ke=async D=>{if(!D.invitationToken)return T("warn","Pas de token d'invitation trouv√©.");const G=`${window.location.origin}/accept-invitation/${D.invitationToken}`;try{await navigator.clipboard.writeText(G),T("success",`Lien d'invitation copi√© pour ${D.displayName}.`)}catch{M(G),T("success","Lien d'invitation r√©g√©n√©r√©. Copiez-le ci-dessus.")}},Pe=()=>{navigator.clipboard.writeText(H),x(!0),setTimeout(()=>x(!1),2e3)},je=o.useMemo(()=>{const D=s.length,G=s.filter(y=>y.active).length;return{total:D,active:G,inactive:D-G}},[s]);return l?e("div",{className:_.page,children:e("p",{className:_.muted,children:"Chargement de l'√©quipe‚Ä¶"})}):r("div",{className:_.page,children:[r("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[e("h1",{className:_.h1,children:"√âquipe"}),e("button",{onClick:()=>{I(!b),M("")},className:b?_.btnSecondary:_.btnPrimary,children:b?r(bt,{children:[e(Ia,{className:"w-4 h-4"})," Fermer"]}):r(bt,{children:[e(ir,{className:"w-4 h-4"})," Ajouter un agent"]})})]}),C&&e("div",{className:`px-4 py-3 rounded-lg text-sm font-medium ${C.type==="success"?"bg-emerald-50 text-emerald-800":C.type==="error"?"bg-red-50 text-red-800":"bg-amber-50 text-amber-800"}`,children:C.text}),b&&r(Zt,{title:"Nouvel agent",icon:ir,children:[r("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[r("div",{children:[e("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Nom complet *"}),e("input",{value:h,onChange:D=>L(D.target.value),placeholder:"Pr√©nom Nom",className:_.input+" w-full"})]}),r("div",{children:[e("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Email *"}),e("input",{value:E,onChange:D=>m(D.target.value),type:"email",placeholder:"email@exemple.com",className:_.input+" w-full"})]}),r("div",{children:[e("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"T√©l√©phone"}),e("input",{value:c,onChange:D=>w(D.target.value),placeholder:"Optionnel",className:_.input+" w-full"})]}),r("div",{children:[r("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:["R√¥le ",e(Fn,{text:"Le r√¥le d√©termine les permissions de l'agent dans l'application. Le guichetier vend les billets, le comptable valide les rapports, etc."})]}),e("select",{value:N,onChange:D=>R(D.target.value),className:_.input+" w-full",children:Y.map(D=>e("option",{value:D.value,children:D.label},D.value))}),se&&e("p",{className:"text-xs text-gray-400 col-span-full",children:"Seuls les administrateurs de la compagnie peuvent attribuer le r√¥le Chef d'agence."})]})]}),e("div",{className:"mt-4 flex items-center gap-3",children:r("button",{onClick:ce,disabled:g==="add",className:_.btnPrimary,children:[g==="add"?e(rt,{className:"w-4 h-4 animate-spin"}):e(ir,{className:"w-4 h-4"}),"Envoyer l'invitation"]})}),H&&r("div",{className:"mt-3 p-3 rounded-lg bg-gray-50 border border-gray-200",children:[e("p",{className:"text-xs text-gray-500 mb-1",children:"Lien d'activation :"}),r("div",{className:"flex items-center gap-2",children:[e("code",{className:"text-xs text-gray-700 flex-1 truncate",children:H}),e("button",{onClick:Pe,className:"p-1.5 rounded-lg hover:bg-gray-200 transition",title:"Copier",children:u?e(no,{className:"w-4 h-4 text-emerald-600"}):e(so,{className:"w-4 h-4 text-gray-500"})})]})]})]}),r("div",{className:"grid grid-cols-3 gap-4",children:[e(dt,{label:"Total",value:je.total}),e(dt,{label:"Actifs",value:je.active,accent:"text-emerald-700"}),e(dt,{label:"Inactifs",value:je.inactive,accent:"text-red-700"})]}),e(Zt,{title:"Personnel",icon:Tn,noPad:!0,children:s.length===0?e(Sa,{message:"Aucun membre dans l'√©quipe."}):e("div",{className:_.table.wrapper,children:r("table",{className:_.table.base,children:[e("thead",{className:_.table.head,children:r("tr",{children:[e("th",{className:_.table.th,children:"Nom"}),e("th",{className:_.table.th,children:"R√¥le"}),e("th",{className:_.table.th,children:"Code"}),e("th",{className:_.table.th,children:"Contact"}),e("th",{className:_.table.th,children:"Statut"}),e("th",{className:_.table.thRight,children:"Actions"})]})}),e("tbody",{className:_.table.body,children:s.map(D=>e("tr",{className:_.table.row,children:K===D.id?r(bt,{children:[e("td",{className:_.table.td,children:e("input",{value:le,onChange:G=>Q(G.target.value),className:_.input+" w-full text-sm"})}),e("td",{className:_.table.td,children:e("select",{value:k,onChange:G=>W(G.target.value),className:_.input+" w-full text-sm",children:Y.map(G=>e("option",{value:G.value,children:G.label},G.value))})}),e("td",{className:_.table.td,children:e("code",{className:"text-xs bg-gray-100 px-1.5 py-0.5 rounded",children:D.staffCode||"‚Äî"})}),e("td",{className:_.table.td,children:e("input",{value:Z,onChange:G=>j(G.target.value),placeholder:"T√©l√©phone",className:_.input+" w-full text-sm"})}),e("td",{className:_.table.td,children:D.active?e(xt,{color:"green",children:"Actif"}):e(xt,{color:"red",children:"Inactif"})}),e("td",{className:_.table.tdRight,children:r("div",{className:"flex items-center justify-end gap-1.5",children:[e("button",{onClick:te,disabled:g===D.id,className:_.btnPrimary+" !py-1.5 !text-xs",children:g===D.id?e(rt,{className:"w-3.5 h-3.5 animate-spin"}):"Sauver"}),e("button",{onClick:Fe,className:_.btnSecondary+" !py-1.5 !text-xs",children:"Annuler"})]})})]}):r(bt,{children:[e("td",{className:_.table.td,children:e("span",{className:"font-medium text-gray-900",children:D.displayName})}),e("td",{className:_.table.td,children:uc[D.role]??D.role}),e("td",{className:_.table.td,children:e("code",{className:"text-xs bg-gray-100 px-1.5 py-0.5 rounded",children:D.staffCode||"‚Äî"})}),r("td",{className:_.table.td,children:[e("div",{className:"text-sm",children:D.email}),D.telephone&&e("div",{className:"text-xs text-gray-500",children:D.telephone})]}),e("td",{className:_.table.td,children:D.invitationPending?e(xt,{color:"purple",children:"Invitation en attente"}):D.active?e(xt,{color:"green",children:"Actif"}):e(xt,{color:"red",children:"Inactif"})}),e("td",{className:_.table.tdRight,children:r("div",{className:"flex items-center justify-end gap-1.5",children:[D.invitationPending&&D.invitationToken&&r("button",{onClick:()=>ke(D),title:"Renvoyer le lien d'invitation",className:_.btnSecondary+" !py-1.5 !text-xs",children:[e(or,{className:"w-3.5 h-3.5"})," Renvoyer"]}),e("button",{onClick:()=>Ve(D),className:_.btnSecondary+" !py-1.5 !text-xs",children:"Modifier"}),!D.invitationPending&&r(bt,{children:[e("button",{onClick:()=>Ie(D,!D.active),disabled:g===D.id,className:`${D.active?_.btnSecondary:_.btnPrimary} !py-1.5 !text-xs`,children:g===D.id?e(rt,{className:"w-3.5 h-3.5 animate-spin"}):D.active?"D√©sactiver":"Activer"}),e("button",{onClick:()=>ye(D),disabled:g===D.id,title:"R√©initialiser le mot de passe",className:_.btnSecondary+" !py-1.5 !text-xs !px-2",children:e(Gs,{className:"w-3.5 h-3.5"})})]})]})})]})},D.id))})]})})}),e(zl,{open:!!q,title:"R√©initialiser le mot de passe",message:q?`Envoyer un email de r√©initialisation du mot de passe √† ${q.email} ?`:"",confirmLabel:"Envoyer",variant:"danger",onConfirm:Ae,onCancel:()=>ye(null)})]})}const Vu=Object.freeze(Object.defineProperty({__proto__:null,default:pc},Symbol.toStringTag,{value:"Module"}));function gc(){const{user:a}=Ke(),t=Nt(),i=(a==null?void 0:a.companyId)??"",s=(a==null?void 0:a.agencyId)??"",n=On(),[l,d]=o.useState([]),[g,f]=o.useState(0),[b,I]=o.useState(0),[C,A]=o.useState(!0);o.useEffect(()=>{if(!i||!s){A(!1);return}(async()=>{A(!0);const{start:L,end:E}=n.range,[m,c]=await Promise.all([Ee(Te(he($,`companies/${i}/agences/${s}/shifts`),ae("status","==","validated"))),Ee(Te(he($,`companies/${i}/agences/${s}/reservations`),ae("createdAt",">=",We.fromDate(L)),ae("createdAt","<=",We.fromDate(E)),ae("statut","in",["paye","pay√©"])))]);d(m.docs.map(w=>({id:w.id,...w.data()}))),f(c.docs.reduce((w,N)=>w+(N.data().montant??0),0)),I(c.size),A(!1)})()},[i,s,n.range.start.getTime(),n.range.end.getTime()]);const u=o.useMemo(()=>l.filter(h=>h.lockedChef),[l]),x=()=>{const h=`Guichetier,Code,D√©but,Fin,Valid√© Compta,Valid√© Chef
`,L=u.map(w=>{var H,M;const N=(H=w.startTime)!=null&&H.toDate?Je(w.startTime.toDate(),"dd/MM/yyyy HH:mm"):"",R=(M=w.endTime)!=null&&M.toDate?Je(w.endTime.toDate(),"dd/MM/yyyy HH:mm"):"";return`"${w.userName??w.userId}","${w.userCode??""}","${N}","${R}","Oui","Oui"`}).join(`
`),E=new Blob([h+L],{type:"text/csv;charset=utf-8;"}),m=URL.createObjectURL(E),c=document.createElement("a");c.href=m,c.download=`rapports-agence-${Je(new Date,"yyyy-MM-dd")}.csv`,c.click(),URL.revokeObjectURL(m)};return C?e("div",{className:_.page,children:e("p",{className:_.muted,children:"Chargement des rapports‚Ä¶"})}):r("div",{className:_.page,children:[r("div",{className:"flex items-start justify-between flex-wrap gap-3",children:[r("div",{children:[e("h1",{className:_.h1,children:"Rapports"}),e("p",{className:_.muted,children:Je(new Date,"EEEE d MMMM yyyy",{locale:Et})})]}),r("div",{className:"flex items-center gap-2 flex-wrap",children:[e(jn,{preset:n.preset,onPresetChange:n.setPreset,customStart:n.customStart,customEnd:n.customEnd,onCustomStartChange:n.setCustomStart,onCustomEndChange:n.setCustomEnd}),r("button",{onClick:x,disabled:u.length===0,className:_.btnSecondary,children:[e(Dn,{className:"w-4 h-4"}),"Export CSV"]})]})]}),r("div",{className:"grid grid-cols-3 gap-4",children:[e(dt,{label:"Revenu",value:t(g),accent:"text-emerald-700"}),e(dt,{label:"Billets",value:b,accent:"text-blue-700"}),e(dt,{label:"Rapports valid√©s",value:u.length,accent:"text-indigo-700",help:"Nombre de rapports de session ayant √©t√© valid√©s par le comptable ET approuv√©s par le chef d'agence."})]}),e(Zt,{title:"Rapports valid√©s (comptable + chef)",icon:Bs,noPad:!0,help:"Historique des sessions enti√®rement valid√©es. Un rapport appara√Æt ici uniquement apr√®s la double validation (comptable + chef d'agence).",children:u.length===0?e(Sa,{message:"Aucun rapport enti√®rement valid√©."}):e("div",{className:_.table.wrapper,children:r("table",{className:_.table.base,children:[e("thead",{className:_.table.head,children:r("tr",{children:[e("th",{className:_.table.th,children:"Guichetier"}),e("th",{className:_.table.th,children:"Code"}),e("th",{className:_.table.th,children:"D√©but"}),e("th",{className:_.table.th,children:"Fin"}),e("th",{className:_.table.th,children:"Valid√© compta"}),e("th",{className:_.table.th,children:"Approuv√© chef"})]})}),e("tbody",{className:_.table.body,children:u.map(h=>{var L,E,m,c,w,N;return r("tr",{className:_.table.row,children:[e("td",{className:_.table.td,children:h.userName??h.userId}),e("td",{className:_.table.td,children:e("code",{className:"text-xs bg-gray-100 px-1.5 py-0.5 rounded",children:h.userCode??"‚Äî"})}),e("td",{className:_.table.td,children:(L=h.startTime)!=null&&L.toDate?Je(h.startTime.toDate(),"dd/MM HH:mm"):"‚Äî"}),e("td",{className:_.table.td,children:(E=h.endTime)!=null&&E.toDate?Je(h.endTime.toDate(),"dd/MM HH:mm"):"‚Äî"}),e("td",{className:_.table.td,children:e(xt,{color:"green",children:((c=(m=h.comptable)==null?void 0:m.by)==null?void 0:c.name)??"Oui"})}),e("td",{className:_.table.td,children:e(xt,{color:"green",children:((N=(w=h.chef)==null?void 0:w.by)==null?void 0:N.name)??"Oui"})})]},h.id)})})]})})})]})}const qu=Object.freeze(Object.defineProperty({__proto__:null,default:gc},Symbol.toStringTag,{value:"Module"})),fc=async(a,t,i,s,n,l,d)=>{try{const g=he($,"companies",a,"agences",d,"weeklyTrips"),f=pe(g),b={id:f.id,departure:t.trim(),arrival:i.trim(),price:s,places:l,horaires:n,active:!0,createdAt:We.now(),updatedAt:We.now()};return await jt(f,b),f.id}catch(g){throw console.error("Erreur lors de la cr√©ation du trajet:",g),g}},us=({label:a,value:t,onChange:i})=>{const[s,n]=o.useState([]);return o.useEffect(()=>{(async()=>{const g=(await Ee(he($,"villes"))).docs.map(f=>f.data().nom);n(g)})()},[]),r("div",{children:[e("label",{className:"block font-medium mb-1",children:a}),e("input",{list:"liste-villes",className:"w-full border px-3 py-2 rounded",value:t,onChange:l=>i(l.target.value),placeholder:"Entrer une ville"}),e("datalist",{id:"liste-villes",children:s.map((l,d)=>e("option",{value:l},d))})]})},yc=async(a,t)=>{const i=n=>n.trim().toLowerCase().replace(/\s+/g," ").replace(/\b\w/g,l=>l.toUpperCase()),s=[a,t].map(i);for(const n of s){const l=pe($,"villes",n);(await He(l)).exists()||await jt(l,{nom:n})}},dn=["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"],bc=()=>{const{user:a,company:t}=Ke(),i=Nt(),s=ti(),[n,l]=o.useState(""),[d,g]=o.useState(""),[f,b]=o.useState(""),[I,C]=o.useState(""),[A,u]=o.useState({}),[x,h]=o.useState(""),[L,E]=o.useState(!1),[m,c]=o.useState([]),[w,N]=o.useState(null),[R,H]=o.useState(null),[M,K]=o.useState(""),[B,le]=o.useState(""),[Q,Z]=o.useState(1),[j,k]=o.useState(!1),W=10,q={primary:(t==null?void 0:t.couleurPrimaire)||"#06b6d4",secondary:(t==null?void 0:t.couleurSecondaire)||"#8b5cf6"};o.useEffect(()=>{a!=null&&a.role&&(["admin_platforme","admin_compagnie","chefAgence"].includes(a.role)?k(!1):(k(!0),h("‚ùå Acc√®s refus√© : seuls les administrateurs et chefs d'agence peuvent g√©rer les trajets.")))},[a]),o.useEffect(()=>{!j&&(a!=null&&a.companyId)&&(a!=null&&a.agencyId)&&ye()},[a,Q,M,B,j]);const ye=async()=>{if(!(a!=null&&a.companyId)||!(a!=null&&a.agencyId))return;const te=Te(he($,"companies",a.companyId,"agences",a.agencyId,"weeklyTrips")),D=(await Ee(te)).docs.map(G=>({id:G.id,...G.data()})).sort((G,y)=>{var P,F;return(((P=y.createdAt)==null?void 0:P.seconds)||0)-(((F=G.createdAt)==null?void 0:F.seconds)||0)}).filter(G=>{var y,P;return(G.departure.toLowerCase().includes(M.toLowerCase())||G.arrival.toLowerCase().includes(M.toLowerCase()))&&(B===""||((P=(y=G.horaires)==null?void 0:y[B])==null?void 0:P.length)>0)}).slice((Q-1)*W,Q*W);c(D)},se=async te=>{if(!(!(a!=null&&a.companyId)||!(a!=null&&a.agencyId))&&confirm("Voulez-vous vraiment supprimer ce trajet ?")){E(!0);try{await Ki(pe($,"companies",a.companyId,"agences",a.agencyId,"weeklyTrips",te)),ye(),h("üóëÔ∏è Trajet supprim√© avec succ√®s.")}catch(Ae){console.error(Ae),h("‚ùå Erreur lors de la suppression du trajet.")}finally{E(!1)}}},Y=(te,Ae,ke)=>{u(Pe=>{const je={...Pe};return je[te]||(je[te]=[]),je[te][Ae]=ke,je})},ue=te=>{u(Ae=>({...Ae,[te]:[...Ae[te]||[],""]}))},T=(te,Ae)=>{u(ke=>{const Pe={...ke};return Pe[te]?(Pe[te].splice(Ae,1),Pe):ke})},ce=te=>te.charAt(0).toUpperCase()+te.slice(1).toLowerCase(),Ie=()=>{l(""),g(""),b(""),C(""),u({}),H(null)},Ve=()=>{const te=new vi;te.text("Liste des trajets",14,14),Ni(te,{head:[["D√©part","Arriv√©e","Prix","Places"]],body:m.map(Ae=>[Ae.departure,Ae.arrival,i(Ae.price),Ae.places||""])}),te.save("trajets_agence.pdf")},Fe=async()=>{if(!["admin_platforme","admin_compagnie","chefAgence"].includes((a==null?void 0:a.role)||""))return h("‚ùå Permission insuffisante pour cette action.");if(!(a!=null&&a.companyId)||!(a!=null&&a.agencyId))return h("‚ùå Agence non reconnue. Reconnectez-vous.");E(!0),h("");const Ae={};for(const je in A){const D=A[je].filter(G=>G&&G.trim()!=="");D.length>0&&(Ae[je]=D)}const ke=ce(n.trim()),Pe=ce(d.trim());if(!ke||!Pe||!f.trim()||!I.trim()||Object.keys(Ae).length===0)return E(!1),h("‚ö†Ô∏è Tous les champs sont obligatoires (d√©part, arriv√©e, prix, places et au moins un horaire).");try{if(R)await gt(pe($,"companies",a.companyId,"agences",a.agencyId,"weeklyTrips",R),{departure:ke,arrival:Pe,price:parseInt(f),places:parseInt(I),horaires:Ae}),h("‚úÖ Trajet modifi√© avec succ√®s.");else{const je=await fc(a.companyId,ke,Pe,parseInt(f),Ae,parseInt(I),a.agencyId);await yc(ke,Pe),h("‚úÖ Trajet ajout√© avec succ√®s !")}Ie(),ye()}catch(je){console.error("Erreur Firebase:",je),je.code==="permission-denied"?h("‚ùå Permission refus√©e. V√©rifiez que votre r√¥le (chefAgence) est correctement configur√©."):h("‚ùå Erreur lors de l'enregistrement. V√©rifiez la console.")}finally{E(!1)}};return j?e("div",{className:"min-h-screen bg-gray-50 p-6 text-gray-800 flex items-center justify-center",children:r("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-8 max-w-md text-center",children:[e("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Acc√®s Refus√©"}),e("p",{className:"text-gray-600 mb-4",children:"Vous n'avez pas les permissions n√©cessaires pour acc√©der √† cette page."}),e("p",{className:"text-sm text-gray-500",children:"Seuls les administrateurs et chefs d'agence peuvent g√©rer les trajets."})]})}):r("div",{className:"min-h-screen bg-gray-50 p-6 text-gray-800",children:[r("div",{className:"mb-8 p-6 rounded-xl bg-white shadow-md border border-gray-200 flex justify-between items-center",children:[r("div",{children:[e("h1",{className:"text-3xl font-bold",style:{color:q.primary},children:"Gestion des Trajets"}),r("p",{className:"text-gray-600 mt-1",children:["Connect√© en tant que ",e("span",{className:"font-semibold",children:a==null?void 0:a.role})]})]}),e("button",{onClick:Ve,disabled:m.length===0,className:`px-6 py-2 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition-all ${m.length===0?"opacity-50 cursor-not-allowed":""}`,style:{background:`linear-gradient(to right, ${q.primary}, ${q.secondary})`},children:"üìÑ Exporter la liste"})]}),r("div",{className:"grid md:grid-cols-2 gap-6",children:[r("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-6",children:[e("h2",{className:"text-xl font-bold mb-4",children:R?"Modifier le trajet":"Ajouter un trajet"}),e(us,{label:"Ville de d√©part",value:n,onChange:l}),e(us,{label:"Ville d'arriv√©e",value:d,onChange:g}),e("input",{type:"number",placeholder:`Prix (${s})`,value:f,onChange:te=>b(te.target.value),className:"border p-2 w-full rounded mb-3",min:"0"}),e("input",{type:"number",placeholder:"Nombre de places",value:I,onChange:te=>C(te.target.value),className:"border p-2 w-full rounded mb-4",min:"1"}),dn.map(te=>r("div",{className:"mb-2",children:[r("p",{className:"font-semibold",children:[ce(te)," :"]}),(A[te]||[]).map((Ae,ke)=>r("div",{className:"flex gap-2 my-1",children:[e("input",{type:"time",value:Ae,onChange:Pe=>Y(te,ke,Pe.target.value),className:"border p-1 rounded flex-grow"}),e("button",{type:"button",onClick:()=>T(te,ke),className:"text-red-600 hover:bg-red-50 px-2 rounded",children:"√ó"})]},ke)),e(pt,{type:"button",onClick:()=>ue(te),variant:"primary",size:"sm",className:"mt-1",children:"+ Ajouter un horaire"})]},te)),e(pt,{onClick:Fe,disabled:L,variant:"primary",className:"mt-4 w-full",children:L?"‚è≥ En cours...":R?"Mettre √† jour":"Enregistrer le trajet"}),x&&e("p",{className:`mt-2 p-3 rounded ${x.includes("‚ùå")?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:x}),R&&e("button",{onClick:Ie,className:"mt-2 px-4 py-2 bg-gray-500 hover:bg-gray-700 text-white rounded w-full",children:"Annuler la modification"})]}),r("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-6",children:[e("h2",{className:"text-xl font-bold mb-4",children:"Liste des trajets"}),r("div",{className:"flex gap-2 mb-4",children:[e("input",{type:"text",placeholder:"Rechercher par ville...",value:M,onChange:te=>{K(te.target.value),Z(1)},className:"border p-2 w-full rounded"}),r("select",{value:B,onChange:te=>{le(te.target.value),Z(1)},className:"border p-2 rounded",children:[e("option",{value:"",children:"Tous les jours"}),dn.map(te=>e("option",{value:te,children:ce(te)},te))]})]}),m.length>W&&r("div",{className:"flex justify-between items-center mb-4",children:[e("button",{onClick:()=>Z(te=>Math.max(1,te-1)),disabled:Q===1,className:"px-3 py-1 bg-gray-200 rounded disabled:opacity-50",children:"Pr√©c√©dent"}),r("span",{children:["Page ",Q]}),e("button",{onClick:()=>Z(te=>te+1),disabled:m.length<W,className:"px-3 py-1 bg-gray-200 rounded disabled:opacity-50",children:"Suivant"})]}),m.length>0?m.map(te=>r("div",{className:"border rounded p-3 mb-2 shadow hover:shadow-md transition-shadow",children:[r("div",{className:`cursor-pointer font-semibold flex justify-between items-center ${te.active?"text-green-700":"text-red-500"}`,onClick:()=>N(w===te.id?null:te.id),children:[r("span",{children:[te.departure," ‚Üí ",te.arrival," ‚Ä¢ ",i(te.price)]}),e("span",{className:"text-xs bg-gray-100 px-2 py-1 rounded",children:te.active?"üü¢ Actif":"üî¥ Inactif"})]}),w===te.id&&r("div",{className:"mt-2 text-sm space-y-2",children:[r("p",{children:[e("strong",{children:"Places :"})," ",te.places||"Non sp√©cifi√©"]}),r("div",{children:[e("strong",{children:"Horaires :"}),dn.map(Ae=>{var Pe;const ke=(Pe=te.horaires)==null?void 0:Pe[Ae];return ke!=null&&ke.length?r("p",{className:"ml-2",children:[ce(Ae)," : ",ke.sort().join(", ")]},Ae):null})]}),r("div",{className:"mt-3 flex gap-2 flex-wrap",children:[e("button",{onClick:()=>se(te.id),disabled:L,className:"bg-red-600 hover:bg-red-800 text-white px-3 py-1 rounded text-sm",children:"Supprimer"}),e("button",{onClick:()=>{H(te.id),l(te.departure),g(te.arrival),b(te.price.toString()),C((te.places||"").toString()),u(te.horaires)},disabled:L,className:"bg-yellow-500 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm",children:"Modifier"}),e(pt,{onClick:async()=>{if(!(a!=null&&a.companyId)||!(a!=null&&a.agencyId)){alert("Votre session a expir√©. Merci de vous reconnecter.");return}try{await gt(pe($,"companies",a.companyId,"agences",a.agencyId,"weeklyTrips",te.id),{active:!te.active}),ye()}catch(Ae){console.error("Erreur lors du changement d'√©tat:",Ae)}},disabled:L,variant:te.active?"secondary":"primary",size:"sm",children:te.active?"D√©sactiver":"Activer"})]})]})]},te.id)):e("div",{className:"text-gray-500 italic p-4 border rounded text-center",children:L?"Chargement...":"Aucun trajet disponible"})]})]})]})},Bu=Object.freeze(Object.defineProperty({__proto__:null,default:bc},Symbol.toStringTag,{value:"Module"}));function xc(){const{user:a,company:t}=Ke(),i=ml(),s=(a==null?void 0:a.companyId)??"",n=(a==null?void 0:a.agencyId)??"",[l,d]=o.useState([]),[g,f]=o.useState([]),[b,I]=o.useState([]),[C,A]=o.useState(!0),[u,x]=o.useState(null),[h,L]=o.useState(0);o.useEffect(()=>{if(!s||!n){A(!1);return}const m=(t==null?void 0:t.devise)??"XOF";x(null),fr(s,n,m,t==null?void 0:t.nom).then(()=>qr(s,{agencyId:n})).then(d).catch(()=>{x(i?"Erreur lors du chargement de la tr√©sorerie.":"Connexion indisponible. Impossible de charger la tr√©sorerie.")}).finally(()=>A(!1))},[s,n,t,i,h]),o.useEffect(()=>{if(!s)return;const m=Te(he($,`companies/${s}/financialMovements`),ae("agencyId","==",n),Rt("performedAt","desc"),Tt(50)),c=Ge(m,w=>{f(w.docs.map(N=>{const R=N.data();return{id:N.id,amount:Number(R.amount??0),movementType:R.movementType??"",performedAt:R.performedAt}}))},()=>{x(i?"Erreur lors du chargement des mouvements.":"Connexion indisponible. Mouvements non synchronis√©s.")});return()=>c()},[s,n,i]),o.useEffect(()=>{if(!s)return;hr(s,{agencyId:n,status:"pending",limitCount:20}).then(c=>I(c.map(w=>({id:w.id,amount:w.amount,category:w.category,status:w.status})))).catch(()=>{x(i?"Erreur lors du chargement des d√©penses.":"Connexion indisponible. D√©penses non disponibles.")});const m=setInterval(()=>{hr(s,{agencyId:n,status:"pending",limitCount:20}).then(c=>I(c.map(w=>({id:w.id,amount:w.amount,category:w.category,status:w.status})))).catch(()=>{})},3e4);return()=>clearInterval(m)},[s,n,i]);const E=l.reduce((m,c)=>m+c.currentBalance,0);return!s||!n?e("div",{className:"p-6",children:e("p",{className:"text-gray-500",children:"Contexte agence introuvable."})}):C&&l.length===0?e(gl,{}):r("div",{className:"space-y-6 p-4 md:p-6 max-w-4xl mx-auto",children:[!i&&e(fl,{message:"Connexion instable: certaines donn√©es peuvent √™tre incompl√®tes."}),u&&e(yl,{message:u,onRetry:()=>L(m=>m+1)}),e("p",{className:"text-sm text-gray-600",children:ri(new Date)}),r("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[r("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(_t,{className:"w-5 h-5"})," Position caisse"]}),e("div",{className:"text-2xl font-bold text-indigo-700",children:E.toLocaleString("fr-FR")}),e("ul",{className:"mt-3 space-y-2 text-sm",children:l.map(m=>r("li",{className:"flex justify-between",children:[e("span",{children:m.accountName}),r("span",{className:"font-medium",children:[m.currentBalance.toLocaleString("fr-FR")," ",m.currency]})]},m.id))})]}),r("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[r("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(vn,{className:"w-5 h-5"})," Derniers mouvements"]}),e("div",{className:"overflow-x-auto max-h-64 overflow-y-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{children:r("tr",{className:"border-b",children:[e("th",{className:"text-left py-1",children:"Type"}),e("th",{className:"text-right py-1",children:"Montant"})]})}),e("tbody",{children:g.length===0?e("tr",{children:e("td",{colSpan:2,className:"py-4 text-gray-500 text-center",children:"Aucun mouvement"})}):g.slice(0,25).map(m=>r("tr",{className:"border-b",children:[e("td",{className:"py-1",children:m.movementType}),r("td",{className:"py-1 text-right",children:["+",m.amount.toLocaleString("fr-FR")]})]},m.id))})]})})]}),r("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[r("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(mr,{className:"w-5 h-5"})," D√©penses en attente"]}),b.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucune d√©pense en attente."}):e("ul",{className:"space-y-2 text-sm",children:b.map(m=>r("li",{className:"flex justify-between",children:[e("span",{children:m.category}),r("span",{children:[m.amount.toLocaleString("fr-FR")," ‚Äî ",m.status]})]},m.id))})]})]})}const Gu=Object.freeze(Object.defineProperty({__proto__:null,default:xc},Symbol.toStringTag,{value:"Module"})),Xe={PENDING:"pending",ACTIVE:"active",PAUSED:"paused",CLOSED:"closed",VALIDATED:"validated"},vc=[Xe.PENDING,Xe.ACTIVE,Xe.PAUSED],Nc=[Xe.PENDING,Xe.ACTIVE,Xe.PAUSED],Vn="shiftReports";function qn(a){return a===Xe.VALIDATED}function wc(a){return Nc.includes(a)}const ms="teliya_device_fp";function Sn(a){let t=0;for(let i=0;i<a.length;i++){const s=a.charCodeAt(i);t=(t<<5)-t+s,t=t&t}return Math.abs(t).toString(36)}function Cc(){if(typeof window>"u")return"ssr";try{let a=localStorage.getItem(ms);if(!a){a=[typeof navigator<"u"?navigator.userAgent:"",typeof screen<"u"?`${screen.width}x${screen.height}`:"",Date.now().toString(36),Math.random().toString(36).slice(2,10)].join("|");const t=Sn(a);return localStorage.setItem(ms,t),t}return a}catch{return Sn("fallback_"+Date.now())}}function xr(){const a=Cc(),t=typeof navigator<"u"?navigator.userAgent:"";return Sn(a+"|"+t)}const Sc="dailyStats";function ii(a){const t=a.toDate();return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function Ur(a,t,i){return pe($,`companies/${a}/agences/${t}/${Sc}/${i}`)}function zr(){return{totalRevenue:qe(0),totalPassengers:qe(0),totalSeats:qe(0),validatedSessions:qe(0),activeSessions:qe(0),closedSessions:qe(0),boardingClosedCount:qe(0)}}function Ac(a,t,i,s,n,l){const d=Ur(t,i,s);a.set(d,{companyId:t,agencyId:i,date:s,...zr(),totalPassengers:qe(n),totalSeats:qe(l),createdAt:Re(),updatedAt:Re()},{merge:!0})}function Ic(a,t,i,s){const n=Ur(t,i,s);a.set(n,{companyId:t,agencyId:i,date:s,...zr(),closedSessions:qe(1),createdAt:Re(),updatedAt:Re()},{merge:!0})}function Ec(a,t,i,s,n){const l=Ur(t,i,s);a.set(l,{companyId:t,agencyId:i,date:s,...zr(),totalRevenue:qe(n),validatedSessions:qe(1),createdAt:Re(),updatedAt:Re()},{merge:!0})}function kc(a,t,i,s){const n=Ur(t,i,s);a.set(n,{companyId:t,agencyId:i,date:s,...zr(),boardingClosedCount:qe(1),createdAt:Re(),updatedAt:Re()},{merge:!0})}const Rc="agencyLiveState/current";function Ya(a,t){return pe($,`companies/${a}/agences/${t}/${Rc}`)}function Tc(a,t,i){const s=Ya(t,i);a.set(s,{companyId:t,agencyId:i,activeSessionsCount:qe(1),closedPendingValidationCount:qe(0),vehiclesInTransitCount:qe(0),boardingOpenCount:qe(0),lastUpdatedAt:Re()},{merge:!0})}function Dc(a,t,i){const s=Ya(t,i);a.set(s,{companyId:t,agencyId:i,activeSessionsCount:qe(-1),closedPendingValidationCount:qe(1),vehiclesInTransitCount:qe(0),boardingOpenCount:qe(0),lastUpdatedAt:Re()},{merge:!0})}function $c(a,t,i){const s=Ya(t,i);a.set(s,{companyId:t,agencyId:i,activeSessionsCount:qe(0),closedPendingValidationCount:qe(-1),vehiclesInTransitCount:qe(0),boardingOpenCount:qe(0),lastUpdatedAt:Re()},{merge:!0})}function Mc(a,t,i){const s=Ya(t,i);a.set(s,{companyId:t,agencyId:i,activeSessionsCount:qe(0),closedPendingValidationCount:qe(0),vehiclesInTransitCount:qe(0),boardingOpenCount:qe(1),lastUpdatedAt:Re()},{merge:!0})}function _c(a,t,i){const s=Ya(t,i);a.set(s,{companyId:t,agencyId:i,activeSessionsCount:qe(0),closedPendingValidationCount:qe(0),vehiclesInTransitCount:qe(0),boardingOpenCount:qe(-1),lastUpdatedAt:Re()},{merge:!0})}function Lc(a,t,i,s){if(s===0)return;const n=Ya(t,i);a.set(n,{companyId:t,agencyId:i,activeSessionsCount:qe(0),closedPendingValidationCount:qe(0),vehiclesInTransitCount:qe(s),boardingOpenCount:qe(0),lastUpdatedAt:Re()},{merge:!0})}const oa="shifts",Pc="reservations",Fc="guichet";function ta(a){const t={};return Object.keys(a||{}).forEach(i=>{const s=a[i];s!==void 0&&(s&&typeof s=="object"&&!Array.isArray(s)&&!(s instanceof We)?t[i]=ta(s):t[i]=s)}),t}function jc(a=new Date){const t=a.getFullYear(),i=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${t}${i}${s}`}async function oi(a,t,i){const s=he($,`companies/${a}/agences/${t}/${oa}`),n=Te(s,ae("userId","==",i),ae("status","in",[Xe.PENDING,Xe.ACTIVE,Xe.PAUSED]),Rt("createdAt","desc"),Tt(1)),l=await Ee(n);return l.empty?null:l.docs[0].id}async function Oc(a){const t=await oi(a.companyId,a.agencyId,a.userId);if(t)return t;const i=he($,`companies/${a.companyId}/agences/${a.agencyId}/${oa}`);return(await kn(i,ta({companyId:a.companyId,agencyId:a.agencyId,userId:a.userId,userName:a.userName??null,userCode:a.userCode??"GUEST",status:Xe.PENDING,startAt:null,endAt:null,startTime:null,endTime:null,dayKey:jc(),tickets:0,amount:0,totalRevenue:0,totalReservations:0,totalCash:0,totalDigital:0,accountantValidated:!1,managerValidated:!1,accountantValidatedAt:null,managerValidatedAt:null,createdAt:Re(),updatedAt:Re()}))).id}async function Vc(a){const t=`companies/${a.companyId}/agences/${a.agencyId}`,i=pe($,`${t}/${oa}/${a.shiftId}`),s=pe($,`${t}/${Vn}/${a.shiftId}`);await Ut($,async n=>{const l=await n.get(i);if(!l.exists())throw new Error("Poste introuvable.");const d=l.data();if(d.status!==Xe.PENDING)throw new Error("Seul un poste en attente peut √™tre activ√©.");const g=We.now();n.update(i,ta({status:Xe.ACTIVE,startAt:g,startTime:g,activatedAt:g,activatedBy:{id:a.activatedBy.id,name:a.activatedBy.name??null},updatedAt:Re()})),n.set(s,ta({shiftId:a.shiftId,companyId:a.companyId,agencyId:a.agencyId,userId:d.userId,userName:d.userName??null,userCode:d.userCode??null,startAt:g,activatedAt:g,activatedBy:{id:a.activatedBy.id,name:a.activatedBy.name??null},status:"pending_validation",updatedAt:Re()}),{merge:!0}),Tc(n,a.companyId,a.agencyId)})}async function qc(a){const t=xr(),i=`companies/${a.companyId}/agences/${a.agencyId}`,s=pe($,`${i}/${oa}/${a.shiftId}`);try{return await Ut($,async n=>{const l=await n.get(s);if(!l.exists())throw new Error("Poste introuvable.");const d=l.data(),g=d.status;if(g!==Xe.ACTIVE&&g!==Xe.PAUSED)throw new Error("Poste non actif.");const f=d.deviceFingerprint;if(f&&f!==t)throw new Error("SESSION_LOCKED_OTHER_DEVICE");f||n.update(s,ta({deviceFingerprint:t,deviceClaimedAt:Re(),sessionOwnerUid:d.userId,updatedAt:Re()}))}),{claimed:!0}}catch(n){const l=n instanceof Error?n.message:String(n);if(l==="SESSION_LOCKED_OTHER_DEVICE")return{claimed:!1,error:l};throw n}}function Bc(a){return a.deviceFingerprint?a.deviceFingerprint===xr():!0}async function Gc(a){const t=`companies/${a.companyId}/agences/${a.agencyId}`,i=he($,`${t}/${oa}`),s=pe(i,a.shiftId),n=he($,`${t}/${Pc}`),l=pe($,`${t}/${Vn}/${a.shiftId}`),d=Te(n,ae("shiftId","==",a.shiftId),ae("canal","==",Fc)),f=(await Ee(d)).docs.map(I=>I.ref);let b={totalRevenue:0,totalReservations:0,totalCash:0,totalDigital:0,tickets:0,details:[]};return await Ut($,async I=>{const C=await I.get(s);if(!C.exists())throw new Error("Poste introuvable.");const A=C.data(),u=A.status;if(!wc(u))throw new Error("√âtat non cl√¥turable.");if(qn(u))throw new Error("Poste d√©j√† valid√© (verrouill√©).");if(A.deviceFingerprint&&A.deviceFingerprint!==a.deviceFingerprint)throw new Error("Session ouverte sur un autre appareil.");let x=0,h=0,L=0,E=0,m=0;const c={};for(const M of f){const K=await I.get(M);if(!K.exists())continue;const B=K.data(),le=Number(B.montant??0),Q=Number(B.seatsGo??0)+Number(B.seatsReturn??0);h+=1,m+=Q,x+=le;const Z=String(B.paiement??"").toLowerCase();Z==="esp√®ces"||Z==="especes"?L+=le:E+=le;const j=`${B.depart??""}‚Üí${B.arrivee??B.arrival??""}`;c[j]||(c[j]={billets:0,montant:0,heures:new Set}),c[j].billets+=Q,c[j].montant+=le,B.heure&&c[j].heures.add(String(B.heure))}const w=Object.entries(c).map(([M,K])=>({trajet:M,billets:K.billets,montant:K.montant,heures:Array.from(K.heures).sort()})),N=We.now(),R=A.startAt??A.startTime??N;I.set(l,ta({shiftId:a.shiftId,companyId:a.companyId,agencyId:a.agencyId,userId:A.userId,userName:A.userName??null,userCode:A.userCode??null,startAt:R,endAt:N,closedAt:N,billets:m,montant:x,totalRevenue:x,totalReservations:h,totalCash:L,totalDigital:E,details:w,accountantValidated:!1,managerValidated:!1,accountantValidatedAt:null,managerValidatedAt:null,status:"pending_validation",createdAt:A.createdAt,updatedAt:Re()}),{merge:!0}),I.update(s,ta({status:Xe.CLOSED,endAt:N,endTime:N,closedAt:N,tickets:m,amount:x,totalRevenue:x,totalReservations:h,totalCash:L,totalDigital:E,updatedAt:Re()}));const H=ii(N);Ic(I,a.companyId,a.agencyId,H),Dc(I,a.companyId,a.agencyId),b={totalRevenue:x,totalReservations:h,totalCash:L,totalDigital:E,tickets:m,details:w}}),b}async function Uc(a){const t=`companies/${a.companyId}/agences/${a.agencyId}`,i=pe($,`${t}/${oa}/${a.shiftId}`),s=pe($,`${t}/${Vn}/${a.shiftId}`);let n=0;return await Ut($,async l=>{const d=await l.get(i),g=await l.get(s);if(!d.exists())throw new Error("Poste introuvable.");if(!g.exists())throw new Error("Rapport introuvable.");const f=d.data();if(f.status===Xe.VALIDATED)throw new Error("Poste d√©j√† valid√© (verrouill√©).");if(f.status!==Xe.CLOSED)throw new Error("Seuls les postes cl√¥tur√©s peuvent √™tre valid√©s.");const b=Number(f.totalCash??f.amount??0);n=a.receivedCashAmount-b;const I=We.now(),C={validatedBy:a.validatedBy,validatedAt:I,receivedCashAmount:a.receivedCashAmount,computedDifference:n,accountantDeviceFingerprint:a.accountantDeviceFingerprint};l.update(i,ta({status:Xe.VALIDATED,validatedAt:I,validationAudit:C,updatedAt:Re()})),l.update(s,ta({status:"validated",validatedAt:I,validationAudit:C,updatedAt:Re()}));const A=Number(f.totalRevenue??f.amount??0),u=f.closedAt??f.endAt??I,x=ii(u);Ec(l,a.companyId,a.agencyId,x,A),$c(l,a.companyId,a.agencyId);const h=Ws(a.agencyId),L=ko(a.companyId,h),E=await l.get(L);if(E.exists()&&a.receivedCashAmount>0){const m=E.data().currency??"XOF";await Ro(l,{companyId:a.companyId,fromAccountId:null,toAccountId:h,amount:a.receivedCashAmount,currency:m,movementType:"revenue_cash",referenceType:"shift",referenceId:a.shiftId,agencyId:a.agencyId,performedBy:a.validatedBy.id,performedAt:I,notes:null})}}),{computedDifference:n}}async function li(a,t,i){const s=pe($,`companies/${a}/agences/${t}/${oa}/${i}`),n=await He(s);if(!n.exists())throw new Error("Poste introuvable.");const l=n.data();if(l.status!==Xe.ACTIVE)throw new Error("Le poste doit √™tre en service.");if(qn(l.status))throw new Error("Poste verrouill√©.");await gt(s,{status:Xe.PAUSED,updatedAt:Re()})}async function ci(a,t,i){const s=pe($,`companies/${a}/agences/${t}/${oa}/${i}`),n=await He(s);if(!n.exists())throw new Error("Poste introuvable.");if(n.data().status!==Xe.PAUSED)throw new Error("Le poste doit √™tre en pause.");await gt(s,{status:Xe.ACTIVE,updatedAt:Re()})}function hs(a,t){return{id:a,companyId:t.companyId,agencyId:t.agencyId,userId:t.userId,userName:t.userName??null,userCode:t.userCode??null,status:t.status||"pending",startAt:t.startAt??null,endAt:t.endAt??null,startTime:t.startTime??null,endTime:t.endTime??null,dayKey:t.dayKey??null,tickets:t.tickets??0,amount:t.amount??0,totalRevenue:t.totalRevenue??0,totalReservations:t.totalReservations??0,totalCash:t.totalCash??0,totalDigital:t.totalDigital??0,accountantValidated:!!(t.accountantValidated??!1),managerValidated:!!(t.managerValidated??!1),accountantValidatedAt:t.accountantValidatedAt??null,managerValidatedAt:t.managerValidatedAt??null,deviceFingerprint:t.deviceFingerprint??null,deviceClaimedAt:t.deviceClaimedAt??null,sessionOwnerUid:t.sessionOwnerUid??null,createdAt:t.createdAt,updatedAt:t.updatedAt}}function zc(){const{user:a}=Ke(),[t,i]=o.useState(null),[s,n]=o.useState(!0),[l,d]=o.useState(!1),g=o.useRef(new Set),f=o.useRef(new Set),b=(t==null?void 0:t.status)??"none";o.useEffect(()=>{if(!(a!=null&&a.companyId)||!(a!=null&&a.agencyId)||!(a!=null&&a.uid)){i(null),d(!1),n(!1);return}n(!0);const h=he($,`companies/${a.companyId}/agences/${a.agencyId}/shifts`),L=Te(h,ae("userId","==",a.uid),ae("status","in",vc),Rt("createdAt","desc"),Tt(1)),E=Ge(L,m=>{if(m.empty)i(null),d(!1),g.current.clear(),f.current.clear();else{const c=m.docs[0],w=c.data(),N=hs(c.id,w);if(i(N),N.status===Xe.ACTIVE||N.status===Xe.PAUSED){const R=Bc(N),H=g.current.has(N.id),M=f.current.has(N.id);R?(f.current.delete(N.id),d(!1)):M?d(!0):(H||(g.current.add(N.id),qc({companyId:a.companyId,agencyId:a.agencyId,shiftId:N.id}).then(K=>{K.error==="SESSION_LOCKED_OTHER_DEVICE"?(f.current.add(N.id),d(!0)):(f.current.delete(N.id),d(!1))}).catch(()=>{f.current.delete(N.id),d(!1)})),d(!1))}else d(!1)}n(!1)},m=>{console.error("[useActiveShift] onSnapshot error:",m),i(null),d(!1),n(!1)});return()=>E()},[a==null?void 0:a.uid,a==null?void 0:a.companyId,a==null?void 0:a.agencyId]);const I=o.useCallback(async()=>{if(!(a!=null&&a.companyId)||!(a!=null&&a.agencyId)||!(a!=null&&a.uid))throw new Error("Utilisateur invalide.");if(await oi(a.companyId,a.agencyId,a.uid))return;const L=await Oc({companyId:a.companyId,agencyId:a.agencyId,userId:a.uid,userName:a.displayName||a.email||null,userCode:(a.staffCode||a.codeCourt||a.code||"GUEST")??null}),E=pe($,`companies/${a.companyId}/agences/${a.agencyId}/shifts/${L}`),m=await He(E);m.exists()&&i(hs(L,m.data()))},[a==null?void 0:a.companyId,a==null?void 0:a.agencyId,a==null?void 0:a.uid,a==null?void 0:a.displayName,a==null?void 0:a.email,a==null?void 0:a.staffCode,a==null?void 0:a.codeCourt,a==null?void 0:a.code]),C=o.useCallback(async()=>{if(!t)throw new Error("Aucun poste en cours.");await li(t.companyId,t.agencyId,t.id)},[t]),A=o.useCallback(async()=>{if(!t)throw new Error("Aucun poste en cours.");await ci(t.companyId,t.agencyId,t.id)},[t]),u=o.useCallback(async()=>{if(!t)throw new Error("Aucun poste en cours.");const h=xr();await Gc({companyId:t.companyId,agencyId:t.agencyId,shiftId:t.id,userId:t.userId,deviceFingerprint:h}),i(null)},[t]),x=o.useCallback(async()=>{},[]);return{activeShift:t??null,status:b,loading:s,sessionLockedByOtherDevice:l,startShift:I,pauseShift:C,continueShift:A,closeShift:u,refresh:x}}function Hc(a){if(!a||typeof a!="object")return!1;const t=a.message??"",i=a.code??"";return i==="unavailable"||i==="resource-exhausted"||/offline|network|unavailable|failed to get document/i.test(t)}async function Kc(a,t){const i=`companies/${a.companyId}/agences/${a.agencyId}`,s=pe($,`${i}/shifts/${a.sessionId}`),n=he($,`${i}/reservations`),l=pe(n),d=l.id,g=We.now(),f={trajetId:a.trajetId,date:a.date,heure:a.heure,depart:a.depart,arrivee:a.arrivee,nomClient:a.nomClient,telephone:a.telephone,email:null,seatsGo:a.seatsGo,seatsReturn:a.seatsReturn,montant:a.montant,statut:"paye",statutEmbarquement:"en_attente",checkInTime:null,reportInfo:null,compagnieId:a.companyId,companyId:a.companyId,agencyId:a.agencyId,companySlug:a.companySlug,compagnieNom:a.compagnieNom,agencyNom:a.agencyNom,agencyTelephone:a.agencyTelephone??null,canal:"guichet",paiement:"esp√®ces",paiementSource:"encaisse_guichet",guichetierId:a.userId,guichetierCode:a.userCode,shiftId:a.sessionId,referenceCode:a.referenceCode,qrCode:d,tripType:a.tripType,createdAt:g,createdInSessionId:a.sessionId,createdByUid:a.userId};try{await Ut($,async b=>{const I=await b.get(s);if(!I.exists())throw new Error("Poste introuvable.");const C=I.data(),A=C.status;if(A!=="active"&&A!=="paused")throw new Error("Le poste doit √™tre actif pour enregistrer une vente.");if(qn(A))throw new Error("Poste verrouill√©.");if(C.deviceFingerprint&&(t!=null&&t.deviceFingerprint)&&C.deviceFingerprint!==t.deviceFingerprint)throw new Error("Session ouverte sur un autre appareil.");b.set(l,f);const u=1,x=(a.seatsGo??0)+(a.seatsReturn??0);Ac(b,a.companyId,a.agencyId,a.date,u,x)})}catch(b){if(Hc(b))await jt(l,f);else throw b}return d}async function Yc(a,t,i){if(!i)return!1;const s=pe($,`companies/${a}/agences/${t}/shifts/${i}`),n=await He(s);if(!n.exists())return!1;const d=n.data().status;return d!==Xe.CLOSED&&d!==Xe.VALIDATED}async function Wc(a,t,i,s,n){const l=pe($,`companies/${a}/agences/${t}/reservations/${i}`),d=await He(l);if(!d.exists())throw new Error("R√©servation introuvable.");const f=d.data().shiftId,b=await Yc(a,t,f),I={updatedAt:Re(),editedBy:{id:n.id,name:n.name??null,reason:s.editReason??null}};if(s.nomClient!==void 0&&(I.nomClient=s.nomClient),s.telephone!==void 0&&(I.telephone=s.telephone),s.seatsGo!==void 0&&(I.seatsGo=Math.max(1,s.seatsGo)),s.seatsReturn!==void 0&&(I.seatsReturn=Math.max(0,s.seatsReturn)),s.montant!==void 0){if(!b)throw new Error("Impossible de modifier le montant : session cl√¥tur√©e ou valid√©e.");I.montant=Math.max(0,s.montant)}await gt(l,I)}function Xc(a){return(a||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9 ]/g," ").trim().replace(/\s+/g,"-").toUpperCase()}function Fr(a,t,i=5){const s=(t||"").toUpperCase().replace(/[^A-Z0-9]/g,"");if(s)return s.slice(0,i);const n=(a||"").trim();if(!n)return"ORG";const l=n.split(/\s+/).filter(Boolean);if(l.length>=2){const d=l.slice(0,3).map(g=>g[0]||"").join("");if(d)return d.toUpperCase().slice(0,i)}return Xc(n).replace(/-/g,"").slice(0,Math.max(3,i))}const Er={control:"Pr√©sentez ce code au contr√¥le.",validity:"Validit√© : 1 mois √† compter de la date d‚Äô√©mission.",arrival:"Pr√©sentez-vous 1H avant le d√©part.",keep:"Conservez ce billet jusqu‚Äô√† l‚Äôarriv√©e."};function Qc(a){return a==null?void 0:a.toLowerCase().split(" ").filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function Jc(a){try{return Je(new Date(a),"dd/MM/yyyy",{locale:Et})}catch{return a}}const di=({open:a,onClose:t,reservation:i,company:s})=>{const n=Nt(),l=o.useRef(null);if(!a)return null;const d=i.referenceCode||i.id,g=`${window.location.origin}/r/${d}`,f=Je(new Date(i.createdAt||new Date),"dd/MM/yyyy HH:mm",{locale:Et}),b=()=>{l.current&&In().set({margin:2,filename:`ticket-${d}.pdf`,html2canvas:{scale:2},jsPDF:{unit:"mm",format:[80,200]}}).from(l.current).save()};return r("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:[e("style",{children:`
        @media print {
          body * { visibility: hidden !important; }
          #thermal-ticket, #thermal-ticket * { visibility: visible !important; }
          #thermal-ticket { position: absolute; left: 0; top: 0; width: 100%; }
          .no-print { display: none !important; }
        }
      `}),r("div",{id:"thermal-ticket",className:"ticket-force-light bg-white rounded-xl shadow-xl overflow-hidden",style:{width:"80mm",fontFamily:"monospace",fontSize:"12px",lineHeight:"1.5"},children:[r("div",{className:"no-print flex justify-between items-center px-4 py-3 border-b",children:[e("div",{className:"font-semibold",children:s.nom}),r("div",{className:"flex gap-2",children:[e("button",{onClick:b,children:"PDF"}),e("button",{onClick:()=>window.print(),children:"Imprimer"}),e("button",{onClick:t,children:"Fermer"})]})]}),r("div",{ref:l,className:"p-4 text-black",children:[r("div",{className:"text-center mb-3",children:[s.logoUrl&&e("img",{src:s.logoUrl,alt:"logo",style:{width:"60px",height:"60px",objectFit:"cover",borderRadius:"50%",border:"2px solid #000",margin:"0 auto"}}),e("div",{style:{fontWeight:"bold",fontSize:"14px",marginTop:"6px"},children:s.nom.toUpperCase()}),e("div",{style:{fontSize:"11px"},children:i.agencyNom||"Agence"})]}),e("hr",{}),r("div",{style:{textAlign:"center",margin:"6px 0"},children:[r("div",{style:{fontWeight:"bold"},children:["N¬∞ ",d]}),r("div",{style:{fontSize:"11px"},children:["√âmis le ",f]})]}),e("hr",{}),r("div",{style:{marginTop:"8px"},children:[r("div",{style:{display:"flex",justifyContent:"space-between"},children:[e("span",{children:"Passager :"}),e("span",{style:{fontWeight:"bold"},children:Qc(i.nomClient)})]}),r("div",{style:{display:"flex",justifyContent:"space-between"},children:[e("span",{children:"T√©l√©phone :"}),e("span",{children:i.telephone})]})]}),e("hr",{}),r("div",{style:{textAlign:"center",margin:"10px 0"},children:[r("div",{style:{fontWeight:"bold",fontSize:"14px",letterSpacing:"1px"},children:[i.depart.toUpperCase()," ‚Üí ",i.arrivee.toUpperCase()]}),r("div",{style:{marginTop:"4px"},children:[Jc(i.date)," ‚Ä¢ ",i.heure]}),r("div",{style:{fontSize:"11px"},children:[i.seatsGo," place(s) ‚Ä¢ guichet"]})]}),e("hr",{}),r("div",{style:{textAlign:"center",margin:"10px 0"},children:[e("div",{style:{fontSize:"16px",fontWeight:"bold"},children:n(i.montant)}),r("div",{style:{fontSize:"11px"},children:["Paiement : ",(i.paiement||"esp√®ces").toUpperCase()]})]}),e("hr",{}),e("div",{style:{marginTop:"12px",display:"flex",justifyContent:"center"},children:e(wi,{value:g,size:100,level:"H",fgColor:"#000000"})}),e("div",{style:{textAlign:"center",fontSize:"10px",marginTop:"6px"},children:"Validit√© : 1 mois √† compter de la date d‚Äô√©mission."}),e("hr",{}),r("div",{style:{textAlign:"center",fontSize:"10px",marginTop:"8px"},children:[e("div",{style:{fontWeight:"bold"},children:Er.control}),e("div",{children:Er.validity}),r("div",{children:["Merci d'avoir choisi ",s.nom]}),e("div",{style:{fontStyle:"italic"},children:Er.arrival}),e("div",{children:Er.keep})]})]})]})]})},Zc={active:{label:"Comptoir ouvert",dot:"bg-emerald-500",bg:"bg-emerald-50",text:"text-emerald-800"},paused:{label:"En pause",dot:"bg-amber-500",bg:"bg-amber-50",text:"text-amber-800"},pending:{label:"Activation en attente",dot:"bg-blue-500",bg:"bg-blue-50",text:"text-blue-800"},closed:{label:"Comptoir ferm√©",dot:"bg-gray-400",bg:"bg-gray-100",text:"text-gray-600"},none:{label:"Comptoir ferm√©",dot:"bg-gray-400",bg:"bg-gray-100",text:"text-gray-600"}};function ed(a){const t=Math.floor(a/1e3),i=Math.floor(t/3600),s=Math.floor(t%3600/60),n=t%60;return i>0?`${i}:${String(s).padStart(2,"0")}:${String(n).padStart(2,"0")}`:`${String(s).padStart(2,"0")}:${String(n).padStart(2,"0")}`}const td=({status:a,locked:t,userName:i,userCode:s,companyLogo:n,companyName:l,agencyName:d,sessionTickets:g,sessionRevenue:f,primaryColor:b,secondaryColor:I,sessionStartedAt:C,isOnline:A=!0,onStart:u,onPause:x,onContinue:h,onClose:L,onRefresh:E,onLogout:m})=>{const c=Zc[t?"none":a],w=`linear-gradient(135deg, ${b}, ${I})`,[N,R]=o.useState("");return o.useEffect(()=>{if(!C||!(a==="active"||a==="paused")){R("");return}const H=()=>R(ed(Date.now()-C.getTime()));H();const M=setInterval(H,1e3);return()=>clearInterval(M)},[C,a]),e("div",{className:"sticky top-0 z-20 bg-white border-b border-gray-200 shadow-sm",children:e("div",{className:"max-w-[1600px] mx-auto px-4 lg:px-6",children:r("div",{className:"h-16 flex items-center gap-4",children:[r("div",{className:"flex items-center gap-3 min-w-0 shrink-0",children:[n?e("img",{src:n,alt:"",className:"h-9 w-9 rounded-lg object-contain border bg-white p-0.5"}):e("div",{className:"h-9 w-9 rounded-lg bg-gray-100 grid place-items-center",children:e(io,{className:"w-4 h-4 text-gray-400"})}),r("div",{className:"min-w-0 hidden sm:block",children:[e("p",{className:"text-sm font-bold truncate",style:{color:b},children:l}),e("p",{className:"text-[11px] text-gray-500 truncate",children:d})]})]}),e("div",{className:"h-8 w-px bg-gray-200 hidden sm:block"}),r("div",{className:"flex items-center gap-2",children:[r("div",{className:`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold ${c.bg} ${c.text}`,children:[e("span",{className:`w-2 h-2 rounded-full ${c.dot} ${a==="active"?"animate-pulse":""}`}),t?"Verrouill√© (autre appareil)":c.label]}),!A&&r("div",{className:"flex items-center gap-1 px-2 py-1 rounded-full bg-red-50 text-red-700 text-[10px] font-semibold",children:[e(qs,{className:"w-3 h-3"}),"Hors-ligne"]})]}),(a==="active"||a==="paused")&&!t&&r("div",{className:"hidden md:flex items-center gap-4 text-sm",children:[N&&r("div",{className:"flex items-center gap-1.5 text-gray-500",children:[e(oo,{className:"w-3.5 h-3.5"}),e("span",{className:"font-mono text-xs tabular-nums",children:N})]}),r("div",{className:"flex items-center gap-1.5",children:[e("span",{className:"text-gray-500",children:"Billets"}),e("span",{className:"font-bold text-gray-900 bg-gray-100 px-2 py-0.5 rounded-md",children:g})]}),r("div",{className:"flex items-center gap-1.5",children:[e("span",{className:"text-gray-500",children:"Recette"}),e("span",{className:"font-bold rounded-md px-2 py-0.5",style:{background:`${b}15`,color:b},children:f})]})]}),e("div",{className:"flex-1"}),r("div",{className:"flex items-center gap-2",children:[a==="active"&&!t&&r(bt,{children:[r("button",{onClick:x,className:"inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition",children:[e(Dr,{className:"w-3.5 h-3.5"})," ",e("span",{className:"hidden sm:inline",children:"Pause"})]}),r("button",{onClick:()=>{window.confirm("Cl√¥turer le comptoir ? Vous ne pourrez plus vendre.")&&L()},className:"inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium text-white transition hover:opacity-90",style:{background:w},children:[e(Mr,{className:"w-3.5 h-3.5"})," ",e("span",{className:"hidden sm:inline",children:"Cl√¥turer"})]})]}),a==="paused"&&!t&&r(bt,{children:[r("button",{onClick:h,className:"inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium text-white transition hover:opacity-90",style:{background:w},children:[e(Jt,{className:"w-3.5 h-3.5"})," Reprendre"]}),r("button",{onClick:()=>{window.confirm("Cl√¥turer le comptoir ?")&&L()},className:"inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition",children:[e(Mr,{className:"w-3.5 h-3.5"})," Cl√¥turer"]})]}),a==="pending"&&r("button",{onClick:E,className:"inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition",children:[e(or,{className:"w-3.5 h-3.5"})," Actualiser"]}),(a==="none"||a==="closed")&&!t&&r("button",{onClick:u,className:"inline-flex items-center gap-1.5 px-4 py-2.5 rounded-lg text-sm font-bold text-white transition hover:opacity-90 shadow-md",style:{background:w},children:[e(Nn,{className:"w-4 h-4"})," Ouvrir le comptoir"]}),e("div",{className:"h-8 w-px bg-gray-200 ml-1"}),r("div",{className:"hidden lg:flex items-center gap-2 bg-gray-50 border rounded-lg px-2.5 py-1.5",children:[e("div",{className:"w-7 h-7 rounded-full bg-gray-200 grid place-items-center text-xs font-bold text-gray-600",children:i.charAt(0).toUpperCase()}),r("div",{className:"min-w-0",children:[e("p",{className:"text-xs font-medium text-gray-900 truncate max-w-[120px]",children:i}),e("p",{className:"text-[10px] text-gray-500",children:s})]})]}),e("button",{onClick:m,className:"p-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 transition",title:"Se d√©connecter",children:e(dr,{className:"w-4 h-4 text-gray-500"})})]})]})})})},ad=({departure:a,arrivals:t,selected:i,onSelect:s,primaryColor:n,showDepartureLabel:l=!1})=>{const[d,g]=o.useState(""),f=o.useMemo(()=>{if(!d.trim())return t;const b=d.trim().toLowerCase();return t.filter(I=>I.toLowerCase().includes(b))},[t,d]);return t.length===0?r("div",{className:"rounded-2xl border-2 border-dashed border-gray-200 p-8 text-center",children:[e(Ca,{className:"w-8 h-8 text-gray-300 mx-auto mb-2"}),r("p",{className:"text-sm text-gray-500",children:["D√©part : ",e("strong",{children:a||"‚Äî"})]}),e("p",{className:"text-sm text-gray-400 mt-2",children:"Aucune destination configur√©e. Contactez l'administrateur."})]}):r("div",{children:[l&&r("p",{className:"text-sm text-gray-500 mb-2",children:["D√©part : ",e("strong",{className:"text-gray-900",children:a||"‚Äî"})]}),r("div",{className:"relative mb-3",children:[e(_r,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e("input",{type:"text",value:d,onChange:b=>g(b.target.value),placeholder:"Rechercher une destination...",className:"w-full pl-9 pr-3 py-2.5 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:border-transparent",style:{"--tw-ring-color":`${n}40`},autoComplete:"off"})]}),e("div",{className:"grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2.5",children:f.map(b=>{const I=i.toLowerCase()===b.toLowerCase();return r("button",{type:"button",onClick:()=>s(b),className:`group relative flex items-center gap-3 px-4 py-3.5 rounded-xl border-2 transition-all duration-200 text-left ${I?"border-current shadow-md scale-[1.02]":"border-gray-200 bg-white hover:border-gray-300 hover:shadow-sm"}`,style:I?{borderColor:n,backgroundColor:`${n}08`}:void 0,children:[e("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center shrink-0 transition-colors ${I?"text-white":"bg-gray-100 text-gray-400 group-hover:bg-gray-200"}`,style:I?{backgroundColor:n}:void 0,children:e(lo,{className:"w-5 h-5"})}),r("div",{className:"min-w-0",children:[e("p",{className:`font-semibold truncate ${I?"":"text-gray-900"}`,style:I?{color:n}:void 0,children:b}),r("p",{className:"text-[11px] text-gray-400 truncate",children:[a," ‚Üí ",b]})]})]},b)})}),f.length===0&&d.trim()&&r("p",{className:"text-sm text-amber-600 mt-2",children:["Aucune ville ne correspond √† ¬´ ",d," ¬ª. Modifiez la recherche ou choisissez une autre destination."]})]})},rd={Mon:"Lun",Tue:"Mar",Wed:"Mer",Thu:"Jeu",Fri:"Ven",Sat:"Sam",Sun:"Dim"},nd=({dates:a,selected:t,hasTrips:i,onSelect:s,primaryColor:n})=>{const l=o.useRef(null);return o.useEffect(()=>{if(!l.current||!t)return;const d=l.current.querySelector("[data-active=true]");d==null||d.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})},[t]),e("div",{ref:l,className:"flex gap-1.5 overflow-x-auto pb-0.5 scrollbar-none -mx-0.5 px-0.5",children:a.map(d=>{const g=new Date(d+"T00:00:00"),f=i(d),b=t===d,I=g.toLocaleDateString("en-US",{weekday:"short"}),C=rd[I]||I,A=d===new Date().toISOString().split("T")[0];return r("button",{"data-active":b||void 0,disabled:!f,onClick:()=>f&&s(d),className:`shrink-0 w-11 py-1.5 rounded-lg border text-center transition-all duration-200
              ${b?"text-white shadow border-current":f?"border-gray-200 bg-white hover:border-gray-300":"border-gray-100 bg-gray-50 opacity-40 cursor-not-allowed"}`,style:b?{backgroundColor:n,borderColor:n}:void 0,children:[e("p",{className:`text-[10px] font-medium leading-tight ${b?"text-white/90":"text-gray-500"}`,children:C}),e("p",{className:`text-sm font-bold leading-tight ${b?"":"text-gray-900"}`,children:g.getDate()}),A&&e("div",{className:`mx-auto mt-0.5 w-0.5 h-0.5 rounded-full ${b?"bg-white":""}`,style:b?void 0:{backgroundColor:n}})]},d)})})};function sd(a,t){if(a===void 0)return{pct:0,color:"bg-gray-200",text:"Calcul‚Ä¶",textColor:"text-gray-500"};const i=Math.max(0,t-a),s=Math.min(100,Math.round(i/Math.max(1,t)*100));return a<=0?{pct:100,color:"bg-red-500",text:"Complet",textColor:"text-red-600"}:s>70?{pct:s,color:"bg-amber-500",text:`${a} place${a>1?"s":""}`,textColor:"text-amber-600"}:{pct:s,color:"bg-emerald-500",text:`${a} place${a>1?"s":""}`,textColor:"text-emerald-600"}}const id=({slots:a,selectedId:t,onSelect:i,formatMoney:s,primaryColor:n})=>a.length===0?r("div",{className:"py-4 text-center",children:[e(Or,{className:"w-5 h-5 text-gray-300 mx-auto mb-1"}),e("p",{className:"text-xs text-gray-400",children:"Aucun horaire pour cette date."})]}):r("div",{className:"max-h-[min(50vh,28rem)] overflow-y-auto overflow-x-hidden pr-1",children:[e("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-1.5",children:a.map(l=>{const d=t===l.id,g=sd(l.remainingSeats,l.places),f=l.remainingSeats!==void 0&&l.remainingSeats<=0;return r("button",{onClick:()=>!f&&i(l),disabled:f,className:`relative text-left p-2 rounded-lg border transition-all duration-200 ${f?"border-gray-100 bg-gray-50 opacity-60 cursor-not-allowed":d?"border-2 border-current shadow":"border-gray-200 bg-white hover:border-gray-300"}`,style:d?{borderColor:n,backgroundColor:`${n}08`}:void 0,children:[r("div",{className:"flex items-center justify-between gap-1",children:[e("span",{className:"text-sm font-bold truncate",style:d||!f?{color:n}:void 0,children:l.time}),e("span",{className:"text-xs font-semibold text-gray-700 shrink-0",children:s(l.price)})]}),r("p",{className:"text-[10px] text-gray-500 truncate mt-0.5",children:[l.departure," ‚Üí ",l.arrival]}),r("div",{className:"mt-1 flex items-center justify-between gap-0.5",children:[e("span",{className:`text-[10px] font-medium ${g.textColor}`,children:g.text}),e("div",{className:"h-1 flex-1 min-w-[2rem] bg-gray-100 rounded-full overflow-hidden max-w-[3rem]",children:e("div",{className:`h-full rounded-full ${g.color}`,style:{width:`${g.pct}%`}})})]})]},l.id)})}),a.length>12&&r("p",{className:"text-[10px] text-gray-400 text-center mt-1.5 pb-0.5",children:[a.length," d√©parts ‚Äî faites d√©filer pour voir tout"]})]});function Na(a){return a.trim().split(/\s+/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" ")}const Bn=8;function Ft(a){return(a||"").replace(/\D/g,"").slice(0,Bn)}function od(a){return Ft(a).length===Bn}function cr(a){const t=(a||"").replace(/\D/g,"").slice(0,Bn),i=[];for(let s=0;s<t.length;s+=2)i.push(t.slice(s,s+2));return i.join(" ")}const An=[{key:"plein",label:"Plein tarif",multiplier:1},{key:"enfant",label:"Enfant (‚àí50%)",multiplier:.5},{key:"senior",label:"Senior (‚àí25%)",multiplier:.75},{key:"fidelite",label:"Fid√©lit√© (‚àí10%)",multiplier:.9}],ld=({selectedTrip:a,canSell:t,status:i,nomClient:s,onNomChange:n,telephone:l,onTelChange:d,placesAller:g,onPlacesAllerChange:f,totalPrice:b,canValidate:I,isProcessing:C,onValidate:A,formatMoney:u,primaryColor:x,secondaryColor:h,validationHint:L,clientSuggestions:E=[],tariffKey:m="plein",onTariffChange:c,tariffMultiplier:w=1,additionalPassengers:N=[],onAdditionalPassengersChange:R})=>{var q,ye;const H=o.useRef(null),M=`linear-gradient(135deg, ${x}, ${h})`,[K,B]=o.useState(!1),[le,Q]=o.useState(!1),Z=o.useMemo(()=>{if(!s||s.length<2)return[];const se=s.toLowerCase();return E.filter(Y=>Y.name.toLowerCase().includes(se)||Y.phone.includes(se)).slice(0,6)},[s,E]);o.useEffect(()=>{var se;a&&t&&((se=H.current)==null||se.focus())},[a==null?void 0:a.time,t]);const j=se=>{se.key==="Enter"&&I&&!C&&(se.preventDefault(),A())},k=se=>{n(Na(se.name)),d(cr(Ft(se.phone))),B(!1)},W=()=>{const se=!le;if(Q(se),se&&R){const Y=Math.max(0,g-1);R(Array.from({length:Y},()=>({name:"",phone:""})))}else R&&R([])};return o.useEffect(()=>{if(!le||!R)return;const se=Math.max(0,g-1);if(N.length!==se){const Y=Array.from({length:se},(ue,T)=>N[T]||{name:"",phone:""});R(Y)}},[g,le]),w!==1?u(b)+` (${((q=An.find(se=>se.key===m))==null?void 0:q.label)||""})`:u(b),r("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden flex flex-col h-full min-h-0 max-h-[calc(100vh-10rem)]",children:[r("div",{className:"px-4 py-3 border-b border-gray-100 shrink-0",style:{background:`${x}08`},children:[r("div",{className:"flex items-center gap-1.5",children:[e(Yn,{className:"w-4 h-4",style:{color:x}}),e("h2",{className:"text-base font-bold text-gray-900",children:"Vente en cours"})]}),e("p",{className:"text-[11px] text-gray-500 mt-0.5",children:"Paiement : esp√®ces uniquement"})]}),r("div",{className:"flex-1 min-h-0 flex flex-col p-4",onKeyDown:j,children:[r("div",{className:"flex-1 min-h-0 overflow-y-auto space-y-3 pr-1 -mr-1",children:[!t&&r("div",{className:"flex items-start gap-2 p-3 rounded-xl bg-amber-50 border border-amber-200",children:[e(Ha,{className:"w-4 h-4 text-amber-600 shrink-0 mt-0.5"}),e("p",{className:"text-xs text-amber-800",children:i==="pending"?"En attente d'activation par la comptabilit√©.":"Ouvrez le comptoir pour commencer √† vendre."})]}),a?r("div",{className:"rounded-lg border-2 p-3",style:{borderColor:`${x}40`,backgroundColor:`${x}04`},children:[r("div",{className:"flex items-center justify-between",children:[r("div",{children:[r("p",{className:"font-semibold text-sm text-gray-900",children:[a.departure," ‚Üí ",a.arrival]}),e("p",{className:"text-[11px] text-gray-500 mt-0.5",children:new Date(a.date+"T00:00:00").toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})})]}),r("div",{className:"text-right",children:[e("span",{className:"text-base font-bold",style:{color:x},children:a.time}),r("p",{className:"text-[11px] text-gray-500",children:[u(a.price),"/place"]})]})]}),a.remainingSeats!==void 0&&r("div",{className:"mt-1.5 flex items-center gap-1",children:[e(xa,{className:"w-3 h-3 text-gray-400"}),r("span",{className:"text-[11px] text-gray-500",children:[a.remainingSeats," places dispo."]})]})]}):r("div",{className:"rounded-lg border-2 border-dashed border-gray-200 p-4 text-center",children:[e(xa,{className:"w-5 h-5 text-gray-300 mx-auto mb-0.5"}),e("p",{className:"text-xs text-gray-400",children:"S√©lectionnez un trajet"})]}),r("div",{className:"space-y-3",children:[r("div",{className:"relative",children:[r("div",{className:"flex items-center justify-between mb-1",children:[e("label",{className:"text-xs font-medium text-gray-500",children:"Passager *"}),R&&r("button",{type:"button",onClick:W,className:`inline-flex items-center gap-1 text-[10px] font-medium px-2 py-0.5 rounded-full transition ${le?"text-white":"text-gray-500 bg-gray-100 hover:bg-gray-200"}`,style:le?{background:x}:void 0,title:"Mode multi-passagers",children:[e(Tn,{className:"w-3 h-3"}),"Multi"]})]}),e("input",{ref:H,value:s,onChange:se=>{n(se.target.value),B(!0)},onFocus:()=>{s.length>=2&&Z.length>0&&B(!0)},onBlur:()=>{setTimeout(()=>B(!1),200);const se=Na(s);se!==s&&n(se)},placeholder:"Nom complet",className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:border-transparent transition",style:{"--tw-ring-color":`${x}40`},autoComplete:"off"}),K&&Z.length>0&&e("div",{className:"absolute z-30 left-0 right-0 top-full mt-1 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden max-h-48 overflow-y-auto",children:Z.map((se,Y)=>r("button",{type:"button",onMouseDown:ue=>{ue.preventDefault(),k(se)},className:"w-full px-3.5 py-2.5 text-left hover:bg-gray-50 transition flex items-center justify-between",children:[e("span",{className:"text-sm text-gray-900",children:se.name}),e("span",{className:"text-xs text-gray-400",children:se.phone})]},`${se.name}-${se.phone}-${Y}`))})]}),r("div",{children:[e("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"T√©l√©phone * (8 chiffres, Mali)"}),e("input",{value:l,onChange:se=>{const Y=Ft(se.target.value);d(cr(Y))},placeholder:"12 34 56 78",type:"tel",inputMode:"numeric",maxLength:11,className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:border-transparent transition",style:{"--tw-ring-color":`${x}40`},autoComplete:"off"})]})]}),le&&N.length>0&&r("div",{className:"space-y-2 p-3 rounded-xl bg-gray-50 border border-gray-200",children:[r("div",{className:"flex items-center gap-1.5 mb-1",children:[e(ir,{className:"w-3.5 h-3.5 text-gray-400"}),e("span",{className:"text-xs font-medium text-gray-600",children:"Passagers suppl√©mentaires"})]}),N.map((se,Y)=>r("div",{className:"flex gap-2",children:[e("input",{value:se.name,onChange:ue=>{const T=[...N];T[Y]={...T[Y],name:ue.target.value},R==null||R(T)},onBlur:()=>{const ue=Na(se.name);if(ue!==se.name&&N[Y]){const T=[...N];T[Y]={...T[Y],name:ue},R==null||R(T)}},placeholder:`Passager ${Y+2}`,className:"flex-1 border border-gray-200 rounded-lg px-2.5 py-2 text-xs"}),e("input",{value:se.phone,onChange:ue=>{const T=[...N],ce=Ft(ue.target.value);T[Y]={...T[Y],phone:cr(ce)},R==null||R(T)},placeholder:"12 34 56 78",type:"tel",inputMode:"numeric",maxLength:11,className:"w-28 border border-gray-200 rounded-lg px-2.5 py-2 text-xs"})]},Y))]}),r("div",{className:"flex items-center gap-2",children:[e("span",{className:"text-xs font-medium text-gray-500 shrink-0",children:"Places"}),r("div",{className:"flex items-center gap-0 flex-1 min-w-0",children:[e("button",{type:"button",onClick:()=>f(Math.max(1,g-1)),className:"w-7 h-7 rounded-l-lg border border-gray-300 bg-white hover:bg-gray-50 transition flex items-center justify-center shrink-0",children:e(co,{className:"w-3 h-3 text-gray-600"})}),e("div",{className:"flex-1 min-w-[2rem] h-7 border-y border-gray-300 bg-gray-50 flex items-center justify-center",children:e("span",{className:"text-sm font-bold text-gray-900",children:g})}),e("button",{type:"button",onClick:()=>f(g+1),className:"w-7 h-7 rounded-r-lg border border-gray-300 bg-white hover:bg-gray-50 transition flex items-center justify-center shrink-0",children:e(Ka,{className:"w-3 h-3 text-gray-600"})})]})]})]}),r("div",{className:"shrink-0 space-y-1.5 mt-3 pt-3 border-t border-gray-100",children:[e("div",{className:"rounded-lg p-3",style:{background:`${x}08`},children:r("div",{className:"flex items-center justify-between",children:[r("div",{children:[e("span",{className:"text-xs font-medium text-gray-600",children:"Total √† encaisser"}),w!==1&&e("p",{className:"text-[10px] text-gray-400",children:(ye=An.find(se=>se.key===m))==null?void 0:ye.label})]}),e("span",{className:"text-2xl font-bold tracking-tight",style:{color:x},children:u(b)})]})}),!I&&a&&L&&e("p",{className:"text-[11px] text-center text-gray-400 px-1",children:L}),e("button",{onClick:A,disabled:!I||C,className:"w-full py-3 rounded-lg text-white font-semibold text-sm transition shadow-md disabled:shadow-none disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg active:scale-[0.99]",style:{background:I?M:"#9CA3AF"},children:C?r("span",{className:"inline-flex items-center gap-1.5",children:[e(rt,{className:"w-4 h-4 animate-spin"})," Traitement‚Ä¶"]}):r("span",{className:"inline-flex items-center gap-1.5",children:[e(Yn,{className:"w-4 h-4"})," Encaisser"]})})]})]})]})},cd=({sales:a,formatMoney:t,primaryColor:i,onResell:s})=>{const n=aa(),l=a.filter(d=>d.montant>0&&d.statutEmbarquement!=="annul√©").slice(-8).reverse();return l.length===0?r("div",{className:"py-6 text-center",children:[e(uo,{className:"w-6 h-6 text-gray-300 mx-auto mb-1"}),e("p",{className:"text-sm text-gray-400",children:"Aucune vente pour cette session."})]}):e("div",{className:"overflow-x-auto",children:e("div",{className:"flex gap-2.5 pb-1 min-w-0",children:l.map(d=>r("div",{className:"shrink-0 w-[260px] bg-white rounded-xl border border-gray-200 p-3.5 hover:shadow-sm transition group",children:[r("div",{className:"flex items-start justify-between gap-2",children:[r("div",{className:"min-w-0",children:[e("p",{className:"text-sm font-semibold text-gray-900 truncate",children:d.nomClient}),r("p",{className:"text-xs text-gray-500 mt-0.5",children:[d.depart," ‚Üí ",d.arrivee," ‚Ä¢ ",d.heure]})]}),e("span",{className:"text-sm font-bold shrink-0",style:{color:i},children:t(d.montant)})]}),r("div",{className:"flex items-center justify-between mt-2.5 pt-2.5 border-t border-gray-100",children:[e("code",{className:"text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded",children:d.referenceCode||d.id.slice(0,8)}),r("div",{className:"flex items-center gap-1",children:[r("span",{className:"text-[10px] text-gray-400",children:[d.seatsGo+(d.seatsReturn||0)," billet(s)"]}),s&&e("button",{onClick:()=>s(d),className:"p-1.5 rounded-lg hover:bg-blue-50 transition opacity-0 group-hover:opacity-100",title:"Revendre le m√™me trajet",children:e(Gs,{className:"w-3.5 h-3.5 text-blue-500"})}),e("button",{onClick:()=>n(`/agence/receipt/${d.referenceCode||d.id}`),className:"p-1.5 rounded-lg hover:bg-gray-100 transition opacity-0 group-hover:opacity-100",title:"R√©imprimer le re√ßu",children:e(Vr,{className:"w-3.5 h-3.5 text-gray-500"})})]})]})]},d.id))})})},ps=({status:a,locked:t,primaryColor:i,secondaryColor:s,onStart:n,onRefresh:l})=>{const d=`linear-gradient(135deg, ${i}, ${s})`;return e("div",{className:"flex-1 flex items-center justify-center p-8",children:r("div",{className:"max-w-md w-full text-center space-y-6",children:[r("div",{className:"relative mx-auto w-24 h-24",children:[e("div",{className:"absolute inset-0 rounded-full opacity-20 animate-ping",style:{backgroundColor:i}}),e("div",{className:"relative w-24 h-24 rounded-full bg-gray-100 grid place-items-center mx-auto",children:t?e(mo,{className:"w-10 h-10 text-gray-400"}):a==="pending"?e("div",{className:"w-10 h-10 rounded-full border-4 border-gray-300 border-t-current animate-spin",style:{borderTopColor:i}}):e(Nn,{className:"w-10 h-10 text-gray-400"})})]}),r("div",{children:[e("h2",{className:"text-2xl font-bold text-gray-900",children:t?"Comptoir verrouill√©":a==="pending"?"Activation en cours‚Ä¶":"Comptoir ferm√©"}),e("p",{className:"text-gray-500 mt-2 text-sm max-w-xs mx-auto",children:t?"Ce poste est d√©j√† ouvert sur un autre appareil. Fermez-le l√†-bas ou contactez la comptabilit√©.":a==="pending"?"Votre demande a √©t√© envoy√©e. La comptabilit√© doit activer votre poste.":"Ouvrez le comptoir pour commencer √† vendre des billets."})]}),t?r("div",{className:"flex items-center gap-2 justify-center text-sm text-amber-700 bg-amber-50 rounded-xl p-3",children:[e($n,{className:"w-4 h-4"}),e("span",{children:"Session verrouill√©e par un autre appareil"})]}):a==="pending"?e("button",{onClick:l,className:"inline-flex items-center gap-2 px-6 py-3 rounded-xl text-sm font-medium border-2 border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition",children:"V√©rifier le statut"}):r("button",{onClick:n,className:"inline-flex items-center gap-2 px-8 py-4 rounded-xl text-lg font-bold text-white shadow-xl hover:shadow-2xl hover:scale-[1.02] active:scale-[0.98] transition-all duration-200",style:{background:d},children:[e(Nn,{className:"w-5 h-5"}),"Ouvrir le comptoir"]})]})})},dd=({message:a,visible:t,primaryColor:i,type:s="success"})=>{const[n,l]=o.useState(!1);if(o.useEffect(()=>{if(t)l(!0);else{const b=setTimeout(()=>l(!1),300);return()=>clearTimeout(b)}},[t]),!n&&!t)return null;const d=s==="error",g=d?"linear-gradient(135deg, #DC2626, #DC2626DD)":`linear-gradient(135deg, ${i}, ${i}DD)`,f=d?"#DC262660":`${i}60`;return e("div",{className:`fixed top-20 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 ${t?"opacity-100 translate-y-0":"opacity-0 -translate-y-4"}`,children:r("div",{className:"flex items-center gap-3 px-5 py-3.5 rounded-xl shadow-xl border text-white",style:{background:g,borderColor:f},children:[d?e(Mr,{className:"w-5 h-5 shrink-0"}):e(va,{className:"w-5 h-5 shrink-0"}),e("p",{className:"text-sm font-medium",children:a})]})})};function gs(a){const t=Math.floor(a/1e3),i=Math.floor(t/3600),s=Math.floor(t%3600/60);return i>0?`${i}h ${String(s).padStart(2,"0")}min`:`${s} min`}const ud=({open:a,tickets:t,sessionStart:i,sessionEnd:s,userName:n,userCode:l,formatMoney:d,primaryColor:g,secondaryColor:f,onPrint:b,onClose:I})=>{const C=o.useMemo(()=>{const x=t.filter(c=>c.statutEmbarquement!=="annul√©"&&c.montant>0),h=t.filter(c=>c.statutEmbarquement==="annul√©"||c.montant===0),L=x.reduce((c,w)=>c+(w.seatsGo||0)+(w.seatsReturn||0),0),E=x.reduce((c,w)=>c+(w.montant||0),0),m={};for(const c of x){const w=`${c.depart}‚Üí${c.arrivee}`;m[w]||(m[w]={route:w,billets:0,montant:0}),m[w].billets+=(c.seatsGo||0)+(c.seatsReturn||0),m[w].montant+=c.montant||0}return{totalSeats:L,totalRevenue:E,canceledCount:h.length,routes:Object.values(m)}},[t]),A=i&&s?gs(s.getTime()-i.getTime()):i?gs(Date.now()-i.getTime()):"‚Äî";if(!a)return null;const u=`linear-gradient(135deg, ${g}, ${f})`;return e("div",{className:"fixed inset-0 z-50 grid place-items-center bg-black/40 p-4",children:r("div",{className:"w-full max-w-lg bg-white rounded-2xl shadow-2xl border overflow-hidden",children:[r("div",{className:"px-6 py-5 border-b border-gray-100 flex items-center justify-between",style:{background:`${g}08`},children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"w-10 h-10 rounded-full grid place-items-center text-white",style:{background:u},children:e(Gt,{className:"w-5 h-5"})}),r("div",{children:[e("h2",{className:"text-lg font-bold text-gray-900",children:"Session cl√¥tur√©e"}),r("p",{className:"text-xs text-gray-500",children:[n," (",l,")"]})]})]}),e("button",{onClick:I,className:"p-2 rounded-lg hover:bg-gray-100 transition",children:e(Ia,{className:"w-5 h-5 text-gray-400"})})]}),r("div",{className:"p-6 space-y-5",children:[r("div",{className:"grid grid-cols-3 gap-3",children:[r("div",{className:"bg-gray-50 rounded-xl p-3 text-center",children:[e(xa,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),e("p",{className:"text-2xl font-black",style:{color:g},children:C.totalSeats}),e("p",{className:"text-[11px] text-gray-500",children:"Billets vendus"})]}),r("div",{className:"bg-gray-50 rounded-xl p-3 text-center",children:[e(Mt,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),e("p",{className:"text-2xl font-black",style:{color:g},children:d(C.totalRevenue)}),e("p",{className:"text-[11px] text-gray-500",children:"Recette totale"})]}),r("div",{className:"bg-gray-50 rounded-xl p-3 text-center",children:[e(Or,{className:"w-5 h-5 mx-auto text-gray-400 mb-1"}),e("p",{className:"text-2xl font-black text-gray-900",children:A}),e("p",{className:"text-[11px] text-gray-500",children:"Dur√©e"})]})]}),C.canceledCount>0&&r("div",{className:"text-xs text-center text-red-600 bg-red-50 rounded-lg py-1.5",children:[C.canceledCount," annulation",C.canceledCount>1?"s":""]}),C.routes.length>0&&r("div",{children:[e("h3",{className:"text-sm font-semibold text-gray-700 mb-2",children:"R√©partition par trajet"}),e("div",{className:"rounded-xl border border-gray-200 overflow-hidden",children:r("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gray-50/60 border-b border-gray-200",children:r("tr",{children:[e("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500",children:"Trajet"}),e("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500",children:"Billets"}),e("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500",children:"Montant"})]})}),e("tbody",{className:"divide-y divide-gray-100",children:C.routes.map(x=>r("tr",{children:[e("td",{className:"px-4 py-2 text-gray-700",children:x.route}),e("td",{className:"px-4 py-2 text-right text-gray-700",children:x.billets}),e("td",{className:"px-4 py-2 text-right font-medium text-gray-900",children:d(x.montant)})]},x.route))})]})})]}),r("div",{className:"flex items-center justify-between text-xs text-gray-400 bg-gray-50 rounded-lg px-4 py-2",children:[r("span",{children:["D√©but : ",i?i.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):"‚Äî"]}),r("span",{children:["Fin : ",s?s.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})]})]})]}),r("div",{className:"px-6 py-4 border-t border-gray-100 flex justify-end gap-2",children:[r("button",{onClick:b,className:"inline-flex items-center gap-2 px-4 py-2.5 rounded-xl border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition",children:[e(Vr,{className:"w-4 h-4"})," Imprimer le r√©sum√©"]}),e("button",{onClick:I,className:"px-5 py-2.5 rounded-xl text-sm font-bold text-white transition hover:opacity-90",style:{background:u},children:"Fermer"})]})]})})};let un=null;function fs(){return un||(un=new AudioContext),un}const md="/splash/son.mp3";function hd(a,t){const i=a.createOscillator(),s=a.createGain();i.connect(s),s.connect(a.destination),i.type="sine",i.frequency.setValueAtTime(1760,t),i.frequency.exponentialRampToValueAtTime(1320,t+.06),s.gain.setValueAtTime(0,t),s.gain.linearRampToValueAtTime(.2,t+.02),s.gain.exponentialRampToValueAtTime(.001,t+.1),i.start(t),i.stop(t+.1);const n=a.createOscillator(),l=a.createGain();n.connect(l),l.connect(a.destination),n.type="sine",n.frequency.setValueAtTime(880,t+.08),n.frequency.exponentialRampToValueAtTime(520,t+.22),l.gain.setValueAtTime(0,t+.08),l.gain.linearRampToValueAtTime(.22,t+.1),l.gain.exponentialRampToValueAtTime(.001,t+.35),n.start(t+.08),n.stop(t+.35)}function ja(a){try{if(a==="success"){const s=new Audio(md);let n=!1;const l=()=>{if(!n){n=!0;try{const d=fs();hd(d,d.currentTime)}catch{}}};s.addEventListener("error",l),s.play().catch(l);return}const t=fs(),i=t.currentTime;switch(a){case"error":{const s=t.createOscillator(),n=t.createGain();s.connect(n),n.connect(t.destination),s.type="square",s.frequency.setValueAtTime(200,i),s.frequency.setValueAtTime(150,i+.1),n.gain.setValueAtTime(.12,i),n.gain.exponentialRampToValueAtTime(.001,i+.15),s.start(i),s.stop(i+.15);const l=t.createOscillator(),d=t.createGain();l.connect(d),d.connect(t.destination),l.type="square",l.frequency.setValueAtTime(200,i+.18),l.frequency.setValueAtTime(150,i+.28),d.gain.setValueAtTime(.12,i+.18),d.gain.exponentialRampToValueAtTime(.001,i+.35),l.start(i+.18),l.stop(i+.35);break}case"close":{const s=t.createOscillator(),n=t.createGain();s.connect(n),n.connect(t.destination),s.type="sine",s.frequency.setValueAtTime(660,i),s.frequency.linearRampToValueAtTime(440,i+.2),s.frequency.linearRampToValueAtTime(330,i+.4),n.gain.setValueAtTime(.12,i),n.gain.exponentialRampToValueAtTime(.001,i+.5),s.start(i),s.stop(i+.5);break}case"click":{const s=t.createOscillator(),n=t.createGain();s.connect(n),n.connect(t.destination),s.type="sine",s.frequency.setValueAtTime(1e3,i),n.gain.setValueAtTime(.05,i),n.gain.exponentialRampToValueAtTime(.001,i+.05),s.start(i),s.stop(i+.05);break}}}catch{}}const pd={PAYE:"paye",ANNULE:"annule",CONFIRME:"confirme"},Qt={EMBARQUE:"embarqu√©",ANNULE:"annul√©"},ys={GUICHET:"guichet"},bs=8,kr=30,xs="compagnie-par-defaut";function mn(a,t,i){const s=i.filter(n=>n.trajetId===t&&(Ot(n.statut)==="paye"||Ot(n.statut)==="confirme")).reduce((n,l)=>n+(l.seatsGo||0),0);return Math.max(0,a-s)}async function gd(a){if(!a)return null;try{const t=await He(pe($,"users",a));if(!t.exists())return null;const i=t.data();return i.staffCode||i.codeCourt||i.code||null}catch{return null}}async function fd(a){const{companyId:t,companyCode:i="COMP",agencyCode:s="AGC",tripInstanceId:n,sellerCode:l}=a,d=pe($,`companies/${t}/counters/byTrip/trips/${n}`),g=await Ut($,async f=>{const b=await f.get(d),C=(b.exists()&&b.data().lastSeq||0)+1;return b.exists()?f.update(d,{lastSeq:C,updatedAt:We.now()}):f.set(d,{lastSeq:C,updatedAt:We.now()}),C}).catch(async()=>(await jt(d,{lastSeq:1,updatedAt:We.now()},{merge:!0}),1));return`${i}-${s}-${l}-${String(g).padStart(3,"0")}`}const hn=a=>od(a),yd=()=>{var ze;const a=Ke(),{user:t,company:i,signOutSafe:s}=a??{},n=Nt(),l=zc(),{activeShift:d,startShift:g,pauseShift:f,continueShift:b,closeShift:I,refresh:C,sessionLockedByOtherDevice:A}=l,u=Lt(i)||{primary:"#EA580C",secondary:"#F97316"},x=br(),[h,L]=Gr(),[E,m]=o.useState("vente"),[c,w]=o.useState(0),N=o.useCallback(S=>{m(S),w(X=>X+1)},[]),[R,H]=o.useState({name:"Compagnie",code:"COMP",slug:xs,logo:null,phone:""}),[M,K]=o.useState({name:"Agence",code:"AGC",phone:""}),[B,le]=o.useState(""),[Q,Z]=o.useState([]),[j,k]=o.useState(""),[W,q]=o.useState(""),[ye,se]=o.useState([]),[Y,ue]=o.useState([]),[T,ce]=o.useState(null),[Ie,Ve]=o.useState(""),[Fe,te]=o.useState(""),[Ae,ke]=o.useState(1),[Pe,je]=o.useState(!1),[D,G]=o.useState([]),[y,P]=o.useState(!0),[F,z]=o.useState(!1),[ee,ne]=o.useState(""),[Ne,ge]=o.useState("plein"),[p,V]=o.useState([]),[re,fe]=o.useState(!1),[Ce,Se]=o.useState(null),[De,Ze]=o.useState([]),[nt,ct]=o.useState(!1),[wt,ut]=o.useState([]),[Pt,vt]=o.useState([]),[Ea,la]=o.useState(!1),[Vt,ka]=o.useState(!1),[st,Ct]=o.useState(!1),[it,yt]=o.useState(null),[Ue,Xa]=o.useState(null),[ra,Kr]=o.useState(""),[ca,vr]=o.useState(!1),[da,Yr]=o.useState("success"),[ua,ma]=o.useState(!1),[Le,Ra]=o.useState(null),[Qa,Ja]=o.useState(!1),[zt,Nr]=o.useState(null),[qt,Ta]=o.useState("GUEST"),Ye=(t==null?void 0:t.staffCode)||(t==null?void 0:t.codeCourt)||(t==null?void 0:t.code)||"GUEST",at=(d==null?void 0:d.status)??"none",Ht=at==="active"&&!!(t!=null&&t.companyId)&&!!(t!=null&&t.agencyId)&&!A,Wr=at==="active"||at==="paused",wr=o.useMemo(()=>{const S=(d==null?void 0:d.startAt)??(d==null?void 0:d.startTime);return S?typeof S.toDate=="function"?S.toDate():new Date(S):null},[d==null?void 0:d.startAt,d==null?void 0:d.startTime]),ha=((ze=An.find(S=>S.key===Ne))==null?void 0:ze.multiplier)??1,Xr=o.useMemo(()=>{const S=new Map;for(const X of D){if(!X.nomClient)continue;const oe=X.nomClient.toLowerCase().trim();S.has(oe)||S.set(oe,{name:X.nomClient,phone:X.telephone||""})}return Array.from(S.values())},[D]),Da=o.useCallback((S,X="success")=>{Kr(S),Yr(X),vr(!0),setTimeout(()=>vr(!1),3500)},[]),Qr=o.useCallback(async()=>{try{if(typeof s=="function"){await s();return}if(typeof(a==null?void 0:a.logout)=="function"){await a.logout();return}window.location.href="/login"}catch{window.location.href="/login"}},[s,a]),Jr=o.useMemo(()=>Array.from({length:bs},(S,X)=>{const oe=new Date;return oe.setDate(oe.getDate()+X),oe.toISOString().split("T")[0]}),[]),$a=o.useCallback((S,X)=>{const[oe,be]=X.split(":").map(Number),me=new Date(S);return me.setHours(oe,be,0,0),me.getTime()<Date.now()},[]);o.useEffect(()=>{const S=X=>{const oe=document.activeElement,be=oe instanceof HTMLInputElement||oe instanceof HTMLTextAreaElement||oe instanceof HTMLSelectElement;if(X.key==="Escape"){if(ua){ma(!1),Ra(null);return}if(st){Ct(!1);return}if(re){fe(!1);return}if(T){ce(null);return}}if(X.key==="F2"){X.preventDefault();const me=["vente","rapport","historique"],J=me.indexOf(E);N(me[(J+1)%me.length]);return}if(X.ctrlKey&&X.key.toLowerCase()==="p"){if(X.preventDefault(),it){Ct(!0);return}window.print();return}if(!be){if(X.key==="+"||X.key==="="){X.preventDefault(),ke(me=>me+1);return}if(X.key==="-"&&Ae>1){X.preventDefault(),ke(me=>Math.max(1,me-1));return}}};return window.addEventListener("keydown",S),()=>window.removeEventListener("keydown",S)},[ua,st,re,T,E,N,it,Ae]),o.useEffect(()=>{(async()=>{try{if(t!=null&&t.uid){const J=await gd(t.uid);J&&Ta(J)}if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const S=await He(pe($,"companies",t.companyId));if(S.exists()){const J=S.data(),xe=J.nom||J.name||"Compagnie";H({name:xe,code:Fr(xe,J.code),slug:J.slug||xs,logo:J.logoUrl||J.logo||null,phone:J.telephone||""})}const X=await He(pe($,`companies/${t.companyId}/agences/${t.agencyId}`));if(X.exists()){const J=X.data(),xe=(J==null?void 0:J.ville)||(J==null?void 0:J.city)||(J==null?void 0:J.nomVille)||(J==null?void 0:J.villeDepart)||"";le((xe||"").toString()),K({name:(J==null?void 0:J.nomAgence)||(J==null?void 0:J.nom)||xe||"Agence",code:Fr((J==null?void 0:J.nomAgence)||(J==null?void 0:J.nom)||xe,J==null?void 0:J.code),phone:(J==null?void 0:J.telephone)||""})}const oe=he($,`companies/${t.companyId}/agences/${t.agencyId}/weeklyTrips`),be=await Ee(Te(oe,ae("active","==",!0))),me=Array.from(new Set(be.docs.map(J=>J.data().arrival).filter(Boolean))).sort((J,xe)=>J.localeCompare(xe,"fr"));Z(me)}catch(S){console.error("[GUICHET] init:error",S)}})()},[t==null?void 0:t.uid,t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),o.useEffect(()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const S=he($,`companies/${t.companyId}/agences/${t.agencyId}/reservations`),X=Te(S,Rt("createdAt","asc")),oe=Ge(X,be=>{const me=be.docs.map(J=>{const xe=J.data();return{id:J.id,referenceCode:xe.referenceCode,date:xe.date,heure:xe.heure,depart:xe.depart,arrivee:xe.arrivee,nomClient:xe.nomClient,telephone:xe.telephone,seatsGo:xe.seatsGo||1,seatsReturn:xe.seatsReturn||0,montant:xe.montant||0,canal:xe.canal,statutEmbarquement:xe.statutEmbarquement,statut:xe.statut,trajetId:xe.trajetId,shiftId:xe.shiftId,createdAt:xe.createdAt,guichetierCode:xe.guichetierCode||""}});G(me),se(J=>J.map(xe=>({...xe,remainingSeats:mn(xe.places||kr,xe.id,me)})))});return()=>oe()},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]);const pa=o.useCallback(async(S,X,oe,be,me=!1)=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const xe=(be??ye).map($e=>$e.date!==S?$e:{...$e,remainingSeats:mn($e.places||kr,$e.id,D)}),Oe=xe.filter($e=>$e.date===S&&!$a($e.date,$e.time)).sort(($e,Be)=>$e.time.localeCompare(Be.time));if(ue(Oe),me&&Oe.length>0){const $e=Oe.find(Be=>Be.remainingSeats===void 0?!0:Be.remainingSeats>0)||Oe[0];ce(Be=>Be??$e)}se(xe)},[$a,t==null?void 0:t.companyId,t==null?void 0:t.agencyId,D,ye]),Kt=o.useCallback(async(S,X)=>{var $e;if(se([]),ue([]),ce(null),q(""),!S||!X||!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const oe=he($,`companies/${t.companyId}/agences/${t.agencyId}/weeklyTrips`),be=(await Ee(Te(oe,ae("active","==",!0)))).docs.map(Be=>({id:Be.id,...Be.data()})),me=[],J=new Date;for(let Be=0;Be<bs;Be++){const mt=new Date(J);mt.setDate(J.getDate()+Be);const ga=mt.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase(),Yt=mt.toISOString().split("T")[0];be.forEach(ht=>{var fa;!ht.active||(ht.departure||"").toLowerCase().trim()!==S.toLowerCase().trim()||(ht.arrival||"").toLowerCase().trim()!==X.toLowerCase().trim()||(((fa=ht.horaires)==null?void 0:fa[ga])||[]).forEach(er=>{me.push({id:`${ht.id}_${Yt}_${er}`,date:Yt,time:er,departure:ht.departure,arrival:ht.arrival,price:ht.price,places:ht.places||kr,remainingSeats:mn(ht.places||kr,`${ht.id}_${Yt}_${er}`,D)})})})}me.sort((Be,mt)=>Be.date.localeCompare(mt.date)||Be.time.localeCompare(mt.time));const xe=me.filter(Be=>!$a(Be.date,Be.time));se(xe);const Oe=(($e=xe[0])==null?void 0:$e.date)||"";q(Oe),ce(null),Oe?await pa(Oe,S,X,xe,!0):ue([])},[$a,t==null?void 0:t.agencyId,t==null?void 0:t.companyId,pa,D]),Ma=o.useRef(Kt);Ma.current=Kt,o.useEffect(()=>{if(!j){se([]),ue([]),ce(null),q("");return}Ma.current(B,j)},[j,B]);const _a=o.useCallback(async S=>{q(S),ce(null),await pa(S,B,j,void 0,!0)},[j,B,pa]),Bt=o.useCallback(S=>{if(!Ht)return;const X=Q.find(oe=>oe.toLowerCase()===S.arrivee.toLowerCase());X&&X!==j&&k(X),N("vente"),y&&ja("click")},[Ht,Q,j,N,y]),St=o.useMemo(()=>T?Math.max(0,Math.round(T.price*Math.max(0,Ae)*ha)):0,[T,Ae,ha]),Za=o.useMemo(()=>!(!Ht||!T||T.remainingSeats!==void 0&&T.remainingSeats<=0||Ae<=0||T.remainingSeats!==void 0&&Ae>T.remainingSeats||!Ie.trim()||!hn(Fe)||St<=0||Pe),[Ht,T,Ae,Ie,Fe,St,Pe]),Zr=o.useMemo(()=>T?Ie.trim()?Fe?hn(Fe)?St<=0?"Montant invalide":T.remainingSeats!==void 0&&T.remainingSeats<=0?"Plus de places disponibles":T.remainingSeats!==void 0&&Ae>T.remainingSeats?"Pas assez de places":"Remplissez tous les champs obligatoires":"T√©l√©phone invalide (8 chiffres, Mali)":"Entrez un num√©ro de t√©l√©phone":"Entrez le nom du passager":"",[T,Ie,Fe,St,Ae]),en=o.useCallback(async()=>{if(!T||!Ie||!Fe)return;const S=Na(Ie);if(!x){Da("Pas de connexion internet. R√©essayez.","error"),y&&ja("error");return}const X=i,oe=(X==null?void 0:X.subscriptionStatus)??"active",be=ql(oe,"CREATE_RESERVATION");if(!be.allowed){alert(be.reason||"Action non autoris√©e.");return}if(!Ht){alert(A?"Poste ouvert sur un autre appareil.":"Ouvrez votre comptoir.");return}if(!hn(Fe)){alert("T√©l√©phone invalide.");return}if(T.remainingSeats!==void 0&&Ae>T.remainingSeats){alert(`Il reste ${T.remainingSeats} places.`);return}je(!0);try{const me=await fd({companyId:t.companyId,companyCode:R.code,agencyId:t.agencyId,agencyCode:M.code,tripInstanceId:T.id,sellerCode:qt||Ye}),J=p.length>0?[{name:S,phone:Ft(Fe)},...p.filter($e=>$e.name.trim()).map($e=>({name:Na($e.name),phone:Ft($e.phone)}))]:void 0,xe=await Kc({companyId:t.companyId,agencyId:t.agencyId,userId:t.uid,sessionId:d.id,userCode:qt||Ye,trajetId:T.id,date:T.date,heure:T.time,depart:T.departure,arrivee:T.arrival,nomClient:S,telephone:Ft(Fe)||null,seatsGo:Ae,seatsReturn:0,montant:St,companySlug:R.slug,compagnieNom:R.name,agencyNom:M.name,agencyTelephone:M.phone??null,referenceCode:me,tripType:"aller_simple",...Ne!=="plein"?{tariff:Ne,tariffMultiplier:ha}:{},...J?{passengers:J}:{}},{deviceFingerprint:xr()});yt({id:xe,nomClient:S,telephone:Ft(Fe)||Fe,date:T.date,heure:T.time,depart:T.departure,arrivee:T.arrival,seatsGo:Ae,seatsReturn:0,montant:St,statut:pd.PAYE,paiement:"esp√®ces",agencyNom:M.name,agenceTelephone:M.phone,createdAt:new Date,referenceCode:me}),Xa({nom:R.name,logoUrl:R.logo||void 0,couleurPrimaire:u.primary,couleurSecondaire:u.secondary,slug:R.slug,telephone:R.phone||void 0}),Ct(!0);const Oe=`R√©servation confirm√©e ‚Äî ${S} ‚Ä¢ ${Ae} place(s) ‚Ä¢ ${n(St)}`;Da(Oe),y&&ja("success"),F&&setTimeout(()=>window.print(),500),Ve(""),te(""),ke(1),ge("plein"),V([])}catch(me){console.error("[GUICHET] reservation:error",me),Da("Erreur lors de la r√©servation.","error"),y&&ja("error")}finally{je(!1)}},[T,Ie,Fe,Ht,Ae,St,t,d,R,M,qt,Ye,u,i,A,y,n,x,Da,F,Ne,ha,p]),Cr=o.useCallback(async S=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;if(S.canal&&S.canal!==ys.GUICHET){alert("Annulation uniquement pour les ventes guichet.");return}if(S.statutEmbarquement===Qt.EMBARQUE){alert("Impossible : passager embarqu√©.");return}if(S.statutEmbarquement===Qt.ANNULE||S.montant===0){alert("D√©j√† annul√©.");return}const X=prompt("Motif d'annulation (min. 5 caract√®res) :")||"";if(!X.trim()||X.length<5){alert("Motif requis (min. 5 caract√®res).");return}if(window.confirm(`Annuler la r√©servation de ${S.nomClient} (${n(S.montant)}) ?`)){Nr(S.id);try{const oe=pe($,`companies/${t.companyId}/agences/${t.agencyId}/reservations/${S.id}`);await Ml(oe,"annulation_en_attente",{userId:t.uid,userRole:(t==null?void 0:t.role)??"guichetier"},{statutEmbarquement:Qt.ANNULE,montantOriginal:S.montant,montant:0,cancelReason:X.trim(),canceledBy:{id:t.uid,name:t.displayName||t.email||null,code:qt,timestamp:Re()},annulation:{demandePar:t.uid,demandeLe:Re(),motif:X.trim(),canal:"guichet"}}),Ze(be=>be.map(me=>me.id===S.id?{...me,montant:0,statut:"annulation_en_attente",statutEmbarquement:Qt.ANNULE}:me)),y&&ja("error")}catch{alert("√âchec de l'annulation.")}finally{Nr(null)}}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,t==null?void 0:t.uid,t==null?void 0:t.displayName,t==null?void 0:t.email,qt,n,y]),v=o.useCallback(S=>{if(S.statutEmbarquement===Qt.EMBARQUE){alert("Modification impossible : passager embarqu√©.");return}if(S.statutEmbarquement===Qt.ANNULE||S.montant===0){alert("D√©j√† annul√©.");return}Ra({id:S.id,nomClient:S.nomClient,telephone:S.telephone,seatsGo:S.seatsGo??1,seatsReturn:S.seatsReturn??0,montant:S.montant??0,expectedPrice:S.montant??0}),ma(!0)},[]),O=o.useCallback(async S=>{if(!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))){Ja(!0);try{await Wc(t.companyId,t.agencyId,S.id,{nomClient:S.nomClient,telephone:S.telephone??null,seatsGo:S.seatsGo??1,seatsReturn:S.seatsReturn??0,montant:S.montant??0,editReason:S.editReason??null},{id:t.uid,name:t.displayName||t.email||null}),Ze(X=>X.map(oe=>oe.id===S.id?{...oe,nomClient:S.nomClient,telephone:S.telephone,seatsGo:Math.max(1,S.seatsGo||1),seatsReturn:Math.max(0,S.seatsReturn||0),montant:Math.max(0,S.montant||0)}:oe)),ma(!1),Ra(null)}catch(X){alert(X instanceof Error?X.message:"√âchec.")}finally{Ja(!1)}}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,t==null?void 0:t.uid,t==null?void 0:t.displayName,t==null?void 0:t.email]);o.useEffect(()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!(d!=null&&d.id)){Ze([]);return}if(!(at==="active"||at==="paused"||at==="pending")){Ze([]);return}ct(!0);const S=he($,`companies/${t.companyId}/agences/${t.agencyId}/reservations`),X=Te(S,ae("shiftId","==",d.id),ae("canal","==",ys.GUICHET),Rt("createdAt","asc")),oe=Ge(X,be=>{Ze(be.docs.map(me=>{const J=me.data();return{id:me.id,referenceCode:J.referenceCode,date:J.date,heure:J.heure,depart:J.depart,arrivee:J.arrivee,nomClient:J.nomClient,telephone:J.telephone,seatsGo:J.seatsGo||1,seatsReturn:J.seatsReturn||0,montant:J.montant||0,canal:J.canal,statutEmbarquement:J.statutEmbarquement,statut:J.statut,trajetId:J.trajetId,createdAt:J.createdAt,guichetierCode:J.guichetierCode||""}})),ct(!1)},be=>{console.error("[GUICHET] report listener error",be),ct(!1)});return()=>oe()},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,d==null?void 0:d.id,at]);const we=o.useCallback(async()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!(t!=null&&t.uid)){ut([]);return}la(!0);try{const S=`companies/${t.companyId}/agences/${t.agencyId}`,X=he($,`${S}/shiftReports`),[oe,be]=await Promise.all([Ee(Te(X,ae("userId","==",t.uid),ae("accountantValidated","==",!1))),Ee(Te(X,ae("userId","==",t.uid),ae("accountantValidated","==",!0),ae("managerValidated","==",!1)))]),me=[...oe.docs,...be.docs].map(J=>{const xe=J.data();return{shiftId:J.id,userId:xe.userId,userName:xe.userName,userCode:xe.userCode,startAt:xe.startAt,endAt:xe.endAt,billets:xe.billets||0,montant:xe.montant||0,details:Array.isArray(xe.details)?xe.details:[],accountantValidated:!!xe.accountantValidated,managerValidated:!!xe.managerValidated}}).sort((J,xe)=>{var Oe,$e,Be,mt;return((($e=(Oe=xe.endAt)==null?void 0:Oe.toMillis)==null?void 0:$e.call(Oe))??0)-(((mt=(Be=J.endAt)==null?void 0:Be.toMillis)==null?void 0:mt.call(Be))??0)});ut(me)}catch(S){console.error(S)}finally{la(!1)}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,t==null?void 0:t.uid]),de=o.useCallback(async()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!(t!=null&&t.uid)){vt([]);return}ka(!0);try{const S=he($,`companies/${t.companyId}/agences/${t.agencyId}/shiftReports`),X=await Ee(Te(S,ae("userId","==",t.uid),ae("accountantValidated","==",!0),ae("managerValidated","==",!0),Rt("endAt","desc"),Tt(50)));vt(X.docs.map(oe=>{const be=oe.data();return{shiftId:oe.id,userId:be.userId,userName:be.userName,userCode:be.userCode,startAt:be.startAt,endAt:be.endAt,billets:be.billets||0,montant:be.montant||0,details:Array.isArray(be.details)?be.details:[],accountantValidated:!0,managerValidated:!0}}))}catch(S){console.error(S)}finally{ka(!1)}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,t==null?void 0:t.uid]);o.useEffect(()=>{E==="rapport"&&we()},[E,we]),o.useEffect(()=>{E==="historique"&&de()},[E,de]);const U=o.useMemo(()=>{let S=0,X=0;for(const oe of De)oe.statutEmbarquement===Qt.ANNULE||oe.montant===0||(S+=(oe.seatsGo||0)+(oe.seatsReturn||0),X+=oe.montant||0);return{billets:S,montant:X}},[De]),ve=o.useMemo(()=>{var X,oe,be,me;const S=((oe=(X=d==null?void 0:d.startAt)==null?void 0:X.toDate)==null?void 0:oe.call(X))||((me=(be=d==null?void 0:d.startTime)==null?void 0:be.toDate)==null?void 0:me.call(be));return S?S.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}):new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})},[d==null?void 0:d.startAt,d==null?void 0:d.startTime]),ie=o.useMemo(()=>{if(!ee.trim())return De;const S=ee.toLowerCase();return De.filter(X=>(X.referenceCode||"").toLowerCase().includes(S)||X.nomClient.toLowerCase().includes(S)||(X.telephone||"").includes(S)||X.id.toLowerCase().includes(S))},[De,ee]),_e=o.useCallback(async()=>{try{await I(),Se(new Date),fe(!0),y&&ja("close"),N("rapport")}catch(S){alert((S==null?void 0:S.message)||"Erreur")}},[I,y,N]);return r("div",{className:`h-screen flex flex-col bg-gray-50 overflow-hidden ${h?"agency-dark":""}`,children:[e(dd,{message:ra,visible:ca,primaryColor:u.primary,type:da}),e(td,{status:at,locked:A,userName:(t==null?void 0:t.displayName)||(t==null?void 0:t.email)||"‚Äî",userCode:qt||Ye,companyLogo:R.logo,companyName:R.name,agencyName:M.name,sessionTickets:U.billets,sessionRevenue:n(U.montant),primaryColor:u.primary,secondaryColor:u.secondary,sessionStartedAt:wr,isOnline:x,onStart:()=>g().catch(S=>alert((S==null?void 0:S.message)||"Erreur")),onPause:()=>f().catch(S=>alert((S==null?void 0:S.message)||"Erreur")),onContinue:()=>b().catch(S=>alert((S==null?void 0:S.message)||"Erreur")),onClose:_e,onRefresh:()=>C().catch(()=>{}),onLogout:Qr}),e("div",{className:"bg-white border-b border-gray-200 px-4 lg:px-6",children:r("div",{className:"max-w-[1600px] mx-auto flex items-center gap-1",children:[[{key:"vente",label:"Guichet",icon:Us},{key:"rapport",label:"Rapport",icon:Wn},{key:"historique",label:"Historique",icon:zs}].map(({key:S,label:X,icon:oe})=>r("button",{onClick:()=>N(S),className:`flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 transition-colors ${E===S?"border-current text-current":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,style:E===S?{color:u.primary}:void 0,children:[e(oe,{className:"w-4 h-4"}),X]},S)),r("div",{className:"ml-auto flex items-center gap-1.5",children:[e("button",{onClick:()=>z(!F),className:`px-2 py-1 rounded-md transition text-xs ${F?"text-white":"text-gray-400 hover:bg-gray-100"}`,style:F?{backgroundColor:u.primary}:void 0,title:F?"Impression auto activ√©e":"Impression auto d√©sactiv√©e",children:e(Vr,{className:"w-3.5 h-3.5"})}),e("button",{onClick:()=>P(!y),className:`px-2 py-1 rounded-md transition text-xs ${y?"bg-gray-100 text-gray-600":"text-gray-400"}`,title:y?"Son activ√©":"Son d√©sactiv√©",children:y?"üîä":"üîá"}),e("button",{onClick:L,className:`px-2 py-1 rounded-md transition text-xs ${h?"bg-gray-700 text-yellow-300":"text-gray-400 hover:bg-gray-100"}`,title:h?"Mode jour":"Mode nuit",children:h?e(ho,{className:"w-3.5 h-3.5"}):e(po,{className:"w-3.5 h-3.5"})}),e("span",{className:"hidden xl:block text-[10px] text-gray-300 ml-2",children:"F2:onglet ¬∑ Esc:fermer ¬∑ +/-:places ¬∑ Ctrl+P:imprimer"})]})]})}),e("div",{className:"flex-1 min-h-0 overflow-y-auto",children:r("div",{className:`agency-content-transition ${E==="vente"?"h-full":""}`,children:[E==="vente"&&(!Wr&&!A?e(ps,{status:at==="pending"?"pending":"none",locked:!1,primaryColor:u.primary,secondaryColor:u.secondary,onStart:()=>g().catch(S=>alert((S==null?void 0:S.message)||"Erreur")),onRefresh:()=>C().catch(()=>{})}):A?e(ps,{status:"none",locked:!0,primaryColor:u.primary,secondaryColor:u.secondary,onStart:()=>{},onRefresh:()=>C().catch(()=>{})}):e("div",{className:"max-w-[1600px] mx-auto p-4 lg:p-6 h-full flex flex-col min-h-0",children:r("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-6 flex-1 min-h-0",children:[r("div",{className:"lg:col-span-3 space-y-5 overflow-y-auto min-h-0",children:[e("section",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm p-5",children:e(ad,{departure:B,arrivals:Q,selected:j,onSelect:k,primaryColor:u.primary,showDepartureLabel:!0})}),j&&r("section",{className:"bg-white rounded-xl border border-gray-200 shadow-sm p-3",children:[r("h3",{className:"text-sm font-semibold text-gray-900 mb-2 flex items-center gap-1.5",children:[e(Wn,{className:"w-3.5 h-3.5 text-gray-400"})," Date de voyage"]}),e(nd,{dates:Jr,selected:W,hasTrips:S=>ye.some(X=>X.date===S),onSelect:_a,primaryColor:u.primary})]}),j&&W&&r("section",{className:"bg-white rounded-xl border border-gray-200 shadow-sm p-3",children:[r("h3",{className:"text-sm font-semibold text-gray-900 mb-2 flex items-center gap-1.5",children:[e(qa,{className:"w-3.5 h-3.5 text-gray-400"})," Horaires disponibles"]}),e(id,{slots:Y,selectedId:(T==null?void 0:T.id)??null,onSelect:ce,formatMoney:n,primaryColor:u.primary})]}),De.length>0&&r("section",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm p-5",children:[e("h3",{className:"text-base font-bold text-gray-900 mb-3",children:"Derni√®res ventes"}),e(cd,{sales:De,formatMoney:n,primaryColor:u.primary,onResell:Bt})]})]}),e("div",{className:"lg:col-span-2 flex flex-col min-h-0 lg:min-h-[calc(100vh-12rem)]",children:e(ld,{selectedTrip:T,canSell:Ht,status:at,nomClient:Ie,onNomChange:Ve,telephone:Fe,onTelChange:te,placesAller:Ae,onPlacesAllerChange:ke,totalPrice:St,canValidate:Za,isProcessing:Pe,onValidate:en,formatMoney:n,primaryColor:u.primary,secondaryColor:u.secondary,validationHint:Zr,clientSuggestions:Xr,tariffKey:Ne,onTariffChange:ge,tariffMultiplier:ha,additionalPassengers:p,onAdditionalPassengersChange:V})})]})})),E==="rapport"&&r("div",{className:"max-w-[1600px] mx-auto p-4 lg:p-6 space-y-5",children:[e("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm p-5",children:r("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[r("div",{children:[e("h2",{className:"text-xl font-bold text-gray-900",children:"Rapport de session"}),e("p",{className:"text-sm text-gray-500 mt-0.5",children:ve})]}),r("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-right",children:r("p",{className:"text-2xl font-bold",style:{color:u.primary},children:[U.billets," ",e("span",{className:"text-sm font-normal text-gray-500",children:"billets"})]})}),e("div",{className:"h-8 w-px bg-gray-200"}),e("div",{className:"text-right",children:e("p",{className:"text-2xl font-bold",style:{color:u.primary},children:n(U.montant)})})]})]})}),r("div",{className:"relative",children:[e(_r,{className:"absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e("input",{value:ee,onChange:S=>ne(S.target.value),placeholder:"Rechercher par code, nom, t√©l√©phone‚Ä¶",className:"w-full bg-white border border-gray-200 rounded-xl pl-10 pr-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:border-transparent transition",style:{"--tw-ring-color":`${u.primary}40`}})]}),(at==="active"||at==="paused"||at==="pending")&&r("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden",children:[r("div",{className:"px-5 py-4 border-b border-gray-100 flex items-center justify-between",children:[e("h3",{className:"font-semibold text-gray-900",children:"Ventes du poste en cours"}),e("span",{className:"text-xs text-gray-400",children:"Temps r√©el"})]}),nt?e("div",{className:"p-8 text-center text-gray-400",children:"Chargement‚Ä¶"}):ie.length?e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gray-50/60 border-b border-gray-200",children:r("tr",{children:[e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Trajet"}),e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Client"}),e("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Billets"}),e("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Montant"}),e("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Statut"}),e("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e("tbody",{className:"divide-y divide-gray-100",children:ie.map(S=>{const X=S.statutEmbarquement===Qt.ANNULE||S.montant===0,oe=S.statutEmbarquement===Qt.EMBARQUE;return r("tr",{className:`hover:bg-gray-50/50 transition-colors ${X?"bg-red-50/40":oe?"bg-emerald-50/40":""}`,children:[r("td",{className:"px-4 py-3",children:[r("p",{className:"font-medium text-gray-900",children:[S.depart," ‚Üí ",S.arrivee]}),r("p",{className:"text-xs text-gray-500",children:[S.heure," ‚Ä¢ ",S.date]})]}),r("td",{className:"px-4 py-3",children:[e("p",{className:"text-gray-900",children:S.nomClient}),S.telephone&&e("p",{className:"text-xs text-gray-500",children:S.telephone})]}),e("td",{className:"px-4 py-3 text-right",children:(S.seatsGo||0)+(S.seatsReturn||0)}),e("td",{className:"px-4 py-3 text-right font-medium",children:X?e("span",{className:"text-gray-400 line-through",children:n(S.montant)}):n(S.montant)}),e("td",{className:"px-4 py-3 text-center",children:e("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${X?"bg-red-100 text-red-700":oe?"bg-emerald-100 text-emerald-700":"bg-blue-100 text-blue-700"}`,children:X?"Annul√©":oe?"Embarqu√©":"Actif"})}),e("td",{className:"px-4 py-3 text-right",children:r("div",{className:"flex items-center justify-end gap-1.5",children:[!X&&!oe&&r(bt,{children:[e("button",{onClick:()=>v(S),className:"p-1.5 rounded-lg hover:bg-gray-100 transition",title:"Modifier",children:e(go,{className:"w-3.5 h-3.5 text-gray-500"})}),e("button",{onClick:()=>Cr(S),disabled:zt===S.id,className:"p-1.5 rounded-lg hover:bg-red-50 transition",title:"Annuler",children:zt===S.id?e(rt,{className:"w-3.5 h-3.5 animate-spin text-red-500"}):e(Mr,{className:"w-3.5 h-3.5 text-red-500"})})]}),e("code",{className:"text-[10px] text-gray-400 bg-gray-50 px-1 py-0.5 rounded",children:S.referenceCode||S.id.slice(0,8)})]})})]},S.id)})})]})}):e("div",{className:"p-8 text-center text-gray-400",children:ee?"Aucun r√©sultat pour cette recherche.":"Aucune vente pour cette session."})]}),r("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden",children:[e("div",{className:"px-5 py-4 border-b border-gray-100",children:e("h3",{className:"font-semibold text-gray-900",children:"Sessions en attente de validation"})}),Ea?e("div",{className:"p-8 text-center text-gray-400",children:"Chargement‚Ä¶"}):wt.length===0?e("div",{className:"p-8 text-center text-gray-400",children:"Aucune session en attente."}):e("div",{className:"divide-y divide-gray-100",children:wt.map(S=>{var be,me,J,xe;const X=((me=(be=S.startAt)==null?void 0:be.toDate)==null?void 0:me.call(be))??new Date,oe=((xe=(J=S.endAt)==null?void 0:J.toDate)==null?void 0:xe.call(J))??new Date;return r("div",{className:"p-5",children:[r("div",{className:"flex items-center justify-between mb-2",children:[r("div",{children:[r("p",{className:"font-semibold text-gray-900",children:["Session #",S.shiftId.slice(0,6)]}),r("p",{className:"text-xs text-gray-500",children:[X.toLocaleString("fr-FR")," ‚Äî ",oe.toLocaleString("fr-FR")]})]}),r("div",{className:"flex items-center gap-2",children:[r("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${S.accountantValidated?"bg-emerald-100 text-emerald-700":"bg-amber-100 text-amber-700"}`,children:["Comptable ",S.accountantValidated?"‚úì":"‚Ä¶"]}),r("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${S.managerValidated?"bg-emerald-100 text-emerald-700":"bg-amber-100 text-amber-700"}`,children:["Chef ",S.managerValidated?"‚úì":"‚Ä¶"]})]})]}),S.details.length>0&&r("table",{className:"w-full text-sm mt-2",children:[e("thead",{className:"bg-gray-50/60",children:r("tr",{children:[e("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"Trajet"}),e("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"Billets"}),e("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"Montant"})]})}),e("tbody",{className:"divide-y divide-gray-100",children:S.details.map((Oe,$e)=>r("tr",{children:[e("td",{className:"px-3 py-2 text-gray-700",children:Oe.trajet}),e("td",{className:"px-3 py-2 text-right text-gray-700",children:Oe.billets}),e("td",{className:"px-3 py-2 text-right text-gray-700",children:n(Oe.montant)})]},$e))})]})]},S.shiftId)})})]})]}),E==="historique"&&r("div",{className:"max-w-[1600px] mx-auto p-4 lg:p-6 space-y-5",children:[r("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm p-5",children:[e("h2",{className:"text-xl font-bold text-gray-900",children:"Historique des sessions valid√©es"}),r("p",{className:"text-sm text-gray-500",children:[(t==null?void 0:t.displayName)||(t==null?void 0:t.email)||"‚Äî"," (",qt,")"]})]}),e("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden",children:Vt?e("div",{className:"p-8 text-center text-gray-400",children:"Chargement‚Ä¶"}):Pt.length===0?e("div",{className:"p-8 text-center text-gray-400",children:"Aucune session valid√©e."}):e("div",{className:"divide-y divide-gray-100",children:Pt.map(S=>{var be,me,J,xe;const X=((me=(be=S.startAt)==null?void 0:be.toDate)==null?void 0:me.call(be))??new Date,oe=((xe=(J=S.endAt)==null?void 0:J.toDate)==null?void 0:xe.call(J))??new Date;return r("div",{className:"p-5",children:[r("div",{className:"flex items-center justify-between mb-2",children:[r("div",{children:[r("p",{className:"font-semibold text-gray-900",children:["Session #",S.shiftId.slice(0,6)," ‚Äî ",S.billets," billets ‚Ä¢ ",n(S.montant)]}),r("p",{className:"text-xs text-gray-500",children:[X.toLocaleString("fr-FR")," ‚Üí ",oe.toLocaleString("fr-FR")]})]}),r("div",{className:"flex gap-1.5",children:[e("span",{className:"px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700",children:"Comptable ‚úì"}),e("span",{className:"px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700",children:"Chef ‚úì"})]})]}),S.details.length>0&&r("table",{className:"w-full text-sm mt-2",children:[e("thead",{className:"bg-gray-50/60",children:r("tr",{children:[e("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"Trajet"}),e("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"Billets"}),e("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"Montant"})]})}),e("tbody",{className:"divide-y divide-gray-100",children:S.details.map((Oe,$e)=>r("tr",{children:[e("td",{className:"px-3 py-2 text-gray-700",children:Oe.trajet}),e("td",{className:"px-3 py-2 text-right text-gray-700",children:Oe.billets}),e("td",{className:"px-3 py-2 text-right text-gray-700",children:n(Oe.montant)})]},$e))})]})]},S.shiftId)})})})]})]},c)}),ua&&Le&&e("div",{className:"fixed inset-0 z-50 grid place-items-center bg-black/30 p-4",children:r("div",{className:"w-full max-w-md rounded-2xl bg-white border shadow-xl p-6",children:[e("h3",{className:"text-lg font-bold text-gray-900 mb-4",children:"Modifier la r√©servation"}),e(bd,{target:Le,saving:Qa,money:n,primaryColor:u.primary,secondaryColor:u.secondary,onSave:O,onClose:()=>{ma(!1),Ra(null)}})]})}),st&&it&&Ue&&e(di,{open:st,onClose:()=>Ct(!1),reservation:it,company:Ue}),e(ud,{open:re,tickets:De,sessionStart:wr,sessionEnd:Ce,userName:(t==null?void 0:t.displayName)||(t==null?void 0:t.email)||"‚Äî",userCode:qt||Ye,formatMoney:n,primaryColor:u.primary,secondaryColor:u.secondary,onPrint:()=>window.print(),onClose:()=>fe(!1)})]})},bd=({target:a,saving:t,money:i,primaryColor:s,secondaryColor:n,onSave:l,onClose:d})=>{const[g,f]=o.useState(a.nomClient),[b,I]=o.useState(cr(Ft(a.telephone||""))||a.telephone||""),[C,A]=o.useState(a.seatsGo),[u,x]=o.useState(a.seatsReturn||0),[h,L]=o.useState(a.montant),[E,m]=o.useState(""),c=a.expectedPrice??a.montant,w=c>0?Math.abs(h-c)/c:0,N=w>.15&&h!==c;return r("div",{className:"space-y-3",children:[e("input",{className:"w-full border border-gray-300 rounded-xl px-3 py-2.5 text-sm",placeholder:"Nom",value:g,onChange:R=>f(R.target.value),onBlur:()=>f(Na(g))}),e("input",{className:"w-full border border-gray-300 rounded-xl px-3 py-2.5 text-sm",placeholder:"12 34 56 78",value:b,onChange:R=>I(cr(Ft(R.target.value))),inputMode:"numeric",maxLength:11}),r("div",{className:"grid grid-cols-2 gap-3",children:[r("div",{children:[e("label",{className:"text-xs text-gray-500 mb-1 block",children:"Places Aller"}),r("div",{className:"flex",children:[e("button",{className:"px-3 py-2 border rounded-l-xl bg-white hover:bg-gray-50",onClick:()=>A(Math.max(1,C-1)),children:"-"}),e("div",{className:"flex-1 text-center font-bold py-2 border-y bg-gray-50",children:C}),e("button",{className:"px-3 py-2 border rounded-r-xl bg-white hover:bg-gray-50",onClick:()=>A(C+1),children:"+"})]})]}),r("div",{children:[e("label",{className:"text-xs text-gray-500 mb-1 block",children:"Places Retour"}),r("div",{className:"flex",children:[e("button",{className:"px-3 py-2 border rounded-l-xl bg-white hover:bg-gray-50",onClick:()=>x(Math.max(0,u-1)),children:"-"}),e("div",{className:"flex-1 text-center font-bold py-2 border-y bg-gray-50",children:u}),e("button",{className:"px-3 py-2 border rounded-r-xl bg-white hover:bg-gray-50",onClick:()=>x(u+1),children:"+"})]})]})]}),r("div",{children:[e("label",{className:"text-xs text-gray-500 mb-1 block",children:"Montant"}),e("input",{type:"number",className:"w-full border border-gray-300 rounded-xl px-3 py-2.5 text-sm",value:h,onChange:R=>L(Math.max(0,Number(R.target.value)))}),N&&e("div",{className:"mt-1.5 flex items-center gap-1.5 text-amber-700 bg-amber-50 rounded-lg px-2.5 py-1.5",children:r("span",{className:"text-xs font-medium",children:["‚ö† √âcart de ",Math.round(w*100),"% par rapport au montant attendu (",i(c),")"]})})]}),e("input",{className:"w-full border border-gray-300 rounded-xl px-3 py-2.5 text-sm",placeholder:"Motif (optionnel)",value:E,onChange:R=>m(R.target.value)}),r("div",{className:"flex justify-end gap-2 pt-2",children:[e("button",{onClick:d,className:"px-4 py-2.5 rounded-xl border border-gray-300 text-sm font-medium bg-white hover:bg-gray-50 transition",children:"Annuler"}),e("button",{disabled:t||!g,onClick:()=>l({id:a.id,nomClient:Na(g),telephone:Ft(b)||b,seatsGo:C,seatsReturn:u,montant:h,editReason:E||void 0}),className:"px-4 py-2.5 rounded-xl text-sm font-medium text-white transition disabled:opacity-50",style:{background:`linear-gradient(135deg, ${s}, ${n})`},children:t?"Enregistrement‚Ä¶":"Enregistrer"})]})]})},Uu=Object.freeze(Object.defineProperty({__proto__:null,default:yd},Symbol.toStringTag,{value:"Module"})),xd=({fullScreen:a=!1,className:t=""})=>e("div",{className:`flex items-center justify-center ${a?"min-h-screen":""} ${t}`,children:e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}),vd=({message:a,onRetry:t,onHome:i})=>e("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:e("div",{className:"p-6 rounded-lg max-w-md bg-white shadow-sm border border-red-200",children:r("div",{className:"flex flex-col items-center",children:[e(Ha,{className:"h-12 w-12 text-red-500 mb-4"}),e("h2",{className:"text-xl font-bold mb-2 text-red-600",children:"Erreur"}),e("p",{className:"mb-6 text-gray-700",children:a}),r("div",{className:"flex gap-3",children:[t&&e("button",{onClick:t,className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition",children:"R√©essayer"}),i&&e("button",{onClick:i,className:"px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300 transition",children:"Accueil"})]})]})})}),Nd=()=>{const{id:a}=Ai(),t=aa(),i=Aa(),{companyInfo:s,reservation:n,from:l}=i.state||{},[d,g]=o.useState(n||null),[f,b]=o.useState(s||null),[I,C]=o.useState(!0),[A,u]=o.useState(null),x=o.useRef(null),h=o.useCallback((M,K)=>{try{let B;return typeof M=="string"?B=Ci(M):M instanceof Date?B=M:B=new Date(M.seconds*1e3),Je(B,K,{locale:Et})}catch{return"--/--/----"}},[]),L=o.useCallback(async()=>{var Z;if(!a)throw new Error("ID manquant");let M=await Ee(Te(Hn($,"reservations"),ae("referenceCode","==",a),Tt(1)));if(M.empty&&(M=await Ee(Te(Hn($,"reservations"),ae("__name__","==",a),Tt(1)))),M.empty)throw new Error("R√©servation introuvable");const K=M.docs[0],B=K.data(),Q=K.ref.path.split("/")[1];return{...B,id:K.id,compagnieId:B.compagnieId||Q,createdAt:(Z=B.createdAt)!=null&&Z.seconds?new Date(B.createdAt.seconds*1e3):void 0}},[a]),E=o.useCallback(async M=>{var le,Q;const K=await He(pe($,"companies",M));if(!K.exists())throw new Error("Compagnie non trouv√©e");const B=K.data();return{id:K.id,nom:B.nom||B.name,logoUrl:B.logoUrl,couleurPrimaire:B.couleurPrimaire||((le=B.theme)==null?void 0:le.primary)||"#3b82f6",couleurSecondaire:B.couleurSecondaire||((Q=B.theme)==null?void 0:Q.secondary),slug:B.slug,telephone:B.telephone}},[]);if(o.useEffect(()=>{(async()=>{try{C(!0);let M=n||null,K=s||null;M||(M=await L()),K||(K=await E(M.compagnieId)),g(M),b(K)}catch(M){u((M==null?void 0:M.message)||"Erreur de chargement")}finally{C(!1)}})()},[E,L,n,s]),I||!f)return e(xd,{fullScreen:!0});if(A||!d)return e(vd,{message:A||"Erreur de chargement",onRetry:()=>window.location.reload(),onHome:()=>t("/")});const m=d.referenceCode||d.id;h(d.createdAt||new Date,"dd/MM/yyyy");const c=f.couleurPrimaire,w=f.couleurSecondaire,N=lr(c),R=o.useCallback(()=>{if(!x.current)return;const M={margin:2,filename:`recu-${m}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:[81,200],orientation:"portrait"}};In().set(M).from(x.current).save()},[m]),H=o.useCallback(()=>{t(l||"/agence/guichet")},[t,l]);return r("div",{className:"min-h-screen bg-gray-50 print:bg-white",children:[e("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm no-print",style:{backgroundColor:c,color:N},children:r("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e("button",{onClick:H,className:"p-2 rounded-full",children:e(fo,{})}),e("h1",{className:"font-bold text-sm",children:"Re√ßu de voyage"}),e("div",{className:"w-6"})]})}),e("div",{className:"max-w-[81mm] mx-auto p-2",ref:x,children:e(di,{open:!0,onClose:()=>t("/agence/guichet"),reservation:{...d,agencyNom:d.agencyNom||d.nomAgence},company:{id:f.id,nom:f.nom,logoUrl:f.logoUrl,couleurPrimaire:f.couleurPrimaire,couleurSecondaire:f.couleurSecondaire,telephone:f.telephone,slug:f.slug}})}),r("div",{className:"no-print fixed bottom-0 left-0 right-0 bg-white border-t py-3 px-4 grid grid-cols-3 gap-2",children:[r("button",{onClick:R,className:"py-2 rounded-lg font-medium flex items-center justify-center gap-1",style:{backgroundColor:c,color:N},children:[e(Dn,{size:16})," PDF"]}),r("button",{onClick:()=>window.print(),className:"py-2 rounded-lg font-medium flex items-center justify-center gap-1",style:{backgroundColor:w||c,color:lr(w||c)},children:[e(Vr,{size:16})," Imprimer"]}),r("button",{onClick:()=>t("/agence/guichet"),className:"py-2 rounded-lg bg-gray-200 text-gray-800 flex items-center justify-center gap-1",children:[e(yo,{size:16})," Retour"]})]})]})},zu=Object.freeze(Object.defineProperty({__proto__:null,default:Nd},Symbol.toStringTag,{value:"Module"})),wd=a=>new Date(a.getFullYear(),a.getMonth(),1,0,0,0,0),Cd=a=>new Date(a.getFullYear(),a.getMonth()+1,1,0,0,0,0),Oa=a=>a?a.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"‚Äî",Sd=a=>a?new Date(a).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}):"‚Äî",Ad=()=>{var Cr;console.log("[AgenceCompta] Initialisation de la page de comptabilit√©");const a=aa(),{user:t,company:i,logout:s}=Ke(),n=Lt(i)||{primary:"#EA580C",secondary:"#F97316"},l=Nt(),d=ti(),g=br(),[f,b]=Gr(),[I,C]=o.useState(null),[A,u]=o.useState("Compagnie"),[x,h]=o.useState("XOF"),[L,E]=o.useState("Agence"),[m,c]=o.useState([]),[w,N]=o.useState("controle"),[R,H]=o.useState(null),[M,K]=o.useState("ACCOUNT"),[B,le]=o.useState(""),Q=o.useRef(0),[Z,j]=o.useState([]),[k,W]=o.useState([]),[q,ye]=o.useState([]),[se,Y]=o.useState([]),[ue,T]=o.useState({}),[ce,Ie]=o.useState({}),[Ve,Fe]=o.useState([]),[te,Ae]=o.useState([]),[ke,Pe]=o.useState([]),[je,D]=o.useState([]),[G,y]=o.useState([]),[P,F]=o.useState(10),[z,ee]=o.useState([]),[ne,Ne]=o.useState(!1),[ge,p]=o.useState(""),[V,re]=o.useState(0),[fe,Ce]=o.useState("all"),[Se,De]=o.useState({}),[Ze,nt]=o.useState({}),[ct,wt]=o.useState({}),[ut,Pt]=o.useState({}),vt=o.useRef({}),[Ea,la]=o.useState({}),[Vt,ka]=o.useState(!1),[st,Ct]=o.useState(()=>{const v=new Date;return`${v.getFullYear()}-${String(v.getMonth()+1).padStart(2,"0")}`}),[it,yt]=o.useState(""),[Ue,Xa]=o.useState(""),[ra,Kr]=o.useState([]),[ca,vr]=o.useState(0),[da,Yr]=o.useState(0),[ua,ma]=o.useState(!1),[Le,Ra]=o.useState(null),[Qa,Ja]=o.useState(!1),[zt,Nr]=o.useState(()=>new Date().toISOString().split("T")[0]),[qt,Ta]=o.useState(!1),[Ye,at]=o.useState({kind:"depense",montant:"",libelle:"",banque:"",companyBankId:"",note:""});o.useEffect(()=>{console.log("[AgenceCompta] Chargement des donn√©es header et profil"),(async()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)){console.warn("[AgenceCompta] Donn√©es utilisateur incompl√®tes");return}try{const v=await He(pe($,"companies",t.companyId));if(v.exists()){const U=v.data();C(U.logoUrl||U.logo||null),u(U.nom||U.name||"Compagnie"),h(U.devise||"XOF"),console.log(`[AgenceCompta] Compagnie charg√©e: ${U.nom||U.name}`)}const O=await He(pe($,`companies/${t.companyId}/agences/${t.agencyId}`));if(O.exists()){const U=O.data(),ve=(U==null?void 0:U.ville)||(U==null?void 0:U.city)||(U==null?void 0:U.nomVille)||(U==null?void 0:U.villeDepart)||"";E((U==null?void 0:U.nomAgence)||(U==null?void 0:U.nom)||ve||"Agence"),console.log(`[AgenceCompta] Agence charg√©e: ${(U==null?void 0:U.nomAgence)||(U==null?void 0:U.nom)||ve}`)}const we=await To(t.companyId);c(we);const de=await He(pe($,"users",t.uid));if(de.exists()){const U=de.data();le(U.role||"");const ve={id:t.uid,displayName:U.displayName||t.displayName||"",email:U.email||t.email||"",staffCode:U.staffCode,codeCourt:U.codeCourt,code:U.code};H(ve),K(U.staffCode||U.codeCourt||U.code||"ACCOUNT"),console.log(`[AgenceCompta] Comptable identifi√©: ${ve.displayName} (${M})`)}}catch(v){console.error("[AgenceCompta] Erreur lors du chargement des donn√©es:",v)}})().catch(console.error)},[t==null?void 0:t.uid,t==null?void 0:t.companyId,t==null?void 0:t.agencyId]);const Ht=(v,O)=>({id:v,userId:O.userId||O.openedById||"",userName:O.userName||O.openedByName||O.userEmail||"",userEmail:O.userEmail||"",userCode:O.userCode||O.openedByCode||"",companyId:O.companyId,agencyId:O.agencyId,status:O.status,startTime:O.startTime||O.openedAt,endTime:O.endTime||O.closedAt,totalTickets:O.totalTickets,totalReservations:O.totalReservations,totalAmount:O.totalAmount,payBy:O.payBy,accountantId:O.accountantId,accountantCode:O.accountantCode,accountantName:O.accountantName,validatedAt:O.validatedAt,cashExpected:O.cashExpected,cashReceived:O.cashReceived,mmExpected:O.mmExpected,mmReceived:O.mmReceived,comptable:O.comptable});o.useEffect(()=>{if(console.log("[AgenceCompta] D√©marrage de l'√©coute des postes"),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)){console.warn("[AgenceCompta] Abandon de l'√©coute - IDs manquants");return}const v=he($,`companies/${t.companyId}/agences/${t.agencyId}/shifts`),O=Ge(v,async we=>{console.log(`[AgenceCompta] Mise √† jour des postes: ${we.docs.length} document(s)`);const de=we.docs.map(ie=>Ht(ie.id,ie.data())),U=Array.from(new Set(de.map(ie=>ie.userId).filter(ie=>!!ie&&!ct[ie])));if(U.length){console.log(`[AgenceCompta] Chargement de ${U.length} utilisateur(s) manquant(s)`);const ie=await Promise.all(U.map(async _e=>{const ze=await He(pe($,"users",_e));if(!ze.exists())return[_e,{}];const S=ze.data();return[_e,{name:S.displayName||S.nom||S.email||"",email:S.email||"",code:S.staffCode||S.codeCourt||S.code||""}]}));wt(_e=>Object.fromEntries([...Object.entries(_e),...ie]))}const ve=ie=>{var _e,ze,S,X,oe,be;return(((ze=(_e=ie.validatedAt)==null?void 0:_e.toMillis)==null?void 0:ze.call(_e))??0)||(((X=(S=ie.endTime)==null?void 0:S.toMillis)==null?void 0:X.call(S))??0)||(((be=(oe=ie.startTime)==null?void 0:oe.toMillis)==null?void 0:be.call(oe))??0)};Fe(de.filter(ie=>ie.status==="pending").sort((ie,_e)=>ve(_e)-ve(ie))),Ae(de.filter(ie=>ie.status==="active").sort((ie,_e)=>ve(_e)-ve(ie))),Pe(de.filter(ie=>ie.status==="paused").sort((ie,_e)=>ve(_e)-ve(ie))),D(de.filter(ie=>ie.status==="closed").sort((ie,_e)=>ve(_e)-ve(ie))),y(de.filter(ie=>ie.status==="validated").sort((ie,_e)=>ve(_e)-ve(ie))),console.log("[AgenceCompta] Postes mis √† jour:",{pending:de.filter(ie=>ie.status==="pending").length,active:de.filter(ie=>ie.status==="active").length,paused:de.filter(ie=>ie.status==="paused").length,closed:de.filter(ie=>ie.status==="closed").length,validated:de.filter(ie=>ie.status==="validated").length})});return()=>{console.log("[AgenceCompta] Arr√™t de l'√©coute des postes"),O()}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),o.useEffect(()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const v=Br($,t.companyId,t.agencyId),O=Ge(v,we=>{const de=we.docs.map(ve=>({...ve.data(),id:ve.id})),U=ve=>{var ie,_e,ze,S,X,oe,be,me;return((_e=(ie=ve.validatedAt)==null?void 0:ie.toMillis)==null?void 0:_e.call(ie))??((S=(ze=ve.closedAt)==null?void 0:ze.toMillis)==null?void 0:S.call(ze))??((oe=(X=ve.openedAt)==null?void 0:X.toMillis)==null?void 0:oe.call(X))??((me=(be=ve.createdAt)==null?void 0:be.toMillis)==null?void 0:me.call(be))??0};j(de.filter(ve=>ve.status==="PENDING").sort((ve,ie)=>U(ie)-U(ve))),W(de.filter(ve=>ve.status==="ACTIVE").sort((ve,ie)=>U(ie)-U(ve))),ye(de.filter(ve=>ve.status==="CLOSED").sort((ve,ie)=>U(ie)-U(ve))),Y(de.filter(ve=>ve.status==="VALIDATED").sort((ve,ie)=>U(ie)-U(ve)))});return()=>O()},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),o.useEffect(()=>{const v=Z.length;B==="agency_accountant"&&v>0&&Q.current===0&&Si.info("Nouvelle demande d'activation Courrier"),Q.current=v},[Z.length,B]),o.useEffect(()=>{var O,we;if(console.log("[AgenceCompta] Mise √† jour des statistiques live"),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const v=he($,`companies/${t.companyId}/agences/${t.agencyId}/reservations`);for(const de of Object.keys(vt.current))!![...te,...ke].find(ve=>ve.id===de)||(console.log(`[AgenceCompta] Arr√™t de l'√©coute pour le poste ${de}`),(we=(O=vt.current)[de])==null||we.call(O),delete vt.current[de]);for(const de of[...te,...ke]){if(vt.current[de.id])continue;console.log(`[AgenceCompta] D√©marrage de l'√©coute pour le poste ${de.id}`);const U=Te(v,ae("shiftId","==",de.id)),ve=Ge(U,ie=>{let _e=0,ze=0,S=0;ie.forEach(X=>{const oe=X.data();_e+=1,ze+=(oe.seatsGo||0)+(oe.seatsReturn||0),S+=oe.montant||0}),Pt(X=>({...X,[de.id]:{reservations:_e,tickets:ze,amount:S}}))});vt.current[de.id]=ve}return()=>{var de,U;console.log("[AgenceCompta] Nettoyage des √©couteurs live");for(const ve of Object.keys(vt.current))(U=(de=vt.current)[ve])==null||U.call(de);vt.current={}}},[te,ke,t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),o.useEffect(()=>{console.log("[AgenceCompta] Calcul des agr√©gats pour r√©ceptions"),(async()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const v=he($,`companies/${t.companyId}/agences/${t.agencyId}/reservations`),O={};console.log(`[AgenceCompta] ${je.length} poste(s) cl√¥tur√©(s) √† analyser`);for(const we of je){const de=await Ee(Te(v,ae("shiftId","==",we.id)));let U=0,ve=0,ie=0,_e=0,ze=0,S=0;de.forEach(X=>{const oe=X.data();U+=1,ve+=(oe.seatsGo||0)+(oe.seatsReturn||0),ie+=oe.montant||0;const be=String(oe.paiement||"").toLowerCase(),me=String(oe.canal||"").toLowerCase();me==="guichet"||me===""?(be.includes("esp")&&(_e+=oe.montant||0),(be.includes("mobile")||be.includes("mm"))&&(ze+=oe.montant||0)):me==="en_ligne"&&(S+=oe.montant||0)}),O[we.id]={reservations:U,tickets:ve,amount:ie,cashExpected:_e,mmExpected:ze,onlineAmount:S}}la(O),console.log("[AgenceCompta] Agr√©gats calcul√©s:",Object.keys(O).length)})().catch(v=>console.error("[AgenceCompta] Erreur agr√©gats r√©ceptions:",v))},[je,t==null?void 0:t.companyId,t==null?void 0:t.agencyId]);const Wr=o.useCallback(async v=>{if(!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!R))try{await Vc({companyId:t.companyId,agencyId:t.agencyId,shiftId:v,activatedBy:{id:R.id,name:R.displayName||R.email||null}})}catch(O){console.error(`[AgenceCompta] Erreur activation poste ${v}:`,O),alert(O instanceof Error?O.message:"Erreur lors de l'activation du poste")}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,R]),wr=o.useCallback(async v=>{if(!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)))try{await li(t.companyId,t.agencyId,v)}catch(O){console.error(`[AgenceCompta] Erreur pause poste ${v}:`,O)}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),ha=o.useCallback(async v=>{if(!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)))try{await ci(t.companyId,t.agencyId,v)}catch(O){console.error(`[AgenceCompta] Erreur reprise poste ${v}:`,O)}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),Xr=(v,O)=>De(we=>({...we,[v]:{cashReceived:O}})),Da=o.useCallback(async v=>{if(console.log(`[AgenceCompta] Validation de la r√©ception pour le poste ${v.id}`),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!R){console.warn("[AgenceCompta] Donn√©es manquantes pour la validation");return}if(Ze[v.id]){console.log(`[AgenceCompta] Validation d√©j√† en cours pour le poste ${v.id}`);return}nt(U=>({...U,[v.id]:!0}));const O=Se[v.id]||{cashReceived:"0"},de=(U=>{const ve=(U||"").replace(/[^\d.,]/g,"").replace(",","."),ie=Number(ve);return Number.isFinite(ie)&&ie>=0?ie:NaN})(O.cashReceived||"");if(!Number.isFinite(de)){alert("Montant esp√®ces re√ßu invalide."),nt(U=>({...U,[v.id]:!1}));return}try{const{computedDifference:U}=await Uc({companyId:t.companyId,agencyId:t.agencyId,shiftId:v.id,receivedCashAmount:de,validatedBy:{id:R.id,name:R.displayName||R.email||null},accountantDeviceFingerprint:xr()});De(ve=>({...ve,[v.id]:{cashReceived:""}})),alert(U!==0?`Validation enregistr√©e. √âcart (re√ßu - attendu) : ${U>=0?"+":""}${U.toFixed(0)} ${d}`:"Validation enregistr√©e ‚úì")}catch(U){console.error(`[AgenceCompta] Erreur validation poste ${v.id}:`,U),alert(U instanceof Error?U.message:"Erreur lors de la validation.")}finally{nt(U=>({...U,[v.id]:!1}))}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,R,Se,d,Ze]),Qr=(v,O)=>T(we=>({...we,[v]:{countedAmount:O}})),Jr=o.useCallback(async v=>{if(!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!R))try{await Po({companyId:t.companyId,agencyId:t.agencyId,sessionId:v,activatedBy:{id:R.id,name:R.displayName||R.email||null}})}catch(O){console.error("[AgenceCompta] Erreur activation session courrier:",O),alert(O instanceof Error?O.message:"Erreur lors de l'activation.")}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,R]),$a=o.useCallback(async v=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!R)return;const O=(ue[v.id]||{countedAmount:""}).countedAmount||"0",we=Number(String(O).replace(/[^\d.,]/g,"").replace(",","."));if(!Number.isFinite(we)||we<0){alert("Montant compt√© invalide.");return}if(!ce[v.id]){Ie(de=>({...de,[v.id]:!0}));try{const{difference:de}=await Fo({companyId:t.companyId,agencyId:t.agencyId,sessionId:v.id,validatedAmount:we,validatedBy:{id:R.id,name:R.displayName||R.email||null}});T(U=>({...U,[v.id]:{countedAmount:""}})),alert(de!==0?`Validation enregistr√©e. √âcart (compt√© - attendu) : ${de>=0?"+":""}${de.toFixed(0)} ${d}`:"Validation enregistr√©e ‚úì")}catch(de){console.error("[AgenceCompta] Erreur validation session courrier:",de),alert(de instanceof Error?de.message:"Erreur lors de la validation.")}finally{Ie(de=>({...de,[v.id]:!1}))}}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,R,ue,d,ce]),pa=o.useCallback(async v=>{var O,we,de,U,ve,ie,_e,ze,S,X,oe,be;if(console.log(`[AgenceCompta] Chargement du rapport pour le poste ${v}`),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!v){console.log("[AgenceCompta] Donn√©es manquantes pour le rapport"),ee([]),re(0);return}Ne(!0),p(v);try{const me=`companies/${t.companyId}/agences/${t.agencyId}`,J=he($,`${me}/reservations`),xe=pe($,`${me}/shifts/${v}`),Oe=await He(xe),$e=Oe.exists()?Oe.data():{},Be=((we=(O=$e.startTime)==null?void 0:O.toDate)==null?void 0:we.call(O))??((U=(de=$e.openedAt)==null?void 0:de.toDate)==null?void 0:U.call(de))??null,mt=((ie=(ve=$e.endTime)==null?void 0:ve.toDate)==null?void 0:ie.call(ve))??((ze=(_e=$e.closedAt)==null?void 0:_e.toDate)==null?void 0:ze.call(_e))??null,ga=$e.userId||$e.openedById||"",Yt=$e.userCode||$e.openedByCode||"",ht=Be?new Date(Be.getTime()-5*60*1e3):null,fa=mt?new Date(mt.getTime()+6*60*60*1e3):null,er=await Ee(Te(J,ae("shiftId","==",v),Rt("createdAt","asc")));let Gn=[];ht&&fa&&(Gn=(await Ee(Te(J,ae("createdAt",">=",We.fromDate(ht)),Rt("createdAt","asc")))).docs.filter(et=>{var Ir,Un;const lt=et.data(),Wt=((Un=(Ir=lt.createdAt)==null?void 0:Ir.toDate)==null?void 0:Un.call(Ir))??new Date(0),Xt=Wt>=ht&&Wt<=fa,La=String(lt.canal||"").toLowerCase();if(La==="guichet"||La===""){const an=!!ga&&lt.guichetierId===ga||!!Yt&&lt.guichetierCode===Yt,rn=!lt.shiftId||lt.shiftId==="";return Xt&&an&&rn}if(La==="en_ligne"){const an=lt.agencyId===t.agencyId,rn=!lt.shiftId||lt.shiftId==="";return Xt&&an&&rn}return!1}));const gi=ot=>{const et=ot.data(),lt=String(et.canal||"").toLowerCase(),Wt=lt==="guichet"||lt===""?"agence":"compagnie";return{id:ot.id,referenceCode:et.referenceCode,date:et.date,heure:et.heure,depart:et.depart,arrivee:et.arrivee,nomClient:et.nomClient,telephone:et.telephone,seatsGo:et.seatsGo||1,seatsReturn:et.seatsReturn||0,montant:et.montant||0,paiement:et.paiement,createdAt:et.createdAt,guichetierCode:et.guichetierCode||"",canal:et.canal,encaissement:Wt}},tn=[...er.docs,...Gn].map(gi),ya=ot=>String(ot||"").normalize("NFKC").replace(/\s+/g," ").trim().toLowerCase(),fi=ot=>ot.referenceCode&&ya(ot.referenceCode)||[ya(ot.date),ya(ot.heure),ya(ot.depart),ya(ot.arrivee),ya(ot.nomClient),ya(ot.telephone)].join("|"),Sr=new Map;for(const ot of tn){const et=fi(ot),lt=Sr.get(et);if(!lt)Sr.set(et,ot);else{const Wt=((X=(S=lt.createdAt)==null?void 0:S.toMillis)==null?void 0:X.call(S))??0,Xt=((be=(oe=ot.createdAt)==null?void 0:oe.toMillis)==null?void 0:be.call(oe))??0;Sr.set(et,Xt>=Wt?ot:lt)}}const Ar=[...Sr.values()].sort((ot,et)=>{var lt,Wt,Xt,La;return(((Wt=(lt=ot.createdAt)==null?void 0:lt.toMillis)==null?void 0:Wt.call(lt))??0)-(((La=(Xt=et.createdAt)==null?void 0:Xt.toMillis)==null?void 0:La.call(Xt))??0)});ee(Ar),re(tn.length-Ar.length),console.log(`[AgenceCompta] Rapport charg√©: ${Ar.length} ligne(s), ${tn.length-Ar.length} doublon(s) √©limin√©(s)`)}catch(me){console.error("[AgenceCompta] Erreur lors du chargement du rapport:",me),alert("Erreur lors du chargement du rapport")}finally{Ne(!1)}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),Kt=o.useMemo(()=>{const v={billets:0,montant:0,guichet:{billets:0,montant:0},en_ligne:{billets:0,montant:0}};for(const O of z){const we=(O.seatsGo||0)+(O.seatsReturn||0);v.billets+=we,v.montant+=O.montant||0,O.canal==="guichet"||O.canal===""?(v.guichet.billets+=we,v.guichet.montant+=O.montant||0):O.canal==="en_ligne"&&(v.en_ligne.billets+=we,v.en_ligne.montant+=O.montant||0)}return v},[z]),Ma=o.useMemo(()=>{let v=0,O=0,we=0;for(const de of[...te,...ke]){const U=ut[de.id];U&&(v+=U.reservations,O+=U.tickets,we+=U.amount)}return console.log("[AgenceCompta] Totaux globaux live:",{reservations:v,tickets:O,amount:we}),{reservations:v,tickets:O,amount:we}},[te,ke,ut]),_a=o.useMemo(()=>{const v=se.reduce((O,we)=>O+(Number(we.expectedAmount)||0),0);return{pendingCount:Z.length,activeCount:k.length,closedCount:q.length,totalCAValidated:v}},[Z.length,k.length,q.length,se]),Bt=o.useMemo(()=>{if(Vt&&it&&Ue){const de=new Date(it);de.setHours(0,0,0,0);const U=new Date(Ue);return U.setHours(24,0,0,0),{from:de,to:U}}const[v,O]=st.split("-").map(Number),we=new Date(v,(O||1)-1,1);return{from:wd(we),to:Cd(we)}},[Vt,it,Ue,st]),St=o.useCallback(async()=>{if(console.log("[AgenceCompta] Chargement des donn√©es de caisse",Bt),!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))){ma(!0);try{const v=he($,`companies/${t.companyId}/agences/${t.agencyId}/cashReceipts`),O=he($,`companies/${t.companyId}/agences/${t.agencyId}/cashMovements`),we=Te(v,ae("createdAt",">=",We.fromDate(Bt.from)),Rt("createdAt","asc")),de=Te(O,ae("createdAt",">=",We.fromDate(Bt.from)),Rt("createdAt","asc")),[U,ve]=await Promise.all([Ee(we),Ee(de)]),ie={};U.forEach(be=>{var $e,Be;const me=be.data(),J=((Be=($e=me.createdAt)==null?void 0:$e.toDate)==null?void 0:Be.call($e))??new Date;if(J<Bt.from||J>=Bt.to)return;const xe=J.toISOString().split("T")[0],Oe=Number(me.cashReceived||0);ie[xe]||(ie[xe]={in:0,out:0}),ie[xe].in+=Math.max(0,Oe)}),ve.forEach(be=>{var Be,mt;const me=be.data(),J=((mt=(Be=me.createdAt)==null?void 0:Be.toDate)==null?void 0:mt.call(Be))??new Date;if(J<Bt.from||J>=Bt.to)return;const xe=J.toISOString().split("T")[0],Oe=String(me.kind||""),$e=Number(me.amount||0);ie[xe]||(ie[xe]={in:0,out:0}),Oe==="depense"||Oe==="transfert_banque"?ie[xe].out+=Math.max(0,$e):Oe==="entree_manual"&&(ie[xe].in+=Math.max(0,$e))});const _e=Object.keys(ie).sort();let ze=0;const S=[];let X=0,oe=0;for(const be of _e){const me=ie[be].in||0,J=ie[be].out||0;me===0&&J===0||(ze+=me-J,X+=me,oe+=J,S.push({dateISO:be,entrees:me,sorties:J,solde:ze}))}Kr(S),vr(X),Yr(oe),console.log("[AgenceCompta] Donn√©es de caisse charg√©es:",{jours:S.length,entr√©es:X,sorties:oe,solde:X-oe})}catch(v){console.error("[AgenceCompta] Erreur lors du chargement de la caisse:",v),alert("Erreur lors du chargement des donn√©es de caisse")}finally{ma(!1)}}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,Bt]);o.useEffect(()=>{console.log("[AgenceCompta] D√©clenchement du chargement de la caisse"),St()},[St]);const Za=o.useCallback(async()=>{if(console.log("[AgenceCompta] Chargement des donn√©es de r√©conciliation pour",zt),!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))){Ja(!0);try{const v=new Date(zt),O=new Date(v.getFullYear(),v.getMonth(),v.getDate(),0,0,0,0),we=new Date(v.getFullYear(),v.getMonth(),v.getDate(),23,59,59,999),de=he($,`companies/${t.companyId}/agences/${t.agencyId}/reservations`),U=Te(de,ae("date","==",zt),Rt("createdAt","asc")),ve=await Ee(U);let ie={reservations:0,tickets:0,montant:0},_e={reservations:0,tickets:0,montant:0},ze=0,S=0;ve.forEach(be=>{const me=be.data(),J=String(me.canal||"").toLowerCase(),xe=String(me.paiement||"").toLowerCase(),Oe=me.montant||0,$e=(me.seatsGo||0)+(me.seatsReturn||0);J==="guichet"||J===""?(ie.reservations+=1,ie.tickets+=$e,ie.montant+=Oe,xe.includes("esp")&&(ze+=Oe),(xe.includes("mobile")||xe.includes("mm"))&&(S+=Oe)):J==="en_ligne"&&(_e.reservations+=1,_e.tickets+=$e,_e.montant+=Oe)});const X=ze+S,oe=ie.montant-X;Ra({ventesGuichet:ie,ventesEnLigne:_e,encaissementsEspeces:ze,encaissementsMobileMoney:S,encaissementsTotal:X,ecart:oe}),console.log("[AgenceCompta] R√©conciliation calcul√©e:",{ventesGuichet:ie,ventesEnLigne:_e,encaissementsTotal:X,ecart:oe})}catch(v){console.error("[AgenceCompta] Erreur lors du chargement de la r√©conciliation:",v),alert("Erreur lors du chargement de la r√©conciliation")}finally{Ja(!1)}}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,zt]);o.useEffect(()=>{w==="reconciliation"&&Za()},[w,zt,Za]);const Zr=async()=>{var we;if(console.log("[AgenceCompta] Cr√©ation d'un nouveau mouvement de sortie",Ye),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const v=Number(Ye.montant||0);if(!Number.isFinite(v)||v<=0){console.warn("[AgenceCompta] Montant invalide pour le mouvement"),alert("Montant invalide");return}const O=Ye.kind==="transfert_banque"&&((Ye.companyBankId?(we=m.find(de=>de.id===Ye.companyBankId))==null?void 0:we.name:null)||Ye.banque)||"";if(Ye.kind==="transfert_banque"&&!O){alert("Veuillez s√©lectionner une banque de la compagnie ou indiquer le nom du compte.");return}try{const de={kind:Ye.kind,amount:v,label:Ye.libelle||(Ye.kind==="transfert_banque"?"Transfert vers banque":"D√©pense"),bankName:O,companyBankId:Ye.kind==="transfert_banque"&&Ye.companyBankId||null,note:Ye.note||"",companyId:t.companyId,agencyId:t.agencyId,accountantId:(R==null?void 0:R.id)||null,accountantCode:M,createdAt:We.now()},ve=(await kn(he($,`companies/${t.companyId}/agences/${t.agencyId}/cashMovements`),de)).id;Ye.kind==="transfert_banque"&&Ye.companyBankId&&(await fr(t.companyId,t.agencyId,x,L),await Do({companyId:t.companyId,fromAccountId:Ws(t.agencyId),toAccountId:$o(Ye.companyBankId),amount:v,currency:x,movementType:"deposit_to_bank",referenceType:"transfer",referenceId:ve,agencyId:t.agencyId,performedBy:t.uid,notes:`Transfert caisse ‚Üí ${O}`})),console.log("[AgenceCompta] Mouvement de sortie enregistr√© avec succ√®s"),Ta(!1),at({kind:"depense",montant:"",libelle:"",banque:"",companyBankId:"",note:""}),await St()}catch(de){console.error("[AgenceCompta] Erreur lors de l'enregistrement du mouvement:",de),alert("Erreur lors de l'enregistrement du mouvement")}},en=o.useCallback(v=>[...te,...ke,...je,...G].find(O=>O.id===v),[te,ke,je,G]);return r("div",{className:`min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 ${f?"agency-dark":""}`,children:[e("div",{className:"sticky top-0 z-10 border-b bg-white/95 backdrop-blur-sm supports-[backdrop-filter]:bg-white/90 shadow-sm",children:e("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 py-4",children:r("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e("div",{className:"flex items-center gap-4",children:r("div",{className:"flex items-center gap-3",children:[I?r("div",{className:"relative",children:[e("img",{src:I,alt:"Logo compagnie",className:"h-12 w-12 rounded-xl object-contain border-2 border-white shadow-sm"}),e("div",{className:"absolute -bottom-1 -right-1 h-5 w-5 bg-gradient-to-br from-emerald-500 to-cyan-500 rounded-full border border-white flex items-center justify-center",children:e(bo,{className:"h-3 w-3 text-white"})})]}):e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-white shadow-sm grid place-items-center",children:e(Hs,{className:"h-6 w-6 text-gray-600"})}),r("div",{className:"min-w-0",children:[e("div",{className:"text-xl font-bold tracking-tight truncate bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent",title:A,children:A}),r("div",{className:"text-sm text-gray-600 flex items-center gap-1.5 truncate",children:[e(Ca,{className:"h-4 w-4 flex-shrink-0"}),e("span",{className:"truncate",children:L}),e("span",{className:"text-xs px-2 py-0.5 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 rounded-full",children:"Comptabilit√©"})]})]})]})}),e("div",{className:"w-full sm:w-auto",children:r("div",{className:"inline-flex rounded-xl p-1.5 bg-gradient-to-r from-slate-100 to-slate-50 shadow-inner w-full sm:w-auto",children:[e(Va,{active:w==="controle",onClick:()=>N("controle"),label:"Contr√¥le",icon:e(sr,{className:"h-4 w-4"}),theme:n}),e(Va,{active:w==="receptions",onClick:()=>N("receptions"),label:"R√©ceptions",icon:e(xo,{className:"h-4 w-4"}),theme:n}),e(Va,{active:w==="rapports",onClick:()=>N("rapports"),label:"Rapports",icon:e(Xn,{className:"h-4 w-4"}),theme:n}),e(Va,{active:w==="caisse",onClick:()=>N("caisse"),label:"Caisse",icon:e(Mt,{className:"h-4 w-4"}),theme:n}),e(Va,{active:w==="reconciliation",onClick:()=>N("reconciliation"),label:"R√©conciliation",icon:e(or,{className:"h-4 w-4"}),theme:n}),e(Va,{active:w==="courrier",onClick:()=>N("courrier"),label:"Courrier",icon:e(wa,{className:"h-4 w-4"}),theme:n,badgeCount:B==="agency_accountant"?Z.length:0})]})}),r("div",{className:"flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-end",children:[e(Pn,{isOnline:g,darkMode:f,onDarkModeToggle:b}),R&&r("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-100 shadow-sm",children:[e("div",{className:"h-7 w-7 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold",children:((Cr=R.displayName)==null?void 0:Cr.charAt(0))||"C"}),r("div",{className:"min-w-0",children:[e("div",{className:"text-xs font-medium text-gray-900 truncate",children:R.displayName||R.email||"‚Äî"}),e("div",{className:"text-xs text-gray-600 truncate",children:M||"‚Äî"})]})]}),r("button",{onClick:async()=>{console.log("[AgenceCompta] D√©connexion du comptable"),await s(),a("/login")},className:"inline-flex items-center gap-2 px-4 py-2 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50 shadow-sm transition-colors",title:"D√©connexion",children:[e(dr,{className:"h-4 w-4"}),e("span",{className:"hidden sm:inline",children:"D√©connexion"})]})]})]})})}),r("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8 space-y-6",children:[w==="controle"&&r("div",{className:"space-y-6",children:[r("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6",children:[e(Dt,{icon:e(xa,{className:"h-6 w-6"}),label:"Billets vendus",value:Ma.tickets.toString(),sublabel:"en direct",theme:n,emphasis:!1}),e(Dt,{icon:e(_t,{className:"h-6 w-6"}),label:"Chiffre d'affaires",value:l(Ma.amount),sublabel:"en direct",theme:n,emphasis:!0}),e(Dt,{icon:e(sr,{className:"h-6 w-6"}),label:"R√©servations",value:Ma.reservations.toString(),sublabel:"en direct",theme:n,emphasis:!1})]}),r("div",{className:"grid grid-cols-2 sm:grid-cols-5 gap-3 sm:gap-4",children:[e(na,{tone:"indigo",label:"En attente",value:Ve.length,icon:e(qa,{className:"h-4 w-4"})}),e(na,{tone:"emerald",label:"En service",value:te.length,icon:e(Jt,{className:"h-4 w-4"})}),e(na,{tone:"amber",label:"En pause",value:ke.length,icon:e(Dr,{className:"h-4 w-4"})}),e(na,{tone:"rose",label:"Cl√¥tur√©s",value:je.length,icon:e(nn,{className:"h-4 w-4"})}),e(na,{tone:"slate",label:"Valid√©s",value:G.length,icon:e(Gt,{className:"h-4 w-4"})})]}),e(pn,{title:"Postes en attente d'activation",hint:"Le guichetier est connect√© mais ne peut pas vendre tant que vous n'activez pas.",icon:e(qa,{className:"h-5 w-5"}),list:Ve,usersCache:ct,liveStats:{},theme:n,actions:v=>r(pt,{variant:"primary",onClick:()=>Wr(v.id),children:[e(Jt,{className:"h-4 w-4 mr-2"}),"Activer le poste"]})}),e(pn,{title:"Postes en service",hint:"Statistiques mises √† jour en direct.",icon:e(Jt,{className:"h-5 w-5"}),list:te,usersCache:ct,liveStats:ut,theme:n,actions:v=>r("div",{className:"flex flex-col sm:flex-row gap-2",children:[r(pt,{variant:"secondary",onClick:()=>wr(v.id),children:[e(Dr,{className:"h-4 w-4 mr-2"}),"Pause"]}),e("span",{className:"text-xs text-gray-500 self-center",children:"Cl√¥ture par le guichetier uniquement."})]})}),e(pn,{title:"Postes en pause",hint:"Peuvent √™tre remis en service.",icon:e(Dr,{className:"h-5 w-5"}),list:ke,usersCache:ct,liveStats:ut,theme:n,actions:v=>r("div",{className:"flex flex-col sm:flex-row gap-2",children:[r(pt,{variant:"primary",onClick:()=>ha(v.id),children:[e(Jt,{className:"h-4 w-4 mr-2"}),"Continuer"]}),e("span",{className:"text-xs text-gray-500 self-center",children:"Cl√¥ture par le guichetier uniquement."})]})})]}),w==="receptions"&&r("div",{className:"space-y-6",children:[e(vs,{icon:e(Us,{className:"h-6 w-6"}),title:"R√©ceptions de caisse √† valider",subtitle:"Validez la remise d'esp√®ces des postes cl√¥tur√©s par les guichetiers."}),(()=>{const v=je.filter(O=>O.status==="closed");return v.length===0?e(sa,{icon:e(Gt,{className:"h-12 w-12"}),title:"Aucune r√©ception en attente",description:"Toutes les remises de caisse ont √©t√© valid√©es."}):e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6",children:v.map(O=>{var mt,ga,Yt,ht;const we=O.payBy||{},de=Se[O.id]||{cashReceived:""},U=Ea[O.id],ve=(U==null?void 0:U.reservations)??O.totalReservations??0,ie=(U==null?void 0:U.tickets)??O.totalTickets??0,_e=(U==null?void 0:U.amount)??O.totalAmount??0,S=O.totalCash??(U==null?void 0:U.cashExpected)??we.esp√®ces??O.cashExpected??0,X=(U==null?void 0:U.mmExpected)??we.mobile_money??O.mmExpected??0,oe=(U==null?void 0:U.onlineAmount)??0,be=Number((de.cashReceived||"").replace(/[^\d.]/g,"")),me=(Number.isFinite(be)?be:0)-(S||0),J=!Number.isFinite(be)||be<0,xe=Number.isFinite(be)&&me!==0,Oe=ct[O.userId]||{},$e=Oe.name||O.userName||O.userEmail||O.userId,Be=Oe.code||O.userCode||"‚Äî";return r("div",{className:"group relative",children:[e("div",{className:"absolute inset-0 bg-gradient-to-br from-white to-gray-50 rounded-xl transform group-hover:scale-[1.02] transition-all duration-300"}),r("div",{className:"relative rounded-xl border border-gray-200 bg-white/80 p-5 shadow-sm hover:shadow-md transition-all duration-300",children:[r("div",{className:"flex items-start justify-between gap-3 mb-4",children:[r("div",{className:"min-w-0",children:[e("div",{className:"text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Guichetier"}),r("div",{className:"font-semibold text-gray-900 truncate",children:[$e,r("span",{className:"text-gray-500 text-sm ml-2",children:["(",Be,")"]})]})]}),e("div",{className:"flex-shrink-0",children:e("div",{className:"px-3 py-1 rounded-full bg-gradient-to-r from-amber-50 to-amber-100 border border-amber-200",children:e("div",{className:"text-xs font-medium text-amber-800",children:"√Ä valider"})})})]}),r("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e($t,{label:"R√©servations",value:ve.toString()}),e($t,{label:"Billets",value:ie.toString()}),e($t,{label:"Montant total",value:l(_e),emphasis:!0}),e($t,{label:"Esp√®ces attendu",value:l(S),emphasis:!0}),e($t,{label:"Mobile Money",value:l(X)}),e($t,{label:"En ligne",value:l(oe)})]}),r("div",{className:"mb-4 p-3 rounded-xl bg-gradient-to-r from-gray-50 to-gray-100/50",children:[e("div",{className:"text-xs text-gray-600 mb-1",children:"P√©riode de vente"}),r("div",{className:"text-sm font-medium text-gray-900",children:[O.startTime?Oa(new Date(((ga=(mt=O.startTime).toDate)==null?void 0:ga.call(mt))??O.startTime)):"‚Äî",e("span",{className:"mx-2 text-gray-400",children:"‚Üí"}),O.endTime?Oa(new Date(((ht=(Yt=O.endTime).toDate)==null?void 0:ht.call(Yt))??O.endTime)):"‚Äî"]})]}),r("div",{className:"space-y-3",children:[r("div",{children:[r("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Esp√®ces re√ßues ",e("span",{className:"text-red-500",children:"*"})]}),r("div",{className:"relative",children:[e("input",{type:"number",min:"0",inputMode:"numeric",className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent text-lg font-medium",style:{outlineColor:n.primary},placeholder:"0",value:de.cashReceived,onChange:fa=>Xr(O.id,fa.target.value)}),e("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500",children:d})]})]}),r("div",{className:`p-3 rounded-xl border ${xe?"ring-2 ring-red-400":""}`,style:{borderColor:me===0?"#d1fae5":me>0?"#bbf7d0":"#fecaca",backgroundColor:me===0?"#f0fdf4":me>0?"#dcfce7":"#fef2f2"},children:[e("div",{className:"text-xs font-medium text-gray-700 mb-1",children:"√âcart (re√ßu - attendu)"}),e("div",{className:`text-lg font-bold ${me===0?"text-emerald-700":me>0?"text-green-700":"text-red-700"}`,children:Number.isFinite(me)?l(me):"‚Äî"}),xe&&e("div",{className:"mt-2 text-xs font-medium text-red-700",children:"√âcart √† justifier avant validation."})]})]}),r("div",{className:"mt-6 flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3",children:[r(pt,{variant:"secondary",onClick:()=>{N("rapports"),pa(O.id)},className:"w-full sm:w-auto",children:[e(mr,{className:"h-4 w-4 mr-2"}),"Voir le d√©tail"]}),r(pt,{variant:"primary",disabled:J||!!Ze[O.id],onClick:()=>Da(O),className:"w-full sm:w-auto",children:[e(Gt,{className:"h-4 w-4 mr-2"}),Ze[O.id]?"Validation...":"Valider la r√©ception"]})]})]})]},O.id)})})})()]}),w==="rapports"&&r("div",{className:"space-y-6",children:[r("div",{className:"rounded-xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[r("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-3",children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center",children:e(Xn,{className:"h-5 w-5 text-blue-600"})}),r("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Rapports d√©taill√©s par poste"}),e("div",{className:"text-sm text-gray-600",children:"Analyse compl√®te des ventes (guichet + en ligne)"})]})]}),e("div",{className:"w-full sm:w-96",children:r("select",{className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:n.primary},value:ge,onChange:v=>pa(v.target.value),children:[e("option",{value:"",children:"‚Äî S√©lectionnez un poste ‚Äî"}),[...te,...ke,...je,...G].map(v=>{var ze,S,X,oe;const O=ct[v.userId]||{},we=O.name||v.userName||v.userEmail||v.userId,de=O.code||v.userCode||"‚Äî",U=v.startTime?new Date(((S=(ze=v.startTime).toDate)==null?void 0:S.call(ze))??v.startTime):null,ve=v.endTime?new Date(((oe=(X=v.endTime).toDate)==null?void 0:oe.call(X))??v.endTime):null,ie=v.status==="active"?"En service":v.status==="paused"?"En pause":v.status==="closed"?"Cl√¥tur√©":v.status==="validated"?"Valid√©":"En attente",_e=`${U?U.toLocaleDateString("fr-FR"):"?"} ‚Üí ${ve?ve.toLocaleDateString("fr-FR"):"?"}`;return e("option",{value:v.id,children:`${we} (${de}) ‚Ä¢ ${_e} ‚Ä¢ ${ie}`},v.id)})]})})]}),r("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mt-4",children:[ge&&(()=>{var de,U,ve,ie;const v=en(ge),O=v!=null&&v.startTime?new Date(((U=(de=v.startTime).toDate)==null?void 0:U.call(de))??v.startTime):null,we=v!=null&&v.endTime?new Date(((ie=(ve=v.endTime).toDate)==null?void 0:ie.call(ve))??v.endTime):null;return r("div",{className:"text-sm text-gray-600",children:["P√©riode analys√©e : ",Oa(O)," ‚Üí ",Oa(we),V>0&&r("span",{className:"ml-3 px-2 py-1 rounded-full bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 text-xs font-medium",children:[V," doublon",V>1?"s":""," consolid√©",V>1?"s":""]})]})})(),r("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"Filtrer par canal :"}),r("div",{className:"flex rounded-xl border border-gray-300 p-1",children:[e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${fe==="all"?"bg-blue-50 text-blue-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>Ce("all"),children:"Tous"}),e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${fe==="guichet"?"bg-emerald-50 text-emerald-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>Ce("guichet"),children:"Guichet"}),e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${fe==="en_ligne"?"bg-indigo-50 text-indigo-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>Ce("en_ligne"),children:"En ligne"})]})]})]})]}),r("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6",children:[e(Dt,{icon:e(xa,{className:"h-6 w-6"}),label:"Billets vendus",value:Kt.billets.toString(),sublabel:`${Kt.guichet.billets} guichet + ${Kt.en_ligne.billets} ligne`,theme:n,emphasis:!1}),e(Dt,{icon:e(_t,{className:"h-6 w-6"}),label:"Chiffre d'affaires",value:l(Kt.montant),sublabel:`${l(Kt.guichet.montant)} guichet + ${l(Kt.en_ligne.montant)} ligne`,theme:n,emphasis:!0}),e(Dt,{icon:e(sr,{className:"h-6 w-6"}),label:"R√©servations",value:z.length.toString(),sublabel:`${z.filter(v=>v.canal==="guichet"||v.canal==="").length} guichet + ${z.filter(v=>v.canal==="en_ligne").length} ligne`,theme:n,emphasis:!1})]}),r("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[r("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"D√©tail des r√©servations"}),r("div",{className:"text-sm text-gray-600",children:[z.length," ligne",z.length>1?"s":""]})]}),ne?e("div",{className:"flex items-center justify-center py-12",children:r("div",{className:"text-center",children:[e("div",{className:"h-12 w-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-3"}),e("div",{className:"text-gray-600",children:"Chargement des donn√©es..."})]})}):z.length?e("div",{className:"overflow-hidden rounded-xl border border-gray-200",children:e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gradient-to-r from-gray-50 to-gray-100/50",children:r("tr",{children:[e(ft,{children:"Date/Heure"}),e(ft,{children:"Canal"}),e(ft,{children:"Trajet"}),e(ft,{children:"Client"}),e(ft,{align:"right",children:"Billets"}),e(ft,{align:"right",children:"Montant"}),e(ft,{align:"right",children:"Paiement"}),e(ft,{align:"right",children:"Vendeur"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:z.filter(v=>fe==="all"?!0:fe==="guichet"?v.canal==="guichet"||v.canal==="":fe==="en_ligne"?v.canal==="en_ligne":!0).map((v,O)=>{const we=v.canal==="en_ligne"?"bg-indigo-100 text-indigo-700":"bg-emerald-100 text-emerald-700",de=v.encaissement==="agence"?"Caisse agence":"Compte compagnie",U=v.encaissement==="agence"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700";return r("tr",{className:`hover:bg-gray-50/50 ${O%2===0?"bg-white":"bg-gray-50/30"}`,children:[r(Me,{children:[e("div",{className:"font-medium",children:Sd(v.date)}),e("div",{className:"text-xs text-gray-500",children:v.heure})]}),e(Me,{children:r("div",{className:"flex flex-col gap-1",children:[e("span",{className:`text-xs px-2 py-1 rounded-full ${we} font-medium`,children:v.canal==="en_ligne"?"En ligne":"Guichet"}),e("span",{className:`text-xs px-2 py-0.5 rounded-full ${U}`,children:de})]})}),e(Me,{children:r("div",{className:"font-medium",children:[v.depart," ‚Üí ",v.arrivee]})}),r(Me,{children:[e("div",{className:"font-medium",children:v.nomClient}),v.telephone&&e("div",{className:"text-xs text-gray-500",children:v.telephone})]}),e(Me,{align:"right",children:e("span",{className:"font-medium",children:(v.seatsGo||0)+(v.seatsReturn||0)})}),e(Me,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:l(v.montant)})}),e(Me,{align:"right",children:e("span",{className:"text-xs text-gray-600",children:v.paiement||"‚Äî"})}),e(Me,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700",children:v.guichetierCode||"‚Äî"})})]},v.id)})})]})})}):e(sa,{icon:e(mr,{className:"h-12 w-12"}),title:"Aucune donn√©e disponible",description:"S√©lectionnez un poste pour afficher son rapport d√©taill√©"})]})]}),w==="caisse"&&r("div",{className:"space-y-6",children:[r("div",{className:"rounded-xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[r("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-5",children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-emerald-50 to-green-50 flex items-center justify-center",children:e(Mt,{className:"h-6 w-6 text-emerald-600"})}),r("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:"Caisse d'agence"}),e("div",{className:"text-sm text-gray-600",children:"Gestion des mouvements financiers"})]})]}),r("div",{className:"flex flex-wrap items-center gap-3",children:[r(pt,{variant:"primary",onClick:()=>Ta(!0),className:"whitespace-nowrap",children:[e(Ka,{className:"h-4 w-4 mr-2"}),"Nouveau mouvement"]}),r(pt,{variant:"secondary",onClick:()=>Id(ra,d),disabled:ra.length===0,className:"whitespace-nowrap",children:[e(Dn,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]})]}),r("div",{className:"space-y-4",children:[e("div",{className:"flex items-center gap-3",children:r("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e("input",{type:"checkbox",checked:Vt,onChange:v=>ka(v.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),"P√©riode personnalis√©e"]})}),r("div",{className:"flex flex-wrap items-center gap-4",children:[Vt?r(bt,{children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"Du"}),e("input",{type:"date",className:"border border-gray-300 rounded-xl px-4 py-2.5 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:n.primary},value:it,onChange:v=>yt(v.target.value)})]}),r("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"Au"}),e("input",{type:"date",className:"border border-gray-300 rounded-xl px-4 py-2.5 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:n.primary},value:Ue,onChange:v=>Xa(v.target.value)})]})]}):r("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"P√©riode :"}),e("div",{className:"relative",children:e("input",{type:"month",className:"border border-gray-300 rounded-xl px-4 py-2.5 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:n.primary},value:st,onChange:v=>Ct(v.target.value)})})]}),e(pt,{variant:"secondary",onClick:St,disabled:ua,children:ua?"Actualisation...":"Actualiser"})]})]})]}),r("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6",children:[e(Dt,{icon:e(_t,{className:"h-6 w-6"}),label:"Entr√©es totales",value:l(ca),theme:n,emphasis:!1}),e(Dt,{icon:e(Ha,{className:"h-6 w-6"}),label:"Sorties totales",value:l(da),theme:n,emphasis:!1}),e(Dt,{icon:e(Mt,{className:"h-6 w-6"}),label:"Solde de p√©riode",value:l(ca-da),sublabel:ca-da>=0?"Positif":"D√©ficitaire",theme:n,emphasis:!0})]}),r("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[r("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Journal des mouvements"}),r("div",{className:"text-sm text-gray-600",children:[ra.length," jour",ra.length>1?"s":""," avec activit√©"]})]}),ua?e("div",{className:"flex items-center justify-center py-12",children:r("div",{className:"text-center",children:[e("div",{className:"h-12 w-12 border-4 border-gray-200 border-t-emerald-500 rounded-full animate-spin mx-auto mb-3"}),e("div",{className:"text-gray-600",children:"Chargement des donn√©es de caisse..."})]})}):ra.length===0?e(sa,{icon:e(Mt,{className:"h-12 w-12"}),title:"Aucun mouvement enregistr√©",description:"Aucun mouvement de caisse sur la p√©riode s√©lectionn√©e"}):e("div",{className:"overflow-hidden rounded-xl border border-gray-200",children:e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gradient-to-r from-gray-50 to-gray-100/50",children:r("tr",{children:[e(ft,{children:"Date"}),e(ft,{align:"right",children:"Entr√©es"}),e(ft,{align:"right",children:"Sorties"}),e(ft,{align:"right",children:"Solde journalier"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:ra.map((v,O)=>r("tr",{className:`hover:bg-gray-50/50 ${O%2===0?"bg-white":"bg-gray-50/30"}`,children:[e(Me,{children:e("div",{className:"font-medium",children:new Date(v.dateISO).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})})}),e(Me,{align:"right",children:e("span",{className:"font-medium text-emerald-700",children:l(v.entrees)})}),e(Me,{align:"right",children:e("span",{className:"font-medium text-rose-700",children:l(v.sorties)})}),e(Me,{align:"right",children:e("span",{className:`font-bold ${v.solde>=0?"text-emerald-700":"text-rose-700"}`,children:l(v.solde)})})]},v.dateISO))}),e("tfoot",{className:"bg-gradient-to-r from-gray-50 to-gray-100/80 border-t-2 border-gray-300",children:r("tr",{children:[e(Me,{className:"font-bold text-gray-900",children:"TOTAUX"}),e(Me,{align:"right",className:"font-bold text-emerald-700",children:l(ca)}),e(Me,{align:"right",className:"font-bold text-rose-700",children:l(da)}),e(Me,{align:"right",className:"font-bold text-gray-900",children:l(ca-da)})]})})]})})})]})]}),w==="reconciliation"&&r("div",{className:"space-y-6",children:[r("div",{className:"rounded-xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[r("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-5",children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-amber-50 to-orange-50 flex items-center justify-center",children:e(or,{className:"h-6 w-6 text-amber-600"})}),r("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:"R√©conciliation des ventes"}),e("div",{className:"text-sm text-gray-600",children:"Coh√©rence billets vendus vs argent encaiss√©"})]})]}),r("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"Date :"}),e("input",{type:"date",className:"border border-gray-300 rounded-xl px-4 py-2.5 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:n.primary},value:zt,onChange:v=>Nr(v.target.value)}),e(pt,{variant:"secondary",onClick:Za,disabled:Qa,children:Qa?"Chargement...":"Actualiser"})]})]}),e("div",{className:"text-sm text-gray-600",children:"Compare les billets vendus par votre agence avec l'argent r√©ellement encaiss√©"})]}),Qa?e("div",{className:"flex items-center justify-center py-12",children:r("div",{className:"text-center",children:[e("div",{className:"h-12 w-12 border-4 border-gray-200 border-t-amber-500 rounded-full animate-spin mx-auto mb-3"}),e("div",{className:"text-gray-600",children:"Chargement de la r√©conciliation..."})]})}):Le?r(bt,{children:[r("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6",children:[e(Dt,{icon:e(xa,{className:"h-6 w-6"}),label:"Billets vendus",value:(Le.ventesGuichet.tickets+Le.ventesEnLigne.tickets).toString(),sublabel:`${Le.ventesGuichet.tickets} guichet + ${Le.ventesEnLigne.tickets} ligne`,theme:n,emphasis:!1}),e(Dt,{icon:e(vo,{className:"h-6 w-6"}),label:"Chiffre d'affaires total",value:l(Le.ventesGuichet.montant+Le.ventesEnLigne.montant),sublabel:`${l(Le.ventesGuichet.montant)} guichet + ${l(Le.ventesEnLigne.montant)} ligne`,theme:n,emphasis:!0}),e(Dt,{icon:Le.ecart===0?e(Gt,{className:"h-6 w-6"}):e(Ha,{className:"h-6 w-6"}),label:"√âcart de caisse",value:l(Le.ecart),sublabel:Le.ecart===0?"Caisse OK":Le.ecart>0?"Caisse en d√©ficit":"Exc√©dent",theme:n,emphasis:!0})]}),r("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[e("div",{className:"text-lg font-bold text-gray-900 mb-5",children:"R√©conciliation d√©taill√©e"}),e("div",{className:"overflow-hidden rounded-xl border border-gray-200",children:r("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gradient-to-r from-gray-50 to-gray-100/50",children:r("tr",{children:[e(ft,{children:"Cat√©gorie"}),e(ft,{align:"right",children:"R√©servations"}),e(ft,{align:"right",children:"Billets"}),e(ft,{align:"right",children:"Montant"}),e(ft,{align:"right",children:"Commentaire"})]})}),r("tbody",{className:"divide-y divide-gray-200",children:[e("tr",{className:"bg-gradient-to-r from-blue-50/30 to-indigo-50/30",children:e(Me,{colSpan:5,children:e("div",{className:"text-sm font-bold text-blue-700 uppercase tracking-wider py-2",children:"VENTES DE L'AGENCE"})})}),r("tr",{className:"hover:bg-gray-50/50",children:[e(Me,{children:r("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-emerald-100 flex items-center justify-center",children:e(_t,{className:"h-3 w-3 text-emerald-600"})}),e("span",{className:"font-medium",children:"Ventes guichet"})]})}),e(Me,{align:"right",children:e("span",{className:"font-medium",children:Le.ventesGuichet.reservations})}),e(Me,{align:"right",children:e("span",{className:"font-medium",children:Le.ventesGuichet.tickets})}),e(Me,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:l(Le.ventesGuichet.montant)})}),e(Me,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700",children:"√Ä encaisser en caisse"})})]}),r("tr",{className:"hover:bg-gray-50/50",children:[e(Me,{children:r("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-indigo-100 flex items-center justify-center",children:e(No,{className:"h-3 w-3 text-indigo-600"})}),e("span",{className:"font-medium",children:"Ventes en ligne"})]})}),e(Me,{align:"right",children:e("span",{className:"font-medium",children:Le.ventesEnLigne.reservations})}),e(Me,{align:"right",children:e("span",{className:"font-medium",children:Le.ventesEnLigne.tickets})}),e(Me,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:l(Le.ventesEnLigne.montant)})}),e(Me,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700",children:"Encaiss√© en ligne"})})]}),r("tr",{className:"border-t-2 border-gray-300",children:[e(Me,{className:"font-bold text-gray-900",children:"TOTAL VENTES AGENCE"}),e(Me,{align:"right",className:"font-bold text-gray-900",children:Le.ventesGuichet.reservations+Le.ventesEnLigne.reservations}),e(Me,{align:"right",className:"font-bold text-gray-900",children:Le.ventesGuichet.tickets+Le.ventesEnLigne.tickets}),e(Me,{align:"right",className:"font-bold text-gray-900",children:l(Le.ventesGuichet.montant+Le.ventesEnLigne.montant)}),e(Me,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700",children:"Billets consomm√©s"})})]}),e("tr",{className:"bg-gradient-to-r from-emerald-50/30 to-green-50/30",children:e(Me,{colSpan:5,children:e("div",{className:"text-sm font-bold text-emerald-700 uppercase tracking-wider py-2",children:"ENCAISSEMENTS DANS LA CAISSE"})})}),r("tr",{className:"hover:bg-gray-50/50",children:[e(Me,{children:r("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-amber-100 flex items-center justify-center",children:e(Mt,{className:"h-3 w-3 text-amber-600"})}),e("span",{className:"font-medium",children:"Esp√®ces re√ßues"})]})}),e(Me,{align:"right",children:"‚Äî"}),e(Me,{align:"right",children:"‚Äî"}),e(Me,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:l(Le.encaissementsEspeces)})}),e(Me,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700",children:"Caisse agence"})})]}),r("tr",{className:"hover:bg-gray-50/50",children:[e(Me,{children:r("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-purple-100 flex items-center justify-center",children:e(wo,{className:"h-3 w-3 text-purple-600"})}),e("span",{className:"font-medium",children:"Mobile Money"})]})}),e(Me,{align:"right",children:"‚Äî"}),e(Me,{align:"right",children:"‚Äî"}),e(Me,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:l(Le.encaissementsMobileMoney)})}),e(Me,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Compte compagnie"})})]}),r("tr",{className:"border-t-2 border-gray-300",children:[e(Me,{className:"font-bold text-gray-900",children:"TOTAL ENCAISS√âS"}),e(Me,{align:"right",children:"‚Äî"}),e(Me,{align:"right",children:"‚Äî"}),e(Me,{align:"right",className:"font-bold text-gray-900",children:l(Le.encaissementsTotal)}),e(Me,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700",children:"Argent r√©ellement re√ßu"})})]}),e("tr",{className:`${Le.ecart===0?"bg-gradient-to-r from-emerald-50/30 to-green-50/30":Le.ecart>0?"bg-gradient-to-r from-rose-50/30 to-red-50/30":"bg-gradient-to-r from-amber-50/30 to-orange-50/30"}`,children:e(Me,{colSpan:5,children:r("div",{className:"flex items-center justify-between py-3",children:[e("div",{className:"text-sm font-bold text-gray-900",children:"√âCART (Ventes guichet - Encaissements)"}),r("div",{className:`text-xl font-bold ${Le.ecart===0?"text-emerald-700":Le.ecart>0?"text-rose-700":"text-amber-700"}`,children:[l(Le.ecart),Le.ecart===0&&e("span",{className:"ml-2 text-sm font-medium text-emerald-600",children:"‚úì √âquilibre parfait"}),Le.ecart>0&&e("span",{className:"ml-2 text-sm font-medium text-rose-600",children:"‚ö†Ô∏è Manque dans la caisse"}),Le.ecart<0&&e("span",{className:"ml-2 text-sm font-medium text-amber-600",children:"‚ÑπÔ∏è Exc√©dent en caisse"})]})]})})})]})]})}),r("div",{className:"mt-6 p-4 rounded-xl bg-gradient-to-r from-gray-50 to-gray-100/50 border border-gray-200",children:[e("div",{className:"text-sm font-medium text-gray-700 mb-2",children:"R√©sum√© de la journ√©e"}),r("div",{className:"text-sm text-gray-600 space-y-1",children:[r("div",{children:["‚Ä¢ ",e("span",{className:"font-medium",children:Le.ventesGuichet.reservations+Le.ventesEnLigne.reservations})," r√©servations effectu√©es"]}),r("div",{children:["‚Ä¢ ",e("span",{className:"font-medium",children:Le.ventesGuichet.tickets+Le.ventesEnLigne.tickets})," billets vendus"]}),r("div",{children:["‚Ä¢ ",e("span",{className:"font-medium",children:l(Le.ventesGuichet.montant+Le.ventesEnLigne.montant)})," chiffre d'affaires g√©n√©r√©"]}),r("div",{children:["‚Ä¢ ",e("span",{className:"font-medium",children:l(Le.encaissementsTotal)})," r√©ellement encaiss√©s dans la caisse"]})]})]})]})]}):e(sa,{icon:e(or,{className:"h-12 w-12"}),title:"Aucune donn√©e disponible",description:"S√©lectionnez une date pour voir la r√©conciliation"})]}),w==="courrier"&&r("div",{className:"space-y-6",children:[e(vs,{icon:e(wa,{className:"h-6 w-6"}),title:"Sessions courrier",subtitle:"Activation des sessions en attente et validation des sessions cl√¥tur√©es."}),r("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[e(na,{tone:"indigo",label:"En attente",value:_a.pendingCount,icon:e(qa,{className:"h-4 w-4"})}),e(na,{tone:"emerald",label:"Actives",value:_a.activeCount,icon:e(Jt,{className:"h-4 w-4"})}),e(na,{tone:"rose",label:"Cl√¥tur√©es",value:_a.closedCount,icon:e(nn,{className:"h-4 w-4"})}),r("div",{className:"rounded-xl border border-gray-200 bg-white p-4 shadow-sm",children:[r("div",{className:"flex items-center gap-2 text-gray-600 mb-1",children:[e(_t,{className:"h-4 w-4"}),e("span",{className:"text-sm font-medium",children:"Total CA Courrier (valid√©es)"})]}),e("div",{className:"text-xl font-bold",style:{color:n.primary},children:l(_a.totalCAValidated)})]})]}),r("div",{className:"rounded-xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[r("div",{className:"flex items-center justify-between mb-4",children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-indigo-50 flex items-center justify-center",children:e(qa,{className:"h-5 w-5 text-indigo-600"})}),r("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Sessions en attente d'activation"}),e("div",{className:"text-sm text-gray-600",children:"L'agent a cr√©√© une session ; activez-la pour qu'il puisse enregistrer des envois."})]})]}),r("span",{className:"text-sm font-medium px-3 py-1.5 rounded-full bg-gray-100 text-gray-700",children:[Z.length," session",Z.length>1?"s":""]})]}),Z.length===0?e(sa,{icon:e(qa,{className:"h-12 w-12"}),title:"Aucune session en attente",description:"Aucune session courrier en attente d'activation."}):e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:Z.map(v=>{var O,we;return r("div",{className:"rounded-xl border border-gray-200 bg-white p-5",children:[r("div",{className:"flex items-start justify-between gap-3 mb-4",children:[r("div",{children:[e("div",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"Agent"}),e("div",{className:"font-semibold text-gray-900",children:v.agentCode||v.agentId})]}),e("span",{className:"px-3 py-1 rounded-full text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-200",children:"En attente"})]}),r("div",{className:"text-xs text-gray-500 mb-3",children:["Cr√©√©e le ",v.createdAt?Oa((we=(O=v.createdAt).toDate)==null?void 0:we.call(O)):"‚Äî"]}),r(pt,{variant:"primary",onClick:()=>Jr(v.id),children:[e(Jt,{className:"h-4 w-4 mr-2"}),"Activer"]})]},v.id)})})]}),r("div",{className:"rounded-xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[r("div",{className:"flex items-center justify-between mb-4",children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-emerald-50 flex items-center justify-center",children:e(Jt,{className:"h-5 w-5 text-emerald-600"})}),r("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Sessions actives"}),e("div",{className:"text-sm text-gray-600",children:"L'agent peut enregistrer des envois. Cl√¥ture par l'agent uniquement."})]})]}),r("span",{className:"text-sm font-medium px-3 py-1.5 rounded-full bg-gray-100 text-gray-700",children:[k.length," session",k.length>1?"s":""]})]}),k.length===0?e(sa,{icon:e(Jt,{className:"h-12 w-12"}),title:"Aucune session active",description:"Aucune session courrier en cours."}):e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:k.map(v=>{var O,we;return r("div",{className:"rounded-xl border border-gray-200 bg-white p-5",children:[r("div",{className:"flex items-start justify-between gap-3 mb-4",children:[r("div",{children:[e("div",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"Agent"}),e("div",{className:"font-semibold text-gray-900",children:v.agentCode||v.agentId})]}),e("span",{className:"px-3 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200",children:"Active"})]}),r("div",{className:"text-xs text-gray-500",children:["Ouverte le ",v.openedAt?Oa((we=(O=v.openedAt).toDate)==null?void 0:we.call(O)):"‚Äî"]})]},v.id)})})]}),r("div",{className:"rounded-xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[r("div",{className:"flex items-center justify-between mb-4",children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-rose-50 flex items-center justify-center",children:e(nn,{className:"h-5 w-5 text-rose-600"})}),r("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Sessions cl√¥tur√©es √† valider"}),e("div",{className:"text-sm text-gray-600",children:"Saisissez le montant compt√© et validez la r√©ception."})]})]}),r("span",{className:"text-sm font-medium px-3 py-1.5 rounded-full bg-gray-100 text-gray-700",children:[q.length," session",q.length>1?"s":""]})]}),q.length===0?e(sa,{icon:e(Gt,{className:"h-12 w-12"}),title:"Aucune r√©ception en attente",description:"Toutes les sessions cl√¥tur√©es ont √©t√© valid√©es."}):e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:q.map(v=>{const O=ue[v.id]||{countedAmount:""},we=Number(String(O.countedAmount).replace(/[^\d.,]/g,"").replace(",",".")),de=Number(v.expectedAmount)||0,U=Number.isFinite(we)?we-de:0;return r("div",{className:"rounded-xl border border-gray-200 bg-white p-5",children:[r("div",{className:"flex items-start justify-between gap-3 mb-4",children:[r("div",{children:[e("div",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"Agent"}),e("div",{className:"font-semibold text-gray-900",children:v.agentCode||v.agentId})]}),e("span",{className:"px-3 py-1 rounded-full text-xs font-medium bg-rose-50 text-rose-700 border border-rose-200",children:"Cl√¥tur√©e"})]}),r("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e($t,{label:"Montant attendu",value:l(de),emphasis:!0}),e($t,{label:"√âcart",value:Number.isFinite(we)?l(U):"‚Äî"})]}),r("div",{className:"mb-4",children:[e("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:"Montant compt√©"}),e("input",{type:"text",inputMode:"decimal",className:"w-full border border-gray-300 rounded-lg px-3 py-2",placeholder:"0",value:O.countedAmount,onChange:ve=>Qr(v.id,ve.target.value)})]}),r(pt,{variant:"primary",disabled:!Number.isFinite(we)||we<0||!!ce[v.id],onClick:()=>$a(v),children:[e(Gt,{className:"h-4 w-4 mr-2"}),ce[v.id]?"Validation...":"Valider"]})]},v.id)})})]})]})]}),qt&&e("div",{className:"fixed inset-0 bg-black/50 grid place-items-center z-50 p-4",children:r("div",{className:"w-full max-w-md bg-white rounded-xl p-6 shadow-2xl",children:[r("div",{className:"flex items-center justify-between mb-6",children:[e("div",{className:"text-xl font-bold text-gray-900",children:"Nouveau mouvement de sortie"}),e("button",{onClick:()=>Ta(!1),className:"h-8 w-8 rounded-full flex items-center justify-center hover:bg-gray-100",children:e("span",{className:"text-gray-500",children:"√ó"})})]}),r("div",{className:"space-y-6",children:[r("div",{children:[e("div",{className:"text-sm font-medium text-gray-700 mb-3",children:"Type de mouvement"}),r("div",{className:"grid grid-cols-2 gap-3",children:[r("button",{type:"button",className:`p-4 rounded-xl border-2 text-center transition-all ${Ye.kind==="depense"?"border-blue-500 bg-blue-50 text-blue-700":"border-gray-200 bg-gray-50 text-gray-700 hover:border-gray-300"}`,onClick:()=>at(v=>({...v,kind:"depense"})),children:[e("div",{className:"font-medium",children:"D√©pense"}),e("div",{className:"text-xs text-gray-500 mt-1",children:"Achat, frais, etc."})]}),r("button",{type:"button",className:`p-4 rounded-xl border-2 text-center transition-all ${Ye.kind==="transfert_banque"?"border-blue-500 bg-blue-50 text-blue-700":"border-gray-200 bg-gray-50 text-gray-700 hover:border-gray-300"}`,onClick:()=>at(v=>({...v,kind:"transfert_banque"})),children:[e("div",{className:"font-medium",children:"Transfert banque"}),e("div",{className:"text-xs text-gray-500 mt-1",children:"Vers compte bancaire"})]})]})]}),r("div",{children:[r("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Libell√© ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{type:"text",className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:n.primary},placeholder:"Ex: Achat fournitures bureau",value:Ye.libelle,onChange:v=>at(O=>({...O,libelle:v.target.value}))})]}),Ye.kind==="transfert_banque"&&r("div",{children:[r("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Banque de la compagnie ",e("span",{className:"text-red-500",children:"*"})]}),m.length>0?r("select",{className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:n.primary},value:Ye.companyBankId||"",onChange:v=>at(O=>({...O,companyBankId:v.target.value,banque:""})),required:!0,children:[e("option",{value:"",children:"‚Äî Choisir une banque ‚Äî"}),m.map(v=>r("option",{value:v.id,children:[v.name,v.iban?` (${v.iban})`:""]},v.id))]}):r(bt,{children:[e("p",{className:"text-xs text-amber-700 mb-2",children:"Aucune banque configur√©e par la compagnie. Indiquez le compte manuellement (la tra√ßabilit√© tr√©sorerie ne sera pas mise √† jour)."}),e("input",{type:"text",className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:n.primary},placeholder:"Ex: BICIS - Compte principal",value:Ye.banque,onChange:v=>at(O=>({...O,banque:v.target.value,companyBankId:""}))})]})]}),r("div",{children:[r("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Montant (",d,") ",e("span",{className:"text-red-500",children:"*"})]}),r("div",{className:"relative",children:[e("input",{type:"number",min:"0",inputMode:"numeric",className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent text-lg font-medium",style:{outlineColor:n.primary},placeholder:"0",value:Ye.montant,onChange:v=>at(O=>({...O,montant:v.target.value}))}),e("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium",children:d})]})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Note (facultatif)"}),e("textarea",{className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent resize-none",style:{outlineColor:n.primary},placeholder:"Informations compl√©mentaires...",rows:3,value:Ye.note,onChange:v=>at(O=>({...O,note:v.target.value}))})]})]}),r("div",{className:"mt-8 flex justify-end gap-3",children:[e(pt,{variant:"secondary",onClick:()=>Ta(!1),children:"Annuler"}),r(pt,{variant:"primary",onClick:Zr,children:[e(Ka,{className:"h-4 w-4 mr-2"}),"Enregistrer le mouvement"]})]})]})})]})},Va=({active:a,onClick:t,label:i,icon:s,theme:n,badgeCount:l=0})=>r("button",{className:`
      flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all relative
      ${a?"text-white shadow-sm transform scale-105":"text-gray-600 hover:text-gray-900 hover:bg-white/80"}
    `,onClick:t,style:a?{background:`linear-gradient(135deg, ${n.primary}, ${n.secondary})`,boxShadow:`0 4px 12px ${n.primary}40`}:{},children:[s,e("span",{className:"whitespace-nowrap",children:i}),l>0&&e("span",{className:"absolute -top-1 -right-1 min-w-[1.25rem] h-5 px-1 flex items-center justify-center rounded-full bg-red-500 text-white text-xs font-bold",children:l>99?"99+":l})]}),Dt=({icon:a,label:t,value:i,sublabel:s,theme:n,emphasis:l})=>r("div",{className:`relative overflow-hidden rounded-xl border border-gray-200 p-5 bg-white shadow-sm
    hover:shadow-sm transition-all duration-300
    ${l?"ring-2 ring-offset-2":""}`,style:l?{"--tw-ring-color":n.primary}:void 0,children:[e("div",{className:"absolute top-0 right-0 h-20 w-20 opacity-10",children:e("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-200 to-gray-300 rounded-full blur-xl"})}),r("div",{className:"flex items-start justify-between mb-4",children:[e("div",{className:"text-sm font-medium text-gray-500 uppercase tracking-wider",children:t}),e("div",{className:"h-10 w-10 rounded-xl grid place-items-center",style:{background:`linear-gradient(135deg, ${n.primary}20, ${n.secondary}20)`},children:e("span",{className:"text-gray-700",children:a})})]}),r("div",{className:"space-y-1",children:[e("div",{className:`font-bold ${l?"text-3xl":"text-2xl"} text-gray-900`,children:i}),s&&e("div",{className:"text-xs font-medium text-gray-500",children:s})]})]}),na=({tone:a,label:t,value:i,icon:s})=>{const n={indigo:{bg:"bg-indigo-50",text:"text-indigo-700",border:"border-indigo-100"},emerald:{bg:"bg-emerald-50",text:"text-emerald-700",border:"border-emerald-100"},amber:{bg:"bg-amber-50",text:"text-amber-700",border:"border-amber-100"},rose:{bg:"bg-rose-50",text:"text-rose-700",border:"border-rose-100"},slate:{bg:"bg-slate-50",text:"text-slate-700",border:"border-slate-100"}}[a];return r("div",{className:`rounded-xl border ${n.border} p-4 bg-white shadow-sm hover:shadow-sm transition-shadow`,children:[r("div",{className:"flex items-center justify-between mb-2",children:[e("div",{className:`px-2.5 py-1 rounded-lg text-xs font-medium ${n.bg} ${n.text}`,children:t}),e("div",{className:`h-8 w-8 rounded-lg flex items-center justify-center ${n.bg}`,children:e("span",{className:n.text,children:s})})]}),e("div",{className:"text-2xl font-bold text-gray-900",children:i})]})},vs=({icon:a,title:t,subtitle:i})=>e("div",{className:"rounded-xl border border-gray-200 shadow-sm p-6 bg-gradient-to-r from-white to-gray-50/50",children:r("div",{className:"flex items-center gap-4",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center",children:a}),r("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:t}),i&&e("div",{className:"text-sm text-gray-600 mt-1",children:i})]})]})}),pn=({title:a,hint:t,icon:i,list:s,usersCache:n,liveStats:l,actions:d,theme:g})=>{const f=Nt();return r("div",{className:"rounded-xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[r("div",{className:"flex items-center justify-between mb-4",children:[r("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center",children:i}),r("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:a}),t&&e("div",{className:"text-sm text-gray-600",children:t})]})]}),r("div",{className:"text-sm font-medium px-3 py-1.5 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 shadow-inner",children:[s.length," poste",s.length>1?"s":""]})]}),s.length===0?e(sa,{icon:i,title:`Aucun ${a.toLowerCase()}`,description:"Aucun poste dans cet √©tat pour le moment"}):e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(b=>{var m,c,w,N;const I=n[b.userId]||{},C=I.name||b.userName||b.userEmail||b.userId,A=I.code||b.userCode||"‚Äî",u=l[b.id],x=(u==null?void 0:u.reservations)??b.totalReservations??0,h=(u==null?void 0:u.tickets)??b.totalTickets??0,L=(u==null?void 0:u.amount)??b.totalAmount??0,E={active:{label:"En service",colors:"bg-emerald-50 text-emerald-700 border-emerald-200"},paused:{label:"En pause",colors:"bg-amber-50 text-amber-700 border-amber-200"},closed:{label:"Cl√¥tur√©",colors:"bg-rose-50 text-rose-700 border-rose-200"},pending:{label:"En attente",colors:"bg-indigo-50 text-indigo-700 border-indigo-200"},validated:{label:"Valid√©",colors:"bg-slate-50 text-slate-700 border-slate-200"}}[b.status];return r("div",{className:`group relative rounded-xl border border-gray-200 bg-white p-5 
                         hover:border-gray-300 hover:shadow-md transition-all duration-300`,children:[e("div",{className:"absolute inset-0 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300",style:{background:`linear-gradient(135deg, ${g.primary}08, ${g.secondary}08)`}}),r("div",{className:"relative",children:[r("div",{className:"flex items-start justify-between gap-3 mb-4",children:[r("div",{className:"min-w-0",children:[e("div",{className:"text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Guichetier"}),r("div",{className:"font-semibold text-gray-900 truncate",children:[C,r("span",{className:"text-gray-500 text-sm ml-2",children:["(",A,")"]})]})]}),e("span",{className:`px-3 py-1 rounded-full text-xs font-medium border ${E.colors}`,children:E.label})]}),r("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e($t,{label:"R√©servations",value:x.toString()}),e($t,{label:"Billets",value:h.toString()}),e($t,{label:"D√©but",value:b.startTime?new Date(((c=(m=b.startTime).toDate)==null?void 0:c.call(m))??b.startTime).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):"‚Äî"}),e($t,{label:"Fin",value:b.endTime?new Date(((N=(w=b.endTime).toDate)==null?void 0:N.call(w))??b.endTime).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):"‚Äî"})]}),r("div",{className:"mb-5 p-3 rounded-xl bg-gradient-to-r from-gray-50 to-gray-100/50 border border-gray-200",children:[e("div",{className:"text-xs font-medium text-gray-500 uppercase tracking-wider mb-1",children:"Montant total"}),e("div",{className:"text-xl font-bold",style:{color:g.primary},children:f(L)})]}),e("div",{className:"flex justify-end",children:d(b)})]})]},b.id)})})]})},$t=({label:a,value:t,emphasis:i=!1})=>r("div",{children:[e("div",{className:"text-xs text-gray-500 mb-1",children:a}),e("div",{className:`font-medium ${i?"text-gray-900":"text-gray-700"}`,children:t})]}),sa=({icon:a,title:t,description:i})=>r("div",{className:"text-center py-12 px-4 rounded-xl border-2 border-dashed border-gray-300 bg-gradient-to-b from-white to-gray-50/50",children:[e("div",{className:"inline-flex h-16 w-16 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 items-center justify-center mb-4",children:a}),e("div",{className:"text-lg font-medium text-gray-900 mb-2",children:t}),e("div",{className:"text-sm text-gray-600 max-w-md mx-auto",children:i})]}),ft=({children:a,align:t="left",className:i="",colSpan:s})=>e("th",{colSpan:s,className:`px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider
      ${t==="right"?"text-right":"text-left"}
      ${i}`,children:a}),Me=({children:a,align:t="left",className:i="",colSpan:s})=>e("td",{colSpan:s,className:`px-4 py-3
      ${t==="right"?"text-right":"text-left"}
      ${i}`,children:a});function Id(a,t){if(console.log("[AgenceCompta] Export CSV des donn√©es de caisse"),!a.length){console.warn("[AgenceCompta] Aucune donn√©e √† exporter"),alert("Aucune donn√©e √† exporter");return}try{const i=["Date",`Entr√©es (${t})`,`Sorties (${t})`,`Solde (${t})`],s=a.map(f=>[new Date(f.dateISO).toLocaleDateString("fr-FR"),f.entrees.toLocaleString("fr-FR"),f.sorties.toLocaleString("fr-FR"),f.solde.toLocaleString("fr-FR")].join(";")),n=[i.join(";"),...s].join(`
`),l=new Blob([n],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(l),g=document.createElement("a");g.href=d,g.download=`caisse_agence_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(d),console.log("[AgenceCompta] Export CSV termin√© avec succ√®s")}catch(i){console.error("[AgenceCompta] Erreur lors de l'export CSV:",i),alert("Erreur lors de l'export CSV")}}const Hu=Object.freeze(Object.defineProperty({__proto__:null,default:Ad},Symbol.toStringTag,{value:"Module"})),Ns=[{label:"D√©parts du jour",icon:ur,path:"/agence/boarding",end:!0},{label:"Scan / Liste",icon:Co,path:"/agence/boarding/scan"}],Ed=["chefEmbarquement","chefAgence","admin_compagnie"],kd=()=>{var u,x;const{user:a,company:t,logout:i}=Ke(),s=aa(),n=Lt(t),l=br(),[d,g]=o.useState(()=>localStorage.getItem("theme")||"light");o.useEffect(()=>{document.documentElement.classList.toggle("dark",d==="dark"),localStorage.setItem("theme",d)},[d]),Ln(Ns);const f=Array.isArray(a==null?void 0:a.role)?a.role:a!=null&&a.role?[a.role]:[],b=new Set(f),I=h=>b.has(h);if(!Ed.some(h=>I(h)))return I("agency_fleet_controller")?e(kt,{to:"/agence/fleet",replace:!0}):I("chefAgence")||I("admin_compagnie")?e(kt,{to:"/agence/dashboard",replace:!0}):e(kt,{to:"/login",replace:!0});const A=async()=>{try{await i(),s("/login")}catch(h){console.error(h)}};return e("div",{className:d==="dark"?"agency-dark":"",children:e(_n,{sections:Ns,role:f[0]||"chefEmbarquement",userName:(a==null?void 0:a.displayName)??(a==null?void 0:a.nom),userEmail:a==null?void 0:a.email,brandName:(t==null?void 0:t.nom)??"Embarquement",logoUrl:t==null?void 0:t.logoUrl,primaryColor:(u=n==null?void 0:n.colors)==null?void 0:u.primary,secondaryColor:(x=n==null?void 0:n.colors)==null?void 0:x.secondary,onLogout:A,headerRight:r(bt,{children:[!l&&e("div",{className:"flex items-center gap-1 px-2 py-1 rounded-full bg-red-50 text-red-700 text-[10px] font-semibold mr-2",title:"Connexion perdue",children:e("span",{className:"hidden sm:inline",children:"Hors-ligne"})}),e("button",{onClick:()=>g(h=>h==="dark"?"light":"dark"),className:"ml-2 px-3 py-2 rounded-full border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-800 dark:text-white transition",title:"Changer le th√®me",children:d==="dark"?"‚òÄÔ∏è":"üåô"})]}),mainClassName:"agency-content-transition",children:e(gr,{})})})},Ku=Object.freeze(Object.defineProperty({__proto__:null,default:kd},Symbol.toStringTag,{value:"Module"}));function Rd(a){const t=a.getFullYear(),i=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${t}-${i}-${s}`}const Td=a=>a.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase(),Dd=()=>{const{user:a,company:t}=Ke(),i=aa(),s=(a==null?void 0:a.companyId)??null,n=(a==null?void 0:a.agencyId)??null,[l,d]=o.useState([]),[g,f]=o.useState([]),[b,I]=o.useState(!0),C=Rd(new Date),A=Td(new Date);o.useEffect(()=>{if(!s){f([]),I(!1);return}(async()=>{var x,h;I(!0);try{const E=(await Ee(he($,`companies/${s}/agences`))).docs.map(w=>{var N,R;return{id:w.id,nom:((N=w.data())==null?void 0:N.nom)??((R=w.data())==null?void 0:R.name)??w.id}});d(E);const m=n?[n]:E.map(w=>w.id),c=[];for(const w of m){const N=await Ee(he($,`companies/${s}/agences/${w}/weeklyTrips`)),R=((x=E.find(M=>M.id===w))==null?void 0:x.nom)??w,H=N.docs.map(M=>({id:M.id,...M.data()})).filter(M=>{var K,B;return M.active&&(((B=(K=M.horaires)==null?void 0:K[A])==null?void 0:B.length)??0)>0});for(const M of H){const K=(((h=M.horaires)==null?void 0:h[A])??[]).slice().sort();for(const B of K)c.push({agencyId:w,agencyNom:R,tripId:M.id,departure:M.departure,arrival:M.arrival,heure:B})}}f(c)}finally{I(!1)}})()},[s,n,A]);const u=(t==null?void 0:t.couleurPrimaire)??"#0ea5e9";return r("div",{className:"p-4 sm:p-6 max-w-4xl mx-auto min-h-screen text-sm sm:text-base text-gray-900 dark:text-white",style:{fontSize:"14px"},children:[e("h1",{className:"text-xl font-semibold mb-2 text-gray-900 dark:text-white",children:"D√©parts du jour"}),r("p",{className:"text-sm text-gray-600 dark:text-gray-200 mb-4",children:[ri(new Date)," ‚Äî S√©lectionnez un d√©part pour ouvrir la liste d'embarquement."]}),b?e("div",{className:"text-gray-600 dark:text-gray-200",children:"Chargement‚Ä¶"}):g.length===0?e("div",{className:"bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-600 shadow-md p-6 text-center text-gray-600 dark:text-gray-200",children:"Aucun d√©part planifi√© pour aujourd'hui."}):e("ul",{className:"space-y-2",children:g.map(x=>e("li",{children:r("button",{type:"button",onClick:()=>i("/agence/boarding/scan",{state:{agencyId:x.agencyId,date:C,trajet:`${x.departure} ‚Üí ${x.arrival}`,heure:x.heure,tripId:x.tripId,departure:x.departure,arrival:x.arrival}}),className:"w-full text-left px-4 py-3 rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700 shadow-md flex items-center justify-between text-gray-900 dark:text-white",style:{borderLeftWidth:4,borderLeftColor:u},children:[r("span",{className:"font-medium",children:[x.departure," ‚Üí ",x.arrival," √† ",x.heure]}),e("span",{className:"text-sm text-gray-500 dark:text-gray-200",children:x.agencyNom})]})},`${x.agencyId}_${x.tripId}_${x.heure}`))})]})},Yu=Object.freeze(Object.defineProperty({__proto__:null,default:Dd},Symbol.toStringTag,{value:"Module"})),$d={garage:["assigned","maintenance"],assigned:["in_transit"],in_transit:["arrived"],arrived:["garage"],maintenance:["garage"]};function jr(a,t){return $d[a].includes(t)}function Md(a,t,i,s){return`${a.trim()}_${t.trim()}_${i.trim()}_${s}`.replace(/\s+/g,"-")}function ui(a,t,i,s,n,l,d,g,f){return{vehicleId:a,fromAgencyId:t,toAgencyId:i,tripId:s,date:n,heure:l,movedBy:d,movedAt:Re(),previousStatus:g,newStatus:f}}function _d(a,t,i){return{status:"in_transit",destinationAgencyId:null,lastMovementAt:Re(),lastMovementBy:i,updatedAt:Re()}}async function Ld(a,t,i,s,n){const l=pe($,`companies/${a}/fleetVehicles/${t}`),d=pe(he($,`companies/${a}/fleetMovements`));await Ut($,async g=>{const f=await g.get(l);if(!f.exists())throw new Error("V√©hicule introuvable");const b=f.data(),I=b.status;if(!jr(I,i))throw new Error(`Transition interdite: ${I} ‚Üí ${i}`);const C=b.currentAgencyId??null,A=(n==null?void 0:n.toAgencyId)??(i==="arrived"?C:null);let u={status:i,lastMovementAt:Re(),lastMovementBy:s,updatedAt:Re()};i==="in_transit"?u.destinationAgencyId=(n==null?void 0:n.toAgencyId)??null:i==="arrived"&&(n!=null&&n.toAgencyId)?(u.currentAgencyId=n.toAgencyId,u.destinationAgencyId=null):i==="garage"&&(u.currentAgencyId=null,u.destinationAgencyId=null,u.currentTripId=null,u.currentDate=null,u.currentHeure=null,u.currentDeparture=null,u.currentArrival=null),g.update(l,u),g.set(d,ui(t,C,A,(n==null?void 0:n.tripId)??null,(n==null?void 0:n.date)??null,(n==null?void 0:n.heure)??null,s,I,i))})}function ws(a,t,i,s){return`${(a||"").trim()}_${(t||"").trim()}_${(i||"").trim()}_${s||""}`.replace(/\s+/g,"-")}const Pd="boardingStats";function Hr(a,t,i){return pe($,`companies/${a}/agences/${t}/${Pd}/${i}`)}function Fd(a,t,i){return Hr(a,t,i)}function jd(a,t,i,s,n){const l=Hr(t,i,s);a.set(l,{tripId:n.tripId,date:n.date,heure:n.heure,vehicleCapacity:n.vehicleCapacity,embarkedSeats:0,absentSeats:0,status:"open",updatedAt:Re()},{merge:!0})}function Od(a,t,i,s,n){if(n<=0)return;const l=Hr(t,i,s);a.update(l,{embarkedSeats:qe(n),updatedAt:Re()})}function Vd(a,t,i,s,n){const l=Hr(t,i,s);a.set(l,{status:"closed",absentSeats:n,updatedAt:Re()},{merge:!0})}function za(a){const t=a.getFullYear(),i=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${t}-${i}-${s}`}const Cs=a=>a.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase();function gn(a){const t=(a||"").trim();try{const s=new URL(t).pathname.split("/").filter(Boolean),n=s.findIndex(l=>l.toLowerCase()==="r");return n>=0&&s[n+1]?decodeURIComponent(s[n+1]):decodeURIComponent(s[s.length-1]||t)}catch{return t}}function Ss(a){return a?typeof a=="string"?a:typeof a.getText=="function"?a.getText():typeof a.text=="string"?a.text:String(a):""}function mi(a){return a.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function At(a){return mi((a||"").toLowerCase()).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim()}function $r(a){if(!a)return null;const t=a.trim().match(/^(\d{1,2}):(\d{2})$/);return t?t[1].padStart(2,"0")+":"+t[2]:null}function Ga(a){if(!a)return null;if(typeof a=="string"){const t=a.trim();if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const i=t.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);return i?`${i[3]}-${i[2].padStart(2,"0")}-${i[1].padStart(2,"0")}`:null}if(typeof a=="object"&&"seconds"in a){const t=new Date(a.seconds*1e3);return za(t)}return a instanceof Date?za(a):null}async function fn(a,t,i,s){const n={city:A=>A?mi(A).toLowerCase().trim():"",date:A=>A?Ga(A):null,time:A=>A?$r(A):null},l={dep:n.city(s==null?void 0:s.dep),arr:n.city(s==null?void 0:s.arr),date:n.date(s==null?void 0:s.date),heure:n.time(s==null?void 0:s.heure),id:(s==null?void 0:s.weeklyTripId)||null},d=A=>{let u=0;const x=n.city(A.depart),h=n.city(A.arrivee||A.arrival),L=n.date(A.date),E=n.time(A.heure);return l.id&&A.trajetId&&A.trajetId===l.id&&(u+=100),x&&l.dep&&x===l.dep&&(u+=20),h&&l.arr&&h===l.arr&&(u+=20),L&&l.date&&L===l.date&&(u+=30),E&&l.heure&&E===l.heure&&(u+=10),u},g=A=>{if(A.empty)return null;let u=null,x=-1;return A.docs.forEach(h=>{const L=d(h.data());L>x&&(x=L,u=h)}),u||A.docs[0]};if(t){const A=pe($,`companies/${a}/agences/${t}/reservations`,i),u=await He(A);if(u.exists())return{resId:u.id,agencyId:t};const x=Te(he($,`companies/${a}/agences/${t}/reservations`),ae("referenceCode","==",i)),h=await Ee(x),L=g(h);if(L)return{resId:L.id,agencyId:t}}const f=await Ee(he($,`companies/${a}/agences`));for(const A of f.docs){const u=pe($,`companies/${a}/agences/${A.id}/reservations`,i),x=await He(u);if(x.exists())return{resId:x.id,agencyId:A.id}}let b=null,I=null,C=-1;for(const A of f.docs){const u=Te(he($,`companies/${a}/agences/${A.id}/reservations`),ae("referenceCode","==",i)),x=await Ee(u);if(!x.empty){const h=g(x);if(h){const L=d(h.data());L>C&&(C=L,b=h,I=A.id)}}}return b&&I?{resId:b.id,agencyId:I}:null}const qd=({vehicleCapacity:a=null})=>{var G;const{user:t,company:i}=Ke(),s=Aa(),n="var(--teliya-primary)",l="var(--teliya-secondary)",d=(t==null?void 0:t.companyId)??null,g=(t==null?void 0:t.agencyId)??null,f=(t==null?void 0:t.uid)??null,[b,I]=o.useState([]),[C,A]=o.useState(g),[u,x]=o.useState(null),[h,L]=o.useState(((G=s.state)==null?void 0:G.date)||za(new Date)),[E,m]=o.useState([]),[c,w]=o.useState(null),[N,R]=o.useState([]),[H,M]=o.useState(!1),[K,B]=o.useState(""),[le,Q]=o.useState(!1),Z=o.useRef(null),j=o.useRef(null),k=o.useRef(0),W=o.useRef(0),[q,ye]=o.useState({});o.useEffect(()=>{(async()=>{if(!d)return;if(g){if(!b.length){const z=(await Ee(he($,`companies/${d}/agences`))).docs.map(ee=>{var ne,Ne;return{id:ee.id,nom:((ne=ee.data())==null?void 0:ne.nom)||((Ne=ee.data())==null?void 0:Ne.name)||ee.id}});I(z)}return}const P=(await Ee(he($,`companies/${d}/agences`))).docs.map(F=>{var z,ee;return{id:F.id,nom:((z=F.data())==null?void 0:z.nom)||((ee=F.data())==null?void 0:ee.name)||F.id}});I(P),P.length===1&&A(P[0].id)})()},[d,g,b.length]),o.useEffect(()=>{if(!d||!C){x(null);return}const y=pe($,`companies/${d}/agences/${C}`);He(y).then(P=>{P.exists()&&x({id:P.id,...P.data()})})},[d,C]),o.useEffect(()=>{if(ye({}),!d||!C||!c||!h)return;const y=(c.departure??"").trim(),P=(c.arrival??"").trim(),F=(c.heure??"").trim();!y||!P||Mo(d,C,y,P,h,F).then(z=>{z&&ye({bus:z.vehicleModel??"",immat:z.vehiclePlate??"",chauffeur:z.driverName??"",chauffeurPhone:z.driverPhone??"",chef:z.convoyeurName??"",chefPhone:z.convoyeurPhone??""})}).catch(()=>{})},[d,C,c,h]),o.useEffect(()=>{const y=s.state;if(y!=null&&y.agencyId&&A(y.agencyId),!(y!=null&&y.trajet)&&!(y!=null&&y.departure))return;const P=(y==null?void 0:y.departure)??(y!=null&&y.trajet?y.trajet.split("‚Üí").map(ee=>ee.trim())[0]:"")??"",F=(y==null?void 0:y.arrival)??(y!=null&&y.trajet?y.trajet.split("‚Üí").map(ee=>ee.trim())[1]:"")??"",z=(y==null?void 0:y.heure)??"";z&&(w({id:y==null?void 0:y.tripId,departure:P,arrival:F,heure:z}),y!=null&&y.date&&L(y.date))},[s.state]),o.useEffect(()=>{(async()=>{if(!d||!C){m([]);return}const P=he($,`companies/${d}/agences/${C}/weeklyTrips`),F=await Ee(P),z=Cs(new Date(h)),ee=F.docs.map(ne=>({id:ne.id,...ne.data()})).filter(ne=>{var Ne,ge;return ne.active&&((ge=(Ne=ne.horaires)==null?void 0:Ne[z])==null?void 0:ge.length)>0});if(m(ee),c&&!c.id){const ne=ee.find(Ne=>Ne.departure===c.departure&&Ne.arrival===c.arrival&&(Ne.horaires[z]||[]).includes(c.heure));ne&&w(Ne=>Ne&&{...Ne,id:ne.id})}})()},[d,C,h]),o.useEffect(()=>{if(!d||!C){R([]);return}if(!c||!c.departure||!c.arrival||!c.heure){R([]);return}M(!0),R([]);const y=he($,`companies/${d}/agences/${C}/reservations`),P=[],F=new Map,z=()=>{const ne=Array.from(F.values()).sort((Ne,ge)=>{const p=!!(Ne.canal==="report"||Ne.sourceReservationId),V=!!(ge.canal==="report"||ge.sourceReservationId);return p!==V?p?-1:1:(Ne.nomClient||"").localeCompare(ge.nomClient||"")});R(ne),M(!1)},ee=Te(y,ae("date","==",h),ae("depart","==",c.departure),ae("arrivee","==",c.arrival),ae("heure","==",c.heure),ae("statut","in",[...pr,"valid√©"]));if(P.push(Ge(ee,ne=>{ne.docs.forEach(Ne=>F.set(Ne.id,{id:Ne.id,...Ne.data()})),z()},()=>M(!1))),c.id){const ne=Te(y,ae("date","==",h),ae("trajetId","==",c.id),ae("heure","==",c.heure),ae("statut","in",[...pr,"valid√©"]));P.push(Ge(ne,Ne=>{Ne.docs.forEach(ge=>F.set(ge.id,{id:ge.id,...ge.data()})),z()},()=>M(!1)))}return()=>P.forEach(ne=>ne())},[d,C,c,h]);const se=o.useCallback(async(y,P,F)=>{if(!d||!f)return;const z=F??C;if(!z){alert("S√©lectionne d‚Äôabord une agence.");return}if(!c||!h){alert("S√©lectionne la date et le trajet avant d‚Äôembarquer.");return}const ee=pe($,`companies/${d}/agences/${z}/reservations/${y}`);if(P==="embarqu√©"&&a!=null&&a>0){const ne=Te(he($,`companies/${d}/agences/${z}/reservations`),ae("date","==",h),ae("heure","==",c.heure),ae("statutEmbarquement","==","embarqu√©")),Ne=await Ee(ne);let ge=0;Ne.docs.forEach(Ce=>{const Se=Ce.data();(Se.trajetId===(c==null?void 0:c.id)||At(Se.depart)===At(c.departure)&&At(Se.arrivee||Se.arrival)===At(c.arrival))&&(ge+=Se.seatsGo??1)});const p=await He(ee),V=p.exists()?p.data():null,fe=(V==null?void 0:V.statutEmbarquement)==="embarqu√©"?0:(V==null?void 0:V.seatsGo)??1;if(ge+fe>a)throw new Error("Capacit√© v√©hicule atteinte")}try{await Ut($,async ne=>{const Ne=await ne.get(ee);if(!Ne.exists())throw new Error("R√©servation introuvable");const ge=Ne.data();if(P==="embarqu√©"){const st=wl({statut:ge.statut,date:ge.date});if(!El(st))throw(st??"")==="embarque"?new Error("D√©j√† embarqu√©"):new Error("Billet non valide (annul√©, rembours√© ou expir√©).")}const p=At(ge.depart),V=At(ge.arrivee??ge.arrival),re=$r(ge.heure??""),fe=Ga(ge.date),Ce=At(c.departure),Se=At(c.arrival),De=$r(c.heure),Ze=Ga(h),nt=!!(ge.trajetId&&(c!=null&&c.id)&&ge.trajetId===c.id),ct=p===Ce&&V===Se&&re===De&&fe===Ze,wt=p===Ce&&V===Se&&fe===Ze;let ut=!1;const Pt=(c==null?void 0:c.id)??ge.trajetId??null,vt=ge.trajetId??null;if(!nt&&(Pt||vt))try{let st=null,Ct=null;if(c!=null&&c.id){const it=pe($,`companies/${d}/agences/${z}/weeklyTrips/${c.id}`),yt=await ne.get(it);if(yt.exists()){const Ue=yt.data();st={departure:Ue==null?void 0:Ue.departure,arrival:Ue==null?void 0:Ue.arrival}}}else if(Pt){const it=pe($,`companies/${d}/agences/${z}/weeklyTrips/${Pt}`),yt=await ne.get(it);if(yt.exists()){const Ue=yt.data();st={departure:Ue==null?void 0:Ue.departure,arrival:Ue==null?void 0:Ue.arrival}}}if(vt){const it=pe($,`companies/${d}/agences/${z}/weeklyTrips/${vt}`),yt=await ne.get(it);if(yt.exists()){const Ue=yt.data();Ct={departure:Ue==null?void 0:Ue.departure,arrival:Ue==null?void 0:Ue.arrival}}}if(st&&Ct){const it=At(st.departure),yt=At(st.arrival),Ue=At(Ct.departure),Xa=At(Ct.arrival);ut=it===Ue&&yt===Xa}}catch{}if(!(nt||ct||wt||ut))throw new Error("Billet pour un autre d√©part (date/heure/trajet non concordants).");if(P==="embarqu√©"){const st=ws(Ce??"",Se??"",De??"",h),Ct=Fd(d,z,st),it=await ne.get(Ct);it.exists()||(jd(ne,d,z,st,{tripId:(c==null?void 0:c.id)??ge.trajetId??null,date:h,heure:(c==null?void 0:c.heure)??ge.heure??"",vehicleCapacity:a??0}),Mc(ne,d,z));const yt=it.exists()?it.data().embarkedSeats??0:0,Ue=ge.statutEmbarquement==="embarqu√©"?0:Number(ge.seatsGo)||1;if(a!=null&&a>0&&yt+Ue>a)throw new Error("Capacit√© v√©hicule atteinte");Od(ne,d,z,st,Ue)}if(ge.statutEmbarquement==="embarqu√©"&&P==="embarqu√©")throw new Error("D√©j√† embarqu√©");const Ea=pe($,`companies/${d}/agences/${z}/boardingLocks/${y}`),la=await ne.get(Ea);if(la.exists()&&P==="embarqu√©")throw new Error("D√©j√† embarqu√©");P==="embarqu√©"&&!la.exists()&&ne.set(Ea,{reservationId:y,by:f,at:Re(),tripId:(c==null?void 0:c.id)??ge.trajetId??null,date:h,heure:(c==null?void 0:c.heure)??ge.heure??null});const Vt={statutEmbarquement:P,controleurId:f,checkInTime:P==="embarqu√©"?Re():null};P==="embarqu√©"&&(Vt.statut="embarque",Vt.auditLog=Vs(ai(String(ge.statut??""),"embarque",{userId:f,userRole:(t==null?void 0:t.role)??"controleur_embarquement"}))),ne.update(ee,Vt);const ka=he($,`companies/${d}/agences/${z}/boardingLogs`);ne.set(pe(ka),{reservationId:y,trajetId:(c==null?void 0:c.id)??ge.trajetId??null,departure:(c==null?void 0:c.departure)??ge.depart,arrival:(c==null?void 0:c.arrival)??ge.arrivee??ge.arrival,date:h,heure:(c==null?void 0:c.heure)??ge.heure,result:(P==="embarqu√©"?"EMBARQUE":P).toUpperCase(),controleurId:f,scannedAt:Re()})});try{new Audio("/beep.mp3").play()}catch{}}catch(ne){const Ne=String((ne==null?void 0:ne.message)||ne||"");Ne.includes("D√©j√† embarqu√©")?alert("Billet d√©j√† embarqu√©."):Ne.includes("Capacit√© v√©hicule atteinte")?alert("Capacit√© v√©hicule atteinte. Impossible d'embarquer davantage."):Ne.includes("non concordants")?alert("Billet pour un autre d√©part (date/heure/trajet non concordants)."):alert("Erreur d‚Äôembarquement."),console.error("[EMBARK][ERROR]",ne)}},[d,C,f,c==null?void 0:c.id,c==null?void 0:c.departure,c==null?void 0:c.arrival,c==null?void 0:c.heure,h,a]);async function Y(y,P,F,z,ee){var ge;let ne=null;if(z.id){const p=await He(pe(y,`companies/${P}/agences/${F}/weeklyTrips/${z.id}`));p.exists()&&(ne={id:p.id,...p.data()})}if(!ne){const p=he(y,`companies/${P}/agences/${F}/weeklyTrips`);ne=(await Ee(p)).docs.map(re=>({id:re.id,...re.data()})).find(re=>re.active&&re.departure===z.departure&&re.arrival===z.arrival)||null}if(!ne)throw new Error("Trajet hebdo introuvable.");const Ne=new Date(`${ee}T${z.heure||"00:00"}:00`);for(let p=0;p<14;p++){const V=new Date(Ne);V.setDate(V.getDate()+p);const re=V.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase(),fe=(((ge=ne.horaires)==null?void 0:ge[re])||[]).slice().sort();if(fe.length)if(p===0){const Ce=fe.filter(Se=>Se>z.heure);if(Ce.length)return{date:ee,heure:Ce[0]}}else return{date:za(V),heure:fe[0]}}throw new Error("Aucun prochain d√©part disponible.")}o.useCallback(async y=>{if(!d||!C||!f||!c||!h){alert("Contexte incomplet (agence, trajet ou date manquants).");return}const P=pe($,`companies/${d}/agences/${C}/reservations/${y}`),F=await He(P);if(!F.exists())return alert("R√©servation introuvable.");const z=F.data();if(!(z.noShowAt||z.reprogrammedOnce===!0))try{const ee=await Y($,d,C,{id:z.trajetId||c.id,departure:z.depart||c.departure,arrival:z.arrivee||z.arrival||c.arrival,heure:z.heure||c.heure},Ga(z.date)||h),ne=Kn($);ne.update(P,{statutEmbarquement:"absent",noShowAt:Re(),noShowBy:f,reprogrammedOnce:!0});const Ne=pe(he($,`companies/${d}/agences/${C}/reservations`));ne.set(Ne,{companyId:d,agencyId:C,depart:z.depart,arrivee:z.arrivee||z.arrival,trajetId:z.trajetId||c.id||null,date:ee.date,heure:ee.heure,nomClient:z.nomClient,telephone:z.telephone,seatsGo:z.seatsGo||1,canal:"report",statut:"confirme",statutEmbarquement:"en_attente",sourceReservationId:y,createdBy:f,createdAt:Re()});const ge=pe(he($,`companies/${d}/agences/${C}/boardingLogs`));ne.set(ge,{reservationId:y,trajetId:z.trajetId||c.id||null,departure:z.depart,arrival:z.arrivee||z.arrival,date:h,heure:c.heure,result:"ABSENT_REPROG",nextDate:ee.date,nextHeure:ee.heure,controleurId:f,scannedAt:Re()}),await ne.commit()}catch(ee){console.error(ee)}},[d,C,f,c,h]);const ue=o.useMemo(()=>{if(!c||!h)return null;const y=At(c.departure),P=At(c.arrival),F=$r(c.heure),z=Ga(h);return!y||!P||!F||!z?null:`${y}_${P}_${F}_${z}`},[c,h]),[T,ce]=o.useState(!1);o.useEffect(()=>{if(!d||!C||!ue){ce(!1);return}const y=pe($,`companies/${d}/agences/${C}/boardingClosures/${ue}`),P=Ge(y,F=>ce(F.exists()));return()=>P()},[d,C,ue]);const Ie=o.useCallback(async()=>{if(!d||!C||!f||!c||!h){alert("Contexte incomplet (agence, trajet ou date manquants).");return}if(N.length===0){alert("Aucune r√©servation √† traiter.");return}if(!ue){alert("Trajet invalide.");return}const y=pe($,`companies/${d}/agences/${C}/boardingClosures/${ue}`),P=c.id??null;let F=[];try{const z=he($,`companies/${d}/fleetVehicles`),ee=Te(z,ae("currentAgencyId","==",C),ae("currentDate","==",h),ae("currentHeure","==",c.heure),ae("status","==","assigned"));F=(await Ee(ee)).docs.filter(Ne=>Ne.data().currentTripId===P).map(Ne=>({id:Ne.id}))}catch{}try{await Ut($,async ee=>{if((await ee.get(y)).exists())throw new Error("DEJA_CLOTURE");for(const Ce of N)if(!(Ce.statutEmbarquement==="embarqu√©")){const De=pe($,`companies/${d}/agences/${C}/reservations/${Ce.id}`);ee.update(De,{statutEmbarquement:"absent",noShowAt:Re(),noShowBy:f})}ee.set(y,{closedAt:Re(),closedBy:f,date:h,heure:c.heure,departure:c.departure,arrival:c.arrival});const Ne=pe(he($,`companies/${d}/agences/${C}/boardingLogs`));ee.set(Ne,{result:"CLOSURE",date:h,heure:c.heure,departure:c.departure,arrival:c.arrival,trajetId:P,closedBy:f,scannedAt:Re()}),kc(ee,d,C,h);const ge=ws(c.departure,c.arrival,c.heure,h),p=N.filter(Ce=>Ce.statutEmbarquement!=="embarqu√©").reduce((Ce,Se)=>Ce+(Se.seatsGo??1),0);Vd(ee,d,C,ge,p),_c(ee,d,C);const V=he($,`companies/${d}/fleetMovements`),re=_d(C,null,f);let fe=0;for(const{id:Ce}of F){const Se=pe($,`companies/${d}/fleetVehicles/${Ce}`),De=await ee.get(Se);if(!De.exists())continue;const Ze=De.data();if(Ze.status!=="assigned"||Ze.currentTripId!==P||!jr("assigned","in_transit"))continue;ee.update(Se,re);const nt=pe(V);ee.set(nt,ui(Ce,C,null,P,h,c.heure,f,"assigned","in_transit")),fe+=1}fe>0&&Lc(ee,d,C,fe)});const z=Kn($);for(const ee of N)if(!(ee.statutEmbarquement==="embarqu√©"||ee.reprogrammedOnce===!0||!(await Ee(Te(he($,`companies/${d}/agences/${C}/reservations`),ae("sourceReservationId","==",ee.id),Tt(1)))).empty))try{const ge=await Y($,d,C,{id:ee.trajetId||c.id,departure:ee.depart||c.departure,arrival:ee.arrivee||ee.arrival||c.arrival,heure:ee.heure||c.heure},Ga(ee.date)||h),p=pe(he($,`companies/${d}/agences/${C}/reservations`));z.set(p,{companyId:d,agencyId:C,depart:ee.depart,arrivee:ee.arrivee||ee.arrival,trajetId:ee.trajetId||c.id||null,date:ge.date,heure:ge.heure,nomClient:ee.nomClient,telephone:ee.telephone,seatsGo:ee.seatsGo||1,canal:"report",statut:"confirme",statutEmbarquement:"en_attente",sourceReservationId:ee.id,createdBy:f,createdAt:Re()});const V=pe($,`companies/${d}/agences/${C}/reservations/${ee.id}`);z.update(V,{reprogrammedOnce:!0});const re=pe(he($,`companies/${d}/agences/${C}/boardingLogs`));z.set(re,{reservationId:ee.id,trajetId:ee.trajetId||c.id||null,departure:ee.depart,arrival:ee.arrivee||ee.arrival,date:h,heure:c.heure,result:"ABSENT_REPROG",nextDate:ge.date,nextHeure:ge.heure,controleurId:f,scannedAt:Re()})}catch(ge){console.warn("Pas de prochain d√©part pour",ee.id,ge)}await z.commit(),alert("Cl√¥ture effectu√©e. Absents marqu√©s et reprogramm√©s (si possible).")}catch(z){String((z==null?void 0:z.message)||z)==="DEJA_CLOTURE"?alert("D√©j√† cl√¥tur√© : aucune action r√©p√©t√©e."):(console.error(z),alert("Erreur lors de la cl√¥ture."))}},[d,C,f,c,h,N,ue]),[Ve,Fe]=o.useState(""),te=o.useCallback(async y=>{if(y.preventDefault(),!d)return;const P=gn(Ve);if(P)try{const F=await fn(d,C,P,c?{dep:c.departure,arr:c.arrival,date:h,heure:c.heure,weeklyTripId:c.id||null}:void 0);F?(await se(F.resId,"embarqu√©",F.agencyId),Fe("")):alert("R√©servation introuvable.")}catch(F){console.error(F),alert("Erreur lors de la validation manuelle.")}},[Ve,d,C,se,c,h]);o.useEffect(()=>{var P,F,z,ee;if(!le){(F=(P=j.current)==null?void 0:P.reset)==null||F.call(P),j.current=null,(z=Z.current)!=null&&z.srcObject&&((ee=Z.current.srcObject)==null||ee.getTracks().forEach(ne=>ne.stop()),Z.current.srcObject=null);return}const y=new zn;return j.current=y,(async()=>{var ne;try{await y.decodeFromConstraints({video:{facingMode:{ideal:"environment"}}},Z.current,async Ne=>{const ge=Date.now();if(!Ne||ge-k.current<1200)return;k.current=ge;const p=Ss(Ne),V=gn(p);try{const re=await fn(d,C,V,c?{dep:c.departure,arr:c.arrival,date:h,heure:c.heure,weeklyTripId:c.id||null}:void 0);re?await se(re.resId,"embarqu√©",re.agencyId):ge-W.current>2e3&&(W.current=ge,alert("Billet introuvable."))}catch(re){console.error(re),ge-W.current>2e3&&(W.current=ge,alert("Erreur lors du scan"))}})}catch{const Ne=await zn.listVideoInputDevices(),ge=((ne=Ne==null?void 0:Ne[0])==null?void 0:ne.deviceId)??null;await y.decodeFromVideoDevice(ge,Z.current,async p=>{const V=Date.now();if(!p||V-k.current<1200)return;k.current=V;const re=Ss(p),fe=gn(re);try{const Ce=await fn(d,C,fe,c?{dep:c.departure,arr:c.arrival,date:h,heure:c.heure,weeklyTripId:c.id||null}:void 0);Ce?await se(Ce.resId,"embarqu√©",Ce.agencyId):V-W.current>2e3&&(W.current=V,alert("Billet introuvable."))}catch(Ce){console.error(Ce),V-W.current>2e3&&(W.current=V,alert("Erreur lors du scan"))}})}})(),()=>{var ne,Ne,ge,p;(Ne=(ne=j.current)==null?void 0:ne.reset)==null||Ne.call(ne),j.current=null,(ge=Z.current)!=null&&ge.srcObject&&((p=Z.current.srcObject)==null||p.getTracks().forEach(V=>V.stop()),Z.current.srcObject=null)}},[le,d,C,se,c,h]);const Ae=o.useMemo(()=>{const y=K.toLowerCase().trim();return y?N.filter(P=>(P.nomClient||"").toLowerCase().includes(y)||(P.telephone||"").includes(K)):N},[N,K]),ke=o.useMemo(()=>{let y=0,P=0,F=0,z=0;for(const ee of N){const ne=ee.seatsGo??1;y+=1,P+=ne,ee.statutEmbarquement==="embarqu√©"&&(F+=ne),ee.statutEmbarquement==="absent"&&(z+=ne)}return{totalRes:y,totalSeats:P,seatsEmbarques:F,seatsAbsents:z}},[N]),Pe=o.useMemo(()=>{try{const y=new Date(h+"T00:00:00");return Je(y,"dd/MM/yyyy")}catch{return h}},[h]),je=o.useMemo(()=>Cs(new Date(h)),[h]),D=o.useMemo(()=>E.length?E.flatMap(y=>(y.horaires[je]||[]).map(P=>{const F=(c==null?void 0:c.departure)===y.departure&&(c==null?void 0:c.arrival)===y.arrival&&(c==null?void 0:c.heure)===P;return r("button",{onClick:()=>w({id:y.id,departure:y.departure,arrival:y.arrival,heure:P}),className:`px-3 py-2 rounded-lg text-sm font-medium shadow-sm ${F?"text-white":"bg-gray-200 text-gray-700"}`,style:F?{background:n}:void 0,children:[y.departure," ‚Üí ",y.arrival," √† ",P]},`${y.id}_${P}`)})):[],[E,je,c]);return t?r("div",{className:"agency-content-transition",children:[e("style",{children:`
        .brand-logo{height:40px;width:auto;object-fit:contain}
        .case{display:inline-flex;align-items:center;justify-content:center;min-width:20px;min-height:20px;width:20px;height:20px;border:2px solid #0f172a;border-radius:6px;background:#fff;cursor:pointer;user-select:none}
        .case[data-checked="true"]::after{content:"‚úì";font-weight:700;font-size:12px}

        .thin-table { table-layout: fixed; }
        .thin-table th, .thin-table td { padding: 6px 8px; }
        .col-idx{width:40px}
        .col-client{width:24%}
        .col-phone{width:14%}
        .col-canal{width:12%}
        .col-ref{width:18%}
        .col-seats{width:8%}
        .col-emb{width:8%}
        .col-abs{width:8%}

        @media (max-width: 640px){
          .col-client{width:38%}
          .col-phone{width:18%}
          .col-ref{width:22%}
        }

        /* Header imprimable centr√© */
        #print-area .title{ text-align:center; font-weight:800; font-size:18px; }
        #print-area .subtitle{ text-align:center; font-size:14px; margin-top:2px; }

        /* zones signatures √©pur√©es */
        #print-area .sig-box {
          border: 1px solid #000;
          min-height: 28mm;
          border-radius: 6px;
        }
        #print-area .sig-caption { text-align:center; margin-top:6px; }

        @media print{
          body * { visibility: hidden; }
          #print-area, #print-area * { visibility: visible; }
          #print-area { position: absolute; inset: 0; padding: 0 8mm; }
          .brand-logo{height:26px}
          .case{width:14px;height:14px;border:1.5px solid #000;border-radius:0}
          .case::after{font-size:12px;line-height:1}
          tr.embarked { background:transparent !important; color:inherit !important; }
        }
      `}),r("div",{className:"max-w-7xl mx-auto px-4 py-6 space-y-6",children:[r("div",{className:"no-print bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-600 p-4 shadow-md space-y-3",children:[r("div",{className:"flex flex-wrap items-center gap-3",children:[r("div",{className:"flex items-center gap-2",children:[e("span",{className:"font-semibold",style:{color:l},children:"Agence :"}),C?e("span",{className:"px-2 py-1 rounded border bg-gray-50 text-sm",children:(u==null?void 0:u.nomAgence)||"‚Äî"}):r("select",{className:"px-2 py-1 border rounded text-sm",value:C||"",onChange:y=>A(y.target.value||null),children:[e("option",{value:"",children:"‚Äî Choisir une agence ‚Äî"}),b.map(y=>e("option",{value:y.id,children:y.nom},y.id))]})]}),e("span",{className:"font-semibold",style:{color:l},children:"Date :"}),e("button",{className:"px-2 py-1 rounded border",onClick:()=>{const y=new Date(h);y.setDate(y.getDate()-1),L(za(y))},children:"‚óÄ Jour pr√©c√©dent"}),e("input",{type:"date",className:"border rounded px-3 py-1",value:h,onChange:y=>L(y.target.value)}),e("button",{className:"px-2 py-1 rounded border",onClick:()=>{const y=new Date(h);y.setDate(y.getDate()+1),L(za(y))},children:"Jour suivant ‚ñ∂"})]}),e("div",{className:"font-semibold",children:"S√©lectionner un trajet"}),e("div",{className:"flex flex-wrap gap-2",children:C?E.length===0?e("div",{className:"text-gray-500 dark:text-gray-200",children:"Aucun trajet planifi√© pour cette date"}):D:e("div",{className:"text-gray-500 dark:text-gray-200",children:"Choisissez d‚Äôabord une agence."})})]}),r("div",{className:"bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-600 shadow-md",children:[r("div",{className:"px-4 pt-4 flex flex-wrap items-center gap-3",children:[e("div",{className:"text-sm text-gray-500 dark:text-gray-200",children:"Trajet"}),e("div",{className:"font-semibold text-gray-900 dark:text-white",children:c?r(bt,{children:[c.departure," ‚Äî ",c.arrival," ‚Ä¢ ",Pe," √† ",c.heure]}):"Aucun trajet s√©lectionn√©"}),r("div",{className:"ml-auto flex flex-wrap items-center gap-2 text-xs",children:[r("div",{className:"px-2.5 py-1.5 rounded-lg bg-blue-600 text-white font-medium",children:[e("span",{className:"opacity-90",children:"R√©servations:"})," ",e("b",{children:ke.totalRes})]}),r("div",{className:"px-2.5 py-1.5 rounded-lg bg-indigo-600 text-white font-medium",children:[e("span",{className:"opacity-90",children:"Places:"})," ",e("b",{children:ke.totalSeats})]}),r("div",{className:"px-2.5 py-1.5 rounded-lg bg-green-600 text-white font-medium",children:[e("span",{className:"opacity-90",children:"Embarqu√©s:"})," ",e("b",{children:ke.seatsEmbarques})]}),r("div",{className:"px-2.5 py-1.5 rounded-lg bg-red-600 text-white font-medium",children:[e("span",{className:"opacity-90",children:"Absent:"})," ",e("b",{children:ke.seatsAbsents})]}),a!=null&&r("div",{className:"px-2 py-1 rounded bg-blue-50 dark:bg-slate-700 border border-blue-200 dark:border-slate-600",children:[e("span",{className:"text-gray-500 dark:text-gray-200",children:"Capacit√© v√©hicule:"})," ",e("b",{className:"text-gray-900 dark:text-white",children:a})," places",a>0&&r("span",{className:"ml-1 text-sm",children:[" ‚Äî Remplissage: ",Math.round(ke.seatsEmbarques/a*100),"%"]})]}),a!=null&&a>0&&ke.seatsEmbarques>=a&&e("div",{className:"px-2 py-1 rounded bg-amber-100 border border-amber-300 text-amber-800 text-sm font-medium",children:"Capacit√© atteinte"})]})]}),r("div",{className:"px-4 pb-3 grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r("div",{className:"border border-gray-200 dark:border-slate-600 rounded-xl p-3 bg-gray-50 dark:bg-slate-800 shadow-md",children:[e("div",{className:"text-xs text-gray-500 dark:text-gray-200 mb-1",children:"V√©hicule / Plaque"}),e("div",{className:"font-medium text-gray-900 dark:text-white",children:q.bus||q.immat?`${q.bus||"‚Äî"} / ${q.immat||"‚Äî"}`:"‚Äî / ‚Äî"})]}),r("div",{className:"border border-gray-200 dark:border-slate-600 rounded-xl p-3 bg-gray-50 dark:bg-slate-800 shadow-md",children:[e("div",{className:"text-xs text-gray-500 dark:text-gray-200 mb-1",children:"Chauffeur"}),e("div",{className:"font-medium text-gray-900 dark:text-white",children:q.chauffeur||"‚Äî"}),q.chauffeurPhone&&r("div",{className:"text-xs text-gray-600 dark:text-gray-200 mt-0.5",children:["T√©l. ",q.chauffeurPhone]})]}),r("div",{className:"border border-gray-200 dark:border-slate-600 rounded-xl p-3 bg-gray-50 dark:bg-slate-800 shadow-md",children:[e("div",{className:"text-xs text-gray-500 dark:text-gray-200 mb-1",children:"Convoyeur"}),e("div",{className:"font-medium text-gray-900 dark:text-white",children:q.chef||"‚Äî"}),q.chefPhone&&r("div",{className:"text-xs text-gray-600 dark:text-gray-200 mt-0.5",children:["T√©l. ",q.chefPhone]})]})]}),r("div",{className:"no-print px-4 pb-3 flex flex-wrap items-center gap-3",children:[e("input",{type:"text",placeholder:"Rechercher nom / t√©l√©phone‚Ä¶",value:K,onChange:y=>B(y.target.value),className:"flex-1 min-w-0 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg text-sm bg-white dark:bg-slate-900 text-gray-900 dark:text-white"}),e("button",{type:"button",onClick:()=>Q(y=>!y),className:`w-full sm:w-auto px-3 py-2 rounded-lg text-sm min-h-[40px] ${le?"bg-emerald-600 text-white":"bg-gray-200 text-gray-700 dark:bg-slate-700 dark:text-gray-200"}`,title:"Activer le scanner (QR / code-barres)",disabled:!c||!C,children:le?"Scanner ON":"Scanner OFF"}),e("button",{type:"button",onClick:()=>window.print(),className:"w-full sm:w-auto px-3 py-2 rounded-lg text-sm border border-gray-300 dark:border-slate-600 min-h-[40px]",title:"Imprimer la liste",children:"üñ®Ô∏è Imprimer"}),e("button",{type:"button",onClick:Ie,className:`w-full sm:w-auto px-3 py-2 rounded-lg text-sm min-h-[40px] ${T?"bg-gray-300 text-gray-600":"bg-red-600 text-white"}`,title:T?"D√©j√† cl√¥tur√©":"Cl√¥turer l‚Äôembarquement",disabled:!c||!C||T,children:T?"Cl√¥tur√©":"üöç Cl√¥turer"})]}),le&&e("div",{className:"no-print px-4 pb-4 w-full",children:e("video",{ref:Z,className:"w-full sm:max-w-md aspect-video bg-black rounded-xl overflow-hidden",muted:!0,playsInline:!0,autoPlay:!0})})]}),r("div",{className:"no-print bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-600 shadow-md p-4",children:[e("div",{className:"text-sm font-semibold mb-2",style:{color:l},children:"Saisir une r√©f√©rence"}),r("form",{onSubmit:te,className:"flex gap-2",children:[e("input",{value:Ve,onChange:y=>Fe(y.target.value),placeholder:"ID Firestore ou r√©f√©rence (REF-‚Ä¶ / MT-‚Ä¶)",className:"flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg text-sm bg-white dark:bg-slate-900 text-gray-900 dark:text-white"}),e("button",{type:"submit",className:"px-3 py-2 rounded-lg text-white text-sm",style:{background:n},disabled:!C&&!g,children:"Valider"})]})]}),r("div",{id:"print-area",className:"bg-white rounded-xl border shadow-sm",children:[r("div",{className:"px-4 pt-4",children:[e("div",{className:"flex items-center justify-between gap-3",children:r("div",{className:"flex items-center gap-3",children:[(i==null?void 0:i.logoUrl)&&e("img",{src:i.logoUrl,alt:i==null?void 0:i.nom,className:"brand-logo"}),r("div",{children:[e("div",{className:"font-extrabold text-lg",children:(i==null?void 0:i.nom)??"‚Äî"}),r("div",{className:"text-xs text-gray-500 dark:text-gray-200",children:[(u==null?void 0:u.nomAgence)||"Agence"," ‚Ä¢ Tel. ",(u==null?void 0:u.telephone)||"‚Äî"]})]})]})}),r("div",{className:"mt-2",children:[e("div",{className:"title",children:"Liste d‚Äôembarquement"}),c&&r("div",{className:"subtitle text-gray-700 dark:text-gray-200",children:[c.departure," ‚Üí ",c.arrival," ‚Ä¢ ",Pe," ‚Ä¢ ",c.heure]})]}),r("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-4 gap-2",children:[r("div",{className:"meta-card bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-lg px-3 py-2 text-gray-900 dark:text-white",children:[e("div",{className:"text-xs text-gray-500 dark:text-gray-200",children:"V√©hicule / Plaque"}),e("div",{className:"font-medium",children:(q.bus||"‚Äî")+" / "+(q.immat||"‚Äî")})]}),r("div",{className:"meta-card bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-lg px-3 py-2 text-gray-900 dark:text-white",children:[e("div",{className:"text-xs text-gray-500 dark:text-gray-200",children:"Chauffeur"}),e("div",{className:"font-medium",children:q.chauffeur||"‚Äî"}),q.chauffeurPhone&&r("div",{className:"text-xs text-gray-600 dark:text-gray-200",children:["T√©l. ",q.chauffeurPhone]})]}),r("div",{className:"meta-card bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-lg px-3 py-2 text-gray-900 dark:text-white",children:[e("div",{className:"text-xs text-gray-500 dark:text-gray-200",children:"Convoyeur"}),e("div",{className:"font-medium",children:q.chef||"‚Äî"}),q.chefPhone&&r("div",{className:"text-xs text-gray-600 dark:text-gray-200",children:["T√©l. ",q.chefPhone]})]}),r("div",{className:"meta-card bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-lg px-3 py-2 text-gray-900 dark:text-white",children:[e("div",{className:"text-xs text-gray-500 dark:text-gray-200",children:"Totaux"}),r("div",{className:"font-medium",children:["R: ",ke.totalRes," ‚Ä¢ P: ",ke.totalSeats," ‚Ä¢ E: ",ke.seatsEmbarques," ‚Ä¢ A: ",ke.seatsAbsents]})]})]})]}),e("div",{className:"overflow-x-auto mt-3",style:{minWidth:0},children:r("table",{className:"w-full text-sm thin-table min-w-[600px]",style:{fontSize:"14px"},children:[r("colgroup",{children:[e("col",{className:"col-idx"}),e("col",{className:"col-client"}),e("col",{className:"col-phone"}),e("col",{className:"col-canal"}),e("col",{className:"col-ref"}),e("col",{className:"col-seats"}),e("col",{className:"col-emb"}),e("col",{className:"col-abs"})]}),e("thead",{className:"bg-gray-50 dark:bg-slate-800 dark:border-slate-600",children:r("tr",{children:[e("th",{className:"text-left text-gray-900 dark:text-white border-b border-gray-200 dark:border-slate-600",children:"#"}),e("th",{className:"text-left text-gray-900 dark:text-white border-b border-gray-200 dark:border-slate-600",children:"Client"}),e("th",{className:"text-left text-gray-900 dark:text-white border-b border-gray-200 dark:border-slate-600",children:"T√©l√©phone"}),e("th",{className:"text-left text-gray-900 dark:text-white border-b border-gray-200 dark:border-slate-600",children:"Canal"}),e("th",{className:"text-left text-gray-900 dark:text-white border-b border-gray-200 dark:border-slate-600",children:"R√©f√©rence"}),e("th",{className:"text-center text-gray-900 dark:text-white border-b border-gray-200 dark:border-slate-600",children:"Places"}),e("th",{className:"text-center text-gray-900 dark:text-white border-b border-gray-200 dark:border-slate-600",children:"Embarqu√©"}),e("th",{className:"text-center text-gray-900 dark:text-white border-b border-gray-200 dark:border-slate-600",children:"Absent"})]})}),e("tbody",{children:H?e("tr",{children:e("td",{className:"py-4 text-gray-500 dark:text-gray-200",colSpan:8,children:"Chargement‚Ä¶"})}):Ae.length===0?e("tr",{children:e("td",{className:"py-4 text-gray-400 dark:text-gray-200",colSpan:8,children:"Aucun passager trouv√©"})}):Ae.map((y,P)=>{const F=y.statutEmbarquement==="embarqu√©",z=y.statutEmbarquement==="absent",ee=y.seatsGo??1;return r("tr",{className:`border-t border-gray-200 dark:border-slate-600 ${F?"embarked bg-gray-50 dark:bg-slate-700 text-slate-700 dark:text-white":`bg-white ${P%2===0?"dark:bg-slate-900":"dark:bg-slate-800"} text-gray-900 dark:text-white`}`,children:[e("td",{className:F?"text-slate-700 dark:text-white":"text-gray-900 dark:text-white",children:P+1}),e("td",{className:`truncate ${F?"text-slate-700 dark:text-white":"text-gray-900 dark:text-white"}`,children:y.nomClient||"‚Äî"}),e("td",{className:`truncate ${F?"text-slate-700 dark:text-white":"text-gray-900 dark:text-white"}`,children:y.telephone||"‚Äî"}),e("td",{className:`capitalize truncate ${F?"text-slate-700 dark:text-white":"text-gray-900 dark:text-white"}`,children:y.canal||"‚Äî"}),e("td",{className:`truncate ${F?"text-slate-700 dark:text-white":"text-gray-900 dark:text-white"}`,children:y.referenceCode||y.id}),e("td",{className:`text-center font-semibold ${F?"text-slate-700 dark:text-white":"text-gray-900 dark:text-white"}`,children:ee}),e("td",{className:"text-center",children:e("button",{className:"case","data-checked":F,onClick:()=>se(y.id,F?"en_attente":"embarqu√©"),title:"Basculer Embarqu√©"})}),e("td",{className:"text-center",children:e("button",{className:"case","data-checked":z,onClick:()=>se(y.id,z?"en_attente":"absent"),title:"Basculer Absent"})})]},y.id)})})]})}),e("div",{className:"px-4 py-6 text-sm",children:r("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-6",children:[r("div",{children:[e("div",{className:"sig-box"}),e("div",{className:"sig-caption",children:"Contr√¥leur / Chef d‚Äôembarquement ‚Äî Nom & Signature"})]}),r("div",{children:[e("div",{className:"sig-box"}),e("div",{className:"sig-caption",children:"Chauffeur ‚Äî Nom & Signature"})]}),r("div",{children:[e("div",{className:"sig-box"}),e("div",{className:"sig-caption",children:"Visa Agence"})]})]})})]})]})]}):e("div",{className:"min-h-screen grid place-items-center text-gray-600",children:"Chargement‚Ä¶"})};async function Bd(a,t,i,s,n){const l=he($,`companies/${a}/fleetVehicles`),d=Te(l,ae("status","==","assigned"),ae("currentAgencyId","==",t),ae("currentDate","==",s),ae("currentHeure","==",n)),g=await Ee(d);for(const f of g.docs){const b=f.data();if(b.currentTripId===i)return b.capacity??null}return null}const Gd=()=>{var C,A,u,x;const{user:a}=Ke(),t=Aa(),[i,s]=o.useState(null),[n,l]=o.useState(!1),d=(a==null?void 0:a.companyId)??null,g=((C=t.state)==null?void 0:C.agencyId)??null,f=((A=t.state)==null?void 0:A.date)??null,b=((u=t.state)==null?void 0:u.heure)??null,I=((x=t.state)==null?void 0:x.tripId)??void 0;return o.useEffect(()=>{if(!d||!g||!f||!b){s(null),l(!0);return}let h=!1;return Bd(d,g,I,f,b).then(L=>{h||(s(L),l(!0))}),()=>{h=!0}},[d,g,f,b,I]),n?e(qd,{vehicleCapacity:i}):e("div",{className:"p-6 flex items-center justify-center min-h-[200px] text-gray-500",children:"Chargement de la capacit√© v√©hicule‚Ä¶"})},Wu=Object.freeze(Object.defineProperty({__proto__:null,default:Gd},Symbol.toStringTag,{value:"Module"})),As=[{label:"Tableau de bord",icon:ur,path:"/agence/fleet",end:!0},{label:"Exploitation",icon:Ca,path:"/agence/fleet/operations",end:!0},{label:"Affectation",icon:So,path:"/agence/fleet/assignment"},{label:"V√©hicules",icon:ea,path:"/agence/fleet/vehicles"},{label:"Mouvements",icon:zs,path:"/agence/fleet/movements"}],Ud=["agency_fleet_controller","chefAgence","admin_compagnie"],zd=()=>{var u,x;const{user:a,company:t,logout:i}=Ke(),s=aa(),n=Lt(t),l=br(),[d,g]=Gr();Ln(As);const f=Array.isArray(a==null?void 0:a.role)?a.role:a!=null&&a.role?[a.role]:[],b=new Set(f),I=h=>b.has(h);if(!Ud.some(h=>I(h)))return I("chefEmbarquement")?e(kt,{to:"/agence/boarding",replace:!0}):I("chefAgence")||I("admin_compagnie")?e(kt,{to:"/agence/dashboard",replace:!0}):e(kt,{to:"/login",replace:!0});const A=async()=>{try{await i(),s("/login")}catch(h){console.error(h)}};return e("div",{className:d?"agency-dark":"",children:e(_n,{sections:As,role:f[0]||"agency_fleet_controller",userName:(a==null?void 0:a.displayName)??(a==null?void 0:a.nom),userEmail:a==null?void 0:a.email,brandName:(t==null?void 0:t.nom)??"Flotte",logoUrl:t==null?void 0:t.logoUrl,primaryColor:(u=n==null?void 0:n.colors)==null?void 0:u.primary,secondaryColor:(x=n==null?void 0:n.colors)==null?void 0:x.secondary,onLogout:A,headerRight:e(Pn,{isOnline:l,darkMode:d,onDarkModeToggle:g}),mainClassName:"agency-content-transition",children:e(gr,{})})})},Xu=Object.freeze(Object.defineProperty({__proto__:null,default:zd},Symbol.toStringTag,{value:"Module"})),rr={garage:"En garage",assigned:"Affect√©",in_transit:"En transit",arrived:"Arriv√©",maintenance:"Maintenance"},Hd=()=>{const{user:a,company:t}=Ke(),i=aa(),s=(a==null?void 0:a.companyId)??null,n=(a==null?void 0:a.agencyId)??null,[l,d]=o.useState([]),[g,f]=o.useState({}),[b,I]=o.useState(!0);o.useEffect(()=>{if(!s){d([]),I(!1);return}(async()=>{I(!0);try{const m=await Ee(he($,`companies/${s}/agences`)),c={};m.docs.forEach(H=>{const M=H.data();c[H.id]=(M==null?void 0:M.nom)??(M==null?void 0:M.name)??H.id}),f(c);const w=he($,`companies/${s}/fleetVehicles`),R=(await Ee(w)).docs.map(H=>({id:H.id,...H.data()}));d(R)}finally{I(!1)}})()},[s]);const C=m=>l.filter(c=>c.status===m),A=C("garage"),u=C("assigned"),x=C("in_transit");C("arrived");const h=C("maintenance"),L=l.filter(m=>m.status==="in_transit"&&n&&(m.destinationAgencyId===n||m.currentArrival===n)),E=(t==null?void 0:t.couleurPrimaire)??"#0ea5e9";return b?e("div",{className:"p-6 max-w-5xl mx-auto",children:e("div",{className:"text-gray-500",children:"Chargement du tableau de bord flotte‚Ä¶"})}):r("div",{className:"p-6 max-w-5xl mx-auto space-y-6",children:[e("h1",{className:"text-xl font-semibold",children:"Tableau de bord Flotte"}),r("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[r("button",{type:"button",onClick:()=>i("/agence/fleet/vehicles?status=garage"),className:"text-left p-4 rounded-xl border bg-white hover:bg-gray-50",children:[e("div",{className:"text-2xl font-bold",style:{color:E},children:A.length}),e("div",{className:"text-sm text-gray-600",children:rr.garage})]}),r("button",{type:"button",onClick:()=>i("/agence/fleet/vehicles?status=assigned"),className:"text-left p-4 rounded-xl border bg-white hover:bg-gray-50",children:[e("div",{className:"text-2xl font-bold text-amber-600",children:u.length}),e("div",{className:"text-sm text-gray-600",children:rr.assigned})]}),r("button",{type:"button",onClick:()=>i("/agence/fleet/vehicles?status=in_transit"),className:"text-left p-4 rounded-xl border bg-white hover:bg-gray-50",children:[e("div",{className:"text-2xl font-bold text-blue-600",children:x.length}),e("div",{className:"text-sm text-gray-600",children:rr.in_transit})]}),r("button",{type:"button",onClick:()=>i("/agence/fleet/vehicles?status=maintenance"),className:"text-left p-4 rounded-xl border bg-white hover:bg-gray-50",children:[e("div",{className:"text-2xl font-bold text-red-600",children:h.length}),e("div",{className:"text-sm text-gray-600",children:rr.maintenance})]})]}),L.length>0&&r("div",{className:"bg-emerald-50 border border-emerald-200 rounded-xl p-4",children:[e("h2",{className:"font-semibold text-emerald-800 mb-2",children:"V√©hicules approchant cette agence"}),e("ul",{className:"space-y-2",children:L.map(m=>r("li",{className:"flex items-center justify-between text-sm",children:[r("span",{className:"font-medium",children:[m.plateNumber," ‚Äî ",m.internalCode]}),e("span",{className:"text-gray-600",children:m.chauffeurName||"‚Äî"})]},m.id))})]}),r("div",{className:"bg-white rounded-xl border overflow-hidden",children:[e("div",{className:"px-4 py-3 border-b font-semibold",children:"V√©hicules r√©cents"}),e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gray-50",children:r("tr",{children:[e("th",{className:"px-3 py-2 text-left",children:"Plaque / Code"}),e("th",{className:"px-3 py-2 text-left",children:"Capacit√©"}),e("th",{className:"px-3 py-2 text-left",children:"Statut"}),e("th",{className:"px-3 py-2 text-left",children:"Agence / Trajet"}),e("th",{className:"px-3 py-2 text-left",children:"Chauffeur"})]})}),e("tbody",{children:l.slice(0,15).map(m=>r("tr",{className:"border-t",children:[r("td",{className:"px-3 py-2",children:[m.plateNumber," ‚Äî ",m.internalCode]}),e("td",{className:"px-3 py-2",children:m.capacity}),e("td",{className:"px-3 py-2",children:e("span",{className:"inline-flex px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800",children:rr[m.status]})}),r("td",{className:"px-3 py-2",children:[m.currentAgencyId?g[m.currentAgencyId]??m.currentAgencyId:"‚Äî",m.currentTripId&&` ‚Ä¢ ${m.currentDate??""} ${m.currentHeure??""}`]}),e("td",{className:"px-3 py-2",children:m.chauffeurName||"‚Äî"})]},m.id))})]})}),l.length===0&&e("div",{className:"p-6 text-center text-gray-500",children:"Aucun v√©hicule enregistr√©. Cr√©ez-en depuis V√©hicules ou Affectation."})]})]})},Qu=Object.freeze(Object.defineProperty({__proto__:null,default:Hd},Symbol.toStringTag,{value:"Module"}));function Kd(a){const t=a.getFullYear(),i=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${t}-${i}-${s}`}const yn=a=>a.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase(),Is=({companyId:a,agencyId:t,trip:i,date:s,heure:n,fleetVehicleIds:l,onSaved:d})=>{const[g,f]=o.useState(!0),[b,I]=o.useState(!1),[C,A]=o.useState(""),[u,x]=o.useState(""),[h,L]=o.useState(""),[E,m]=o.useState(""),[c,w]=o.useState(50),[N,R]=o.useState(null),[H,M]=o.useState(!1),K=o.useMemo(()=>Md(i.departure,i.arrival,n,s),[i.departure,i.arrival,n,s]);o.useEffect(()=>{let le=!1;return(async()=>{f(!0);try{const Q=pe($,`companies/${a}/agences/${t}/affectations/${K}`),Z=await He(Q),j=he($,`companies/${a}/fleetVehicles`),k=Te(j,ae("currentAgencyId","==",t),ae("currentDate","==",s),ae("currentHeure","==",n),ae("currentTripId","==",i.id)),W=await Ee(k);if(!le){if(Z.exists()){const q=Z.data();A(q.busNumber??""),x(q.immatriculation??""),L(q.chauffeur??""),m(q.chefEmbarquement??""),M(!0)}else A(""),x(""),L(""),m(""),M(!1);if(W.empty)R(null);else{const q=W.docs[0];R(q.id);const ye=q.data();w(ye.capacity??50),L(ye.chauffeurName??h),m(ye.convoyeurName??E)}}}finally{le||f(!1)}})(),()=>{le=!0}},[a,t,K,s,n,i.id]);const B=o.useCallback(async()=>{I(!0);try{const le=pe($,`companies/${a}/agences/${t}/affectations/${K}`),Q={busNumber:C||"",immatriculation:u||"",chauffeur:h||"",chefEmbarquement:E||"",tripId:i.id||null,date:s,heure:n,updatedAt:new Date};await jt(le,Q,{merge:!0});const Z=he($,`companies/${a}/fleetVehicles`),j=Re(),k={plateNumber:C||u||"‚Äî",internalCode:C||u||K,capacity:c,status:"assigned",currentAgencyId:t,destinationAgencyId:null,currentTripId:i.id||null,currentDeparture:i.departure,currentArrival:i.arrival,currentDate:s,currentHeure:n,departureTime:null,estimatedArrivalTime:null,lastMovementAt:j,lastMovementBy:null,chauffeurName:h||"",convoyeurName:E||"",createdAt:j,updatedAt:j};if(N)await jt(pe($,`companies/${a}/fleetVehicles/${N}`),{...k,updatedAt:j},{merge:!0});else{const W=pe(Z);await jt(W,{...k,id:W.id}),R(W.id)}M(!0),d==null||d()}catch(le){console.error(le),alert("√âchec de l'enregistrement.")}finally{I(!1)}},[a,t,K,C,u,h,E,c,N,i.id,i.departure,i.arrival,s,n,d]);return r("tr",{className:"border-t",children:[r("td",{className:"px-3 py-2 whitespace-nowrap text-sm",children:[r("div",{className:"font-medium",children:[i.departure," ‚Üí ",i.arrival]}),r("div",{className:"text-xs text-gray-500",children:[s," ‚Ä¢ ",n]})]}),e("td",{className:"px-2 py-2",children:e("input",{className:"w-32 px-2 py-1 border rounded text-sm",placeholder:"N¬∞ Bus",value:C,onChange:le=>A(le.target.value),disabled:g||b})}),e("td",{className:"px-2 py-2",children:e("input",{className:"w-32 px-2 py-1 border rounded text-sm",placeholder:"Immat.",value:u,onChange:le=>x(le.target.value),disabled:g||b})}),e("td",{className:"px-2 py-2",children:e("input",{type:"number",min:1,className:"w-20 px-2 py-1 border rounded text-sm",value:c,onChange:le=>w(Number(le.target.value)||50),disabled:g||b})}),e("td",{className:"px-2 py-2",children:e("input",{className:"w-40 px-2 py-1 border rounded text-sm",placeholder:"Chauffeur",value:h,onChange:le=>L(le.target.value),disabled:g||b})}),e("td",{className:"px-2 py-2",children:e("input",{className:"w-40 px-2 py-1 border rounded text-sm",placeholder:"Convoyeur",value:E,onChange:le=>m(le.target.value),disabled:g||b})}),e("td",{className:"px-2 py-2 text-center",children:e("button",{onClick:B,disabled:b||g,className:`px-3 py-1 rounded text-sm text-white ${H?"bg-emerald-600 hover:bg-emerald-700":"bg-indigo-600 hover:bg-indigo-700"}`,children:b?"‚Ä¶":H?"Mettre √† jour":"Affecter"})}),e("td",{className:"px-3 py-2 text-xs text-center",children:g?"‚Ä¶":H?e("span",{className:"inline-flex items-center px-2 py-0.5 rounded bg-emerald-50 text-emerald-700 border border-emerald-200",children:"Affect√©"}):e("span",{className:"inline-flex items-center px-2 py-0.5 rounded bg-amber-50 text-amber-700 border border-amber-200",children:"Non affect√©"})})]})},Yd=()=>{var w;const{user:a,company:t}=Ke(),i=(a==null?void 0:a.companyId)??null,s=(a==null?void 0:a.agencyId)??null,n={primary:(t==null?void 0:t.couleurPrimaire)??"#0ea5e9",secondary:(t==null?void 0:t.couleurSecondaire)??"#f59e0b",bg:"#f7f8fa"},[l,d]=o.useState([]),[g,f]=o.useState(s),[b,I]=o.useState(Kd(new Date)),[C,A]=o.useState([]),[u,x]=o.useState(null),[h,L]=o.useState(""),[E,m]=o.useState([]);o.useEffect(()=>{i&&Ee(he($,`companies/${i}/agences`)).then(N=>{const R=N.docs.map(H=>{var M,K;return{id:H.id,nom:((M=H.data())==null?void 0:M.nom)??((K=H.data())==null?void 0:K.name)??H.id}});d(R),!s&&R.length===1&&f(R[0].id)})},[i,s]),o.useEffect(()=>{i&&Ee(he($,`companies/${i}/fleetVehicles`)).then(N=>{m(N.docs.map(R=>R.id))})},[i]),o.useEffect(()=>{if(!i||!g){A([]),x(null),L("");return}const N=he($,`companies/${i}/agences/${g}/weeklyTrips`);Ee(N).then(R=>{const H=yn(new Date(b)),M=R.docs.map(K=>({id:K.id,...K.data()})).filter(K=>{var B;return K.active&&(((B=K.horaires)==null?void 0:B[H])||[]).length>0});A(M)})},[i,g,b]);const c=o.useMemo(()=>{var R;if(!u)return[];const N=yn(new Date(b));return(((R=u.horaires)==null?void 0:R[N])||[]).slice().sort()},[u,b]);return a?e("div",{className:"min-h-screen",style:{background:n.bg},children:r("div",{className:"max-w-7xl mx-auto px-4 py-6 space-y-6",children:[r("div",{className:"bg-white rounded-xl border p-4 shadow-sm space-y-3",children:[r("div",{className:"flex flex-wrap items-center gap-3",children:[e("span",{className:"font-semibold",style:{color:n.secondary},children:"Agence :"}),s?e("span",{className:"px-2 py-1 rounded border bg-gray-50 text-sm",children:((w=l.find(N=>N.id===(g||s)))==null?void 0:w.nom)??"‚Äî"}):r("select",{className:"px-2 py-1 border rounded text-sm",value:g??"",onChange:N=>f(N.target.value||null),children:[e("option",{value:"",children:"‚Äî Choisir ‚Äî"}),l.map(N=>e("option",{value:N.id,children:N.nom},N.id))]}),e("span",{className:"font-semibold",style:{color:n.secondary},children:"Date :"}),e("input",{type:"date",className:"border rounded px-3 py-1",value:b,onChange:N=>I(N.target.value)})]}),e("div",{className:"font-semibold",children:"Trajet & heure"}),e("div",{className:"flex flex-wrap gap-2",children:g?C.length===0?e("div",{className:"text-gray-500",children:"Aucun trajet pour cette date."}):r(bt,{children:[C.map(N=>r("button",{type:"button",onClick:()=>{x(N),L("")},className:`px-3 py-2 rounded-lg text-sm font-medium ${(u==null?void 0:u.id)===N.id?"text-white":"bg-gray-200 text-gray-700"}`,style:(u==null?void 0:u.id)===N.id?{background:n.primary}:void 0,children:[N.departure," ‚Üí ",N.arrival]},N.id)),u&&e("div",{className:"flex flex-wrap items-center gap-2",children:c.map(N=>e("button",{type:"button",onClick:()=>L(N),className:`px-2 py-1 rounded border text-sm ${h===N?"text-white":"bg-white text-gray-700"}`,style:h===N?{background:n.primary,borderColor:n.primary}:void 0,children:N},N))})]}):e("div",{className:"text-gray-500",children:"Choisissez une agence."})})]}),r("div",{className:"bg-white rounded-xl border shadow-sm",children:[e("div",{className:"px-4 py-3 border-b font-semibold",children:"Affectation v√©hicule & √©quipage (flotte)"}),e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gray-50",children:r("tr",{children:[e("th",{className:"px-3 py-2 text-left",children:"Trajet"}),e("th",{className:"px-3 py-2 text-left",children:"N¬∞ Bus"}),e("th",{className:"px-3 py-2 text-left",children:"Immat."}),e("th",{className:"px-3 py-2 text-left",children:"Capacit√©"}),e("th",{className:"px-3 py-2 text-left",children:"Chauffeur"}),e("th",{className:"px-3 py-2 text-left",children:"Convoyeur"}),e("th",{className:"px-3 py-2 text-center w-32",children:"Action"}),e("th",{className:"px-3 py-2 text-center w-32",children:"Statut"})]})}),e("tbody",{children:u&&h?e(Is,{companyId:i,agencyId:g??s,trip:u,date:b,heure:h,fleetVehicleIds:E},`${u.id}_${h}`):(()=>{const N=yn(new Date(b)),R=[];return C.forEach(H=>{var M;(((M=H.horaires)==null?void 0:M[N])||[]).slice().sort().forEach(K=>{R.push(e(Is,{companyId:i,agencyId:g??s,trip:H,date:b,heure:K,fleetVehicleIds:E},`${H.id}_${K}`))})}),R.length===0?e("tr",{children:e("td",{className:"px-3 py-4 text-gray-500",colSpan:8,children:"Aucun trajet pour cette date."})}):R})()})]})})]})]})}):null},Ju=Object.freeze(Object.defineProperty({__proto__:null,default:Yd},Symbol.toStringTag,{value:"Module"})),nr={garage:"En garage",assigned:"Affect√©",in_transit:"En transit",arrived:"Arriv√©",maintenance:"Maintenance"},Wd=()=>{const{user:a,company:t}=Ke(),[i]=js(),s=i.get("status"),[n,l]=o.useState(null),[d,g]=o.useState([]),[f,b]=o.useState({}),[I,C]=o.useState(!0);o.useEffect(()=>{if(!(a!=null&&a.companyId)){g([]),C(!1);return}const u=a.companyId;(async()=>{C(!0);try{const[x,h]=await Promise.all([Ee(he($,`companies/${u}/fleetVehicles`)),Ee(he($,`companies/${u}/agences`))]),L={};h.docs.forEach(m=>{const c=m.data();L[m.id]=(c==null?void 0:c.nom)??(c==null?void 0:c.name)??m.id}),b(L);let E=x.docs.map(m=>({id:m.id,...m.data()}));s&&nr[s]!==void 0&&(E=E.filter(m=>m.status===s)),g(E)}finally{C(!1)}})()},[a==null?void 0:a.companyId,s]);const A=async(u,x)=>{const h=a==null?void 0:a.companyId,L=(a==null?void 0:a.uid)??"";if(!(!h||!L)){if(!jr(u.status,x)){alert(`Transition interdite : ${u.status} ‚Üí ${x}`);return}l(u.id);try{await Ld(h,u.id,x,L,{toAgencyId:x==="arrived"?u.destinationAgencyId??u.currentAgencyId:null,tripId:u.currentTripId??void 0,date:u.currentDate??void 0,heure:u.currentHeure??void 0}),g(E=>E.map(m=>m.id===u.id?{...m,status:x}:m))}catch(E){console.error(E),alert(E instanceof Error?E.message:"Erreur lors de la mise √† jour.")}finally{l(null)}}};return t==null||t.couleurPrimaire,I?e("div",{className:"p-6 max-w-5xl mx-auto",children:e("div",{className:"text-gray-500",children:"Chargement des v√©hicules‚Ä¶"})}):r("div",{className:"p-6 max-w-5xl mx-auto space-y-4",children:[e("h1",{className:"text-xl font-semibold",children:"V√©hicules flotte"}),s&&r("p",{className:"text-sm text-gray-600",children:["Filtre : ",nr[s]??s]}),r("div",{className:"bg-white rounded-xl border overflow-hidden",children:[e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gray-50",children:r("tr",{children:[e("th",{className:"px-3 py-2 text-left",children:"Plaque / Code"}),e("th",{className:"px-3 py-2 text-left",children:"Capacit√©"}),e("th",{className:"px-3 py-2 text-left",children:"Statut"}),e("th",{className:"px-3 py-2 text-left",children:"Agence / Trajet"}),e("th",{className:"px-3 py-2 text-left",children:"Chauffeur / Convoyeur"}),e("th",{className:"px-3 py-2 text-center w-40",children:"Action"})]})}),e("tbody",{children:d.map(u=>r("tr",{className:"border-t",children:[r("td",{className:"px-3 py-2 font-medium",children:[u.plateNumber," ‚Äî ",u.internalCode]}),e("td",{className:"px-3 py-2",children:u.capacity}),e("td",{className:"px-3 py-2",children:e("span",{className:"inline-flex px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800",children:nr[u.status]})}),r("td",{className:"px-3 py-2",children:[u.currentAgencyId?f[u.currentAgencyId]??u.currentAgencyId:"‚Äî",u.currentTripId&&` ‚Ä¢ ${u.currentDate??""} ${u.currentHeure??""}`]}),r("td",{className:"px-3 py-2",children:[u.chauffeurName||"‚Äî"," / ",u.convoyeurName||"‚Äî"]}),e("td",{className:"px-3 py-2 text-center",children:n===u.id?e("span",{className:"text-xs text-gray-500",children:"‚Ä¶"}):e("select",{className:"text-xs border rounded px-2 py-1",value:u.status,onChange:x=>A(u,x.target.value),children:Object.keys(nr).map(x=>e("option",{value:x,disabled:!jr(u.status,x),children:nr[x]},x))})})]},u.id))})]})}),d.length===0&&e("div",{className:"p-6 text-center text-gray-500",children:"Aucun v√©hicule."})]})]})},Zu=Object.freeze(Object.defineProperty({__proto__:null,default:Wd},Symbol.toStringTag,{value:"Module"})),Xd=()=>{const{user:a}=Ke(),t=(a==null?void 0:a.companyId)??null,[i,s]=o.useState([]),[n,l]=o.useState(!0);return o.useEffect(()=>{if(!t){s([]),l(!1);return}(async()=>{l(!0);try{const d=he($,`companies/${t}/fleetMovements`),g=Te(d,Rt("movedAt","desc"),Tt(100)),b=(await Ee(g)).docs.map(I=>{var A,u;const C=I.data();return{id:I.id,...C,at:((u=(A=C.movedAt)==null?void 0:A.toDate)==null?void 0:u.call(A))??null}});s(b)}catch{s([])}finally{l(!1)}})()},[t]),n?e("div",{className:"p-6 max-w-4xl mx-auto",children:e("div",{className:"text-gray-500",children:"Chargement des mouvements‚Ä¶"})}):r("div",{className:"p-6 max-w-4xl mx-auto space-y-4",children:[e("h1",{className:"text-xl font-semibold",children:"Historique des mouvements flotte"}),e("p",{className:"text-sm text-gray-600",children:"Audit des changements de statut (fleetMovements)."}),r("div",{className:"bg-white rounded-xl border overflow-hidden",children:[e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gray-50",children:r("tr",{children:[e("th",{className:"px-3 py-2 text-left",children:"V√©hicule"}),e("th",{className:"px-3 py-2 text-left",children:"Transition"}),e("th",{className:"px-3 py-2 text-left",children:"De ‚Üí Vers agence"}),e("th",{className:"px-3 py-2 text-left",children:"Trajet / Date"}),e("th",{className:"px-3 py-2 text-left",children:"Par"}),e("th",{className:"px-3 py-2 text-left",children:"Date"})]})}),e("tbody",{children:i.map(d=>r("tr",{className:"border-t",children:[e("td",{className:"px-3 py-2 font-medium",children:d.vehicleId}),r("td",{className:"px-3 py-2",children:[d.previousStatus," ‚Üí ",d.newStatus]}),r("td",{className:"px-3 py-2",children:[d.fromAgencyId??"‚Äî"," ‚Üí ",d.toAgencyId??"‚Äî"]}),e("td",{className:"px-3 py-2",children:[d.date,d.heure,d.tripId].filter(Boolean).join(" ‚Ä¢ ")||"‚Äî"}),e("td",{className:"px-3 py-2",children:d.movedBy}),e("td",{className:"px-3 py-2 text-gray-600",children:d.at?Je(d.at,"dd/MM/yyyy HH:mm"):"‚Äî"})]},d.id))})]})}),i.length===0&&e("div",{className:"p-6 text-center text-gray-500",children:"Aucun mouvement enregistr√©."})]})]})},em=Object.freeze(Object.defineProperty({__proto__:null,default:Xd},Symbol.toStringTag,{value:"Module"})),Qd=()=>{var Z;const{user:a}=Ke(),t=(a==null?void 0:a.companyId)??"",i=(a==null?void 0:a.agencyId)??"",s=((a==null?void 0:a.ville)??"").trim(),n=(a==null?void 0:a.uid)??"",l=(a==null?void 0:a.role)??"chefAgence",[d,g]=o.useState([]),[f,b]=o.useState([]),[I,C]=o.useState(new Set),[A,u]=o.useState(!0),[x,h]=o.useState(null),[L,E]=o.useState(null),[m,c]=o.useState(null),[w,N]=o.useState({tripId:"",departureCity:s,arrivalCity:"",departureTime:"",driverName:"",driverPhone:"",convoyeurName:"",convoyeurPhone:""}),R=o.useCallback(async()=>{if(!t||!i){u(!1),g([]),b([]);return}u(!0),h(null);try{const[j,k]=await Promise.all([wn(t),_o(t)]);g(j.map(q=>({id:q.id,plateNumber:q.plateNumber??"",model:q.model??"",currentCity:q.currentCity??"",operationalStatus:q.operationalStatus??Ua.GARAGE,technicalStatus:q.technicalStatus??Lr.NORMAL}))),b(k.map(q=>({id:q.id,agencyId:q.agencyId??"",vehicleId:q.vehicleId,vehiclePlate:q.vehiclePlate??"",vehicleModel:q.vehicleModel??"",tripId:q.tripId??"",departureCity:q.departureCity??"",arrivalCity:q.arrivalCity??"",departureTime:q.departureTime??"",driverName:q.driverName,driverPhone:q.driverPhone,convoyeurName:q.convoyeurName,convoyeurPhone:q.convoyeurPhone,status:q.status??""})));const W=new Set(k.filter(q=>q.status===It.AFFECTE||q.status===It.DEPART_CONFIRME).map(q=>q.vehicleId));C(W)}catch(j){h(j instanceof Error?j.message:"Erreur chargement."),g([]),b([])}finally{u(!1)}},[t,i]);o.useEffect(()=>{R()},[R]);const H=d.filter(j=>s&&j.operationalStatus===Ua.GARAGE&&j.technicalStatus===Lr.NORMAL&&(j.currentCity??"").trim().toLowerCase()===s.toLowerCase()&&!I.has(j.id)),M=f.filter(j=>j.agencyId===i&&j.status===It.AFFECTE),K=f.filter(j=>j.status===It.DEPART_CONFIRME&&(j.arrivalCity??"").trim().toLowerCase()===s.toLowerCase()),B=async j=>{var k;if(j.preventDefault(),!t||!i||!m||!((k=w.arrivalCity)!=null&&k.trim())){h("Veuillez remplir au moins la ville d'arriv√©e.");return}E(m),h(null);try{await Ks(t,i,m,s,{tripId:w.tripId.trim()||"‚Äî",departureCity:w.departureCity.trim()||s,arrivalCity:w.arrivalCity.trim(),departureTime:w.departureTime.trim()||new Date().toISOString().slice(0,16),driverName:w.driverName.trim()||void 0,driverPhone:w.driverPhone.trim()||void 0,convoyeurName:w.convoyeurName.trim()||void 0,convoyeurPhone:w.convoyeurPhone.trim()||void 0,assignedBy:n},n,l),c(null),N({tripId:"",departureCity:s,arrivalCity:"",departureTime:"",driverName:"",driverPhone:"",convoyeurName:"",convoyeurPhone:""}),await R()}catch(W){h(W instanceof Error?W.message:"Erreur affectation.")}finally{E(null)}},le=async j=>{if(!(!t||!i)){E(j),h(null);try{await Ys(t,i,j,n,l),await R()}catch(k){h(k instanceof Error?k.message:"Erreur confirmation d√©part.")}finally{E(null)}}},Q=async(j,k)=>{if(!(!t||!s)){E(j),h(null);try{await Lo(t,k,j,s,n,l),await R()}catch(W){h(W instanceof Error?W.message:"Erreur confirmation arriv√©e.")}finally{E(null)}}};return!t||!i?e("div",{className:"p-6 text-gray-600 bg-gray-50 rounded-lg",children:"Compagnie ou agence introuvable."}):r("div",{className:"p-4 sm:p-6 max-w-4xl mx-auto",children:[r("h1",{className:"text-xl font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e(ea,{className:"w-5 h-5"})," Exploitation"]}),r("p",{className:"text-sm text-gray-600 mb-4",children:["Agence : ",e("strong",{children:s||"‚Äî"}),". Affectez les v√©hicules et confirmez d√©parts / arriv√©es."]}),x&&e("div",{className:"mb-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm",children:x}),A?e("div",{className:"flex justify-center py-12",children:e(rt,{className:"w-8 h-8 animate-spin text-gray-400"})}):r("div",{className:"space-y-8",children:[r("section",{children:[r("h2",{className:"text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2",children:[e(Ca,{className:"w-4 h-4"})," 1. V√©hicules disponibles (dans votre agence)"]}),H.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucun v√©hicule disponible √† l'affectation."}):e("ul",{className:"space-y-2",children:H.map(j=>r("li",{className:"flex flex-wrap items-center gap-2 p-3 rounded-lg border bg-white",children:[e("span",{className:"font-medium",children:j.plateNumber}),e("span",{className:"text-gray-500",children:j.model}),r("button",{type:"button",onClick:()=>{c(j.id),N(k=>({...k,departureCity:s}))},className:"inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700",children:[e(ir,{className:"w-4 h-4"})," Affecter"]})]},j.id))})]}),r("section",{children:[r("h2",{className:"text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2",children:[e(Ca,{className:"w-4 h-4"})," 2. D√©parts affect√©s"]}),M.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucun d√©part en attente de confirmation."}):e("ul",{className:"space-y-2",children:M.map(j=>r("li",{className:"flex flex-wrap items-center gap-2 p-3 rounded-lg border bg-white",children:[e("span",{className:"font-medium",children:j.vehiclePlate}),e("span",{className:"text-gray-500",children:j.vehicleModel}),r("span",{className:"text-gray-500",children:[j.departureCity," ‚Üí ",j.arrivalCity]}),r("button",{type:"button",onClick:()=>le(j.id),disabled:L===j.id,className:"inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 disabled:opacity-50",children:[L===j.id?"‚Ä¶":e(va,{className:"w-4 h-4"}),"Confirmer d√©part"]})]},j.id))})]}),r("section",{children:[r("h2",{className:"text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2",children:[e(va,{className:"w-4 h-4"})," 3. En transit vers moi"]}),K.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucun v√©hicule en attente d'arriv√©e."}):e("ul",{className:"space-y-2",children:K.map(j=>r("li",{className:"flex flex-wrap items-center gap-2 p-3 rounded-lg border bg-white",children:[e("span",{className:"font-medium",children:j.vehiclePlate}),e("span",{className:"text-gray-500",children:j.vehicleModel}),r("span",{className:"text-gray-500",children:[j.departureCity," ‚Üí ",j.arrivalCity]}),r("button",{type:"button",onClick:()=>Q(j.id,j.agencyId),disabled:L===j.id,className:"inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 disabled:opacity-50",children:[L===j.id?"‚Ä¶":e(va,{className:"w-4 h-4"}),"Confirmer arriv√©e"]})]},j.id))})]})]}),m&&e("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:r("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] flex flex-col",children:[r("div",{className:"flex items-center justify-between p-4 border-b shrink-0",children:[e("h3",{className:"text-lg font-semibold",children:"Affecter un v√©hicule"}),e("button",{type:"button",onClick:()=>c(null),className:"p-1 rounded hover:bg-gray-100",children:e(Ia,{className:"w-5 h-5"})})]}),r("form",{onSubmit:B,className:"flex flex-col flex-1 min-h-0",children:[r("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ville d'arriv√©e *"}),e("input",{type:"text",value:w.arrivalCity,onChange:j=>N(k=>({...k,arrivalCity:j.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",required:!0})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ville de d√©part"}),e("input",{type:"text",value:w.departureCity,onChange:j=>N(k=>({...k,departureCity:j.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ID trajet"}),e("input",{type:"text",value:w.tripId,onChange:j=>N(k=>({...k,tripId:j.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Heure de d√©part"}),e("input",{type:"datetime-local",value:w.departureTime,onChange:j=>N(k=>({...k,departureTime:j.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Chauffeur (optionnel)"}),e("input",{type:"text",value:w.driverName,onChange:j=>N(k=>({...k,driverName:j.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",placeholder:"Nom"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"T√©l. chauffeur"}),e("input",{type:"text",value:w.driverPhone,onChange:j=>N(k=>({...k,driverPhone:j.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",placeholder:"T√©l√©phone"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Convoyeur (optionnel)"}),e("input",{type:"text",value:w.convoyeurName,onChange:j=>N(k=>({...k,convoyeurName:j.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",placeholder:"Nom"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"T√©l. convoyeur"}),e("input",{type:"text",value:w.convoyeurPhone,onChange:j=>N(k=>({...k,convoyeurPhone:j.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm",placeholder:"T√©l√©phone"})]})]}),r("div",{className:"flex gap-2 p-4 border-t shrink-0",children:[e("button",{type:"button",onClick:()=>c(null),className:"flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 text-sm font-medium hover:bg-gray-50",children:"Annuler"}),e("button",{type:"submit",disabled:!!L||!((Z=w.arrivalCity)!=null&&Z.trim()),className:"flex-1 px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700 disabled:opacity-50",children:L?"‚Ä¶":"Affecter"})]})]})]})})]})},tm=Object.freeze(Object.defineProperty({__proto__:null,default:Qd},Symbol.toStringTag,{value:"Module"})),Jd=["agentCourrier","chefAgence","admin_compagnie"],Zd=()=>{var I,C;const{user:a,company:t}=Ke(),i=Lt(t),s=(document.documentElement.classList.contains("dark")?"dark":null)??localStorage.getItem("theme")??"light",n=Array.isArray(a==null?void 0:a.role)?a.role:a!=null&&a.role?[a.role]:[],l=A=>n.includes(A);if(!Jd.some(A=>l(A)))return null;const g=(((I=i==null?void 0:i.colors)==null?void 0:I.primary)??"#ea580c").trim(),f=(((C=i==null?void 0:i.colors)==null?void 0:C.secondary)??"#f97316").trim(),b=o.useMemo(()=>{if(s==="dark"){const A=Pr(g),u=Pr(f);return{"--courier-primary":A,"--courier-secondary":u,"--teliya-primary":A,"--teliya-secondary":u}}return{"--courier-primary":g,"--courier-secondary":f,"--teliya-primary":g,"--teliya-secondary":f}},[s,g,f]);return e("div",{className:s==="dark"?"agency-dark":"",style:b,children:e(gr,{})})},am=Object.freeze(Object.defineProperty({__proto__:null,default:Zd},Symbol.toStringTag,{value:"Module"})),eu=()=>e(kt,{to:"/agence/courrier/session",replace:!0}),rm=Object.freeze(Object.defineProperty({__proto__:null,default:eu},Symbol.toStringTag,{value:"Module"})),tu="#ea580c",au="#f97316";function ru({session:a,shipments:t,agencyName:i,primaryColor:s=tu,secondaryColor:n=au}){const l=Nt(),d=a!=null&&a.openedAt&&typeof a.openedAt.toDate=="function"?Je(a.openedAt.toDate(),"dd/MM/yyyy HH:mm",{locale:Et}):"‚Äî",g=t.filter(u=>u.sessionId===(a==null?void 0:a.sessionId)),f=g.reduce((u,x)=>u+(x.transportFee??0)+(x.insuranceAmount??0),0),b=t.filter(u=>u.sessionId===(a==null?void 0:a.sessionId)&&(u.currentStatus==="DELIVERED"||u.currentStatus==="CLOSED")),I=b.reduce((u,x)=>u+(x.destinationCollectedAmount??0),0),C=f+I,A=a?a.status==="PENDING"?"En attente":a.status==="ACTIVE"?"Active":a.status==="CLOSED"?"Cl√¥tur√©e":"Valid√©e":"‚Äî";return r("section",{className:"mb-6 rounded-xl border border-gray-200/80 bg-white p-5 shadow-sm print:hidden sm:p-6","aria-label":"Session courrier en direct",children:[e("h2",{className:"mb-4 text-2xl font-bold",style:{color:"var(--courier-primary, #ea580c)"},children:"Session en direct"}),r("div",{className:"grid grid-cols-1 gap-4 xs:grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5",children:[r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm transition-shadow hover:shadow",style:{borderColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 30%, transparent)",backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 6%, transparent)"},children:[e(sr,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Statut"}),e("span",{className:"mt-1 text-xl font-semibold",style:{color:"var(--courier-primary, #ea580c)"},children:A})]}),r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm transition-shadow hover:shadow",style:{borderColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 30%, transparent)",backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 6%, transparent)"},children:[e(Rn,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Code agent"}),e("span",{className:"mt-1 font-mono text-xl font-semibold",style:{color:"var(--courier-primary, #ea580c)"},children:(a==null?void 0:a.agentCode)??"‚Äî"})]}),r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm transition-shadow hover:shadow",style:{borderColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 30%, transparent)",backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 6%, transparent)"},children:[e(Or,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Ouverture"}),e("span",{className:"mt-1 text-lg font-medium",style:{color:"var(--courier-primary, #ea580c)"},children:d})]}),r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm transition-shadow hover:shadow",style:{borderColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 30%, transparent)",backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 6%, transparent)"},children:[e(wa,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Envois cr√©√©s"}),e("span",{className:"mt-1 text-2xl font-bold",style:{color:"var(--courier-primary, #ea580c)"},children:g.length})]}),r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm transition-shadow hover:shadow courier-kpi-origin",style:{borderColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 25%, transparent)",backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 5%, transparent)"},children:[e(Mt,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Total encaiss√© origine"}),e("span",{className:"mt-1 text-xl font-bold teliya-monetary",children:l(f)})]}),r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm transition-shadow hover:shadow",style:{borderColor:"color-mix(in srgb, var(--courier-secondary, #f97316) 30%, transparent)",backgroundColor:"color-mix(in srgb, var(--courier-secondary, #f97316) 6%, transparent)"},children:[e(ea,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-secondary, #f97316)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Envois livr√©s"}),e("span",{className:"mt-1 text-2xl font-bold",style:{color:"var(--courier-secondary, #f97316)"},children:b.length})]}),r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm transition-shadow hover:shadow courier-kpi-dest",style:{borderColor:"color-mix(in srgb, var(--courier-secondary, #f97316) 25%, transparent)",backgroundColor:"color-mix(in srgb, var(--courier-secondary, #f97316) 5%, transparent)"},children:[e(_t,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-secondary, #f97316)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Total encaiss√© destination"}),e("span",{className:"mt-1 text-xl font-bold teliya-monetary",children:l(I)})]}),r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm transition-shadow hover:shadow",style:{borderColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 50%, var(--courier-secondary, #f97316))",backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 8%, transparent)"},children:[e(_t,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Total global"}),e("span",{className:"mt-1 text-2xl font-bold teliya-monetary",children:l(C)})]})]}),i&&r("p",{className:"mt-4 flex items-center gap-1.5 text-xs text-gray-500",children:[e(Hs,{className:"h-4 w-4"}),"Agence : ",i]})]})}const nu="#ea580c";function Wa({icon:a,title:t,primaryColor:i=nu,description:s,right:n}){return r("header",{className:"mb-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[r("div",{className:"flex items-center gap-3 min-w-0",children:[e("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-lg text-white",style:{backgroundColor:"var(--courier-primary, #ea580c)"},"aria-hidden":!0,children:e(a,{className:"h-6 w-6"})}),r("div",{className:"min-w-0",children:[e("h1",{className:"text-2xl font-bold tracking-tight sm:text-3xl",style:{color:"var(--courier-primary, #ea580c)"},children:t}),s&&e("p",{className:"mt-0.5 text-sm text-gray-600",children:s})]})]}),n&&e("div",{className:"shrink-0",children:n})]})}const hi=({shipment:a,companyName:t,companyLogoUrl:i,agencyName:s,agentName:n,agentCode:l,onClose:d})=>{var h,L,E,m;const g=l??a.agentCode??"‚Äî",f=Nt(),b=o.useRef(null),I=a.shipmentNumber??a.shipmentId,C=a.transportFee+(a.insuranceAmount??0),A=a.createdAt?typeof a.createdAt.toDate=="function"?a.createdAt.toDate():new Date(a.createdAt):new Date,u=Je(A,"dd/MM/yyyy HH:mm",{locale:Et});return r("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4",children:[e("style",{children:`
        @media print {
          body * { visibility: hidden !important; }
          #thermal-ticket-courrier, #thermal-ticket-courrier * { visibility: visible !important; }
          #thermal-ticket-courrier { position: absolute; left: 0; top: 0; width: 100%; }
          .no-print { display: none !important; }
        }
      `}),r("div",{id:"thermal-ticket-courrier",className:"ticket-force-light bg-white rounded-xl shadow-xl overflow-hidden",style:{width:"80mm",fontFamily:"monospace",fontSize:"12px",lineHeight:"1.5"},children:[r("div",{className:"no-print flex justify-between items-center px-4 py-3 border-b",children:[e("div",{className:"font-semibold",children:t}),r("div",{className:"flex gap-2",children:[e("button",{type:"button",onClick:()=>{b.current&&In().set({margin:2,filename:`envoi-${I}.pdf`,html2canvas:{scale:2},jsPDF:{unit:"mm",format:[80,200]}}).from(b.current).save()},className:"px-2 py-1 rounded border text-sm",children:"PDF"}),e("button",{type:"button",onClick:()=>window.print(),className:"px-2 py-1 rounded border text-sm",children:"Imprimer"}),e("button",{type:"button",onClick:d,className:"px-2 py-1 rounded border text-sm",children:"Fermer"})]})]}),r("div",{ref:b,className:"p-4 text-black",children:[r("div",{className:"text-center mb-3",children:[i&&e("img",{src:i,alt:"logo",style:{width:"60px",height:"60px",objectFit:"cover",borderRadius:"50%",border:"2px solid #000",margin:"0 auto"}}),e("div",{style:{fontWeight:"bold",fontSize:"14px",marginTop:"6px"},children:t.toUpperCase()}),e("div",{style:{fontSize:"11px"},children:s})]}),e("hr",{}),r("div",{style:{textAlign:"center",margin:"6px 0"},children:[r("div",{style:{fontWeight:"bold",fontSize:"14px",letterSpacing:"0.05em"},children:["Envoi N¬∞ ",I]}),r("div",{style:{fontSize:"10px",color:"#666"},children:["R√©f. compl√®te : ",I]}),r("div",{style:{fontSize:"11px"},children:["√âmis le ",u]})]}),e("hr",{}),r("div",{style:{marginTop:"8px"},children:[r("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e("span",{children:"Exp√©diteur :"}),e("span",{style:{fontWeight:"bold"},children:((h=a.sender)==null?void 0:h.name)??"‚Äî"})]}),r("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e("span",{children:"T√©l. exp. :"}),e("span",{children:((L=a.sender)==null?void 0:L.phone)??"‚Äî"})]}),r("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e("span",{children:"Destinataire :"}),e("span",{style:{fontWeight:"bold"},children:((E=a.receiver)==null?void 0:E.name)??"‚Äî"})]}),r("div",{style:{display:"flex",justifyContent:"space-between"},children:[e("span",{children:"T√©l. dest. :"}),e("span",{children:((m=a.receiver)==null?void 0:m.phone)??"‚Äî"})]}),a.nature&&r("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"4px"},children:[e("span",{children:"Nature :"}),e("span",{children:a.nature})]})]}),e("hr",{}),r("div",{style:{marginTop:"8px"},children:[r("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e("span",{children:"Valeur d√©clar√©e :"}),e("span",{children:f(a.declaredValue??0)})]}),r("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e("span",{children:"Frais transport :"}),e("span",{children:f(a.transportFee??0)})]}),r("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[e("span",{children:"Assurance :"}),e("span",{children:f(a.insuranceAmount??0)})]})]}),e("hr",{}),e("div",{style:{textAlign:"center",margin:"10px 0"},children:r("div",{style:{fontSize:"16px",fontWeight:"bold"},children:["Total pay√© : ",f(C)]})}),e("hr",{}),r("div",{style:{fontSize:"11px",textAlign:"center",marginTop:"8px",fontWeight:"bold"},children:["Code agent : ",g]}),r("div",{style:{fontSize:"10px",textAlign:"center"},children:["Agent : ",n]}),r("div",{style:{fontSize:"10px",textAlign:"center"},children:["Agence : ",s]}),r("div",{style:{fontSize:"10px",textAlign:"center"},children:["Date : ",u]})]})]})]})},pi=({shipment:a,destinationAgencyName:t,originAgencyName:i,onClose:s})=>{var f,b;const n=o.useRef(null),l=a.shipmentNumber??a.shipmentId,d=a.createdAt?typeof a.createdAt.toDate=="function"?a.createdAt.toDate():new Date(a.createdAt):null,g=d?new Intl.DateTimeFormat("fr-FR",{dateStyle:"short",timeStyle:"short"}).format(d):"‚Äî";return r("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4",children:[e("style",{children:`
        @media print {
          body * { visibility: hidden !important; }
          .courier-package-label, .courier-package-label * { visibility: visible !important; }
          .courier-package-label { position: absolute; left: 0; top: 0; width: 100%; }
          .no-print { display: none !important; }
        }
      `}),r("div",{ref:n,className:"courier-package-label bg-white rounded-xl shadow-xl p-6 max-w-md w-full",children:[r("div",{className:"no-print flex justify-end gap-2 mb-4",children:[e("button",{type:"button",onClick:()=>window.print(),className:"px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50",children:"Imprimer"}),s&&e("button",{type:"button",onClick:s,className:"px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50",children:"Fermer"})]}),r("div",{className:"border-2 border-dashed border-gray-400 p-4 rounded-lg",children:[r("div",{className:"text-center mb-4",children:[e("div",{className:"text-2xl font-mono font-bold tracking-widest text-gray-900",children:l}),r("div",{className:"text-xs text-gray-500 mt-1",children:["R√©f. compl√®te : ",l]}),a.agentCode&&r("div",{className:"text-xs text-gray-500 mt-0.5",children:["Agent : ",a.agentCode]}),r("div",{className:"text-xs text-gray-500",children:["Agence : ",i," ¬∑ Date : ",g]})]}),r("div",{className:"space-y-2 text-sm",children:[r("div",{children:[e("span",{className:"text-gray-500",children:"Destination : "}),e("span",{className:"font-medium",children:t})]}),r("div",{children:[e("span",{className:"text-gray-500",children:"Destinataire : "}),e("span",{className:"font-medium",children:((f=a.receiver)==null?void 0:f.name)??"‚Äî"})]}),r("div",{children:[e("span",{className:"text-gray-500",children:"T√©l. destinataire : "}),e("span",{className:"font-medium",children:((b=a.receiver)==null?void 0:b.phone)??"‚Äî"})]}),r("div",{children:[e("span",{className:"text-gray-500",children:"Agence origine : "}),e("span",{className:"font-medium",children:i})]})]}),e("div",{className:"mt-4 flex justify-center",children:e("div",{className:"w-24 h-24 border-2 border-gray-300 rounded flex items-center justify-center text-gray-400 text-xs",children:"QR code"})})]})]})]})};function su(){var Y,ue;const{user:a,company:t}=Ke(),i=Nt(),s=(a==null?void 0:a.companyId)??"",n=(a==null?void 0:a.agencyId)??"",l=(a==null?void 0:a.uid)??"",d=(a==null?void 0:a.displayName)??"Agent",g=(a==null?void 0:a.agencyNom)??"Agence",f=(t==null?void 0:t.nom)??"Compagnie",b=(t==null?void 0:t.logoUrl)??void 0,I=Lt(t),C=((Y=I==null?void 0:I.colors)==null?void 0:Y.primary)??"#ea580c",A=((ue=I==null?void 0:I.colors)==null?void 0:ue.secondary)??"#f97316",[u,x]=o.useState(null),[h,L]=o.useState(null),[E,m]=o.useState([]),[c,w]=o.useState(!1),[N,R]=o.useState(null),[H,M]=o.useState(!1),[K,B]=o.useState(null),[le,Q]=o.useState(null),[Z,j]=o.useState([]),k=(a==null?void 0:a.staffCode)??(a==null?void 0:a.codeCourt)??(a==null?void 0:a.code)??"COUR";o.useEffect(()=>{s&&Ee(he($,"companies",s,"agences")).then(T=>{j(T.docs.map(ce=>({id:ce.id,...ce.data()})))})},[s]),o.useEffect(()=>{if(!s||!n||!l)return;const T=Br($,s,n),ce=Ge(Te(T,ae("agentId","==",l)),Ie=>{const Ve=[...Ie.docs].sort((Fe,te)=>{var Pe,je,D,G;const Ae=((je=(Pe=Fe.data().createdAt)==null?void 0:Pe.toMillis)==null?void 0:je.call(Pe))??0;return(((G=(D=te.data().createdAt)==null?void 0:D.toMillis)==null?void 0:G.call(D))??0)-Ae});if(Ve.length>0){const Fe=Ve[0];L(Fe.id),x({...Fe.data(),sessionId:Fe.id})}else L(null),x(null)});return()=>ce()},[s,n,l]),o.useEffect(()=>{if(!s||!n||!h)return;const T=jo($,s,n,h),ce=Ge(T,Ie=>{Ie.exists()&&x({...Ie.data(),sessionId:Ie.id})});return()=>ce()},[s,n,h]),o.useEffect(()=>{if(!s||!h){m([]);return}const T=ia($,s),ce=Te(T,ae("sessionId","==",h)),Ie=Ge(ce,Ve=>{m(Ve.docs.map(Fe=>Fe.data()))});return()=>Ie()},[s,h]);const W=async()=>{R(null),w(!0);try{await Oo({companyId:s,agencyId:n,agentId:l,agentCode:k})}catch(T){R(T instanceof Error?T.message:"Erreur ouverture session")}finally{w(!1)}},q=async()=>{if(h){R(null),w(!0);try{await Vo({companyId:s,agencyId:n,sessionId:h}),M(!1)}catch(T){R(T instanceof Error?T.message:"Erreur fermeture session")}finally{w(!1)}}},ye=T=>T.transportFee+(T.insuranceAmount??0),se=T=>{var ce,Ie;return((ce=Z.find(Ve=>Ve.id===T))==null?void 0:ce.nomAgence)??((Ie=Z.find(Ve=>Ve.id===T))==null?void 0:Ie.nom)??(T||"‚Äî")};return r("div",{className:"p-4 max-w-4xl mx-auto space-y-6",children:[e(Wa,{icon:ur,title:"Session Courrier",primaryColor:C,right:(u==null?void 0:u.status)==="ACTIVE"?r(En,{to:"/agence/courrier/nouveau",className:"inline-flex min-h-[44px] items-center gap-2 rounded-lg px-4 py-2.5 text-white transition-colors duration-200 hover:opacity-90 active:opacity-95",style:{backgroundColor:"var(--courier-primary, #ea580c)"},onMouseOver:T=>{T.currentTarget.style.backgroundColor="var(--courier-secondary, #f97316)"},onMouseOut:T=>{T.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)"},children:[e(Ka,{className:"h-4 w-4"}),"Nouvel envoi"]}):void 0}),e(ru,{session:u,shipments:E,agencyName:g,primaryColor:C,secondaryColor:A}),N&&r("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-red-50 text-red-800 border border-red-200",children:[e($n,{className:"w-5 h-5 shrink-0"}),e("span",{children:N}),e("button",{type:"button",onClick:()=>R(null),className:"ml-auto underline",children:"Fermer"})]}),r("section",{className:"rounded-xl border border-gray-200/80 bg-white p-5 shadow-sm sm:p-6",children:[r("h2",{className:"mb-4 flex items-center gap-2 font-semibold text-gray-800",children:[e(ur,{className:"h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"}}),"Session"]}),!u||u.status!=="PENDING"&&u.status!=="ACTIVE"?r("div",{children:[e("p",{className:"text-gray-600 mb-3",children:u?"Session cl√¥tur√©e ou valid√©e. Cr√©ez une nouvelle session pour enregistrer des envois.":"Aucune session. Cr√©ez une session (elle sera en attente d'activation par le comptable)."}),r("button",{type:"button",onClick:W,disabled:c,className:"inline-flex min-h-[44px] items-center gap-2 rounded-lg px-4 py-2.5 text-white transition-colors duration-200 disabled:opacity-50",style:{backgroundColor:"var(--courier-primary, #ea580c)"},onMouseOver:T=>{c||(T.currentTarget.style.backgroundColor="var(--courier-secondary, #f97316)")},onMouseOut:T=>{T.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)"},children:[c?e(rt,{className:"h-4 w-4 animate-spin"}):null,"Cr√©er une session"]})]}):null,u&&u.status!=="PENDING"&&u.status!=="ACTIVE"?e("div",{className:"mt-4 p-3 rounded-lg bg-gray-50 border border-gray-200",children:r("p",{className:"text-sm text-gray-600",children:["Derni√®re session : ",e("span",{className:"font-medium",children:u.status==="CLOSED"?"Cl√¥tur√©e":"Valid√©e"})," ‚Äî ","Montant attendu : ",e("span",{className:"font-mono",children:i(u.expectedAmount??0)})]})}):null,u?r("div",{className:"space-y-2",children:[r("p",{className:"text-gray-700",children:[e("span",{className:"font-medium",children:"Statut :"})," ",r("span",{className:u.status==="ACTIVE"?"text-green-700":u.status==="CLOSED"||u.status==="VALIDATED"?"text-gray-600":"text-amber-700",children:[u.status==="PENDING"&&"En attente d'activation par le comptable",u.status==="ACTIVE"&&"Active",u.status==="CLOSED"&&"Cl√¥tur√©e",u.status==="VALIDATED"&&"Valid√©e"]})]}),(u.status==="CLOSED"||u.status==="VALIDATED")&&r("p",{className:"text-gray-700",children:[e("span",{className:"font-medium",children:"Montant attendu :"})," ",e("span",{className:"font-mono",children:i(u.expectedAmount??0)})]}),u.status==="ACTIVE"&&e("button",{type:"button",onClick:()=>M(!0),disabled:c,className:"inline-flex min-h-[44px] items-center gap-2 rounded-lg border px-4 py-2.5 transition-colors duration-200 disabled:opacity-50",style:{borderColor:"var(--courier-primary, #ea580c)",color:"var(--courier-primary, #ea580c)"},onMouseOver:T=>{c||(T.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)",T.currentTarget.style.color="#fff")},onMouseOut:T=>{T.currentTarget.style.backgroundColor="",T.currentTarget.style.color="var(--courier-primary, #ea580c)"},children:"Fermer la session"})]}):null]}),H&&h&&e("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4",children:r("div",{className:"bg-white rounded-xl p-6 max-w-sm w-full shadow-xl",children:[e("h3",{className:"font-semibold mb-2",children:"Fermer la session"}),e("p",{className:"text-gray-600 text-sm mb-4",children:"Le montant attendu sera calcul√© √† partir des envois de cette session."}),r("div",{className:"flex gap-2 justify-end",children:[e("button",{type:"button",onClick:()=>M(!1),className:"min-h-[44px] rounded-lg border border-gray-300 px-4 py-2.5 transition-colors duration-200 hover:bg-gray-50",children:"Annuler"}),r("button",{type:"button",onClick:q,disabled:c,className:"min-h-[44px] rounded-lg px-4 py-2.5 text-white transition-colors duration-200 disabled:opacity-50",style:{backgroundColor:"var(--courier-primary, #ea580c)"},onMouseOver:T=>{c||(T.currentTarget.style.backgroundColor="var(--courier-secondary, #f97316)")},onMouseOut:T=>{T.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)"},children:[c?e(rt,{className:"h-4 w-4 animate-spin inline"}):null," Confirmer"]})]})]})}),h&&r("section",{className:"rounded-xl border border-gray-200/80 bg-white p-5 shadow-sm sm:p-6",children:[r("h2",{className:"mb-4 flex items-center gap-2 font-semibold text-gray-800",children:[e("span",{style:{color:"var(--courier-primary, #ea580c)"},children:"üì¶"}),"Envois de la session"]}),E.length===0?e("p",{className:"text-gray-500 text-sm",children:"Aucun envoi pour cette session."}):e("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:r("table",{className:"w-full text-sm",children:[e("thead",{children:r("tr",{className:"border-b bg-gray-100 text-left font-semibold text-gray-700",children:[e("th",{className:"p-3",children:"ID"}),e("th",{className:"p-3",children:"Exp√©diteur"}),e("th",{className:"p-3",children:"Destinataire"}),e("th",{className:"p-3",children:"Total pay√©"}),e("th",{className:"p-3",children:"Statut"}),e("th",{className:"p-3"})]})}),e("tbody",{children:E.map((T,ce)=>{var Ie,Ve;return r("tr",{className:`border-b ${ce%2===1?"bg-gray-50":""}`,children:[e("td",{className:"p-3 font-mono",children:T.shipmentNumber??T.shipmentId}),e("td",{className:"p-3",children:((Ie=T.sender)==null?void 0:Ie.name)??"‚Äî"}),e("td",{className:"p-3",children:((Ve=T.receiver)==null?void 0:Ve.name)??"‚Äî"}),e("td",{className:"p-3",children:i(ye(T))}),e("td",{className:"p-3",children:T.currentStatus}),r("td",{className:"flex flex-wrap gap-2 p-3",children:[e("button",{type:"button",onClick:()=>B(T),className:"min-h-[44px] px-3 py-2 text-sm font-medium transition-colors duration-200",style:{color:"var(--courier-primary, #ea580c)"},children:"Re√ßu"}),e("button",{type:"button",onClick:()=>Q(T),className:"min-h-[44px] px-3 py-2 text-sm font-medium transition-colors duration-200",style:{color:"var(--courier-secondary, #f97316)"},children:"√âtiquette"})]})]},T.shipmentId)})})]})})]}),K&&e(hi,{shipment:K,companyName:f,companyLogoUrl:b,agencyName:g,agentName:d,agentCode:k,onClose:()=>B(null)}),le&&e(pi,{shipment:le,destinationAgencyName:se(le.destinationAgencyId),originAgencyName:g,onClose:()=>Q(null)})]})}const nm=Object.freeze(Object.defineProperty({__proto__:null,default:su},Symbol.toStringTag,{value:"Module"})),bn=a=>a.nomAgence??a.nom??a.id;function iu({options:a,value:t,onChange:i,placeholder:s="Rechercher une agence‚Ä¶","aria-label":n="Agence de destination"}){const[l,d]=o.useState(!1),[g,f]=o.useState(""),[b,I]=o.useState(0),C=o.useRef(null),A=o.useRef(null),u=a.find(c=>c.id===t),x=u?bn(u):"",h=g.trim().toLowerCase(),E=(h===""?a:a.filter(c=>bn(c).toLowerCase().includes(h))).slice(0,30);return o.useEffect(()=>{l||I(0)},[l]),o.useEffect(()=>{if(l&&A.current){const c=A.current.children[b];c==null||c.scrollIntoView({block:"nearest"})}},[l,b]),r("div",{className:"relative w-full",children:[e("input",{ref:C,type:"text",value:l?g:x,onChange:c=>{f(c.target.value),d(!0)},onFocus:()=>d(!0),onBlur:()=>setTimeout(()=>d(!1),200),onKeyDown:c=>{var w;if(!l){(c.key==="Enter"||c.key===" "||c.key==="ArrowDown")&&(c.preventDefault(),d(!0));return}if(c.key==="Escape"){d(!1),(w=C.current)==null||w.blur();return}if(c.key==="ArrowDown"){c.preventDefault(),I(N=>N<E.length-1?N+1:0);return}if(c.key==="ArrowUp"){c.preventDefault(),I(N=>N>0?N-1:E.length-1);return}c.key==="Enter"&&E[b]&&(c.preventDefault(),i(E[b].id),f(""),d(!1))},placeholder:s,"aria-label":n,"aria-expanded":l,"aria-autocomplete":"list",role:"combobox",className:"w-full border border-gray-300 rounded-lg px-3 py-2.5 min-h-[44px] bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"}),l&&e("ul",{ref:A,role:"listbox",className:"absolute z-50 mt-1 w-full max-h-60 overflow-auto rounded-lg border border-gray-200 bg-white shadow-lg py-1",children:E.length===0?e("li",{className:"px-3 py-2.5 text-gray-500 text-sm",children:"Aucune agence trouv√©e"}):E.map((c,w)=>e("li",{role:"option","aria-selected":c.id===t,className:`px-3 py-2.5 min-h-[44px] flex items-center cursor-pointer text-sm ${w===b?"bg-orange-50 text-orange-900":"text-gray-900 hover:bg-gray-50"} ${c.id===t?"font-medium":""}`,onMouseDown:N=>{N.preventDefault(),i(c.id),f(""),d(!1)},children:bn(c)},c.id))})]})}const Es=5,ou=50,lu=3,cu=3;function du(){var Ne,ge;const{user:a,company:t}=Ke(),i=Nt(),s=(a==null?void 0:a.companyId)??"",n=(a==null?void 0:a.agencyId)??"",l=(a==null?void 0:a.uid)??"",d=(a==null?void 0:a.displayName)??"Agent",g=(a==null?void 0:a.agencyNom)??"Agence",f=(t==null?void 0:t.nom)??"Compagnie",b=(t==null?void 0:t.logoUrl)??void 0,I=Lt(t),C=((Ne=I==null?void 0:I.colors)==null?void 0:Ne.primary)??"#ea580c",A=((ge=I==null?void 0:I.colors)==null?void 0:ge.secondary)??"#f97316",u=(a==null?void 0:a.staffCode)??(a==null?void 0:a.codeCourt)??(a==null?void 0:a.code)??"COUR",[x,h]=o.useState(null),[L,E]=o.useState(null),[m,c]=o.useState([]),[w,N]=o.useState(""),[R,H]=o.useState(""),[M,K]=o.useState(""),[B,le]=o.useState(""),[Q,Z]=o.useState(""),[j,k]=o.useState(""),[W,q]=o.useState(""),[ye,se]=o.useState(""),[Y,ue]=o.useState(!1),[T,ce]=o.useState(null),[Ie,Ve]=o.useState(null),[Fe,te]=o.useState(!1),[Ae,ke]=o.useState(!1),[Pe,je]=o.useState([]);o.useEffect(()=>{if(!s||!n||!l)return;const p=Br($,s,n),V=Ge(Te(p,ae("agentId","==",l)),re=>{const fe=[...re.docs].sort((Ce,Se)=>{var nt,ct,wt,ut;const De=((ct=(nt=Ce.data().createdAt)==null?void 0:nt.toMillis)==null?void 0:ct.call(nt))??0;return(((ut=(wt=Se.data().createdAt)==null?void 0:wt.toMillis)==null?void 0:ut.call(wt))??0)-De});if(fe.length>0){const Ce=fe[0],Se=Ce.data();Se.status==="ACTIVE"||Se.status==="PENDING"?(E(Ce.id),h({...Se,sessionId:Ce.id})):(E(null),h(null))}else E(null),h(null)});return()=>V()},[s,n,l]),o.useEffect(()=>{s&&Ee(he($,"companies",s,"agences")).then(p=>{var re;const V=p.docs.map(fe=>({id:fe.id,...fe.data()}));c(V),V.length>0&&!w&&N(((re=V.find(fe=>fe.id!==n))==null?void 0:re.id)??V[0].id)})},[s,n]),o.useEffect(()=>{if(!s||!n)return;const p=Te(ia($,s),ae("originAgencyId","==",n)),V=Ge(p,re=>{const Ce=re.docs.map(Se=>Se.data()).sort((Se,De)=>{var ct,wt,ut,Pt;const Ze=((wt=(ct=Se.createdAt)==null?void 0:ct.toMillis)==null?void 0:wt.call(ct))??0;return(((Pt=(ut=De.createdAt)==null?void 0:ut.toMillis)==null?void 0:Pt.call(ut))??0)-Ze});je(Ce.slice(0,ou))});return()=>V()},[s,n]);const D=o.useMemo(()=>{const p=new Map;return Pe.slice(0,10).forEach(V=>{var Se,De,Ze,nt;const re=(((Se=V.sender)==null?void 0:Se.phone)??"").trim();if(!re)return;const fe=(((De=V.sender)==null?void 0:De.name)??"").trim()||re,Ce=p.get(re);Ce?(Ce.count+=1,(nt=(Ze=V.sender)==null?void 0:Ze.name)!=null&&nt.trim()&&(Ce.name=V.sender.name.trim())):p.set(re,{name:fe,count:1})}),[...p.entries()].sort((V,re)=>re[1].count-V[1].count).slice(0,lu).map(([V,{name:re}])=>({phone:V,name:re}))},[Pe]),G=o.useMemo(()=>{const p=new Map;return Pe.slice(0,20).forEach(V=>{const re=V.destinationAgencyId??"";re&&p.set(re,(p.get(re)??0)+1)}),[...p.entries()].sort((V,re)=>re[1]-V[1]).slice(0,cu).map(([V])=>V)},[Pe]),y=o.useMemo(()=>{var fe,Ce;const p=M.trim().toLowerCase();if(p.length<2)return[];const V=new Set,re=[];for(const Se of Pe){const De=(((fe=Se.sender)==null?void 0:fe.phone)??"").trim();if(!(!De||!De.toLowerCase().startsWith(p)||V.has(De))&&(V.add(De),re.push({phone:De,name:(((Ce=Se.sender)==null?void 0:Ce.name)??"").trim()||De}),re.length>=Es))break}return re},[Pe,M]),P=o.useMemo(()=>{var fe,Ce;const p=Q.trim().toLowerCase();if(p.length<2)return[];const V=new Set,re=[];for(const Se of Pe){const De=(((fe=Se.receiver)==null?void 0:fe.phone)??"").trim();if(!(!De||!De.toLowerCase().startsWith(p)||V.has(De))&&(V.add(De),re.push({phone:De,name:(((Ce=Se.receiver)==null?void 0:Ce.name)??"").trim()||De}),re.length>=Es))break}return re},[Pe,Q]),F=(()=>{const p=Number(ye);return Number.isNaN(p)||p<0?0:p})(),z=(x==null?void 0:x.status)==="ACTIVE"&&L&&R.trim()!==""&&M.trim()!==""&&B.trim()!==""&&Q.trim()!==""&&j.trim()!==""&&W.trim()!==""&&!Number.isNaN(Number(W))&&Number(W)>=0&&ye.trim()!==""&&!Number.isNaN(Number(ye))&&Number(ye)>=0,ee=async p=>{if(p.preventDefault(),!(!z||!L)){ce(null),ue(!0);try{const V=Number(ye),re=Number(W),fe=m.find(nt=>nt.id===n),Ce=Fr(t==null?void 0:t.nom,t==null?void 0:t.code),Se=Fr((fe==null?void 0:fe.nomAgence)??(fe==null?void 0:fe.nom),fe==null?void 0:fe.code),{shipmentId:De,shipmentNumber:Ze}=await qo({companyId:s,originAgencyId:n,destinationAgencyId:w||n,sender:{name:R.trim(),phone:M.trim()},receiver:{name:B.trim(),phone:Q.trim()},nature:j.trim(),declaredValue:Number.isNaN(re)?0:re,insuranceRate:0,insuranceAmount:0,transportFee:V,paymentType:"ORIGIN",paymentStatus:V>0?"PAID_ORIGIN":"UNPAID",createdBy:l,sessionId:L,agentCode:u,companyCode:Ce,agencyCode:Se});await Bo({companyId:s,sessionId:L,shipmentId:De,agencyId:n,agentId:l,type:"TRANSPORT_FEE",amount:V}),Ve({shipmentId:De,shipmentNumber:Ze,originAgencyId:n,destinationAgencyId:w||n,sender:{name:R.trim(),phone:M.trim()},receiver:{name:B.trim(),phone:Q.trim()},nature:j.trim(),declaredValue:Number.isNaN(re)?0:re,insuranceRate:0,insuranceAmount:0,transportFee:V,paymentType:"ORIGIN",paymentStatus:V>0?"PAID_ORIGIN":"UNPAID",currentStatus:"CREATED",currentAgencyId:n,createdAt:new Date,createdBy:l,sessionId:L,agentCode:u}),H(""),K(""),le(""),Z(""),k(""),q(""),se("")}catch(V){ce(V instanceof Error?V.message:"Erreur cr√©ation envoi")}finally{ue(!1)}}},ne=p=>{var V,re;return((V=m.find(fe=>fe.id===p))==null?void 0:V.nomAgence)??((re=m.find(fe=>fe.id===p))==null?void 0:re.nom)??p};return r("div",{className:"p-4 max-w-2xl mx-auto space-y-6",children:[e(Wa,{icon:wa,title:"Nouvel Envoi",primaryColor:C,right:r(En,{to:"/agence/courrier",className:"inline-flex min-h-[44px] items-center gap-2 rounded-lg border px-4 py-2.5 text-sm transition-colors duration-200",style:{borderColor:"var(--courier-primary, #ea580c)",color:"var(--courier-primary, #ea580c)"},onMouseOver:p=>{p.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)",p.currentTarget.style.color="#fff"},onMouseOut:p=>{p.currentTarget.style.backgroundColor="",p.currentTarget.style.color="var(--courier-primary, #ea580c)"},children:[e(Ao,{className:"h-4 w-4"}),"Courrier"]})}),!x&&e("div",{className:"rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-800 text-sm",children:"Aucune session active. Ouvrez une session depuis Courrier et attendez son activation par le comptable."}),(x==null?void 0:x.status)==="PENDING"&&e("div",{className:"rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-800 text-sm",children:"Session en attente d'activation par le comptable."}),T&&r("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-red-50 text-red-800 border border-red-200",children:[e($n,{className:"w-5 h-5 shrink-0"}),e("span",{children:T}),e("button",{type:"button",onClick:()=>ce(null),className:"ml-auto underline min-h-[44px]",children:"Fermer"})]}),(x==null?void 0:x.status)==="ACTIVE"&&r("form",{onSubmit:ee,className:"space-y-6 rounded-xl border border-gray-200/80 bg-white p-5 shadow-sm sm:p-6",style:{"--focus-ring":A},children:[D.length>0&&r("div",{children:[e("p",{className:"mb-2 text-xs font-medium uppercase tracking-wider text-gray-500",children:"Exp√©diteurs fr√©quents"}),e("div",{className:"flex flex-wrap gap-2",children:D.map(({phone:p,name:V})=>e("button",{type:"button",onClick:()=>{K(p),H(V)},className:"min-h-[44px] rounded-lg border px-3 py-2 text-sm transition-colors duration-200",style:{borderColor:"var(--courier-primary, #ea580c)",color:"var(--courier-primary, #ea580c)"},onMouseOver:re=>{re.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)",re.currentTarget.style.color="#fff"},onMouseOut:re=>{re.currentTarget.style.backgroundColor="",re.currentTarget.style.color="var(--courier-primary, #ea580c)"},children:V||p},p))})]}),r("section",{className:"rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[e("h2",{className:"mb-3 font-semibold",style:{color:"var(--courier-primary, #ea580c)"},children:"Exp√©diteur"}),r("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[r("div",{children:[r("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:["Nom ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{required:!0,value:R,onChange:p=>H(p.target.value),className:"min-h-[44px] w-full rounded-lg border border-gray-300 px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--focus-ring)] focus:ring-offset-0",placeholder:"Nom exp√©diteur"})]}),r("div",{className:"relative",children:[r("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:["T√©l√©phone ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{required:!0,type:"tel",value:M,onChange:p=>K(p.target.value),className:"min-h-[44px] w-full rounded-lg border border-gray-300 px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--focus-ring)] focus:ring-offset-0",placeholder:"T√©l. exp√©diteur"}),y.length>0&&e("ul",{className:"absolute z-10 mt-1 max-h-48 w-full overflow-auto rounded-lg border bg-white py-1 shadow-lg",children:y.map(({phone:p,name:V})=>e("li",{children:r("button",{type:"button",className:"w-full px-3 py-2.5 text-left text-sm min-h-[44px] hover:opacity-90",style:{backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 5%, transparent)"},onMouseDown:re=>{re.preventDefault(),K(p),H(V||R)},children:[V||p," ‚Äî ",p]})},p))})]})]})]}),r("section",{className:"rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[e("h2",{className:"mb-3 font-semibold",style:{color:"var(--courier-primary, #ea580c)"},children:"Destinataire"}),r("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[r("div",{children:[r("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Nom ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{required:!0,value:B,onChange:p=>le(p.target.value),className:"min-h-[44px] w-full rounded-lg border border-gray-300 px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--focus-ring)] focus:ring-offset-0",placeholder:"Nom destinataire"})]}),r("div",{className:"relative",children:[r("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["T√©l√©phone ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{required:!0,type:"tel",value:Q,onChange:p=>Z(p.target.value),className:"min-h-[44px] w-full rounded-lg border border-gray-300 px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--focus-ring)] focus:ring-offset-0",placeholder:"T√©l. destinataire"}),P.length>0&&e("ul",{className:"absolute z-10 mt-1 w-full rounded-lg border bg-white shadow-lg py-1 max-h-48 overflow-auto",children:P.map(({phone:p,name:V})=>e("li",{children:r("button",{type:"button",className:"w-full px-3 py-2.5 text-left text-sm min-h-[44px] hover:opacity-90",style:{backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 5%, transparent)"},onMouseDown:re=>{re.preventDefault(),Z(p),le(V||B)},children:[V||p," ‚Äî ",p]})},p))})]})]})]}),r("section",{className:"rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[G.length>0&&r("div",{className:"mb-3",children:[e("p",{className:"mb-2 text-xs font-medium uppercase tracking-wider text-gray-500",children:"Destinations fr√©quentes"}),e("div",{className:"flex flex-wrap gap-2",children:G.map(p=>e("button",{type:"button",onClick:()=>N(p),className:`min-h-[44px] rounded-lg border px-3 py-2 text-sm transition-colors duration-200 ${w===p?"font-medium text-white":""}`,style:w===p?{backgroundColor:"var(--courier-primary, #ea580c)",borderColor:"var(--courier-primary, #ea580c)"}:{borderColor:"var(--courier-primary, #ea580c)",color:"var(--courier-primary, #ea580c)"},onMouseOver:V=>{w!==p&&(V.currentTarget.style.backgroundColor="color-mix(in srgb, var(--courier-primary, #ea580c) 10%, transparent)")},onMouseOut:V=>{w!==p&&(V.currentTarget.style.backgroundColor="")},children:ne(p)},p))})]}),e("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Agence de destination"}),e(iu,{options:m,value:w,onChange:N,placeholder:"Rechercher une agence‚Ä¶","aria-label":"Agence de destination"})]}),r("section",{className:"rounded-lg border border-gray-100 bg-gray-50/50 p-4",children:[e("h2",{className:"mb-3 font-semibold",style:{color:"var(--courier-primary, #ea580c)"},children:"Colis"}),r("div",{className:"space-y-4",children:[r("div",{children:[r("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:["Nature ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{required:!0,value:j,onChange:p=>k(p.target.value),className:"min-h-[44px] w-full rounded-lg border border-gray-300 px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--focus-ring)] focus:ring-offset-0",placeholder:"Ex: Documents, Colis"})]}),r("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2",children:[r("div",{children:[r("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:["Valeur d√©clar√©e (FCFA) ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{required:!0,type:"number",min:"0",step:"1",value:W,onChange:p=>q(p.target.value),className:"min-h-[44px] w-full rounded-lg border border-gray-300 px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--focus-ring)] focus:ring-offset-0",placeholder:"0"}),e("p",{className:"mt-1 text-xs text-gray-500",children:"N'affecte pas le total."})]}),r("div",{children:[r("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:["Frais de transport (FCFA) ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{required:!0,type:"number",min:"0",step:"1",value:ye,onChange:p=>se(p.target.value),className:"min-h-[44px] w-full rounded-lg border border-gray-300 px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[var(--focus-ring)] focus:ring-offset-0",placeholder:"0"})]})]})]})]}),r("div",{className:"flex flex-col gap-4 rounded-xl border-2 bg-gray-50/80 p-5 sm:flex-row sm:items-center sm:justify-between",style:{borderColor:"var(--courier-primary, #ea580c)"},children:[r("div",{children:[e("span",{className:"text-sm font-medium uppercase tracking-wider text-gray-600",children:"Total √† payer"}),e("p",{className:"mt-1 text-2xl font-bold teliya-monetary",children:i(F)})]}),r("button",{type:"submit",disabled:!z||Y,className:"w-full min-h-[48px] rounded-lg px-4 py-2.5 text-white transition-colors duration-200 disabled:opacity-50 sm:w-auto inline-flex items-center justify-center gap-2",style:{backgroundColor:"var(--courier-primary, #ea580c)"},onMouseOver:p=>{z&&!Y&&(p.currentTarget.style.backgroundColor="var(--courier-secondary, #f97316)")},onMouseOut:p=>{p.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)"},children:[Y?e(rt,{className:"h-5 w-5 animate-spin"}):null,"Cr√©er l'envoi"]})]})]}),Ie&&r("div",{className:"space-y-4 rounded-xl border border-gray-200/80 bg-white p-5 shadow-sm sm:p-6",children:[r("p",{className:"font-medium text-green-700",children:["Envoi cr√©√© : ",Ie.shipmentNumber??Ie.shipmentId]}),r("div",{className:"flex flex-wrap gap-2",children:[e("button",{type:"button",onClick:()=>te(!0),className:"min-h-[44px] rounded-lg px-4 py-2.5 text-sm text-white transition-colors duration-200",style:{backgroundColor:"var(--courier-primary, #ea580c)"},onMouseOver:p=>{p.currentTarget.style.backgroundColor="var(--courier-secondary, #f97316)"},onMouseOut:p=>{p.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)"},children:"Imprimer re√ßu"}),e("button",{type:"button",onClick:()=>ke(!0),className:"min-h-[44px] rounded-lg border px-4 py-2.5 text-sm transition-colors duration-200",style:{borderColor:"var(--courier-primary, #ea580c)",color:"var(--courier-primary, #ea580c)"},onMouseOver:p=>{p.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)",p.currentTarget.style.color="#fff"},onMouseOut:p=>{p.currentTarget.style.backgroundColor="",p.currentTarget.style.color="var(--courier-primary, #ea580c)"},children:"Imprimer √©tiquette"}),e("button",{type:"button",onClick:()=>{Ve(null),te(!1),ke(!1)},className:"min-h-[44px] rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors duration-200 hover:bg-gray-50",children:"Fermer"})]})]}),Ie&&Fe&&e(hi,{shipment:Ie,companyName:f,companyLogoUrl:b,agencyName:g,agentName:d,agentCode:u,onClose:()=>te(!1)}),Ie&&Ae&&e(pi,{shipment:Ie,destinationAgencyName:ne(Ie.destinationAgencyId),originAgencyName:g,onClose:()=>ke(!1)})]})}const sm=Object.freeze(Object.defineProperty({__proto__:null,default:du},Symbol.toStringTag,{value:"Module"}));function uu(){var L,E;const{user:a,company:t}=Ke(),i=Lt(t),s=((L=i==null?void 0:i.colors)==null?void 0:L.primary)??"#ea580c";(E=i==null?void 0:i.colors)==null||E.secondary;const n=(a==null?void 0:a.companyId)??"",l=(a==null?void 0:a.agencyId)??"",[d,g]=o.useState([]),[f,b]=o.useState([]),[I,C]=o.useState({}),[A,u]=o.useState(null);o.useEffect(()=>{if(!n||!l)return;const m=Te(ia($,n),ae("destinationAgencyId","==",l),ae("currentStatus","in",["CREATED","IN_TRANSIT"])),c=Ge(m,w=>{g(w.docs.map(N=>N.data()))});return()=>c()},[n,l]),o.useEffect(()=>{if(!n||!l)return;const m=Te(ia($,n),ae("destinationAgencyId","==",l),ae("currentStatus","==","ARRIVED")),c=Ge(m,w=>{b(w.docs.map(N=>N.data()))});return()=>c()},[n,l]);const x=async m=>{u(null),C(c=>({...c,[m]:!0}));try{await Go({companyId:n,shipmentId:m,performedBy:a.uid,agencyId:l})}catch(c){u(c instanceof Error?c.message:"Erreur")}finally{C(c=>({...c,[m]:!1}))}},h=async m=>{u(null),C(c=>({...c,[m]:!0}));try{await Uo({companyId:n,shipmentId:m,performedBy:a.uid,agencyId:l})}catch(c){u(c instanceof Error?c.message:"Erreur")}finally{C(c=>({...c,[m]:!1}))}};return r("div",{className:"p-4 max-w-4xl mx-auto space-y-6",children:[e(Wa,{icon:Io,title:"R√©ception Colis",primaryColor:s,description:"Marquez les envois ¬´ Arriv√©s ¬ª, puis ¬´ Pr√™t √† retirer ¬ª pour la remise."}),A&&r("div",{className:"p-3 rounded-lg bg-red-50 text-red-800 border border-red-200 text-sm flex justify-between",children:[e("span",{children:A}),e("button",{type:"button",onClick:()=>u(null),className:"underline",children:"Fermer"})]}),d.length>0&&r("section",{className:"rounded-xl border border-amber-200 bg-amber-50/50 p-4 shadow-sm",children:[r("h2",{className:"font-semibold text-gray-800 flex items-center gap-2 mb-3",children:[e(ea,{className:"w-5 h-5"}),"Envois √† marquer arriv√©s (simulation Phase 1)"]}),e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{children:r("tr",{className:"border-b text-left text-gray-600",children:[e("th",{className:"p-3",children:"Code"}),e("th",{className:"p-3",children:"Destinataire"}),e("th",{className:"p-3",children:"Statut"}),e("th",{className:"p-3 w-40",children:"Action"})]})}),e("tbody",{children:d.map(m=>{var c;return r("tr",{className:"border-b",children:[e("td",{className:"p-3 font-mono",children:m.shipmentNumber??m.shipmentId}),e("td",{className:"p-3",children:((c=m.receiver)==null?void 0:c.name)??"‚Äî"}),e("td",{className:"p-3",children:m.currentStatus}),e("td",{className:"p-3",children:r("button",{type:"button",onClick:()=>x(m.shipmentId),disabled:I[m.shipmentId],className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 text-sm min-h-[44px]",children:[I[m.shipmentId]?e(rt,{className:"w-4 h-4 animate-spin"}):e(ea,{className:"w-4 h-4"}),"Marquer arriv√©"]})})]},m.shipmentId)})})]})})]}),r("section",{className:"rounded-xl border bg-white shadow-sm overflow-hidden",children:[e("h2",{className:"font-semibold text-gray-800 p-4 pb-0",children:"Envois arriv√©s ‚Äî Pr√™t √† retirer"}),f.length===0?e("div",{className:"p-8 text-center text-gray-500",children:"Aucun envoi en statut Arriv√©."}):e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm",children:[e("thead",{children:r("tr",{className:"border-b bg-gray-50 text-left text-gray-600",children:[e("th",{className:"p-3",children:"Code"}),e("th",{className:"p-3",children:"Destinataire"}),e("th",{className:"p-3",children:"T√©l."}),e("th",{className:"p-3 hidden sm:table-cell",children:"Exp√©diteur"}),e("th",{className:"p-3 w-40",children:"Action"})]})}),e("tbody",{children:f.map(m=>{var c,w,N;return r("tr",{className:"border-b",children:[e("td",{className:"p-3 font-mono",children:m.shipmentNumber??m.shipmentId}),e("td",{className:"p-3",children:((c=m.receiver)==null?void 0:c.name)??"‚Äî"}),e("td",{className:"p-3",children:((w=m.receiver)==null?void 0:w.phone)??"‚Äî"}),e("td",{className:"p-3 hidden sm:table-cell",children:((N=m.sender)==null?void 0:N.name)??"‚Äî"}),e("td",{className:"p-3",children:r("button",{type:"button",onClick:()=>h(m.shipmentId),disabled:I[m.shipmentId],className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 text-sm min-h-[44px]",children:[I[m.shipmentId]?e(rt,{className:"w-4 h-4 animate-spin"}):e(va,{className:"w-4 h-4"}),"Pr√™t √† retirer"]})})]},m.shipmentId)})})]})})]})]})}const im=Object.freeze(Object.defineProperty({__proto__:null,default:uu},Symbol.toStringTag,{value:"Module"}));function mu(){var H,M,K,B,le;const{user:a,company:t}=Ke(),i=Lt(t),s=((H=i==null?void 0:i.colors)==null?void 0:H.primary)??"#ea580c",n=((M=i==null?void 0:i.colors)==null?void 0:M.secondary)??"#f97316",l=(a==null?void 0:a.companyId)??"",d=(a==null?void 0:a.agencyId)??"",g=Nt(),[f,b]=o.useState("code"),[I,C]=o.useState(""),[A,u]=o.useState(null),[x,h]=o.useState(""),[L,E]=o.useState(!1),[m,c]=o.useState(null),w=o.useCallback(async Q=>{if(!l||!Q.trim())return;const Z=Q.trim(),j=Xs($,l,Z),k=await He(j);if(k.exists()){u(k.data());return}const W=Te(ia($,l),ae("shipmentNumber","==",Z)),q=await Ee(W);if(q.empty)u(null);else{const ye=q.docs[0];u({...ye.data(),shipmentId:ye.id})}},[l]);o.useEffect(()=>{if(!l||!d||!I.trim()){u(null);return}if(f==="code"){w(I);return}const Q=Te(ia($,l),ae("receiver.phone","==",I.trim()),ae("currentAgencyId","==",d),ae("currentStatus","==","READY_FOR_PICKUP")),Z=Ge(Q,j=>{const k=j.docs;k.length>0?u(k[0].data()):u(null)});return()=>Z()},[l,d,f,I,w]);const N=async()=>{if(A){if(A.currentStatus!=="READY_FOR_PICKUP"){c("Cet envoi n'est pas en attente de remise.");return}if(A.paymentType==="DESTINATION"){const Q=x.trim()?Number(x):NaN;if(Number.isNaN(Q)||Q<0){c("Paiement √† destination : saisissez le montant per√ßu (FCFA).");return}}c(null),E(!0);try{const Q=x.trim()?Number(x):void 0;if(Q!=null&&(Number.isNaN(Q)||Q<0)){c("Montant destination invalide."),E(!1);return}await zo({companyId:l,shipmentId:A.shipmentId,performedBy:a.uid,agencyId:d,destinationCollectedAmount:Q}),u(null),C(""),h("")}catch(Q){c(Q instanceof Error?Q.message:"Erreur")}finally{E(!1)}}},R=(A==null?void 0:A.currentStatus)==="READY_FOR_PICKUP"&&(A.paymentType!=="DESTINATION"||x.trim()!==""&&!Number.isNaN(Number(x))&&Number(x)>=0);return r("div",{className:"mx-auto max-w-2xl space-y-6 p-4",children:[e(Wa,{icon:ea,title:"Remise Colis",primaryColor:s,description:"Recherchez par code envoi ou t√©l√©phone destinataire, puis confirmez la remise."}),r("section",{className:"rounded-xl border border-gray-200/80 bg-white p-5 shadow-sm sm:p-6",children:[r("h2",{className:"mb-4 flex items-center gap-2 font-semibold text-gray-800",children:[e(_r,{className:"h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"}}),"Recherche"]}),r("div",{className:"flex flex-col gap-4 sm:flex-row sm:gap-2",children:[r("select",{value:f,onChange:Q=>{b(Q.target.value),u(null),C("")},className:"min-h-[44px] rounded-lg border border-gray-300 bg-white px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-0",style:{"--tw-ring-color":n},children:[e("option",{value:"code",children:"Code envoi"}),e("option",{value:"phone",children:"T√©l. destinataire"})]}),r("div",{className:"flex flex-1 gap-2",children:[e("input",{type:f==="phone"?"tel":"text",value:I,onChange:Q=>C(Q.target.value),placeholder:f==="code"?"Code envoi":"T√©l√©phone destinataire",className:"min-h-[44px] flex-1 rounded-lg border border-gray-300 px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-0",style:{"--tw-ring-color":n}}),e("button",{type:"button",onClick:()=>f==="code"&&I.trim()&&w(I),className:"flex min-h-[44px] items-center justify-center rounded-lg border px-4 py-2.5 transition-colors duration-200",style:{borderColor:"var(--courier-primary, #ea580c)",color:"var(--courier-primary, #ea580c)"},onMouseOver:Q=>{Q.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)",Q.currentTarget.style.color="#fff"},onMouseOut:Q=>{Q.currentTarget.style.backgroundColor="",Q.currentTarget.style.color="var(--courier-primary, #ea580c)"},"aria-label":"Rechercher",children:e(_r,{className:"h-5 w-5"})})]})]})]}),m&&r("div",{className:"flex justify-between rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-800",children:[e("span",{children:m}),e("button",{type:"button",onClick:()=>c(null),className:"min-h-[44px] underline",children:"Fermer"})]}),A&&r("section",{className:"rounded-xl border border-gray-200/80 bg-white p-5 shadow-sm sm:p-6",children:[r("h2",{className:"mb-4 flex items-center gap-2 font-semibold text-gray-800",children:[e(wa,{className:"h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"}}),"D√©tails envoi"]}),r("dl",{className:"grid grid-cols-1 gap-3 text-sm",children:[r("div",{children:[e("dt",{className:"text-gray-500",children:"N¬∞ Envoi"}),e("dd",{className:"font-mono font-medium",children:A.shipmentNumber??A.shipmentId})]}),r("div",{children:[e("dt",{className:"text-gray-500",children:"Destinataire"}),e("dd",{children:((K=A.receiver)==null?void 0:K.name)??"‚Äî"})]}),r("div",{children:[e("dt",{className:"text-gray-500",children:"T√©l."}),e("dd",{children:((B=A.receiver)==null?void 0:B.phone)??"‚Äî"})]}),r("div",{children:[e("dt",{className:"text-gray-500",children:"Exp√©diteur"}),e("dd",{children:((le=A.sender)==null?void 0:le.name)??"‚Äî"})]}),r("div",{children:[e("dt",{className:"text-gray-500",children:"Statut"}),e("dd",{children:A.currentStatus})]}),r("div",{children:[e("dt",{className:"text-gray-500",children:"Frais transport"}),e("dd",{className:"font-medium teliya-monetary",children:g(A.transportFee??0)})]})]}),A.paymentType==="DESTINATION"&&r("div",{className:"mt-4",children:[e("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Montant √† percevoir (destination) FCFA"}),e("input",{type:"number",min:"0",step:"1",value:x,onChange:Q=>h(Q.target.value),className:"min-h-[44px] w-full rounded-lg border border-gray-300 px-3 py-2.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-0",style:{"--tw-ring-color":n},placeholder:"0"})]}),R&&r("button",{type:"button",onClick:N,disabled:L,className:"mt-4 flex w-full items-center justify-center gap-2 rounded-lg px-4 py-3 text-white transition-colors duration-200 disabled:opacity-50 min-h-[48px] sm:w-auto",style:{backgroundColor:"var(--courier-primary, #ea580c)"},onMouseOver:Q=>{L||(Q.currentTarget.style.backgroundColor="var(--courier-secondary, #f97316)")},onMouseOut:Q=>{Q.currentTarget.style.backgroundColor="var(--courier-primary, #ea580c)"},children:[L?e(rt,{className:"h-5 w-5 animate-spin"}):e(va,{className:"h-5 w-5"}),"Confirmer la remise"]}),A.currentStatus!=="READY_FOR_PICKUP"&&A.currentStatus!=="DELIVERED"&&r("p",{className:"mt-3 text-sm text-amber-700",children:["Statut : ",A.currentStatus,". Non remis."]})]}),I.trim()&&!A&&e("p",{className:"text-sm text-gray-500",children:"Aucun envoi trouv√©."})]})}const om=Object.freeze(Object.defineProperty({__proto__:null,default:mu},Symbol.toStringTag,{value:"Module"}));function hu(){var L,E;const{user:a,company:t}=Ke(),i=Lt(t),s=((L=i==null?void 0:i.colors)==null?void 0:L.primary)??"#ea580c";(E=i==null?void 0:i.colors)==null||E.secondary;const n=(a==null?void 0:a.companyId)??"",l=(a==null?void 0:a.agencyId)??"",d=Nt(),[g,f]=o.useState([]),[b,I]=o.useState([]);o.useEffect(()=>{if(!n||!l)return;const m=Br($,n,l),c=Ge(m,w=>{const N=w.docs.map(R=>({id:R.id,...R.data()}));f(N.sort((R,H)=>{var B,le,Q,Z;const M=((le=(B=R.createdAt)==null?void 0:B.toMillis)==null?void 0:le.call(B))??0;return(((Z=(Q=H.createdAt)==null?void 0:Q.toMillis)==null?void 0:Z.call(Q))??0)-M}))});return()=>c()},[n,l]),o.useEffect(()=>{if(!n)return;const m=Te(ia($,n),ae("originAgencyId","==",l)),c=Ge(m,w=>{I(w.docs.map(N=>N.data()))});return()=>c()},[n,l]);const C=m=>b.filter(c=>c.sessionId===m),A=m=>C(m).reduce((c,w)=>c+(w.transportFee??0)+(w.insuranceAmount??0),0),u=m=>C(m).filter(c=>c.currentStatus==="DELIVERED"||c.currentStatus==="CLOSED"),x=m=>u(m).reduce((c,w)=>c+(w.destinationCollectedAmount??0),0),h=m=>A(m)+x(m);return r("div",{className:"mx-auto max-w-4xl space-y-6 p-4",children:[e(Wa,{icon:mr,title:"Rapport Session",primaryColor:s,description:"Synth√®se des sessions et envois : cr√©√©s, livr√©s, totaux origine/destination, √©cart si valid√©."}),e("div",{className:"space-y-6",children:g.map(m=>{const c=C(m.id),w=u(m.id),N=A(m.id),R=x(m.id),H=h(m.id);return r("section",{className:"rounded-xl border border-gray-200/80 bg-white p-5 shadow-sm sm:p-6",children:[r("h2",{className:"mb-4 flex items-center gap-2 text-2xl font-bold",style:{color:"var(--courier-primary, #ea580c)"},children:[e(mr,{className:"h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"},"aria-hidden":!0}),"Session ",m.id.slice(0,8)," ‚Äî ",m.status," ‚Äî Agent ",m.agentCode]}),r("div",{className:"mb-4 grid grid-cols-1 gap-4 xs:grid-cols-2 sm:grid-cols-4",children:[r("div",{className:"flex flex-col rounded-xl border border-gray-100 bg-gray-50/80 p-4 shadow-sm",children:[e(wa,{className:"mb-1 h-5 w-5 text-gray-500","aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase text-gray-500",children:"Envois cr√©√©s"}),e("span",{className:"mt-1 text-2xl font-bold text-gray-800",children:c.length})]}),r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm",style:{borderColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 25%, transparent)",backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 5%, transparent)"},children:[e(Mt,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-primary, #ea580c)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Revenus origine"}),e("span",{className:"mt-1 text-xl font-bold teliya-monetary",children:d(N)})]}),r("div",{className:"flex flex-col rounded-xl border border-gray-100 bg-gray-50/80 p-4 shadow-sm",children:[e(ea,{className:"mb-1 h-5 w-5 text-gray-500","aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase text-gray-500",children:"Envois livr√©s"}),e("span",{className:"mt-1 text-2xl font-bold text-gray-800",children:w.length})]}),r("div",{className:"flex flex-col rounded-xl border p-4 shadow-sm",style:{borderColor:"color-mix(in srgb, var(--courier-secondary, #f97316) 25%, transparent)",backgroundColor:"color-mix(in srgb, var(--courier-secondary, #f97316) 5%, transparent)"},children:[e(_t,{className:"mb-1 h-5 w-5",style:{color:"var(--courier-secondary, #f97316)"},"aria-hidden":!0}),e("span",{className:"text-xs font-medium uppercase",style:{color:"var(--courier-secondary, #f97316)"},children:"Revenus destination"}),e("span",{className:"mt-1 text-xl font-bold teliya-monetary",children:d(R)})]})]}),r("div",{className:"flex flex-wrap items-center gap-2 rounded-xl border-2 py-3 px-4",style:{borderColor:"var(--courier-primary, #ea580c)",backgroundColor:"color-mix(in srgb, var(--courier-primary, #ea580c) 5%, transparent)"},children:[e("span",{className:"font-semibold text-gray-900",children:"Total global :"}),e("span",{className:"text-xl font-bold teliya-monetary",children:d(H)}),m.status==="VALIDATED"&&m.expectedAmount!=null&&r("span",{className:"ml-2 text-sm text-gray-600",children:["Attendu : ",e("span",{className:"teliya-monetary",children:d(m.expectedAmount)})," ‚Äî Diff√©rence : ",e("span",{className:"teliya-monetary",children:d((m.validatedAmount??0)-(m.expectedAmount??0))})]})]}),c.length>0&&r("div",{className:"mt-4 overflow-x-auto rounded-lg border border-gray-200",children:[r("table",{className:"w-full text-sm",children:[e("thead",{children:r("tr",{className:"border-b bg-gray-100 font-semibold text-gray-700",children:[e("th",{className:"p-3 text-left",children:"N¬∞ Envoi"}),e("th",{className:"p-3 text-left",children:"Agent"}),e("th",{className:"p-3 text-left",children:"Nature"}),e("th",{className:"p-3 text-left",children:"Destinataire"}),e("th",{className:"p-3 text-right",children:"Statut"}),e("th",{className:"p-3 text-right",children:"Frais transport"}),e("th",{className:"p-3 text-right",children:"Montant dest."})]})}),e("tbody",{children:c.slice(0,20).map((M,K)=>{var B;return r("tr",{className:`border-b ${K%2===1?"bg-gray-50":""}`,children:[e("td",{className:"p-3 font-mono",children:M.shipmentNumber??M.shipmentId}),e("td",{className:"p-3",children:M.agentCode??"‚Äî"}),e("td",{className:"p-3",children:M.nature??"‚Äî"}),e("td",{className:"p-3",children:((B=M.receiver)==null?void 0:B.name)??"‚Äî"}),e("td",{className:"p-3 text-right",children:M.currentStatus}),e("td",{className:"p-3 text-right teliya-monetary",children:d(M.transportFee??0)}),e("td",{className:"p-3 text-right teliya-monetary",children:d(M.destinationCollectedAmount??0)})]},M.shipmentId)})})]}),c.length>20&&r("p",{className:"mt-1 text-gray-500",children:["‚Ä¶ et ",c.length-20," autres"]})]})]},m.id)})}),g.length===0&&e("div",{className:"rounded-xl border border-gray-200/80 bg-white p-8 text-center text-gray-500 shadow-sm",children:"Aucune session courrier."})]})}const lm=Object.freeze(Object.defineProperty({__proto__:null,default:hu},Symbol.toStringTag,{value:"Module"})),pu={DRAFT:"Brouillon",READY:"Pr√™t au d√©part",DEPARTED:"En route",CLOSED:"Cl√¥tur√©"},gu={DRAFT:"bg-amber-100 text-amber-800 border-amber-200",READY:"bg-blue-100 text-blue-800 border-blue-200",DEPARTED:"bg-violet-100 text-violet-800 border-violet-200",CLOSED:"bg-emerald-100 text-emerald-800 border-emerald-200"};function xn({status:a}){const t=pu[a]??a,i=gu[a]??"bg-gray-100 text-gray-800 border-gray-200";return e("span",{className:`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-medium ${i}`,children:t})}const fu=[{value:"all",label:"Tous"},{value:"IN_TRANSIT",label:"En transit"},{value:"ARRIVED",label:"Arriv√©"},{value:"DELIVERED",label:"Livr√©"}],yu={CREATED:"Cr√©√©",IN_TRANSIT:"En transit",ARRIVED:"Arriv√©",READY_FOR_PICKUP:"Pr√™t √† retirer",DELIVERED:"Livr√©"};function bu(){var Ne,ge;const{user:a,company:t}=Ke(),i=Lt(t),s=((Ne=i==null?void 0:i.colors)==null?void 0:Ne.primary)??"#ea580c",n=(a==null?void 0:a.companyId)??"",l=(a==null?void 0:a.agencyId)??"",d=Array.isArray(a==null?void 0:a.role)?a.role:a!=null&&a.role?[a.role]:[],g=d.includes("chefAgence")||d.includes("admin_compagnie"),f=d[0]??"",[b,I]=o.useState([]),[C,A]=o.useState([]),[u,x]=o.useState([]),[h,L]=o.useState([]),[E,m]=o.useState(null),[c,w]=o.useState(null),[N,R]=o.useState([]),[H,M]=o.useState({}),[K,B]=o.useState(null),[le,Q]=o.useState(""),[Z,j]=o.useState(""),[k,W]=o.useState(""),[q,ye]=o.useState(new Set),[se,Y]=o.useState(null),[ue,T]=o.useState(""),[ce,Ie]=o.useState("all");o.useEffect(()=>{if(!n||!l)return;const p=Ho($,n,l),V=Ge(p,re=>{I(re.docs.map(fe=>({id:fe.id,...fe.data()})))});return()=>V()},[n,l]),o.useEffect(()=>{if(!n||!l)return;const p=Te(ia($,n),ae("originAgencyId","==",l),ae("currentStatus","==","CREATED")),V=Ge(p,re=>{A(re.docs.map(fe=>({...fe.data(),shipmentId:fe.id})))});return()=>V()},[n,l]),o.useEffect(()=>{n&&(Ee(he($,"companies",n,"agences")).then(p=>{x(p.docs.map(V=>({id:V.id,...V.data()})))}),Ee(he($,"companies",n,"fleetVehicles")).then(p=>{L(p.docs.map(V=>({id:V.id,...V.data()})))}))},[n]),o.useEffect(()=>{T(""),Ie("all")},[E]),o.useEffect(()=>{if(!n||!l||!E){w(null),R([]);return}const p=Ko($,n,l,E),V=Ge(p,re=>{if(!re.exists()){w(null),R([]);return}const fe={id:re.id,...re.data()};if(w(fe),fe.shipmentIds.length===0){R([]);return}Promise.all(fe.shipmentIds.map(Ce=>He(Xs($,n,Ce)))).then(Ce=>{R(Ce.filter(Se=>Se.exists()).map(Se=>({...Se.data(),shipmentId:Se.id})))})});return()=>V()},[n,l,E]);const Ve=o.useMemo(()=>{const p={DRAFT:[],READY:[],DEPARTED:[],CLOSED:[]};return b.forEach(V=>{p[V.status]&&p[V.status].push(V)}),p},[b]),Fe=p=>{var V,re;return((V=u.find(fe=>fe.id===p))==null?void 0:V.nomAgence)??((re=u.find(fe=>fe.id===p))==null?void 0:re.nom)??p},te=async p=>{if(p.preventDefault(),!le.trim()||!Z.trim()){B("Cl√© trajet et v√©hicule requis.");return}B(null),M(V=>({...V,create:!0}));try{const V=await Yo({companyId:n,originAgencyId:l,tripKey:le.trim(),vehicleId:Z.trim(),createdBy:a.uid});m(V),Q(""),j("")}catch(V){B(V instanceof Error?V.message:"Erreur cr√©ation lot")}finally{M(V=>({...V,create:!1}))}},Ae=async()=>{if(!(!E||!k.trim())){B(null),M(p=>({...p,add:!0}));try{await el({companyId:n,originAgencyId:l,batchId:E,shipmentId:k.trim(),performedBy:a.uid}),W("")}catch(p){B(p instanceof Error?p.message:"Erreur ajout envoi")}finally{M(p=>({...p,add:!1}))}}},ke=async p=>{if(E){B(null),M(V=>({...V,[p]:!0}));try{await Wo({companyId:n,originAgencyId:l,batchId:E,shipmentId:p})}catch(V){B(V instanceof Error?V.message:"Erreur retrait")}finally{M(V=>({...V,[p]:!1}))}}},Pe=async()=>{if(E){B(null),M(p=>({...p,ready:!0}));try{await Qo({companyId:n,originAgencyId:l,batchId:E})}catch(p){B(p instanceof Error?p.message:"Erreur")}finally{M(p=>({...p,ready:!1}))}}},je=async()=>{if(E){B(null),M(p=>({...p,depart:!0}));try{await Jo({companyId:n,originAgencyId:l,batchId:E,performedBy:a.uid,userRole:f})}catch(p){B(p instanceof Error?p.message:"Erreur d√©part")}finally{M(p=>({...p,depart:!1}))}}},D=async()=>{if(q.size!==0){B(null),M(p=>({...p,escale:!0}));try{await Xo({companyId:n,agencyId:l,shipmentIds:Array.from(q),performedBy:a.uid}),ye(new Set)}catch(p){B(p instanceof Error?p.message:"Erreur arriv√©e escale")}finally{M(p=>({...p,escale:!1}))}}},G=async()=>{if(E){B(null),M(p=>({...p,close:!0}));try{await Zo({companyId:n,originAgencyId:l,batchId:E,userRole:f})}catch(p){B(p instanceof Error?p.message:"Erreur cl√¥ture")}finally{M(p=>({...p,close:!1}))}}},y=o.useMemo(()=>C.filter(p=>!p.batchId&&!(c!=null&&c.shipmentIds.includes(p.shipmentId))),[C,c]),P=o.useMemo(()=>N.filter(p=>p.currentStatus==="IN_TRANSIT"&&p.destinationAgencyId===l),[N,l]),F=o.useMemo(()=>{let p=N;const V=ue.trim().toLowerCase();return V&&(p=p.filter(re=>(re.shipmentNumber??re.shipmentId).toLowerCase().includes(V))),ce!=="all"&&(p=p.filter(re=>re.currentStatus===ce)),p},[N,ue,ce]),z=o.useMemo(()=>{const p=N.length,V=N.filter(Ce=>Ce.currentStatus==="DELIVERED").length,re=N.filter(Ce=>Ce.currentStatus==="IN_TRANSIT").length,fe=N.filter(Ce=>Ce.currentStatus==="ARRIVED"||Ce.currentStatus==="READY_FOR_PICKUP").length;return{total:p,delivered:V,inTransit:re,arrived:fe}},[N]),ee=c?((ge=h.find(p=>p.id===c.vehicleId))==null?void 0:ge.plateNumber)??c.vehicleId:"",ne=async()=>{se==="ready"?await Pe():se==="depart"?await je():se==="close"&&await G(),Y(null)};return r("div",{className:"p-4 max-w-5xl mx-auto space-y-6",children:[e(Wa,{icon:Qn,title:"Lots",primaryColor:s,description:"Cr√©ez des lots, assignez des envois, confirmez le d√©part et les arriv√©es escale.",right:e(En,{to:"/agence/courrier",className:"inline-flex items-center gap-2 rounded-lg border px-4 py-2.5 text-sm",style:{borderColor:s,color:s},children:"Retour"})}),K&&r("div",{className:"p-3 rounded-lg bg-red-50 text-red-800 border border-red-200 text-sm flex justify-between",children:[e("span",{children:K}),e("button",{type:"button",onClick:()=>B(null),className:"underline",children:"Fermer"})]}),r("section",{className:"rounded-xl border bg-white p-4 shadow-sm",children:[r("h2",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e(Ka,{className:"w-5 h-5",style:{color:s}}),"Nouveau lot"]}),r("form",{onSubmit:te,className:"flex flex-wrap gap-3 items-end",children:[r("div",{className:"min-w-[200px]",children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cl√© trajet (dep_arr_heure_date)"}),e("input",{type:"text",value:le,onChange:p=>Q(p.target.value),placeholder:"Bamako_Segou_08:00_2025-02-22",className:"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm"})]}),r("div",{className:"min-w-[140px]",children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"V√©hicule"}),r("select",{value:Z,onChange:p=>j(p.target.value),className:"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm",children:[e("option",{value:"",children:"‚Äî"}),h.map(p=>e("option",{value:p.id,children:p.plateNumber??p.id},p.id))]})]}),r("button",{type:"submit",disabled:H.create,className:"w-full sm:w-auto min-h-[48px] rounded-lg px-4 py-2.5 text-white text-sm font-medium disabled:opacity-50 flex items-center justify-center gap-2",style:{backgroundColor:s},children:[H.create?e(rt,{className:"w-4 h-4 animate-spin"}):e(Ka,{className:"w-4 h-4"}),"Cr√©er lot"]})]})]}),e("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:["DRAFT","READY","DEPARTED","CLOSED"].map(p=>r("section",{className:"rounded-xl border bg-white p-4 shadow-sm",children:[r("h3",{className:"font-semibold text-gray-800 mb-2 flex items-center gap-2",children:[e(Qn,{className:"w-4 h-4 shrink-0",style:{color:s}}),e(xn,{status:p})]}),r("ul",{className:"space-y-2",children:[Ve[p].length===0&&e("li",{className:"text-sm text-gray-500",children:"Aucun"}),Ve[p].map(V=>e("li",{children:r("button",{type:"button",onClick:()=>m(V.id),className:`w-full text-left rounded-lg border px-3 py-2 text-sm transition min-h-[44px] ${E===V.id?"ring-2":"border-gray-200 hover:border-gray-300"}`,style:E===V.id?{borderColor:s,boxShadow:`0 0 0 2px ${s}`}:{},children:[r("span",{className:"font-mono text-xs block truncate",children:[V.tripKey.slice(0,20),"‚Ä¶"]}),r("span",{className:"flex items-center justify-between gap-2 mt-1",children:[r("span",{className:"text-gray-600",children:[V.shipmentIds.length," envoi(s)"]}),e(xn,{status:V.status})]})]})},V.id))]})]},p))}),c&&r("section",{className:"rounded-xl border bg-white p-4 shadow-sm space-y-4",children:[r("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-4 grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3 text-sm",children:[r("div",{children:[e("span",{className:"text-gray-500 block",children:"V√©hicule"}),e("span",{className:"font-medium text-gray-900",children:ee||"‚Äî"})]}),r("div",{className:"col-span-2",children:[e("span",{className:"text-gray-500 block",children:"Cl√© trajet"}),e("span",{className:"font-mono text-gray-900 break-all",children:c.tripKey})]}),r("div",{children:[e("span",{className:"text-gray-500 block",children:"Total envois"}),e("span",{className:"font-medium text-gray-900",children:z.total})]}),r("div",{children:[e("span",{className:"text-gray-500 block",children:"En transit"}),e("span",{className:"font-medium text-gray-900",children:z.inTransit})]}),r("div",{children:[e("span",{className:"text-gray-500 block",children:"Arriv√©s"}),e("span",{className:"font-medium text-gray-900",children:z.arrived})]}),r("div",{children:[e("span",{className:"text-gray-500 block",children:"Livr√©s"}),e("span",{className:"font-medium text-gray-900",children:z.delivered})]}),e("div",{className:"col-span-2 sm:col-span-4 lg:col-span-1 flex items-end",children:e(xn,{status:c.status})})]}),r("div",{className:"flex flex-col sm:flex-row gap-2",children:[e("input",{type:"search",placeholder:"Rechercher par N¬∞ envoi...",value:ue,onChange:p=>T(p.target.value),className:"rounded-lg border border-gray-300 px-3 py-2 text-sm w-full sm:max-w-xs"}),e("select",{value:ce,onChange:p=>Ie(p.target.value),className:"rounded-lg border border-gray-300 px-3 py-2 text-sm w-full sm:w-auto",children:fu.map(p=>e("option",{value:p.value,children:p.label},p.value))})]}),e("div",{className:"overflow-x-auto",children:r("table",{className:"w-full text-sm min-w-[600px]",children:[e("thead",{children:r("tr",{className:"border-b text-left text-gray-600",children:[e("th",{className:"p-2",children:"N¬∞ Envoi"}),e("th",{className:"p-2",children:"Destination"}),e("th",{className:"p-2",children:"Statut"}),e("th",{className:"p-2",children:"Position actuelle"}),c.status==="DRAFT"&&e("th",{className:"p-2"}),c.status==="DEPARTED"&&P.length>0&&e("th",{className:"p-2",children:"Arriv√©e escale"})]})}),e("tbody",{children:F.map(p=>r("tr",{className:"border-b",children:[e("td",{className:"p-2 font-mono",children:p.shipmentNumber??p.shipmentId}),e("td",{className:"p-2",children:Fe(p.destinationAgencyId)}),e("td",{className:"p-2",children:yu[p.currentStatus]??p.currentStatus}),e("td",{className:"p-2",children:p.currentLocationAgencyId?Fe(p.currentLocationAgencyId):"‚Äî"}),c.status==="DRAFT"&&e("td",{className:"p-2",children:e("button",{type:"button",onClick:()=>ke(p.shipmentId),disabled:H[p.shipmentId],className:"text-red-600 hover:underline text-xs",children:H[p.shipmentId]?e(rt,{className:"w-3 h-3 animate-spin inline"}):e(Ia,{className:"w-3 h-3 inline"})})}),c.status==="DEPARTED"&&P.length>0&&e("td",{className:"p-2",children:p.currentStatus==="IN_TRANSIT"&&p.destinationAgencyId===l&&r("label",{className:"flex items-center gap-1",children:[e("input",{type:"checkbox",checked:q.has(p.shipmentId),onChange:V=>ye(re=>{const fe=new Set(re);return V.target.checked?fe.add(p.shipmentId):fe.delete(p.shipmentId),fe})}),"Ici"]})})]},p.shipmentId))})]})}),c.status==="DRAFT"&&r("div",{className:"mt-4 flex flex-col sm:flex-row flex-wrap gap-2 items-stretch sm:items-end",children:[r("select",{value:k,onChange:p=>W(p.target.value),className:"rounded-lg border border-gray-300 px-3 py-2.5 text-sm min-h-[48px] w-full sm:min-w-[180px] sm:w-auto",children:[e("option",{value:"",children:"‚Äî Ajouter un envoi ‚Äî"}),y.map(p=>r("option",{value:p.shipmentId,children:[p.shipmentNumber??p.shipmentId," ‚Üí ",Fe(p.destinationAgencyId)]},p.shipmentId))]}),e("button",{type:"button",onClick:Ae,disabled:!k.trim()||H.add,className:"w-full sm:w-auto min-h-[48px] rounded-lg px-4 py-2.5 text-white text-sm font-medium disabled:opacity-50 flex items-center justify-center gap-2",style:{backgroundColor:s},children:H.add?e(rt,{className:"w-4 h-4 animate-spin"}):"Ajouter"})]}),c.status==="DRAFT"&&c.shipmentIds.length>0&&e("div",{className:"mt-3",children:r("button",{type:"button",onClick:()=>Y("ready"),disabled:H.ready,className:"w-full sm:w-auto min-h-[48px] rounded-lg px-4 py-2.5 text-white text-sm font-medium disabled:opacity-50 flex items-center justify-center gap-2",style:{backgroundColor:s},children:[H.ready?e(rt,{className:"w-4 h-4 animate-spin"}):e(va,{className:"w-4 h-4"}),"Marquer pr√™t"]})}),c.status==="READY"&&g&&e("div",{className:"mt-3",children:r("button",{type:"button",onClick:()=>Y("depart"),disabled:H.depart,className:"w-full sm:w-auto min-h-[48px] rounded-lg px-4 py-2.5 text-white text-sm font-medium disabled:opacity-50 flex items-center justify-center gap-2",style:{backgroundColor:s},children:[H.depart?e(rt,{className:"w-4 h-4 animate-spin"}):e(ea,{className:"w-4 h-4"}),"Confirmer d√©part"]})}),c.status==="DEPARTED"&&P.length>0&&e("div",{className:"mt-3 flex flex-wrap gap-2 items-center",children:r("button",{type:"button",onClick:D,disabled:q.size===0||H.escale,className:"w-full sm:w-auto min-h-[48px] rounded-lg px-4 py-2.5 text-white text-sm font-medium disabled:opacity-50 flex items-center justify-center gap-2",style:{backgroundColor:s},children:[H.escale?e(rt,{className:"w-4 h-4 animate-spin"}):e(Ca,{className:"w-4 h-4"}),"Confirmer arriv√©e escale (",q.size,")"]})}),c.status==="DEPARTED"&&g&&e("div",{className:"mt-3",children:e("button",{type:"button",onClick:()=>Y("close"),disabled:H.close,className:"w-full sm:w-auto min-h-[48px] rounded-lg px-4 py-2.5 border border-gray-300 text-gray-700 text-sm font-medium disabled:opacity-50 flex items-center justify-center gap-2",children:H.close?e(rt,{className:"w-4 h-4 animate-spin"}):"Cl√¥turer le lot"})})]}),se!==null&&e("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-title",children:r("div",{className:"bg-white rounded-xl shadow-xl max-w-sm w-full p-6 space-y-4",children:[e("h2",{id:"confirm-title",className:"text-lg font-semibold text-gray-900",children:"Confirmer l'action"}),e("p",{className:"text-sm text-gray-600",children:"Cette action est irr√©versible. Voulez-vous continuer ?"}),r("div",{className:"flex flex-col-reverse sm:flex-row gap-2 sm:justify-end",children:[e("button",{type:"button",onClick:()=>Y(null),className:"min-h-[48px] w-full sm:w-auto rounded-lg px-4 py-2.5 border border-gray-300 text-gray-700 text-sm font-medium",children:"Annuler"}),r("button",{type:"button",onClick:()=>ne(),disabled:H.ready||H.depart||H.close,className:"min-h-[48px] w-full sm:w-auto rounded-lg px-4 py-2.5 text-white text-sm font-medium disabled:opacity-50 flex items-center justify-center gap-2",style:{backgroundColor:s},children:[H.ready||H.depart||H.close?e(rt,{className:"w-4 h-4 animate-spin"}):null,"Confirmer"]})]})]})})]})}const cm=Object.freeze(Object.defineProperty({__proto__:null,default:bu},Symbol.toStringTag,{value:"Module"}));export{Gu as $,Pn as A,pt as B,ei as C,rl as D,ql as E,Pl as F,yl as G,Mu as H,_n as I,Er as J,al as K,Du as L,Tu as M,Iu as N,ul as O,gl as P,ku as Q,Ru as R,tt as S,Lu as T,Pu as U,Fu as V,ju as W,Ou as X,Vu as Y,qu as Z,Bu as _,kl as a,Uu as a0,zu as a1,Hu as a2,Ku as a3,Yu as a4,Wu as a5,Xu as a6,Qu as a7,Ju as a8,Zu as a9,em as aa,tm as ab,am as ac,rm as ad,nm as ae,sm as af,im as ag,om as ah,lm as ai,cm as aj,Ke as b,_u as c,$ as d,Lt as e,br as f,Gr as g,as as h,Ln as i,Ml as j,ti as k,Zs as l,ml as m,Ot as n,ai as o,wl as p,Il as q,$u as r,lr as s,Qe as t,Nt as u,Pr as v,fl as w,ri as x,Ba as y,Eu as z};
