import{r as y,a as i,j as a,F as G}from"./react-DB_4kGOy.js";import{x as $,z as V,o as x,P as ne,Q as ce,E as re,T as P,F as ie,q,C as S,G as K,e as le,V as de,w as ue,J as pe,y as M,H as L}from"./firebase-lLzYRzUk.js";import{u as me,d,a as ye}from"../index-Bkmir__O.js";import"./vendor-C-DAJou6.js";async function H(e){const{companyId:u,agencyId:l,role:p}=e;if(p==="guichetier"){const f=x(d,"companies",u,"agences",l,"counters","guichetier"),E=await L(d,async g=>{const C=await g.get(f),N=(C.exists()&&C.data().lastSeq||0)+1;return g.set(f,{lastSeq:N,updatedAt:P.now()},{merge:!0}),N});return"G"+String(E).padStart(3,"0")}if(p==="comptable"){const f=x(d,"companies",u,"agences",l,"counters","comptable"),E=await L(d,async g=>{const C=await g.get(f),N=(C.exists()&&C.data().lastSeq||0)+1;return g.set(f,{lastSeq:N,updatedAt:P.now()},{merge:!0}),N});return"ACC"+String(E).padStart(3,"0")}}async function O(e,u){const l=$(d,"users");return!(await V(ue(l,M("companyId","==",e),M("agencyId","==",u),M("role","==","comptable"),pe(1)))).empty}async function fe(e,u,l){if(!l||!l.companyId||!l.agencyId||!["guichetier","comptable"].includes(l.role)||l.staffCode)return;const p=await H({companyId:l.companyId,agencyId:l.agencyId,role:l.role});if(!p)return;await S(e,{staffCode:p,codeCourt:p}),(await q(u)).exists()&&await S(u,{staffCode:p,codeCourt:p})}const we=()=>{const{user:e,company:u}=me(),[l,p]=y.useState([]),[f,E]=y.useState(""),[g,C]=y.useState(""),[R,N]=y.useState(""),[A,z]=y.useState("guichetier"),[j,B]=y.useState(""),[J,m]=y.useState(""),[k,w]=y.useState(!1),[D,Q]=y.useState(null),[T,X]=y.useState(""),[F,Y]=y.useState(""),[I,Z]=y.useState("guichetier"),v=y.useMemo(()=>({primary:(u==null?void 0:u.couleurPrimaire)||"#ef6c00",secondary:(u==null?void 0:u.couleurSecondaire)||"#ffb74d"}),[u]),U=async()=>{if(!(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)))try{const t=$(d,"companies",e.companyId,"agences",e.agencyId,"users"),s=(await V(t)).docs.map(o=>({id:o.id,...o.data()})),r=s.filter(o=>(o.role==="guichetier"||o.role==="comptable")&&!o.staffCode);for(const o of r){const n=x(d,"companies",o.companyId,"agences",o.agencyId,"users",o.id),h=x(d,"users",o.uid);await fe(n,h,o)}if(r.length>0){const n=(await V(t)).docs.map(h=>({id:h.id,...h.data()}));p(n.sort((h,b)=>h.displayName.localeCompare(b.displayName)))}else p(s.sort((o,n)=>o.displayName.localeCompare(n.displayName)))}catch(t){console.error("loadAgents err:",t),m("❌ Erreur lors du chargement des agents.")}};y.useEffect(()=>{U()},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId]);const _=()=>{E(""),C(""),N(""),B(""),z("guichetier")},ee=async()=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)){m("⚠️ Contexte agence/compagnie manquant.");return}if(!f||!j||!g){m("⚠️ Nom, email et mot de passe sont obligatoires.");return}if(j.length<6){m("⚠️ Mot de passe: minimum 6 caractères.");return}w(!0),m("");try{if(A==="comptable"&&await O(e.companyId,e.agencyId)){w(!1),m("⚠️ Il existe déjà un comptable pour cette agence.");return}const t=await ne(ye,f,j);await ce(t.user,{displayName:g});const c=t.user.uid;let s;(A==="guichetier"||A==="comptable")&&(s=await H({companyId:e.companyId,agencyId:e.agencyId,role:A}));const r=x(d,"users",c);await re(r,{uid:c,email:f,displayName:g,telephone:R||"",role:A,active:!0,companyId:e.companyId,agencyId:e.agencyId,agencyName:(e==null?void 0:e.agencyName)||"",createdAt:P.now(),...s?{staffCode:s,codeCourt:s}:{}},{merge:!0});const o=await ie($(d,"companies",e.companyId,"agences",e.agencyId,"users"),{uid:c,email:f,displayName:g,telephone:R||"",role:A,active:!0,companyId:e.companyId,agencyId:e.agencyId,agencyName:(e==null?void 0:e.agencyName)||"",createdAt:P.now(),...s?{staffCode:s,codeCourt:s}:{}});m("✅ Agent ajouté avec succès."),_(),await U()}catch(t){console.error("handleAdd err:",t),(t==null?void 0:t.code)==="auth/email-already-in-use"?m("⚠️ Cet email est déjà utilisé."):m("❌ Ajout impossible. Voir la console.")}finally{w(!1)}},te=t=>window.confirm(t),W=async(t,c)=>{if(!(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!t.id)){w(!0);try{const s=x(d,"companies",e.companyId,"agences",e.agencyId,"users",t.id);if(await S(s,{active:c}),t.uid){const r=x(d,"users",t.uid);await S(r,{active:c})}p(r=>r.map(o=>o.id===t.id?{...o,active:c}:o))}catch(s){console.error("toggleActive err:",s),m("❌ Erreur lors du changement de statut.")}finally{w(!1)}}},ae=async()=>{if(!(!D||!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))){w(!0);try{const t=x(d,"companies",e.companyId,"agences",e.agencyId,"users",D),c=await q(t),s=c.exists()?c.data():null;if(!s)throw new Error("Agent introuvable.");if(I==="comptable"&&s.role!=="comptable"&&await O(e.companyId,e.agencyId)){w(!1),m("⚠️ Il existe déjà un comptable pour cette agence.");return}await S(t,{displayName:T,telephone:F,role:I});const r=s.uid;if(r){const h=x(d,"users",r);if(await S(h,{displayName:T,telephone:F,role:I}),(I==="guichetier"||I==="comptable")&&!s.staffCode){const b=await H({companyId:e.companyId,agencyId:e.agencyId,role:I});b&&(await S(t,{staffCode:b,codeCourt:b}),await S(h,{staffCode:b,codeCourt:b}))}}const o=await q(t),n=o.exists()?{id:D,...o.data()}:null;p(h=>h.map(b=>b.id===D?{...b,displayName:(n==null?void 0:n.displayName)||T,telephone:(n==null?void 0:n.telephone)||F,role:(n==null?void 0:n.role)||I,staffCode:n==null?void 0:n.staffCode,codeCourt:n==null?void 0:n.codeCourt}:b)),Q(null)}catch(t){console.error("edit save err:",t),m("❌ Erreur lors de la modification.")}finally{w(!1)}}},oe=async t=>{if(!(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!t.id||!te(`Supprimer définitivement "${t.displayName}" ?
Cette action effacera aussi son compte d'authentification.`))){w(!0),m("");try{const s=x(d,"companies",e.companyId,"agences",e.agencyId,"users",t.id);if(await K(s),t.uid){const r=x(d,"users",t.uid);(await q(r)).exists()&&await K(r)}if(t.uid){const r=le();await de(r,"adminDeleteUser")({uid:t.uid})}p(r=>r.filter(o=>o.id!==t.id)),m("✅ Agent supprimé partout.")}catch(s){console.error("delete err:",s),m("❌ Suppression partielle. Vérifie la console et la Cloud Function.")}finally{w(!1)}}};function se(t){throw new Error("Function not implemented.")}return i("div",{className:"p-6 max-w-5xl mx-auto min-h-screen",style:{background:"#f7f7fb"},children:[a("h1",{className:"text-3xl font-extrabold mb-6",style:{color:v.primary},children:"Gestion du personnel (Agence)"}),i("div",{className:"mb-8 bg-white p-6 rounded-xl shadow-md border",style:{borderColor:v.secondary},children:[a("h2",{className:"text-lg font-semibold mb-4",style:{color:v.secondary},children:"Ajouter un agent"}),i("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[a("input",{value:g,onChange:t=>C(t.target.value),placeholder:"Nom complet",className:"border p-3 rounded focus:ring-2"}),a("input",{value:f,onChange:t=>E(t.target.value),placeholder:"Email",type:"email",className:"border p-3 rounded focus:ring-2"}),a("input",{value:R,onChange:t=>N(t.target.value),placeholder:"Téléphone (optionnel)",className:"border p-3 rounded focus:ring-2"}),i("select",{value:A,onChange:t=>z(t.target.value),className:"border p-3 rounded focus:ring-2",children:[a("option",{value:"guichetier",children:"Guichetier"}),a("option",{value:"controleur",children:"Contrôleur"}),a("option",{value:"comptable",children:"Comptable"}),a("option",{value:"chefAgence",children:"Chef d’agence"})]}),a("input",{value:j,onChange:t=>B(t.target.value),placeholder:"Mot de passe",type:"password",className:"border p-3 rounded focus:ring-2 md:col-span-2"})]}),a("button",{onClick:ee,disabled:k,className:"w-full py-3 rounded font-semibold text-white transition disabled:opacity-60",style:{background:`linear-gradient(to right, ${v.primary}, ${v.secondary})`},children:k?"⏳ Traitement...":"Ajouter l’agent"}),J&&a("p",{className:"mt-3 text-center text-sm text-gray-700",children:J})]}),i("div",{className:"bg-white rounded-xl shadow-md border",style:{borderColor:v.secondary},children:[a("div",{className:"p-4 border-b",style:{borderColor:v.secondary},children:a("h2",{className:"text-lg font-semibold",style:{color:v.secondary},children:"Agents de cette agence"})}),l.length===0?a("p",{className:"p-6 text-gray-500",children:"Aucun agent enregistré."}):a("div",{className:"divide-y",children:l.map(t=>i("div",{className:"p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[a("div",{children:D===t.id?i("div",{className:"grid grid-cols-1 sm:grid-cols-5 gap-2",children:[a("input",{value:T,onChange:c=>X(c.target.value),className:"border p-2 rounded"}),a("input",{value:F,onChange:c=>Y(c.target.value),placeholder:"Téléphone",className:"border p-2 rounded"}),i("select",{value:I,onChange:c=>Z(c.target.value),className:"border p-2 rounded",children:[a("option",{value:"guichetier",children:"Guichetier"}),a("option",{value:"controleur",children:"Contrôleur"}),a("option",{value:"comptable",children:"Comptable"}),a("option",{value:"chefAgence",children:"Chef d’agence"})]}),i("div",{className:"text-sm text-gray-500 flex items-center",children:["Code: ",a("span",{className:"font-mono",children:t.staffCode||"—"})]}),i("div",{className:"text-xs text-gray-500 flex items-center",children:["Statut: ",a("span",{className:t.active?"text-green-600":"text-red-600",children:t.active?"Actif":"Désactivé"})]})]}):i(G,{children:[i("p",{className:"font-semibold text-gray-900",children:[t.displayName," ",i("span",{className:"text-gray-500 text-sm",children:["• ",t.role]}),(t.role==="guichetier"||t.role==="comptable")&&a("span",{className:"ml-2 px-2 py-0.5 rounded bg-gray-100 font-mono text-xs",children:t.staffCode||"—"})]}),i("p",{className:"text-sm text-gray-600",children:[t.email,t.telephone?` • ${t.telephone}`:""]}),i("p",{className:"text-xs",children:["Statut :"," ",a("span",{className:t.active?"text-green-600":"text-red-600",children:t.active?"Actif":"Désactivé"})]})]})}),a("div",{className:"flex flex-wrap gap-2",children:D===t.id?i(G,{children:[a("button",{onClick:ae,disabled:k,className:"px-3 py-1 rounded text-white",style:{background:v.primary},children:"Enregistrer"}),a("button",{onClick:()=>Q(null),className:"px-3 py-1 rounded border",children:"Annuler"})]}):i(G,{children:[a("button",{onClick:()=>se(),className:"px-3 py-1 rounded border",children:"Modifier"}),t.active?a("button",{onClick:()=>W(t,!1),disabled:k,className:"px-3 py-1 rounded text-white",style:{background:"#b45309"},children:"Désactiver"}):a("button",{onClick:()=>W(t,!0),disabled:k,className:"px-3 py-1 rounded text-white",style:{background:"#16a34a"},children:"Activer"}),a("button",{onClick:()=>oe(t),disabled:k,className:"px-3 py-1 rounded text-white",style:{background:"#dc2626"},children:"Supprimer"})]})})]},t.id))})]})]})};export{we as default};
