import{o as I,H as E,T as b,t as w,q as m,v as L,r as N,G as F,w as _,u as O,x as a,W as U}from"./firebase-CURBI7X6.js";import{d as i}from"./agence-Bsj2lp2X.js";const q="agentCourrier",G="C",Y=3;async function X(e){const{companyId:t,agencyId:n}=e,o=I(i,"companies",t,"agences",n,"counters",q),s=await E(i,async c=>{var y;const r=await c.get(o),u=(r.exists()?((y=r.data())==null?void 0:y.lastSeq)??0:0)+1;return c.set(o,{lastSeq:u,updatedAt:b.now()},{merge:!0}),u});return G+String(s).padStart(Y,"0")}const P="courierSessions";function B(e,t,n){return w(e,"companies",t,"agences",n,P)}function R(e,t,n,o){return I(e,"companies",t,"agences",n,P,o)}const p="logistics",C="data";function V(e,t){return w(e,"companies",t,p,C,"shipments")}function A(e,t,n){return I(e,"companies",t,p,C,"shipments",n)}function g(e,t){return w(e,"companies",t,p,C,"events")}function K(e,t){return w(e,"companies",t,p,C,"ledger")}function M(e,t,n){return w(e,"companies",t,"agences",n,"batches")}function S(e,t,n,o){return I(e,"companies",t,"agences",n,"batches",o)}const $=["PENDING","ACTIVE"];async function k(e,t,n){const o=B(i,e,t),s=N(o,_("agentId","==",n),F(20)),r=(await O(s)).docs.filter(d=>$.includes(d.data().status)).sort((d,u)=>{var h,D,f,v;const y=((D=(h=d.data().createdAt)==null?void 0:h.toMillis)==null?void 0:D.call(h))??0;return(((v=(f=u.data().createdAt)==null?void 0:f.toMillis)==null?void 0:v.call(f))??0)-y});return r.length>0?r[0].id:null}async function Z(e){const t=await k(e.companyId,e.agencyId,e.agentId);if(t)return t;const n=B(i,e.companyId,e.agencyId),o=I(n),s=o.id;return await L(o,{sessionId:s,companyId:e.companyId,agencyId:e.agencyId,agentId:e.agentId,agentCode:e.agentCode,status:"PENDING",openedAt:null,closedAt:null,validatedAt:null,expectedAmount:0,validatedAmount:null,difference:null,createdAt:a(),updatedAt:a()}),s}async function ee(e){const t=R(i,e.companyId,e.agencyId,e.sessionId),n=await m(t);if(!n.exists())throw new Error("Session courrier introuvable.");if(n.data().status!=="PENDING")throw new Error("Seule une session en attente peut être activée.");await E(i,async s=>{const c=await s.get(t);if(!c.exists())throw new Error("Session courrier introuvable.");if(c.data().status!=="PENDING")throw new Error("Seule une session en attente peut être activée.");const r=a();s.update(t,{status:"ACTIVE",openedAt:r,activatedBy:{id:e.activatedBy.id,name:e.activatedBy.name??null},updatedAt:r})})}async function te(e){const t=R(i,e.companyId,e.agencyId,e.sessionId),n=V(i,e.companyId),o=N(n,_("sessionId","==",e.sessionId)),s=await O(o);let c=0;return s.docs.forEach(r=>{const d=r.data();c+=Number(d.transportFee??0)+Number(d.insuranceAmount??0)}),await E(i,async r=>{const d=await r.get(t);if(!d.exists())throw new Error("Session courrier introuvable.");if(d.data().status!=="ACTIVE")throw new Error("La session doit être ACTIVE pour être clôturée.");r.update(t,{status:"CLOSED",closedAt:a(),expectedAmount:c,updatedAt:a()})}),{expectedAmount:c}}async function ne(e){const t=R(i,e.companyId,e.agencyId,e.sessionId),n=await m(t);if(!n.exists())throw new Error("Session courrier introuvable.");const o=n.data();if(o.status!=="CLOSED")throw new Error("La session doit être CLOSED pour être validée.");const s=Number(o.expectedAmount??0),c=e.validatedAmount-s;return await E(i,async r=>{const d=await r.get(t);if(!d.exists())throw new Error("Session courrier introuvable.");if(d.data().status!=="CLOSED")throw new Error("La session doit être CLOSED pour être validée.");r.update(t,{status:"VALIDATED",validatedAt:a(),validatedAmount:e.validatedAmount,difference:c,validatedBy:{id:e.validatedBy.id,name:e.validatedBy.name??null},updatedAt:a()})}),{difference:c}}const W=5;async function oe(e){const t=e.shipmentId??I(V(i,e.companyId)).id;let n;return await E(i,async o=>{var y;if(e.sessionId){const l=R(i,e.companyId,e.originAgencyId,e.sessionId),h=await o.get(l);if(!h.exists())throw new Error("Session courrier introuvable.");if(h.data().status!=="ACTIVE")throw new Error("La session courrier doit être ACTIVE pour créer un envoi.")}if(e.companyCode!=null&&e.agencyCode!=null&&e.agentCode!=null){const l=I(i,"companies",e.companyId,"agences",e.originAgencyId,"counters","shipmentSeq"),h=await o.get(l),f=(h.exists()?((y=h.data())==null?void 0:y.lastSeq)??0:0)+1;o.set(l,{lastSeq:f,updatedAt:b.now()},{merge:!0}),n=`${e.companyCode}-${e.agencyCode}-${e.agentCode}-${String(f).padStart(W,"0")}`}const s=A(i,e.companyId,t);if((await o.get(s)).exists())throw new Error("Un envoi existe déjà avec cet id.");o.set(s,{shipmentId:t,...n!=null&&{shipmentNumber:n},originAgencyId:e.originAgencyId,destinationAgencyId:e.destinationAgencyId,sender:e.sender,receiver:e.receiver,nature:e.nature??"",declaredValue:e.declaredValue,insuranceRate:e.insuranceRate,insuranceAmount:e.insuranceAmount,transportFee:e.transportFee,paymentType:e.paymentType,paymentStatus:e.paymentStatus,currentStatus:"CREATED",currentAgencyId:e.originAgencyId,currentLocationAgencyId:e.originAgencyId,batchId:void 0,vehicleId:void 0,createdAt:a(),createdBy:e.createdBy,...e.sessionId!=null&&{sessionId:e.sessionId},...e.agentCode!=null&&{agentCode:e.agentCode}});const r=g(i,e.companyId),d=I(r),u={shipmentId:t,eventType:"CREATED",agencyId:e.originAgencyId,performedBy:e.createdBy,performedAt:a()};o.set(d,u)}),{shipmentId:t,shipmentNumber:n}}const H=["REFUND","ADJUSTMENT"];async function ie(e){let t="";return await E(i,async n=>{const o=R(i,e.companyId,e.agencyId,e.sessionId),s=await n.get(o);if(!s.exists())throw new Error("Session courrier introuvable.");const c=s.data();if(c.status!=="ACTIVE")throw new Error(`La session doit être ACTIVE pour enregistrer une entrée (actuel: ${c.status}).`);const r=Number(e.amount);if(r<0&&!H.includes(e.type))throw new Error("Les montants négatifs sont autorisés uniquement pour REFUND ou ADJUSTMENT.");const d=K(i,e.companyId),u=I(d);t=u.id;const y={entryId:t,sessionId:e.sessionId,shipmentId:e.shipmentId,agencyId:e.agencyId,agentId:e.agentId,type:e.type,amount:r,createdAt:a()};n.set(u,y)}),t}const j={CREATED:["STORED","CANCELLED","ARRIVED"],STORED:["ASSIGNED","CANCELLED"],ASSIGNED:["IN_TRANSIT"],IN_TRANSIT:["ARRIVED","LOST"],ARRIVED:["READY_FOR_PICKUP"],READY_FOR_PICKUP:["DELIVERED","RETURNED"],DELIVERED:["CLOSED"],CLOSED:[],CANCELLED:[],LOST:["CLAIM_PENDING"],CLAIM_PENDING:["CLAIM_PAID"],CLAIM_PAID:[],RETURNED:[]};function T(e,t){const n=j[e];return n?n.includes(t):!1}async function se(e){await E(i,async t=>{const n=A(i,e.companyId,e.shipmentId),o=await t.get(n);if(!o.exists())throw new Error("Envoi introuvable.");const s=o.data();if(s.destinationAgencyId!==e.agencyId)throw new Error("Cet envoi ne peut être marqué arrivé que par l'agence de destination.");const c=s.currentStatus;if(c!=="CREATED"&&c!=="IN_TRANSIT")throw new Error(`Envoi en statut ${c}. Seuls CREATED ou IN_TRANSIT peuvent être marqués arrivés (simulation Phase 1).`);if(!T(c,"ARRIVED"))throw new Error("Transition non autorisée.");t.update(n,{currentStatus:"ARRIVED",currentAgencyId:e.agencyId});const r=g(i,e.companyId),d=I(r),u={shipmentId:e.shipmentId,eventType:"ARRIVED",agencyId:e.agencyId,performedBy:e.performedBy,performedAt:a()};t.set(d,u)})}async function ce(e){await E(i,async t=>{const n=A(i,e.companyId,e.shipmentId),o=await t.get(n);if(!o.exists())throw new Error("Envoi introuvable.");const s=o.data();if(s.currentStatus!=="ARRIVED")throw new Error(`Envoi doit être ARRIVED (actuel: ${s.currentStatus}).`);if(!T("ARRIVED","READY_FOR_PICKUP"))throw new Error("Transition ARRIVED → READY_FOR_PICKUP non autorisée.");t.update(n,{currentStatus:"READY_FOR_PICKUP",currentAgencyId:e.agencyId});const c=g(i,e.companyId),r=I(c),d={shipmentId:e.shipmentId,eventType:"READY_FOR_PICKUP",agencyId:e.agencyId,performedBy:e.performedBy,performedAt:a()};t.set(r,d)})}async function re(e){await E(i,async t=>{const n=A(i,e.companyId,e.shipmentId),o=await t.get(n);if(!o.exists())throw new Error("Envoi introuvable.");const s=o.data();if(s.currentStatus!=="READY_FOR_PICKUP")throw new Error(`Envoi doit être READY_FOR_PICKUP (actuel: ${s.currentStatus}).`);if(!T("READY_FOR_PICKUP","DELIVERED"))throw new Error("Transition READY_FOR_PICKUP → DELIVERED non autorisée.");const c={currentStatus:"DELIVERED",currentAgencyId:e.agencyId};e.destinationCollectedAmount!=null&&e.destinationCollectedAmount>=0&&(c.destinationCollectedAmount=e.destinationCollectedAmount),t.update(n,c);const r=g(i,e.companyId),d=I(r),u={shipmentId:e.shipmentId,eventType:"DELIVERED",agencyId:e.agencyId,performedBy:e.performedBy,performedAt:a()};t.set(d,u)})}async function de(e){const t=I(M(i,e.companyId,e.originAgencyId)),n=t.id,o={batchId:n,originAgencyId:e.originAgencyId,tripKey:e.tripKey,vehicleId:e.vehicleId,shipmentIds:[],status:"DRAFT",createdBy:e.createdBy,createdAt:a()};return await L(t,o),n}async function ae(e){await E(i,async t=>{const n=S(i,e.companyId,e.originAgencyId,e.batchId),o=A(i,e.companyId,e.shipmentId),s=await t.get(n),c=await t.get(o);if(!s.exists())throw new Error("Batch not found");if(!c.exists())throw new Error("Shipment not found");const r=s.data(),d=c.data();if(r.status!=="DRAFT")throw new Error("Batch must be DRAFT");if(d.currentStatus!=="CREATED")throw new Error("Shipment must be CREATED");if(d.originAgencyId!==r.originAgencyId)throw new Error("Shipment does not belong to this agency.");if(d.batchId!=null&&d.batchId!==e.batchId)throw new Error("Shipment in another batch");if(r.shipmentIds.includes(e.shipmentId))throw new Error("Already in batch");const u=r.shipmentIds.concat(e.shipmentId);t.update(n,{shipmentIds:u}),t.update(o,{batchId:e.batchId});const y=I(g(i,e.companyId));t.set(y,{shipmentId:e.shipmentId,eventType:"ASSIGNED_TO_BATCH",agencyId:e.originAgencyId,performedBy:e.performedBy,performedAt:a()})})}async function ue(e){await E(i,async t=>{const n=S(i,e.companyId,e.originAgencyId,e.batchId),o=A(i,e.companyId,e.shipmentId),s=await t.get(n);if(!s.exists())throw new Error("Batch not found");const c=s.data();if(c.status!=="DRAFT")throw new Error("Batch must be DRAFT");if(!c.shipmentIds.includes(e.shipmentId))throw new Error("Shipment not in batch");t.update(n,{shipmentIds:c.shipmentIds.filter(r=>r!==e.shipmentId)}),t.update(o,{batchId:U()})})}async function Ie(e){await E(i,async t=>{const n=S(i,e.companyId,e.originAgencyId,e.batchId),o=await t.get(n);if(!o.exists())throw new Error("Lot introuvable.");const s=o.data();if(s.status!=="DRAFT")throw new Error("Lot doit etre DRAFT.");if(!s.shipmentIds||s.shipmentIds.length===0)throw new Error("Cannot mark batch READY without shipments.");t.update(n,{status:"READY"})})}const x=["chefAgence","admin_compagnie"];async function Ee(e){if(!x.includes(e.userRole))throw new Error("Unauthorized action.");await E(i,async t=>{const n=S(i,e.companyId,e.originAgencyId,e.batchId),o=await t.get(n);if(!o.exists())throw new Error("Lot introuvable.");const s=o.data();if(s.status!=="READY")throw new Error("Le lot doit être READY pour confirmer le départ.");for(const c of s.shipmentIds){const r=A(i,e.companyId,c),d=await t.get(r);if(!d.exists())throw new Error("Envoi introuvable: "+c);if(d.data().currentStatus!=="CREATED")throw new Error("Envoi "+c+" statut attendu CREATED.");t.update(r,{currentStatus:"IN_TRANSIT",currentAgencyId:e.originAgencyId});const y=g(i,e.companyId);t.set(I(y),{shipmentId:c,eventType:"DEPARTED",agencyId:e.originAgencyId,performedBy:e.performedBy,performedAt:a()})}t.update(n,{status:"DEPARTED",departedAt:a()})})}async function ye(e){e.shipmentIds.length!==0&&await E(i,async t=>{for(const n of e.shipmentIds){const o=A(i,e.companyId,n),s=await t.get(o);if(!s.exists())throw new Error(`Envoi introuvable: ${n}.`);const c=s.data();if(c.currentStatus!=="IN_TRANSIT"||c.destinationAgencyId!==e.agencyId)continue;t.update(o,{currentStatus:"ARRIVED",currentAgencyId:e.agencyId,currentLocationAgencyId:e.agencyId});const r=g(i,e.companyId);t.set(I(r),{shipmentId:n,eventType:"ARRIVED",agencyId:e.agencyId,performedBy:e.performedBy,performedAt:a()})}})}const z=["chefAgence","admin_compagnie"];async function he(e){if(!z.includes(e.userRole))throw new Error("Unauthorized action.");await E(i,async t=>{const n=S(i,e.companyId,e.originAgencyId,e.batchId),o=await t.get(n);if(!o.exists())throw new Error("Lot introuvable.");if(o.data().status!=="DEPARTED")throw new Error("Seul un lot DEPARTED peut être clôturé.");t.update(n,{status:"CLOSED",closedAt:a()})})}export{X as a,ee as b,B as c,R as d,Z as e,te as f,oe as g,ce as h,A as i,re as j,M as k,S as l,se as m,de as n,ue as o,ye as p,Ie as q,ie as r,V as s,Ee as t,he as u,ne as v,ae as w};
