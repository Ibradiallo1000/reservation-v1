import{d as _,b as B,r as s,j as a,a as t,F as G}from"./react-KXT1Riez.js";import{q as H,o as x,r as K,t as Q,w as z,J as U,u as X,y as I,x as L,a as Y,i as Z,d as ee,V as ae,W as te}from"./firebase-DYTOaTLw.js";import{d as u}from"../index-CBC3XRHi.js";import"./vendor-B27hBV_J.js";function f(i){return i.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)+/g,"")}const ie=()=>{const{id:i}=_(),p=B(),[J,O]=s.useState(!0),[g,N]=s.useState(!1),[v,o]=s.useState(""),[c,w]=s.useState(""),[d,h]=s.useState(""),[S,A]=s.useState(""),[C,E]=s.useState(""),[k,P]=s.useState(""),[F,j]=s.useState("actif"),[n,q]=s.useState(null),[D,M]=s.useState(""),[T,R]=s.useState(""),[b,$]=s.useState(!1),y=s.useMemo(()=>c.trim().length>=2&&d.trim().length>=2&&!g,[c,d,g]);s.useEffect(()=>{(async()=>{try{if(!i)return;const e=await H(x(u,"companies",i));if(e.exists()){const l=e.data()||{};w(l.nom||""),h(l.slug||""),A(l.email||""),E(l.telephone||""),P(l.pays||""),j(l.status||"actif")}const r=K(Q(u,"users"),z("companyId","==",i),z("role","==","admin_compagnie"),U(1)),m=await X(r);if(m.empty)q(null);else{const l={uid:m.docs[0].id,...m.docs[0].data()};q(l),M(l.displayName||""),R(l.phone||"")}}catch(e){console.error(e),o("Erreur lors du chargement.")}finally{O(!1)}})()},[i]),s.useEffect(()=>{c&&h(e=>{const r=f(c);return!e||e===f(e)?r:e})},[c]);async function V(e){if(e.preventDefault(),!(!i||!y)){N(!0),o("");try{await I(x(u,"companies",i),{nom:c.trim(),slug:d.trim(),email:S.trim()||null,telephone:C.trim()||null,pays:k.trim()||null,status:F,updatedAt:L()}),n&&await I(x(u,"users",n.uid),{displayName:D.trim()||null,phone:T.trim()||null,updatedAt:L()}),o("✅ Modifications enregistrées."),setTimeout(()=>p("/admin/compagnies"),900)}catch(r){console.error(r),o("❌ Erreur lors de l’enregistrement.")}finally{N(!1)}}}async function W(){if(!(n!=null&&n.email)){o("Email admin introuvable.");return}$(!0),o("");let e=null;try{const r=Y();e=Z(r.options,"admin-modifier-secondary");const m=ee(e);await ae(m,n.email),o(`✉️ Lien de réinitialisation envoyé à ${n.email}.`)}catch(r){console.error(r),o("❌ Échec de l’envoi du lien de réinitialisation.")}finally{$(!1),e&&await te(e)}}return J?a("p",{className:"p-6",children:"Chargement…"}):t("div",{className:"p-6 max-w-4xl mx-auto",children:[t("div",{className:"flex items-center justify-between mb-6",children:[a("h1",{className:"text-2xl font-bold text-orange-700",children:"Modifier la compagnie"}),a("button",{className:"px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",onClick:()=>p("/admin/compagnies"),children:"← Retour"})]}),v&&a("div",{className:"mb-4 text-sm text-blue-800 bg-blue-50 border border-blue-200 rounded p-3",children:v}),t("form",{onSubmit:V,className:"grid md:grid-cols-2 gap-5",children:[t("section",{className:"bg-white border rounded-2xl p-5 shadow-sm",children:[a("h2",{className:"text-lg font-semibold text-orange-700 mb-3",children:"Infos compagnie"}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Nom *"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:c,onChange:e=>w(e.target.value),required:!0})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Slug *"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:d,onChange:e=>h(f(e.target.value)),required:!0})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Email"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",type:"email",value:S,onChange:e=>A(e.target.value)})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Téléphone"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:C,onChange:e=>E(e.target.value)})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Pays"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:k,onChange:e=>P(e.target.value)})]}),t("label",{className:"block",children:[a("span",{className:"text-sm text-gray-700",children:"Statut"}),t("select",{className:"mt-1 w-full border rounded px-3 py-2",value:F,onChange:e=>j(e.target.value),children:[a("option",{value:"actif",children:"Actif"}),a("option",{value:"inactif",children:"Inactif"})]})]})]}),t("section",{className:"bg-white border rounded-2xl p-5 shadow-sm",children:[a("h2",{className:"text-lg font-semibold text-orange-700 mb-3",children:"Admin principal"}),n?t(G,{children:[t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Nom complet"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:D,onChange:e=>M(e.target.value)})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Téléphone"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:T,onChange:e=>R(e.target.value)})]}),t("label",{className:"block mb-4",children:[a("span",{className:"text-sm text-gray-700",children:"Email (lecture seule)"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2 bg-gray-100",value:n.email,readOnly:!0}),a("p",{className:"text-xs text-gray-500 mt-1",children:"Pour changer l’email, passer par la console Firebase (ou une Cloud Function d’admin)."})]}),a("button",{type:"button",onClick:W,disabled:b,className:`px-3 py-2 rounded text-white ${b?"bg-gray-400":"bg-blue-600 hover:bg-blue-700"}`,children:b?"Envoi en cours…":"Envoyer le lien de réinitialisation"})]}):a("p",{className:"text-sm text-gray-600",children:"Aucun admin principal trouvé pour cette compagnie."})]}),t("div",{className:"md:col-span-2 flex items-center justify-end gap-3",children:[a("button",{type:"button",onClick:()=>p("/admin/compagnies"),className:"px-4 py-2 rounded bg-gray-100 hover:bg-gray-200",children:"Annuler"}),a("button",{type:"submit",disabled:!y,className:`px-5 py-2 rounded text-white ${y?"bg-green-600 hover:bg-green-700":"bg-gray-400"}`,children:g?"Enregistrement…":"Sauvegarder"})]})]})]})};export{ie as default};
