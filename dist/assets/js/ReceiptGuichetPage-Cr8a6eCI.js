import{j as e,aP as H,b as G,u as B,a as O,r as i,C as V,M as J,U as Q,T as _,A as K,p as W,aQ as X,aN as Y,ax as Z,aR as ee,a1 as se}from"./react-PtMwKKf1.js";import{d as S,f as A}from"./firebase-eGIzIftJ.js";import{d as P,s as U,h as f}from"../index-C4y8wfzK.js";import{h as te}from"./html2pdf-BR7FolKG.js";import{p as re,J as ae,a5 as ne}from"./vendor-B5FTF_2c.js";import"./jspdf.es.min-C1yNX6Vr.js";import"./html2canvas-DMqt7zzs.js";const oe=({fullScreen:x=!1,className:h=""})=>e.jsx("div",{className:`flex items-center justify-center ${x?"min-h-screen":""} ${h}`,children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}),ie=({message:x,onRetry:h,onHome:d})=>e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:e.jsx("div",{className:"p-6 rounded-lg max-w-md bg-white shadow-sm border border-red-200",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(H,{className:"h-12 w-12 text-red-500 mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2 text-red-600",children:"Erreur"}),e.jsx("p",{className:"mb-6 text-gray-700",children:x}),e.jsxs("div",{className:"flex gap-3",children:[h&&e.jsx("button",{onClick:h,className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition",children:"Réessayer"}),d&&e.jsx("button",{onClick:d,className:"px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300 transition",children:"Accueil"})]})]})})}),ge=()=>{var R,D;const{id:x,slug:h}=G(),d=B(),T=O(),{companyInfo:w,reservation:p,from:j}=T.state||{},[s,$]=i.useState(null),[n,z]=i.useState(null),[q,y]=i.useState(!0),[C,g]=i.useState(null),b=i.useRef(null),I=i.useCallback((r,a)=>{try{let o;return typeof r=="string"?o=re(r):r instanceof Date?o=r:o=new Date(r.seconds*1e3),ae(o,a,{locale:ne})}catch{return"--/--/----"}},[]),N=i.useCallback(()=>{if(!s)return"BIL-000000";const r=s.depart.slice(0,3).toUpperCase(),a=s.arrivee.slice(0,3).toUpperCase(),o=(s.agenceNom||s.agencyNom||s.nomAgence||"AGC").slice(0,3).toUpperCase(),c=s.id.substring(s.id.length-6).toUpperCase();return`${o}-${r}${a}-${c}`},[s]),k=i.useCallback(async()=>{if(!x)return g("ID de réservation manquant"),y(!1),null;try{if(!p)throw new Error("Données de réservation manquantes");const r=p.compagnieId,a=p.agencyId;if(!r||!a)throw new Error("Identifiants manquants");const o=S(P,"companies",r,"agences",a,"reservations",x),c=await A(o);if(!c.exists())throw new Error("Réservation introuvable");const m=c.data();return{...m,id:c.id,createdAt:m.createdAt instanceof Date?m.createdAt:new Date(m.createdAt.seconds*1e3)}}catch(r){return g(r instanceof Error?r.message:"Erreur inconnue"),null}},[x,p]),E=i.useCallback(async r=>{var a,o;try{const c=S(P,"companies",r),m=await A(c);if(!m.exists())throw new Error("Compagnie non trouvée");const l=m.data();return{id:m.id,nom:l.nom,logoUrl:l.logoUrl,couleurPrimaire:((a=l.theme)==null?void 0:a.primary)||l.couleurPrimaire||"#3b82f6",couleurSecondaire:((o=l.theme)==null?void 0:o.secondary)||l.couleurSecondaire||"#93c5fd",slug:l.slug,telephone:l.telephone,banniereUrl:l.banniereUrl}}catch(c){return g(c instanceof Error?c.message:"Erreur compagnie"),null}},[]);i.useEffect(()=>{(async()=>{y(!0),g(null);try{if(!p||!w)throw new Error("Données manquantes. Vous devez accéder à cette page depuis une réservation valide.");const a=await k();if(!a)return;const o=await E(a.compagnieId);if(!o)return;$(a),z(o)}catch(a){g(a instanceof Error?a.message:"Erreur inattendue")}finally{y(!1)}})()},[k,E,p,w]);const M=i.useCallback(()=>{if(b.current){const r={margin:2,filename:`recu-${N()}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,letterRendering:!0,width:340},jsPDF:{unit:"mm",format:[81,200],orientation:"portrait"}};te().set(r).from(b.current).save()}},[N]),F=i.useCallback(()=>{d(j||-1)},[j,d]);if(q||!n)return e.jsx(oe,{fullScreen:!0});if(C||!s||!n)return e.jsx(ie,{message:C||"Erreur de chargement",onRetry:()=>window.location.reload(),onHome:()=>d("/")});const L=`${window.location.origin}/compagnie/${n.slug}/receipt/${s.id}`,t=n.couleurPrimaire,v=n.couleurSecondaire,u=U(t);return e.jsxs("div",{className:"min-h-screen bg-gray-50 print:bg-white",style:{"--primary":t,"--secondary":v,"--text-on-primary":u},children:[e.jsx("style",{children:`
        @media print {
          body, html {
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            background: white !important;
            width: 81mm !important;
          }
          .receipt-container {
            width: 81mm !important;
            max-width: 81mm !important;
            padding: 3mm !important;
            font-size: 11px !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            border: none !important;
            page-break-after: avoid !important;
          }
          .compact-section {
            margin-bottom: 3px !important;
            padding: 2px !important;
          }
          .qr-code-container {
            width: 60px !important;
            height: 60px !important;
            margin: 0 auto !important;
          }
          .print-text-sm {
            font-size: 10px !important;
          }
          .print-py-1 {
            padding-top: 1px !important;
            padding-bottom: 1px !important;
          }
          .no-print {
            display: none !important;
          }
          .print-border-top {
            border-top: 4px solid var(--primary) !important;
          }
        }
      `}),e.jsx("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm no-print",style:{backgroundColor:t,color:u},children:e.jsxs("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e.jsx("button",{onClick:F,className:"p-2 rounded-full hover:bg-white/10 transition","aria-label":"Retour",children:e.jsx(V,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-3",children:[n.logoUrl&&e.jsx("img",{src:n.logoUrl,alt:`Logo ${n.nom}`,className:"h-10 w-10 rounded-full object-cover border-2",style:{borderColor:u,backgroundColor:f(t,.2)},onError:r=>{r.target.src="/default-company.png"}}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h1",{className:"text-sm font-bold",children:"Reçu de voyage"}),e.jsx("p",{className:"text-xs opacity-90",children:n.nom})]})]})]})}),e.jsxs("div",{className:"max-w-[81mm] mx-auto p-2 print:p-0 print:max-w-none",children:[e.jsxs("div",{ref:b,className:"receipt-container bg-white rounded-lg shadow-sm overflow-hidden print-border-top",style:{width:"81mm",margin:"0 auto"},children:[e.jsxs("div",{className:"flex justify-between items-center border-b pb-2 mb-2 px-3",style:{borderColor:f(t,.3)},children:[e.jsxs("div",{className:"flex items-center gap-2",children:[n.logoUrl&&e.jsx("img",{src:n.logoUrl,alt:n.nom,className:"h-9 w-9 object-contain rounded border",style:{borderColor:t},onError:r=>{r.target.src="/default-company.png"}}),e.jsxs("div",{className:"leading-tight",children:[e.jsx("h2",{className:"text-sm font-bold",style:{color:t},children:n.nom}),e.jsxs("p",{className:"text-[11px] text-gray-700 flex items-center gap-1",children:[e.jsx(J,{className:"h-3 w-3 text-gray-500"}),(s.agenceNom||s.agencyNom||s.nomAgence||"Agence inconnue").trim()]})]})]}),e.jsxs("div",{className:"text-right leading-tight pr-2",children:[e.jsxs("p",{className:"text-[11px] font-mono tracking-tight text-gray-700",children:["N° ",N()]}),e.jsx("span",{className:"px-2 py-0.5 rounded text-[10px] font-medium",style:{backgroundColor:f(t,.15),color:t},children:((R=s.statut)==null?void 0:R.toUpperCase())||"EN ATTENTE"})]})]}),e.jsxs("div",{className:"p-2 print:p-1 space-y-2 print-py-1",children:[e.jsxs("div",{className:"compact-section",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx(Q,{className:"h-3 w-3",style:{color:t}}),e.jsx("h3",{className:"text-xs font-semibold",style:{color:t},children:"Client"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Nom"}),e.jsx("p",{className:"truncate",children:s.nomClient})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Téléphone"}),e.jsx("p",{children:s.telephone})]}),s.referenceCode&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Référence"}),e.jsx("p",{className:"font-mono text-[11px]",children:s.referenceCode})]})]})]}),e.jsxs("div",{className:"compact-section",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx(_,{className:"h-3 w-3",style:{color:t}}),e.jsx("h3",{className:"text-xs font-semibold",style:{color:t},children:"Voyage"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Trajet"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("p",{className:"font-medium",children:s.depart}),e.jsx(K,{className:"h-3 w-3 text-gray-500"}),e.jsx("p",{className:"font-medium",children:s.arrivee})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Date"}),e.jsx("p",{children:I(s.date,"dd/MM/yyyy")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Heure"}),e.jsx("p",{children:s.heure})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Places"}),e.jsxs("p",{children:[s.seatsGo," ",s.seatsReturn?`(+${s.seatsReturn} retour)`:""]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Canal"}),e.jsx("p",{className:"capitalize",children:s.canal})]})]})]}),e.jsxs("div",{className:"compact-section",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx(W,{className:"h-3 w-3",style:{color:t}}),e.jsx("h3",{className:"text-xs font-semibold",style:{color:t},children:"Paiement"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Montant"}),e.jsxs("p",{className:"font-bold",style:{color:t},children:[(D=s.montant)==null?void 0:D.toLocaleString("fr-FR")," FCFA"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:"Méthode"}),e.jsx("p",{className:"capitalize",children:s.paiement})]})]})]}),e.jsxs("div",{className:"mt-2 p-1 rounded border border-gray-200 flex flex-col items-center compact-section",children:[e.jsx("h3",{className:"text-xs font-semibold mb-1",style:{color:t},children:"Code d'embarquement"}),e.jsx("div",{className:"bg-white p-1 rounded border qr-code-container",style:{borderColor:t},children:e.jsx(X,{value:L,size:60,fgColor:t,level:"H"})})]}),e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-200 text-center compact-section",style:{fontSize:"10px",color:"#4b5563"},children:[e.jsxs("p",{className:"mb-1",children:["Merci d'avoir choisi ",n.nom]}),e.jsx("p",{className:"italic mb-1",children:"Présentez-vous 1H avant le départ"}),e.jsx("p",{className:"font-medium mb-0.5",children:"Pour plus d'infos, veuillez contacter :"}),e.jsxs("div",{className:"flex justify-center items-center gap-1 text-gray-700",children:[e.jsx(Y,{className:"h-3 w-3 text-gray-500"}),e.jsx("span",{children:s.agenceTelephone||n.telephone||"—"})]})]})]})]}),e.jsxs("div",{className:"no-print mt-3 grid grid-cols-1 gap-2",children:[e.jsxs("button",{onClick:M,className:"flex items-center justify-center gap-2 px-4 py-2 rounded-lg shadow transition-colors text-xs",style:{backgroundColor:t,color:u},children:[e.jsx(Z,{className:"h-4 w-4"}),"Télécharger"]}),e.jsxs("button",{onClick:()=>window.print(),className:"flex items-center justify-center gap-2 px-4 py-2 rounded-lg shadow transition-colors text-xs",style:{backgroundColor:v||f(t,.8),color:U(v||t)},children:[e.jsx(ee,{className:"h-4 w-4"}),"Imprimer"]}),e.jsxs("button",{onClick:()=>d("/agence/guichet"),className:"flex items-center justify-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow hover:bg-gray-300 transition-colors text-xs",children:[e.jsx(se,{className:"h-4 w-4"}),"Retour à la compagnie"]})]})]})]})};export{ge as default};
