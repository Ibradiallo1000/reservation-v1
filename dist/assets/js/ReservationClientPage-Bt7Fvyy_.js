import{b as Ne,a as we,u as Se,r as d,j as e,C as Ce,a0 as De,aN as Ie,b7 as ke,b8 as Pe}from"./react-PtMwKKf1.js";import{m as P,d as j}from"../index-B745l0NT.js";import{d as Te,f as $e,A as Ae,k as w,l as D,q as M,w as J}from"./firebase-eGIzIftJ.js";import{ax as le,p as T,o as ie,ay as Ee,J as _e,a5 as Fe}from"./vendor-B5FTF_2c.js";const Le=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],$=o=>o?o.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/-/g," ").replace(/\s+/g," "):"",ce=o=>o.charAt(0).toUpperCase()+o.slice(1).toLowerCase(),Je=()=>{var Z,ee;const{slug:o}=Ne(),de=we(),q=Se(),H=new URLSearchParams(de.search),x=$(H.get("departure")||""),y=$(H.get("arrival")||""),[n,B]=d.useState({id:"",name:"",couleurPrimaire:"#3b82f6",couleurSecondaire:"#93c5fd",logoUrl:""}),[A,V]=d.useState({nom:"",telephone:""}),[G,Q]=d.useState([]),[E,Y]=d.useState([]),[f,_]=d.useState(""),[I,K]=d.useState(""),[m,F]=d.useState({fullName:"",phone:"",email:""}),[h,W]=d.useState(1),[v,me]=d.useState(!0),[X,L]=d.useState("");d.useEffect(()=>{const a=sessionStorage.getItem(`preload_${o}_${x}_${y}`);if(a)try{const{company:r,trips:u,dates:l,agencyInfo:p}=JSON.parse(a);B(r),Q(u),Y(l),_(l[0]||""),V(p)}catch(r){console.error("Error parsing cached data:",r)}},[o,x,y]),d.useEffect(()=>{if(!o||!x||!y)return;(async()=>{try{const[r,u]=await Promise.all([ue(),pe()]);if(r&&(B(r),sessionStorage.setItem("companyInfo",JSON.stringify(r))),u){const{trips:l,dates:p,agencyInfo:k}=u;Q(l),Y(p),_(p[0]||""),V(k),sessionStorage.setItem(`preload_${o}_${x}_${y}`,JSON.stringify({company:r,trips:l,dates:p,agencyInfo:k,timestamp:Date.now()}))}}catch(r){console.error("Error loading data:",r),L("Une erreur est survenue lors du chargement des données")}finally{me(!1)}})()},[o,x,y]);const ue=async()=>{const a=await D(M(w(j,"companies"),J("slug","==",o)));if(a.empty)return null;const r=a.docs[0];return{id:r.id,name:r.data().nom||"",couleurPrimaire:r.data().couleurPrimaire||"#3b82f6",couleurSecondaire:r.data().couleurSecondaire||"#93c5fd",logoUrl:r.data().logoUrl||"",slug:o}},pe=async()=>{const a=await D(M(w(j,"companies"),J("slug","==",o)));if(a.empty)return null;const r=a.docs[0].id,l=(await D(w(j,"companies",r,"agences"))).docs.map(i=>({id:i.id,nom:i.data().nom||"",telephone:i.data().telephone||""})),p=l.length>0?{nom:l[0].nom,telephone:l[0].telephone}:{nom:"",telephone:""},k=Array.from({length:8},(i,b)=>{const C=new Date;return C.setDate(C.getDate()+b),C.toISOString().split("T")[0]}),ae=[];await Promise.all(l.map(async i=>{const[b,C]=await Promise.all([D(M(w(j,"companies",r,"agences",i.id,"weeklyTrips"),J("active","==",!0))),D(w(j,"companies",r,"agences",i.id,"reservations"))]),be=b.docs.map(c=>({id:c.id,...c.data()})).filter(c=>{const U=$(c.depart||c.departure||""),R=$(c.arrivee||c.arrival||"");return U===x&&R===y}),je=C.docs.map(c=>c.data());k.forEach(c=>{const U=new Date(c),R=Le[U.getDay()];be.forEach(g=>{var re;(((re=g.horaires)==null?void 0:re[R])||[]).forEach(z=>{const se=`${g.id}_${c}_${z}`;if(c===new Date().toISOString().split("T")[0]){const N=new Date;if(ie(z,"HH:mm",new Date)<=N)return}const ve=je.filter(N=>N.trajetId===se&&["payé","preuve_recue"].includes(N.statut)).reduce((N,ne)=>N+(ne.seatsGo||0),0),te=g.places||30,oe=te-ve;oe>0&&ae.push({id:se,date:c,time:z,departure:g.depart||g.departure||"",arrival:g.arrivee||g.arrival||"",price:g.price,agencyId:i.id,companyId:r,places:te,remainingSeats:oe})})})})}));const O=ae.sort((i,b)=>i.date.localeCompare(b.date)),fe=[...new Set(O.map(i=>i.date))].filter(i=>O.some(b=>b.date===i));return{trips:O,dates:fe,agencyInfo:p}},S=d.useMemo(()=>{if(!f)return[];const a=G.filter(r=>r.date===f);if(le(T(f))){const r=new Date;return a.filter(u=>ie(u.time,"HH:mm",new Date)>r)}return a},[G,f]),t=S.find(a=>a.time===I),he=a=>{const r=T(a);return _e(r,"EEE d",{locale:Fe})},ge=async()=>{if(t){if(!m.fullName||!m.phone)return L("Veuillez remplir votre nom complet et numéro de téléphone");try{const a=Te(j,"companies",t.companyId,"agences",t.agencyId),u=(await $e(a)).data()||{},l={nomClient:m.fullName,telephone:m.phone,email:m.email||null,depart:t.departure,arrivee:t.arrival,date:t.date,heure:t.time,montant:t.price*h,seatsGo:h,statut:"en_attente",canal:"en_ligne",tripType:"aller_simple",companyId:t.companyId,agencyId:t.agencyId,agencyNom:u.nom||"",agencyTelephone:u.telephone||"",trajetId:t.id,referenceCode:`RES${Date.now()}`,companySlug:o,companyName:n.name,createdAt:new Date,updatedAt:new Date},p=await Ae(w(j,"companies",t.companyId,"agences",t.agencyId,"reservations"),l);sessionStorage.setItem("reservationDraft",JSON.stringify({...l,id:p.id})),sessionStorage.setItem("companyInfo",JSON.stringify(n)),q(`/${o}/upload-preuve/${p.id}`)}catch(a){console.error("Booking error:",a),L("Une erreur est survenue lors de la réservation")}}},xe=()=>e.jsx("div",{className:"h-12 w-16 bg-gray-200 rounded-lg animate-pulse"}),ye=()=>e.jsx("div",{className:"h-20 bg-gray-200 rounded-lg animate-pulse"}),s=d.useMemo(()=>({primary:n.couleurPrimaire,secondary:n.couleurSecondaire,lightPrimary:`${n.couleurPrimaire}20`,lightSecondary:`${n.couleurSecondaire}20`,textOnPrimary:"#ffffff"}),[n.couleurPrimaire,n.couleurSecondaire]);return v||!n.id||E.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gray-50",children:[e.jsxs(P.div,{initial:{opacity:0,y:-50,scale:.5},animate:{opacity:1,y:0,scale:1},transition:{duration:.8,ease:"easeOut"},className:"relative flex items-center justify-center mb-6",children:[e.jsx(P.div,{className:"absolute w-28 h-28 rounded-full",style:{backgroundColor:n.couleurPrimaire,opacity:.2},animate:{scale:[1,1.4,1],opacity:[.2,0,.2]},transition:{duration:2,repeat:1/0}}),e.jsx(P.img,{src:n.logoUrl,alt:"Logo compagnie",className:"h-20 w-20 rounded-full object-cover border-4 shadow-lg",style:{borderColor:n.couleurSecondaire},whileHover:{scale:1.05}})]}),e.jsx(P.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.6,duration:.6},className:"text-gray-600 font-medium",children:"Recherche en cours..."})]}):e.jsxs("div",{className:"min-h-screen bg-gray-50 pb-24",children:[e.jsx("header",{className:"p-4 shadow-sm sticky top-0 z-50",style:{backgroundColor:s.primary},children:e.jsxs("div",{className:"max-w-5xl mx-auto flex items-center justify-between text-white",children:[e.jsx("button",{onClick:()=>q(-1),className:"hover:opacity-80 transition-opacity",children:e.jsx(Ce,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex items-center gap-3",children:[n.logoUrl&&e.jsx("img",{src:n.logoUrl,alt:"logo",className:"h-8 w-8 rounded-full object-cover border border-white"}),e.jsx("span",{className:"font-semibold text-lg",children:n.name})]})]})}),A.nom&&e.jsx("div",{className:"bg-white py-2 px-4 border-b border-gray-100",children:e.jsxs("div",{className:"max-w-5xl mx-auto text-sm text-gray-600",children:["Agence : ",A.nom," — ",A.telephone]})}),e.jsxs("main",{className:"max-w-5xl mx-auto p-4",children:[e.jsxs("section",{className:"flex items-center justify-between bg-white p-4 mb-6 rounded-xl shadow-sm border",style:{borderColor:s.primary},children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full",style:{backgroundColor:s.lightPrimary},children:e.jsx(De,{className:"w-5 h-5",style:{color:s.primary}})}),e.jsxs("h1",{className:"font-semibold text-lg text-gray-900",children:[ce(x)," → ",ce(y)]})]}),e.jsx("div",{className:"text-right font-bold text-lg",style:{color:s.primary},children:(t==null?void 0:t.price)??((Z=S[0])==null?void 0:Z.price)?`${((t==null?void 0:t.price)??((ee=S[0])==null?void 0:ee.price)).toLocaleString("fr-FR")} FCFA`:"Prix non disponible"})]}),v&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2",style:{borderColor:s.primary}})}),e.jsx("div",{className:"flex space-x-3",children:[...Array(5)].map((a,r)=>e.jsx(xe,{},r))}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3",children:[...Array(6)].map((a,r)=>e.jsx(ye,{},r))})]}),X&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 rounded-lg border border-red-200",children:e.jsxs("div",{className:"flex items-center gap-3 text-red-800",children:[e.jsx("svg",{className:"h-5 w-5 flex-shrink-0",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),e.jsx("span",{children:X})]})}),!v&&E.length>0&&e.jsxs("div",{className:"mb-8 p-5 rounded-xl shadow-sm border",style:{backgroundColor:s.lightPrimary,borderColor:s.primary},children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold mr-3 text-white",style:{backgroundColor:s.primary},children:"1"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Choisissez votre date du voyage"})]}),e.jsx("div",{className:"overflow-x-auto pb-2",children:e.jsx("div",{className:"flex space-x-3 w-max",children:E.map(a=>e.jsxs("button",{onClick:()=>{_(a),K("")},className:`py-2 px-4 rounded-lg border transition-all flex flex-col items-center min-w-[80px] ${f===a?"shadow-sm":"bg-white text-gray-700 border-gray-200 hover:border-gray-300"}`,style:{borderColor:f===a?s.primary:"",backgroundColor:f===a?s.lightPrimary:"white"},children:[e.jsx("div",{className:"font-medium text-sm",children:he(a)}),le(T(a))&&e.jsx("div",{className:"text-xs mt-1",children:"Aujourd'hui"}),Ee(T(a))&&e.jsx("div",{className:"text-xs mt-1",children:"Demain"})]},a))})})]}),!v&&S.length>0&&e.jsxs("div",{className:"mb-8 p-5 rounded-xl shadow-sm border",style:{backgroundColor:s.lightSecondary,borderColor:s.secondary},children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold mr-3 text-white",style:{backgroundColor:s.secondary},children:"2"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Choisissez votre heure de depart"})]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3",children:S.map(a=>e.jsxs("button",{onClick:()=>K(a.time),className:`py-3 px-4 rounded-lg border transition-all ${I===a.time?"shadow-sm":"bg-white text-gray-700 border-gray-200 hover:border-gray-300"}`,style:{borderColor:I===a.time?s.secondary:"",backgroundColor:I===a.time?s.lightSecondary:"white"},children:[e.jsx("div",{className:"font-bold text-center text-lg",children:a.time}),e.jsxs("div",{className:"text-sm text-center mt-1",children:[a.remainingSeats," place",a.remainingSeats>1?"s":""]})]},a.id))})]}),!v&&t&&e.jsxs("div",{className:"bg-white p-5 rounded-xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full font-bold mr-3 text-white",style:{backgroundColor:s.primary},children:"3"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Informations personnelles"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullName",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nom complet *"}),e.jsx("input",{id:"fullName",type:"text",placeholder:"Votre nom complet",value:m.fullName,onChange:a=>F({...m,fullName:a.target.value}),className:"w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:outline-none focus:ring-blue-500",style:{borderColor:s.lightPrimary},required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:"Numéro de téléphone *"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(Ie,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"phone",type:"tel",placeholder:"Votre numéro de téléphone",value:m.phone,onChange:a=>F({...m,phone:a.target.value}),className:"w-full pl-10 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:outline-none focus:ring-blue-500",style:{borderColor:s.lightPrimary},required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email (facultatif)"}),e.jsx("input",{id:"email",type:"email",placeholder:"Votre email",value:m.email,onChange:a=>F({...m,email:a.target.value}),className:"w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:outline-none focus:ring-blue-500",style:{borderColor:s.lightPrimary}})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"seats",className:"block text-sm font-medium text-gray-700 mb-1",children:["Nombre de places (",t.remainingSeats," disponible",t.remainingSeats>1?"s":"",")"]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:()=>W(Math.max(1,h-1)),className:"w-10 h-10 rounded-full flex items-center justify-center border",style:{borderColor:s.lightPrimary,color:s.primary},children:e.jsx(ke,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-lg font-semibold px-4 py-2 rounded-lg",style:{backgroundColor:s.lightPrimary,color:s.primary},children:h}),e.jsx("button",{onClick:()=>W(Math.min(10,t.remainingSeats,h+1)),className:"w-10 h-10 rounded-full flex items-center justify-center border",style:{borderColor:s.lightPrimary,color:s.primary},children:e.jsx(Pe,{className:"w-5 h-5"})})]})]})]})]})]}),!v&&t&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-3 px-4 shadow-lg",children:e.jsxs("div",{className:"max-w-5xl mx-auto flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Total pour ",h," place",h>1?"s":""]}),e.jsxs("div",{className:"font-bold text-lg",style:{color:s.primary},children:[t.price*h," FCFA"]})]}),e.jsx("button",{onClick:ge,className:"py-3 px-6 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition-all",style:{backgroundColor:s.secondary},children:"Confirmer la réservation"})]})})]})};export{Je as default};
