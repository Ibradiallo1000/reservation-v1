import{t as z,u as H,r as c,j as e,w as O,_,D as Q,E as G,F as I}from"./react-A-4nP3fl.js";import{d as S,c as $,q as J,f as V,w as Y,e as B}from"./firebase-CbfwkGbo.js";import{d as g}from"../index-ChphXJpr.js";import{h as K}from"./html2pdf-BwS9zivy.js";import{s as W,h as k}from"./color-CDd1PckM.js";import{p as X,J as Z,a5 as ee}from"./vendor-CCJV4Wg0.js";import"./jspdf.es.min-DKRyy6ac.js";import"./html2canvas-B0EGcZY8.js";const de=()=>{var N;const{id:d,slug:l}=z(),p=H(),[t,q]=c.useState(null),[r,P]=c.useState(null),[L,u]=c.useState(!0),[j,y]=c.useState(null),h=c.useRef(null),f=(a,i)=>{try{let n;return typeof a=="string"?n=X(a):a instanceof Date?n=a:n=new Date(a.seconds*1e3),Z(n,i,{locale:ee})}catch{return"Date invalide"}},b=()=>{if(!t)return"ONL-000000";const i=(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt.seconds*1e3)).getFullYear(),n=t.id.slice(0,6).toUpperCase();return`ONL-${i}-${n}`};c.useEffect(()=>{(async()=>{if(!d||!l){y("Paramètres manquants dans l'URL"),u(!1);return}try{const i=S(g,"reservations",d),n=await $(i);if(!n.exists())throw new Error("Réservation introuvable");const o=n.data();if(o.companySlug!==l)throw new Error("URL invalide pour cette réservation");const U=J(V(g,"companies"),Y("slug","==",l)),v=await B(U);if(v.empty)throw new Error("Compagnie non trouvée");const w=v.docs[0].data();let C="",D="",R,E;if(o.agencyId){const A=await $(S(g,"agences",o.agencyId));if(A.exists()){const x=A.data();C=x.nomAgence||"",D=x.telephone||"",R=x.latitude,E=x.longitude}}q({...o,id:n.id,createdAt:o.createdAt instanceof Date?o.createdAt:new Date(o.createdAt.seconds*1e3),latitude:R,longitude:E}),P({...w,agenceNom:C,telephone:D||w.telephone})}catch(i){y(i instanceof Error?i.message:"Erreur inconnue")}finally{u(!1)}})()},[d,l]);const T=()=>{if(h.current){const a={margin:2,filename:`recu-${b()}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:1.5,useCORS:!0,letterRendering:!0,width:340},jsPDF:{unit:"mm",format:"a6",orientation:"portrait"}};K().set(a).from(h.current).save()}};if(L)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})});if(j||!t||!r)return e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:e.jsxs("div",{className:"p-4 rounded-lg max-w-md bg-white shadow-sm border border-red-200",children:[e.jsx("h2",{className:"text-xl font-bold mb-2 text-red-600",children:"Erreur"}),e.jsx("p",{className:"mb-4",children:j||"Erreur de chargement"}),e.jsx("button",{onClick:()=>p("/"),className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition",children:"Retour à l'accueil"})]})});const F=`${window.location.origin}/compagnie/${l}/receipt/${d}`,s=r.couleurPrimaire||"#3b82f6",M=r.couleurSecondaire||"#93c5fd",m=W(s);return e.jsxs("div",{className:"min-h-screen bg-gray-50 print:bg-white",style:{"--primary":s,"--secondary":M},children:[e.jsx("style",{children:`
        @media print {
          body, html {
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
          }
          .receipt-container {
            padding: 2mm !important;
            font-size: 11px !important;
            width: 100% !important;
            max-width: 100% !important;
          }
          .compact-section {
            margin-bottom: 2px !important;
            padding: 2px !important;
          }
          .qr-code-container {
            width: 90px !important;
            height: 90px !important;
            margin: 0 auto !important;
          }
          .print-text-sm {
            font-size: 10px !important;
          }
          .print-py-1 {
            padding-top: 1px !important;
            padding-bottom: 1px !important;
          }
          .no-print {
            display: none !important;
          }
        }
      `}),e.jsx("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm no-print",style:{backgroundColor:k(s,.95),color:m},children:e.jsxs("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e.jsx("button",{onClick:()=>p(-1),className:"p-2 rounded-full hover:bg-white/10 transition",children:e.jsx(O,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[r.logoUrl&&e.jsx("img",{src:r.logoUrl,alt:`Logo ${r.nom}`,className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:m,backgroundColor:k(s,.2)}}),e.jsx("h1",{className:"text-lg font-bold",children:"Reçu de voyage"})]})]})}),e.jsxs("div",{className:"max-w-lg mx-auto p-4 print:p-0 print:max-w-none",children:[e.jsxs("div",{ref:h,className:"receipt-container bg-white rounded-xl shadow-sm overflow-hidden print:shadow-none print:rounded-none",style:{borderTop:`4px solid ${s}`},children:[e.jsxs("div",{className:"p-3 print:p-2 flex justify-between items-center print-py-1",style:{backgroundColor:s,color:m},children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold print-text-sm",children:r.nom}),r.agenceNom&&e.jsxs("p",{className:"text-xs opacity-90 mt-1 print-text-sm",children:["Agence: ",r.agenceNom]})]}),r.logoUrl&&e.jsx("img",{src:r.logoUrl,alt:r.nom,className:"h-10 w-10 object-contain bg-white p-1 rounded-full print:h-8 print:w-8",onError:a=>a.currentTarget.src="/default-company.png"})]}),e.jsxs("div",{className:"p-3 print:p-2 print-py-1",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3 pb-1 border-b border-gray-200 compact-section",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-gray-500 print-text-sm",children:["N° ",b()]}),e.jsxs("p",{className:"text-xs text-gray-500 print-text-sm",children:["Émis le ",f(t.createdAt,"dd/MM/yyyy à HH:mm")]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium print-text-sm ${t.statut==="confirmé"?"bg-green-100 text-green-800":t.statut==="annulé"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:t.statut})})]}),e.jsxs("div",{className:"mb-3 compact-section",children:[e.jsx("h3",{className:"text-sm font-semibold mb-1 print-text-sm",style:{color:s},children:"Client"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-sm print-text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 print-text-sm",children:"Nom"}),e.jsx("p",{children:t.nomClient})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 print-text-sm",children:"Téléphone"}),e.jsx("p",{children:t.telephone})]}),t.email&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-xs text-gray-600 print-text-sm",children:"Email"}),e.jsx("p",{children:t.email})]})]})]}),e.jsxs("div",{className:"mb-3 compact-section",children:[e.jsx("h3",{className:"text-sm font-semibold mb-1 print-text-sm",style:{color:s},children:"Voyage"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-sm print-text-sm",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-xs text-gray-600 print-text-sm",children:"Trajet"}),e.jsxs("p",{className:"font-medium",children:[t.depart," → ",t.arrivee]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 print-text-sm",children:"Date"}),e.jsx("p",{children:f(t.date,"dd/MM/yyyy")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 print-text-sm",children:"Heure"}),e.jsx("p",{children:t.heure})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 print-text-sm",children:"Places"}),e.jsxs("p",{children:[t.seatsGo," ",t.seatsReturn?`(+${t.seatsReturn} retour)`:""]})]})]})]}),e.jsxs("div",{className:"mb-3 compact-section",children:[e.jsx("h3",{className:"text-sm font-semibold mb-1 print-text-sm",style:{color:s},children:"Paiement"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-sm print-text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 print-text-sm",children:"Montant"}),e.jsxs("p",{className:"font-bold",style:{color:s},children:[(N=t.montant)==null?void 0:N.toLocaleString("fr-FR")," FCFA"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 print-text-sm",children:"Méthode"}),e.jsx("p",{className:"capitalize",children:t.paiement})]})]})]}),e.jsxs("div",{className:"mt-3 p-2 rounded border border-gray-200 flex flex-col items-center compact-section",children:[e.jsx("h3",{className:"text-sm font-semibold mb-1 print-text-sm",style:{color:s},children:"Code d'embarquement"}),e.jsx("div",{className:"bg-white p-1 rounded border qr-code-container",style:{borderColor:s},children:e.jsx(_,{value:F,size:90,fgColor:s,level:"H"})}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 text-center print-text-sm",children:"Présentez ce code QR au chauffeur ou à l'agent d'embarquement"})]}),e.jsxs("div",{className:"mt-2 pt-1 border-t border-gray-200 text-center text-xs text-gray-500 compact-section print-text-sm",children:[e.jsx("p",{children:"Reçu valable uniquement pour le trajet indiqué"}),e.jsxs("p",{className:"mt-1",children:["Merci d'avoir choisi ",r.nom]})]})]})]}),e.jsxs("div",{className:"no-print mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2",children:[e.jsxs("button",{onClick:T,className:"flex items-center justify-center gap-2 px-4 py-2 rounded-lg shadow transition-colors text-sm",style:{backgroundColor:s,color:m},children:[e.jsx(Q,{className:"h-4 w-4"}),"Télécharger"]}),e.jsxs("button",{onClick:()=>window.print(),className:"flex items-center justify-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 transition-colors text-sm",children:[e.jsx(G,{className:"h-4 w-4"}),"Imprimer"]}),e.jsxs("button",{onClick:()=>p("/"),className:"flex items-center justify-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow hover:bg-gray-300 transition-colors text-sm",children:[e.jsx(I,{className:"h-4 w-4"}),"Accueil"]}),t.latitude&&t.longitude&&e.jsx("a",{href:`https://www.google.com/maps/dir/?api=1&destination=${t.latitude},${t.longitude}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-colors text-sm",children:"📍 Itinéraire"})]})]})]})};export{de as default};
