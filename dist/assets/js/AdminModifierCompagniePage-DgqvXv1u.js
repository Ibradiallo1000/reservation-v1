import{r as s,j as a,a as t,F as U}from"./vendor-Bq-8_m9i.js";import{q as V,o as f,r as W,t as X,w as z,G as Y,u as Z,y as I,x as B,a as ee,i as ae,d as te,J as se,a2 as ne}from"./firebase-CURBI7X6.js";import{m as le,d as u,P as re,w as ie,B as K}from"./agence-Bsj2lp2X.js";import{d as oe,a as ce}from"./router-DoGdw-3y.js";import"./compagnie-DiuZFnHS.js";import"./icons-C0JHUK9Z.js";import"./courier-CoQgRaHG.js";function x(p){return p.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)+/g,"")}const ye=()=>{const p=le(),{id:c}=oe(),g=ce(),[$,G]=s.useState(!0),[h,N]=s.useState(!1),[b,i]=s.useState(""),[o,v]=s.useState(""),[d,y]=s.useState(""),[S,w]=s.useState(""),[C,A]=s.useState(""),[E,k]=s.useState(""),[P,F]=s.useState("actif"),[l,j]=s.useState(null),[R,q]=s.useState(""),[D,M]=s.useState(""),[T,L]=s.useState(!1),[J,_]=s.useState(0),O=s.useMemo(()=>o.trim().length>=2&&d.trim().length>=2&&!h,[o,d,h]);s.useEffect(()=>{(async()=>{try{if(!c)return;const e=await V(f(u,"companies",c));if(e.exists()){const n=e.data()||{};v(n.nom||""),y(n.slug||""),w(n.email||""),A(n.telephone||""),k(n.pays||""),F(n.status||"actif")}const r=W(X(u,"users"),z("companyId","==",c),z("role","==","admin_compagnie"),Y(1)),m=await Z(r);if(m.empty)j(null);else{const n={uid:m.docs[0].id,...m.docs[0].data()};j(n),q(n.displayName||""),M(n.phone||"")}}catch(e){console.error(e),i("Erreur lors du chargement.")}finally{G(!1)}})()},[c,J]),s.useEffect(()=>{o&&y(e=>{const r=x(o);return!e||e===x(e)?r:e})},[o]);async function H(e){if(e.preventDefault(),!(!c||!O)){N(!0),i("");try{await I(f(u,"companies",c),{nom:o.trim(),slug:d.trim(),email:S.trim()||null,telephone:C.trim()||null,pays:E.trim()||null,status:P,updatedAt:B()}),l&&await I(f(u,"users",l.uid),{displayName:R.trim()||null,phone:D.trim()||null,updatedAt:B()}),i("✅ Modifications enregistrées."),setTimeout(()=>g("/admin/compagnies"),900)}catch(r){console.error(r),i("❌ Erreur lors de l’enregistrement.")}finally{N(!1)}}}async function Q(){if(!(l!=null&&l.email)){i("Email admin introuvable.");return}L(!0),i("");let e=null;try{const r=ee();e=ae(r.options,"admin-modifier-secondary");const m=te(e);await se(m,l.email),i(`✉️ Lien de réinitialisation envoyé à ${l.email}.`)}catch(r){console.error(r),i("❌ Échec de l’envoi du lien de réinitialisation.")}finally{L(!1),e&&await ne(e)}}return $?a(re,{}):t("div",{className:"p-6 max-w-7xl mx-auto",children:[!p&&a("div",{className:"mb-4",children:a(ie,{message:"Connexion instable: certaines opérations peuvent échouer."})}),t("div",{className:"flex items-center justify-between mb-6",children:[a("h1",{className:"text-2xl font-bold text-orange-700",children:"Modifier la compagnie"}),a("button",{className:"px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",onClick:()=>g("/admin/compagnies"),children:"← Retour"})]}),b&&t("div",{className:"mb-4 text-sm text-blue-800 bg-blue-50 border border-blue-200 rounded p-3 flex items-center justify-between gap-3",children:[a("span",{children:b}),b.includes("Erreur")&&a("button",{type:"button",onClick:()=>_(e=>e+1),className:"px-2 py-1 text-xs rounded border border-blue-300 hover:bg-blue-100",children:"Réessayer"})]}),t("form",{onSubmit:H,className:"grid md:grid-cols-2 gap-5",children:[t("section",{className:"bg-white border rounded-xl p-5 shadow-sm",children:[a("h2",{className:"text-lg font-semibold text-orange-700 mb-3",children:"Infos compagnie"}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Nom *"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:o,onChange:e=>v(e.target.value),required:!0})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Slug *"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:d,onChange:e=>y(x(e.target.value)),required:!0})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Email"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",type:"email",value:S,onChange:e=>w(e.target.value)})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Téléphone"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:C,onChange:e=>A(e.target.value)})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Pays"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:E,onChange:e=>k(e.target.value)})]}),t("label",{className:"block",children:[a("span",{className:"text-sm text-gray-700",children:"Statut"}),t("select",{className:"mt-1 w-full border rounded px-3 py-2",value:P,onChange:e=>F(e.target.value),children:[a("option",{value:"actif",children:"Actif"}),a("option",{value:"inactif",children:"Inactif"})]})]})]}),t("section",{className:"bg-white border rounded-xl p-5 shadow-sm",children:[a("h2",{className:"text-lg font-semibold text-orange-700 mb-3",children:"Admin principal"}),l?t(U,{children:[t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Nom complet"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:R,onChange:e=>q(e.target.value)})]}),t("label",{className:"block mb-3",children:[a("span",{className:"text-sm text-gray-700",children:"Téléphone"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2",value:D,onChange:e=>M(e.target.value)})]}),t("label",{className:"block mb-4",children:[a("span",{className:"text-sm text-gray-700",children:"Email (lecture seule)"}),a("input",{className:"mt-1 w-full border rounded px-3 py-2 bg-gray-100",value:l.email,readOnly:!0}),a("p",{className:"text-xs text-gray-500 mt-1",children:"Pour changer l’email, passer par la console Firebase (ou une Cloud Function d’admin)."})]}),a(K,{type:"button",onClick:Q,disabled:T,variant:"primary",children:T?"Envoi en cours…":"Envoyer le lien de réinitialisation"})]}):a("p",{className:"text-sm text-gray-600",children:"Aucun admin principal trouvé pour cette compagnie."})]}),t("div",{className:"md:col-span-2 flex items-center justify-end gap-3",children:[a("button",{type:"button",onClick:()=>g("/admin/compagnies"),className:"px-4 py-2 rounded bg-gray-100 hover:bg-gray-200",children:"Annuler"}),a(K,{type:"submit",disabled:!O,variant:"primary",children:h?"Enregistrement…":"Sauvegarder"})]})]})]})};export{ye as default};
