import{b as S,r,j as t,a as n,aw as E,aG as F,A as R,_ as j,F as y,L as k,aA as D}from"./react-KXT1Riez.js";import{A as q,B as M,Q as z,S as T,q as U,o as $}from"./firebase-DYTOaTLw.js";import{a as v,d as B}from"../index-CBC3XRHi.js";import"./vendor-B27hBV_J.js";const I=o=>o.trim().toLowerCase(),G=o=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o.trim()),O=o=>{const a=(o||"user").toLowerCase();return a==="company_accountant"||a==="comptable_compagnie"?"company_accountant":a==="financial_director"||a==="daf"?"financial_director":a==="admin_platforme"?"admin_platforme":a==="admin_compagnie"||a==="compagnie"?"admin_compagnie":a==="chefagence"||a==="chef_agence"||a==="superviseur"||a==="agentcourrier"?"chefAgence":a==="agency_accountant"||a==="comptable_agence"?"agency_accountant":a==="guichetier"?"guichetier":a==="embarquement"?"embarquement":"user"},N=o=>{switch(o){case"admin_platforme":return"/admin/dashboard";case"admin_compagnie":return"/compagnie/dashboard";case"company_accountant":case"financial_director":return"/comptable";case"chefAgence":case"embarquement":return"/agence/dashboard";case"agency_accountant":return"/agence/comptabilite";case"guichetier":return"/agence/guichet";default:return"/"}},J=()=>{const o=S(),[a,h]=r.useState("email"),[c,L]=r.useState(""),[m,f]=r.useState(""),[d,_]=r.useState(!0),[l,i]=r.useState(""),[b,x]=r.useState(!1),g=r.useRef(!1),C=r.useCallback(s=>{if(s.preventDefault(),i(""),!G(c)){i("Adresse e-mail invalide");return}h("password")},[c]),P=r.useCallback(async s=>{if(s.preventDefault(),!g.current){i(""),x(!0);try{await q(v,d?M:z),console.log("üîç LoginPage - Tentative de connexion avec:",c);const e=await T(v,I(c),m);console.log("‚úÖ LoginPage - Firebase Auth r√©ussi, UID:",e.user.uid);const u=await U($(B,"users",e.user.uid));console.log("üîç LoginPage - Document Firestore:",u.exists()?u.data():"Non trouv√©");const w=u.exists()?u.data():{},p=O(w.role);console.log("üîç LoginPage - R√¥le brut:",w.role),console.log("üîç LoginPage - R√¥le normalis√©:",p),console.log("üîç LoginPage - Redirection vers:",N(p)),g.current=!0,o(N(p),{replace:!0})}catch(e){console.error("‚ùå LoginPage - Erreur de connexion:",e),console.error("‚ùå LoginPage - Code d'erreur:",e==null?void 0:e.code),console.error("‚ùå LoginPage - Message:",e==null?void 0:e.message),g.current=!1,(e==null?void 0:e.code)==="auth/wrong-password"?i("Mot de passe incorrect."):(e==null?void 0:e.code)==="auth/user-not-found"?i("Aucun compte associ√© √† cet e-mail."):(e==null?void 0:e.code)==="auth/invalid-email"?i("Format d'email invalide."):(e==null?void 0:e.code)==="auth/too-many-requests"?i("Trop de tentatives. R√©essayez plus tard."):i(`Connexion impossible: ${(e==null?void 0:e.message)||"Erreur inconnue"}`)}finally{x(!1)}}},[c,m,d,o]),A=r.useMemo(()=>{const s=c.split("@")[0]||"Utilisateur";return s.charAt(0).toUpperCase()+s.slice(1)},[c]);return t("div",{className:"min-h-screen flex items-center justify-center bg-orange-50 p-4",children:n("div",{className:"w-full max-w-md bg-white rounded-2xl shadow p-6 space-y-6",children:[t("h1",{className:"text-xl font-bold",children:a==="email"?"Connexion":`Bonjour ${A}`}),a==="email"&&n("form",{onSubmit:C,className:"space-y-4",children:[n("div",{className:"relative",children:[t(E,{className:"absolute left-3 top-3 h-4 w-4 text-gray-400"}),t("input",{type:"email",className:"w-full border rounded-xl pl-10 pr-3 py-3",placeholder:"email@domaine.com",value:c,onChange:s=>L(s.target.value),autoFocus:!0})]}),l&&t("p",{className:"text-sm text-red-600",children:l}),t("button",{className:"w-full bg-orange-600 text-white py-3 rounded-xl",children:"Continuer"})]}),a==="password"&&n("form",{onSubmit:P,className:"space-y-4",children:[n("div",{className:"relative",children:[t(F,{className:"absolute left-3 top-3 h-4 w-4 text-gray-400"}),t("input",{type:"password",className:"w-full border rounded-xl pl-10 pr-3 py-3",placeholder:"Mot de passe",value:m,onChange:s=>f(s.target.value),autoFocus:!0})]}),l&&n("p",{className:"text-sm text-red-600 flex gap-1 items-center",children:[t(R,{className:"h-4 w-4"})," ",l]}),n("div",{className:"flex justify-between items-center text-sm",children:[n("label",{className:"flex items-center gap-2",children:[t("input",{type:"checkbox",checked:d,onChange:s=>_(s.target.checked)}),"Se souvenir de moi"]}),n("button",{type:"button",onClick:()=>{h("email"),f("")},className:"flex items-center gap-1 text-gray-600",children:[t(j,{className:"h-4 w-4"})," Changer d'email"]})]}),t("button",{disabled:b,className:"w-full bg-orange-600 text-white py-3 rounded-xl flex justify-center gap-2 disabled:opacity-50",children:b?n(y,{children:[t(k,{className:"animate-spin h-4 w-4"})," Connexion en cours..."]}):n(y,{children:["Connexion ",t(D,{className:"h-4 w-4"})]})}),t("div",{className:"text-center mt-4",children:t("a",{href:"/test-firebase",className:"text-sm text-blue-600 underline hover:text-blue-800",children:"Probl√®mes de connexion ? Testez Firebase ici"})})]})]})})};export{J as default};
