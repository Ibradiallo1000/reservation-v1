import{a as o,j as e,r as g,aR as Se,d as De,aS as $e,aT as ke,aU as je,aV as Me,aW as Le}from"./react-DB_4kGOy.js";import{x as he,z as Ae,w as Fe,B as Ie,y as te,T as le,A as Te}from"./firebase-lLzYRzUk.js";import{u as D,b as $,m as Ee,d as pe}from"../index-Bkmir__O.js";import{a as j,C as M,b as L,S as A,c as F}from"./skeleton-DZEhV3nL.js";import{R as ge,X as Be,Y as Oe,T as ye,B as Pe,k as Ye,l as ze,j as Ke}from"./generateCategoricalChart-B2qQXPfN.js";import{B as Ue}from"./BarChart-CgOoYHZJ.js";import{a as _e,P as Ge}from"./PieChart-hJ1LyQz7.js";import"./vendor-C-DAJou6.js";import"./utils-CmftarAw.js";function He(t){return t.toDate?t.toDate():t}const H=({title:t,value:a,icon:f,color:r="primary",isCurrency:n=!1,unit:d="",link:u,isLoading:c=!1})=>{const{company:s}=D(),i=$(s),p={primary:i.colors.primary,secondary:i.colors.secondary,success:"#10B981",warning:"#F59E0B",info:"#3B82F6"}[r]||i.colors.primary,b="#1e293b",N=n?`${Number(a).toLocaleString()} FCFA`:typeof a=="number"?`${a.toLocaleString()}${d}`:a,v=o(F,{className:"h-full transition-all hover:shadow-xl border border-gray-300 bg-white rounded-xl shadow-md",children:[o(j,{className:"flex flex-row items-center justify-between pb-3",children:[e(M,{className:"text-base font-semibold tracking-wide",style:{color:b},children:t}),e("div",{className:"p-2 rounded-lg shadow-md",style:{backgroundColor:`${p}20`,color:p},children:f})]}),o(L,{children:[c?e(A,{className:"h-8 w-3/4 rounded-md"}):e(Ee.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{duration:.3},className:"text-3xl font-bold",style:{color:p},children:N}),e("p",{className:"text-xs text-gray-500 mt-1",children:"Tableau de bord – Réservations"})]})]});return u?e("a",{href:u,className:"block h-full",children:v}):v},Ve=({data:t,isLoading:a})=>{const{company:f}=D(),r=$(f);return a?e(A,{className:"w-full h-64 rounded-lg"}):o(F,{className:"shadow-sm border border-gray-200",children:[e(j,{children:e(M,{style:{color:r.colors.primary},children:"Réservations par jour"})}),e(L,{children:e("div",{className:"h-64",children:e(ge,{width:"100%",height:"100%",children:o(Ue,{data:t,children:[e(Be,{dataKey:"date",tick:{fill:r.colors.text},axisLine:!1,tickLine:!1}),e(Oe,{tick:{fill:r.colors.text},axisLine:!1,tickLine:!1}),e(ye,{contentStyle:{backgroundColor:"#fff",border:`1px solid ${r.colors.secondary}`,borderRadius:"0.5rem",color:r.colors.primary,boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1)"},formatter:n=>[`${n} réservations`,"Nombre"]}),e(Pe,{dataKey:"reservations",fill:r.colors.secondary,radius:[6,6,0,0],animationDuration:1500})]})})})})]})},qe=({data:t,isLoading:a})=>{const{company:f}=D(),r=$(f),n=g.useMemo(()=>{const u=i=>(i||"").toLowerCase().trim().replace(/[̀-ͯ]/g,"").replace(/\s+/g," ").replace("guiche","guichet").replace("en ligne","En ligne").replace("guichet","Guichet").replace(/^en ligne$/,"En ligne").replace(/^guichet$/,"Guichet"),c=t.map(i=>({...i,name:u(i.name)})),s=c.reduce((i,y)=>i+(Number(y.value)||0),0);return{total:s,rows:c.map(i=>({...i,pct:s?Math.round(Number(i.value)/s*100):0}))}},[t]),d=[r.colors.primary,r.colors.secondary,r.colors.accent,r.colors.tertiary,"#9CA3AF"];return a?e(A,{className:"w-full h-64 rounded-lg"}):o(F,{className:"shadow-sm border border-gray-200",children:[e(j,{children:e(M,{style:{color:r.colors.primary},children:"Répartition par canal"})}),e(L,{children:e("div",{className:"h-64",children:e(ge,{width:"100%",height:"100%",children:o(_e,{children:[o(Ge,{data:n.rows,cx:"50%",cy:"50%",innerRadius:60,outerRadius:90,paddingAngle:2,dataKey:"value",nameKey:"name",labelLine:!1,children:[n.rows.map((u,c)=>e(Ye,{fill:d[c%d.length]},c)),e(ze,{position:"center",content:()=>o("text",{textAnchor:"middle",dominantBaseline:"middle",children:[e("tspan",{fontSize:"16",fontWeight:700,children:n.total}),e("tspan",{x:"0",dy:"1.2em",fontSize:"11",fill:"#64748B",children:"réservations"})]})})]}),e(ye,{formatter:(u,c,s)=>{var y;const i=((y=s==null?void 0:s.payload)==null?void 0:y.pct)??0;return[`${u} (${i}%)`,c]},contentStyle:{backgroundColor:"#fff",border:`1px solid ${r.colors.secondary}`,borderRadius:"0.5rem",color:r.colors.primary,boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1)"}}),e(Ke,{verticalAlign:"bottom",align:"center",wrapperStyle:{paddingTop:8,color:r.colors.text},formatter:(u,c)=>{var y,p;const s=((y=c==null?void 0:c.payload)==null?void 0:y.value)??0,i=((p=c==null?void 0:c.payload)==null?void 0:p.pct)??0;return`${u} — ${s} (${i}%)`}})]})})})})]})},We=({trajets:t,isLoading:a})=>{const{company:f}=D(),r=$(f),n=g.useMemo(()=>{var y;const d=p=>(p||"").toLowerCase().trim().normalize("NFD").replace(/[̀-ͯ]/g,"").replace(/\s+/g," "),u=new Map;for(const p of t||[]){const b=d(p.name),N=u.get(b)??{name:p.name,count:0,revenue:0};N.count+=Number(p.count)||0,N.revenue+=Number(p.revenue)||0,u.set(b,N)}const c=[...u.values()].sort((p,b)=>b.count-p.count||b.revenue-p.revenue).slice(0,5),s=((y=c[0])==null?void 0:y.count)??0,i=c.reduce((p,b)=>p+b.count,0);return{rows:c,maxCount:s,totalCount:i}},[t]);return a?e(A,{className:"w-full h-64 rounded-lg"}):o(F,{className:"shadow-md border border-gray-200 bg-white",children:[e(j,{children:e(M,{style:{color:r.colors.primary},children:"Top trajets"})}),e(L,{children:n.rows.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucun trajet pour cette période."}):e("div",{className:"space-y-3",children:n.rows.map((d,u)=>{const c=n.totalCount>0?Math.round(d.count/n.totalCount*100):0,s=n.maxCount>0?Math.max(6,Math.round(d.count/n.maxCount*100)):0;return o("div",{className:"p-3 rounded-lg bg-gray-50 hover:shadow transition",children:[o("div",{className:"flex items-center justify-between",children:[o("div",{className:"flex items-center gap-2 min-w-0",children:[e("span",{className:"shrink-0 inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold",style:{background:r.colors.secondary,color:"#fff"},children:u+1}),e("p",{className:"font-semibold truncate",title:d.name,style:{color:r.colors.primary},children:d.name})]}),o("div",{className:"text-right shrink-0",children:[o("p",{className:"font-bold text-sm sm:text-base",style:{color:r.colors.primary},children:[d.revenue.toLocaleString("fr-FR")," FCFA"]}),o("p",{className:"text-xs text-gray-500",children:[d.count," réservation",d.count>1?"s":""," • ",c,"%"]})]})]}),e("div",{className:"mt-2 h-2 w-full rounded-full bg-white border border-gray-200 overflow-hidden",children:e("div",{className:"h-full",style:{width:`${s}%`,background:r.colors.primary,opacity:.2}})})]},`${d.name}-${u}`)})})})]})},fe=g.forwardRef(({className:t="",variant:a="default",...f},r)=>{const n="inline-block px-2 py-1 text-xs rounded font-medium",d={default:"bg-gray-100 text-gray-800",outline:"border border-gray-300 text-gray-700"}[a];return e("span",{ref:r,className:`${n} ${d} ${t}`,...f})});fe.displayName="Badge";const Xe=({destinations:t,isLoading:a})=>{const{company:f}=D(),r=$(f);return a?e(A,{className:"w-full h-48 rounded-lg"}):o(F,{className:"shadow-md border border-gray-200 bg-white",children:[e(j,{children:e(M,{style:{color:r.colors.primary},children:"Top villes de départ"})}),e(L,{children:e("div",{className:"space-y-3",children:t.map((n,d)=>o("div",{className:"flex items-center justify-between p-3 rounded-lg bg-gray-50 hover:shadow transition",children:[e("div",{className:"flex items-center space-x-3",children:o("span",{className:"font-semibold text-sm",style:{color:r.colors.primary||"#1f2937"},children:[d+1,". ",n.name]})}),o(fe,{className:"px-3 py-1 text-xs font-semibold rounded-md shadow-sm",style:{backgroundColor:r.colors.secondary,color:"#fff"},children:[n.count," réservation",n.count>1?"s":""]})]},n.name))})})]})},Je=({isLoading:t})=>{const{user:a,company:f}=D(),r=$(f),[n,d]=g.useState([]),[u,c]=g.useState(t);return g.useEffect(()=>{if(!(a!=null&&a.companyId)||!(a!=null&&a.agencyId))return;const s=async()=>{c(!0);const y=he(pe,`companies/${a.companyId}/agences/${a.agencyId}/weeklyTrips`),p=await Ae(y),N=new Date().toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase();let v=[];p.forEach(C=>{const h=C.data();h.active&&h.horaires[N]&&h.horaires[N].forEach(k=>{v.push({id:`${C.id}_${k}`,route:`${h.departure} → ${h.arrival}`,heure:k})})}),v=v.filter(C=>{const[h,k]=C.heure.split(":").map(Number),w=new Date;return w.setHours(h,k,0,0),w>=new Date}).sort((C,h)=>C.heure.localeCompare(h.heure)).slice(0,3),d(v),c(!1)};s();const i=setInterval(s,6e4);return()=>clearInterval(i)},[a==null?void 0:a.companyId,a==null?void 0:a.agencyId]),o(F,{className:"shadow-md border border-gray-200 bg-white",children:[e(j,{children:o("div",{className:"flex justify-between items-center",children:[e(M,{style:{color:r.colors.primary},children:"Prochains départs"}),e(Se,{className:"h-5 w-5",style:{color:r.colors.secondary}})]})}),e(L,{children:u?e(A,{className:"h-20 w-full"}):n.length===0?e("p",{className:"text-gray-500 text-center",children:"Aucun départ à venir"}):e("ul",{className:"space-y-2",children:n.map((s,i)=>o("li",{className:`flex justify-between items-center p-3 rounded-lg shadow-sm transition ${i===0?"bg-green-50 border border-green-200":"bg-gray-50 hover:bg-gray-100"}`,children:[e("span",{className:"font-semibold",style:{color:r.colors.primary},children:s.route}),e("span",{className:"text-sm font-medium",style:{color:r.colors.secondary},children:s.heure})]},s.id))})})]})},ie=t=>{const a=new Date(t);return a.setHours(0,0,0,0),a},de=t=>{const a=new Date(t);return a.setHours(23,59,59,999),a},me=(t,a)=>new Date(t,a,1,0,0,0,0),ue=(t,a)=>new Date(t,a+1,0,23,59,59,999),Qe=t=>new Date(t,0,1,0,0,0,0),Ze=t=>new Date(t,11,31,23,59,59,999),et=t=>`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}`,dt=()=>{var re,oe;const{user:t}=D(),a=$(),{id:f}=De(),r=new Date,[n,d]=g.useState("month"),[u,c]=g.useState(r.getMonth()),[s,i]=g.useState(r.getFullYear()),[y,p]=g.useState(""),[b,N]=g.useState(""),[v,C]=g.useState([me(r.getFullYear(),r.getMonth()),ue(r.getFullYear(),r.getMonth())]);g.useEffect(()=>{if(n==="month")C([me(s,u),ue(s,u)]);else if(n==="year")C([Qe(s),Ze(s)]);else{const l=ie(y?new Date(y):r),R=de(b?new Date(b):r);C([l,R])}},[n,u,s,y,b]);const[h,k]=g.useState({sales:0,totalRevenue:0,dailyStats:[],nextDeparture:"—",destinations:[],channels:[],topRoutes:[]}),[w,V]=g.useState(!0),I=g.useRef(),ae=g.useCallback(async(l,R)=>{const z=t==null?void 0:t.companyId,K=f||(t==null?void 0:t.agencyId);if(!z||!K)return;V(!0),I.current&&I.current();const U=Fe(he(pe,"companies",z,"agences",K,"reservations"),te("createdAt",">=",le.fromDate(l)),te("createdAt","<=",le.fromDate(R)),te("statut","==","payé"),Ie("createdAt","asc")),E=Te(U,S=>{const ne=S.docs.map(m=>({id:m.id,...m.data()}));let se=0;const J={online:0,counter:0},Q={},B={},O={};for(const m of ne){se+=m.montant||0;const P=(m.canal||"").toString().toLowerCase().trim().replace(/\s|_|-/g,""),ee=P.includes("ligne")||P==="online"||P==="web"?"online":"counter";J[ee]++;const Y=m.arrivee||"Inconnu";if(Q[Y]=(Q[Y]||0)+1,m.createdAt){const Re=He(m.createdAt),G=et(Re);B[G]||(B[G]={count:0,revenue:0}),B[G].count++,B[G].revenue+=m.montant||0}const ce=`${m.depart||"?"} → ${m.arrivee||"?"}`,_=m.trajetId||ce;O[_]||(O[_]={name:ce,count:0,revenue:0}),O[_].count+=1,O[_].revenue+=m.montant||0}const ve=Object.entries(B).map(([m,x])=>({date:m,reservations:x.count,revenue:x.revenue})).sort((m,x)=>{const[P,Z]=m.date.split("/").map(Number),[ee,Y]=x.date.split("/").map(Number);return Z===Y?P-ee:Z-Y}),we=[{name:"En ligne",value:J.online},{name:"Guichet",value:J.counter}],Ne=Object.entries(O).map(([m,x])=>({id:m,name:x.name,count:x.count,revenue:x.revenue})).sort((m,x)=>x.revenue-m.revenue),Ce=Object.entries(Q).map(([m,x])=>({name:m,count:x})).sort((m,x)=>x.count-m.count);k({sales:ne.length,totalRevenue:se,dailyStats:ve,nextDeparture:"—",destinations:Ce,channels:we,topRoutes:Ne}),V(!1)},S=>{console.error(S),V(!1)});I.current=E},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,f]);g.useEffect(()=>(ae(v[0],v[1]),()=>{I.current&&I.current()}),[ae,v]);const[T,q]=g.useState(1),W=10,X=Math.max(1,Math.ceil(h.topRoutes.length/W));g.useEffect(()=>{q(1)},[h.topRoutes.length]);const be=g.useMemo(()=>{const l=(T-1)*W;return h.topRoutes.slice(l,l+W)},[h.topRoutes,T]),xe=()=>{const l=["Date","Réservations","Revenus"],R=h.dailyStats.map(S=>[S.date,String(S.reservations),String(S.revenue)]),z=[l,...R].map(S=>S.join(";")).join(`
`),K=new Blob([z],{type:"text/csv;charset=utf-8;"}),U=URL.createObjectURL(K),E=document.createElement("a");E.href=U,E.download="dashboard_reservations.csv",E.click(),URL.revokeObjectURL(U)};return e("div",{className:"min-h-screen p-4 md:p-6",style:{backgroundColor:a.colors.background},children:o("div",{className:"max-w-7xl mx-auto space-y-6",children:[o("div",{className:"rounded-xl bg-white shadow-sm border p-4 space-y-4",children:[o("div",{className:"flex items-start justify-between gap-3",children:[o("div",{children:[e("h1",{className:"text-2xl md:text-3xl font-bold",style:{color:a.colors.primary},children:"Tableau de bord • Réservations"}),o("p",{className:"px-3 py-1 rounded-md text-sm font-medium shadow-sm",style:{backgroundColor:`${a.colors.secondary}20`,color:a.colors.primary},children:[t==null?void 0:t.agencyName," • Période ",v[0].toLocaleDateString()," → ",v[1].toLocaleDateString()]})]}),o("button",{onClick:xe,className:"inline-flex items-center gap-2 border rounded-lg px-3 py-2 shadow-sm",style:{borderColor:a.colors.primary,color:a.colors.primary},children:[e($e,{className:"h-5 w-5"})," Exporter"]})]}),o("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[o("div",{className:"flex items-center gap-3",children:[o("label",{className:"flex items-center gap-2 text-sm",children:[e("input",{type:"radio",name:"mode",checked:n==="month",onChange:()=>d("month")})," Mois"]}),o("label",{className:"flex items-center gap-2 text-sm",children:[e("input",{type:"radio",name:"mode",checked:n==="year",onChange:()=>d("year")})," Année"]}),o("label",{className:"flex items-center gap-2 text-sm",children:[e("input",{type:"radio",name:"mode",checked:n==="range",onChange:()=>d("range")})," Période personnalisée"]})]}),n==="month"&&o("div",{className:"flex items-center gap-2",children:[e("select",{className:"border rounded-lg px-3 py-2",value:u,onChange:l=>c(Number(l.target.value)),children:Array.from({length:12}).map((l,R)=>e("option",{value:R,children:new Date(2e3,R,1).toLocaleString("fr-FR",{month:"long"})},R))}),e("input",{className:"border rounded-lg px-3 py-2 w-28",type:"number",value:s,onChange:l=>i(Number(l.target.value))})]}),n==="year"&&e("div",{className:"flex items-center gap-2",children:e("input",{className:"border rounded-lg px-3 py-2 w-28",type:"number",value:s,onChange:l=>i(Number(l.target.value))})}),n==="range"&&o("div",{className:"flex items-center gap-2",children:[e("input",{type:"date",className:"border rounded-lg px-3 py-2",value:y,onChange:l=>p(l.target.value)}),e("span",{className:"text-gray-500",children:"→"}),e("input",{type:"date",className:"border rounded-lg px-3 py-2",value:b,onChange:l=>N(l.target.value)})]})]})]}),o("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[e(H,{title:"Billets vendus",value:h.sales,icon:e(ke,{className:"h-5 w-5",style:{color:a.colors.secondary}}),color:"primary",link:"/agence/reservations",isLoading:w}),e(H,{title:"Revenus totaux",value:h.totalRevenue,icon:e(je,{className:"h-5 w-5",style:{color:a.colors.primary}}),color:"success",isCurrency:!0,isLoading:w}),e(H,{title:"En ligne",value:((re=h.channels.find(l=>l.name==="En ligne"))==null?void 0:re.value)||0,icon:e(Me,{className:"h-5 w-5",style:{color:a.colors.primary}}),color:"info",isLoading:w}),e(H,{title:"Au guichet",value:((oe=h.channels.find(l=>l.name==="Guichet"))==null?void 0:oe.value)||0,icon:e(Le,{className:"h-5 w-5",style:{color:a.colors.secondary}}),color:"warning",isLoading:w})]}),o("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e("div",{className:"lg:col-span-2 p-4 rounded-lg shadow-md bg-white",children:e(Ve,{data:h.dailyStats,isLoading:w})}),e("div",{className:"p-4 rounded-lg shadow-md bg-white",children:e(qe,{data:h.channels,isLoading:w})})]}),o("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e("div",{className:"p-4 rounded-lg shadow-md bg-white",children:e(Je,{isLoading:w})}),e("div",{className:"p-4 rounded-lg shadow-md bg-white",children:e(Xe,{destinations:h.destinations,isLoading:w})}),o("div",{className:"p-4 rounded-lg shadow-md bg-white space-y-3",children:[o("div",{className:"flex items-center justify-between",children:[e("div",{className:"text-lg font-semibold",children:"Top trajets"}),o("div",{className:"text-sm text-gray-600",children:[h.topRoutes.length," lignes • page ",T,"/",X]})]}),e(We,{trajets:be,isLoading:w}),o("div",{className:"flex items-center justify-end gap-2",children:[e("button",{className:"px-3 py-1 rounded border",onClick:()=>q(l=>Math.max(1,l-1)),disabled:T<=1,children:"Préc."}),e("button",{className:"px-3 py-1 rounded border",onClick:()=>q(l=>Math.min(X,l+1)),disabled:T>=X,children:"Suiv."})]})]})]})]})})};export{dt as default};
