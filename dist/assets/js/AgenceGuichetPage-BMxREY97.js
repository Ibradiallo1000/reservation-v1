import{u as ne,r,j as e}from"./react-CdtEOh9s.js";import{h as E,f as S,d as oe,c as ie,T as ce,e as de}from"./firebase-C3aZpI0W.js";import{u as me,d as f}from"../index-BEWNaqTF.js";import"./vendor-D_1n0kdO.js";const ue=30,pe=8,G="compagnie-par-defaut",be=()=>{const{user:i}=me(),I=ne(),[v,H]=r.useState(""),[j,U]=r.useState(""),[O,P]=r.useState(""),[b,Y]=r.useState([]),[V,C]=r.useState([]),[B,W]=r.useState([]),[X,J]=r.useState([]),[t,D]=r.useState(null),[h,K]=r.useState(""),[y,Q]=r.useState(""),[o,A]=r.useState(1),[g,T]=r.useState(0),[m,$]=r.useState("aller_simple"),[k,z]=r.useState(0),[F,Z]=r.useState("espèces"),[M,q]=r.useState(!1),L=Array.from({length:pe},(s,a)=>{const l=new Date;return l.setDate(l.getDate()+a),l.toISOString().split("T")[0]}),N=r.useCallback((s,a)=>{const l=new Date,[x,u]=a.split(":").map(Number),c=new Date(s);return c.setHours(x,u,0,0),c.getTime()<l.getTime()},[]);r.useEffect(()=>{i&&!i.companyId&&(console.error("Aucune compagnie associée à cet utilisateur"),alert("Votre compte n'est associé à aucune compagnie. Contactez l'administrateur."))},[i]),r.useEffect(()=>{(async()=>{try{const l=(await E(S(f,"dailyTrips"))).docs.map(c=>c.data()),x=Array.from(new Set(l.map(c=>c.departure))),u=Array.from(new Set(l.map(c=>c.arrival)));W(x),J(u)}catch(a){console.error("Error loading cities:",a)}})()},[]),r.useEffect(()=>{if(!t){z(0);return}const s=t.price;let a=o*s;m==="aller_retour"&&(a+=g*s),z(a)},[o,g,m,t]);const ee=r.useCallback(async()=>{if(!v||!j){alert("Veuillez sélectionner une ville de départ et une ville d'arrivée");return}try{const s=v.trim().toLowerCase(),a=j.trim().toLowerCase(),u=(await E(S(f,"dailyTrips"))).docs.map(n=>({id:n.id,...n.data()})).filter(n=>{var d,p;return((d=n.departure)==null?void 0:d.toLowerCase())===s&&((p=n.arrival)==null?void 0:p.toLowerCase())===a}),R=(await E(S(f,"reservations"))).docs.map(n=>n.data()),w=u.filter(n=>n.date&&L.includes(n.date)).map(n=>{const d=R.filter(p=>p.trajetId===n.id&&p.statut==="payé").reduce((p,le)=>p+(le.seatsGo||1),0);return{...n,remainingSeats:(n.places||ue)-d}}).filter(n=>!N(n.date,n.time)).sort((n,d)=>new Date(n.date).getTime()-new Date(d.date).getTime());Y(w);const _=w.length>0?w[0].date:"";if(P(_),_){const n=w.filter(d=>d.date===_).sort((d,p)=>d.time.localeCompare(p.time));C(n)}else C([]);D(null)}catch(s){console.error("Error searching trips:",s),alert("Une erreur est survenue lors de la recherche des trajets")}},[v,j,L,N]),se=r.useCallback(s=>{P(s);const a=b.filter(l=>l.date===s&&!N(l.date,l.time)).sort((l,x)=>l.time.localeCompare(x.time));C(a),D(null)},[b,N]),te=r.useCallback(s=>{D(s),A(1),T(0)},[]),ae=r.useCallback(async()=>{if(!t||!h||!y||o<1){alert("Veuillez remplir tous les champs obligatoires");return}if(!(i!=null&&i.companyId)){alert("Votre compte n'est pas associé à une compagnie valide");return}const s=m==="aller_retour"?o+g:o;if(t.remainingSeats!==void 0&&s>t.remainingSeats){alert(`Désolé, il ne reste que ${t.remainingSeats} places disponibles.`);return}q(!0);try{let a=G,l="Compagnie";const x=oe(f,"compagnies",i.companyId),u=await ie(x);u.exists()?(a=u.data().slug||G,l=u.data().nom||"Compagnie"):console.warn(`Compagnie ${i.companyId} non trouvée, utilisation des valeurs par défaut`);const c={trajetId:t.id,nomClient:h,telephone:y,seatsGo:o,seatsReturn:m==="aller_retour"?g:0,date:t.date,heure:t.time,depart:t.departure,arrivee:t.arrival,montant:k,statut:"payé",compagnieId:i.companyId,compagnieNom:l,agencyId:i.agencyId||null,createdAt:ce.now(),canal:"guichet",tripType:m,paiement:F,companySlug:a},R=await de(S(f,"reservations"),c);I(`/agence/receipt/${R.id}`)}catch(a){console.error("Erreur création réservation:",a);let l="Erreur lors de la réservation";a instanceof Error&&(l+=`: ${a.message}`),alert(l)}finally{q(!1)}},[t,h,y,i,o,g,m,k,F,I]),re=Array.from(new Set(b.map(s=>s.date)));return e.jsxs("div",{className:"p-6 grid grid-cols-1 lg:grid-cols-3 gap-6 bg-gray-50 min-h-screen",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("header",{className:"space-y-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"🎛 Guichet – Vente de billets"}),e.jsx("p",{className:"text-gray-600",children:"Recherchez et réservez des billets pour vos clients"})]}),e.jsxs("section",{className:"bg-white p-4 rounded-xl shadow",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3 text-gray-800",children:"🔍 Rechercher un trajet"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"departure",className:"block text-sm font-medium text-gray-700 mb-1",children:"Départ"}),e.jsx("input",{id:"departure",list:"depList",value:v,onChange:s=>H(s.target.value),placeholder:"Ville de départ",className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"}),e.jsx("datalist",{id:"depList",children:B.map(s=>e.jsx("option",{value:s},`dep-${s}`))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"arrival",className:"block text-sm font-medium text-gray-700 mb-1",children:"Arrivée"}),e.jsx("input",{id:"arrival",list:"arrList",value:j,onChange:s=>U(s.target.value),placeholder:"Ville d'arrivée",className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"}),e.jsx("datalist",{id:"arrList",children:X.map(s=>e.jsx("option",{value:s},`arr-${s}`))})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:ee,className:"w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium px-4 py-2 rounded transition-colors duration-200",children:"Rechercher"})})]})]}),b.length>0&&e.jsxs("section",{className:"bg-white p-4 rounded-xl shadow",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3 text-gray-800",children:"📅 Dates disponibles"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:L.map(s=>{const a=re.includes(s),l=O===s;return e.jsx("button",{onClick:()=>a&&se(s),className:`px-3 py-1 rounded-full text-sm border shadow-sm transition-colors duration-200 ${l?"bg-yellow-600 text-white border-yellow-700":a?"bg-yellow-100 text-yellow-700 border-yellow-200 hover:bg-yellow-200":"bg-gray-100 text-gray-500 border-gray-200 cursor-not-allowed"}`,disabled:!a,title:a?`Voir les trajets pour le ${s}`:"Date non disponible",children:new Date(s).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})},s)})})]}),e.jsxs("section",{className:"bg-white p-4 rounded-xl shadow",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3 text-gray-800",children:"🕒 Horaires disponibles"}),V.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500",children:b.length===0?"Aucun trajet trouvé. Veuillez effectuer une recherche.":"Aucun horaire disponible pour cette date."})}):e.jsx("ul",{className:"divide-y divide-gray-200",children:V.map(s=>e.jsx("li",{onClick:()=>te(s),className:`py-3 px-2 cursor-pointer transition-colors duration-200 ${(t==null?void 0:t.id)===s.id?"bg-yellow-100 border-l-4 border-yellow-500":"hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-bold",children:[e.jsx("span",{className:"text-lg",children:s.time})," — ",s.departure," → ",s.arrival]}),e.jsx("p",{className:"text-sm text-gray-600",children:new Date(s.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-yellow-700",children:[s.price.toLocaleString("fr-FR")," FCFA"]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[s.remainingSeats??"NC"," places restantes"]})]})]})},s.id))})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow space-y-4 sticky top-6 h-fit",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"🧍‍♂️ Détails du passager"}),t?e.jsxs("div",{className:"text-sm text-gray-700 bg-yellow-50 rounded-lg border-l-4 border-yellow-500 p-3 space-y-1",children:[e.jsxs("p",{className:"font-medium",children:[t.departure," → ",t.arrival]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(t.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Heure:"})," ",t.time]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Prix unitaire:"})," ",t.price.toLocaleString("fr-FR")," FCFA"]}),t.remainingSeats!==void 0&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Places restantes:"})," ",t.remainingSeats]})]}):e.jsx("div",{className:"text-center py-4 bg-gray-50 rounded-lg text-gray-500",children:"Sélectionnez un trajet pour continuer"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>$("aller_simple"),className:`flex-1 py-2 rounded transition-colors duration-200 ${m==="aller_simple"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Aller simple"}),e.jsx("button",{onClick:()=>$("aller_retour"),className:`flex-1 py-2 rounded transition-colors duration-200 ${m==="aller_retour"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Aller-retour"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Nom complet du passager*"}),e.jsx("input",{type:"text",value:h,onChange:s=>K(s.target.value),className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Numéro de téléphone*"}),e.jsx("input",{type:"tel",value:y,onChange:s=>Q(s.target.value),className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Nombre de places (Aller)*"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>A(s=>Math.max(1,s-1)),className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-200",disabled:!t,children:"-"}),e.jsx("span",{className:"w-8 text-center",children:o}),e.jsx("button",{onClick:()=>A(s=>s+1),className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-200",disabled:!t||t.remainingSeats!==void 0&&o>=t.remainingSeats,children:"+"})]})]}),m==="aller_retour"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Nombre de places (Retour)"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>T(s=>Math.max(0,s-1)),className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-200",disabled:!t,children:"-"}),e.jsx("span",{className:"w-8 text-center",children:g}),e.jsx("button",{onClick:()=>T(s=>s+1),className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-200",disabled:!t||t.remainingSeats!==void 0&&o+g>=t.remainingSeats,children:"+"})]})]}),e.jsxs("div",{className:"pt-2 border-t border-gray-200 space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Total à payer"}),e.jsxs("span",{className:"text-xl font-bold text-green-600",children:[k.toLocaleString("fr-FR")," FCFA"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Mode de paiement"}),e.jsxs("select",{value:F,onChange:s=>Z(s.target.value),className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"espèces",children:"Espèces"}),e.jsx("option",{value:"mobile_money",children:"Mobile Money"})]})]})]}),e.jsx("button",{onClick:ae,disabled:!t||!h||!y||o<1||M,className:`w-full py-3 px-4 rounded font-semibold transition-colors duration-200 flex items-center justify-center ${!t||!h||!y||o<1?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-green-600 hover:bg-green-700 text-white"}`,children:M?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Traitement..."]}):"✅ Valider la réservation"})]})]})};export{be as default};
