import{b as ga,r as d,a as n,j as e,O as ua,J as ha,M as pa,bn as ut,bo as fa,ae as kt,af as Se,a0 as ht,_ as ba,T as pt,b9 as Ye,bj as Rt,bp as Ke,bq as ft,br as Dt,b7 as Je,b8 as ya,V as Tt,y as jt,a5 as xa,F as Mt,a1 as Lt,Q as va,p as Na,a6 as wa}from"./react-KXT1Riez.js";import{q as xe,o as V,t as W,D as Ft,r as le,w as ne,u as me,H as Bt,T as se,y as bt,E as ve,I as Ca,F as Aa}from"./firebase-DYTOaTLw.js";import{u as Ia,c as Sa,d as E}from"../index-b0dmvJTQ.js";import"./vendor-B27hBV_J.js";const A=p=>`${(p||0).toLocaleString("fr-FR")} FCFA`,$a=p=>new Date(p.getFullYear(),p.getMonth(),1,0,0,0,0),Ea=p=>new Date(p.getFullYear(),p.getMonth()+1,1,0,0,0,0),We=p=>p?p.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—",ka=p=>p?new Date(p).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}):"—",qa=()=>{var $t;console.log("[AgenceCompta] Initialisation de la page de comptabilité");const p=ga(),{user:t,company:I,logout:T}=Ia(),l=Sa(I)||{primary:"#EA580C",secondary:"#F97316"},[U,X]=d.useState(null),[z,L]=d.useState("Compagnie"),[Re,Qe]=d.useState("Agence"),[q,B]=d.useState("controle"),[$,Xe]=d.useState(null),[Z,De]=d.useState("ACCOUNT"),[we,Te]=d.useState([]),[P,je]=d.useState([]),[J,Ot]=d.useState([]),[re,qt]=d.useState([]),[Me,Pt]=d.useState([]),[Ta,ja]=d.useState(10),[ee,xt]=d.useState([]),[Vt,vt]=d.useState(!1),[Ze,Gt]=d.useState(""),[Le,Nt]=d.useState(0),[ue,et]=d.useState("all"),[tt,wt]=d.useState({}),[Fe,at]=d.useState({}),[he,_t]=d.useState({}),[Be,Ut]=d.useState({}),oe=d.useRef({}),[nt,zt]=d.useState({}),[Oe,Ht]=d.useState(!1),[st,Yt]=d.useState(()=>{const a=new Date;return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`}),[qe,Kt]=d.useState(""),[Pe,Jt]=d.useState(""),[pe,Wt]=d.useState([]),[Ce,Qt]=d.useState(0),[Ae,Xt]=d.useState(0),[rt,Ct]=d.useState(!1),[y,Zt]=d.useState(null),[ot,At]=d.useState(!1),[fe,ea]=d.useState(()=>new Date().toISOString().split("T")[0]),[ta,Ve]=d.useState(!1),[O,ce]=d.useState({kind:"depense",montant:"",libelle:"",banque:"",note:""});d.useEffect(()=>{console.log("[AgenceCompta] Chargement des données header et profil"),(async()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)){console.warn("[AgenceCompta] Données utilisateur incomplètes");return}try{const a=await xe(V(E,"companies",t.companyId));if(a.exists()){const r=a.data();X(r.logoUrl||r.logo||null),L(r.nom||r.name||"Compagnie"),console.log(`[AgenceCompta] Compagnie chargée: ${r.nom||r.name}`)}const s=await xe(V(E,`companies/${t.companyId}/agences/${t.agencyId}`));if(s.exists()){const r=s.data(),i=(r==null?void 0:r.ville)||(r==null?void 0:r.city)||(r==null?void 0:r.nomVille)||(r==null?void 0:r.villeDepart)||"";Qe((r==null?void 0:r.nomAgence)||(r==null?void 0:r.nom)||i||"Agence"),console.log(`[AgenceCompta] Agence chargée: ${(r==null?void 0:r.nomAgence)||(r==null?void 0:r.nom)||i}`)}const m=await xe(V(E,"users",t.uid));if(m.exists()){const r=m.data(),i={id:t.uid,displayName:r.displayName||t.displayName||"",email:r.email||t.email||"",staffCode:r.staffCode,codeCourt:r.codeCourt,code:r.code};Xe(i),De(r.staffCode||r.codeCourt||r.code||"ACCOUNT"),console.log(`[AgenceCompta] Comptable identifié: ${i.displayName} (${Z})`)}}catch(a){console.error("[AgenceCompta] Erreur lors du chargement des données:",a)}})().catch(console.error)},[t==null?void 0:t.uid,t==null?void 0:t.companyId,t==null?void 0:t.agencyId]);const aa=(a,s)=>({id:a,userId:s.userId||s.openedById||"",userName:s.userName||s.openedByName||s.userEmail||"",userEmail:s.userEmail||"",userCode:s.userCode||s.openedByCode||"",companyId:s.companyId,agencyId:s.agencyId,status:s.status,startTime:s.startTime||s.openedAt,endTime:s.endTime||s.closedAt,totalTickets:s.totalTickets,totalReservations:s.totalReservations,totalAmount:s.totalAmount,payBy:s.payBy,accountantId:s.accountantId,accountantCode:s.accountantCode,accountantName:s.accountantName,validatedAt:s.validatedAt,cashExpected:s.cashExpected,cashReceived:s.cashReceived,mmExpected:s.mmExpected,mmReceived:s.mmReceived,comptable:s.comptable});d.useEffect(()=>{if(console.log("[AgenceCompta] Démarrage de l'écoute des postes"),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)){console.warn("[AgenceCompta] Abandon de l'écoute - IDs manquants");return}const a=W(E,`companies/${t.companyId}/agences/${t.agencyId}/shifts`),s=Ft(a,async m=>{console.log(`[AgenceCompta] Mise à jour des postes: ${m.docs.length} document(s)`);const r=m.docs.map(o=>aa(o.id,o.data())),i=Array.from(new Set(r.map(o=>o.userId).filter(o=>!!o&&!he[o])));if(i.length){console.log(`[AgenceCompta] Chargement de ${i.length} utilisateur(s) manquant(s)`);const o=await Promise.all(i.map(async c=>{const u=await xe(V(E,"users",c));if(!u.exists())return[c,{}];const f=u.data();return[c,{name:f.displayName||f.nom||f.email||"",email:f.email||"",code:f.staffCode||f.codeCourt||f.code||""}]}));_t(c=>Object.fromEntries([...Object.entries(c),...o]))}const h=o=>{var c,u,f,N,b,w;return(((u=(c=o.validatedAt)==null?void 0:c.toMillis)==null?void 0:u.call(c))??0)||(((N=(f=o.endTime)==null?void 0:f.toMillis)==null?void 0:N.call(f))??0)||(((w=(b=o.startTime)==null?void 0:b.toMillis)==null?void 0:w.call(b))??0)};Te(r.filter(o=>o.status==="pending").sort((o,c)=>h(c)-h(o))),je(r.filter(o=>o.status==="active").sort((o,c)=>h(c)-h(o))),Ot(r.filter(o=>o.status==="paused").sort((o,c)=>h(c)-h(o))),qt(r.filter(o=>o.status==="closed").sort((o,c)=>h(c)-h(o))),Pt(r.filter(o=>o.status==="validated").sort((o,c)=>h(c)-h(o))),console.log("[AgenceCompta] Postes mis à jour:",{pending:r.filter(o=>o.status==="pending").length,active:r.filter(o=>o.status==="active").length,paused:r.filter(o=>o.status==="paused").length,closed:r.filter(o=>o.status==="closed").length,validated:r.filter(o=>o.status==="validated").length})});return()=>{console.log("[AgenceCompta] Arrêt de l'écoute des postes"),s()}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),d.useEffect(()=>{var s,m;if(console.log("[AgenceCompta] Mise à jour des statistiques live"),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const a=W(E,`companies/${t.companyId}/agences/${t.agencyId}/reservations`);for(const r of Object.keys(oe.current))!![...P,...J].find(h=>h.id===r)||(console.log(`[AgenceCompta] Arrêt de l'écoute pour le poste ${r}`),(m=(s=oe.current)[r])==null||m.call(s),delete oe.current[r]);for(const r of[...P,...J]){if(oe.current[r.id])continue;console.log(`[AgenceCompta] Démarrage de l'écoute pour le poste ${r.id}`);const i=le(a,ne("shiftId","==",r.id)),h=Ft(i,o=>{let c=0,u=0,f=0;o.forEach(N=>{const b=N.data();c+=1,u+=(b.seatsGo||0)+(b.seatsReturn||0),f+=b.montant||0}),Ut(N=>({...N,[r.id]:{reservations:c,tickets:u,amount:f}}))});oe.current[r.id]=h}return()=>{var r,i;console.log("[AgenceCompta] Nettoyage des écouteurs live");for(const h of Object.keys(oe.current))(i=(r=oe.current)[h])==null||i.call(r);oe.current={}}},[P,J,t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),d.useEffect(()=>{console.log("[AgenceCompta] Calcul des agrégats pour réceptions"),(async()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const a=W(E,`companies/${t.companyId}/agences/${t.agencyId}/reservations`),s={};console.log(`[AgenceCompta] ${re.length} poste(s) clôturé(s) à analyser`);for(const m of re){const r=await me(le(a,ne("shiftId","==",m.id)));let i=0,h=0,o=0,c=0,u=0,f=0;r.forEach(N=>{const b=N.data();i+=1,h+=(b.seatsGo||0)+(b.seatsReturn||0),o+=b.montant||0;const w=String(b.paiement||"").toLowerCase(),C=String(b.canal||"").toLowerCase();C==="guichet"||C===""?(w.includes("esp")&&(c+=b.montant||0),(w.includes("mobile")||w.includes("mm"))&&(u+=b.montant||0)):C==="en_ligne"&&(f+=b.montant||0)}),s[m.id]={reservations:i,tickets:h,amount:o,cashExpected:c,mmExpected:u,onlineAmount:f}}zt(s),console.log("[AgenceCompta] Agrégats calculés:",Object.keys(s).length)})().catch(a=>console.error("[AgenceCompta] Erreur agrégats réceptions:",a))},[re,t==null?void 0:t.companyId,t==null?void 0:t.agencyId]);const na=d.useCallback(async a=>{if(console.log(`[AgenceCompta] Activation du poste ${a}`),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!$){console.warn("[AgenceCompta] Données manquantes pour l'activation");return}const s=`companies/${t.companyId}/agences/${t.agencyId}`,m=V(E,`${s}/shifts/${a}`),r=V(E,`${s}/shiftReports/${a}`);try{await Bt(E,async i=>{const h=await i.get(m);if(!h.exists())throw new Error("Poste introuvable");const o=h.data(),c=se.now(),u=o.startTime||o.openedAt||c;i.update(m,{status:"active",startTime:o.startTime??c}),i.set(r,{companyId:t.companyId,agencyId:t.agencyId,userId:o.userId||o.openedById||"",userName:o.userName||o.userEmail||"",userCode:o.userCode||o.openedByCode||"",startAt:u,updatedAt:c},{merge:!0})}),console.log(`[AgenceCompta] Poste ${a} activé avec succès`)}catch(i){console.error(`[AgenceCompta] Erreur lors de l'activation du poste ${a}:`,i),alert("Erreur lors de l'activation du poste")}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,$]),sa=d.useCallback(async a=>{if(console.log(`[AgenceCompta] Mise en pause du poste ${a}`),!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)))try{await bt(V(E,`companies/${t.companyId}/agences/${t.agencyId}/shifts/${a}`),{status:"paused"}),console.log(`[AgenceCompta] Poste ${a} mis en pause`)}catch(s){console.error(`[AgenceCompta] Erreur lors de la pause du poste ${a}:`,s)}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),ra=d.useCallback(async a=>{if(console.log(`[AgenceCompta] Reprise du poste ${a}`),!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)))try{await bt(V(E,`companies/${t.companyId}/agences/${t.agencyId}/shifts/${a}`),{status:"active"}),console.log(`[AgenceCompta] Poste ${a} repris`)}catch(s){console.error(`[AgenceCompta] Erreur lors de la reprise du poste ${a}:`,s)}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),It=d.useCallback(async(a,s)=>{var h,o,c,u;if(console.log(`[AgenceCompta] Clôture du poste ${a}`,s),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const m=`companies/${t.companyId}/agences/${t.agencyId}`,r=V(E,`${m}/shifts/${a}`),i=W(E,`${m}/reservations`);try{const f=await xe(r);if(!f.exists()){console.warn(`[AgenceCompta] Poste ${a} introuvable`),alert("Poste introuvable");return}const N=f.data(),b=se.now();if(console.log(`[AgenceCompta] Mise à jour du statut du poste ${a} en 'closed'`),await bt(r,{status:"closed",endTime:b}),!(s!=null&&s.forcedByAccountant))return;const w=((o=(h=N.startTime)==null?void 0:h.toDate)==null?void 0:o.call(h))??((u=(c=N.openedAt)==null?void 0:c.toDate)==null?void 0:u.call(c))??new Date,C=b.toDate(),S=new Date(w.getTime()-5*60*1e3),x=new Date(C.getTime()+6*60*60*1e3),R=N.userId||N.openedById||"",v=N.userCode||N.openedByCode||"",k=le(i,ne("createdAt",">=",se.fromDate(S)),ne("createdAt","<=",se.fromDate(x)),ve("createdAt","asc")),G=(await me(k)).docs.filter(Y=>{const K=Y.data();if(K.shiftId)return!1;const Ie=String(K.canal||"").toLowerCase(),ct=Ie==="guichet"||Ie===""&&String(K.paiement||"").toLowerCase().includes("esp"),_e=!!R&&K.guichetierId===R||!!v&&K.guichetierCode===v;return ct&&_e});if(G.length){console.log(`[AgenceCompta] Rattachement de ${G.length} transaction(s) au poste ${a}`);const Y=Ca(E);G.forEach(K=>Y.update(K.ref,{shiftId:a})),await Y.commit()}console.log(`[AgenceCompta] Poste ${a} clôturé avec succès`)}catch(f){console.error(`[AgenceCompta] Erreur lors de la clôture du poste ${a}:`,f),alert("Erreur lors de la clôture du poste")}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),oa=(a,s)=>wt(m=>({...m,[a]:{cashReceived:s}})),ia=d.useCallback(async a=>{var C,S;if(console.log(`[AgenceCompta] Validation de la réception pour le poste ${a.id}`),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!$){console.warn("[AgenceCompta] Données manquantes pour la validation");return}if(Fe[a.id]){console.log(`[AgenceCompta] Validation déjà en cours pour le poste ${a.id}`);return}at(x=>({...x,[a.id]:!0}));const s=tt[a.id]||{cashReceived:"0"},r=(x=>{const R=(x||"").replace(/[^\d.,]/g,"").replace(",","."),v=Number(R);return Number.isFinite(v)&&v>=0?v:NaN})(s.cashReceived||"");if(!Number.isFinite(r)){console.warn(`[AgenceCompta] Montant invalide: ${s.cashReceived}`),alert("Montant espèces reçu invalide."),at(x=>({...x,[a.id]:!1}));return}const i=0,h=V(E,`companies/${t.companyId}/agences/${t.agencyId}/shifts/${a.id}`),o=W(E,`companies/${t.companyId}/agences/${t.agencyId}/cashReceipts`),c=V(E,`companies/${t.companyId}/agences/${t.agencyId}/shiftReports/${a.id}`),u=nt[a.id],f=(u==null?void 0:u.cashExpected)??a.cashExpected??((C=a.payBy)==null?void 0:C.espèces)??0,N=(u==null?void 0:u.mmExpected)??a.mmExpected??((S=a.payBy)==null?void 0:S.mobile_money)??0,b=V(o),w=b.id;try{await Bt(E,async x=>{const R=await x.get(h);if(!R.exists())throw new Error("Poste introuvable.");const v=R.data();if(v.status!=="closed"&&v.status!=="validated")throw new Error("Seuls les postes clôturés peuvent être validés.");const k=se.now(),H=v.startTime||v.openedAt||k,G=v.endTime||k,Y={shiftId:a.id,userId:a.userId,userCode:a.userCode||"",companyId:t.companyId,agencyId:t.agencyId,totalAmount:(u==null?void 0:u.amount)??(v.totalAmount||0),cashExpected:f||0,cashReceived:r,mmExpected:N||0,mmReceived:i,onlineAmount:(u==null?void 0:u.onlineAmount)||0,accountantId:$.id,accountantName:$.displayName||$.email||"",accountantCode:Z,createdAt:k,type:"reception_caisse",note:"Réception espèces validée."};x.set(b,Y),x.update(h,{status:"closed",endTime:G,accountantId:$.id,accountantName:$.displayName||$.email||"",accountantCode:Z,validatedAt:k,cashReceived:r,mmReceived:i,cashExpected:f||0,mmExpected:N||0,comptable:{...v.comptable||{},validated:!0,at:k,by:{id:$.id,name:$.displayName||$.email||""},note:"Réception espèces validée (comptabilité)"}}),x.set(c,{startAt:H,endAt:G,accountantValidated:!0,accountantValidatedAt:k,cashExpected:f||0,cashReceived:r,mmExpected:N||0,mmReceived:i,onlineAmount:(u==null?void 0:u.onlineAmount)||0,accountantStamp:{by:{id:$.id,code:Z,name:$.displayName||$.email||""},at:k,note:"Réception espèces validée (comptabilité)"},updatedAt:k},{merge:!0})}),wt(x=>({...x,[a.id]:{cashReceived:""}})),console.log(`[AgenceCompta] Réception validée pour le poste ${a.id}, reçu ${w}`),alert("Réception enregistrée ✓"),w&&p(`/agence/receipt/${w}`)}catch(x){console.error(`[AgenceCompta] Erreur lors de la validation du poste ${a.id}:`,x),alert((x==null?void 0:x.message)||"Erreur lors de la validation.")}finally{at(x=>({...x,[a.id]:!1}))}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,$,Z,tt,nt,p,Fe]),St=d.useCallback(async a=>{var s,m,r,i,h,o,c,u,f,N,b,w;if(console.log(`[AgenceCompta] Chargement du rapport pour le poste ${a}`),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!a){console.log("[AgenceCompta] Données manquantes pour le rapport"),xt([]),Nt(0);return}vt(!0),Gt(a);try{const C=`companies/${t.companyId}/agences/${t.agencyId}`,S=W(E,`${C}/reservations`),x=V(E,`${C}/shifts/${a}`),R=await xe(x),v=R.exists()?R.data():{},k=((m=(s=v.startTime)==null?void 0:s.toDate)==null?void 0:m.call(s))??((i=(r=v.openedAt)==null?void 0:r.toDate)==null?void 0:i.call(r))??null,H=((o=(h=v.endTime)==null?void 0:h.toDate)==null?void 0:o.call(h))??((u=(c=v.closedAt)==null?void 0:c.toDate)==null?void 0:u.call(c))??null,G=v.userId||v.openedById||"",Y=v.userCode||v.openedByCode||"",K=k?new Date(k.getTime()-5*60*1e3):null,Ie=H?new Date(H.getTime()+6*60*60*1e3):null,ct=await me(le(S,ne("shiftId","==",a),ve("createdAt","asc")));let _e=[];K&&Ie&&(_e=(await me(le(S,ne("createdAt",">=",se.fromDate(K)),ve("createdAt","asc")))).docs.filter(D=>{var He,Et;const M=D.data(),te=((Et=(He=M.createdAt)==null?void 0:He.toDate)==null?void 0:Et.call(He))??new Date(0),ae=te>=K&&te<=Ie,ye=String(M.canal||"").toLowerCase();if(ye==="guichet"||ye===""){const mt=!!G&&M.guichetierId===G||!!Y&&M.guichetierCode===Y,gt=!M.shiftId||M.shiftId==="";return ae&&mt&&gt}if(ye==="en_ligne"){const mt=M.agencyId===t.agencyId,gt=!M.shiftId||M.shiftId==="";return ae&&mt&&gt}return!1}));const da=j=>{const D=j.data(),M=String(D.canal||"").toLowerCase(),te=M==="guichet"||M===""?"agence":"compagnie";return{id:j.id,referenceCode:D.referenceCode,date:D.date,heure:D.heure,depart:D.depart,arrivee:D.arrivee,nomClient:D.nomClient,telephone:D.telephone,seatsGo:D.seatsGo||1,seatsReturn:D.seatsReturn||0,montant:D.montant||0,paiement:D.paiement,createdAt:D.createdAt,guichetierCode:D.guichetierCode||"",canal:D.canal,encaissement:te}},dt=[...ct.docs,..._e].map(da),de=j=>String(j||"").normalize("NFKC").replace(/\s+/g," ").trim().toLowerCase(),ma=j=>j.referenceCode&&de(j.referenceCode)||[de(j.date),de(j.heure),de(j.depart),de(j.arrivee),de(j.nomClient),de(j.telephone)].join("|"),Ue=new Map;for(const j of dt){const D=ma(j),M=Ue.get(D);if(!M)Ue.set(D,j);else{const te=((N=(f=M.createdAt)==null?void 0:f.toMillis)==null?void 0:N.call(f))??0,ae=((w=(b=j.createdAt)==null?void 0:b.toMillis)==null?void 0:w.call(b))??0;Ue.set(D,ae>=te?j:M)}}const ze=[...Ue.values()].sort((j,D)=>{var M,te,ae,ye;return(((te=(M=j.createdAt)==null?void 0:M.toMillis)==null?void 0:te.call(M))??0)-(((ye=(ae=D.createdAt)==null?void 0:ae.toMillis)==null?void 0:ye.call(ae))??0)});xt(ze),Nt(dt.length-ze.length),console.log(`[AgenceCompta] Rapport chargé: ${ze.length} ligne(s), ${dt.length-ze.length} doublon(s) éliminé(s)`)}catch(C){console.error("[AgenceCompta] Erreur lors du chargement du rapport:",C),alert("Erreur lors du chargement du rapport")}finally{vt(!1)}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),be=d.useMemo(()=>{const a={billets:0,montant:0,guichet:{billets:0,montant:0},en_ligne:{billets:0,montant:0}};for(const s of ee){const m=(s.seatsGo||0)+(s.seatsReturn||0);a.billets+=m,a.montant+=s.montant||0,s.canal==="guichet"||s.canal===""?(a.guichet.billets+=m,a.guichet.montant+=s.montant||0):s.canal==="en_ligne"&&(a.en_ligne.billets+=m,a.en_ligne.montant+=s.montant||0)}return a},[ee]),it=d.useMemo(()=>{let a=0,s=0,m=0;for(const r of[...P,...J]){const i=Be[r.id];i&&(a+=i.reservations,s+=i.tickets,m+=i.amount)}return console.log("[AgenceCompta] Totaux globaux live:",{reservations:a,tickets:s,amount:m}),{reservations:a,tickets:s,amount:m}},[P,J,Be]),ie=d.useMemo(()=>{if(Oe&&qe&&Pe){const r=new Date(qe);r.setHours(0,0,0,0);const i=new Date(Pe);return i.setHours(24,0,0,0),{from:r,to:i}}const[a,s]=st.split("-").map(Number),m=new Date(a,(s||1)-1,1);return{from:$a(m),to:Ea(m)}},[Oe,qe,Pe,st]),Ge=d.useCallback(async()=>{if(console.log("[AgenceCompta] Chargement des données de caisse",ie),!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))){Ct(!0);try{const a=W(E,`companies/${t.companyId}/agences/${t.agencyId}/cashReceipts`),s=W(E,`companies/${t.companyId}/agences/${t.agencyId}/cashMovements`),m=le(a,ne("createdAt",">=",se.fromDate(ie.from)),ve("createdAt","asc")),r=le(s,ne("createdAt",">=",se.fromDate(ie.from)),ve("createdAt","asc")),[i,h]=await Promise.all([me(m),me(r)]),o={};i.forEach(w=>{var v,k;const C=w.data(),S=((k=(v=C.createdAt)==null?void 0:v.toDate)==null?void 0:k.call(v))??new Date;if(S<ie.from||S>=ie.to)return;const x=S.toISOString().split("T")[0],R=Number(C.cashReceived||0);o[x]||(o[x]={in:0,out:0}),o[x].in+=Math.max(0,R)}),h.forEach(w=>{var k,H;const C=w.data(),S=((H=(k=C.createdAt)==null?void 0:k.toDate)==null?void 0:H.call(k))??new Date;if(S<ie.from||S>=ie.to)return;const x=S.toISOString().split("T")[0],R=String(C.kind||""),v=Number(C.amount||0);o[x]||(o[x]={in:0,out:0}),R==="depense"||R==="transfert_banque"?o[x].out+=Math.max(0,v):R==="entree_manual"&&(o[x].in+=Math.max(0,v))});const c=Object.keys(o).sort();let u=0;const f=[];let N=0,b=0;for(const w of c){const C=o[w].in||0,S=o[w].out||0;C===0&&S===0||(u+=C-S,N+=C,b+=S,f.push({dateISO:w,entrees:C,sorties:S,solde:u}))}Wt(f),Qt(N),Xt(b),console.log("[AgenceCompta] Données de caisse chargées:",{jours:f.length,entrées:N,sorties:b,solde:N-b})}catch(a){console.error("[AgenceCompta] Erreur lors du chargement de la caisse:",a),alert("Erreur lors du chargement des données de caisse")}finally{Ct(!1)}}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,ie]);d.useEffect(()=>{console.log("[AgenceCompta] Déclenchement du chargement de la caisse"),Ge()},[Ge]);const lt=d.useCallback(async()=>{if(console.log("[AgenceCompta] Chargement des données de réconciliation pour",fe),!(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))){At(!0);try{const a=new Date(fe),s=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0,0),m=new Date(a.getFullYear(),a.getMonth(),a.getDate(),23,59,59,999),r=W(E,`companies/${t.companyId}/agences/${t.agencyId}/reservations`),i=le(r,ne("date","==",fe),ve("createdAt","asc")),h=await me(i);let o={reservations:0,tickets:0,montant:0},c={reservations:0,tickets:0,montant:0},u=0,f=0;h.forEach(w=>{const C=w.data(),S=String(C.canal||"").toLowerCase(),x=String(C.paiement||"").toLowerCase(),R=C.montant||0,v=(C.seatsGo||0)+(C.seatsReturn||0);S==="guichet"||S===""?(o.reservations+=1,o.tickets+=v,o.montant+=R,x.includes("esp")&&(u+=R),(x.includes("mobile")||x.includes("mm"))&&(f+=R)):S==="en_ligne"&&(c.reservations+=1,c.tickets+=v,c.montant+=R)});const N=u+f,b=o.montant-N;Zt({ventesGuichet:o,ventesEnLigne:c,encaissementsEspeces:u,encaissementsMobileMoney:f,encaissementsTotal:N,ecart:b}),console.log("[AgenceCompta] Réconciliation calculée:",{ventesGuichet:o,ventesEnLigne:c,encaissementsTotal:N,ecart:b})}catch(a){console.error("[AgenceCompta] Erreur lors du chargement de la réconciliation:",a),alert("Erreur lors du chargement de la réconciliation")}finally{At(!1)}}},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,fe]);d.useEffect(()=>{q==="reconciliation"&&lt()},[q,fe,lt]);const la=async()=>{if(console.log("[AgenceCompta] Création d'un nouveau mouvement de sortie",O),!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))return;const a=Number(O.montant||0);if(!Number.isFinite(a)||a<=0){console.warn("[AgenceCompta] Montant invalide pour le mouvement"),alert("Montant invalide");return}try{const s={kind:O.kind,amount:a,label:O.libelle||(O.kind==="transfert_banque"?"Transfert vers banque":"Dépense"),bankName:O.kind==="transfert_banque"&&O.banque||"",note:O.note||"",companyId:t.companyId,agencyId:t.agencyId,accountantId:($==null?void 0:$.id)||null,accountantCode:Z,createdAt:se.now()};await Aa(W(E,`companies/${t.companyId}/agences/${t.agencyId}/cashMovements`),s),console.log("[AgenceCompta] Mouvement de sortie enregistré avec succès"),Ve(!1),ce({kind:"depense",montant:"",libelle:"",banque:"",note:""}),await Ge()}catch(s){console.error("[AgenceCompta] Erreur lors de l'enregistrement du mouvement:",s),alert("Erreur lors de l'enregistrement du mouvement")}},ca=d.useCallback(a=>[...P,...J,...re,...Me].find(s=>s.id===a),[P,J,re,Me]);return n("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100",children:[e("div",{className:"sticky top-0 z-10 border-b bg-white/95 backdrop-blur-sm supports-[backdrop-filter]:bg-white/90 shadow-sm",children:e("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 py-4",children:n("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e("div",{className:"flex items-center gap-4",children:n("div",{className:"flex items-center gap-3",children:[U?n("div",{className:"relative",children:[e("img",{src:U,alt:"Logo compagnie",className:"h-12 w-12 rounded-xl object-contain border-2 border-white shadow-md"}),e("div",{className:"absolute -bottom-1 -right-1 h-5 w-5 bg-gradient-to-br from-emerald-500 to-cyan-500 rounded-full border border-white flex items-center justify-center",children:e(ua,{className:"h-3 w-3 text-white"})})]}):e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-white shadow-md grid place-items-center",children:e(ha,{className:"h-6 w-6 text-gray-600"})}),n("div",{className:"min-w-0",children:[e("div",{className:"text-xl font-bold tracking-tight truncate bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent",title:z,children:z}),n("div",{className:"text-sm text-gray-600 flex items-center gap-1.5 truncate",children:[e(pa,{className:"h-4 w-4 flex-shrink-0"}),e("span",{className:"truncate",children:Re}),e("span",{className:"text-xs px-2 py-0.5 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 rounded-full",children:"Comptabilité"})]})]})]})}),e("div",{className:"w-full sm:w-auto",children:n("div",{className:"inline-flex rounded-2xl p-1.5 bg-gradient-to-r from-slate-100 to-slate-50 shadow-inner w-full sm:w-auto",children:[e($e,{active:q==="controle",onClick:()=>B("controle"),label:"Contrôle",icon:e(ut,{className:"h-4 w-4"}),theme:l}),e($e,{active:q==="receptions",onClick:()=>B("receptions"),label:"Réceptions",icon:e(fa,{className:"h-4 w-4"}),theme:l}),e($e,{active:q==="rapports",onClick:()=>B("rapports"),label:"Rapports",icon:e(kt,{className:"h-4 w-4"}),theme:l}),e($e,{active:q==="caisse",onClick:()=>B("caisse"),label:"Caisse",icon:e(Se,{className:"h-4 w-4"}),theme:l}),e($e,{active:q==="reconciliation",onClick:()=>B("reconciliation"),label:"Réconciliation",icon:e(ht,{className:"h-4 w-4"}),theme:l})]})}),n("div",{className:"flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-end",children:[$&&n("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-100 shadow-sm",children:[e("div",{className:"h-7 w-7 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold",children:(($t=$.displayName)==null?void 0:$t.charAt(0))||"C"}),n("div",{className:"min-w-0",children:[e("div",{className:"text-xs font-medium text-gray-900 truncate",children:$.displayName||$.email||"—"}),e("div",{className:"text-xs text-gray-600 truncate",children:Z||"—"})]})]}),n("button",{onClick:async()=>{console.log("[AgenceCompta] Déconnexion du comptable"),await T(),p("/login")},className:"inline-flex items-center gap-2 px-4 py-2 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50 shadow-sm transition-colors",title:"Déconnexion",children:[e(ba,{className:"h-4 w-4"}),e("span",{className:"hidden sm:inline",children:"Déconnexion"})]})]})]})})}),n("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8 space-y-6 sm:space-y-8",children:[q==="controle"&&n("div",{className:"space-y-6 sm:space-y-8",children:[n("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6",children:[e(_,{icon:e(pt,{className:"h-6 w-6"}),label:"Billets vendus",value:it.tickets.toString(),sublabel:"en direct",theme:l,emphasis:!1}),e(_,{icon:e(Ye,{className:"h-6 w-6"}),label:"Chiffre d'affaires",value:A(it.amount),sublabel:"en direct",theme:l,emphasis:!0}),e(_,{icon:e(ut,{className:"h-6 w-6"}),label:"Réservations",value:it.reservations.toString(),sublabel:"en direct",theme:l,emphasis:!1})]}),n("div",{className:"grid grid-cols-2 sm:grid-cols-5 gap-3 sm:gap-4",children:[e(Ee,{tone:"indigo",label:"En attente",value:we.length,icon:e(Rt,{className:"h-4 w-4"})}),e(Ee,{tone:"emerald",label:"En service",value:P.length,icon:e(Ke,{className:"h-4 w-4"})}),e(Ee,{tone:"amber",label:"En pause",value:J.length,icon:e(ft,{className:"h-4 w-4"})}),e(Ee,{tone:"rose",label:"Clôturés",value:re.length,icon:e(Dt,{className:"h-4 w-4"})}),e(Ee,{tone:"slate",label:"Validés",value:Me.length,icon:e(Je,{className:"h-4 w-4"})})]}),e(yt,{title:"Postes en attente d'activation",hint:"Le guichetier est connecté mais ne peut pas vendre tant que vous n'activez pas.",icon:e(Rt,{className:"h-5 w-5"}),list:we,usersCache:he,liveStats:{},theme:l,actions:a=>n(Ne,{onClick:()=>na(a.id),theme:l,children:[e(Ke,{className:"h-4 w-4 mr-2"}),"Activer le poste"]})}),e(yt,{title:"Postes en service",hint:"Statistiques mises à jour en direct.",icon:e(Ke,{className:"h-5 w-5"}),list:P,usersCache:he,liveStats:Be,theme:l,actions:a=>n("div",{className:"flex flex-col sm:flex-row gap-2",children:[n(ge,{onClick:()=>sa(a.id),children:[e(ft,{className:"h-4 w-4 mr-2"}),"Pause"]}),n(Ne,{onClick:()=>{confirm("Clôturer ce poste maintenant ?")&&It(a.id,{forcedByAccountant:!0})},theme:l,children:[e(Dt,{className:"h-4 w-4 mr-2"}),"Clôturer"]})]})}),e(yt,{title:"Postes en pause",hint:"Peuvent être remis en service.",icon:e(ft,{className:"h-5 w-5"}),list:J,usersCache:he,liveStats:Be,theme:l,actions:a=>n("div",{className:"flex flex-col sm:flex-row gap-2",children:[n(Ne,{onClick:()=>ra(a.id),theme:l,children:[e(Ke,{className:"h-4 w-4 mr-2"}),"Continuer"]}),e(ge,{onClick:()=>{confirm("Clôturer ce poste ?")&&It(a.id,{forcedByAccountant:!0})},children:"Clôturer"})]})})]}),q==="receptions"&&n("div",{className:"space-y-6 sm:space-y-8",children:[e(Ra,{icon:e(ya,{className:"h-6 w-6"}),title:"Réceptions de caisse à valider",subtitle:"Validez la remise d'espèces des postes clôturés par les guichetiers."}),(()=>{const a=re.filter(s=>{var m;return!((m=s.comptable)!=null&&m.validated)});return a.length===0?e(ke,{icon:e(Je,{className:"h-12 w-12"}),title:"Aucune réception en attente",description:"Toutes les remises de caisse ont été validées."}):e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6",children:a.map(s=>{var v,k,H,G;const m=s.payBy||{},r=tt[s.id]||{cashReceived:""},i=nt[s.id],h=(i==null?void 0:i.reservations)??s.totalReservations??0,o=(i==null?void 0:i.tickets)??s.totalTickets??0,c=(i==null?void 0:i.amount)??s.totalAmount??0,u=(i==null?void 0:i.cashExpected)??m.espèces??s.cashExpected??0,f=(i==null?void 0:i.mmExpected)??m.mobile_money??s.mmExpected??0,N=(i==null?void 0:i.onlineAmount)??0,b=Number((r.cashReceived||"").replace(/[^\d.]/g,"")),w=(Number.isFinite(b)?b:0)-(u||0),C=!Number.isFinite(b)||b<0,S=he[s.userId]||{},x=S.name||s.userName||s.userEmail||s.userId,R=S.code||s.userCode||"—";return n("div",{className:"group relative",children:[e("div",{className:"absolute inset-0 bg-gradient-to-br from-white to-gray-50 rounded-2xl transform group-hover:scale-[1.02] transition-all duration-300"}),n("div",{className:"relative rounded-2xl border border-gray-200 bg-white/80 p-5 shadow-sm hover:shadow-lg transition-all duration-300",children:[n("div",{className:"flex items-start justify-between gap-3 mb-4",children:[n("div",{className:"min-w-0",children:[e("div",{className:"text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Guichetier"}),n("div",{className:"font-semibold text-gray-900 truncate",children:[x,n("span",{className:"text-gray-500 text-sm ml-2",children:["(",R,")"]})]})]}),e("div",{className:"flex-shrink-0",children:e("div",{className:"px-3 py-1 rounded-full bg-gradient-to-r from-amber-50 to-amber-100 border border-amber-200",children:e("div",{className:"text-xs font-medium text-amber-800",children:"À valider"})})})]}),n("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e(Q,{label:"Réservations",value:h.toString()}),e(Q,{label:"Billets",value:o.toString()}),e(Q,{label:"Montant total",value:A(c),emphasis:!0}),e(Q,{label:"Espèces attendu",value:A(u),emphasis:!0}),e(Q,{label:"Mobile Money",value:A(f)}),e(Q,{label:"En ligne",value:A(N)})]}),n("div",{className:"mb-4 p-3 rounded-xl bg-gradient-to-r from-gray-50 to-gray-100/50",children:[e("div",{className:"text-xs text-gray-600 mb-1",children:"Période de vente"}),n("div",{className:"text-sm font-medium text-gray-900",children:[s.startTime?We(new Date(((k=(v=s.startTime).toDate)==null?void 0:k.call(v))??s.startTime)):"—",e("span",{className:"mx-2 text-gray-400",children:"→"}),s.endTime?We(new Date(((G=(H=s.endTime).toDate)==null?void 0:G.call(H))??s.endTime)):"—"]})]}),n("div",{className:"space-y-3",children:[n("div",{children:[n("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Espèces reçues ",e("span",{className:"text-red-500",children:"*"})]}),n("div",{className:"relative",children:[e("input",{type:"number",min:"0",inputMode:"numeric",className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent text-lg font-medium",style:{outlineColor:l.primary},placeholder:"0",value:r.cashReceived,onChange:Y=>oa(s.id,Y.target.value)}),e("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500",children:"FCFA"})]})]}),n("div",{className:"p-3 rounded-xl border",style:{borderColor:w===0?"#d1fae5":w>0?"#bbf7d0":"#fecaca",backgroundColor:w===0?"#f0fdf4":w>0?"#dcfce7":"#fef2f2"},children:[e("div",{className:"text-xs font-medium text-gray-700 mb-1",children:"Écart (reçu - attendu)"}),e("div",{className:`text-lg font-bold ${w===0?"text-emerald-700":w>0?"text-green-700":"text-red-700"}`,children:Number.isFinite(w)?A(w):"—"})]})]}),n("div",{className:"mt-6 flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3",children:[n(ge,{onClick:()=>{B("rapports"),St(s.id)},className:"w-full sm:w-auto",children:[e(Tt,{className:"h-4 w-4 mr-2"}),"Voir le détail"]}),n(Ne,{disabled:C||!!Fe[s.id],onClick:()=>ia(s),theme:l,className:"w-full sm:w-auto",children:[e(Je,{className:"h-4 w-4 mr-2"}),Fe[s.id]?"Validation...":"Valider la réception"]})]})]})]},s.id)})})})()]}),q==="rapports"&&n("div",{className:"space-y-6 sm:space-y-8",children:[n("div",{className:"rounded-2xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[n("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-3",children:[n("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center",children:e(kt,{className:"h-5 w-5 text-blue-600"})}),n("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Rapports détaillés par poste"}),e("div",{className:"text-sm text-gray-600",children:"Analyse complète des ventes (guichet + en ligne)"})]})]}),e("div",{className:"w-full sm:w-96",children:n("select",{className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:l.primary},value:Ze,onChange:a=>St(a.target.value),children:[e("option",{value:"",children:"— Sélectionnez un poste —"}),[...P,...J,...re,...Me].map(a=>{var u,f,N,b;const s=he[a.userId]||{},m=s.name||a.userName||a.userEmail||a.userId,r=s.code||a.userCode||"—",i=a.startTime?new Date(((f=(u=a.startTime).toDate)==null?void 0:f.call(u))??a.startTime):null,h=a.endTime?new Date(((b=(N=a.endTime).toDate)==null?void 0:b.call(N))??a.endTime):null,o=a.status==="active"?"En service":a.status==="paused"?"En pause":a.status==="closed"?"Clôturé":a.status==="validated"?"Validé":"En attente",c=`${i?i.toLocaleDateString("fr-FR"):"?"} → ${h?h.toLocaleDateString("fr-FR"):"?"}`;return e("option",{value:a.id,children:`${m} (${r}) • ${c} • ${o}`},a.id)})]})})]}),n("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mt-4",children:[Ze&&(()=>{var r,i,h,o;const a=ca(Ze),s=a!=null&&a.startTime?new Date(((i=(r=a.startTime).toDate)==null?void 0:i.call(r))??a.startTime):null,m=a!=null&&a.endTime?new Date(((o=(h=a.endTime).toDate)==null?void 0:o.call(h))??a.endTime):null;return n("div",{className:"text-sm text-gray-600",children:["Période analysée : ",We(s)," → ",We(m),Le>0&&n("span",{className:"ml-3 px-2 py-1 rounded-full bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 text-xs font-medium",children:[Le," doublon",Le>1?"s":""," consolidé",Le>1?"s":""]})]})})(),n("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"Filtrer par canal :"}),n("div",{className:"flex rounded-xl border border-gray-300 p-1",children:[e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${ue==="all"?"bg-blue-50 text-blue-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>et("all"),children:"Tous"}),e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${ue==="guichet"?"bg-emerald-50 text-emerald-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>et("guichet"),children:"Guichet"}),e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${ue==="en_ligne"?"bg-indigo-50 text-indigo-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>et("en_ligne"),children:"En ligne"})]})]})]})]}),n("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6",children:[e(_,{icon:e(pt,{className:"h-6 w-6"}),label:"Billets vendus",value:be.billets.toString(),sublabel:`${be.guichet.billets} guichet + ${be.en_ligne.billets} ligne`,theme:l,emphasis:!1}),e(_,{icon:e(Ye,{className:"h-6 w-6"}),label:"Chiffre d'affaires",value:A(be.montant),sublabel:`${A(be.guichet.montant)} guichet + ${A(be.en_ligne.montant)} ligne`,theme:l,emphasis:!0}),e(_,{icon:e(ut,{className:"h-6 w-6"}),label:"Réservations",value:ee.length.toString(),sublabel:`${ee.filter(a=>a.canal==="guichet"||a.canal==="").length} guichet + ${ee.filter(a=>a.canal==="en_ligne").length} ligne`,theme:l,emphasis:!1})]}),n("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:[n("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Détail des réservations"}),n("div",{className:"text-sm text-gray-600",children:[ee.length," ligne",ee.length>1?"s":""]})]}),Vt?e("div",{className:"flex items-center justify-center py-12",children:n("div",{className:"text-center",children:[e("div",{className:"h-12 w-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-3"}),e("div",{className:"text-gray-600",children:"Chargement des données..."})]})}):ee.length?e("div",{className:"overflow-hidden rounded-xl border border-gray-200",children:e("div",{className:"overflow-x-auto",children:n("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gradient-to-r from-gray-50 to-gray-100/50",children:n("tr",{children:[e(F,{children:"Date/Heure"}),e(F,{children:"Canal"}),e(F,{children:"Trajet"}),e(F,{children:"Client"}),e(F,{align:"right",children:"Billets"}),e(F,{align:"right",children:"Montant"}),e(F,{align:"right",children:"Paiement"}),e(F,{align:"right",children:"Vendeur"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:ee.filter(a=>ue==="all"?!0:ue==="guichet"?a.canal==="guichet"||a.canal==="":ue==="en_ligne"?a.canal==="en_ligne":!0).map((a,s)=>{const m=a.canal==="en_ligne"?"bg-indigo-100 text-indigo-700":"bg-emerald-100 text-emerald-700",r=a.encaissement==="agence"?"Caisse agence":"Compte compagnie",i=a.encaissement==="agence"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700";return n("tr",{className:`hover:bg-gray-50/50 ${s%2===0?"bg-white":"bg-gray-50/30"}`,children:[n(g,{children:[e("div",{className:"font-medium",children:ka(a.date)}),e("div",{className:"text-xs text-gray-500",children:a.heure})]}),e(g,{children:n("div",{className:"flex flex-col gap-1",children:[e("span",{className:`text-xs px-2 py-1 rounded-full ${m} font-medium`,children:a.canal==="en_ligne"?"En ligne":"Guichet"}),e("span",{className:`text-xs px-2 py-0.5 rounded-full ${i}`,children:r})]})}),e(g,{children:n("div",{className:"font-medium",children:[a.depart," → ",a.arrivee]})}),n(g,{children:[e("div",{className:"font-medium",children:a.nomClient}),a.telephone&&e("div",{className:"text-xs text-gray-500",children:a.telephone})]}),e(g,{align:"right",children:e("span",{className:"font-medium",children:(a.seatsGo||0)+(a.seatsReturn||0)})}),e(g,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:A(a.montant)})}),e(g,{align:"right",children:e("span",{className:"text-xs text-gray-600",children:a.paiement||"—"})}),e(g,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700",children:a.guichetierCode||"—"})})]},a.id)})})]})})}):e(ke,{icon:e(Tt,{className:"h-12 w-12"}),title:"Aucune donnée disponible",description:"Sélectionnez un poste pour afficher son rapport détaillé"})]})]}),q==="caisse"&&n("div",{className:"space-y-6 sm:space-y-8",children:[n("div",{className:"rounded-2xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[n("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-5",children:[n("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-emerald-50 to-green-50 flex items-center justify-center",children:e(Se,{className:"h-6 w-6 text-emerald-600"})}),n("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:"Caisse d'agence"}),e("div",{className:"text-sm text-gray-600",children:"Gestion des mouvements financiers"})]})]}),n("div",{className:"flex flex-wrap items-center gap-3",children:[n(Ne,{onClick:()=>Ve(!0),theme:l,className:"whitespace-nowrap",children:[e(jt,{className:"h-4 w-4 mr-2"}),"Nouveau mouvement"]}),n(ge,{onClick:()=>Da(pe),disabled:pe.length===0,className:"whitespace-nowrap",children:[e(xa,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]})]}),n("div",{className:"space-y-4",children:[e("div",{className:"flex items-center gap-3",children:n("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e("input",{type:"checkbox",checked:Oe,onChange:a=>Ht(a.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),"Période personnalisée"]})}),n("div",{className:"flex flex-wrap items-center gap-4",children:[Oe?n(Mt,{children:[n("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"Du"}),e("input",{type:"date",className:"border border-gray-300 rounded-xl px-4 py-2.5 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:l.primary},value:qe,onChange:a=>Kt(a.target.value)})]}),n("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"Au"}),e("input",{type:"date",className:"border border-gray-300 rounded-xl px-4 py-2.5 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:l.primary},value:Pe,onChange:a=>Jt(a.target.value)})]})]}):n("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"Période :"}),e("div",{className:"relative",children:e("input",{type:"month",className:"border border-gray-300 rounded-xl px-4 py-2.5 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:l.primary},value:st,onChange:a=>Yt(a.target.value)})})]}),e(ge,{onClick:Ge,disabled:rt,children:rt?"Actualisation...":"Actualiser"})]})]})]}),n("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6",children:[e(_,{icon:e(Ye,{className:"h-6 w-6"}),label:"Entrées totales",value:A(Ce),theme:l,emphasis:!1}),e(_,{icon:e(Lt,{className:"h-6 w-6"}),label:"Sorties totales",value:A(Ae),theme:l,emphasis:!1}),e(_,{icon:e(Se,{className:"h-6 w-6"}),label:"Solde de période",value:A(Ce-Ae),sublabel:Ce-Ae>=0?"Positif":"Déficitaire",theme:l,emphasis:!0})]}),n("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:[n("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Journal des mouvements"}),n("div",{className:"text-sm text-gray-600",children:[pe.length," jour",pe.length>1?"s":""," avec activité"]})]}),rt?e("div",{className:"flex items-center justify-center py-12",children:n("div",{className:"text-center",children:[e("div",{className:"h-12 w-12 border-4 border-gray-200 border-t-emerald-500 rounded-full animate-spin mx-auto mb-3"}),e("div",{className:"text-gray-600",children:"Chargement des données de caisse..."})]})}):pe.length===0?e(ke,{icon:e(Se,{className:"h-12 w-12"}),title:"Aucun mouvement enregistré",description:"Aucun mouvement de caisse sur la période sélectionnée"}):e("div",{className:"overflow-hidden rounded-xl border border-gray-200",children:e("div",{className:"overflow-x-auto",children:n("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gradient-to-r from-gray-50 to-gray-100/50",children:n("tr",{children:[e(F,{children:"Date"}),e(F,{align:"right",children:"Entrées"}),e(F,{align:"right",children:"Sorties"}),e(F,{align:"right",children:"Solde journalier"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:pe.map((a,s)=>n("tr",{className:`hover:bg-gray-50/50 ${s%2===0?"bg-white":"bg-gray-50/30"}`,children:[e(g,{children:e("div",{className:"font-medium",children:new Date(a.dateISO).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})})}),e(g,{align:"right",children:e("span",{className:"font-medium text-emerald-700",children:A(a.entrees)})}),e(g,{align:"right",children:e("span",{className:"font-medium text-rose-700",children:A(a.sorties)})}),e(g,{align:"right",children:e("span",{className:`font-bold ${a.solde>=0?"text-emerald-700":"text-rose-700"}`,children:A(a.solde)})})]},a.dateISO))}),e("tfoot",{className:"bg-gradient-to-r from-gray-50 to-gray-100/80 border-t-2 border-gray-300",children:n("tr",{children:[e(g,{className:"font-bold text-gray-900",children:"TOTAUX"}),e(g,{align:"right",className:"font-bold text-emerald-700",children:A(Ce)}),e(g,{align:"right",className:"font-bold text-rose-700",children:A(Ae)}),e(g,{align:"right",className:"font-bold text-gray-900",children:A(Ce-Ae)})]})})]})})})]})]}),q==="reconciliation"&&n("div",{className:"space-y-6 sm:space-y-8",children:[n("div",{className:"rounded-2xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[n("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-5",children:[n("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-amber-50 to-orange-50 flex items-center justify-center",children:e(ht,{className:"h-6 w-6 text-amber-600"})}),n("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:"Réconciliation des ventes"}),e("div",{className:"text-sm text-gray-600",children:"Cohérence billets vendus vs argent encaissé"})]})]}),n("div",{className:"flex items-center gap-3",children:[e("div",{className:"text-sm font-medium text-gray-700",children:"Date :"}),e("input",{type:"date",className:"border border-gray-300 rounded-xl px-4 py-2.5 bg-white shadow-sm focus:outline-none focus:ring-2 focus:border-transparent text-sm",style:{outlineColor:l.primary},value:fe,onChange:a=>ea(a.target.value)}),e(ge,{onClick:lt,disabled:ot,children:ot?"Chargement...":"Actualiser"})]})]}),e("div",{className:"text-sm text-gray-600",children:"Compare les billets vendus par votre agence avec l'argent réellement encaissé"})]}),ot?e("div",{className:"flex items-center justify-center py-12",children:n("div",{className:"text-center",children:[e("div",{className:"h-12 w-12 border-4 border-gray-200 border-t-amber-500 rounded-full animate-spin mx-auto mb-3"}),e("div",{className:"text-gray-600",children:"Chargement de la réconciliation..."})]})}):y?n(Mt,{children:[n("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6",children:[e(_,{icon:e(pt,{className:"h-6 w-6"}),label:"Billets vendus",value:(y.ventesGuichet.tickets+y.ventesEnLigne.tickets).toString(),sublabel:`${y.ventesGuichet.tickets} guichet + ${y.ventesEnLigne.tickets} ligne`,theme:l,emphasis:!1}),e(_,{icon:e(va,{className:"h-6 w-6"}),label:"Chiffre d'affaires total",value:A(y.ventesGuichet.montant+y.ventesEnLigne.montant),sublabel:`${A(y.ventesGuichet.montant)} guichet + ${A(y.ventesEnLigne.montant)} ligne`,theme:l,emphasis:!0}),e(_,{icon:y.ecart===0?e(Je,{className:"h-6 w-6"}):e(Lt,{className:"h-6 w-6"}),label:"Écart de caisse",value:A(y.ecart),sublabel:y.ecart===0?"Caisse OK":y.ecart>0?"Caisse en déficit":"Excédent",theme:l,emphasis:!0})]}),n("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:[e("div",{className:"text-lg font-bold text-gray-900 mb-5",children:"Réconciliation détaillée"}),e("div",{className:"overflow-hidden rounded-xl border border-gray-200",children:n("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gradient-to-r from-gray-50 to-gray-100/50",children:n("tr",{children:[e(F,{children:"Catégorie"}),e(F,{align:"right",children:"Réservations"}),e(F,{align:"right",children:"Billets"}),e(F,{align:"right",children:"Montant"}),e(F,{align:"right",children:"Commentaire"})]})}),n("tbody",{className:"divide-y divide-gray-200",children:[e("tr",{className:"bg-gradient-to-r from-blue-50/30 to-indigo-50/30",children:e(g,{colSpan:5,children:e("div",{className:"text-sm font-bold text-blue-700 uppercase tracking-wider py-2",children:"VENTES DE L'AGENCE"})})}),n("tr",{className:"hover:bg-gray-50/50",children:[e(g,{children:n("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-emerald-100 flex items-center justify-center",children:e(Ye,{className:"h-3 w-3 text-emerald-600"})}),e("span",{className:"font-medium",children:"Ventes guichet"})]})}),e(g,{align:"right",children:e("span",{className:"font-medium",children:y.ventesGuichet.reservations})}),e(g,{align:"right",children:e("span",{className:"font-medium",children:y.ventesGuichet.tickets})}),e(g,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:A(y.ventesGuichet.montant)})}),e(g,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700",children:"À encaisser en caisse"})})]}),n("tr",{className:"hover:bg-gray-50/50",children:[e(g,{children:n("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-indigo-100 flex items-center justify-center",children:e(Na,{className:"h-3 w-3 text-indigo-600"})}),e("span",{className:"font-medium",children:"Ventes en ligne"})]})}),e(g,{align:"right",children:e("span",{className:"font-medium",children:y.ventesEnLigne.reservations})}),e(g,{align:"right",children:e("span",{className:"font-medium",children:y.ventesEnLigne.tickets})}),e(g,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:A(y.ventesEnLigne.montant)})}),e(g,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700",children:"Encaissé en ligne"})})]}),n("tr",{className:"border-t-2 border-gray-300",children:[e(g,{className:"font-bold text-gray-900",children:"TOTAL VENTES AGENCE"}),e(g,{align:"right",className:"font-bold text-gray-900",children:y.ventesGuichet.reservations+y.ventesEnLigne.reservations}),e(g,{align:"right",className:"font-bold text-gray-900",children:y.ventesGuichet.tickets+y.ventesEnLigne.tickets}),e(g,{align:"right",className:"font-bold text-gray-900",children:A(y.ventesGuichet.montant+y.ventesEnLigne.montant)}),e(g,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700",children:"Billets consommés"})})]}),e("tr",{className:"bg-gradient-to-r from-emerald-50/30 to-green-50/30",children:e(g,{colSpan:5,children:e("div",{className:"text-sm font-bold text-emerald-700 uppercase tracking-wider py-2",children:"ENCAISSEMENTS DANS LA CAISSE"})})}),n("tr",{className:"hover:bg-gray-50/50",children:[e(g,{children:n("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-amber-100 flex items-center justify-center",children:e(Se,{className:"h-3 w-3 text-amber-600"})}),e("span",{className:"font-medium",children:"Espèces reçues"})]})}),e(g,{align:"right",children:"—"}),e(g,{align:"right",children:"—"}),e(g,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:A(y.encaissementsEspeces)})}),e(g,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700",children:"Caisse agence"})})]}),n("tr",{className:"hover:bg-gray-50/50",children:[e(g,{children:n("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-purple-100 flex items-center justify-center",children:e(wa,{className:"h-3 w-3 text-purple-600"})}),e("span",{className:"font-medium",children:"Mobile Money"})]})}),e(g,{align:"right",children:"—"}),e(g,{align:"right",children:"—"}),e(g,{align:"right",children:e("span",{className:"font-bold text-gray-900",children:A(y.encaissementsMobileMoney)})}),e(g,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700",children:"Compte compagnie"})})]}),n("tr",{className:"border-t-2 border-gray-300",children:[e(g,{className:"font-bold text-gray-900",children:"TOTAL ENCAISSÉS"}),e(g,{align:"right",children:"—"}),e(g,{align:"right",children:"—"}),e(g,{align:"right",className:"font-bold text-gray-900",children:A(y.encaissementsTotal)}),e(g,{align:"right",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700",children:"Argent réellement reçu"})})]}),e("tr",{className:`${y.ecart===0?"bg-gradient-to-r from-emerald-50/30 to-green-50/30":y.ecart>0?"bg-gradient-to-r from-rose-50/30 to-red-50/30":"bg-gradient-to-r from-amber-50/30 to-orange-50/30"}`,children:e(g,{colSpan:5,children:n("div",{className:"flex items-center justify-between py-3",children:[e("div",{className:"text-sm font-bold text-gray-900",children:"ÉCART (Ventes guichet - Encaissements)"}),n("div",{className:`text-xl font-bold ${y.ecart===0?"text-emerald-700":y.ecart>0?"text-rose-700":"text-amber-700"}`,children:[A(y.ecart),y.ecart===0&&e("span",{className:"ml-2 text-sm font-medium text-emerald-600",children:"✓ Équilibre parfait"}),y.ecart>0&&e("span",{className:"ml-2 text-sm font-medium text-rose-600",children:"⚠️ Manque dans la caisse"}),y.ecart<0&&e("span",{className:"ml-2 text-sm font-medium text-amber-600",children:"ℹ️ Excédent en caisse"})]})]})})})]})]})}),n("div",{className:"mt-6 p-4 rounded-xl bg-gradient-to-r from-gray-50 to-gray-100/50 border border-gray-200",children:[e("div",{className:"text-sm font-medium text-gray-700 mb-2",children:"Résumé de la journée"}),n("div",{className:"text-sm text-gray-600 space-y-1",children:[n("div",{children:["• ",e("span",{className:"font-medium",children:y.ventesGuichet.reservations+y.ventesEnLigne.reservations})," réservations effectuées"]}),n("div",{children:["• ",e("span",{className:"font-medium",children:y.ventesGuichet.tickets+y.ventesEnLigne.tickets})," billets vendus"]}),n("div",{children:["• ",e("span",{className:"font-medium",children:A(y.ventesGuichet.montant+y.ventesEnLigne.montant)})," chiffre d'affaires généré"]}),n("div",{children:["• ",e("span",{className:"font-medium",children:A(y.encaissementsTotal)})," réellement encaissés dans la caisse"]})]})]})]})]}):e(ke,{icon:e(ht,{className:"h-12 w-12"}),title:"Aucune donnée disponible",description:"Sélectionnez une date pour voir la réconciliation"})]})]}),ta&&e("div",{className:"fixed inset-0 bg-black/50 grid place-items-center z-50 p-4",children:n("div",{className:"w-full max-w-md bg-white rounded-2xl p-6 shadow-2xl",children:[n("div",{className:"flex items-center justify-between mb-6",children:[e("div",{className:"text-xl font-bold text-gray-900",children:"Nouveau mouvement de sortie"}),e("button",{onClick:()=>Ve(!1),className:"h-8 w-8 rounded-full flex items-center justify-center hover:bg-gray-100",children:e("span",{className:"text-gray-500",children:"×"})})]}),n("div",{className:"space-y-5",children:[n("div",{children:[e("div",{className:"text-sm font-medium text-gray-700 mb-3",children:"Type de mouvement"}),n("div",{className:"grid grid-cols-2 gap-3",children:[n("button",{type:"button",className:`p-4 rounded-xl border-2 text-center transition-all ${O.kind==="depense"?"border-blue-500 bg-blue-50 text-blue-700":"border-gray-200 bg-gray-50 text-gray-700 hover:border-gray-300"}`,onClick:()=>ce(a=>({...a,kind:"depense"})),children:[e("div",{className:"font-medium",children:"Dépense"}),e("div",{className:"text-xs text-gray-500 mt-1",children:"Achat, frais, etc."})]}),n("button",{type:"button",className:`p-4 rounded-xl border-2 text-center transition-all ${O.kind==="transfert_banque"?"border-blue-500 bg-blue-50 text-blue-700":"border-gray-200 bg-gray-50 text-gray-700 hover:border-gray-300"}`,onClick:()=>ce(a=>({...a,kind:"transfert_banque"})),children:[e("div",{className:"font-medium",children:"Transfert banque"}),e("div",{className:"text-xs text-gray-500 mt-1",children:"Vers compte bancaire"})]})]})]}),n("div",{children:[n("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Libellé ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{type:"text",className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:l.primary},placeholder:"Ex: Achat fournitures bureau",value:O.libelle,onChange:a=>ce(s=>({...s,libelle:a.target.value}))})]}),O.kind==="transfert_banque"&&n("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Banque / Compte"}),e("input",{type:"text",className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:l.primary},placeholder:"Ex: BICIS - Compte principal",value:O.banque,onChange:a=>ce(s=>({...s,banque:a.target.value}))})]}),n("div",{children:[n("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Montant (FCFA) ",e("span",{className:"text-red-500",children:"*"})]}),n("div",{className:"relative",children:[e("input",{type:"number",min:"0",inputMode:"numeric",className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent text-lg font-medium",style:{outlineColor:l.primary},placeholder:"0",value:O.montant,onChange:a=>ce(s=>({...s,montant:a.target.value}))}),e("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium",children:"FCFA"})]})]}),n("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Note (facultatif)"}),e("textarea",{className:"w-full border border-gray-300 rounded-xl px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:border-transparent resize-none",style:{outlineColor:l.primary},placeholder:"Informations complémentaires...",rows:3,value:O.note,onChange:a=>ce(s=>({...s,note:a.target.value}))})]})]}),n("div",{className:"mt-8 flex justify-end gap-3",children:[e(ge,{onClick:()=>Ve(!1),children:"Annuler"}),n(Ne,{onClick:la,theme:l,children:[e(jt,{className:"h-4 w-4 mr-2"}),"Enregistrer le mouvement"]})]})]})})]})},$e=({active:p,onClick:t,label:I,icon:T,theme:l})=>n("button",{className:`
      flex items-center gap-2 px-4 py-2.5 rounded-2xl text-sm font-medium transition-all
      ${p?"text-white shadow-lg transform scale-105":"text-gray-600 hover:text-gray-900 hover:bg-white/80"}
    `,onClick:t,style:p?{background:`linear-gradient(135deg, ${l.primary}, ${l.secondary})`,boxShadow:`0 4px 12px ${l.primary}40`}:{},children:[T,e("span",{className:"whitespace-nowrap",children:I})]}),Ne=({theme:p,className:t="",children:I,...T})=>e("button",{...T,className:`
      inline-flex items-center justify-center px-5 py-3 rounded-xl text-white font-medium 
      shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200
      disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none
      ${t}
    `,style:{background:`linear-gradient(135deg, ${p.primary}, ${p.secondary})`,boxShadow:`0 4px 12px ${p.primary}40`},children:I}),ge=({className:p="",children:t,...I})=>e("button",{...I,className:`
      inline-flex items-center justify-center px-5 py-3 rounded-xl border-2 border-gray-200 
      bg-white text-gray-700 font-medium shadow-sm hover:shadow-md hover:border-gray-300 
      hover:bg-gray-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed
      ${p}
    `,children:t}),_=({icon:p,label:t,value:I,sublabel:T,theme:l,emphasis:U})=>n("div",{className:`relative overflow-hidden rounded-2xl border border-gray-200 p-5 bg-white shadow-sm
    hover:shadow-md transition-all duration-300
    ${U?"ring-2 ring-offset-2":""}`,style:U?{"--tw-ring-color":l.primary}:void 0,children:[e("div",{className:"absolute top-0 right-0 h-20 w-20 opacity-10",children:e("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-200 to-gray-300 rounded-full blur-xl"})}),n("div",{className:"flex items-start justify-between mb-4",children:[e("div",{className:"text-sm font-medium text-gray-500 uppercase tracking-wider",children:t}),e("div",{className:"h-10 w-10 rounded-xl grid place-items-center",style:{background:`linear-gradient(135deg, ${l.primary}20, ${l.secondary}20)`},children:e("span",{className:"text-gray-700",children:p})})]}),n("div",{className:"space-y-1",children:[e("div",{className:`font-bold ${U?"text-3xl":"text-2xl"} text-gray-900`,children:I}),T&&e("div",{className:"text-xs font-medium text-gray-500",children:T})]})]}),Ee=({tone:p,label:t,value:I,icon:T})=>{const l={indigo:{bg:"bg-indigo-50",text:"text-indigo-700",border:"border-indigo-100"},emerald:{bg:"bg-emerald-50",text:"text-emerald-700",border:"border-emerald-100"},amber:{bg:"bg-amber-50",text:"text-amber-700",border:"border-amber-100"},rose:{bg:"bg-rose-50",text:"text-rose-700",border:"border-rose-100"},slate:{bg:"bg-slate-50",text:"text-slate-700",border:"border-slate-100"}}[p];return n("div",{className:`rounded-2xl border ${l.border} p-4 bg-white shadow-sm hover:shadow-md transition-shadow`,children:[n("div",{className:"flex items-center justify-between mb-2",children:[e("div",{className:`px-2.5 py-1 rounded-lg text-xs font-medium ${l.bg} ${l.text}`,children:t}),e("div",{className:`h-8 w-8 rounded-lg flex items-center justify-center ${l.bg}`,children:e("span",{className:l.text,children:T})})]}),e("div",{className:"text-2xl font-bold text-gray-900",children:I})]})},Ra=({icon:p,title:t,subtitle:I})=>e("div",{className:"rounded-2xl border border-gray-200 shadow-sm p-6 bg-gradient-to-r from-white to-gray-50/50",children:n("div",{className:"flex items-center gap-4",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center",children:p}),n("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:t}),I&&e("div",{className:"text-sm text-gray-600 mt-1",children:I})]})]})}),yt=({title:p,hint:t,icon:I,list:T,usersCache:l,liveStats:U,actions:X,theme:z})=>n("div",{className:"rounded-2xl border border-gray-200 shadow-sm p-5 bg-gradient-to-r from-white to-gray-50/50",children:[n("div",{className:"flex items-center justify-between mb-4",children:[n("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center",children:I}),n("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:p}),t&&e("div",{className:"text-sm text-gray-600",children:t})]})]}),n("div",{className:"text-sm font-medium px-3 py-1.5 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 shadow-inner",children:[T.length," poste",T.length>1?"s":""]})]}),T.length===0?e(ke,{icon:I,title:`Aucun ${p.toLowerCase()}`,description:"Aucun poste dans cet état pour le moment"}):e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:T.map(L=>{var we,Te,P,je;const Re=l[L.userId]||{},Qe=Re.name||L.userName||L.userEmail||L.userId,q=Re.code||L.userCode||"—",B=U[L.id],$=(B==null?void 0:B.reservations)??L.totalReservations??0,Xe=(B==null?void 0:B.tickets)??L.totalTickets??0,Z=(B==null?void 0:B.amount)??L.totalAmount??0,De={active:{label:"En service",colors:"bg-emerald-50 text-emerald-700 border-emerald-200"},paused:{label:"En pause",colors:"bg-amber-50 text-amber-700 border-amber-200"},closed:{label:"Clôturé",colors:"bg-rose-50 text-rose-700 border-rose-200"},pending:{label:"En attente",colors:"bg-indigo-50 text-indigo-700 border-indigo-200"},validated:{label:"Validé",colors:"bg-slate-50 text-slate-700 border-slate-200"}}[L.status];return n("div",{className:`group relative rounded-2xl border border-gray-200 bg-white p-5 \r
                         hover:border-gray-300 hover:shadow-lg transition-all duration-300`,children:[e("div",{className:"absolute inset-0 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300",style:{background:`linear-gradient(135deg, ${z.primary}08, ${z.secondary}08)`}}),n("div",{className:"relative",children:[n("div",{className:"flex items-start justify-between gap-3 mb-4",children:[n("div",{className:"min-w-0",children:[e("div",{className:"text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Guichetier"}),n("div",{className:"font-semibold text-gray-900 truncate",children:[Qe,n("span",{className:"text-gray-500 text-sm ml-2",children:["(",q,")"]})]})]}),e("span",{className:`px-3 py-1 rounded-full text-xs font-medium border ${De.colors}`,children:De.label})]}),n("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e(Q,{label:"Réservations",value:$.toString()}),e(Q,{label:"Billets",value:Xe.toString()}),e(Q,{label:"Début",value:L.startTime?new Date(((Te=(we=L.startTime).toDate)==null?void 0:Te.call(we))??L.startTime).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):"—"}),e(Q,{label:"Fin",value:L.endTime?new Date(((je=(P=L.endTime).toDate)==null?void 0:je.call(P))??L.endTime).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):"—"})]}),n("div",{className:"mb-5 p-3 rounded-xl bg-gradient-to-r from-gray-50 to-gray-100/50 border border-gray-200",children:[e("div",{className:"text-xs font-medium text-gray-500 uppercase tracking-wider mb-1",children:"Montant total"}),e("div",{className:"text-xl font-bold",style:{color:z.primary},children:A(Z)})]}),e("div",{className:"flex justify-end",children:X(L)})]})]},L.id)})})]}),Q=({label:p,value:t,emphasis:I=!1})=>n("div",{children:[e("div",{className:"text-xs text-gray-500 mb-1",children:p}),e("div",{className:`font-medium ${I?"text-gray-900":"text-gray-700"}`,children:t})]}),ke=({icon:p,title:t,description:I})=>n("div",{className:"text-center py-12 px-4 rounded-2xl border-2 border-dashed border-gray-300 bg-gradient-to-b from-white to-gray-50/50",children:[e("div",{className:"inline-flex h-16 w-16 rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 items-center justify-center mb-4",children:p}),e("div",{className:"text-lg font-medium text-gray-900 mb-2",children:t}),e("div",{className:"text-sm text-gray-600 max-w-md mx-auto",children:I})]}),F=({children:p,align:t="left",className:I="",colSpan:T})=>e("th",{colSpan:T,className:`px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider
      ${t==="right"?"text-right":"text-left"}
      ${I}`,children:p}),g=({children:p,align:t="left",className:I="",colSpan:T})=>e("td",{colSpan:T,className:`px-4 py-3
      ${t==="right"?"text-right":"text-left"}
      ${I}`,children:p});function Da(p){if(console.log("[AgenceCompta] Export CSV des données de caisse"),!p.length){console.warn("[AgenceCompta] Aucune donnée à exporter"),alert("Aucune donnée à exporter");return}try{const t=["Date","Entrées (FCFA)","Sorties (FCFA)","Solde (FCFA)"],I=p.map(z=>[new Date(z.dateISO).toLocaleDateString("fr-FR"),z.entrees.toLocaleString("fr-FR"),z.sorties.toLocaleString("fr-FR"),z.solde.toLocaleString("fr-FR")].join(";")),T=[t.join(";"),...I].join(`
`),l=new Blob([T],{type:"text/csv;charset=utf-8;"}),U=URL.createObjectURL(l),X=document.createElement("a");X.href=U,X.download=`caisse_agence_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(X),X.click(),document.body.removeChild(X),URL.revokeObjectURL(U),console.log("[AgenceCompta] Export CSV terminé avec succès")}catch(t){console.error("[AgenceCompta] Erreur lors de l'export CSV:",t),alert("Erreur lors de l'export CSV")}}export{qa as default};
