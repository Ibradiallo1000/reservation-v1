import{j as r,a as i,a1 as $,d as G,b as K,u as O,r as n,C as T,a5 as B,K as H,aK as J}from"./react-KXT1Riez.js";import{u as R,r as j,J as P,w as E,L as A,q as Q,o as V}from"./firebase-DYTOaTLw.js";import{d as b,s as F}from"../index-CBC3XRHi.js";import{h as W}from"./ticketMessages-3kq_IPVw.js";import{R as X}from"./ReceiptModal-BfEnEHzt.js";import{p as Y,f as Z,c as ee}from"./vendor-B27hBV_J.js";import"./jspdf.es.min-z1sh-bkM.js";import"./html2canvas-iRN4OxZ6.js";const re=({fullScreen:c=!1,className:o=""})=>r("div",{className:`flex items-center justify-center ${c?"min-h-screen":""} ${o}`,children:r("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}),te=({message:c,onRetry:o,onHome:d})=>r("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:r("div",{className:"p-6 rounded-lg max-w-md bg-white shadow-sm border border-red-200",children:i("div",{className:"flex flex-col items-center",children:[r($,{className:"h-12 w-12 text-red-500 mb-4"}),r("h2",{className:"text-xl font-bold mb-2 text-red-600",children:"Erreur"}),r("p",{className:"mb-6 text-gray-700",children:c}),i("div",{className:"flex gap-3",children:[o&&r("button",{onClick:o,className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition",children:"Réessayer"}),d&&r("button",{onClick:d,className:"px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300 transition",children:"Accueil"})]})]})})}),de=()=>{const{id:c}=G(),o=K(),d=O(),{companyInfo:p,reservation:f,from:g}=d.state||{},[l,I]=n.useState(f||null),[s,L]=n.useState(p||null),[q,x]=n.useState(!0),[w,z]=n.useState(null),h=n.useRef(null),M=n.useCallback((e,a)=>{try{let t;return typeof e=="string"?t=Y(e):e instanceof Date?t=e:t=new Date(e.seconds*1e3),Z(t,a,{locale:ee})}catch{return"--/--/----"}},[]),v=n.useCallback(async()=>{var D;if(!c)throw new Error("ID manquant");let e=await R(j(A(b,"reservations"),E("referenceCode","==",c),P(1)));if(e.empty&&(e=await R(j(A(b,"reservations"),E("__name__","==",c),P(1)))),e.empty)throw new Error("Réservation introuvable");const a=e.docs[0],t=a.data(),u=a.ref.path.split("/")[1];return{...t,id:a.id,compagnieId:t.compagnieId||u,createdAt:(D=t.createdAt)!=null&&D.seconds?new Date(t.createdAt.seconds*1e3):void 0}},[c]),C=n.useCallback(async e=>{var y,u;const a=await Q(V(b,"companies",e));if(!a.exists())throw new Error("Compagnie non trouvée");const t=a.data();return{id:a.id,nom:t.nom||t.name,logoUrl:t.logoUrl,couleurPrimaire:t.couleurPrimaire||((y=t.theme)==null?void 0:y.primary)||"#3b82f6",couleurSecondaire:t.couleurSecondaire||((u=t.theme)==null?void 0:u.secondary),slug:t.slug,telephone:t.telephone}},[]);if(n.useEffect(()=>{(async()=>{try{x(!0);let e=f||null,a=p||null;e||(e=await v()),a||(a=await C(e.compagnieId)),I(e),L(a)}catch(e){z((e==null?void 0:e.message)||"Erreur de chargement")}finally{x(!1)}})()},[C,v,f,p]),q||!s)return r(re,{fullScreen:!0});if(w||!l)return r(te,{message:w||"Erreur de chargement",onRetry:()=>window.location.reload(),onHome:()=>o("/")});const N=l.referenceCode||l.id;M(l.createdAt||new Date,"dd/MM/yyyy");const m=s.couleurPrimaire,k=s.couleurSecondaire,S=F(m),U=n.useCallback(()=>{if(!h.current)return;const e={margin:2,filename:`recu-${N}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:[81,200],orientation:"portrait"}};W().set(e).from(h.current).save()},[N]),_=n.useCallback(()=>{o(g||"/agence/guichet")},[o,g]);return i("div",{className:"min-h-screen bg-gray-50 print:bg-white",children:[r("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm no-print",style:{backgroundColor:m,color:S},children:i("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[r("button",{onClick:_,className:"p-2 rounded-full",children:r(T,{})}),r("h1",{className:"font-bold text-sm",children:"Reçu de voyage"}),r("div",{className:"w-6"})]})}),r("div",{className:"max-w-[81mm] mx-auto p-2",ref:h,children:r(X,{open:!0,onClose:()=>o("/agence/guichet"),reservation:{...l,agencyNom:l.agencyNom||l.nomAgence},company:{id:s.id,nom:s.nom,logoUrl:s.logoUrl,couleurPrimaire:s.couleurPrimaire,couleurSecondaire:s.couleurSecondaire,telephone:s.telephone,slug:s.slug}})}),i("div",{className:"no-print fixed bottom-0 left-0 right-0 bg-white border-t py-3 px-4 grid grid-cols-3 gap-2",children:[i("button",{onClick:U,className:"py-2 rounded-lg font-medium flex items-center justify-center gap-1",style:{backgroundColor:m,color:S},children:[r(B,{size:16})," PDF"]}),i("button",{onClick:()=>window.print(),className:"py-2 rounded-lg font-medium flex items-center justify-center gap-1",style:{backgroundColor:k||m,color:F(k||m)},children:[r(H,{size:16})," Imprimer"]}),i("button",{onClick:()=>o("/agence/guichet"),className:"py-2 rounded-lg bg-gray-200 text-gray-800 flex items-center justify-center gap-1",children:[r(J,{size:16})," Retour"]})]})]})};export{de as default};
