import{r as d,b as _,j as n,a as s}from"./react-DB_4kGOy.js";import{z as C,w as E,x as k,B as A,q as P,o as f,C as M,D as $,V as q}from"./firebase-lLzYRzUk.js";import{d as u,a as U,f as V}from"../index-Bkmir__O.js";import"./vendor-C-DAJou6.js";const B=new Intl.NumberFormat("fr-FR"),z=g=>{const l=String(g||"").trim().toLowerCase();return l==="admin plateforme"||l==="admin_platforme"?"admin_platforme":l},Q=()=>{const[g,l]=d.useState([]),[b,F]=d.useState([]),[R,j]=d.useState(!0),[y,p]=d.useState(""),[x,N]=d.useState(null),[v,w]=d.useState(null),S=_();d.useEffect(()=>{(async()=>{try{const[e,i]=await Promise.all([C(E(k(u,"companies"),A("nom","asc"))),C(E(k(u,"plans"),A("priceMonthly","asc")))]);l(e.docs.map(a=>({id:a.id,...a.data()}))),F(i.docs.map(a=>{const t=a.data();return{id:a.id,name:String(t.name??a.id)}}))}catch(e){console.error(e),p("Erreur lors du chargement des données")}finally{j(!1)}})()},[]);const D=d.useMemo(()=>g.length>0,[g.length]);async function I(e,i){const a=await P(f(u,"plans",i));if(!a.exists())throw new Error("Plan introuvable");const t=a.data(),r=!!t.features.publicPage||!!t.features.onlineBooking;await M(f(u,"companies",e),{planId:i,plan:t.name,publicPageEnabled:r,onlineBookingEnabled:!!t.features.onlineBooking,guichetEnabled:!!t.features.guichet,commissionOnline:Number(t.features.onlineBooking?t.commissionOnline:0),feeGuichet:Number(t.features.guichet?t.feeGuichet:0),minimumMonthly:Number(t.minimumMonthly||0),maxAgences:Number(t.maxAgences||0),updatedAt:$()}),l(h=>h.map(m=>m.id===e?{...m,planId:i,plan:t.name,publicPageEnabled:r,onlineBookingEnabled:!!t.features.onlineBooking,guichetEnabled:!!t.features.guichet,commissionOnline:t.features.onlineBooking?t.commissionOnline:0,feeGuichet:t.features.guichet?t.feeGuichet:0,minimumMonthly:t.minimumMonthly||0,maxAgences:t.maxAgences||0}:m))}const T=async(e,i)=>{try{w(e);const a=i==="inactif"?"actif":"inactif";await M(f(u,"companies",e),{status:a,updatedAt:$()}),p(`Statut mis à jour en « ${a} »`),l(t=>t.map(r=>r.id===e?{...r,status:a}:r))}catch(a){console.error(a),p("Erreur lors de la mise à jour du statut")}finally{w(null)}},G=async e=>{var m;const i=U.currentUser;if(!i)return alert("Tu dois être connecté.");const a=await i.getIdTokenResult(!0);if(z((m=a.claims)==null?void 0:m.role)!=="admin_platforme")return alert("Accès refusé : nécessite le rôle admin_platforme.");let t="—",r="—";try{const o=await P(f(u,"companies",e));if(o.exists()){const c=o.data();t=(c==null?void 0:c.nom)||t,r=(c==null?void 0:c.slug)||r}}catch{}if(prompt(`⚠️ SUPPRESSION DÉFINITIVE
Nom: ${t}
Slug: ${r}
ID: ${e}

Tape "SUPPRIMER" pour confirmer.`)==="SUPPRIMER")try{N(e),await q(V,"deleteCompany")({companyId:e,hard:!0}),alert("✅ Compagnie supprimée (Firestore + Storage + Auth)."),l(c=>c.filter(O=>O.id!==e))}catch(o){console.error(o),alert("❌ Échec suppression : "+((o==null?void 0:o.message)||"erreur inconnue"))}finally{N(null)}};return R?n("p",{className:"p-6",children:"Chargement des compagnies…"}):s("div",{className:"p-6",children:[s("div",{className:"flex justify-between items-center mb-6",children:[n("h1",{className:"text-2xl font-bold",children:"Gestion des compagnies"}),n("button",{onClick:()=>S("/admin/compagnies/ajouter"),className:"bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded",children:"+ Ajouter une compagnie"})]}),y&&n("p",{className:"mb-4 text-blue-600",children:y}),D?n("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:g.map(e=>s("div",{className:"border rounded-xl shadow-sm bg-white p-5 hover:shadow-md transition",children:[s("div",{className:"flex items-start justify-between gap-3",children:[s("div",{children:[n("h2",{className:"text-lg font-bold text-orange-700",children:e.nom}),s("p",{className:"text-xs text-gray-500",children:["Slug : ",e.slug||"—"]}),s("p",{className:"text-xs text-gray-500",children:["Email : ",e.email||"—"]}),s("p",{className:"text-xs text-gray-500",children:["Téléphone : ",e.telephone||"—"]}),s("p",{className:"text-xs text-gray-500",children:["Pays : ",e.pays||"—"]})]}),n("span",{className:`text-xs px-2 py-1 rounded ${e.status==="inactif"?"bg-red-50 text-red-700":"bg-green-50 text-green-700"}`,children:e.status==="inactif"?"Inactif":"Actif"})]}),s("div",{className:"mt-4 space-y-2",children:[s("div",{className:"text-sm",children:[n("span",{className:"text-gray-600",children:"Plan actuel : "}),n("b",{children:e.plan||"—"})]}),n("label",{className:"block text-sm text-gray-700 font-medium",children:"Appliquer un plan"}),s("select",{value:e.planId||"",onChange:async i=>{var t;const a=i.target.value;if(a)try{await I(e.id,a);const r=((t=b.find(h=>h.id===a))==null?void 0:t.name)||"";p(`Plan « ${r} » appliqué à ${e.nom}`)}catch(r){console.error(r),p("Erreur lors de l’application du plan")}},className:"border p-2 rounded mt-1 w-full",children:[n("option",{value:"",children:"— Sélectionner —"}),b.map(i=>n("option",{value:i.id,children:i.name},i.id))]}),s("div",{className:"text-xs text-gray-600 border rounded-lg p-2",children:[s("div",{children:[n("span",{className:"text-gray-500",children:"Agences max :"})," ",n("b",{children:e.maxAgences??"—"})]}),s("div",{children:[n("span",{className:"text-gray-500",children:"Commission online :"})," ",n("b",{children:e.commissionOnline!=null?Math.round((e.commissionOnline||0)*100)+"%":"—"})]}),s("div",{children:[n("span",{className:"text-gray-500",children:"Frais guichet :"})," ",n("b",{children:e.feeGuichet!=null?B.format(e.feeGuichet)+" FCFA":"—"})]}),s("div",{children:[n("span",{className:"text-gray-500",children:"Minimum mensuel :"})," ",n("b",{children:e.minimumMonthly?B.format(e.minimumMonthly)+" FCFA":"—"})]}),s("div",{className:"mt-1 text-gray-500",children:["Features :"," ",s("b",{children:[e.publicPageEnabled?"Vitrine":"—",","," ",e.onlineBookingEnabled?"Réservation en ligne":"—",","," ",e.guichetEnabled?"Guichet":"—"]})]})]})]}),s("div",{className:"flex flex-wrap gap-2 mt-4",children:[n("button",{onClick:()=>S(`/admin/compagnies/${e.id}/modifier`),className:"text-sm px-3 py-1 rounded bg-green-600 text-white hover:bg-green-700",children:"Modifier"}),n("button",{onClick:()=>T(e.id,e.status),disabled:v===e.id,className:`text-sm px-3 py-1 rounded text-white ${e.status==="inactif"?"bg-sky-600 hover:bg-sky-700":"bg-yellow-600 hover:bg-yellow-700"} ${v===e.id?"opacity-60 cursor-not-allowed":""}`,children:e.status==="inactif"?"Réactiver":"Désactiver"}),e.slug&&n("a",{href:`/${e.slug}`,target:"_blank",rel:"noopener noreferrer",className:"text-sm px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Voir site"}),n("button",{onClick:()=>G(e.id),disabled:x===e.id,className:`text-sm px-3 py-1 rounded text-white bg-red-600 hover:bg-red-700 ${x===e.id?"opacity-60 cursor-not-allowed":""}`,title:"Supprimer définitivement la compagnie et toutes ses données",children:x===e.id?"Suppression…":"Supprimer"})]})]},e.id))}):n("p",{className:"text-gray-500 italic",children:"Aucune compagnie enregistrée"})]})};export{Q as default};
