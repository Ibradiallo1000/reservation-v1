import{a as O,u as U,b as V,r as i,j as e,m as k,C as J,f as _,h as G,o as B,U as H,aN as W,aO as K}from"./react-PtMwKKf1.js";import{d as $,f as Q,t as X}from"./firebase-eGIzIftJ.js";import{d as E}from"../index-C4y8wfzK.js";import{v as Y}from"./v4-C6aID195.js";import"./vendor-B5FTF_2c.js";const y=(n,u=1)=>{const h=parseInt(n.slice(1,3),16),f=parseInt(n.slice(3,5),16),s=parseInt(n.slice(5,7),16);return`rgba(${h}, ${f}, ${s}, ${u})`},Z=n=>{if(n.length<7)return"#000000";const u=parseInt(n.slice(1,3),16),h=parseInt(n.slice(3,5),16),f=parseInt(n.slice(5,7),16);return(.299*u+.587*h+.114*f)/255>.5?"#000000":"#ffffff"},ne=({company:n})=>{const u=O(),h=U(),{slug:f}=V(),[s,F]=i.useState(null),[c,L]=i.useState(n),[I,S]=i.useState(!1),[N,j]=i.useState(null),[p,R]=i.useState({fullName:"",phone:"",email:""}),[d,A]=i.useState(1),[T]=i.useState("aller_simple");i.useEffect(()=>{const l=async()=>{var a;try{if((a=u.state)!=null&&a.tripData){r(u.state.tripData);return}const m=sessionStorage.getItem("reservationDraft");if(m){const o=JSON.parse(m);o!=null&&o.tripData&&r(o.tripData)}if(!(n!=null&&n.id)){const o=sessionStorage.getItem("companyInfo");o&&L(x=>({...x,...JSON.parse(o)}))}}catch(m){console.error("Erreur de chargement initial:",m),j("Erreur de chargement des données")}},r=a=>{var x;const o=["id","companyId","agencyId","departure","arrival","date","time","price","places"].filter(b=>!a[b]);if(o.length>0){j(`Données de trajet incomplètes. Champs manquants: ${o.join(", ")}`);return}F({id:a.id,companyId:a.companyId,agencyId:a.agencyId,departure:a.departure,arrival:a.arrival,date:a.date,time:a.time,price:Number(a.price),places:Number(a.places),remainingSeats:Number(a.remainingSeats)||void 0}),sessionStorage.setItem("reservationDraft",JSON.stringify({tripData:a,companyInfo:((x=u.state)==null?void 0:x.companyInfo)||n}))};l()},[u.state,n]);const v=i.useMemo(()=>(s==null?void 0:s.price)||0,[s]),C=i.useMemo(()=>v*d,[v,d]),P=i.useMemo(()=>{const l=c.couleurPrimaire||"#3b82f6",r=c.couleurSecondaire||"#93c5fd";return{colors:{primary:l,secondary:r,text:Z(l),background:"#ffffff"},classes:{card:"bg-white rounded-xl shadow-sm border border-gray-200",button:"transition-all hover:scale-105 active:scale-95",animations:"transition-all duration-300 ease-in-out",header:"sticky top-0 z-50 px-4 py-3"}}},[c]),{colors:t,classes:g}=P,w=l=>{const{name:r,value:a}=l.target;R(m=>({...m,[r]:a}))},D=l=>{const r=Math.max(1,Math.min(10,l));A(r)},q=async l=>{l.preventDefault(),S(!0),j(null);try{if(!s||!s.id||!s.companyId||!s.agencyId)throw new Error("Données de trajet incomplètes. Veuillez recommencer.");if(!p.fullName||!p.phone)throw new Error("Veuillez remplir tous les champs obligatoires");if(s.remainingSeats!==void 0&&s.remainingSeats<d)throw new Error(`Il ne reste que ${s.remainingSeats} place(s) disponible(s).`);const r=Y(),a=`RES-${Date.now()}`,m=$(E,"companies",s.companyId,"agences",s.agencyId),o=await Q(m),x=o.exists()?o.data():{},b={id:r,nomClient:p.fullName,telephone:p.phone,email:p.email,depart:s.departure,arrivee:s.arrival,date:s.date,heure:s.time,montant:C,seatsGo:d,seatsReturn:0,tripType:T,canal:"en_ligne",statut:"en_attente",companyId:s.companyId,agencyId:s.agencyId,agencyNom:x.nomAgence||x.nom||"",agencyTelephone:x.telephone||"",trajetId:s.id,referenceCode:a,companySlug:f,companyName:c.nom,primaryColor:c.couleurPrimaire,secondaryColor:c.couleurSecondaire,tripData:s,createdAt:new Date,updatedAt:new Date},M=$(E,"companies",s.companyId,"agences",s.agencyId,"reservations",r);await X(M,b),sessionStorage.setItem("reservationDraft",JSON.stringify(b)),h(`/${f}/upload-preuve/${r}`,{state:{companyInfo:c,reservation:b}})}catch(r){console.error("Erreur réservation:",r),j(r.message||"Une erreur est survenue")}finally{S(!1)}},z=l=>{try{return new Date(l).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}catch{return l}};return!s||!s.id?e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:e.jsxs("div",{className:`p-6 rounded-lg max-w-md ${g.card}`,children:[e.jsx(k,{className:"h-12 w-12 mx-auto text-red-500 mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2 text-gray-900",children:"Données manquantes"}),e.jsx("p",{className:"text-gray-700 mb-4",children:N||"Les informations du trajet sont introuvables. Veuillez recommencer votre recherche."}),e.jsx("button",{onClick:()=>h(`/${f}`),className:`mt-4 px-4 py-2 rounded ${g.button}`,style:{backgroundColor:t.primary,color:t.text},children:"Retour à l'accueil"})]})}):e.jsxs("div",{className:"min-h-screen",style:{background:t.background},children:[e.jsx("header",{className:g.header,style:{backgroundColor:y(t.primary,.95),color:t.text,backdropFilter:"blur(10px)"},children:e.jsxs("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e.jsx("button",{onClick:()=>h(-1),className:"p-2 rounded-full hover:bg-white/10 transition",children:e.jsx(J,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[c.logoUrl&&e.jsx(_.LazyLoadImage,{src:c.logoUrl,alt:`Logo ${c.nom}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:t.text}}),e.jsx("h1",{className:"text-lg font-bold",children:"Réservation"})]})]})}),e.jsxs("main",{className:"max-w-4xl mx-auto p-4",children:[N&&e.jsx("div",{className:`p-4 mb-4 rounded-lg bg-red-50 text-red-600 ${g.card}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-5 w-5"}),e.jsx("span",{children:N})]})}),e.jsx("div",{className:`p-4 rounded-xl mb-4 ${g.card}`,children:e.jsxs("div",{className:"flex flex-row flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-lg font-bold",style:{color:t.primary},children:[s.departure," → ",s.arrival]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm mt-1",children:[e.jsx(G,{className:"h-4 w-4 opacity-70"}),e.jsx("span",{children:z(s.date)}),e.jsx(B,{className:"h-4 w-4 opacity-70 ml-2"}),e.jsx("span",{children:s.time})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm opacity-80",children:"Prix unitaire"}),e.jsxs("div",{className:"font-bold",children:[v.toLocaleString()," FCFA"]})]})]})}),e.jsx("div",{className:`rounded-xl overflow-hidden ${g.card}`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",style:{color:t.primary},children:"Informations du passager"}),e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Nom complet *"}),e.jsxs("div",{className:"relative",children:[e.jsx(H,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-70"}),e.jsx("input",{type:"text",name:"fullName",value:p.fullName,onChange:w,className:"w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none",style:{borderColor:y(t.primary,.3)},required:!0,minLength:2})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Téléphone *"}),e.jsxs("div",{className:"relative",children:[e.jsx(W,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-70"}),e.jsx("input",{type:"tel",name:"phone",value:p.phone,onChange:w,className:"w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none",style:{borderColor:y(t.primary,.3)},required:!0,pattern:"[0-9]{10,15}"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Email"}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-70"}),e.jsx("input",{type:"email",name:"email",value:p.email,onChange:w,className:"w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none",style:{borderColor:y(t.primary,.3)}})]})]})]}),e.jsxs("div",{className:"pt-4",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Nombre de places"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1 opacity-80",children:"Aller"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>D(d-1),disabled:d<=1,className:"p-1 w-8 h-8 rounded-lg border hover:bg-gray-50 flex items-center justify-center disabled:opacity-50",style:{borderColor:y(t.primary,.3)},children:"-"}),e.jsx("div",{className:"flex-1 text-center font-medium py-1 border rounded-lg",style:{borderColor:y(t.primary,.2)},children:d}),e.jsx("button",{type:"button",onClick:()=>D(d+1),disabled:d>=10,className:"p-1 w-8 h-8 rounded-lg border hover:bg-gray-50 flex items-center justify-center disabled:opacity-50",style:{borderColor:y(t.primary,.3)},children:"+"})]})]})})]}),e.jsxs("div",{className:"pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"font-medium",children:"Total:"}),e.jsxs("span",{className:"text-lg font-bold",children:[C.toLocaleString()," FCFA"]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mb-3",children:[v.toLocaleString()," FCFA × ",d," place(s)"]}),e.jsx("button",{type:"submit",className:`w-full py-3 px-4 rounded-lg font-medium ${g.button}`,style:{backgroundColor:t.primary,color:t.text},disabled:I,children:I?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Traitement..."]}):"Réserver maintenant"})]})]})]})})]})]})};export{ne as default};
