import{c as R,r as u,a as r,j as e,aJ as fe,F as U,aK as ae,aL as ne,aM as be,aN as xe}from"./react-DB_4kGOy.js";import{z as re,x as se,w as ye,y as le,T as oe}from"./firebase-lLzYRzUk.js";import{u as ve,b as we,c as Ne,d as ie}from"../index-Bkmir__O.js";import"./vendor-C-DAJou6.js";var de={exports:{}};(function(x,$){(function(v,i){i()})(R,function(){function v(s,l){return typeof l>"u"?l={autoBom:!1}:typeof l!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),l={autoBom:!l}),l.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(s.type)?new Blob(["\uFEFF",s],{type:s.type}):s}function i(s,l,f){var c=new XMLHttpRequest;c.open("GET",s),c.responseType="blob",c.onload=function(){h(c.response,l,f)},c.onerror=function(){console.error("could not download file")},c.send()}function C(s){var l=new XMLHttpRequest;l.open("HEAD",s,!1);try{l.send()}catch{}return 200<=l.status&&299>=l.status}function w(s){try{s.dispatchEvent(new MouseEvent("click"))}catch{var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),s.dispatchEvent(l)}}var g=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof R=="object"&&R.global===R?R:void 0,N=g.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),h=g.saveAs||(typeof window!="object"||window!==g?function(){}:"download"in HTMLAnchorElement.prototype&&!N?function(s,l,f){var c=g.URL||g.webkitURL,p=document.createElement("a");l=l||s.name||"download",p.download=l,p.rel="noopener",typeof s=="string"?(p.href=s,p.origin===location.origin?w(p):C(p.href)?i(s,l,f):w(p,p.target="_blank")):(p.href=c.createObjectURL(s),setTimeout(function(){c.revokeObjectURL(p.href)},4e4),setTimeout(function(){w(p)},0))}:"msSaveOrOpenBlob"in navigator?function(s,l,f){if(l=l||s.name||"download",typeof s!="string")navigator.msSaveOrOpenBlob(v(s,f),l);else if(C(s))i(s,l,f);else{var c=document.createElement("a");c.href=s,c.target="_blank",setTimeout(function(){w(c)})}}:function(s,l,f,c){if(c=c||open("","_blank"),c&&(c.document.title=c.document.body.innerText="downloading..."),typeof s=="string")return i(s,l,f);var p=s.type==="application/octet-stream",I=/constructor/i.test(g.HTMLElement)||g.safari,D=/CriOS\/[\d]+/.test(navigator.userAgent);if((D||p&&I||N)&&typeof FileReader<"u"){var L=new FileReader;L.onloadend=function(){var F=L.result;F=D?F:F.replace(/^data:[^;]*;/,"data:attachment/file;"),c?c.location.href=F:location=F,c=null},L.readAsDataURL(s)}else{var T=g.URL||g.webkitURL,k=T.createObjectURL(s);c?c.location=k:location.href=k,c=null,setTimeout(function(){T.revokeObjectURL(k)},4e4)}});g.saveAs=h.saveAs=h,x.exports=h})})(de);var ke=de.exports;const W=x=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"XOF",maximumFractionDigits:0}).format(x),ce=(...x)=>x.filter(Boolean).join(" ");function Ce(x,$,v){const i=new Date,C=new Date(i.getFullYear(),i.getMonth(),i.getDate(),23,59,59,999);if(x==="day")return{start:new Date(i.getFullYear(),i.getMonth(),i.getDate(),0,0,0,0),end:C,label:"Aujourd’hui"};if(x==="week"){const h=new Date(i),s=(h.getDay()+6)%7,l=new Date(h);return l.setDate(h.getDate()-s),l.setHours(0,0,0,0),{start:l,end:C,label:"Cette semaine"}}if(x==="month"){const h=new Date(i.getFullYear(),i.getMonth(),1,0,0,0,0),s=new Intl.DateTimeFormat("fr-FR",{month:"long",year:"numeric"}).format(h);return{start:h,end:C,label:s}}const w=new Date(`${$}T00:00:00`),g=new Date(`${v}T23:59:59`),N=`${w.toLocaleDateString("fr-FR")} → ${g.toLocaleDateString("fr-FR")}`;return{start:w,end:g,label:N}}const De=()=>{const{user:x,company:$}=ve(),v=x==null?void 0:x.companyId,i=we($),{setHeader:C,resetHeader:w}=Ne(),g="week",[N,h]=u.useState(g),[s,l]=u.useState(""),[f,c]=u.useState(""),{start:p,end:I,label:D}=u.useMemo(()=>Ce(N,s,f),[N,s,f]),[L,T]=u.useState([]),[k,F]=u.useState([]),[b,X]=u.useState(null),[Y,q]=u.useState({agences:!0,reservations:!0}),[K,me]=u.useState(!1),[M,ue]=u.useState(""),[B,ge]=u.useState(""),[O,he]=u.useState("tous"),[E,A]=u.useState(1);u.useEffect(()=>{v&&(async()=>{q({agences:!0,reservations:!0});const n=(await re(se(ie,"companies",v,"agences"))).docs.map(a=>({id:a.id,nom:a.data().nomAgence||a.data().nom||a.data().ville||"Agence",ville:a.data().ville,pays:a.data().pays}));T(n),q(a=>({...a,agences:!1}));const d=[];for(const a of n){const o=se(ie,"companies",v,"agences",a.id,"reservations"),j=ye(o,le("createdAt",">=",oe.fromDate(p)),le("createdAt","<=",oe.fromDate(I))),pe=(await re(j)).docs.map(ee=>{var H,te;const S=ee.data();return{id:ee.id,agencyId:a.id,nomClient:S.nomClient,telephone:S.telephone,montant:S.montant||0,canal:(S.canal||"").toLowerCase().includes("ligne")?"en ligne":"guichet",statut:S.statut,depart:S.depart||"",arrivee:S.arrivee||"",createdAt:((te=(H=S.createdAt)==null?void 0:H.toDate)==null?void 0:te.call(H))||null}});d.push(...pe)}const m={};for(const a of d)m[a.agencyId]||(m[a.agencyId]=[]),m[a.agencyId].push(a);const y=Object.keys(m).map(a=>({agencyId:a,reservations:m[a]}));F(y),q(a=>({...a,reservations:!1}))})()},[v,p,I]);const _=t=>L.find(n=>n.id===t)||null,z=t=>{const n=_(t||null);if(!n)return"Agence inconnue";const d=n.ville&&n.pays?` · ${n.ville}, ${n.pays}`:n.ville?` · ${n.ville}`:"";return`${n.nom}${d}`},P=u.useMemo(()=>{var y;let n=((y=k.find(a=>a.agencyId===b))==null?void 0:y.reservations)||[];M&&(n=n.filter(a=>(a.depart||"").toLowerCase().includes(M.toLowerCase()))),B&&(n=n.filter(a=>(a.arrivee||"").toLowerCase().includes(B.toLowerCase()))),O!=="tous"&&(n=n.filter(a=>(a.canal||"").toLowerCase()===O));const d={};for(const a of n){const o=`${a.depart||"?"} → ${a.arrivee||"?"}`;d[o]||(d[o]={trajet:o,billets:0,ca:0,guichet:0,enLigne:0,lastSale:null}),d[o].billets+=1,d[o].ca+=a.montant||0,a.canal==="guichet"?d[o].guichet+=1:d[o].enLigne+=1,(!d[o].lastSale||a.createdAt&&a.createdAt>d[o].lastSale)&&(d[o].lastSale=a.createdAt||null)}return Object.values(d).sort((a,o)=>o.ca-a.ca)},[k,b,M,B,O]),J=Math.ceil(P.length/10),V=P.slice((E-1)*10,E*10),G=u.useMemo(()=>{var a;const t=((a=k.find(o=>o.agencyId===b))==null?void 0:a.reservations)||[],n=t.reduce((o,j)=>o+(j.montant||0),0),d=t.length,m=t.filter(o=>o.canal==="guichet").length,y=t.filter(o=>o.canal==="en ligne").length;return{ca:n,billets:d,guichet:m,enLigne:y}},[k,b]),Q=()=>{var a;const t=P;if(t.length===0)return;const n=`Trajet,Billets,Guichet,En ligne,CA
`,d=t.map(o=>[`"${o.trajet}"`,o.billets,o.guichet,o.enLigne,o.ca].join(",")).join(`
`),m=new Blob([n+d],{type:"text/csv;charset=utf-8;"}),y=((a=_(b||""))==null?void 0:a.nom)||"agence";ke.saveAs(m,`reservations-agregees-${y}-${new Date().toISOString().slice(0,10)}.csv`)};return u.useEffect(()=>{const t=r(U,{children:[["day","week","month"].map(n=>e("button",{onClick:()=>{h(n),A(1),X(null)},className:ce("px-3 py-1 rounded-full text-sm border transition",N===n?"bg-white text-gray-900":"bg-white/10 backdrop-blur text-white border-white/30 hover:bg-white/20"),children:n==="day"?"Aujourd’hui":n==="week"?"Semaine":"Mois"},n)),r("button",{onClick:()=>me(n=>!n),className:"ml-2 flex items-center px-3 py-1 rounded-full text-sm border bg-white/10 text-white hover:bg-white/20 border-white/30",title:"Filtres & période personnalisée",children:[e(fe,{className:"mr-2"}),"Filtres"]}),b&&r(U,{children:[r("button",{onClick:Q,className:"flex items-center px-3 py-1 rounded-full text-sm border bg-white/10 text-white hover:bg-white/20 border-white/30",children:[e(ae,{className:"mr-2"}),"Exporter"]}),r("button",{onClick:()=>window.print(),className:"flex items-center px-3 py-1 rounded-full text-sm bg-white text-gray-900 hover:bg-gray-100",children:[e(ne,{className:"mr-2"}),"Imprimer"]})]})]});return C({title:`Réservations — ${D}`,subtitle:b?z(b):"",actions:t,bg:`linear-gradient(90deg, ${i.colors.primary} 0%, ${i.colors.secondary} 100%)`,fg:"#fff"}),()=>w()},[D,b,N,K,i.colors.primary,i.colors.secondary]),v?e("div",{className:"min-h-screen p-4 md:p-8",style:{background:"linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%)"},children:r("div",{className:"max-w-7xl mx-auto",children:[K&&r("div",{className:"rounded-2xl p-4 mb-6 border shadow-sm",style:{background:"rgba(255,255,255,0.55)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderColor:"rgba(0,0,0,0.08)"},children:[r("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[r("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Période perso — Début"}),e("input",{type:"date",value:s,onChange:t=>l(t.target.value),className:"w-full p-2 border rounded-md bg-white/70"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Période perso — Fin"}),e("input",{type:"date",value:f,onChange:t=>c(t.target.value),className:"w-full p-2 border rounded-md bg-white/70"})]}),r("div",{className:"lg:col-span-2 flex items-end gap-2",children:[e("button",{className:"px-3 py-2 rounded-md border bg-white hover:bg-gray-50",onClick:()=>h("custom"),disabled:!s||!f,children:"Appliquer"}),e("button",{className:"px-3 py-2 rounded-md border bg-white hover:bg-gray-50",onClick:()=>{l(""),c(""),h(g)},children:"Réinitialiser"})]})]}),b&&r(U,{children:[e("hr",{className:"my-4"}),r("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[r("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Départ"}),e("input",{placeholder:"ex: Bamako",value:M,onChange:t=>{ue(t.target.value),A(1)},className:"w-full p-2 border rounded-md bg-white/70"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Arrivée"}),e("input",{placeholder:"ex: Ségou",value:B,onChange:t=>{ge(t.target.value),A(1)},className:"w-full p-2 border rounded-md bg-white/70"})]}),r("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Canal"}),r("select",{value:O,onChange:t=>{he(t.target.value),A(1)},className:"w-full p-2 border rounded-md bg-white/70",children:[e("option",{value:"tous",children:"Tous"}),e("option",{value:"guichet",children:"Guichet"}),e("option",{value:"en ligne",children:"En ligne"})]})]})]})]})]}),Y.agences||Y.reservations?e("div",{className:"flex justify-center items-center h-64",children:e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):r(U,{children:[e("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 mb-8",children:k.map(t=>{const n=_(t.agencyId),d=t.reservations.reduce((j,Z)=>j+(Z.montant||0),0),m=t.reservations.length,y=t.reservations.filter(j=>j.canal==="guichet").length,a=m-y,o=m?Math.round(y/m*100):0;return r("div",{onClick:()=>{X(b===t.agencyId?null:t.agencyId),A(1)},className:ce("relative p-6 rounded-2xl cursor-pointer transition-all","border shadow-sm hover:shadow-lg"),style:{background:"rgba(255,255,255,0.58)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderColor:b===t.agencyId?i.colors.secondary:"rgba(0,0,0,0.08)"},children:[e("div",{className:"absolute left-0 right-0 top-0 h-1.5 rounded-t-2xl",style:{background:`linear-gradient(90deg, ${i.colors.secondary}, ${i.colors.accent})`}}),r("div",{className:"flex items-start justify-between",children:[r("div",{children:[e("h2",{className:"text-base font-semibold text-gray-900",children:(n==null?void 0:n.nom)||"Agence"}),r("p",{className:"text-xs text-gray-500",children:[n!=null&&n.ville?n.ville:""," ",n!=null&&n.pays?`• ${n.pays}`:""]})]}),r("span",{className:"text-xs px-2 py-0.5 rounded-full",style:{backgroundColor:`${i.colors.secondary}15`,color:i.colors.secondary},children:[m," billets"]})]}),r("div",{className:"mt-4",children:[e("div",{className:"text-2xl font-bold",children:W(d)}),e("p",{className:"text-xs text-gray-500",children:"CA sur la période"})]}),r("div",{className:"mt-4",children:[r("div",{className:"flex justify-between text-xs text-gray-600 mb-1",children:[e("span",{children:"Guichet"}),r("span",{children:[y,"/",m," (",o,"%)"]})]}),e("div",{className:"w-full h-2 bg-gray-200/70 rounded-full overflow-hidden",children:e("div",{className:"h-full",style:{width:`${o}%`,background:`linear-gradient(90deg, ${i.colors.primary}, ${i.colors.secondary})`}})}),r("div",{className:"flex justify-between text-xs text-gray-600 mt-1",children:[e("span",{children:"En ligne"}),r("span",{children:[a,"/",m," (",100-o,"%)"]})]})]})]},t.agencyId)})}),b&&r("div",{className:"rounded-2xl border shadow-sm overflow-hidden",style:{background:"rgba(255,255,255,0.58)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderColor:"rgba(0,0,0,0.08)"},children:[e("div",{className:"p-6 border-b",children:r("div",{className:"flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3",children:[r("div",{children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:z(b)}),r("p",{className:"text-sm text-gray-600",children:[G.billets," billets ·"," ",e("span",{className:"font-medium",children:W(G.ca)})," ","· Guichet ",G.guichet," — En ligne ",G.enLigne]})]}),r("div",{className:"flex items-center gap-2",children:[r("button",{onClick:Q,className:"flex items-center px-3 py-1 rounded-full text-sm border bg-white hover:bg-gray-50",children:[e(ae,{className:"mr-2"}),"Exporter (agrégé)"]}),r("button",{onClick:()=>window.print(),className:"flex items-center px-3 py-1 rounded-full text-sm",style:{backgroundColor:i.colors.primary,color:"#fff"},children:[e(ne,{className:"mr-2"}),"Imprimer"]})]})]})}),e("div",{className:"overflow-x-auto",children:r("table",{className:"min-w-full divide-y divide-gray-200",children:[e("thead",{className:"bg-white/60 backdrop-blur",children:r("tr",{children:[e("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Trajet"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Billets"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Guichet"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"En ligne"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"CA"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Dernière vente"})]})}),e("tbody",{className:"bg-white/40 backdrop-blur divide-y divide-gray-100",children:V.length===0?e("tr",{children:e("td",{colSpan:6,className:"px-6 py-8 text-center text-gray-500",children:"Aucune donnée pour cette agence et ces filtres."})}):V.map(t=>r("tr",{className:"hover:bg-white/60",children:[e("td",{className:"px-6 py-3 text-sm font-medium text-gray-900",children:t.trajet}),e("td",{className:"px-6 py-3 text-sm text-right",children:t.billets}),e("td",{className:"px-6 py-3 text-sm text-right",children:t.guichet}),e("td",{className:"px-6 py-3 text-sm text-right",children:t.enLigne}),e("td",{className:"px-6 py-3 text-sm text-right",children:W(t.ca)}),e("td",{className:"px-6 py-3 text-sm text-right text-gray-600",children:t.lastSale?t.lastSale.toLocaleDateString("fr-FR"):"—"})]},t.trajet))})]})}),P.length>10&&r("div",{className:"px-6 py-4 border-t flex items-center justify-between bg-white/60 backdrop-blur",children:[r("button",{onClick:()=>A(t=>Math.max(1,t-1)),disabled:E===1,className:"flex items-center px-3 py-1 border rounded-full text-sm bg-white hover:bg-gray-50 disabled:opacity-50",children:[e(be,{className:"mr-1"}),"Précédent"]}),r("span",{className:"text-sm text-gray-700",children:["Page ",E," sur ",J]}),r("button",{onClick:()=>A(t=>t+1),disabled:E===J,className:"flex items-center px-3 py-1 border rounded-full text-sm bg-white hover:bg-gray-50 disabled:opacity-50",children:["Suivant",e(xe,{className:"ml-1"})]})]})]})]})]})}):r("div",{className:"p-6",children:[e("h1",{className:"text-xl font-semibold mb-2",children:"Réservations"}),e("p",{className:"text-sm text-muted-foreground",children:"Impossible d’identifier la compagnie (companyId manquant)."})]})};export{De as default};
