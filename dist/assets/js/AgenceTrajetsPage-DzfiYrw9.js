import{r as i,a as o,j as a}from"./react-DB_4kGOy.js";import{x as R,F as se,T as ne,z as W,o as A,q as oe,E as ie,w as ce,C as J,G as le}from"./firebase-lLzYRzUk.js";import{d as v,u as de}from"../index-Bkmir__O.js";import{E as pe}from"./jspdf.es.min-Gs4S7Zlz.js";import{a as me}from"./jspdf.plugin.autotable-CtA5BUKo.js";import"./vendor-C-DAJou6.js";const ue=async(r,l,h,u,d,c,p)=>{try{const m=R(v,"companies",r,"agences",p,"weeklyTrips");return(await se(m,{departure:l,arrival:h,price:u,horaires:d,places:c,active:!0,createdAt:ne.now()})).id}catch(m){throw console.error("Erreur lors de la cr√©ation du trajet hebdomadaire :",m),m}},U=({label:r,value:l,onChange:h})=>{const[u,d]=i.useState([]);return i.useEffect(()=>{(async()=>{const m=(await W(R(v,"villes"))).docs.map(f=>f.data().nom);d(m)})()},[]),o("div",{children:[a("label",{className:"block font-medium mb-1",children:r}),a("input",{list:"liste-villes",className:"w-full border px-3 py-2 rounded",value:l,onChange:c=>h(c.target.value),placeholder:"Entrer une ville"}),a("datalist",{id:"liste-villes",children:u.map((c,p)=>a("option",{value:c},p))})]})},he=async(r,l)=>{const h=d=>d.trim().toLowerCase().replace(/\s+/g," ").replace(/\b\w/g,c=>c.toUpperCase()),u=[r,l].map(h);for(const d of u){const c=A(v,"villes",d);(await oe(c)).exists()||await ie(c,{nom:d})}},O=["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"],Ne=()=>{const{user:r,company:l}=de(),[h,u]=i.useState(""),[d,c]=i.useState(""),[p,m]=i.useState(""),[f,E]=i.useState(""),[D,w]=i.useState({}),[F,g]=i.useState(""),[x,N]=i.useState(!1),[P,_]=i.useState([]),[z,B]=i.useState(null),[C,H]=i.useState(null),[j,K]=i.useState(""),[V,ge]=i.useState(""),[L,Q]=i.useState(1),q=10,$={primary:(l==null?void 0:l.couleurPrimaire)||"#06b6d4",secondary:(l==null?void 0:l.couleurSecondaire)||"#8b5cf6"};i.useEffect(()=>{M()},[r,L,j,V]);const M=async()=>{if(!(r!=null&&r.companyId)||!(r!=null&&r.agencyId))return;const e=ce(R(v,"companies",r.companyId,"agences",r.agencyId,"weeklyTrips")),T=(await W(e)).docs.map(y=>({id:y.id,...y.data()})).sort((y,k)=>{var I,G;return(((I=k.createdAt)==null?void 0:I.seconds)||0)-(((G=y.createdAt)==null?void 0:G.seconds)||0)}).filter(y=>{var k,I;return(y.departure.toLowerCase().includes(j.toLowerCase())||y.arrival.toLowerCase().includes(j.toLowerCase()))&&(V===""||((I=(k=y.horaires)==null?void 0:k[V])==null?void 0:I.length)>0)}).slice((L-1)*q,L*q);_(T)},X=async e=>{if(!(!(r!=null&&r.companyId)||!(r!=null&&r.agencyId))&&confirm("Voulez-vous vraiment supprimer ce trajet ?")){N(!0);try{await le(A(v,"companies",r.companyId,"agences",r.agencyId,"weeklyTrips",e)),M(),g("üóëÔ∏è Trajet supprim√© avec succ√®s.")}catch(t){console.error(t),g("‚ùå Erreur lors de la suppression du trajet.")}finally{N(!1)}}},Y=(e,t,s)=>{w(n=>{const b={...n};return b[e]||(b[e]=[]),b[e][t]=s,b})},Z=e=>{w(t=>({...t,[e]:[...t[e]||[],""]}))},ee=(e,t)=>{w(s=>{const n={...s};return n[e]?(n[e].splice(t,1),n):s})},S=e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase(),re=()=>{u(""),c(""),m(""),E(""),w({}),H(null)},te=()=>{const e=new pe;e.text("Liste des trajets",14,14),me(e,{head:[["D√©part","Arriv√©e","Prix","Places"]],body:P.map(t=>[t.departure,t.arrival,`${t.price} FCFA`,t.places||""])}),e.save("trajets_agence.pdf")},ae=async()=>{if(!(r!=null&&r.companyId)||!(r!=null&&r.agencyId))return g("‚ùå Agence non reconnue. Reconnectez-vous.");N(!0),g("");const e={};for(const n in D){const b=D[n].filter(T=>T&&T.trim()!=="");b.length>0&&(e[n]=b)}const t=S(h.trim()),s=S(d.trim());if(!t||!s||!p.trim()||!f.trim()||Object.keys(e).length===0)return N(!1),g("‚ö†Ô∏è Tous les champs sont obligatoires (d√©part, arriv√©e, prix, places et au moins un horaire).");try{if(C)await J(A(v,"companies",r.companyId,"agences",r.agencyId,"weeklyTrips",C),{departure:t,arrival:s,price:parseInt(p),places:parseInt(f),horaires:e}),g("‚úÖ Trajet modifi√© avec succ√®s.");else{const n=await ue(r.companyId,t,s,parseInt(p),e,parseInt(f),r.agencyId);await he(t,s),g("‚úÖ Trajet ajout√© avec succ√®s !")}re(),M()}catch(n){console.error("Erreur Firebase:",n),g("‚ùå Erreur lors de l'enregistrement. V√©rifiez la console.")}finally{N(!1)}};return o("div",{className:"min-h-screen bg-gray-50 p-6 text-gray-800",children:[o("div",{className:"mb-8 p-6 rounded-xl bg-white shadow-md border border-gray-200 flex justify-between items-center",children:[a("h1",{className:"text-3xl font-bold",style:{color:$.primary},children:"Gestion des Trajets"}),a("button",{onClick:te,className:"px-6 py-2 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition-all",style:{background:`linear-gradient(to right, ${$.primary}, ${$.secondary})`},children:"üìÑ Exporter la liste"})]}),o("div",{className:"grid md:grid-cols-2 gap-6",children:[o("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-6",children:[a("h2",{className:"text-xl font-bold mb-4",children:C?"Modifier le trajet":"Ajouter un trajet"}),a(U,{label:"Ville de d√©part",value:h,onChange:u}),a(U,{label:"Ville d'arriv√©e",value:d,onChange:c}),a("input",{type:"number",placeholder:"Prix (FCFA)",value:p,onChange:e=>m(e.target.value),className:"border p-2 w-full rounded mb-3"}),a("input",{type:"number",placeholder:"Nombre de places",value:f,onChange:e=>E(e.target.value),className:"border p-2 w-full rounded mb-4",min:"1"}),O.map(e=>o("div",{className:"mb-2",children:[o("p",{className:"font-semibold",children:[S(e)," :"]}),(D[e]||[]).map((t,s)=>o("div",{className:"flex gap-2 my-1",children:[a("input",{type:"time",value:t,onChange:n=>Y(e,s,n.target.value),className:"border p-1 rounded"}),a("button",{type:"button",onClick:()=>ee(e,s),className:"text-red-600",children:"√ó"})]},s)),a("button",{type:"button",onClick:()=>Z(e),className:"bg-blue-500 hover:bg-blue-700 text-white px-2 py-1 rounded mt-1 text-sm",children:"+ Ajouter un horaire"})]},e)),a("button",{onClick:ae,disabled:x,className:`mt-4 px-4 py-2 rounded text-white ${C?"bg-yellow-600 hover:bg-yellow-700":"bg-green-600 hover:bg-green-700"}`,children:x?"‚è≥ En cours...":C?"Mettre √† jour":"Enregistrer le trajet"}),F&&a("p",{className:`mt-2 p-2 rounded ${F.includes("‚ùå")?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:F})]}),o("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-6",children:[a("h2",{className:"text-xl font-bold mb-4",children:"Liste des trajets"}),a("input",{type:"text",placeholder:"Rechercher par ville...",value:j,onChange:e=>{K(e.target.value),Q(1)},className:"border p-2 w-full rounded mb-4"}),P.length>0?P.map(e=>o("div",{className:"border rounded p-3 mb-2 shadow hover:shadow-md transition-shadow",children:[o("div",{className:`cursor-pointer font-semibold flex justify-between items-center ${e.active?"text-green-700":"text-red-500"}`,onClick:()=>B(z===e.id?null:e.id),children:[o("span",{children:[e.departure," ‚Üí ",e.arrival," ‚Ä¢ ",e.price," FCFA"]}),a("span",{className:"text-xs bg-gray-100 px-2 py-1 rounded",children:e.active?"üü¢ Actif":"üî¥ Inactif"})]}),z===e.id&&o("div",{className:"mt-2 text-sm space-y-2",children:[o("p",{children:[a("strong",{children:"Places :"})," ",e.places||"Non sp√©cifi√©"]}),O.map(t=>{var n;const s=(n=e.horaires)==null?void 0:n[t];return s!=null&&s.length?o("p",{className:"ml-2",children:[S(t)," : ",s.sort().join(", ")]},t):null}),o("div",{className:"mt-3 flex gap-2",children:[a("button",{onClick:()=>X(e.id),disabled:x,className:"bg-red-600 hover:bg-red-800 text-white px-3 py-1 rounded text-sm",children:"Supprimer"}),a("button",{onClick:()=>{H(e.id),u(e.departure),c(e.arrival),m(e.price.toString()),E((e.places||"").toString()),w(e.horaires)},disabled:x,className:"bg-yellow-500 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm",children:"Modifier"}),a("button",{onClick:()=>{if(!(r!=null&&r.companyId)||!(r!=null&&r.agencyId)){alert("Votre session a expir√©. Merci de vous reconnecter.");return}J(A(v,"companies",r.companyId,"agences",r.agencyId,"weeklyTrips",e.id),{active:!e.active})},disabled:x,className:`px-3 py-1 rounded text-white text-sm ${e.active?"bg-gray-600 hover:bg-gray-800":"bg-green-600 hover:bg-green-800"}`,children:e.active?"D√©sactiver":"Activer"})]})]})]},e.id)):a("div",{className:"text-gray-500 italic p-4 border rounded text-center",children:x?"Chargement...":"Aucun trajet disponible"})]})]})]})};export{Ne as default};
