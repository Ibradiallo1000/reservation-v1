import{r as l,a as n,j as e,F as he}from"./react-DB_4kGOy.js";import{z as L,x as F,w as B,B as Y,y as N,T as w}from"./firebase-lLzYRzUk.js";import{u as ge,c as xe,d as T}from"../index-Bkmir__O.js";import"./vendor-C-DAJou6.js";function te(s=new Date){return new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0,0)}function z(s=new Date){return new Date(s.getFullYear(),s.getMonth(),s.getDate(),23,59,59,999)}function ye(s,D){const p=new Date(s);return p.setDate(p.getDate()+D),p}function se(s=new Date){return new Date(s.getFullYear(),s.getMonth(),1,0,0,0,0)}function o(s){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"XOF",maximumFractionDigits:0}).format(s||0)}const Se=()=>{const{user:s}=ge(),{setHeader:D}=xe(),[p,$]=l.useState("mois"),[U,ae]=l.useState(""),[_,ne]=l.useState(""),[J,K]=l.useState(!1),[G,ce]=l.useState([]),[v,oe]=l.useState([]),[le,H]=l.useState(null),[Q,re]=l.useState(""),[M,ie]=l.useState([]),[W,Z]=l.useState(!1),[q,de]=l.useState({in:0,out:0}),{from:R,to:I,label:P}=l.useMemo(()=>{const t=new Date;if(p==="jour")return{from:te(t),to:z(t),label:"Aujourd'hui"};if(p==="semaine")return{from:te(ye(t,-6)),to:z(t),label:"7 derniers jours"};if(p==="mois")return{from:se(t),to:z(t),label:"Mois en cours"};const a=U?new Date(`${U}T00:00:00`):se(t),u=_?new Date(`${_}T23:59:59`):z(t);return{from:a,to:u,label:"Période personnalisée"}},[p,U,_]);l.useEffect(()=>{D({title:"Comptabilité (toutes agences)",subtitle:P})},[P,D]),l.useEffect(()=>{(async()=>{if(!(s!=null&&s.companyId))return;const t=await L(F(T,"companies",s.companyId,"agences"));ce(t.docs.map(a=>({id:a.id,nom:a.data().nomAgence||a.data().nom||"Agence"})))})()},[s==null?void 0:s.companyId]),l.useEffect(()=>{(async()=>{if(!(s!=null&&s.companyId))return;K(!0);const t=[];for(const a of G){const u=F(T,"companies",s.companyId,"agences",a.id,"cashReceipts"),S=F(T,"companies",s.companyId,"agences",a.id,"cashMovements"),f=B(u,N("createdAt",">=",w.fromDate(R)),N("createdAt","<=",w.fromDate(I)),Y("createdAt","asc")),h=B(S,N("createdAt",">=",w.fromDate(R)),N("createdAt","<=",w.fromDate(I)),Y("createdAt","asc")),[c,g]=await Promise.all([L(f),L(h)]);let r=0,C=0,k=0,A=0,E=0;c.forEach(d=>{const x=d.data();r+=1,C+=Number(x.cashReceived||0),k+=Number(x.mmExpected||0)}),g.forEach(d=>{const x=d.data(),m=String(x.kind||""),y=Number(x.amount||0);m==="entree_manual"?A+=y:(m==="depense"||m==="transfert_banque")&&(E+=y)});const O=C+A,b=O-E;t.push({agenceId:a.id,agenceNom:a.nom,nbReceptions:r,especesRecues:C,mmInfo:k,entreesManuelles:A,sorties:E,totalEntrees:O,solde:b})}oe(t.sort((a,u)=>a.agenceNom.localeCompare(u.agenceNom))),K(!1)})()},[s==null?void 0:s.companyId,G,R,I]);const i=l.useMemo(()=>v.reduce((t,a)=>({nbReceptions:t.nbReceptions+a.nbReceptions,especesRecues:t.especesRecues+a.especesRecues,mmInfo:t.mmInfo+a.mmInfo,entreesManuelles:t.entreesManuelles+a.entreesManuelles,sorties:t.sorties+a.sorties,totalEntrees:t.totalEntrees+a.totalEntrees,solde:t.solde+a.solde}),{nbReceptions:0,especesRecues:0,mmInfo:0,entreesManuelles:0,sorties:0,totalEntrees:0,solde:0}),[v]),me=()=>{const t=["Agence","Nb réceptions","Espèces reçues","Entrées manuelles","Total entrées","Sorties","Solde","MM (attendu – info)"],a=v.map(c=>[c.agenceNom,c.nbReceptions,c.especesRecues,c.entreesManuelles,c.totalEntrees,c.sorties,c.solde,c.mmInfo]);a.push(["TOTAL",i.nbReceptions,i.especesRecues,i.entreesManuelles,i.totalEntrees,i.sorties,i.solde,i.mmInfo]);const u=[t,...a].map(c=>c.map(g=>typeof g=="number"?String(g).replace(".",","):`"${String(g).replace(/"/g,'""')}"`).join(";")).join(`
`),S=new Blob([u],{type:"text/csv;charset=utf-8;"}),f=URL.createObjectURL(S),h=document.createElement("a");h.href=f,h.download=`comptabilite_compagnie_${new Date().toISOString().slice(0,10)}.csv`,h.click(),URL.revokeObjectURL(f)},pe=l.useCallback(async(t,a)=>{if(!(s!=null&&s.companyId))return;H(t),re(a),Z(!0);const u=F(T,"companies",s.companyId,"agences",t,"cashReceipts"),S=F(T,"companies",s.companyId,"agences",t,"cashMovements"),f=B(u,N("createdAt",">=",w.fromDate(R)),N("createdAt","<=",w.fromDate(I)),Y("createdAt","asc")),h=B(S,N("createdAt",">=",w.fromDate(R)),N("createdAt","<=",w.fromDate(I)),Y("createdAt","asc")),[c,g]=await Promise.all([L(f),L(h)]),r={};c.forEach(b=>{var y,j;const d=b.data(),m=(((j=(y=d.createdAt)==null?void 0:y.toDate)==null?void 0:j.call(y))??new Date).toISOString().slice(0,10);r[m]||(r[m]={in:0,out:0}),r[m].in+=Math.max(0,Number(d.cashReceived||0))}),g.forEach(b=>{var V,ee;const d=b.data(),m=(((ee=(V=d.createdAt)==null?void 0:V.toDate)==null?void 0:ee.call(V))??new Date).toISOString().slice(0,10);r[m]||(r[m]={in:0,out:0});const y=String(d.kind||""),j=Math.max(0,Number(d.amount||0));(y==="depense"||y==="transfert_banque")&&(r[m].out+=j),y==="entree_manual"&&(r[m].in+=j)});const C=Object.keys(r).sort();let k=0,A=0,E=0;const O=[];for(const b of C){const d=r[b].in||0,x=r[b].out||0;k+=d-x,A+=d,E+=x,O.push({dateISO:b,entrees:d,sorties:x,solde:k})}ie(O),de({in:A,out:E}),Z(!1)},[s==null?void 0:s.companyId,R,I]),ue=()=>{if(!M.length)return;const t=["Date","Entrées","Sorties","Solde"],a=M.map(c=>[new Date(c.dateISO).toLocaleDateString("fr-FR"),c.entrees,c.sorties,c.solde]),u=[t,...a].map(c=>c.map(g=>typeof g=="number"?String(g).replace(".",","):`"${String(g).replace(/"/g,'""')}"`).join(";")).join(`
`),S=new Blob([u],{type:"text/csv;charset=utf-8;"}),f=URL.createObjectURL(S),h=document.createElement("a");h.href=f,h.download=`caisse_${Q}_${new Date().toISOString().slice(0,10)}.csv`,h.click(),URL.revokeObjectURL(f)};return n("div",{className:"space-y-6",children:[e("div",{className:"bg-white p-4 rounded-lg shadow-sm border",children:n("div",{className:"flex flex-wrap items-end gap-3",children:[n("div",{className:"flex items-center gap-2",children:[e("button",{className:`px-3 py-1.5 rounded ${p==="jour"?"bg-gray-900 text-white":"bg-gray-100"}`,onClick:()=>$("jour"),children:"Jour"}),e("button",{className:`px-3 py-1.5 rounded ${p==="semaine"?"bg-gray-900 text-white":"bg-gray-100"}`,onClick:()=>$("semaine"),children:"Semaine"}),e("button",{className:`px-3 py-1.5 rounded ${p==="mois"?"bg-gray-900 text-white":"bg-gray-100"}`,onClick:()=>$("mois"),children:"Mois"}),e("button",{className:`px-3 py-1.5 rounded ${p==="custom"?"bg-gray-900 text-white":"bg-gray-100"}`,onClick:()=>$("custom"),children:"Personnalisé"})]}),p==="custom"&&n(he,{children:[n("div",{children:[e("label",{className:"block text-xs text-gray-600 mb-1",children:"Du"}),e("input",{type:"date",className:"border rounded px-2 py-1",value:U,onChange:t=>ae(t.target.value)})]}),n("div",{children:[e("label",{className:"block text-xs text-gray-600 mb-1",children:"Au"}),e("input",{type:"date",className:"border rounded px-2 py-1",value:_,onChange:t=>ne(t.target.value)})]})]}),n("div",{className:"ml-auto flex items-center gap-2",children:[e("span",{className:"text-sm text-gray-600",children:P}),e("button",{onClick:me,className:"px-3 py-1.5 rounded bg-red-600 text-white",children:"Exporter CSV"})]})]})}),e("div",{className:"bg-white rounded-lg shadow-sm border overflow-x-auto",children:n("table",{className:"min-w-full text-sm",children:[e("thead",{className:"bg-gray-50",children:n("tr",{className:"text-left",children:[e("th",{className:"px-4 py-2",children:"Agence"}),e("th",{className:"px-4 py-2",children:"Nb réceptions"}),e("th",{className:"px-4 py-2",children:"Espèces reçues"}),e("th",{className:"px-4 py-2",children:"Entrées manuelles"}),e("th",{className:"px-4 py-2",children:"Total entrées"}),e("th",{className:"px-4 py-2",children:"Sorties"}),e("th",{className:"px-4 py-2",children:"Solde"}),e("th",{className:"px-4 py-2",children:"MM (attendu – info)"})]})}),e("tbody",{children:J?e("tr",{children:e("td",{colSpan:8,className:"px-4 py-8 text-center text-gray-500",children:"Chargement…"})}):v.length===0?e("tr",{children:e("td",{colSpan:8,className:"px-4 py-8 text-center text-gray-500",children:"Aucune donnée sur la période."})}):v.map(t=>n("tr",{className:"border-t",children:[e("td",{className:"px-4 py-2",children:e("button",{onClick:()=>pe(t.agenceId,t.agenceNom),className:"text-indigo-600 hover:underline",title:"Voir la caisse de cette agence",children:t.agenceNom})}),e("td",{className:"px-4 py-2",children:t.nbReceptions}),e("td",{className:"px-4 py-2",children:o(t.especesRecues)}),e("td",{className:"px-4 py-2",children:o(t.entreesManuelles)}),e("td",{className:"px-4 py-2 font-medium",children:o(t.totalEntrees)}),e("td",{className:"px-4 py-2",children:o(t.sorties)}),e("td",{className:"px-4 py-2 font-semibold",children:o(t.solde)}),e("td",{className:"px-4 py-2",children:o(t.mmInfo)})]},t.agenceId))}),!J&&v.length>0&&e("tfoot",{className:"bg-gray-50 border-t",children:n("tr",{children:[e("th",{className:"px-4 py-2 text-left",children:"TOTAL"}),e("th",{className:"px-4 py-2",children:i.nbReceptions}),e("th",{className:"px-4 py-2",children:o(i.especesRecues)}),e("th",{className:"px-4 py-2",children:o(i.entreesManuelles)}),e("th",{className:"px-4 py-2",children:o(i.totalEntrees)}),e("th",{className:"px-4 py-2",children:o(i.sorties)}),e("th",{className:"px-4 py-2",children:o(i.solde)}),e("th",{className:"px-4 py-2",children:o(i.mmInfo)})]})})]})}),le&&n("div",{className:"fixed inset-0 z-40",children:[e("div",{className:"absolute inset-0 bg-black/30",onClick:()=>H(null)}),n("div",{className:"absolute right-0 top-0 h-full w-full max-w-2xl bg-white shadow-xl flex flex-col",children:[n("div",{className:"px-4 py-3 border-b flex items-center justify-between",children:[n("div",{className:"font-semibold",children:["Caisse — ",Q," ",n("span",{className:"text-sm text-gray-500",children:["(",P,")"]})]}),n("div",{className:"flex items-center gap-2",children:[e("button",{onClick:ue,className:"px-3 py-1.5 rounded bg-red-600 text-white text-sm",children:"Exporter CSV"}),e("button",{onClick:()=>H(null),className:"px-3 py-1.5 rounded border text-sm",children:"Fermer"})]})]}),n("div",{className:"p-4 space-y-3 overflow-auto",children:[n("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[e(X,{label:"Entrées (période)",value:o(q.in)}),e(X,{label:"Sorties (période)",value:o(q.out)}),e(X,{label:"Solde (période)",value:o(q.in-q.out)})]}),e("div",{className:"rounded border overflow-hidden",children:n("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gray-50",children:n("tr",{children:[e("th",{className:"px-3 py-2 text-left",children:"Date"}),e("th",{className:"px-3 py-2 text-right",children:"Entrées"}),e("th",{className:"px-3 py-2 text-right",children:"Sorties"}),e("th",{className:"px-3 py-2 text-right",children:"Solde"})]})}),e("tbody",{children:W?e("tr",{children:e("td",{colSpan:4,className:"px-3 py-6 text-center text-gray-500",children:"Chargement…"})}):M.length===0?e("tr",{children:e("td",{colSpan:4,className:"px-3 py-6 text-center text-gray-500",children:"Aucun mouvement sur la période."})}):M.map(t=>n("tr",{className:"border-t",children:[e("td",{className:"px-3 py-2",children:new Date(t.dateISO).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}),e("td",{className:"px-3 py-2 text-right",children:o(t.entrees)}),e("td",{className:"px-3 py-2 text-right",children:o(t.sorties)}),e("td",{className:"px-3 py-2 text-right",children:o(t.solde)})]},t.dateISO))})]})})]})]}),!W&&M.length===0&&e("span",{className:"hidden"})]})]})},X=({label:s,value:D})=>n("div",{className:"rounded-2xl border p-4 bg-white shadow-sm",children:[e("div",{className:"text-sm text-gray-500",children:s}),e("div",{className:"text-2xl font-extrabold mt-1",children:D})]});export{Se as default};
