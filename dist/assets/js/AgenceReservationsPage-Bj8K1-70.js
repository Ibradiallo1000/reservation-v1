import{u as P,r as n,j as e}from"./react-Bg_vEni-.js";import{h as x,f as u,q as U,w as y}from"./firebase-C3aZpI0W.js";import{u as G,d as b}from"../index-Dgt8Lr4V.js";import{h as O}from"./html2pdf-DbS8s3Ae.js";import{u as g,w as Q}from"./xlsx-5rFX-EW9.js";import{M as V}from"./ModifierReservationForm-DLDw0kvU.js";import"./vendor-D_4iK-Jm.js";import"./jspdf.es.min-3c6yj3HK.js";import"./html2canvas-BsqIyKfB.js";const D=document.createElement("style");D.innerHTML=`
@media print {
  body * { visibility: hidden !important; }
  #receipt, #receipt * { visibility: visible !important; }
  #receipt {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    padding: 1cm;
    font-size: 12px;
  }
}`;document.head.appendChild(D);const se=()=>{const{user:a}=G(),E=P(),N=n.useRef(null),[m,L]=n.useState(""),[h,F]=n.useState(""),[c,w]=n.useState(""),[C,M]=n.useState([]),[S,R]=n.useState([]),[p,j]=n.useState(""),[H,I]=n.useState([]),[f,_]=n.useState(""),[k,T]=n.useState(null),r=t=>t.trim().charAt(0).toUpperCase()+t.trim().slice(1).toLowerCase(),$=async()=>{if(!m||!h||!(a!=null&&a.companyId))return;const l=(await x(u(b,"dailyTrips"))).docs.map(i=>({id:i.id,...i.data()})).filter(i=>r(i.departure)===r(m)&&r(i.arrival)===r(h)&&i.companyId===a.companyId),s=Array.from(new Set(l.map(i=>i.date)));M(s),w(s[0]||""),R([]),j(""),I([])},q=async()=>{if(!c||!(a!=null&&a.companyId))return;const l=(await x(u(b,"dailyTrips"))).docs.map(s=>({id:s.id,...s.data()})).filter(s=>r(s.departure)===r(m)&&r(s.arrival)===r(h)&&s.date===c&&s.companyId===a.companyId).map(s=>s.time);R(l),j(l[0]||"")},A=async()=>{if(!p||!(a!=null&&a.companyId))return;const d=(await x(u(b,"dailyTrips"))).docs.map(o=>({...o.data(),id:o.id})).filter(o=>r(o.departure)===r(m)&&r(o.arrival)===r(h)&&o.date===c&&o.time===p&&o.companyId===a.companyId);if(d.length===0)return;const l=d[0].id,s=U(u(b,"reservations"),y("trajetId","==",l),y("statut","==","payé"),y("agencyId","==",a.agencyId)),z=(await x(s)).docs.map(o=>({id:o.id,...o.data()}));I(z)},v=H.filter(t=>t.nomClient.toLowerCase().includes(f.toLowerCase())||t.telephone.includes(f));return n.useEffect(()=>{c&&q()},[c]),n.useEffect(()=>{p&&A()},[p]),e.jsxs("div",{className:"p-6 bg-white min-h-screen",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Liste de Réservations"}),e.jsxs("div",{className:"flex flex-wrap gap-3 mb-4 items-center",children:[e.jsx("input",{value:m,onChange:t=>L(t.target.value),placeholder:"Départ",className:"border p-2 rounded"}),e.jsx("input",{value:h,onChange:t=>F(t.target.value),placeholder:"Arrivée",className:"border p-2 rounded"}),e.jsx("button",{onClick:$,className:"bg-yellow-500 text-white px-4 py-2 rounded",children:"Rechercher"}),e.jsx("input",{type:"text",placeholder:"Recherche nom ou téléphone",value:f,onChange:t=>_(t.target.value),className:"border p-2 rounded flex-1"})]}),C.length>0&&e.jsx("div",{className:"flex gap-2 flex-wrap mb-4",children:C.map(t=>e.jsx("button",{onClick:()=>w(t),className:`px-3 py-1 rounded-full text-sm border ${c===t?"bg-yellow-600 text-white":"bg-yellow-100 text-yellow-800"}`,children:t},t))}),S.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Choisir une heure :"}),e.jsx("select",{value:p,onChange:t=>j(t.target.value),className:"border p-2 rounded",children:S.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"mb-4 flex justify-between items-center flex-wrap gap-3",children:[e.jsx("button",{onClick:()=>E(-1),className:"text-sm text-blue-500 underline",children:"← Retour"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>O().from(N.current).save(),className:"bg-green-600 text-white px-4 py-2 rounded",children:"📄 PDF"}),e.jsx("button",{onClick:()=>window.print(),className:"bg-blue-600 text-white px-4 py-2 rounded",children:"🖨️ Imprimer"}),e.jsx("button",{onClick:()=>{const t=v.map((s,i)=>({"#":i+1,Nom:s.nomClient,Téléphone:s.telephone,Lieux:`${s.depart} → ${s.arrivee}`,Référence:s.id,Type:s.canal})),d=g.json_to_sheet(t),l=g.book_new();g.book_append_sheet(l,d,"Réservations"),Q(l,"Reservations.xlsx")},className:"bg-purple-600 text-white px-4 py-2 rounded",children:"📊 Excel"})]})]}),e.jsxs("div",{id:"receipt",className:"border rounded-xl p-4 shadow",ref:N,children:[e.jsx("h2",{className:"text-center font-bold text-lg mb-2",children:"LISTE DE RÉSERVATION"}),c&&p&&e.jsx("div",{className:"text-center text-sm text-gray-600 mb-4",children:e.jsxs("div",{children:[c," • ",p," • ",m," → ",h]})}),e.jsxs("table",{className:"w-full text-sm border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border p-2",children:"#"}),e.jsx("th",{className:"border p-2",children:"Nom"}),e.jsx("th",{className:"border p-2",children:"Téléphone"}),e.jsx("th",{className:"border p-2",children:"Lieux"}),e.jsx("th",{className:"border p-2",children:"Référence"}),e.jsx("th",{className:"border p-2",children:"Type"})]})}),e.jsx("tbody",{children:v.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center p-4 text-gray-500",children:"Aucune réservation pour ce trajet."})}):v.map((t,d)=>e.jsxs("tr",{className:"hover:bg-yellow-50",children:[e.jsx("td",{className:"border p-2 text-center",children:d+1}),e.jsx("td",{className:"border p-2",children:t.nomClient}),e.jsx("td",{className:"border p-2",children:t.telephone}),e.jsxs("td",{className:"border p-2",children:[t.depart," → ",t.arrivee]}),e.jsx("td",{className:"border p-2",children:t.id.slice(0,6)}),e.jsxs("td",{className:"border p-2 text-center",children:[t.canal==="guichet"?"🧾 Guichet":"🌐 En ligne",e.jsx("br",{}),e.jsx("button",{onClick:()=>T(t),className:"text-indigo-600 hover:underline text-xs mt-1",children:"✏️ Modifier"})]})]},t.id))})]}),e.jsx("div",{className:"mt-6 text-right text-sm italic",children:"Signature et cachet de la compagnie"})]}),k&&e.jsx(V,{reservation:k,onClose:()=>T(null),onUpdated:A})]})};export{se as default};
