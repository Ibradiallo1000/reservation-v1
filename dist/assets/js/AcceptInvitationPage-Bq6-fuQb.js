import{r as l,j as e,a}from"./vendor-Bq-8_m9i.js";import{r as U,t as _,w as O,u as V,o as x,q as W,a0 as B,a1 as K,v as T,x as h,y as I,z as F}from"./firebase-CURBI7X6.js";import{m as G,d as u,y as L}from"./agence-Bsj2lp2X.js";import{d as H,a as J}from"./router-DoGdw-3y.js";import"./compagnie-DiuZFnHS.js";import"./icons-C0JHUK9Z.js";import"./courier-CoQgRaHG.js";function Q(c,d){return c==="company_ceo"?"admin_compagnie":c==="comptable"&&d?"agency_accountant":c==="comptable"?"company_accountant":c}const re=()=>{const c=G(),{invitationId:d}=H(),b=J(),[t,j]=l.useState(null),[S,y]=l.useState(!0),[v,N]=l.useState(!1),[p,s]=l.useState(null),[z,E]=l.useState(!1),[A,P]=l.useState(0),[g,R]=l.useState(""),[w,q]=l.useState(""),[f,k]=l.useState("");l.useEffect(()=>{if(!d){s("Lien d'invitation invalide."),y(!1);return}(async()=>{try{const r=U(_(u,"invitations"),O("token","==",d));let i=(await V(r)).docs[0]??null;if(!i){const M=x(u,"invitations",d),C=await W(M);C.exists()&&(i=C)}if(!i){s("Invitation introuvable. Le lien est peut-être expiré ou invalide.");return}const o=i.data();if(o.status!=="pending"){s("Cette invitation a déjà été utilisée.");return}const m={id:i.id,email:o.email||"",role:o.role||"",fullName:o.fullName,companyId:o.companyId,agencyId:o.agencyId,status:o.status,token:o.token};j(m),m.fullName&&k(m.fullName)}catch(r){console.error("Error loading invitation:",r),s("Erreur lors du chargement de l'invitation.")}finally{y(!1)}})()},[d,A]);const D=async r=>{if(r.preventDefault(),!!t){if(g.length<6){s("Le mot de passe doit contenir au moins 6 caractères.");return}if(g!==w){s("Les mots de passe ne correspondent pas.");return}if(!f.trim()){s("Le nom complet est requis.");return}s(null),N(!0);try{const i=(await B(L,t.email,g)).user;await K(i,{displayName:f.trim()});const o=Q(t.role,t.agencyId);if(await T(x(u,"users",i.uid),{uid:i.uid,email:t.email,nom:f.trim(),role:o,companyId:t.companyId||"",agencyId:t.agencyId||"",createdAt:h(),lastLogin:h(),invitationId:t.id}),await I(x(u,"invitations",t.id),{status:"accepted",acceptedAt:h(),uid:i.uid}),t.companyId&&t.agencyId){const m=x(u,"companies",t.companyId,"agences",t.agencyId,"users",t.id);try{await I(m,{invitationPending:!1,uid:i.uid})}catch{}}await F(L),E(!0)}catch(n){console.error("Account creation error:",n),(n==null?void 0:n.code)==="auth/email-already-in-use"?s("Un compte existe déjà avec cet email. Connectez-vous directement ou contactez l'administrateur."):(n==null?void 0:n.code)==="auth/weak-password"?s("Le mot de passe est trop faible. Utilisez au moins 6 caractères."):s((n==null?void 0:n.message)||"Erreur lors de la création du compte.")}finally{N(!1)}}};return S?e("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:a("div",{className:"text-center",children:[e("div",{className:"w-10 h-10 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"}),e("p",{className:"text-sm text-gray-500",children:"Chargement de l'invitation…"})]})}):p&&!t?e("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:a("div",{className:"bg-white border border-red-200 rounded-xl p-8 max-w-md w-full text-center",children:[e("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e("svg",{className:"w-6 h-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Invitation invalide"}),e("p",{className:"text-sm text-red-600 mb-4",children:p}),!c&&e("p",{className:"text-xs text-amber-700 mb-4",children:"Connexion indisponible. Vérifiez le réseau puis réessayez."}),e("div",{className:"flex items-center justify-center gap-2 mb-3",children:e("button",{onClick:()=>P(r=>r+1),className:"text-sm px-3 py-1.5 border rounded-lg hover:bg-gray-50",children:"Réessayer"})}),e("button",{onClick:()=>b("/login"),className:"text-sm text-orange-600 hover:underline",children:"Aller à la page de connexion"})]})}):z?e("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:a("div",{className:"bg-white border border-green-200 rounded-xl p-8 max-w-md w-full text-center",children:[e("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e("svg",{className:"w-6 h-6 text-green-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Compte créé avec succès !"}),e("p",{className:"text-sm text-gray-600 mb-6",children:"Votre compte a été activé. Vous pouvez maintenant vous connecter avec votre email et mot de passe."}),e("button",{onClick:()=>b("/login"),className:"w-full bg-orange-600 text-white py-2.5 rounded-lg font-medium hover:bg-orange-700 transition",children:"Se connecter"})]})}):t?e("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:a("form",{onSubmit:D,className:"bg-white p-8 rounded-xl shadow-sm border w-full max-w-md space-y-5",children:[!c&&e("div",{className:"rounded-lg bg-amber-50 border border-amber-200 px-4 py-3",children:e("p",{className:"text-xs text-amber-800",children:"Connexion instable: la création de compte peut échouer."})}),a("div",{className:"text-center",children:[e("div",{className:"w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3",children:e("svg",{className:"w-6 h-6 text-orange-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}),e("h1",{className:"text-xl font-bold text-gray-900",children:"Activer votre compte"}),e("p",{className:"text-sm text-gray-500 mt-1",children:"Définissez votre mot de passe pour accéder à la plateforme."})]}),a("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e("input",{value:t.email,disabled:!0,className:"w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 text-gray-600 text-sm"})]}),a("div",{children:[a("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Nom complet ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{type:"text",value:f,onChange:r=>k(r.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500/20",placeholder:"Votre nom complet",required:!0})]}),a("div",{children:[a("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Mot de passe ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{type:"password",value:g,onChange:r=>R(r.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500/20",placeholder:"Minimum 6 caractères",minLength:6,required:!0})]}),a("div",{children:[a("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Confirmer le mot de passe ",e("span",{className:"text-red-500",children:"*"})]}),e("input",{type:"password",value:w,onChange:r=>q(r.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500/20",placeholder:"Retapez votre mot de passe",minLength:6,required:!0})]}),e("div",{className:"rounded-lg bg-orange-50 border border-orange-200 px-4 py-3",children:a("p",{className:"text-xs text-orange-800",children:[e("strong",{children:"Rôle attribué :"})," ",t.role==="company_ceo"?"Administrateur Compagnie (CEO)":t.role]})}),p&&e("div",{className:"rounded-lg bg-red-50 border border-red-200 px-4 py-3",children:e("p",{className:"text-sm text-red-700",children:p})}),e("button",{type:"submit",disabled:v,className:"w-full bg-orange-600 text-white py-2.5 rounded-lg font-medium hover:bg-orange-700 transition disabled:opacity-60 disabled:cursor-not-allowed",children:v?a("span",{className:"flex items-center justify-center gap-2",children:[e("span",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Création du compte…"]}):"Créer mon compte"})]})}):null};export{re as default};
