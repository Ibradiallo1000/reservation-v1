import{r as n,a as e,j as a}from"./vendor-Bq-8_m9i.js";import{u as O,r as j,I as Ge,t as w,q as fe,o as D,w as K,G as Z,x as Y,y as be,E as Oe,K as je,T as Ne}from"./firebase-CURBI7X6.js";import{d as o,l as Re,O as ee,B as ve,F as qe}from"./agence-Bsj2lp2X.js";import{d as Ie,a as ke,L as Be}from"./router-DoGdw-3y.js";import{C as R,q,s as I,t as k}from"./compagnie-DiuZFnHS.js";import{m as Se,Z as B,l as $,a9 as $e,bc as Ue,ae as Ve,bd as ze}from"./icons-C0JHUK9Z.js";import"./courier-CoQgRaHG.js";const Xe=new Intl.NumberFormat("fr-FR"),Fe=[{name:"Bénin",code:"BJ",phone:"+229",currency:"XOF",currencySymbol:"FCFA"},{name:"Burkina Faso",code:"BF",phone:"+226",currency:"XOF",currencySymbol:"FCFA"},{name:"Cap-Vert",code:"CV",phone:"+238",currency:"CVE",currencySymbol:"CVE"},{name:"Côte d'Ivoire",code:"CI",phone:"+225",currency:"XOF",currencySymbol:"FCFA"},{name:"Gambie",code:"GM",phone:"+220",currency:"GMD",currencySymbol:"GMD"},{name:"Ghana",code:"GH",phone:"+233",currency:"GHS",currencySymbol:"GH₵"},{name:"Guinée",code:"GN",phone:"+224",currency:"GNF",currencySymbol:"GNF"},{name:"Guinée-Bissau",code:"GW",phone:"+245",currency:"XOF",currencySymbol:"FCFA"},{name:"Libéria",code:"LR",phone:"+231",currency:"LRD",currencySymbol:"LRD"},{name:"Mali",code:"ML",phone:"+223",currency:"XOF",currencySymbol:"FCFA"},{name:"Mauritanie",code:"MR",phone:"+222",currency:"MRU",currencySymbol:"MRU"},{name:"Niger",code:"NE",phone:"+227",currency:"XOF",currencySymbol:"FCFA"},{name:"Nigéria",code:"NG",phone:"+234",currency:"NGN",currencySymbol:"₦"},{name:"Sénégal",code:"SN",phone:"+221",currency:"XOF",currencySymbol:"FCFA"},{name:"Sierra Leone",code:"SL",phone:"+232",currency:"SLE",currencySymbol:"SLE"},{name:"Togo",code:"TG",phone:"+228",currency:"XOF",currencySymbol:"FCFA"}];function Ce(d){return d.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)+/g,"")}const f="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 focus:border-[var(--btn-primary,#FF6600)] focus:outline-none focus:ring-2 focus:ring-[var(--btn-primary,#FF6600)]/20 disabled:opacity-50",ae=`${f} appearance-none`,Ye=()=>{const{id:d}=Ie(),l=!!d,U=ke(),[b,te]=n.useState(""),[m,V]=n.useState(""),[p,re]=n.useState(""),[ne,z]=n.useState(""),[X,_]=n.useState(""),[H,Q]=n.useState(""),[P,ie]=n.useState(""),[se,le]=n.useState(""),[ce,oe]=n.useState(""),[M,Ee]=n.useState(""),[h,we]=n.useState(""),[de,De]=n.useState(""),[Pe,Me]=n.useState([]),[g,me]=n.useState(""),[i,W]=n.useState(null),[c,ue]=n.useState(!1),[pe,he]=n.useState("actif"),[Te,ge]=n.useState(!0),[T,J]=n.useState(!1),[A,L]=n.useState(null),[N,S]=n.useState(""),[F,C]=n.useState("");n.useEffect(()=>{(async()=>{const t=await O(j(w(o,"plans"),Ge("priceMonthly","asc")));Me(t.docs.map(r=>{const s=r.data();return{id:r.id,name:s.name,priceMonthly:s.priceMonthly,isTrial:!!s.isTrial,trialDurationDays:Number(s.trialDurationDays)||0}}))})()},[]),n.useEffect(()=>{if(!l){ge(!1);return}(async()=>{const t=await fe(D(o,"companies",d));if(!t.exists()){U("/admin/compagnies");return}const r=t.data();te(r.nom??""),V(r.slug??""),re(r.pays??""),z(r.phoneCountryCode??""),ie(r.telephonePrincipal??r.telephone??""),le(r.telephoneSecondaire??""),oe(r.emailVitrine??r.email??""),_(r.devise??""),Q(r.deviseSymbol??""),he(r.status??"actif"),me(r.planId??""),ge(!1)})()},[d,l,U]),n.useEffect(()=>{if(!g){W(null);return}(async()=>{const t=await fe(D(o,"plans",g));if(t.exists()){const r=t.data();W(r),r.isTrial&&!l&&ue(!0)}else W(null)})()},[g,l]),n.useEffect(()=>{!l&&b&&V(Ce(b))},[b,l]),n.useEffect(()=>{const t=Fe.find(r=>r.name===p);t?(z(t.phone),_(t.currency),Q(t.currencySymbol)):(z(""),_(""),Q(""))},[p]);const ye=n.useMemo(()=>{const t=b.trim()&&m.trim()&&p.trim()&&P.trim()&&g&&!T&&!N;return l?!!t:!!(t&&M.trim()&&h.trim()&&!F)},[b,m,p,P,g,T,N,l,M,h,F]);n.useEffect(()=>{if(!m.trim()){S("");return}const t=setTimeout(async()=>{try{const r=j(w(o,"companies"),K("slug","==",m.trim()),Z(1)),s=await O(r);if(s.empty)S("");else{const u=s.docs[0].id;S(l&&u===d?"":"Ce slug est déjà utilisé par une autre compagnie.")}}catch{S("")}},500);return()=>clearTimeout(t)},[m,l,d]),n.useEffect(()=>{if(l||!h.trim()){C("");return}const t=setTimeout(async()=>{try{const r=h.trim().toLowerCase(),s=j(w(o,"invitations"),K("email","==",r),Z(1));if(!(await O(s)).empty){C("Cet email a déjà une invitation en cours.");return}const y=j(w(o,"users"),K("email","==",r),Z(1));if(!(await O(y)).empty){C("Un utilisateur existe déjà avec cet email.");return}C("")}catch{C("")}},500);return()=>clearTimeout(t)},[h,l]);function Ae(t,r,s){const u=new Date,y=t.trialDurationDays??30,v=(s?y:30)*24*60*60*1e3,x=Ne.fromDate(u),E=Ne.fromDate(new Date(u.getTime()+v)),G={priceMonthly:t.priceMonthly??0,quotaReservations:t.quotaReservations??0,digitalFeePercent:t.digitalFeePercent??0,feeGuichet:t.feeGuichet??0,minimumMonthly:t.minimumMonthly??0,maxAgences:t.maxAgences??0,supportLevel:t.supportLevel??"basic",features:{publicPage:!0,onlineBooking:!0,guichet:!0}},xe=(t.priceMonthly??0)===0;return s?{status:"trial",planId:r,planName:t.name,planType:"trial",isFree:xe,currentPeriodStart:x,currentPeriodEnd:E,trialEndsAt:E,snapshot:G}:{status:"active",planId:r,planName:t.name,planType:"paid",isFree:xe,currentPeriodStart:x,currentPeriodEnd:E,snapshot:G}}async function Le(t){if(t.preventDefault(),!ye||!i)return;J(!0),L(null);let r=null;try{const s=Ae(i,g,c),u=c?"actif":pe,y={nom:b.trim(),slug:m.trim(),pays:p.trim(),phoneCountryCode:ne,devise:X,deviseSymbol:H,telephonePrincipal:P.trim(),telephoneSecondaire:se.trim()||null,emailVitrine:ce.trim()||null,status:u,planId:g,plan:i.name,digitalFeePercent:s.snapshot.digitalFeePercent,feeGuichet:s.snapshot.feeGuichet,minimumMonthly:s.snapshot.minimumMonthly,maxAgences:s.snapshot.maxAgences,supportLevel:s.snapshot.supportLevel,planType:s.planType,publicPageEnabled:!0,onlineBookingEnabled:!0,guichetEnabled:!0,subscription:s,subscriptionStatus:c?"trial":"active",nextBillingDate:s.currentPeriodEnd,updatedAt:Y()};c&&(y.trialEndsAt=s.trialEndsAt??null),l||Object.assign(y,{couleurPrimaire:"#FF6600",couleurSecondaire:"#FFFFFF",imagesSlider:[],createdAt:Y()}),l?(await be(D(o,"companies",d),y),r=d):r=(await Oe(w(o,"companies"),y)).id;let v="";if(!l&&h.trim())try{v=(await qe({email:h,role:"company_ceo",companyId:r,fullName:M,phone:de||void 0,createdBy:"admin_platform"})).activationUrl}catch(x){if(console.error("CEO invitation failed, rolling back company:",x),r)try{await je(D(o,"companies",r))}catch(G){console.error("Rollback delete failed, marking as pending_setup:",G),await be(D(o,"companies",r),{status:"pending_setup",updatedAt:Y()})}const E=x instanceof Error?x.message:"Erreur lors de l'envoi de l'invitation CEO.";L({type:"error",text:`L'invitation CEO a échoué : ${E}. La compagnie a été annulée. Veuillez réessayer.`}),J(!1);return}L({type:"success",text:l?"Compagnie mise à jour avec succès.":v?`Compagnie créée ! Lien d'activation CEO : ${v}`:"Compagnie créée avec succès."}),setTimeout(()=>U("/admin/compagnies"),1500)}catch(s){console.error(s);const u=s instanceof Error?s.message:"Erreur lors de l'enregistrement.";L({type:"error",text:u})}finally{J(!1)}}return Te?e("div",{className:"flex items-center justify-center py-16",children:[a(Se,{className:"h-6 w-6 animate-spin text-gray-400"}),a("span",{className:"ml-2 text-gray-500",children:"Chargement…"})]}):e("div",{className:"p-4 md:p-6 max-w-7xl mx-auto space-y-6",children:[e("div",{children:[a("h1",{className:"text-2xl font-bold text-gray-900",children:l?"Modifier la compagnie":"Configuration initiale d'une compagnie"}),a("p",{className:"text-sm text-gray-500 mt-1",children:l?"Modifiez les informations de la compagnie ci-dessous.":"Remplissez les 4 sections ci-dessous pour créer et configurer une nouvelle compagnie."})]}),A&&e("div",{className:`flex items-center gap-2 rounded-xl border p-4 text-sm ${A.type==="error"?"border-red-200 bg-red-50 text-red-700":"border-green-200 bg-green-50 text-green-700"}`,children:[A.type==="error"?a(B,{className:"h-4 w-4 shrink-0"}):a($,{className:"h-4 w-4 shrink-0"}),A.text]}),e("form",{onSubmit:Le,className:"space-y-6",children:[e(R,{children:[a(I,{children:e(q,{className:"flex items-center gap-2",children:[a($e,{className:"h-5 w-5 text-gray-600"}),"1. Informations de la compagnie"]})}),a(k,{className:"space-y-4",children:e("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e("div",{children:[e("label",{className:"text-sm font-medium text-gray-700",children:["Nom de la compagnie ",a("span",{className:"text-red-500",children:"*"})]}),a("input",{className:f,value:b,onChange:t=>te(t.target.value),placeholder:"Ex: Transport Express Mali",required:!0})]}),e("div",{children:[e("label",{className:"text-sm font-medium text-gray-700",children:["Slug (URL) ",a("span",{className:"text-red-500",children:"*"})]}),a("input",{className:`${f} ${N?"border-red-400 focus:border-red-500 focus:ring-red-200":""}`,value:m,onChange:t=>V(Ce(t.target.value)),placeholder:"transport-express-mali",required:!0}),N&&e("p",{className:"text-xs text-red-500 mt-1 flex items-center gap-1",children:[a(B,{className:"h-3 w-3"})," ",N]}),!N&&m&&e("p",{className:"text-xs text-gray-400 mt-1",children:["URL : teliya.com/",a("span",{className:"font-medium",children:m})]})]}),e("div",{children:[e("label",{className:"text-sm font-medium text-gray-700",children:["Pays ",a("span",{className:"text-red-500",children:"*"})]}),e("select",{className:ae,value:p,onChange:t=>re(t.target.value),required:!0,children:[a("option",{value:"",children:"— Sélectionner un pays —"}),Fe.map(t=>e("option",{value:t.name,children:[t.name," (",t.phone,") — ",Re(t.currency)]},t.code))]})]}),e("div",{children:[a("label",{className:"text-sm font-medium text-gray-700",children:"Devise"}),e("div",{className:"flex",children:[a("span",{className:"inline-flex items-center px-3 text-sm text-gray-600 bg-gray-100 border border-r-0 border-gray-300 rounded-l-xl select-none min-w-[4rem] justify-center font-medium",children:H||"—"}),a("input",{className:"flex-1 rounded-r-xl border border-gray-300 bg-gray-50 px-3 py-2 text-sm text-gray-700",value:X?`${X} (${H})`:"Sélectionnez un pays",readOnly:!0,tabIndex:-1})]}),p&&e("p",{className:"text-xs text-gray-400 mt-1",children:["Devise automatique pour ",a("strong",{children:p})]})]}),e("div",{children:[e("label",{className:"text-sm font-medium text-gray-700",children:["Téléphone principal ",a("span",{className:"text-red-500",children:"*"})]}),e("div",{className:"flex",children:[a("span",{className:"inline-flex items-center px-3 text-sm text-gray-600 bg-gray-100 border border-r-0 border-gray-300 rounded-l-xl select-none min-w-[4rem] justify-center",children:ne||"—"}),a("input",{type:"tel",className:"flex-1 rounded-r-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 focus:border-[var(--btn-primary,#FF6600)] focus:outline-none focus:ring-2 focus:ring-[var(--btn-primary,#FF6600)]/20",value:P,onChange:t=>ie(t.target.value),placeholder:"76 12 34 56",required:!0})]})]}),e("div",{children:[a("label",{className:"text-sm font-medium text-gray-700",children:"Téléphone secondaire"}),a("input",{className:f,value:se,onChange:t=>le(t.target.value),placeholder:"Optionnel"})]}),e("div",{children:[a("label",{className:"text-sm font-medium text-gray-700",children:"Email vitrine / contact"}),a("input",{className:f,type:"email",value:ce,onChange:t=>oe(t.target.value),placeholder:"contact@compagnie.com (optionnel)"})]})]})})]}),!l&&e(R,{children:[a(I,{children:e(q,{className:"flex items-center gap-2",children:[a(Ue,{className:"h-5 w-5 text-gray-600"}),"2. Compte du dirigeant (CEO)"]})}),e(k,{className:"space-y-4",children:[e("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e("div",{children:[e("label",{className:"text-sm font-medium text-gray-700",children:["Nom complet ",a("span",{className:"text-red-500",children:"*"})]}),a("input",{className:f,value:M,onChange:t=>Ee(t.target.value),placeholder:"Prénom et nom du CEO",required:!0})]}),e("div",{children:[e("label",{className:"text-sm font-medium text-gray-700",children:["Email du CEO ",a("span",{className:"text-red-500",children:"*"})]}),a("input",{className:`${f} ${F?"border-red-400 focus:border-red-500 focus:ring-red-200":""}`,type:"email",value:h,onChange:t=>we(t.target.value),placeholder:"ceo@compagnie.com",required:!0}),F&&e("p",{className:"text-xs text-red-500 mt-1 flex items-center gap-1",children:[a(B,{className:"h-3 w-3"})," ",F]})]}),e("div",{children:[a("label",{className:"text-sm font-medium text-gray-700",children:"Téléphone du CEO"}),a("input",{className:f,value:de,onChange:t=>De(t.target.value),placeholder:"Optionnel"})]})]}),e("p",{className:"text-xs text-gray-500 flex items-center gap-1 mt-2",children:[a(B,{className:"h-3 w-3 text-gray-400"}),"Un email d'activation sera envoyé à cette adresse."]})]})]}),e(R,{children:[a(I,{children:e(q,{className:"flex items-center gap-2",children:[a(Ve,{className:"h-5 w-5 text-gray-600"}),l?"2":"3",". Plan & Période d'essai"]})}),e(k,{className:"space-y-4",children:[e("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e("div",{children:[e("label",{className:"text-sm font-medium text-gray-700",children:["Plan ",a("span",{className:"text-red-500",children:"*"})]}),e("select",{className:ae,value:g,onChange:t=>me(t.target.value),required:!0,children:[a("option",{value:"",children:"— Sélectionner un plan —"}),Pe.map(t=>e("option",{value:t.id,children:[t.name," • ",ee(t.priceMonthly),"/mois"]},t.id))]})]}),!c&&e("div",{children:[a("label",{className:"text-sm font-medium text-gray-700",children:"Statut"}),e("select",{className:ae,value:pe,onChange:t=>he(t.target.value),children:[a("option",{value:"actif",children:"Actif"}),a("option",{value:"inactif",children:"Inactif"})]})]})]}),e("div",{className:"flex items-center gap-3 pt-2",children:[a("button",{type:"button",role:"switch","aria-checked":c,onClick:()=>ue(!c),className:`relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full transition-colors duration-200 ${c?"bg-[var(--btn-primary,#FF6600)]":"bg-gray-300"}`,children:a("span",{className:`inline-block h-5 w-5 transform rounded-full bg-white shadow-sm transition-transform duration-200 mt-0.5 ${c?"translate-x-5 ml-0.5":"translate-x-0.5"}`})}),a("span",{className:"text-sm text-gray-700",children:"Activer période d'essai (30 jours)"})]}),c&&e("div",{className:"rounded-lg bg-amber-50 border border-amber-200 p-3 text-sm text-amber-800",children:["La compagnie sera automatiquement ",a("strong",{children:"active"})," pendant"," ",a("strong",{children:i!=null&&i.trialDurationDays&&i.trialDurationDays>0?`${i.trialDurationDays} jours`:"30 jours"})," ","à compter de la création. À l'issue de cette période, une action manuelle sera nécessaire."]}),i&&e("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-4",children:[e("div",{className:"flex items-center justify-between mb-2",children:[e("h4",{className:"text-sm font-semibold text-gray-700",children:["Détails du plan : ",i.name]}),i.isTrial&&a("span",{className:"inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700",children:"Essai"})]}),e("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-gray-600",children:[e("div",{children:["Prix : ",e("strong",{children:[ee(i.priceMonthly),"/mois"]})]}),e("div",{children:["Frais canal digital :"," ",e("strong",{className:"text-[var(--btn-primary,#FF6600)]",children:[i.digitalFeePercent??0,"%"]})]}),e("div",{children:["Frais guichet :"," ",a("strong",{children:ee(i.feeGuichet??0)})]}),e("div",{children:["Max agences :"," ",a("strong",{children:(i.maxAgences??0)===0?"Illimité":i.maxAgences})]}),e("div",{children:["Quota réservations :"," ",a("strong",{children:(i.quotaReservations??0)===0?"Illimité":Xe.format(i.quotaReservations??0)})]}),e("div",{children:["Support :"," ",a("strong",{className:"capitalize",children:i.supportLevel??"basic"})]})]}),e("div",{className:"flex flex-wrap gap-2 mt-3",children:[e("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[a($,{className:"h-3 w-3"})," Page publique"]}),e("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[a($,{className:"h-3 w-3"})," Réservation en ligne"]}),e("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[a($,{className:"h-3 w-3"})," Guichet"]})]})]})]})]}),!l&&e(R,{children:[a(I,{children:e(q,{className:"flex items-center gap-2",children:[a(ze,{className:"h-5 w-5 text-gray-600"}),"4. Configuration système par défaut"]})}),e(k,{className:"space-y-4",children:[e("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-4 text-sm text-gray-600 space-y-2",children:[a("p",{className:"font-medium text-gray-700",children:"Thème & Galerie"}),e("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e("li",{children:["Couleur primaire :"," ",e("span",{className:"inline-flex items-center gap-1",children:[a("span",{className:"inline-block h-3 w-3 rounded-full border",style:{backgroundColor:"#FF6600"}}),a("code",{className:"text-xs bg-white px-1 rounded",children:"#FF6600"})]})]}),e("li",{children:["Couleur secondaire :"," ",e("span",{className:"inline-flex items-center gap-1",children:[a("span",{className:"inline-block h-3 w-3 rounded-full border",style:{backgroundColor:"#FFFFFF"}}),a("code",{className:"text-xs bg-white px-1 rounded",children:"#FFFFFF"})]})]}),a("li",{children:"Galerie d'images : vide (à configurer ultérieurement)"})]})]}),e("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-4 text-sm text-gray-600 space-y-2",children:[a("p",{className:"font-medium text-gray-700",children:"Objet Subscription"}),e("p",{children:["Un objet ",a("code",{className:"text-xs bg-white px-1 rounded border",children:"subscription"})," sera créé avec :"]}),e("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e("li",{children:["Statut :"," ",a("code",{className:"text-xs bg-white px-1 rounded border",children:c?"trial":"active"})]}),e("li",{children:["Type :"," ",a("code",{className:"text-xs bg-white px-1 rounded border",children:c?"trial":"paid"})]}),e("li",{children:["Période : ",c&&(i!=null&&i.trialDurationDays)?`${i.trialDurationDays} jours`:"30 jours"," à compter de la création",c&&" (essai)"]}),e("li",{children:["Frais canal digital :"," ",e("strong",{children:[(i==null?void 0:i.digitalFeePercent)??0,"%"]})," sur les réservations en ligne"]}),e("li",{children:["Niveau de support :"," ",a("strong",{className:"capitalize",children:(i==null?void 0:i.supportLevel)??"basic"})]}),a("li",{children:"Snapshot du plan : tarification et limites figées au moment de la création"}),a("li",{children:"Fonctionnalités : toutes incluses (page publique, réservation en ligne, guichet)"})]})]}),e("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-4 text-sm text-gray-600 space-y-2",children:[a("p",{className:"font-medium text-gray-700",children:"Cycle de paiement"}),a("p",{children:"Les champs de cycle de vie seront préparés :"}),e("ul",{className:"list-disc list-inside space-y-1 ml-2",children:[e("li",{children:[a("code",{className:"text-xs bg-white px-1 rounded border",children:"subscriptionStatus"})," :"," ",a("code",{className:"text-xs bg-white px-1 rounded border",children:"active"})]}),e("li",{children:[a("code",{className:"text-xs bg-white px-1 rounded border",children:"nextBillingDate"})," : fin de période"]}),e("li",{className:"text-gray-400",children:[a("code",{className:"text-xs bg-white px-1 rounded border",children:"lastPaymentDate"}),","," ",a("code",{className:"text-xs bg-white px-1 rounded border",children:"graceUntil"})," : à remplir ultérieurement"]})]})]})]})]}),e("div",{className:"flex items-center gap-3 pt-2",children:[e(ve,{type:"submit",variant:"primary",disabled:!ye,children:[T&&a(Se,{className:"h-4 w-4 animate-spin"}),T?"Enregistrement…":l?"Mettre à jour":"Créer la compagnie"]}),a(Be,{to:"/admin/compagnies",children:a(ve,{type:"button",variant:"secondary",children:"Annuler"})})]})]})]})};export{Ye as default};
