import{j as e,a as t,aS as G,d as B,u as O,b as V,r as c,C as J,M as Q,U as _,T as K,A as W,s as X,aT as Y,aQ as Z,aA as ee,aU as te,a4 as re}from"./react-DgrrIcw2.js";import{d as D,f as U}from"./firebase-eGIzIftJ.js";import{d as P,s as T,h as y}from"../index-p6Te0bSg.js";import{h as ae}from"./html2pdf-CvzpMzG0.js";import{p as ne,J as oe,a5 as se}from"./vendor-BHjJ2Hjk.js";import"./jspdf.es.min-Cptl_4Ji.js";import"./html2canvas-CfelDGmq.js";const ie=({fullScreen:h=!1,className:u=""})=>e("div",{className:`flex items-center justify-center ${h?"min-h-screen":""} ${u}`,children:e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}),ce=({message:h,onRetry:u,onHome:m})=>e("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:e("div",{className:"p-6 rounded-lg max-w-md bg-white shadow-sm border border-red-200",children:t("div",{className:"flex flex-col items-center",children:[e(G,{className:"h-12 w-12 text-red-500 mb-4"}),e("h2",{className:"text-xl font-bold mb-2 text-red-600",children:"Erreur"}),e("p",{className:"mb-6 text-gray-700",children:h}),t("div",{className:"flex gap-3",children:[u&&e("button",{onClick:u,className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition",children:"Réessayer"}),m&&e("button",{onClick:m,className:"px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300 transition",children:"Accueil"})]})]})})}),xe=()=>{var j,A;const{id:h,slug:u}=B(),m=O(),$=V(),{companyInfo:k,reservation:g,from:b}=$.state||{},[r,z]=c.useState(null),[s,q]=c.useState(null),[I,N]=c.useState(!0),[E,x]=c.useState(null),v=c.useRef(null),M=c.useCallback((n,o)=>{try{let i;return typeof n=="string"?i=ne(n):n instanceof Date?i=n:i=new Date(n.seconds*1e3),oe(i,o,{locale:se})}catch{return"--/--/----"}},[]),w=c.useCallback(()=>{if(!r)return"BIL-000000";const n=r.depart.slice(0,3).toUpperCase(),o=r.arrivee.slice(0,3).toUpperCase(),i=(r.agenceNom||r.agencyNom||r.nomAgence||"AGC").slice(0,3).toUpperCase(),l=r.id.substring(r.id.length-6).toUpperCase();return`${i}-${n}${o}-${l}`},[r]),R=c.useCallback(async()=>{if(!h)return x("ID de réservation manquant"),N(!1),null;try{if(!g)throw new Error("Données de réservation manquantes");const n=g.compagnieId,o=g.agencyId;if(!n||!o)throw new Error("Identifiants manquants");const i=D(P,"companies",n,"agences",o,"reservations",h),l=await U(i);if(!l.exists())throw new Error("Réservation introuvable");const p=l.data();return{...p,id:l.id,createdAt:p.createdAt instanceof Date?p.createdAt:new Date(p.createdAt.seconds*1e3)}}catch(n){return x(n instanceof Error?n.message:"Erreur inconnue"),null}},[h,g]),S=c.useCallback(async n=>{var o,i;try{const l=D(P,"companies",n),p=await U(l);if(!p.exists())throw new Error("Compagnie non trouvée");const d=p.data();return{id:p.id,nom:d.nom,logoUrl:d.logoUrl,couleurPrimaire:((o=d.theme)==null?void 0:o.primary)||d.couleurPrimaire||"#3b82f6",couleurSecondaire:((i=d.theme)==null?void 0:i.secondary)||d.couleurSecondaire||"#93c5fd",slug:d.slug,telephone:d.telephone,banniereUrl:d.banniereUrl}}catch(l){return x(l instanceof Error?l.message:"Erreur compagnie"),null}},[]);c.useEffect(()=>{(async()=>{N(!0),x(null);try{if(!g||!k)throw new Error("Données manquantes. Vous devez accéder à cette page depuis une réservation valide.");const o=await R();if(!o)return;const i=await S(o.compagnieId);if(!i)return;z(o),q(i)}catch(o){x(o instanceof Error?o.message:"Erreur inattendue")}finally{N(!1)}})()},[R,S,g,k]);const F=c.useCallback(()=>{if(v.current){const n={margin:2,filename:`recu-${w()}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,letterRendering:!0,width:340},jsPDF:{unit:"mm",format:[81,200],orientation:"portrait"}};ae().set(n).from(v.current).save()}},[w]),L=c.useCallback(()=>{m(b||-1)},[b,m]);if(I||!s)return e(ie,{fullScreen:!0});if(E||!r||!s)return e(ce,{message:E||"Erreur de chargement",onRetry:()=>window.location.reload(),onHome:()=>m("/")});const H=`${window.location.origin}/compagnie/${s.slug}/receipt/${r.id}`,a=s.couleurPrimaire,C=s.couleurSecondaire,f=T(a);return t("div",{className:"min-h-screen bg-gray-50 print:bg-white",style:{"--primary":a,"--secondary":C,"--text-on-primary":f},children:[e("style",{children:`
        @media print {
          body, html {
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            background: white !important;
            width: 81mm !important;
          }
          .receipt-container {
            width: 81mm !important;
            max-width: 81mm !important;
            padding: 3mm !important;
            font-size: 11px !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            border: none !important;
            page-break-after: avoid !important;
          }
          .compact-section {
            margin-bottom: 3px !important;
            padding: 2px !important;
          }
          .qr-code-container {
            width: 60px !important;
            height: 60px !important;
            margin: 0 auto !important;
          }
          .print-text-sm {
            font-size: 10px !important;
          }
          .print-py-1 {
            padding-top: 1px !important;
            padding-bottom: 1px !important;
          }
          .no-print {
            display: none !important;
          }
          .print-border-top {
            border-top: 4px solid var(--primary) !important;
          }
        }
      `}),e("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm no-print",style:{backgroundColor:a,color:f},children:t("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e("button",{onClick:L,className:"p-2 rounded-full hover:bg-white/10 transition","aria-label":"Retour",children:e(J,{className:"h-5 w-5"})}),t("div",{className:"flex items-center gap-3",children:[s.logoUrl&&e("img",{src:s.logoUrl,alt:`Logo ${s.nom}`,className:"h-10 w-10 rounded-full object-cover border-2",style:{borderColor:f,backgroundColor:y(a,.2)},onError:n=>{n.target.src="/default-company.png"}}),t("div",{className:"flex flex-col",children:[e("h1",{className:"text-sm font-bold",children:"Reçu de voyage"}),e("p",{className:"text-xs opacity-90",children:s.nom})]})]})]})}),t("div",{className:"max-w-[81mm] mx-auto p-2 print:p-0 print:max-w-none",children:[t("div",{ref:v,className:"receipt-container bg-white rounded-lg shadow-sm overflow-hidden print-border-top",style:{width:"81mm",margin:"0 auto"},children:[t("div",{className:"flex justify-between items-center border-b pb-2 mb-2 px-3",style:{borderColor:y(a,.3)},children:[t("div",{className:"flex items-center gap-2",children:[s.logoUrl&&e("img",{src:s.logoUrl,alt:s.nom,className:"h-9 w-9 object-contain rounded border",style:{borderColor:a},onError:n=>{n.target.src="/default-company.png"}}),t("div",{className:"leading-tight",children:[e("h2",{className:"text-sm font-bold",style:{color:a},children:s.nom}),t("p",{className:"text-[11px] text-gray-700 flex items-center gap-1",children:[e(Q,{className:"h-3 w-3 text-gray-500"}),(r.agenceNom||r.agencyNom||r.nomAgence||"Agence inconnue").trim()]})]})]}),t("div",{className:"text-right leading-tight pr-2",children:[t("p",{className:"text-[11px] font-mono tracking-tight text-gray-700",children:["N° ",w()]}),e("span",{className:"px-2 py-0.5 rounded text-[10px] font-medium",style:{backgroundColor:y(a,.15),color:a},children:((j=r.statut)==null?void 0:j.toUpperCase())||"EN ATTENTE"})]})]}),t("div",{className:"p-2 print:p-1 space-y-2 print-py-1",children:[t("div",{className:"compact-section",children:[t("div",{className:"flex items-center gap-1 mb-1",children:[e(_,{className:"h-3 w-3",style:{color:a}}),e("h3",{className:"text-xs font-semibold",style:{color:a},children:"Client"})]}),t("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Nom"}),e("p",{className:"truncate",children:r.nomClient})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Téléphone"}),e("p",{children:r.telephone})]}),r.referenceCode&&t("div",{className:"col-span-2",children:[e("p",{className:"text-[10px] text-gray-600",children:"Référence"}),e("p",{className:"font-mono text-[11px]",children:r.referenceCode})]})]})]}),t("div",{className:"compact-section",children:[t("div",{className:"flex items-center gap-1 mb-1",children:[e(K,{className:"h-3 w-3",style:{color:a}}),e("h3",{className:"text-xs font-semibold",style:{color:a},children:"Voyage"})]}),t("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[t("div",{className:"col-span-2",children:[e("p",{className:"text-[10px] text-gray-600",children:"Trajet"}),t("div",{className:"flex items-center gap-1",children:[e("p",{className:"font-medium",children:r.depart}),e(W,{className:"h-3 w-3 text-gray-500"}),e("p",{className:"font-medium",children:r.arrivee})]})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Date"}),e("p",{children:M(r.date,"dd/MM/yyyy")})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Heure"}),e("p",{children:r.heure})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Places"}),t("p",{children:[r.seatsGo," ",r.seatsReturn?`(+${r.seatsReturn} retour)`:""]})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Canal"}),e("p",{className:"capitalize",children:r.canal})]})]})]}),t("div",{className:"compact-section",children:[t("div",{className:"flex items-center gap-1 mb-1",children:[e(X,{className:"h-3 w-3",style:{color:a}}),e("h3",{className:"text-xs font-semibold",style:{color:a},children:"Paiement"})]}),t("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Montant"}),t("p",{className:"font-bold",style:{color:a},children:[(A=r.montant)==null?void 0:A.toLocaleString("fr-FR")," FCFA"]})]}),t("div",{children:[e("p",{className:"text-[10px] text-gray-600",children:"Méthode"}),e("p",{className:"capitalize",children:r.paiement})]})]})]}),t("div",{className:"mt-2 p-1 rounded border border-gray-200 flex flex-col items-center compact-section",children:[e("h3",{className:"text-xs font-semibold mb-1",style:{color:a},children:"Code d'embarquement"}),e("div",{className:"bg-white p-1 rounded border qr-code-container",style:{borderColor:a},children:e(Y,{value:H,size:60,fgColor:a,level:"H"})})]}),t("div",{className:"mt-2 pt-2 border-t border-gray-200 text-center compact-section",style:{fontSize:"10px",color:"#4b5563"},children:[t("p",{className:"mb-1",children:["Merci d'avoir choisi ",s.nom]}),e("p",{className:"italic mb-1",children:"Présentez-vous 1H avant le départ"}),e("p",{className:"font-medium mb-0.5",children:"Pour plus d'infos, veuillez contacter :"}),t("div",{className:"flex justify-center items-center gap-1 text-gray-700",children:[e(Z,{className:"h-3 w-3 text-gray-500"}),e("span",{children:r.agenceTelephone||s.telephone||"—"})]})]})]})]}),t("div",{className:"no-print mt-3 grid grid-cols-1 gap-2",children:[t("button",{onClick:F,className:"flex items-center justify-center gap-2 px-4 py-2 rounded-lg shadow transition-colors text-xs",style:{backgroundColor:a,color:f},children:[e(ee,{className:"h-4 w-4"}),"Télécharger"]}),t("button",{onClick:()=>window.print(),className:"flex items-center justify-center gap-2 px-4 py-2 rounded-lg shadow transition-colors text-xs",style:{backgroundColor:C||y(a,.8),color:T(C||a)},children:[e(te,{className:"h-4 w-4"}),"Imprimer"]}),t("button",{onClick:()=>m("/agence/guichet"),className:"flex items-center justify-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow hover:bg-gray-300 transition-colors text-xs",children:[e(re,{className:"h-4 w-4"}),"Retour à la compagnie"]})]})]})]})};export{xe as default};
