import{r as i,a as s,j as t}from"./react-KXT1Riez.js";import{t as _,o as k,T as B,v as X,u as Y,q as ce,r as de,y as K,G as pe}from"./firebase-DYTOaTLw.js";import{d as x,u as me}from"../index-CBC3XRHi.js";import{E as ue}from"./jspdf.es.min-z1sh-bkM.js";import{a as ge}from"./jspdf.plugin.autotable-CtA5BUKo.js";import"./vendor-B27hBV_J.js";const he=async(r,c,y,f,p,o,g)=>{try{const h=_(x,"companies",r,"agences",g,"weeklyTrips"),b=k(h),C={id:b.id,departure:c.trim(),arrival:y.trim(),price:f,places:o,horaires:p,active:!0,createdAt:B.now(),updatedAt:B.now()};return await X(b,C),b.id}catch(h){throw console.error("Erreur lors de la cr√©ation du trajet:",h),h}},Q=({label:r,value:c,onChange:y})=>{const[f,p]=i.useState([]);return i.useEffect(()=>{(async()=>{const h=(await Y(_(x,"villes"))).docs.map(b=>b.data().nom);p(h)})()},[]),s("div",{children:[t("label",{className:"block font-medium mb-1",children:r}),t("input",{list:"liste-villes",className:"w-full border px-3 py-2 rounded",value:c,onChange:o=>y(o.target.value),placeholder:"Entrer une ville"}),t("datalist",{id:"liste-villes",children:f.map((o,g)=>t("option",{value:o},g))})]})},be=async(r,c)=>{const y=p=>p.trim().toLowerCase().replace(/\s+/g," ").replace(/\b\w/g,o=>o.toUpperCase()),f=[r,c].map(y);for(const p of f){const o=k(x,"villes",p);(await ce(o)).exists()||await X(o,{nom:p})}},H=["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"],Ce=()=>{const{user:r,company:c}=me(),[y,f]=i.useState(""),[p,o]=i.useState(""),[g,h]=i.useState(""),[b,C]=i.useState(""),[M,j]=i.useState({}),[R,m]=i.useState(""),[w,I]=i.useState(!1),[v,Z]=i.useState([]),[G,ee]=i.useState(null),[N,J]=i.useState(null),[P,re]=i.useState(""),[E,te]=i.useState(""),[T,V]=i.useState(1),[z,U]=i.useState(!1),D=10,q={primary:(c==null?void 0:c.couleurPrimaire)||"#06b6d4",secondary:(c==null?void 0:c.couleurSecondaire)||"#8b5cf6"};i.useEffect(()=>{r!=null&&r.role&&(["admin_platforme","admin_compagnie","chefAgence"].includes(r.role)?U(!1):(U(!0),m("‚ùå Acc√®s refus√© : seuls les administrateurs et chefs d'agence peuvent g√©rer les trajets.")))},[r]),i.useEffect(()=>{!z&&(r!=null&&r.companyId)&&(r!=null&&r.agencyId)&&F()},[r,T,P,E,z]);const F=async()=>{if(!(r!=null&&r.companyId)||!(r!=null&&r.agencyId))return;const e=de(_(x,"companies",r.companyId,"agences",r.agencyId,"weeklyTrips")),L=(await Y(e)).docs.map(u=>({id:u.id,...u.data()})).sort((u,$)=>{var S,W;return(((S=$.createdAt)==null?void 0:S.seconds)||0)-(((W=u.createdAt)==null?void 0:W.seconds)||0)}).filter(u=>{var $,S;return(u.departure.toLowerCase().includes(P.toLowerCase())||u.arrival.toLowerCase().includes(P.toLowerCase()))&&(E===""||((S=($=u.horaires)==null?void 0:$[E])==null?void 0:S.length)>0)}).slice((T-1)*D,T*D);Z(L)},ae=async e=>{if(!(!(r!=null&&r.companyId)||!(r!=null&&r.agencyId))&&confirm("Voulez-vous vraiment supprimer ce trajet ?")){I(!0);try{await pe(k(x,"companies",r.companyId,"agences",r.agencyId,"weeklyTrips",e)),F(),m("üóëÔ∏è Trajet supprim√© avec succ√®s.")}catch(a){console.error(a),m("‚ùå Erreur lors de la suppression du trajet.")}finally{I(!1)}}},se=(e,a,n)=>{j(l=>{const d={...l};return d[e]||(d[e]=[]),d[e][a]=n,d})},ne=e=>{j(a=>({...a,[e]:[...a[e]||[],""]}))},ie=(e,a)=>{j(n=>{const l={...n};return l[e]?(l[e].splice(a,1),l):n})},A=e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase(),O=()=>{f(""),o(""),h(""),C(""),j({}),J(null)},le=()=>{const e=new ue;e.text("Liste des trajets",14,14),ge(e,{head:[["D√©part","Arriv√©e","Prix","Places"]],body:v.map(a=>[a.departure,a.arrival,`${a.price} FCFA`,a.places||""])}),e.save("trajets_agence.pdf")},oe=async()=>{if(!["admin_platforme","admin_compagnie","chefAgence"].includes((r==null?void 0:r.role)||""))return m("‚ùå Permission insuffisante pour cette action.");if(!(r!=null&&r.companyId)||!(r!=null&&r.agencyId))return m("‚ùå Agence non reconnue. Reconnectez-vous.");I(!0),m("");const a={};for(const d in M){const L=M[d].filter(u=>u&&u.trim()!=="");L.length>0&&(a[d]=L)}const n=A(y.trim()),l=A(p.trim());if(!n||!l||!g.trim()||!b.trim()||Object.keys(a).length===0)return I(!1),m("‚ö†Ô∏è Tous les champs sont obligatoires (d√©part, arriv√©e, prix, places et au moins un horaire).");try{if(N)await K(k(x,"companies",r.companyId,"agences",r.agencyId,"weeklyTrips",N),{departure:n,arrival:l,price:parseInt(g),places:parseInt(b),horaires:a}),m("‚úÖ Trajet modifi√© avec succ√®s.");else{const d=await he(r.companyId,n,l,parseInt(g),a,parseInt(b),r.agencyId);await be(n,l),m("‚úÖ Trajet ajout√© avec succ√®s !")}O(),F()}catch(d){console.error("Erreur Firebase:",d),d.code==="permission-denied"?m("‚ùå Permission refus√©e. V√©rifiez que votre r√¥le (chefAgence) est correctement configur√©."):m("‚ùå Erreur lors de l'enregistrement. V√©rifiez la console.")}finally{I(!1)}};return z?t("div",{className:"min-h-screen bg-gray-50 p-6 text-gray-800 flex items-center justify-center",children:s("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-8 max-w-md text-center",children:[t("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Acc√®s Refus√©"}),t("p",{className:"text-gray-600 mb-4",children:"Vous n'avez pas les permissions n√©cessaires pour acc√©der √† cette page."}),t("p",{className:"text-sm text-gray-500",children:"Seuls les administrateurs et chefs d'agence peuvent g√©rer les trajets."})]})}):s("div",{className:"min-h-screen bg-gray-50 p-6 text-gray-800",children:[s("div",{className:"mb-8 p-6 rounded-xl bg-white shadow-md border border-gray-200 flex justify-between items-center",children:[s("div",{children:[t("h1",{className:"text-3xl font-bold",style:{color:q.primary},children:"Gestion des Trajets"}),s("p",{className:"text-gray-600 mt-1",children:["Connect√© en tant que ",t("span",{className:"font-semibold",children:r==null?void 0:r.role})]})]}),t("button",{onClick:le,disabled:v.length===0,className:`px-6 py-2 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition-all ${v.length===0?"opacity-50 cursor-not-allowed":""}`,style:{background:`linear-gradient(to right, ${q.primary}, ${q.secondary})`},children:"üìÑ Exporter la liste"})]}),s("div",{className:"grid md:grid-cols-2 gap-6",children:[s("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-6",children:[t("h2",{className:"text-xl font-bold mb-4",children:N?"Modifier le trajet":"Ajouter un trajet"}),t(Q,{label:"Ville de d√©part",value:y,onChange:f}),t(Q,{label:"Ville d'arriv√©e",value:p,onChange:o}),t("input",{type:"number",placeholder:"Prix (FCFA)",value:g,onChange:e=>h(e.target.value),className:"border p-2 w-full rounded mb-3",min:"0"}),t("input",{type:"number",placeholder:"Nombre de places",value:b,onChange:e=>C(e.target.value),className:"border p-2 w-full rounded mb-4",min:"1"}),H.map(e=>s("div",{className:"mb-2",children:[s("p",{className:"font-semibold",children:[A(e)," :"]}),(M[e]||[]).map((a,n)=>s("div",{className:"flex gap-2 my-1",children:[t("input",{type:"time",value:a,onChange:l=>se(e,n,l.target.value),className:"border p-1 rounded flex-grow"}),t("button",{type:"button",onClick:()=>ie(e,n),className:"text-red-600 hover:bg-red-50 px-2 rounded",children:"√ó"})]},n)),t("button",{type:"button",onClick:()=>ne(e),className:"bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded mt-1 text-sm",children:"+ Ajouter un horaire"})]},e)),t("button",{onClick:oe,disabled:w,className:`mt-4 px-4 py-2 rounded text-white w-full font-semibold transition-colors ${N?"bg-yellow-600 hover:bg-yellow-700 disabled:bg-yellow-400":"bg-green-600 hover:bg-green-700 disabled:bg-green-400"}`,children:w?"‚è≥ En cours...":N?"Mettre √† jour":"Enregistrer le trajet"}),R&&t("p",{className:`mt-2 p-3 rounded ${R.includes("‚ùå")?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:R}),N&&t("button",{onClick:O,className:"mt-2 px-4 py-2 bg-gray-500 hover:bg-gray-700 text-white rounded w-full",children:"Annuler la modification"})]}),s("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-6",children:[t("h2",{className:"text-xl font-bold mb-4",children:"Liste des trajets"}),s("div",{className:"flex gap-2 mb-4",children:[t("input",{type:"text",placeholder:"Rechercher par ville...",value:P,onChange:e=>{re(e.target.value),V(1)},className:"border p-2 w-full rounded"}),s("select",{value:E,onChange:e=>{te(e.target.value),V(1)},className:"border p-2 rounded",children:[t("option",{value:"",children:"Tous les jours"}),H.map(e=>t("option",{value:e,children:A(e)},e))]})]}),v.length>D&&s("div",{className:"flex justify-between items-center mb-4",children:[t("button",{onClick:()=>V(e=>Math.max(1,e-1)),disabled:T===1,className:"px-3 py-1 bg-gray-200 rounded disabled:opacity-50",children:"Pr√©c√©dent"}),s("span",{children:["Page ",T]}),t("button",{onClick:()=>V(e=>e+1),disabled:v.length<D,className:"px-3 py-1 bg-gray-200 rounded disabled:opacity-50",children:"Suivant"})]}),v.length>0?v.map(e=>s("div",{className:"border rounded p-3 mb-2 shadow hover:shadow-md transition-shadow",children:[s("div",{className:`cursor-pointer font-semibold flex justify-between items-center ${e.active?"text-green-700":"text-red-500"}`,onClick:()=>ee(G===e.id?null:e.id),children:[s("span",{children:[e.departure," ‚Üí ",e.arrival," ‚Ä¢ ",e.price," FCFA"]}),t("span",{className:"text-xs bg-gray-100 px-2 py-1 rounded",children:e.active?"üü¢ Actif":"üî¥ Inactif"})]}),G===e.id&&s("div",{className:"mt-2 text-sm space-y-2",children:[s("p",{children:[t("strong",{children:"Places :"})," ",e.places||"Non sp√©cifi√©"]}),s("div",{children:[t("strong",{children:"Horaires :"}),H.map(a=>{var l;const n=(l=e.horaires)==null?void 0:l[a];return n!=null&&n.length?s("p",{className:"ml-2",children:[A(a)," : ",n.sort().join(", ")]},a):null})]}),s("div",{className:"mt-3 flex gap-2 flex-wrap",children:[t("button",{onClick:()=>ae(e.id),disabled:w,className:"bg-red-600 hover:bg-red-800 text-white px-3 py-1 rounded text-sm",children:"Supprimer"}),t("button",{onClick:()=>{J(e.id),f(e.departure),o(e.arrival),h(e.price.toString()),C((e.places||"").toString()),j(e.horaires)},disabled:w,className:"bg-yellow-500 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm",children:"Modifier"}),t("button",{onClick:async()=>{if(!(r!=null&&r.companyId)||!(r!=null&&r.agencyId)){alert("Votre session a expir√©. Merci de vous reconnecter.");return}try{await K(k(x,"companies",r.companyId,"agences",r.agencyId,"weeklyTrips",e.id),{active:!e.active}),F()}catch(a){console.error("Erreur lors du changement d'√©tat:",a)}},disabled:w,className:`px-3 py-1 rounded text-white text-sm ${e.active?"bg-gray-600 hover:bg-gray-800":"bg-green-600 hover:bg-green-800"}`,children:e.active?"D√©sactiver":"Activer"})]})]})]},e.id)):t("div",{className:"text-gray-500 italic p-4 border rounded text-center",children:w?"Chargement...":"Aucun trajet disponible"})]})]})]})};export{Ce as default};
