import{r as u}from"./react-DB_4kGOy.js";import{x as A,w as S,J as T,B as R,y as f,A as J,z as k,F as P,q as Y,C as g,o as p,H as _,T as x,D as n}from"./firebase-lLzYRzUk.js";import{u as Q,d as r}from"../index-Bkmir__O.js";function m(t){const a={};return Object.keys(t||{}).forEach(o=>{const d=t[o];d!==void 0&&(d&&typeof d=="object"&&!Array.isArray(d)&&!(d instanceof x)?a[o]=m(d):a[o]=d)}),a}function W(t=new Date){const a=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),d=String(t.getDate()).padStart(2,"0");return`${a}${o}${d}`}function N(t,a){const o=a.startAt??a.startTime??null,d=a.endAt??a.endTime??null;return{id:t,companyId:a.companyId,agencyId:a.agencyId,userId:a.userId,userName:a.userName??null,userCode:a.userCode??null,status:a.status,startAt:o,endAt:d,startTime:a.startTime??null,endTime:a.endTime??null,dayKey:a.dayKey??null,tickets:a.tickets??0,amount:a.amount??0,accountantValidated:!!a.accountantValidated,managerValidated:!!a.managerValidated,accountantValidatedAt:a.accountantValidatedAt??null,managerValidatedAt:a.managerValidatedAt??null,createdAt:a.createdAt,updatedAt:a.updatedAt}}function at(){const{user:t}=Q(),[a,o]=u.useState(null),[d,h]=u.useState(!0),D=(a==null?void 0:a.status)??"none";u.useEffect(()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!(t!=null&&t.uid)){o(null),h(!1);return}h(!0);const s=A(r,`companies/${t.companyId}/agences/${t.agencyId}/shifts`),e=S(s,f("userId","==",t.uid),f("status","in",["pending","active","paused"]),R("createdAt","desc"),T(1)),c=J(e,i=>{i.empty?o(null):o(N(i.docs[0].id,i.docs[0].data())),h(!1)},i=>{console.error("[useActiveShift] onSnapshot error:",i),o(null),h(!1)});return()=>c()},[t==null?void 0:t.uid,t==null?void 0:t.companyId,t==null?void 0:t.agencyId]);const C=u.useCallback(async()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!(t!=null&&t.uid))return null;const s=A(r,`companies/${t.companyId}/agences/${t.agencyId}/shifts`),e=S(s,f("userId","==",t.uid),f("status","in",["pending","active","paused"]),R("createdAt","desc"),T(1)),c=await k(e);return c.empty?null:c.docs[0].id},[t==null?void 0:t.uid,t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),q=u.useCallback(async()=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId)||!(t!=null&&t.uid))throw new Error("Utilisateur invalide.");if(await C())return;const e=m({companyId:t.companyId,agencyId:t.agencyId,userId:t.uid,userName:t.displayName||t.email||null,userCode:t.staffCode||t.codeCourt||t.code||"GUEST",status:"pending",startAt:null,endAt:null,startTime:null,endTime:null,dayKey:W(),tickets:0,amount:0,accountantValidated:!1,managerValidated:!1,accountantValidatedAt:null,managerValidatedAt:null,createdAt:n(),updatedAt:n()}),c=await P(A(r,`companies/${t.companyId}/agences/${t.agencyId}/shifts`),e),i=await Y(c);i.exists()&&o(N(c.id,i.data()))},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId,t==null?void 0:t.uid,C]),B=u.useCallback(async()=>{if(!a)throw new Error("Aucun poste en cours.");if(a.status!=="active")throw new Error("Le poste doit être en service.");await g(p(r,`companies/${a.companyId}/agences/${a.agencyId}/shifts/${a.id}`),m({status:"paused",updatedAt:n()}))},[a]),K=u.useCallback(async()=>{if(!a)throw new Error("Aucun poste en cours.");if(a.status!=="paused")throw new Error("Le poste doit être en pause.");await g(p(r,`companies/${a.companyId}/agences/${a.agencyId}/shifts/${a.id}`),m({status:"active",updatedAt:n()}))},[a]),L=u.useCallback(async()=>{if(!a)throw new Error("Aucun poste en cours.");if(!["active","paused","pending"].includes(a.status))throw new Error("État non clôturable.");const s=`companies/${a.companyId}/agences/${a.agencyId}`;await _(r,async e=>{const c=p(r,`${s}/shifts/${a.id}`);if(!(await e.get(c)).exists())throw new Error("Poste introuvable.");const z=A(r,`${s}/reservations`),F=S(z,f("shiftId","==",a.id),f("canal","==","guichet")),G=await k(F);let w=0,$=0;const y={};G.forEach(V=>{const l=V.data(),v=Number(l.seatsGo||0)+Number(l.seatsReturn||0),E=Number(l.montant||0);w+=v,$+=E;const I=`${l.depart||""}→${l.arrivee||""}`;y[I]||(y[I]={billets:0,montant:0,heures:new Set}),y[I].billets+=v,y[I].montant+=E,l.heure&&y[I].heures.add(String(l.heure))});const M=Object.entries(y).map(([V,l])=>({trajet:V,billets:l.billets,montant:l.montant,heures:Array.from(l.heures).sort()})),b=x.now(),H=p(r,`${s}/shiftReports/${a.id}`);e.set(H,m({shiftId:a.id,companyId:a.companyId,agencyId:a.agencyId,userId:a.userId,userName:a.userName||null,userCode:a.userCode||null,startAt:a.startAt??a.startTime??null,endAt:b,billets:w||0,montant:$||0,details:M||[],accountantValidated:!1,managerValidated:!1,accountantValidatedAt:null,managerValidatedAt:null,status:"pending_validation",createdAt:n(),updatedAt:n()}),{merge:!0}),e.update(c,m({status:"closed",endAt:b,endTime:b,tickets:w||0,amount:$||0,updatedAt:n()}))})},[a]),O=u.useCallback(async s=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))throw new Error("Contexte invalide.");const e=`companies/${t.companyId}/agences/${t.agencyId}`,c=p(r,`${e}/shiftReports/${s}`);await g(c,m({accountantValidated:!0,accountantValidatedAt:n(),updatedAt:n()}));const i=p(r,`${e}/shifts/${s}`);await g(i,m({accountantValidated:!0,accountantValidatedAt:n(),updatedAt:n()}))},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),U=u.useCallback(async s=>{if(!(t!=null&&t.companyId)||!(t!=null&&t.agencyId))throw new Error("Contexte invalide.");const e=`companies/${t.companyId}/agences/${t.agencyId}`,c=p(r,`${e}/shiftReports/${s}`);await g(c,m({managerValidated:!0,managerValidatedAt:n(),updatedAt:n()}));const i=p(r,`${e}/shifts/${s}`);await g(i,m({managerValidated:!0,managerValidatedAt:n(),updatedAt:n()}))},[t==null?void 0:t.companyId,t==null?void 0:t.agencyId]),j=u.useCallback(async()=>{},[]);return{activeShift:a,status:D,loading:d,startShift:q,pauseShift:B,continueShift:K,closeShift:L,validateByAccountant:O,validateByManager:U,refresh:j}}export{at as u};
