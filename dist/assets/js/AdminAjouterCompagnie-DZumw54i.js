import{b as Ze,r as n,a as t,j as a}from"./react-DB_4kGOy.js";import{a as ce,d as C}from"../index-Bkmir__O.js";import{e as Qe,w as j,x as f,y as L,J as U,z as R,D as x,F as de,E as q,o as We,V as me}from"./firebase-lLzYRzUk.js";import"./vendor-C-DAJou6.js";const w=[{name:"Mali",code:"+223"},{name:"Sénégal",code:"+221"},{name:"Côte d'Ivoire",code:"+225"},{name:"Burkina Faso",code:"+226"},{name:"Togo",code:"+228"}],Ye=u=>(u||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"").trim(),_=u=>/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test((u||"").trim()),ea=(u,p)=>`${u}${(p||"").replace(/\D/g,"")}`,ue=u=>{const p=String(u||"").trim().toLowerCase();return p==="admin plateforme"||p==="admin_platforme"?"admin_platforme":p},ra=({onSuccess:u})=>{const p=Ze(),O=Qe(void 0,"europe-west1"),[b,pe]=n.useState(""),[k,ge]=n.useState(w[0].name),[V,he]=n.useState(w[0].code),[M,fe]=n.useState(""),[E,be]=n.useState(""),[A,ve]=n.useState(null),[$,Ne]=n.useState(null),[B,xe]=n.useState("#f59e0b"),[z,ye]=n.useState("#ef4444"),[v,Se]=n.useState(""),[g,Ce]=n.useState(""),[s,we]=n.useState(null),[ke,Me]=n.useState(!1),[h,Ee]=n.useState(!0),[G,Ae]=n.useState(""),[m,$e]=n.useState(""),[c,De]=n.useState(null),[Ie,Fe]=n.useState(!1),[X,Pe]=n.useState("free"),[K,Te]=n.useState(1),[H,je]=n.useState(3),[J,Le]=n.useState(!0),[Z,Ue]=n.useState(!1),[Q,Re]=n.useState(!0),[W,qe]=n.useState(2),[Y,_e]=n.useState(100),[ee,Oe]=n.useState(25e3),[D,I]=n.useState(!1),[ae,te]=n.useState(""),[ne,le]=n.useState(""),[d,y]=n.useState(null),[F,re]=n.useState(!1),S=n.useMemo(()=>Ye(b),[b]),se=async(e,o="admin")=>{const i=o==="admin"?we:De,r=o==="admin"?Me:Fe;r(!0),i(null);try{if(!_(e)){i({ok:!1,reason:"format_invalide"});return}const oe=await me(O,"checkEmailDomain")({email:e});i(oe.data)}catch{i({ok:!1,reason:"erreur_interne"})}finally{r(!1)}},Ve=async e=>{var r;if(e.preventDefault(),!b.trim())return alert("Le nom de la compagnie est requis.");if(!v.trim())return alert("Le nom de l’admin de la compagnie est requis.");if(!_(g))return alert("Email admin compagnie invalide.");if(!E.trim())return alert("Téléphone requis.");if(!h&&m&&!_(m))return alert("Email chef d’agence invalide.");if(!S)return alert("Le nom de la compagnie doit produire un slug valide.");const o=ce.currentUser;if(!o)return alert("Tu dois être connecté.");const i=await o.getIdTokenResult(!0);if(ue((r=i.claims)==null?void 0:r.role)!=="admin_platforme")return alert("Accès refusé : nécessite le rôle admin_platforme.");if(!(s!=null&&s.ok))return alert("Email admin non valide (domaine jetable ou MX absent).");if(!h&&m&&!(c!=null&&c.ok))return alert("Email chef d’agence non valide (domaine jetable ou MX absent).");I(!0);try{const l=j(f(C,"companies"),L("slug","==",S),U(1));if(!(await R(l)).empty){alert("Une compagnie avec ce nom/slug existe déjà."),I(!1);return}const Ge=ea(V,E),Xe=Math.max(0,Number((W/100).toFixed(4))),Ke={nom:b,slug:S,pays:k,ville:M||null,telephone:Ge,latitude:A??null,longitude:$??null,publicVisible:!0,couleurPrimaire:B,couleurSecondaire:z,couleurAccent:"#f6f3f0",couleurTertiaire:"#000000",police:"sans-serif",themeStyle:"moderne",plan:X,maxAgences:K,maxUsers:H,guichetEnabled:J,onlineBookingEnabled:Z,publicPageEnabled:Q,commissionOnline:Xe,feeGuichet:Y,minimumMonthly:ee,description:"",instructionRecherche:"Trouver votre prochain trajet",accroche:"Réservez votre trajet en un clic",logoUrl:"",banniereUrl:"",faviconUrl:"",imagesSlider:[],showContactForm:!0,showLegalLinks:!0,showSocialMedia:!0,showTestimonials:!0,responsable:v,email:g,politiqueConfidentialite:"",conditionsUtilisation:"",status:"actif",createdAt:x(),updatedAt:x()},N=await de(f(C,"companies"),Ke);await q(N,{id:N.id},{merge:!0});const P=N.id,He={id:"",nomAgence:"Agence principale",ville:M||null,pays:k,statut:"active",latitude:A??null,longitude:$??null,createdAt:x(),updatedAt:x(),isHeadOffice:!0},T=await de(f(N,"agences"),He);await q(T,{id:T.id},{merge:!0});const ie=T.id,Je=We(f(N,"contacts"),"main");await q(Je,{admin:{name:v,email:g},agencyManager:h?{name:v,email:g}:m?{name:G,email:m}:null,updatedAt:x()},{merge:!0}),alert(["✅ Compagnie créée.",`- companyId: ${P}`,`- agencyId: ${ie}`,"","ℹ️ Étape suivante (Spark) : crée/repère le compte de l’admin compagnie, puis lance :",`node setUserClaims.cjs ${g} admin_compagnie ${P}`,h?"(le même compte aura les bons contacts)":m?`et pour le chef d’agence : node setUserClaims.cjs ${m} chefAgence ${P} ${ie}`:""].filter(Boolean).join(`
`)),u==null||u(),p("/admin/compagnies")}catch(l){console.error(l),alert("❌ Erreur: "+((l==null?void 0:l.message)||"création impossible"))}finally{I(!1)}},Be=async()=>{y(null);const e=ae.trim(),o=ne.trim().toLowerCase();if(!e&&!o){alert("Renseigne l’ID ou le slug de la compagnie.");return}try{if(e){const i=j(f(C,"companies"),L("id","==",e),U(1)),r=await R(i);if(!r.empty){const l=r.docs[0].data();y({id:r.docs[0].id,nom:l==null?void 0:l.nom,slug:l==null?void 0:l.slug});return}}if(o){const i=j(f(C,"companies"),L("slug","==",o),U(1)),r=await R(i);if(!r.empty){const l=r.docs[0].data();y({id:r.docs[0].id,nom:l==null?void 0:l.nom,slug:l==null?void 0:l.slug});return}}alert("Compagnie introuvable.")}catch(i){console.error(i),alert("Erreur pendant la recherche.")}},ze=async()=>{var r;const e=ce.currentUser;if(!e)return alert("Tu dois être connecté.");const o=await e.getIdTokenResult(!0);if(ue((r=o.claims)==null?void 0:r.role)!=="admin_platforme")return alert("Accès refusé : nécessite le rôle admin_platforme.");if(!(d!=null&&d.id))return alert("Aucune compagnie sélectionnée.");if(prompt(`⚠️ Suppression DÉFINITIVE de la compagnie:
- Nom: ${d.nom||"(inconnu)"}
- Slug: ${d.slug||"(inconnu)"}
- ID: ${d.id}

Tape "SUPPRIMER" pour confirmer.`)!=="SUPPRIMER"){alert("Annulé.");return}re(!0);try{await me(O,"deleteCompany")({companyId:d.id,hard:!0}),alert("✅ Compagnie supprimée (Firestore + Storage + Auth)."),te(""),le(""),y(null)}catch(l){console.error(l),alert("❌ Échec suppression : "+((l==null?void 0:l.message)||"erreur inconnue"))}finally{re(!1)}};return t("div",{className:"p-6 max-w-3xl mx-auto",children:[a("h2",{className:"text-xl font-bold mb-4",children:"Ajouter une compagnie"}),t("form",{onSubmit:Ve,className:"grid grid-cols-1 gap-4",children:[a("input",{required:!0,value:b,onChange:e=>pe(e.target.value),placeholder:"Nom de la compagnie",className:"border p-2 rounded"}),t("div",{className:"flex gap-2",children:[a("select",{value:k,onChange:e=>{const o=w.find(i=>i.name===e.target.value);o&&(ge(o.name),he(o.code))},className:"border p-2 rounded w-1/2",children:w.map(e=>a("option",{value:e.name,children:e.name},e.code))}),a("input",{value:M,onChange:e=>fe(e.target.value),placeholder:"Ville (optionnel)",className:"border p-2 rounded w-1/2"})]}),t("div",{className:"flex gap-2",children:[a("input",{required:!0,value:E,onChange:e=>be(e.target.value),placeholder:"Téléphone",className:"border p-2 rounded w-1/2"}),a("input",{readOnly:!0,value:V,className:"border p-2 rounded w-1/2 bg-gray-50"})]}),t("div",{className:"flex gap-2",children:[a("input",{type:"number",step:"any",value:A??"",onChange:e=>ve(e.target.value?parseFloat(e.target.value):null),placeholder:"Latitude (optionnel)",className:"border p-2 rounded w-1/2"}),a("input",{type:"number",step:"any",value:$??"",onChange:e=>Ne(e.target.value?parseFloat(e.target.value):null),placeholder:"Longitude (optionnel)",className:"border p-2 rounded w-1/2"})]}),t("div",{className:"flex gap-2",children:[a("input",{type:"color",value:B,onChange:e=>xe(e.target.value),className:"border p-1 rounded w-1/2",title:"Couleur primaire"}),a("input",{type:"color",value:z,onChange:e=>ye(e.target.value),className:"border p-1 rounded w-1/2",title:"Couleur secondaire"})]}),t("div",{className:"mt-2 border-t pt-4",children:[a("h3",{className:"font-semibold mb-2",children:"Administrateur de la compagnie (contact)"}),a("input",{required:!0,value:v,onChange:e=>Se(e.target.value),placeholder:"Nom complet (admin compagnie)",className:"border p-2 rounded mb-2 w-full"}),a("input",{required:!0,type:"email",value:g,onChange:e=>Ce(e.target.value),onBlur:()=>se(g,"admin"),placeholder:"Email (admin compagnie)",className:"border p-2 rounded w-full"}),ke&&a("p",{className:"text-sm text-gray-500",children:"Vérification de l’e-mail…"}),s&&a("p",{className:`text-sm ${s.ok?"text-green-600":"text-red-600"}`,children:s.ok?`✓ Domaine valide (${s.domain}), MX: ${s.hasMx?"OK":"absent"}`:`✗ Email non valide (${s.reason||"inconnu"})${s.disposable?" — domaine jetable":""}`})]}),t("div",{className:"mt-2 border-t pt-4",children:[t("div",{className:"flex items-center gap-2",children:[a("input",{id:"sameManager",type:"checkbox",checked:h,onChange:e=>Ee(e.target.checked)}),a("label",{htmlFor:"sameManager",children:"Utiliser le même compte comme Chef d’agence principale"})]}),!h&&t("div",{className:"mt-3 grid grid-cols-1 gap-2",children:[a("input",{value:G,onChange:e=>Ae(e.target.value),placeholder:"Nom complet (chef d’agence)",className:"border p-2 rounded"}),a("input",{type:"email",value:m,onChange:e=>$e(e.target.value),onBlur:()=>m&&se(m,"manager"),placeholder:"Email (chef d’agence)",className:"border p-2 rounded"}),Ie&&a("p",{className:"text-sm text-gray-500",children:"Vérification de l’e-mail…"}),m&&c&&a("p",{className:`text-sm ${c.ok?"text-green-600":"text-red-600"}`,children:c.ok?`✓ Domaine valide (${c.domain}), MX: ${c.hasMx?"OK":"absent"}`:`✗ Email non valide (${c.reason||"inconnu"})${c.disposable?" — domaine jetable":""}`})]})]}),t("div",{className:"mt-2 border-t pt-4",children:[a("h3",{className:"font-semibold mb-3",children:"Plan & options"}),t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[t("label",{className:"text-sm",children:["Plan",t("select",{value:X,onChange:e=>Pe(e.target.value),className:"mt-1 w-full border p-2 rounded",children:[a("option",{value:"free",children:"Free"}),a("option",{value:"standard",children:"Standard"}),a("option",{value:"premium",children:"Premium"})]})]}),t("label",{className:"text-sm",children:["Max agences",a("input",{type:"number",min:0,value:K,onChange:e=>Te(Math.max(0,Number(e.target.value||0))),className:"mt-1 w-full border p-2 rounded"})]}),t("label",{className:"text-sm",children:["Max utilisateurs",a("input",{type:"number",min:0,value:H,onChange:e=>je(Math.max(0,Number(e.target.value||0))),className:"mt-1 w-full border p-2 rounded"})]})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mt-3",children:[t("label",{className:"inline-flex items-center gap-2 text-sm",children:[a("input",{type:"checkbox",checked:J,onChange:e=>Le(e.target.checked)}),"Guichet activé"]}),t("label",{className:"inline-flex items-center gap-2 text-sm",children:[a("input",{type:"checkbox",checked:Z,onChange:e=>Ue(e.target.checked)}),"Réservation en ligne"]}),t("label",{className:"inline-flex items-center gap-2 text-sm",children:[a("input",{type:"checkbox",checked:Q,onChange:e=>Re(e.target.checked)}),"Page publique"]})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mt-3",children:[t("label",{className:"text-sm",children:["Commission en ligne (%)",a("input",{type:"number",step:"0.1",min:0,value:W,onChange:e=>qe(Math.max(0,Number(e.target.value||0))),className:"mt-1 w-full border p-2 rounded",placeholder:"ex: 2 pour 2%"})]}),t("label",{className:"text-sm",children:["Frais guichet (FCFA)",a("input",{type:"number",min:0,value:Y,onChange:e=>_e(Math.max(0,Number(e.target.value||0))),className:"mt-1 w-full border p-2 rounded"})]}),t("label",{className:"text-sm",children:["Minimum mensuel (FCFA)",a("input",{type:"number",min:0,value:ee,onChange:e=>Oe(Math.max(0,Number(e.target.value||0))),className:"mt-1 w-full border p-2 rounded"})]})]})]}),t("div",{className:"text-sm text-gray-500",children:["Slug généré : ",a("span",{className:"font-mono",children:S||"(vide)"})]}),a("button",{type:"submit",disabled:D||!(s!=null&&s.ok)||(!h&&m?!(c!=null&&c.ok):!1),className:`p-2 rounded text-white transition ${D?"bg-orange-300 cursor-not-allowed":"bg-orange-600 hover:bg-orange-700"}`,title:!s||!s.ok?"Email admin non validé":void 0,children:D?"Création en cours...":"Créer la compagnie"})]}),t("div",{className:"mt-10 border-t pt-6",children:[a("h3",{className:"text-lg font-semibold text-red-600 mb-3",children:"Zone de danger"}),t("p",{className:"text-sm text-gray-600 mb-4",children:["Supprimer une compagnie efface ",a("strong",{children:"définitivement"})," toutes ses données Firestore (sous-collections), ses fichiers Storage, et les utilisateurs Auth rattachés."]}),t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 items-end",children:[t("label",{className:"text-sm",children:["ID compagnie (option 1)",a("input",{value:ae,onChange:e=>te(e.target.value),placeholder:"companies/{companyId}",className:"mt-1 w-full border p-2 rounded"})]}),a("div",{className:"text-center text-sm text-gray-500",children:"ou"}),t("label",{className:"text-sm",children:["Slug compagnie (option 2)",a("input",{value:ne,onChange:e=>le(e.target.value),placeholder:"ex: diallo-trans",className:"mt-1 w-full border p-2 rounded"})]})]}),t("div",{className:"flex gap-2 mt-3",children:[a("button",{onClick:Be,className:"px-3 py-2 rounded bg-gray-100 hover:bg-gray-200",children:"Vérifier la compagnie"}),a("button",{onClick:ze,disabled:!d||F,className:`px-3 py-2 rounded text-white ${d&&!F?"bg-red-600 hover:bg-red-700":"bg-red-300 cursor-not-allowed"}`,children:F?"Suppression…":"Supprimer définitivement"})]}),d&&a("div",{className:"mt-3 text-sm",children:t("div",{className:"p-3 bg-red-50 rounded border border-red-200",children:[t("div",{children:["• ",a("strong",{children:"ID:"})," ",d.id]}),t("div",{children:["• ",a("strong",{children:"Nom:"})," ",d.nom||"—"]}),t("div",{children:["• ",a("strong",{children:"Slug:"})," ",d.slug||"—"]})]})})]})]})};export{ra as default};
