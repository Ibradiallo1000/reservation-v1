import{u as T,r as l,j as e,ad as $,ae as O,af as Q,ag as Z,ah as P}from"./react-PtMwKKf1.js";import{k,l as E,d as v,u as M,y as _,A as J,t as K,B as X,q as Y,w as ee}from"./firebase-eGIzIftJ.js";import{u as te,d as m,a as se}from"../index-C4y8wfzK.js";import"./vendor-B5FTF_2c.js";delete P.Icon.Default.prototype._getIconUrl;P.Icon.Default.mergeOptions({iconRetinaUrl:"/leaflet/marker-icon-2x.png",iconUrl:"/leaflet/marker-icon.png",shadowUrl:"/leaflet/marker-shadow.png"});const de=()=>{const{user:a}=te(),I=T(),[d,S]=l.useState([]),[j,x]=l.useState(!1),[t,p]=l.useState({nomAgence:"",ville:"",pays:"",quartier:"",type:"",emailGerant:"",nomGerant:"",telephone:"",motDePasse:"",latitude:"",longitude:""}),[i,C]=l.useState(null),[u,f]=l.useState(1),[g,D]=l.useState(6),[re,A]=l.useState(!1),[ae,w]=l.useState(""),h=(a==null?void 0:a.companyColor)||"#2563eb",L=({onPositionChange:s})=>(Z({click(r){s(r.latlng.lat,r.latlng.lng)}}),null),b=async()=>{if(a!=null&&a.companyId)try{const s=k(m,"companies",a.companyId,"agences"),n=(await E(s)).docs.map(c=>({id:c.id,...c.data()}));S(n),f(1)}catch(s){console.error("Erreur lors du chargement des agences:",s),alert("Une erreur est survenue lors du chargement des agences")}},F=async s=>{try{const r=k(m,"users"),n=Y(r,ee("email","==",s));return!(await E(n)).empty}catch(r){return console.error("Erreur lors de la v√©rification de l'email:",r),!1}};l.useEffect(()=>{b()},[a]);const N=u*g,q=N-g,z=d.slice(q,N),y=Math.ceil(d.length/g),o=s=>{const{name:r,value:n}=s.target;p(c=>({...c,[r]:n})),r==="emailGerant"&&w("")},H=(s,r)=>{p(n=>({...n,latitude:s.toString(),longitude:r.toString()}))},G=()=>{p({nomAgence:"",ville:"",pays:"",quartier:"",type:"",emailGerant:"",nomGerant:"",telephone:"",motDePasse:"",latitude:"",longitude:""}),C(null),x(!1),w("")},U=async s=>{s.preventDefault(),console.log("üì§ Soumission du formulaire",t);try{if(!(a!=null&&a.companyId))throw new Error("Aucune compagnie associ√©e √† cet utilisateur");if(!i){console.log("üîç V√©rification email d√©j√† utilis√©..."),A(!0);const r=await F(t.emailGerant);if(A(!1),r){console.warn("‚ùå Email d√©j√† utilis√© :",t.emailGerant),w("Cet email est d√©j√† utilis√© par un autre utilisateur");return}if(!t.motDePasse||t.motDePasse.length<6){console.warn("‚ùå Mot de passe trop court ou manquant"),alert("Le mot de passe doit contenir au moins 6 caract√®res.");return}}if(i){console.log("‚úèÔ∏è Mise √† jour agence...");const r=v(m,"companies",a.companyId,"agences",i);await M(r,{nomAgence:t.nomAgence,ville:t.ville,pays:t.pays,quartier:t.quartier,type:t.type,nomGerant:t.nomGerant,telephone:t.telephone,latitude:t.latitude?parseFloat(t.latitude):null,longitude:t.longitude?parseFloat(t.longitude):null}),alert("‚úÖ Agence mise √† jour avec succ√®s")}else{console.log("üë§ Cr√©ation utilisateur Firebase Auth...");const r=await _(se,t.emailGerant,t.motDePasse);console.log("‚úÖ Utilisateur cr√©√© :",r.user.uid),console.log("üè¢ Ajout de l‚Äôagence Firestore...");const n=k(m,"companies",a.companyId,"agences"),c=await J(n,{nomAgence:t.nomAgence,ville:t.ville,pays:t.pays,quartier:t.quartier,type:t.type,statut:"active",emailGerant:t.emailGerant,nomGerant:t.nomGerant,telephone:t.telephone,latitude:t.latitude?parseFloat(t.latitude):null,longitude:t.longitude?parseFloat(t.longitude):null});console.log("üì¶ Mise √† jour collection users..."),await K(v(m,"users",r.user.uid),{uid:r.user.uid,email:t.emailGerant,nom:t.nomGerant,telephone:t.telephone,role:"chefAgence",companyId:a.companyId,agencyId:c.id}),alert("‚úÖ Agence et g√©rant cr√©√©s avec succ√®s")}G(),b()}catch(r){console.error("üî• Erreur pendant handleSubmit:",r),alert(`Erreur: ${(r==null?void 0:r.message)??(r==null?void 0:r.code)??"Erreur inconnue"}`)}},W=s=>{var r,n;p({nomAgence:s.nomAgence,ville:s.ville,pays:s.pays,quartier:s.quartier||"",type:s.type||"",emailGerant:s.emailGerant,nomGerant:s.nomGerant,telephone:s.telephone,motDePasse:"",latitude:((r=s.latitude)==null?void 0:r.toString())||"",longitude:((n=s.longitude)==null?void 0:n.toString())||""}),C(s.id),x(!0),window.scrollTo({top:0,behavior:"smooth"})},B=async s=>{if(a!=null&&a.companyId&&window.confirm("√ätes-vous s√ªr de vouloir supprimer cette agence ?"))try{await X(v(m,"companies",a.companyId,"agences",s)),b()}catch(r){console.error("Erreur lors de la suppression:",r),alert("Une erreur est survenue lors de la suppression")}},V=async s=>{if(!(a!=null&&a.companyId)||!s.id)return;const r=s.statut==="active"?"inactive":"active";try{await M(v(m,"companies",a.companyId,"agences",s.id),{statut:r}),b()}catch(n){console.error("Erreur lors du changement de statut:",n),alert("Une erreur est survenue lors du changement de statut")}},R=s=>{I(`/compagnie/agence/${s}/dashboard`)};return e.jsxs("div",{className:"p-6 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsx("h2",{className:"text-2xl font-bold",style:{color:h},children:"Gestion des agences"}),e.jsxs("button",{onClick:()=>x(!j),className:"flex items-center px-4 py-2 rounded-md shadow-sm text-white font-medium",style:{backgroundColor:h},children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),j?"Masquer le formulaire":"Ajouter une nouvelle agence"]})]}),j&&e.jsxs("form",{onSubmit:U,className:"bg-white p-6 rounded-lg shadow-md mb-8 border border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",style:{color:h},children:i?"Modifier une agence":"Ajouter une nouvelle agence"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Nom de l'agence *"}),e.jsx("input",{name:"nomAgence",value:t.nomAgence,onChange:o,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Ville *"}),e.jsx("input",{name:"ville",value:t.ville,onChange:o,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Pays *"}),e.jsx("input",{name:"pays",value:t.pays,onChange:o,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Quartier"}),e.jsx("input",{name:"quartier",value:t.quartier,onChange:o,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Type"}),e.jsx("input",{name:"type",value:t.type,onChange:o,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Nom du g√©rant *"}),e.jsx("input",{name:"nomGerant",value:t.nomGerant,onChange:o,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Email du g√©rant *"}),e.jsx("input",{name:"emailGerant",type:"email",value:t.emailGerant,onChange:o,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:i?"Nouveau mot de passe":"Mot de passe *"}),e.jsx("input",{name:"motDePasse",type:"password",value:t.motDePasse,onChange:o,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!i,placeholder:i?"Laisser vide pour ne pas changer":""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"T√©l√©phone *"}),e.jsx("input",{name:"telephone",value:t.telephone,onChange:o,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]})]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["üìç Position g√©ographique ",t.latitude&&t.longitude&&e.jsxs("span",{className:"text-gray-500 ml-2",children:["(",t.latitude,", ",t.longitude,")"]})]}),e.jsx("p",{className:"text-sm text-gray-500 mb-2",children:"Cliquez sur la carte pour positionner l'agence"}),e.jsx("div",{className:"h-64 rounded-lg border border-gray-300 overflow-hidden",children:e.jsxs($,{center:[t.latitude?parseFloat(t.latitude):12.6392,t.longitude?parseFloat(t.longitude):-8.0029],zoom:t.latitude?15:12,className:"h-full w-full",scrollWheelZoom:!0,children:[e.jsx(O,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e.jsx(L,{onPositionChange:H}),t.latitude&&t.longitude&&e.jsx(Q,{position:[parseFloat(t.latitude),parseFloat(t.longitude)]})]})})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:G,className:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Annuler"}),e.jsx("button",{type:"submit",className:"px-4 py-2 rounded-md shadow-sm text-sm font-medium text-white hover:bg-opacity-90",style:{backgroundColor:h},children:i?"Mettre √† jour l'agence":"Ajouter l'agence"})]})]}),e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-semibold",children:["Liste des agences (",d.length,")"]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("label",{className:"mr-2 text-sm",children:"Agences par page:"}),e.jsxs("select",{value:g,onChange:s=>{D(Number(s.target.value)),f(1)},className:"border rounded p-1 text-sm",children:[e.jsx("option",{value:6,children:"6"}),e.jsx("option",{value:12,children:"12"}),e.jsx("option",{value:24,children:"24"})]})]})]}),d.length===0?e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-sm border border-gray-200 text-center",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-gray-900",children:"Aucune agence enregistr√©e"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Commencez par ajouter votre premi√®re agence."}),e.jsx("div",{className:"mt-6",children:e.jsxs("button",{onClick:()=>x(!0),className:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white",style:{backgroundColor:h},children:[e.jsx("svg",{className:"-ml-1 mr-2 h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Ajouter une agence"]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:z.map(s=>e.jsx("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:s.nomAgence}),e.jsxs("p",{className:"text-sm text-gray-500",children:[s.ville,", ",s.pays]})]}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.statut==="active"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.statut==="active"?"Active":"Inactive"})]}),e.jsxs("div",{className:"mt-4 border-t border-gray-200 pt-4",children:[e.jsxs("div",{className:"flex items-center text-sm text-gray-500 mb-2",children:[e.jsx("svg",{className:"flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})}),s.emailGerant]}),e.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[e.jsx("svg",{className:"flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"})}),s.telephone]})]}),e.jsxs("div",{className:"mt-5 flex justify-between space-x-2",children:[e.jsxs("button",{onClick:()=>R(s.id),className:"flex-1 inline-flex justify-center items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:[e.jsx("svg",{className:"-ml-1 mr-2 h-5 w-5 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})}),"Dashboard"]}),e.jsxs("button",{onClick:()=>W(s),className:"inline-flex justify-center items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white",style:{backgroundColor:h},children:[e.jsx("svg",{className:"-ml-1 mr-2 h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Modifier"]})]}),e.jsxs("div",{className:"mt-3 flex space-x-2",children:[e.jsx("button",{onClick:()=>V(s),className:`flex-1 px-3 py-2 border rounded-md text-sm font-medium ${s.statut==="active"?"border-yellow-300 text-yellow-700 bg-yellow-100 hover:bg-yellow-200":"border-green-300 text-green-700 bg-green-100 hover:bg-green-200"}`,children:s.statut==="active"?"D√©sactiver":"Activer"}),e.jsx("button",{onClick:()=>B(s.id),className:"flex-1 px-3 py-2 border border-red-300 rounded-md text-sm font-medium text-red-700 bg-red-100 hover:bg-red-200",children:"Supprimer"})]})]})},s.id))}),d.length>g&&e.jsxs("div",{className:"flex justify-between items-center mt-6",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["Affichage ",q+1,"-",Math.min(N,d.length)," sur ",d.length," agences"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>f(s=>Math.max(s-1,1)),disabled:u===1,className:`px-4 py-2 rounded-md ${u===1?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:"Pr√©c√©dent"}),e.jsxs("span",{className:"px-4 py-2 text-gray-700",children:["Page ",u," sur ",y]}),e.jsx("button",{onClick:()=>f(s=>Math.min(s+1,y)),disabled:u===y,className:`px-4 py-2 rounded-md ${u===y?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:"Suivant"})]})]})]})]})};export{de as default};
