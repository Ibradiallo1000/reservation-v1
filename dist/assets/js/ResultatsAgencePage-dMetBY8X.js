import{u as Q,k as U,y as V,h as _,r as o,j as B}from"./react-Bg_vEni-.js";import{q as E,f as S,w as $,h as C}from"./firebase-C3aZpI0W.js";import{d as T}from"../index-Dgt8Lr4V.js";import{s as H}from"./color-DxN_zAQH.js";import"./vendor-D_4iK-Jm.js";const le=()=>{Q();const{slug:I}=U(),[P]=V(),t=_().state,k=(t==null?void 0:t.departure)||P.get("departure")||"",q=(t==null?void 0:t.arrival)||P.get("arrival")||"",j=i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase(),p=j(k),m=j(q),[s,b]=o.useState(null),[x,N]=o.useState(null),g=(x==null?void 0:x.id)||null,[K,z]=o.useState({}),[W,l]=o.useState(!0),[X,h]=o.useState(null),[Y,F]=o.useState([]),[Z,G]=o.useState(""),[ee,te]=o.useState(""),R=o.useMemo(()=>({colors:{primary:(s==null?void 0:s.couleurPrimaire)||"#3b82f6",secondary:(s==null?void 0:s.couleurSecondaire)||"#93c5fd",text:s!=null&&s.couleurPrimaire?H(s.couleurPrimaire):"#ffffff",background:"#ffffff"},classes:{card:"bg-white rounded-xl shadow-sm border border-gray-200",button:"transition-all hover:scale-105 active:scale-95",animations:"transition-all duration-300 ease-in-out",header:"sticky top-0 z-50 px-4 py-3"}}),[s]),{colors:ae,classes:se}=R,M=i=>{const a=new Date;return Array.from({length:i},(y,u)=>{const c=new Date(a);return c.setDate(a.getDate()+u),c.toISOString().split("T")[0]})};return o.useEffect(()=>{(async()=>{try{let a="";if(t!=null&&t.companyInfo)b(t.companyInfo),a=t.companyInfo.id;else{if(!I){h("Compagnie non trouvée"),l(!1);return}const c=E(S(T,"companies"),$("slug","==",I)),d=await C(c);if(d.empty){h("Compagnie non trouvée"),l(!1);return}const f=d.docs[0],w=f.data();b({id:f.id,...w}),a=f.id}const y=E(S(T,"agences"),$("companyId","==",a)),u=await C(y);if(u.empty)console.warn("Aucune agence trouvée pour la compagnie",a);else{const c=u.docs[0],d=c.data();N({id:c.id,...d})}}catch(a){console.error("Erreur Firestore:",a),h("Erreur lors du chargement")}finally{l(!1)}})()},[I,t==null?void 0:t.companyInfo]),o.useEffect(()=>{if(!p||!m||!g){console.warn("⏳ Attente des données pour charger les trajets",{departure:p,arrival:m,agenceId:g});return}(async()=>{l(!0);try{const a=M(8),y=E(S(T,"dailyTrips")),c=(await C(y)).docs.map(e=>({id:e.id,...e.data()})),f=(await C(S(T,"reservations"))).docs.map(e=>e.data()),w=c.filter(e=>{var r,n;return((r=e.departure)==null?void 0:r.trim().toLowerCase())===p.toLowerCase()&&((n=e.arrival)==null?void 0:n.trim().toLowerCase())===m.toLowerCase()&&e.agencyId===g&&a.includes(e.date)}).map(e=>{const r=f.filter(n=>n.trajetId===e.id&&n.statut==="payé").reduce((n,O)=>n+(O.seatsGo||1),0);return{...e,places:(e.places||30)-r}}),v={};w.forEach(e=>{v[e.date]||(v[e.date]=[]),v[e.date].push(e)});const L=new Date,A=a.filter(e=>{const r=v[e];return r?r.some(n=>new Date(`${n.date}T${n.time}`)>L):!1});F(A),G(e=>A.includes(e)?e:A[0]||"");const D={};for(const e of w)if(new Date(`${e.date}T${e.time}`)>L){const r=`${e.companyId}`;D[r]||(D[r]=[]),D[r].push(e)}z(D)}catch(a){console.error("Erreur Firestore:",a),h("Erreur lors du chargement des trajets")}finally{l(!1)}})()},[p,m,g]),B.jsx("div",{children:"..."})};export{le as default};
