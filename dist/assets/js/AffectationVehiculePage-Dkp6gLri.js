import{r as n,j as e,a as d}from"./react-DB_4kGOy.js";import{z as M,x as T,o as _,q as F,E as L}from"./firebase-lLzYRzUk.js";import{u as R,d as E}from"../index-Bkmir__O.js";import"./vendor-C-DAJou6.js";function I(r){const u=r.getFullYear(),s=String(r.getMonth()+1).padStart(2,"0"),o=String(r.getDate()).padStart(2,"0");return`${u}-${s}-${o}`}const j=r=>r.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase();function z(r,u,s,o){return`${r.trim()}_${u.trim()}_${s.trim()}_${o}`.replace(/\s+/g,"-")}const q=({companyId:r,agencyId:u,trip:s,date:o,heure:h,onSaved:v})=>{const[b,x]=n.useState(!0),[g,m]=n.useState(!1),[w,S]=n.useState(""),[D,c]=n.useState(""),[C,y]=n.useState(""),[N,A]=n.useState(""),[$,k]=n.useState(!1),t=n.useMemo(()=>z(s.departure,s.arrival,h,o),[s.departure,s.arrival,h,o]);n.useEffect(()=>{let a=!1;return(async()=>{x(!0);try{const p=_(E,`companies/${r}/agences/${u}/affectations/${t}`),i=await F(p);if(!a&&i.exists()){const f=i.data();S(f.busNumber||""),c(f.immatriculation||""),y(f.chauffeur||""),A(f.chefEmbarquement||""),k(!0)}else a||(S(""),c(""),y(""),A(""),k(!1))}finally{a||x(!1)}})(),()=>{a=!0}},[r,u,t]);const l=n.useCallback(async()=>{m(!0);try{const a=_(E,`companies/${r}/agences/${u}/affectations/${t}`),p={busNumber:w||"",immatriculation:D||"",chauffeur:C||"",chefEmbarquement:N||"",tripId:s.id||null,date:o,heure:h,updatedAt:new Date};await L(a,p,{merge:!0}),k(!0),v==null||v()}catch(a){console.error(a),alert("Échec de l’enregistrement de l’affectation.")}finally{m(!1)}},[r,u,t,w,D,C,N,s.id,o,h,v]);return d("tr",{className:"border-t",children:[d("td",{className:"px-3 py-2 whitespace-nowrap text-sm",children:[d("div",{className:"font-medium",children:[s.departure," → ",s.arrival]}),d("div",{className:"text-xs text-gray-500",children:[o," • ",h]})]}),e("td",{className:"px-2 py-2",children:e("input",{className:"w-40 px-2 py-1 border rounded text-sm",placeholder:"N° Bus",value:w,onChange:a=>S(a.target.value),disabled:b||g})}),e("td",{className:"px-2 py-2",children:e("input",{className:"w-40 px-2 py-1 border rounded text-sm",placeholder:"Immat.",value:D,onChange:a=>c(a.target.value),disabled:b||g})}),e("td",{className:"px-2 py-2",children:e("input",{className:"w-48 px-2 py-1 border rounded text-sm",placeholder:"Chauffeur",value:C,onChange:a=>y(a.target.value),disabled:b||g})}),e("td",{className:"px-2 py-2",children:e("input",{className:"w-48 px-2 py-1 border rounded text-sm",placeholder:"Convoyeur",value:N,onChange:a=>A(a.target.value),disabled:b||g})}),e("td",{className:"px-2 py-2 text-center",children:e("button",{onClick:l,disabled:g||b,className:`px-3 py-1 rounded text-sm text-white ${$?"bg-emerald-600 hover:bg-emerald-700":"bg-indigo-600 hover:bg-indigo-700"}`,title:$?"Mettre à jour l’affectation":"Enregistrer l’affectation",children:g?"…":$?"Mettre à jour":"Affecter"})}),e("td",{className:"px-3 py-2 text-xs text-center",children:b?"…":$?e("span",{className:"inline-flex items-center px-2 py-0.5 rounded bg-emerald-50 text-emerald-700 border border-emerald-200",children:"Affecté"}):e("span",{className:"inline-flex items-center px-2 py-0.5 rounded bg-amber-50 text-amber-700 border border-amber-200",children:"Non affecté"})})]})},P=()=>{var k;const{user:r,company:u}=R(),s=(r==null?void 0:r.companyId)??null,o=(r==null?void 0:r.agencyId)??null,h={primary:(u==null?void 0:u.couleurPrimaire)||"#0ea5e9",secondary:(u==null?void 0:u.couleurSecondaire)||"#f59e0b",bg:"#f7f8fa"},[v,b]=n.useState([]),[x,g]=n.useState(o),[m,w]=n.useState(I(new Date)),[S,D]=n.useState([]),[c,C]=n.useState(null),[y,N]=n.useState("");n.useEffect(()=>{(async()=>{if(!s)return;const l=(await M(T(E,`companies/${s}/agences`))).docs.map(a=>{var p,i;return{id:a.id,nom:((p=a.data())==null?void 0:p.nom)||((i=a.data())==null?void 0:i.name)||a.id}});b(l),!o&&l.length===1&&g(l[0].id)})()},[s,o]),n.useEffect(()=>{(async()=>{if(!s||!x){D([]),C(null),N("");return}const t=T(E,`companies/${s}/agences/${x}/weeklyTrips`),l=await M(t),a=j(new Date(m)),p=l.docs.map(i=>({id:i.id,...i.data()})).filter(i=>{var f;return i.active&&(((f=i.horaires)==null?void 0:f[a])||[]).length>0});D(p),c&&(p.find(f=>f.id===c.id)||(C(null),N("")))})()},[s,x,m]);const A=n.useMemo(()=>{var l;if(!c)return[];const t=j(new Date(m));return(((l=c.horaires)==null?void 0:l[t])||[]).slice().sort()},[c,m]),$=n.useCallback(()=>{},[]);return r?e("div",{className:"min-h-screen",style:{background:h.bg},children:d("div",{className:"max-w-7xl mx-auto px-4 py-6 space-y-6",children:[d("div",{className:"bg-white rounded-xl border p-4 shadow-sm space-y-3",children:[d("div",{className:"flex flex-wrap items-center gap-3",children:[d("div",{className:"flex items-center gap-2",children:[e("span",{className:"font-semibold",style:{color:h.secondary},children:"Agence :"}),o?e("span",{className:"px-2 py-1 rounded border bg-gray-50 text-sm",children:((k=v.find(t=>t.id===(x||o)))==null?void 0:k.nom)||"—"}):d("select",{className:"px-2 py-1 border rounded text-sm",value:x||"",onChange:t=>g(t.target.value||null),children:[e("option",{value:"",children:"— Choisir une agence —"}),v.map(t=>e("option",{value:t.id,children:t.nom},t.id))]})]}),e("span",{className:"font-semibold",style:{color:h.secondary},children:"Date :"}),e("button",{className:"px-2 py-1 rounded border",onClick:()=>{const t=new Date(m);t.setDate(t.getDate()-1),w(I(t))},children:"◀ Jour précédent"}),e("input",{type:"date",className:"border rounded px-3 py-1",value:m,onChange:t=>w(t.target.value)}),e("button",{className:"px-2 py-1 rounded border",onClick:()=>{const t=new Date(m);t.setDate(t.getDate()+1),w(I(t))},children:"Jour suivant ▶"})]}),e("div",{className:"font-semibold",children:"Sélectionner un trajet"}),e("div",{className:"flex flex-wrap gap-2",children:x?S.length===0?e("div",{className:"text-gray-500",children:"Aucun trajet planifié pour cette date"}):S.map(t=>{var i;const l=j(new Date(m)),a=(((i=t.horaires)==null?void 0:i[l])||[]).slice().sort(),p=(c==null?void 0:c.id)===t.id;return d("button",{onClick:()=>{C(t),N("")},className:`px-3 py-2 rounded-lg text-sm font-medium shadow-sm ${p?"text-white":"bg-gray-200 text-gray-700"}`,style:p?{background:h.primary}:void 0,title:a.join(", "),children:[t.departure," → ",t.arrival]},t.id)}):e("div",{className:"text-gray-500",children:"Choisissez d’abord une agence."})}),c&&d("div",{className:"flex flex-wrap items-center gap-2",children:[e("span",{className:"text-sm text-gray-600",children:"Heure :"}),A.length===0?e("span",{className:"text-xs text-gray-500",children:"Aucune heure pour ce jour"}):A.map(t=>{const l=y===t;return e("button",{onClick:()=>N(t),className:`px-2 py-1 rounded border text-sm ${l?"text-white":"bg-white text-gray-700"}`,style:l?{background:h.primary,borderColor:h.primary}:void 0,children:t},t)})]})]}),d("div",{className:"bg-white rounded-xl border shadow-sm",children:[d("div",{className:"px-4 py-3 flex items-center justify-between",children:[e("div",{className:"font-semibold",children:"Affectations véhicule & équipage"}),!!c&&!!y&&d("div",{className:"text-sm text-gray-600",children:[c.departure," → ",c.arrival," • ",m," • ",y]})]}),e("div",{className:"overflow-x-auto",children:d("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gray-50",children:d("tr",{children:[e("th",{className:"px-3 py-2 text-left",children:"Trajet"}),e("th",{className:"px-3 py-2 text-left",children:"N° Bus"}),e("th",{className:"px-3 py-2 text-left",children:"Immat."}),e("th",{className:"px-3 py-2 text-left",children:"Chauffeur"}),e("th",{className:"px-3 py-2 text-left",children:"Convoyeur"}),e("th",{className:"px-3 py-2 text-center w-32",children:"Action"}),e("th",{className:"px-3 py-2 text-center w-32",children:"Statut"})]})}),e("tbody",{children:c&&y?e(q,{companyId:s,agencyId:x||o,trip:c,date:m,heure:y,onSaved:$},`${c.id}_${y}`):(()=>{const t=j(new Date(m)),l=[];return S.forEach(a=>{var i;(((i=a.horaires)==null?void 0:i[t])||[]).slice().sort().forEach(f=>{l.push(e(q,{companyId:s,agencyId:x||o,trip:a,date:m,heure:f,onSaved:$},`${a.id}_${f}`))})}),l.length===0?e("tr",{children:e("td",{className:"px-3 py-4 text-gray-500",colSpan:7,children:"Aucun trajet pour cette date."})}):l})()})]})}),e("div",{className:"px-4 py-3 text-xs text-gray-500",children:"Astuce : si vous ne sélectionnez pas d’heure, le tableau affiche toutes les rotations du jour pour affecter en masse."})]})]})}):null};export{P as default};
