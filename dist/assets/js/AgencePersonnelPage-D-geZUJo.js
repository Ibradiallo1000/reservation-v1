import{r as g,a as u,j as t,F as H}from"./react-KXT1Riez.js";import{t as R,u as j,U as le,O as de,o as I,v as B,T as E,F as me,q as G,y as x,G as X,f as ue,P as pe,r as Z,w as T,J as ye}from"./firebase-DYTOaTLw.js";import{u as fe,d as h,a as he}from"../index-b0dmvJTQ.js";import"./vendor-B27hBV_J.js";async function ge(e,d){try{const r=await j(Z(R(h,"users"),T("companyId","==",e),T("agencyId","==",d)));console.log(`üì• ${r.docs.length} agents trouv√©s dans /users`);for(const c of r.docs){const m=c.data();if(m.role==="admin_platforme")continue;const v={...m,uid:c.id,displayName:m.displayName||"Nom inconnu",email:m.email||"Email inconnu",role:m.role||"guichetier",active:m.active!==!1,companyId:m.companyId||e,agencyId:m.agencyId||d,createdAt:m.createdAt||E.now()};await B(I(h,"companies",e,"agences",d,"users",c.id),v,{merge:!0})}return console.log(`‚úÖ Synchronisation termin√©e pour ${e}/${d}`),r.docs.length}catch(r){return console.error("‚ùå Erreur lors de la synchronisation:",r),0}}async function U(e){const{companyId:d,agencyId:r,role:c}=e;if(!["guichetier","comptable"].includes(c))return;const m=I(h,"companies",d,"agences",r,"counters",c);try{const v=await G(m);let b=1;if(v.exists()&&(b=(v.data().lastSeq||0)+1),await B(m,{lastSeq:b,updatedAt:E.now()},{merge:!0}),c==="guichetier")return"G"+String(b).padStart(3,"0");if(c==="comptable")return"ACC"+String(b).padStart(3,"0")}catch(v){console.error("Erreur allocateStaffCode:",v);const k=Date.now().toString().slice(-6);if(c==="guichetier")return"G"+k.slice(0,3);if(c==="comptable")return"ACC"+k.slice(0,3)}}async function Y(e,d){try{const r=R(h,"users");return!(await j(Z(r,T("companyId","==",e),T("agencyId","==",d),T("role","==","comptable"),ye(1)))).empty}catch(r){return console.error("Erreur hasComptableAlready:",r),!1}}async function be(e,d,r){if(!(!r||!r.companyId||!r.agencyId)&&["guichetier","comptable"].includes(r.role)&&!r.staffCode)try{const c=await U({companyId:r.companyId,agencyId:r.agencyId,role:r.role});if(!c)return;await x(e,{staffCode:c,codeCourt:c}),(await G(d)).exists()&&await x(d,{staffCode:c,codeCourt:c})}catch(c){console.error("Erreur ensureAgentHasCode:",c)}}const we=()=>{const{user:e,company:d}=fe(),[r,c]=g.useState([]),[m,v]=g.useState(""),[b,k]=g.useState(""),[q,V]=g.useState(""),[A,J]=g.useState("guichetier"),[$,O]=g.useState(""),[W,p]=g.useState(""),[S,N]=g.useState(!1),[ee,ae]=g.useState(!1),[D,M]=g.useState(null),[F,_]=g.useState(""),[P,z]=g.useState(""),[w,K]=g.useState("guichetier"),C=g.useMemo(()=>({primary:(d==null?void 0:d.couleurPrimaire)||"#ef6c00",secondary:(d==null?void 0:d.couleurSecondaire)||"#ffb74d"}),[d]),L=async()=>{if(!(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)))try{const a=R(h,"companies",e.companyId,"agences",e.agencyId,"users"),s=(await j(a)).docs.map(o=>{const n=o.data();return{id:o.id,uid:n.uid||o.id,displayName:n.displayName||"Nom inconnu",email:n.email||"Email inconnu",telephone:n.telephone||"",role:n.role||"guichetier",active:n.active!==!1,companyId:n.companyId||e.companyId,agencyId:n.agencyId||e.agencyId,agencyName:n.agencyName||"",staffCode:n.staffCode,codeCourt:n.codeCourt,createdAt:n.createdAt||E.now()}}).filter(o=>o.uid&&o.displayName),i=s.filter(o=>(o.role==="guichetier"||o.role==="comptable")&&!o.staffCode);if(i.length>0){console.log(`üîÑ Backfill pour ${i.length} agents sans code`);for(const y of i)if(y.id&&y.uid){const f=I(h,"companies",y.companyId,"agences",y.agencyId,"users",y.id),ie=I(h,"users",y.uid);await be(f,ie,y)}const n=(await j(a)).docs.map(y=>{const f=y.data();return{id:y.id,uid:f.uid||y.id,displayName:f.displayName||"Nom inconnu",email:f.email||"Email inconnu",telephone:f.telephone||"",role:f.role||"guichetier",active:f.active!==!1,companyId:f.companyId||e.companyId,agencyId:f.agencyId||e.agencyId,agencyName:f.agencyName||"",staffCode:f.staffCode,codeCourt:f.codeCourt,createdAt:f.createdAt||E.now()}}).filter(y=>y.uid&&y.displayName);c(n.sort((y,f)=>(y.displayName||"").localeCompare(f.displayName||"")))}else c(s.sort((o,n)=>(o.displayName||"").localeCompare(n.displayName||"")));console.log(`‚úÖ ${s.length} agents charg√©s`)}catch(a){console.error("loadAgents err:",a),p("‚ùå Erreur lors du chargement des agents.")}};g.useEffect(()=>{(async()=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const l=R(h,"companies",e.companyId,"agences",e.agencyId,"users");(await j(l)).empty&&e.role==="chefAgence"&&!ee&&(console.log("üîÑ Synchronisation des agents existants..."),await ge(e.companyId,e.agencyId),ae(!0)),await L()})()},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,e==null?void 0:e.role]);const te=()=>{v(""),k(""),V(""),O(""),J("guichetier")},oe=async()=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)){p("‚ö†Ô∏è Contexte agence/compagnie manquant.");return}if(!m||!$||!b){p("‚ö†Ô∏è Nom, email et mot de passe sont obligatoires.");return}if($.length<6){p("‚ö†Ô∏è Mot de passe: minimum 6 caract√®res.");return}N(!0),p("");try{if(A==="comptable"&&await Y(e.companyId,e.agencyId)){N(!1),p("‚ö†Ô∏è Il existe d√©j√† un comptable pour cette agence.");return}const a=await le(he,m,$);await de(a.user,{displayName:b});const l=a.user.uid;let s;(A==="guichetier"||A==="comptable")&&(s=await U({companyId:e.companyId,agencyId:e.agencyId,role:A}));const i=I(h,"users",l);await B(i,{uid:l,email:m,displayName:b,telephone:q||"",role:A,active:!0,companyId:e.companyId,agencyId:e.agencyId,agencyName:(e==null?void 0:e.agencyName)||"",createdAt:E.now(),...s?{staffCode:s,codeCourt:s}:{}},{merge:!0}),await me(R(h,"companies",e.companyId,"agences",e.agencyId,"users"),{uid:l,email:m,displayName:b,telephone:q||"",role:A,active:!0,companyId:e.companyId,agencyId:e.agencyId,agencyName:(e==null?void 0:e.agencyName)||"",createdAt:E.now(),...s?{staffCode:s,codeCourt:s}:{}}),p("‚úÖ Agent ajout√© avec succ√®s."),te(),await L()}catch(a){console.error("handleAdd err:",a),(a==null?void 0:a.code)==="auth/email-already-in-use"?p("‚ö†Ô∏è Cet email est d√©j√† utilis√©."):p("‚ùå Ajout impossible. Voir la console.")}finally{N(!1)}},ne=a=>window.confirm(a),Q=async(a,l)=>{if(!(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!a.id)){N(!0);try{const s=I(h,"companies",e.companyId,"agences",e.agencyId,"users",a.id);if(await x(s,{active:l}),a.uid){const i=I(h,"users",a.uid);await x(i,{active:l})}c(i=>i.map(o=>o.id===a.id?{...o,active:l}:o))}catch(s){console.error("toggleActive err:",s),p("‚ùå Erreur lors du changement de statut.")}finally{N(!1)}}},ce=a=>{M(a.id||null),_(a.displayName),z(a.telephone||""),K(a.role)},se=async()=>{if(!(!D||!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))){N(!0);try{const a=I(h,"companies",e.companyId,"agences",e.agencyId,"users",D),l=await G(a),s=l.exists()?l.data():null;if(!s)throw new Error("Agent introuvable.");if(w==="comptable"&&s.role!=="comptable"&&await Y(e.companyId,e.agencyId)){N(!1),p("‚ö†Ô∏è Il existe d√©j√† un comptable pour cette agence.");return}await x(a,{displayName:F,telephone:P,role:w});const i=s.uid;if(i){const o=I(h,"users",i);if(await x(o,{displayName:F,telephone:P,role:w}),(w==="guichetier"||w==="comptable")&&!s.staffCode){const n=await U({companyId:e.companyId,agencyId:e.agencyId,role:w});n&&(await x(a,{staffCode:n,codeCourt:n}),await x(o,{staffCode:n,codeCourt:n}))}}c(o=>o.map(n=>n.id===D?{...n,displayName:F,telephone:P,role:w}:n)),M(null),p("‚úÖ Agent modifi√© avec succ√®s.")}catch(a){console.error("edit save err:",a),p("‚ùå Erreur lors de la modification.")}finally{N(!1)}}},re=async a=>{if(!(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!a.id||!ne(`Supprimer d√©finitivement "${a.displayName}" ?
Cette action effacera aussi son compte d'authentification.`))){N(!0),p("");try{const s=I(h,"companies",e.companyId,"agences",e.agencyId,"users",a.id);if(await X(s),a.uid){const i=I(h,"users",a.uid);(await G(i)).exists()&&await X(i)}if(a.uid)try{const i=ue();await pe(i,"adminDeleteUser")({uid:a.uid})}catch(i){console.warn("Cloud Function non disponible:",i)}c(i=>i.filter(o=>o.id!==a.id)),p("‚úÖ Agent supprim√©.")}catch(s){console.error("delete err:",s),p("‚ùå Erreur lors de la suppression.")}finally{N(!1)}}};return u("div",{className:"p-6 max-w-5xl mx-auto min-h-screen",style:{background:"#f7f7fb"},children:[t("h1",{className:"text-3xl font-extrabold mb-6",style:{color:C.primary},children:"Gestion du personnel (Agence)"}),u("div",{className:"mb-8 bg-white p-6 rounded-xl shadow-md border",style:{borderColor:C.secondary},children:[t("h2",{className:"text-lg font-semibold mb-4",style:{color:C.secondary},children:"Ajouter un agent"}),u("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[t("input",{value:b,onChange:a=>k(a.target.value),placeholder:"Nom complet",className:"border p-3 rounded focus:ring-2"}),t("input",{value:m,onChange:a=>v(a.target.value),placeholder:"Email",type:"email",className:"border p-3 rounded focus:ring-2"}),t("input",{value:q,onChange:a=>V(a.target.value),placeholder:"T√©l√©phone (optionnel)",className:"border p-3 rounded focus:ring-2"}),u("select",{value:A,onChange:a=>J(a.target.value),className:"border p-3 rounded focus:ring-2",children:[t("option",{value:"guichetier",children:"Guichetier"}),t("option",{value:"controleur",children:"Contr√¥leur"}),t("option",{value:"comptable",children:"Comptable"}),t("option",{value:"chefAgence",children:"Chef d'agence"})]}),t("input",{value:$,onChange:a=>O(a.target.value),placeholder:"Mot de passe",type:"password",className:"border p-3 rounded focus:ring-2 md:col-span-2"})]}),t("button",{onClick:oe,disabled:S,className:"w-full py-3 rounded font-semibold text-white transition disabled:opacity-60",style:{background:`linear-gradient(to right, ${C.primary}, ${C.secondary})`},children:S?"‚è≥ Traitement...":"Ajouter l'agent"}),W&&t("p",{className:"mt-3 text-center text-sm text-gray-700",children:W})]}),u("div",{className:"bg-white rounded-xl shadow-md border",style:{borderColor:C.secondary},children:[t("div",{className:"p-4 border-b",style:{borderColor:C.secondary},children:u("h2",{className:"text-lg font-semibold",style:{color:C.secondary},children:["Agents de cette agence (",r.length,")"]})}),r.length===0?t("p",{className:"p-6 text-gray-500",children:"Aucun agent enregistr√©."}):t("div",{className:"divide-y",children:r.map(a=>u("div",{className:"p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[t("div",{className:"flex-1",children:D===a.id?u("div",{className:"grid grid-cols-1 sm:grid-cols-5 gap-2",children:[t("input",{value:F,onChange:l=>_(l.target.value),className:"border p-2 rounded",placeholder:"Nom"}),t("input",{value:P,onChange:l=>z(l.target.value),placeholder:"T√©l√©phone",className:"border p-2 rounded"}),u("select",{value:w,onChange:l=>K(l.target.value),className:"border p-2 rounded",children:[t("option",{value:"guichetier",children:"Guichetier"}),t("option",{value:"controleur",children:"Contr√¥leur"}),t("option",{value:"comptable",children:"Comptable"}),t("option",{value:"chefAgence",children:"Chef d'agence"})]}),u("div",{className:"text-sm text-gray-500 flex items-center",children:["Code: ",t("span",{className:"font-mono ml-1",children:a.staffCode||"‚Äî"})]}),u("div",{className:"text-xs text-gray-500 flex items-center",children:["Statut:",t("span",{className:`ml-1 ${a.active?"text-green-600":"text-red-600"}`,children:a.active?"Actif":"D√©sactiv√©"})]})]}):u(H,{children:[u("p",{className:"font-semibold text-gray-900",children:[a.displayName," ",u("span",{className:"text-gray-500 text-sm",children:["‚Ä¢ ",a.role]}),(a.role==="guichetier"||a.role==="comptable")&&t("span",{className:"ml-2 px-2 py-0.5 rounded bg-gray-100 font-mono text-xs",children:a.staffCode||"‚Äî"})]}),u("p",{className:"text-sm text-gray-600",children:[a.email,a.telephone?` ‚Ä¢ ${a.telephone}`:""]}),u("p",{className:"text-xs",children:["Statut :"," ",t("span",{className:a.active?"text-green-600":"text-red-600",children:a.active?"Actif":"D√©sactiv√©"})]})]})}),t("div",{className:"flex flex-wrap gap-2",children:D===a.id?u(H,{children:[t("button",{onClick:se,disabled:S,className:"px-3 py-1 rounded text-white",style:{background:C.primary},children:"Enregistrer"}),t("button",{onClick:()=>M(null),className:"px-3 py-1 rounded border",children:"Annuler"})]}):u(H,{children:[t("button",{onClick:()=>ce(a),className:"px-3 py-1 rounded border",children:"Modifier"}),a.active?t("button",{onClick:()=>Q(a,!1),disabled:S,className:"px-3 py-1 rounded text-white",style:{background:"#b45309"},children:"D√©sactiver"}):t("button",{onClick:()=>Q(a,!0),disabled:S,className:"px-3 py-1 rounded text-white",style:{background:"#16a34a"},children:"Activer"}),t("button",{onClick:()=>re(a),disabled:S,className:"px-3 py-1 rounded text-white",style:{background:"#dc2626"},children:"Supprimer"})]})})]},a.id))})]})]})};export{we as default};
