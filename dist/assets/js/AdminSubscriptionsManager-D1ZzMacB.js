import{r as o,a,j as t,F as _}from"./vendor-Bq-8_m9i.js";import{r as $,t as k,I as ie,u as I,w as le,T as f,x as y,y as v,o as w,E as oe}from"./firebase-CURBI7X6.js";import{B as p,O as b,l as ce,d as g}from"./agence-Bsj2lp2X.js";import{C as z,q as de,s as me,t as G,S as R,u as ue}from"./compagnie-DiuZFnHS.js";import{r as pe,l as O,u as ge,Z as q,R as xe,S as he,a9 as ye,as as fe,C as be,aw as Ne}from"./icons-C0JHUK9Z.js";import"./router-DoGdw-3y.js";import"./courier-CoQgRaHG.js";const V=30*24*60*60*1e3,C=l=>l?l instanceof f?l.toDate():l instanceof Date?l:null:null,S=l=>l?l.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"}):"—",ve=["trial","active","grace","restricted","suspended"];function Ae(){const[l,H]=o.useState([]),[D,B]=o.useState(!0),[P,Q]=o.useState(""),[Z,J]=o.useState(null),[K,u]=o.useState(null),[N,c]=o.useState(null),[x,T]=o.useState(0),[L,W]=o.useState("mobile_money"),[X,F]=o.useState(null),[E,j]=o.useState(0),[A,Y]=o.useState([]),[ee,U]=o.useState(null),h=async()=>{B(!0);try{const e=$(k(g,"companies"),ie("nom","asc")),n=(await I(e)).docs.map(m=>{const i=m.data();return{id:m.id,nom:i.nom||m.id,plan:i.plan||"—",subscriptionStatus:i.subscriptionStatus||"active",nextBillingDate:C(i.nextBillingDate),lastPaymentAt:C(i.lastPaymentAt),digitalFeePercent:Number(i.digitalFeePercent)||0,totalDigitalRevenueGenerated:Number(i.totalDigitalRevenueGenerated)||0,totalDigitalFeesCollected:Number(i.totalDigitalFeesCollected)||0,totalPaymentsReceived:Number(i.totalPaymentsReceived)||0,trialEndsAt:C(i.trialEndsAt),graceUntil:C(i.graceUntil)}});H(n);const r=$(k(g,"invitations"),le("status","==","pending")),d=await I(r);Y(d.docs.map(m=>{const i=m.data();return{id:m.id,email:i.email||"",role:i.role||"",fullName:i.fullName,companyId:i.companyId,token:i.token,status:i.status||"pending"}}))}catch{c({type:"error",text:"Erreur lors du chargement des compagnies."})}finally{B(!1)}};o.useEffect(()=>{h()},[]);const M=l.filter(e=>e.nom.toLowerCase().includes(P.toLowerCase())||e.plan.toLowerCase().includes(P.toLowerCase())),te=async(e,s)=>{u(e);try{const n=f.now(),r={subscriptionStatus:s,"subscription.status":s,updatedAt:y()};if(s==="grace"){const d=f.fromDate(new Date(Date.now()+6048e5));r.graceUntil=d,r["subscription.gracePeriodEnd"]=d}s==="active"&&(r.status="actif"),await v(w(g,"companies",e),r),c({type:"success",text:`Statut mis à jour : ${R[s]}`}),await h()}catch{c({type:"error",text:"Erreur lors de la mise à jour du statut."})}finally{u(null)}},ae=async e=>{u(e);try{const s=new Date,n=f.fromDate(new Date(s.getTime()+V));await v(w(g,"companies",e),{nextBillingDate:n,"subscription.currentPeriodEnd":n,"subscription.nextBillingDate":n,updatedAt:y()}),c({type:"success",text:"Période de facturation prolongée de 30 jours."}),await h()}catch{c({type:"error",text:"Erreur lors de l'extension."})}finally{u(null)}},se=async e=>{if(x<=0){c({type:"error",text:"Le montant doit être positif."});return}u(e);try{const s=f.now(),n=f.fromDate(new Date(Date.now()+V));await oe(k(g,"companies",e,"payments"),{amount:x,method:L,periodCoveredStart:s,periodCoveredEnd:n,createdAt:y(),status:"validated",validatedBy:"admin_manual",validatedAt:y()});const r=w(g,"companies",e),d=l.find(i=>i.id===e),m=((d==null?void 0:d.totalPaymentsReceived)??0)+x;await v(r,{subscriptionStatus:"active","subscription.status":"active",lastPaymentAt:s,nextBillingDate:n,"subscription.currentPeriodStart":s,"subscription.currentPeriodEnd":n,"subscription.lastPaymentAt":s,"subscription.nextBillingDate":n,totalPaymentsReceived:m,status:"actif",updatedAt:y()}),c({type:"success",text:`Paiement de ${b(x)} enregistré.`}),T(0),await h()}catch{c({type:"error",text:"Erreur lors de l'enregistrement du paiement."})}finally{u(null)}},re=async e=>{u(e);try{await v(w(g,"companies",e),{digitalFeePercent:E,updatedAt:y()}),c({type:"success",text:`Frais digital mis à jour : ${E}%`}),F(null),await h()}catch{c({type:"error",text:"Erreur lors de la mise à jour du frais digital."})}finally{u(null)}},ne=({status:e})=>{const s=ue[e]??"bg-gray-100 text-gray-700";return t("span",{className:`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${s}`,children:R[e]??e})};return a("div",{className:"space-y-6",children:[a("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[a("div",{children:[t("h1",{className:"text-2xl font-bold text-gray-900",children:"Gestion des abonnements"}),a("p",{className:"text-sm text-gray-500 mt-1",children:["Contrôle manuel du cycle de vie des abonnements — ",l.length," compagnie",l.length>1?"s":""]})]}),a(p,{variant:"secondary",onClick:h,disabled:D,children:[t(xe,{className:`h-4 w-4 mr-2 ${D?"animate-spin":""}`}),"Actualiser"]})]}),N&&a("div",{className:`flex items-center gap-2 rounded-xl border p-3 text-sm ${N.type==="error"?"border-red-200 bg-red-50 text-red-700":"border-green-200 bg-green-50 text-green-700"}`,children:[N.type==="error"?t(q,{className:"h-4 w-4"}):t(O,{className:"h-4 w-4"}),N.text,t("button",{className:"ml-auto text-xs underline",onClick:()=>c(null),children:"Fermer"})]}),a("div",{className:"relative",children:[t(he,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),t("input",{className:"w-full rounded-lg border border-gray-300 bg-white pl-10 pr-4 py-2 text-sm focus:border-[var(--btn-primary,#FF6600)] focus:outline-none focus:ring-2 focus:ring-[var(--btn-primary,#FF6600)]/20",placeholder:"Rechercher par nom ou plan...",value:P,onChange:e=>Q(e.target.value)})]}),A.length>0&&a(z,{children:[t(me,{children:a(de,{className:"text-lg flex items-center gap-2",children:[t(pe,{className:"h-5 w-5 text-orange-500"}),"Invitations en attente (",A.length,")"]})}),t(G,{children:t("div",{className:"space-y-2",children:A.map(e=>{var d;const s=((d=l.find(m=>m.id===e.companyId))==null?void 0:d.nom)||e.companyId||"Plateforme",n=e.token?`${window.location.origin}/accept-invitation/${e.token}`:null,r=ee===e.id;return a("div",{className:"flex items-center justify-between gap-3 rounded-lg border border-gray-200 px-4 py-3 bg-gray-50",children:[a("div",{className:"min-w-0 flex-1",children:[a("div",{className:"flex items-center gap-2 flex-wrap",children:[t("span",{className:"font-medium text-gray-900 text-sm truncate",children:e.email}),t("span",{className:"text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full",children:e.role==="company_ceo"?"CEO":e.role})]}),a("p",{className:"text-xs text-gray-500 mt-0.5",children:[e.fullName&&a("span",{children:[e.fullName," · "]}),s]})]}),n?t(p,{variant:r?"primary":"secondary",size:"sm",onClick:()=>{navigator.clipboard.writeText(n),U(e.id),c({type:"success",text:`Lien d'activation copié pour ${e.email}`}),setTimeout(()=>U(null),3e3)},children:r?a(_,{children:[t(O,{className:"h-3.5 w-3.5 mr-1"})," Copié !"]}):a(_,{children:[t(ge,{className:"h-3.5 w-3.5 mr-1"})," Copier le lien"]})}):a("span",{className:"text-xs text-amber-600 flex items-center gap-1",children:[t(q,{className:"h-3.5 w-3.5"})," Pas de token"]})]},e.id)})})})]}),a("div",{className:"space-y-3",children:[M.map(e=>{const s=Z===e.id,n=K===e.id;return a(z,{children:[a("button",{type:"button",className:"w-full text-left p-4 flex items-center gap-4 hover:bg-gray-50 transition rounded-xl",onClick:()=>J(s?null:e.id),children:[t(ye,{className:"h-5 w-5 text-gray-400 shrink-0"}),a("div",{className:"flex-1 min-w-0",children:[a("div",{className:"flex items-center gap-2 flex-wrap",children:[t("span",{className:"font-semibold text-gray-900 truncate",children:e.nom}),t(ne,{status:e.subscriptionStatus}),t("span",{className:"text-xs text-gray-400",children:e.plan})]}),a("div",{className:"flex flex-wrap gap-x-4 gap-y-1 mt-1 text-xs text-gray-500",children:[a("span",{children:["Frais digital : ",a("strong",{className:"text-gray-700",children:[e.digitalFeePercent,"%"]})]}),a("span",{children:["Prochaine fact. : ",t("strong",{className:"text-gray-700",children:S(e.nextBillingDate)})]}),a("span",{children:["Paiements : ",t("strong",{className:"text-gray-700",children:b(e.totalPaymentsReceived)})]})]})]}),s?t(fe,{className:"h-4 w-4 text-gray-400"}):t(be,{className:"h-4 w-4 text-gray-400"})]}),s&&a(G,{className:"border-t border-gray-100 space-y-5",children:[a("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[a("div",{className:"rounded-lg border p-3",children:[t("p",{className:"text-xs text-gray-500",children:"Revenus digitaux"}),t("p",{className:"text-lg font-bold",children:b(e.totalDigitalRevenueGenerated)})]}),a("div",{className:"rounded-lg border p-3",children:[t("p",{className:"text-xs text-gray-500",children:"Frais collectés"}),t("p",{className:"text-lg font-bold text-[var(--btn-primary,#FF6600)]",children:b(e.totalDigitalFeesCollected)})]}),a("div",{className:"rounded-lg border p-3",children:[t("p",{className:"text-xs text-gray-500",children:"Paiements reçus"}),t("p",{className:"text-lg font-bold text-green-600",children:b(e.totalPaymentsReceived)})]}),a("div",{className:"rounded-lg border p-3",children:[t("p",{className:"text-xs text-gray-500",children:"Dernier paiement"}),t("p",{className:"text-sm font-semibold",children:S(e.lastPaymentAt)})]})]}),a("div",{children:[t("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Changer le statut"}),t("div",{className:"flex flex-wrap gap-2",children:ve.map(r=>t(p,{variant:e.subscriptionStatus===r?"primary":"secondary",size:"sm",disabled:n||e.subscriptionStatus===r,onClick:()=>te(e.id,r),children:R[r]},r))})]}),a("div",{children:[t("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Facturation"}),t(p,{variant:"secondary",size:"sm",disabled:n,onClick:()=>ae(e.id),children:"Prolonger +30 jours"}),e.trialEndsAt&&a("p",{className:"text-xs text-gray-500 mt-1",children:["Fin d'essai : ",S(e.trialEndsAt)]}),e.graceUntil&&a("p",{className:"text-xs text-amber-600 mt-1",children:["Fin de grâce : ",S(e.graceUntil)]})]}),a("div",{children:[t("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Frais canal digital"}),X===e.id?a("div",{className:"flex items-center gap-2",children:[t("input",{type:"number",step:"0.1",min:"0",max:"100",className:"w-24 rounded-lg border px-3 py-1.5 text-sm",value:E,onChange:r=>j(Number(r.target.value))}),t("span",{className:"text-sm text-gray-500",children:"%"}),t(p,{variant:"primary",size:"sm",disabled:n,onClick:()=>re(e.id),children:"Sauver"}),t(p,{variant:"secondary",size:"sm",onClick:()=>F(null),children:"Annuler"})]}):a(p,{variant:"secondary",size:"sm",onClick:()=>{F(e.id),j(e.digitalFeePercent)},children:[e.digitalFeePercent,"% — Modifier"]})]}),a("div",{className:"rounded-lg border border-green-200 bg-green-50 p-4",children:[a("p",{className:"text-sm font-medium text-green-800 mb-3 flex items-center gap-1",children:[t(Ne,{className:"h-4 w-4"})," Enregistrer un paiement"]}),a("div",{className:"flex flex-wrap items-end gap-3",children:[a("div",{children:[a("label",{className:"text-xs text-gray-600",children:["Montant (",ce(),")"]}),t("input",{type:"number",min:"0",className:"block w-40 rounded-lg border px-3 py-1.5 text-sm mt-1",value:x||"",onChange:r=>T(Number(r.target.value)),placeholder:"40000"})]}),a("div",{children:[t("label",{className:"text-xs text-gray-600",children:"Méthode"}),a("select",{className:"block rounded-lg border px-3 py-1.5 text-sm mt-1",value:L,onChange:r=>W(r.target.value),children:[t("option",{value:"mobile_money",children:"Mobile Money"}),t("option",{value:"invoice",children:"Facture"})]})]}),t(p,{variant:"primary",size:"sm",disabled:n||x<=0,onClick:()=>se(e.id),children:"Enregistrer"})]}),t("p",{className:"text-xs text-green-700 mt-2",children:"Cela active automatiquement l'abonnement et prolonge de 30 jours."})]})]})]},e.id)}),M.length===0&&!D&&t("p",{className:"text-sm text-gray-500 text-center py-8",children:"Aucune compagnie trouvée."})]})]})}export{Ae as default};
