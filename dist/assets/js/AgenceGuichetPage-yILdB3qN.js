import{u as xe,r as l,j as e}from"./react-A-4nP3fl.js";import{q as U,f as C,w as Y,e as I,d as he,c as ye,T as be,h as fe}from"./firebase-CbfwkGbo.js";import{u as ve,d as v}from"../index-ChphXJpr.js";import"./vendor-CCJV4Wg0.js";const B=30,W=8,X="compagnie-par-defaut",ke=()=>{const{user:o}=ve(),$=xe(),[j,J]=l.useState(""),[w,K]=l.useState(""),[Q,E]=l.useState(""),[f,Z]=l.useState([]),[P,D]=l.useState([]),[ee,se]=l.useState([]),[te,ae]=l.useState([]),[t,k]=l.useState(null),[y,re]=l.useState(""),[b,le]=l.useState(""),[i,A]=l.useState(1),[h,T]=l.useState(0),[g,V]=l.useState("aller_simple"),[F,M]=l.useState(0),[L,ne]=l.useState("espèces"),[q,z]=l.useState(!1),oe=Array.from({length:W},(s,a)=>{const r=new Date;return r.setDate(r.getDate()+a),r.toISOString().split("T")[0]}),N=l.useCallback((s,a)=>{const r=new Date,[u,m]=a.split(":").map(Number),c=new Date(s);return c.setHours(u,m,0,0),c.getTime()<r.getTime()},[]);l.useEffect(()=>{(async()=>{try{const r=(await I(U(C(v,"weeklyTrips"),Y("active","==",!0)))).docs.map(c=>c.data()),u=Array.from(new Set(r.map(c=>c.departure))),m=Array.from(new Set(r.map(c=>c.arrival)));se(u),ae(m)}catch(a){console.error("Erreur chargement des villes:",a)}})()},[]),l.useEffect(()=>{if(!t){M(0);return}const s=t.price;let a=i*s;g==="aller_retour"&&(a+=h*s),M(a)},[i,h,g,t]);const ie=l.useCallback(async()=>{var s,a,r,u;if(!j||!w){alert("Veuillez sélectionner une ville de départ et une ville d'arrivée");return}try{const m=j.trim().toLowerCase(),c=w.trim().toLowerCase(),R=U(C(v,"weeklyTrips"),Y("agencyId","==",(o==null?void 0:o.agencyId)||"")),pe=(await I(R)).docs.map(n=>({id:n.id,...n.data()})),G=[],H=new Date;for(let n=0;n<W;n++){const p=new Date(H);p.setDate(H.getDate()+n);const x=p.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase();for(const d of pe)if(((s=d.departure)==null?void 0:s.toLowerCase())===m&&((a=d.arrival)==null?void 0:a.toLowerCase())===c&&d.active&&((u=(r=d.horaires)==null?void 0:r[x])==null?void 0:u.length)>0)for(const O of d.horaires[x])G.push({id:`${d.id}_${p.toISOString().split("T")[0]}_${O}`,date:p.toISOString().split("T")[0],time:O,departure:d.departure,arrival:d.arrival,price:d.price,places:d.places||B})}const ge=(await I(C(v,"reservations"))).docs.map(n=>n.data()),S=G.map(n=>{const p=ge.filter(x=>x.trajetId===n.id&&x.statut==="payé").reduce((x,d)=>x+(d.seatsGo||1),0);return{...n,remainingSeats:(n.places||B)-p}}).filter(n=>!N(n.date,n.time));Z(S);const _=S.length>0?S[0].date:"";if(E(_),_){const n=S.filter(p=>p.date===_).sort((p,x)=>p.time.localeCompare(x.time));D(n)}else D([]);k(null)}catch(m){console.error("Erreur lors de la recherche :",m),alert("Une erreur est survenue lors de la recherche des trajets")}},[j,w,o==null?void 0:o.agencyId,N]),ce=l.useCallback(s=>{E(s);const a=f.filter(r=>r.date===s&&!N(r.date,r.time)).sort((r,u)=>r.time.localeCompare(u.time));D(a),k(null)},[f,N]),de=l.useCallback(s=>{k(s),A(1),T(0)},[]),me=l.useCallback(async()=>{if(!t||!y||!b||i<1){alert("Veuillez remplir tous les champs obligatoires");return}if(!(o!=null&&o.companyId)){alert("Votre compte n'est pas associé à une compagnie valide");return}const s=g==="aller_retour"?i+h:i;if(t.remainingSeats!==void 0&&s>t.remainingSeats){alert(`Désolé, il ne reste que ${t.remainingSeats} places disponibles.`);return}z(!0);try{let a=X,r="Compagnie";const u=he(v,"compagnies",o.companyId),m=await ye(u);m.exists()?(a=m.data().slug||X,r=m.data().nom||"Compagnie"):console.warn(`Compagnie ${o.companyId} non trouvée, utilisation des valeurs par défaut`);const c={trajetId:t.id,nomClient:y,telephone:b,seatsGo:i,seatsReturn:g==="aller_retour"?h:0,date:t.date,heure:t.time,depart:t.departure,arrivee:t.arrival,montant:F,statut:"payé",compagnieId:o.companyId,compagnieNom:r,agencyId:o.agencyId||null,createdAt:be.now(),canal:"guichet",tripType:g,paiement:L,companySlug:a},R=await fe(C(v,"reservations"),c);$(`/agence/receipt/${R.id}`)}catch(a){console.error("Erreur création réservation:",a);let r="Erreur lors de la réservation";a instanceof Error&&(r+=`: ${a.message}`),alert(r)}finally{z(!1)}},[t,y,b,o,i,h,g,F,L,$]),ue=Array.from(new Set(f.map(s=>s.date)));return e.jsxs("div",{className:"p-6 grid grid-cols-1 lg:grid-cols-3 gap-6 bg-gray-50 min-h-screen",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("header",{className:"space-y-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"🎛 Guichet – Vente de billets"}),e.jsx("p",{className:"text-gray-600",children:"Recherchez et réservez des billets pour vos clients"})]}),e.jsxs("section",{className:"bg-white p-4 rounded-xl shadow",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3 text-gray-800",children:"🔍 Rechercher un trajet"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"departure",className:"block text-sm font-medium text-gray-700 mb-1",children:"Départ"}),e.jsx("input",{id:"departure",list:"depList",value:j,onChange:s=>J(s.target.value),placeholder:"Ville de départ",className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"}),e.jsx("datalist",{id:"depList",children:ee.map(s=>e.jsx("option",{value:s},`dep-${s}`))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"arrival",className:"block text-sm font-medium text-gray-700 mb-1",children:"Arrivée"}),e.jsx("input",{id:"arrival",list:"arrList",value:w,onChange:s=>K(s.target.value),placeholder:"Ville d'arrivée",className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"}),e.jsx("datalist",{id:"arrList",children:te.map(s=>e.jsx("option",{value:s},`arr-${s}`))})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:ie,className:"w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium px-4 py-2 rounded transition-colors duration-200",children:"Rechercher"})})]})]}),f.length>0&&e.jsxs("section",{className:"bg-white p-4 rounded-xl shadow",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3 text-gray-800",children:"📅 Dates disponibles"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:oe.map(s=>{const a=ue.includes(s),r=Q===s;return e.jsx("button",{onClick:()=>a&&ce(s),className:`px-3 py-1 rounded-full text-sm border shadow-sm transition-colors duration-200 ${r?"bg-yellow-600 text-white border-yellow-700":a?"bg-yellow-100 text-yellow-700 border-yellow-200 hover:bg-yellow-200":"bg-gray-100 text-gray-500 border-gray-200 cursor-not-allowed"}`,disabled:!a,title:a?`Voir les trajets pour le ${s}`:"Date non disponible",children:new Date(s).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})},s)})})]}),e.jsxs("section",{className:"bg-white p-4 rounded-xl shadow",children:[e.jsx("h2",{className:"text-xl font-semibold mb-3 text-gray-800",children:"🕒 Horaires disponibles"}),P.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500",children:f.length===0?"Aucun trajet trouvé. Veuillez effectuer une recherche.":"Aucun horaire disponible pour cette date."})}):e.jsx("ul",{className:"divide-y divide-gray-200",children:P.map(s=>e.jsx("li",{onClick:()=>de(s),className:`py-3 px-2 cursor-pointer transition-colors duration-200 ${(t==null?void 0:t.id)===s.id?"bg-yellow-100 border-l-4 border-yellow-500":"hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-bold",children:[e.jsx("span",{className:"text-lg",children:s.time})," — ",s.departure," → ",s.arrival]}),e.jsx("p",{className:"text-sm text-gray-600",children:new Date(s.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-yellow-700",children:[s.price.toLocaleString("fr-FR")," FCFA"]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[s.remainingSeats??"NC"," places restantes"]})]})]})},s.id))})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow space-y-4 sticky top-6 h-fit",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"🧍‍♂️ Détails du passager"}),t?e.jsxs("div",{className:"text-sm text-gray-700 bg-yellow-50 rounded-lg border-l-4 border-yellow-500 p-3 space-y-1",children:[e.jsxs("p",{className:"font-medium",children:[t.departure," → ",t.arrival]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(t.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Heure:"})," ",t.time]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Prix unitaire:"})," ",t.price.toLocaleString("fr-FR")," FCFA"]}),t.remainingSeats!==void 0&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Places restantes:"})," ",t.remainingSeats]})]}):e.jsx("div",{className:"text-center py-4 bg-gray-50 rounded-lg text-gray-500",children:"Sélectionnez un trajet pour continuer"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>V("aller_simple"),className:`flex-1 py-2 rounded transition-colors duration-200 ${g==="aller_simple"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Aller simple"}),e.jsx("button",{onClick:()=>V("aller_retour"),className:`flex-1 py-2 rounded transition-colors duration-200 ${g==="aller_retour"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Aller-retour"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Nom complet du passager*"}),e.jsx("input",{type:"text",value:y,onChange:s=>re(s.target.value),className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Numéro de téléphone*"}),e.jsx("input",{type:"tel",value:b,onChange:s=>le(s.target.value),className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Nombre de places (Aller)*"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>A(s=>Math.max(1,s-1)),className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-200",disabled:!t,children:"-"}),e.jsx("span",{className:"w-8 text-center",children:i}),e.jsx("button",{onClick:()=>A(s=>s+1),className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-200",disabled:!t||t.remainingSeats!==void 0&&i>=t.remainingSeats,children:"+"})]})]}),g==="aller_retour"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Nombre de places (Retour)"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>T(s=>Math.max(0,s-1)),className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-200",disabled:!t,children:"-"}),e.jsx("span",{className:"w-8 text-center",children:h}),e.jsx("button",{onClick:()=>T(s=>s+1),className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-200",disabled:!t||t.remainingSeats!==void 0&&i+h>=t.remainingSeats,children:"+"})]})]}),e.jsxs("div",{className:"pt-2 border-t border-gray-200 space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Total à payer"}),e.jsxs("span",{className:"text-xl font-bold text-green-600",children:[F.toLocaleString("fr-FR")," FCFA"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Mode de paiement"}),e.jsxs("select",{value:L,onChange:s=>ne(s.target.value),className:"w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"espèces",children:"Espèces"}),e.jsx("option",{value:"mobile_money",children:"Mobile Money"})]})]})]}),e.jsx("button",{onClick:me,disabled:!t||!y||!b||i<1||q,className:`w-full py-3 px-4 rounded font-semibold transition-colors duration-200 flex items-center justify-center ${!t||!y||!b||i<1?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-green-600 hover:bg-green-700 text-white"}`,children:q?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Traitement..."]}):"✅ Valider la réservation"})]})]})};export{ke as default};
