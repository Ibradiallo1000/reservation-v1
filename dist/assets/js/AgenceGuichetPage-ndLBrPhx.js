import{r as l,a as n,j as t,ao as Ye,t as Je,E as Qe,M as Ie,a5 as qt,T as ct,_ as Ht,p as Vt,aX as _t,a6 as zt,B as Bt,F as ve,aY as Ot,aZ as Wt,aj as et,a_ as Xt,X as Kt,a$ as Zt,b0 as Yt}from"./react-DB_4kGOy.js";import{q as Ae,o as O,x as z,z as ae,w as B,y as R,A as Jt,T as ue,E as mt,C as tt,D as at,B as nt,J as Qt,H as ea}from"./firebase-lLzYRzUk.js";import{e as ta,h as rt,u as aa,b as na,d as D}from"../index-Bkmir__O.js";import{u as ra}from"./useActiveShift-CKM2FBmt.js";import{h as sa}from"./html2pdf-DQqgx56O.js";import{p as la,f as oa,c as ia}from"./vendor-C-DAJou6.js";import"./jspdf.es.min-Gs4S7Zlz.js";import"./html2canvas-BI8K_7w5.js";function da(h){return(h||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9 ]/g," ").trim().replace(/\s+/g,"-").toUpperCase()}function st(h,e,r=5){const g=(e||"").toUpperCase().replace(/[^A-Z0-9]/g,"");if(g)return g.slice(0,r);const k=(h||"").trim();if(!k)return"ORG";const S=k.split(/\s+/).filter(Boolean);if(S.length>=2){const o=S.slice(0,3).map(T=>T[0]||"").join("");if(o)return o.toUpperCase().slice(0,r)}return da(k).replace(/-/g,"").slice(0,Math.max(3,r))}function lt(h,e){try{let r;return h?typeof h=="string"?r=la(h):h instanceof Date?r=h:r=new Date(h.seconds*1e3):r=new Date,oa(r,e,{locale:ia})}catch{return"--/--/----"}}function ot(h,e="XXX"){const r=(h||"").trim();if(!r)return e;const g=r.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9\s]/g," ").trim().split(/\s+/).filter(Boolean);return g.length===1?g[0].slice(0,3).toUpperCase():g.slice(0,3).map(k=>k[0]).join("").toUpperCase()}function ca(h){const e=(h||"").toLowerCase();return e==="en_ligne"?"en ligne":e||"—"}const ma=({open:h,onClose:e,reservation:r,company:g,autoPrint:k=!1})=>{var C;const S=l.useRef(null),o=l.useMemo(()=>{if(r!=null&&r.referenceCode)return r.referenceCode;const v=ot(g==null?void 0:g.nom,"CMP"),G=ot((r==null?void 0:r.agencyNom)||(r==null?void 0:r.nomAgence),"AGC"),W=((r==null?void 0:r.id)||"000").slice(-3).toUpperCase(),F=`${v}-${G}-WEB-${W}`;return console.warn("[ReceiptModal] referenceCode manquant → fallback utilisé:",F),F},[r==null?void 0:r.referenceCode,r==null?void 0:r.agencyNom,r==null?void 0:r.nomAgence,r==null?void 0:r.id,g==null?void 0:g.nom]),T=l.useMemo(()=>{const v=window.location.origin,G=(r==null?void 0:r.referenceCode)||(r==null?void 0:r.id)||"";return`${v}/r/${encodeURIComponent(G)}`},[r==null?void 0:r.referenceCode,r==null?void 0:r.id]),f=g.couleurPrimaire||"#3b82f6",M=g.couleurSecondaire||"#93c5fd",U=ta(f);l.useEffect(()=>{h&&console.log("[ReceiptModal] open with:",{reservation:r,company:g,receiptNumber:o,qrValue:T})},[h,r,g,o,T]),l.useEffect(()=>{var v,G;h&&((G=(v=S.current)==null?void 0:v.scrollTo)==null||G.call(v,{top:0}),k&&setTimeout(()=>window.print(),200))},[h,k]);const $=()=>{if(!S.current)return;const v={margin:2,filename:`recu-${o}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,letterRendering:!0,width:340},jsPDF:{unit:"mm",format:[81,200],orientation:"portrait"}};sa().set(v).from(S.current).save()},c=l.useMemo(()=>lt(r==null?void 0:r.createdAt,"dd/MM/yyyy HH:mm"),[r==null?void 0:r.createdAt]);return h?n("div",{className:"fixed inset-0 z-50","aria-modal":"true",role:"dialog",children:[t("div",{className:"absolute inset-0 bg-black/40",onClick:e}),t("style",{children:`
        @media print {
          body * { visibility: hidden !important; }
          #print-receipt, #print-receipt * { visibility: visible !important; }
          #print-receipt {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            background: white;
            padding: 0;
            margin: 0;
          }
          .no-print { display: none !important; }
        }
        @page { size: A4; margin: 5mm; }
      `}),n("div",{className:"relative mx-auto my-6 w[760px] max-w-[95vw] bg-white rounded-2xl shadow-xl overflow-hidden",children:[n("div",{className:"no-print flex items-center justify-between px-4 py-3 border-b",children:[n("div",{className:"flex items-center gap-3",children:[g.logoUrl?t("img",{src:g.logoUrl,alt:"logo",className:"h-6 w-6 object-contain rounded"}):t("div",{className:"h-6 w-6 rounded bg-gray-200"}),t("div",{className:"font-semibold",children:g.nom})]}),n("div",{className:"flex items-center gap-2",children:[n("button",{onClick:$,className:"px-3 py-2 rounded-lg border flex items-center gap-1",children:[t(Ye,{className:"h-4 w-4"})," PDF"]}),n("button",{onClick:()=>window.print(),className:"px-3 py-2 rounded-lg border flex items-center gap-1",children:[t(Je,{className:"h-4 w-4"})," Imprimer"]}),n("button",{onClick:e,className:"px-3 py-2 rounded-lg border flex items-center gap-1",children:[t(Qe,{className:"h-4 w-4"})," Fermer"]})]})]}),t("div",{id:"print-receipt",className:"p-3",children:n("div",{ref:S,className:"bg-white rounded-lg shadow-sm overflow-hidden",style:{width:"81mm",margin:"0 auto","--primary":f,"--secondary":M,"--text-on-primary":U},children:[n("div",{className:"flex justify-between items-start border-b pb-2 mb-2 px-3",style:{borderColor:rt(f,.3)},children:[n("div",{className:"flex items-center gap-2",children:[g.logoUrl&&t("img",{src:g.logoUrl,alt:g.nom,className:"h-9 w-9 object-contain rounded border",style:{borderColor:f},onError:v=>v.target.src="/default-company.png"}),n("div",{className:"leading-tight",children:[t("h2",{className:"text-sm font-bold",style:{color:f},children:g.nom}),n("p",{className:"text-[11px] text-gray-700 flex items-center gap-1",children:[t(Ie,{className:"h-3 w-3 text-gray-500"}),(r.agencyNom||r.nomAgence||"Agence").trim()]})]})]}),n("div",{className:"text-right leading-tight pr-2",children:[n("p",{className:"text-[11px] font-mono tracking-tight text-gray-700",children:["N° ",o]}),n("p",{className:"text-[10px] text-gray-600",children:["Émis le ",c]}),t("span",{className:"inline-block mt-0.5 px-2 py-0.5 rounded text-[10px] font-medium",style:{backgroundColor:rt(f,.15),color:f},children:(r.statut||"payé").toString().toUpperCase()})]})]}),n("div",{className:"p-2 space-y-2",children:[n("div",{children:[n("div",{className:"flex items-center gap-1 mb-1",children:[t(qt,{className:"h-3 w-3",style:{color:f}}),t("h3",{className:"text-xs font-semibold",style:{color:f},children:"Client"})]}),n("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[n("div",{children:[t("p",{className:"text-[10px] text-gray-600",children:"Nom"}),t("p",{className:"truncate",children:r.nomClient})]}),n("div",{children:[t("p",{className:"text-[10px] text-gray-600",children:"Téléphone"}),t("p",{children:r.telephone})]})]})]}),n("div",{children:[n("div",{className:"flex items-center gap-1 mb-1",children:[t(ct,{className:"h-3 w-3",style:{color:f}}),t("h3",{className:"text-xs font-semibold",style:{color:f},children:"Voyage"})]}),n("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[n("div",{className:"col-span-2",children:[t("p",{className:"text-[10px] text-gray-600",children:"Trajet"}),n("div",{className:"flex items-center gap-1",children:[t("p",{className:"font-medium",children:r.depart}),t(Ht,{className:"h-3 w-3 text-gray-500"}),t("p",{className:"font-medium",children:r.arrivee})]})]}),n("div",{children:[t("p",{className:"text-[10px] text-gray-600",children:"Date"}),t("p",{children:lt(r.date,"dd/MM/yyyy")})]}),n("div",{children:[t("p",{className:"text-[10px] text-gray-600",children:"Heure"}),t("p",{children:r.heure})]}),n("div",{children:[t("p",{className:"text-[10px] text-gray-600",children:"Places"}),n("p",{children:[r.seatsGo,r.seatsReturn?` (+${r.seatsReturn} retour)`:""]})]}),n("div",{children:[t("p",{className:"text-[10px] text-gray-600",children:"Canal"}),t("p",{className:"capitalize",children:ca(r.canal)})]})]})]}),n("div",{children:[n("div",{className:"flex items-center gap-1 mb-1",children:[t(Vt,{className:"h-3 w-3",style:{color:f}}),t("h3",{className:"text-xs font-semibold",style:{color:f},children:"Paiement"})]}),n("div",{className:"grid grid-cols-2 gap-1 text-[11px]",children:[n("div",{children:[t("p",{className:"text-[10px] text-gray-600",children:"Montant"}),n("p",{className:"font-bold",style:{color:f},children:[(C=r.montant)==null?void 0:C.toLocaleString("fr-FR")," FCFA"]})]}),n("div",{children:[t("p",{className:"text-[10px] text-gray-600",children:"Méthode"}),t("p",{className:"capitalize",children:r.paiement})]})]})]}),n("div",{className:"mt-2 p-1 rounded border border-gray-200 flex flex-col items-center",children:[t("h3",{className:"text-xs font-semibold mb-1",style:{color:f},children:"Code d'embarquement"}),t("div",{className:"bg-white p-1 rounded border",style:{borderColor:f},children:t(_t,{value:T,size:60,fgColor:f,level:"H"})}),t("p",{className:"mt-2 text-[10px] text-gray-600 text-center",children:"Validité : 1 mois à compter de la date d’émission."})]}),n("div",{className:"mt-2 pt-2 border-t border-gray-200 text-center",style:{fontSize:"10px",color:"#4b5563"},children:[n("p",{className:"mb-1",children:["Merci d'avoir choisi ",g.nom]}),t("p",{className:"italic mb-1",children:"Présentez-vous 1H avant le départ"}),t("p",{className:"font-medium mb-0.5",children:"Pour plus d'infos, contactez :"}),n("div",{className:"flex justify-center items-center gap-1 text-gray-700",children:[t(zt,{className:"h-3 w-3 text-gray-500"}),t("span",{children:r.agenceTelephone||g.telephone||"—"})]})]})]})]})}),n("div",{className:"no-print px-4 pb-4 flex items-center justify-end gap-2",children:[n("button",{onClick:$,className:"px-3 py-2 rounded-lg border flex items-center gap-1",children:[t(Ye,{className:"h-4 w-4"})," PDF"]}),n("button",{onClick:()=>window.print(),className:"px-3 py-2 rounded-lg border flex items-center gap-1",children:[t(Je,{className:"h-4 w-4"})," Imprimer"]}),n("button",{onClick:e,className:"px-3 py-2 rounded-lg border flex items-center gap-1",children:[t(Qe,{className:"h-4 w-4"})," Fermer"]})]})]})]}):null},it=8,Ce=30,dt="compagnie-par-defaut";async function pa(h){try{if(!h)return null;const e=await Ae(O(D,"users",h));if(!e.exists())return null;const r=e.data();return r.staffCode||r.codeCourt||r.code||null}catch{return null}}async function ha(h){const{companyId:e,companyCode:r="COMP",agencyCode:g="AGC",tripInstanceId:k,sellerCode:S}=h,o=O(D,`companies/${e}/counters/byTrip/trips/${k}`),T=await ea(D,async f=>{const M=await f.get(o),$=(M.exists()&&M.data().lastSeq||0)+1;return M.exists()?f.update(o,{lastSeq:$,updatedAt:ue.now()}):f.set(o,{lastSeq:$,updatedAt:ue.now()}),$}).catch(async()=>(await mt(o,{lastSeq:1,updatedAt:ue.now()},{merge:!0}),1));return`${r}-${g}-${S}-${String(T).padStart(3,"0")}`}function ga(h,e){if(h===void 0)return{bg:"bg-gray-100",text:"text-gray-600",label:"Calcul…"};if(h<=0)return{bg:"bg-red-100",text:"text-red-700",label:"Complet"};const r=h/Math.max(1,e)*100,g=`${h} place${h>1?"s":""} restantes`;return r>60?{bg:"bg-green-100",text:"text-green-700",label:g}:r>30?{bg:"bg-amber-100",text:"text-amber-700",label:g}:{bg:"bg-red-100",text:"text-red-700",label:g}}const ua=({open:h,onClose:e,initial:r,onSave:g,isSaving:k})=>{const[S,o]=l.useState((r==null?void 0:r.nomClient)||""),[T,f]=l.useState((r==null?void 0:r.telephone)||""),[M,U]=l.useState((r==null?void 0:r.seatsGo)??1),[$,c]=l.useState((r==null?void 0:r.seatsReturn)??0),[C,v]=l.useState((r==null?void 0:r.montant)??0),[G,W]=l.useState("");return l.useEffect(()=>{r&&(o(r.nomClient||""),f(r.telephone||""),U(r.seatsGo??1),c(r.seatsReturn??0),v(r.montant??0),W(""))},[r]),!h||!r?null:t("div",{className:"fixed inset-0 z-50 grid place-items-center bg-black/30 p-4",children:n("div",{className:"w-full max-w-md rounded-2xl bg-white border shadow-lg p-5",children:[t("div",{className:"text-lg font-semibold mb-3",children:"Modifier la réservation"}),n("div",{className:"space-y-3",children:[t("input",{className:"w-full border rounded-lg px-3 py-2",placeholder:"Nom du client",value:S,onChange:F=>o(F.target.value)}),t("input",{className:"w-full border rounded-lg px-3 py-2",placeholder:"Téléphone",value:T,onChange:F=>f(F.target.value)}),n("div",{className:"grid grid-cols-2 gap-2",children:[n("div",{children:[t("div",{className:"text-sm mb-1",children:"Places (Aller)"}),n("div",{className:"flex items-center gap-2",children:[t("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50",onClick:()=>U(Math.max(1,M-1)),children:"-"}),t("div",{className:"flex-1 text-center font-semibold py-2 rounded bg-gray-50",children:M}),t("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50",onClick:()=>U(M+1),children:"+"})]})]}),n("div",{children:[t("div",{className:"text-sm mb-1",children:"Places (Retour)"}),n("div",{className:"flex items-center gap-2",children:[t("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50",onClick:()=>c(Math.max(0,$-1)),children:"-"}),t("div",{className:"flex-1 text-center font-semibold py-2 rounded bg-gray-50",children:$}),t("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50",onClick:()=>c($+1),children:"+"})]})]})]}),n("div",{children:[t("div",{className:"text-sm mb-1",children:"Montant (FCFA)"}),t("input",{type:"number",className:"w-full border rounded-lg px-3 py-2",value:C,onChange:F=>v(Math.max(0,Number(F.target.value||0)))})]}),t("input",{className:"w-full border rounded-lg px-3 py-2",placeholder:"Motif de modification (optionnel)",value:G,onChange:F=>W(F.target.value)})]}),n("div",{className:"mt-5 flex items-center justify-end gap-2",children:[t("button",{className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",onClick:e,children:"Annuler"}),t("button",{disabled:k||!S,className:"px-4 py-2 rounded-lg text-white disabled:opacity-50",style:{background:"linear-gradient(90deg, #2563EB, #1D4ED8)"},onClick:()=>g({id:r.id,nomClient:S,telephone:T,seatsGo:M,seatsReturn:$,montant:C,editReason:G||void 0}),children:k?"Enregistrement…":"Enregistrer"})]})]})})},Aa=()=>{const h=aa(),{user:e,company:r,signOutSafe:g}=h??{},k=l.useCallback(async()=>{try{if(typeof g=="function"){await g();return}if(typeof(h==null?void 0:h.logout)=="function"){await h.logout();return}window.location.href="/logout"}catch(a){console.error("logout error",a),window.location.href="/login"}},[g,h]),S=ra(),{activeShift:o,startShift:T,pauseShift:f,continueShift:M,closeShift:U,refresh:$}=S,c=na(r)||{primary:"#EA580C",secondary:"#F97316"},[C,v]=l.useState("guichet"),[G,W]=l.useState(null),[F,pt]=l.useState("Compagnie"),[ht,gt]=l.useState("Agence"),[xa,ut]=l.useState(""),[ne,xt]=l.useState(""),[X,yt]=l.useState(""),[bt,le]=l.useState(""),[ke,ft]=l.useState([]),[Nt,oe]=l.useState([]),[Se,ie]=l.useState([]),[b,K]=l.useState(null),[Z,Re]=l.useState(""),[q,De]=l.useState(""),[L,xe]=l.useState("aller_simple"),[H,ye]=l.useState(1),[Y,de]=l.useState(0),[$e,Fe]=l.useState(!1),[re,se]=l.useState([]),[wt,Ee]=l.useState(!1),[Te,Me]=l.useState([]),[vt,Ge]=l.useState(!1),[Le,je]=l.useState([]),[Ct,Pe]=l.useState(!1),[Ue,qe]=l.useState(!1),[He,It]=l.useState(null),[Ve,At]=l.useState(null),[be,kt]=l.useState((e==null?void 0:e.staffCode)||(e==null?void 0:e.codeCourt)||(e==null?void 0:e.code)||"GUEST"),ce=(e==null?void 0:e.staffCode)||(e==null?void 0:e.codeCourt)||(e==null?void 0:e.code)||"GUEST",N=(o==null?void 0:o.status)??"none",me=N==="active"&&!!(e!=null&&e.companyId)&&!!(e!=null&&e.agencyId),V=l.useRef(),[St,fe]=l.useState(!1),[Rt,Ne]=l.useState(null),[Dt,_e]=l.useState(!1),[ze,Be]=l.useState(null),[j,$t]=l.useState({name:"Compagnie",code:"COMP",slug:dt,logo:null,phone:""}),[_,Ft]=l.useState({name:"Agence",code:"AGC",phone:""}),[pe,Et]=l.useState("GUEST"),Tt=l.useMemo(()=>Array.from({length:it},(a,d)=>{const m=new Date;return m.setDate(m.getDate()+d),m.toISOString().split("T")[0]}),[]),he=l.useCallback((a,d)=>{const[m,p]=d.split(":").map(Number),i=new Date(a);return i.setHours(m,p,0,0),i.getTime()<Date.now()},[]);l.useEffect(()=>{(async()=>{try{if(e!=null&&e.uid){const s=await pa(e.uid);s&&(Et(s),kt(s))}if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const a=await Ae(O(D,"companies",e.companyId));if(a.exists()){const s=a.data(),x=s.nom||s.name||"Compagnie";W(s.logoUrl||s.logo||null),pt(x),ut(s.telephone||""),$t({name:x,code:st(x,s.code),slug:s.slug||dt,logo:s.logoUrl||s.logo||null,phone:s.telephone||""})}const d=await Ae(O(D,`companies/${e.companyId}/agences/${e.agencyId}`));if(d.exists()){const s=d.data(),x=(s==null?void 0:s.ville)||(s==null?void 0:s.city)||(s==null?void 0:s.nomVille)||(s==null?void 0:s.villeDepart)||"";xt((x||"").toString()),gt((s==null?void 0:s.nomAgence)||(s==null?void 0:s.nom)||x||"Agence"),Ft({name:(s==null?void 0:s.nomAgence)||(s==null?void 0:s.nom)||x||"Agence",code:st((s==null?void 0:s.nomAgence)||(s==null?void 0:s.nom)||x,s==null?void 0:s.code),phone:(s==null?void 0:s.telephone)||""})}const m=z(D,`companies/${e.companyId}/agences/${e.agencyId}/weeklyTrips`),p=await ae(B(m,R("active","==",!0))),i=Array.from(new Set(p.docs.map(s=>s.data().arrival).filter(Boolean))).sort((s,x)=>s.localeCompare(x,"fr"));ft(i)}catch(a){console.error("[GUICHET] init:error",a)}})()},[e==null?void 0:e.uid,e==null?void 0:e.companyId,e==null?void 0:e.agencyId]);const J=l.useCallback(async(a,d,m,p,i=!1)=>{try{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;V.current&&(V.current(),V.current=void 0);const s=z(D,`companies/${e.companyId}/agences/${e.agencyId}/reservations`),x=B(s,R("date","==",a),R("depart","==",d),R("arrivee","==",m)),u=Jt(x,w=>{const y={};w.forEach(E=>{const ee=E.data();if(String(ee.statut||"").toLowerCase()!=="payé")return;const A=ee.trajetId,I=Number(ee.seatsGo||0);y[A]=(y[A]||0)+I}),oe(E=>{const te=(p??E).map(I=>{if(I.date!==a)return I;const P=I.places||Ce,ge=y[I.id]||0;return{...I,remainingSeats:Math.max(0,P-ge)}}),A=te.filter(I=>I.date===a&&!he(I.date,I.time)).sort((I,P)=>I.time.localeCompare(P.time));if(ie(A),i&&A.length>0){const I=A.find(P=>{const ge=P.remainingSeats;return ge===void 0?!0:ge>0})||A[0];K(P=>P??I)}return te})},w=>{console.error("[GUICHET] loadRemainingForDate:snapshot:error",w)});V.current=u}catch(s){console.error("[GUICHET] loadRemainingForDate:error",s)}},[he,e==null?void 0:e.companyId,e==null?void 0:e.agencyId]),Oe=l.useCallback(async(a,d)=>{var m;try{if(oe([]),ie([]),K(null),le(""),!a||!d||!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const p=z(D,`companies/${e.companyId}/agences/${e.agencyId}/weeklyTrips`),i=(await ae(B(p,R("active","==",!0)))).docs.map(y=>({id:y.id,...y.data()})),s=[],x=new Date;for(let y=0;y<it;y++){const E=new Date(x);E.setDate(x.getDate()+y);const ee=E.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase(),te=E.toISOString().split("T")[0];i.forEach(A=>{var I;A.active&&(A.departure||"").toLowerCase().trim()===a.toLowerCase().trim()&&(A.arrival||"").toLowerCase().trim()===d.toLowerCase().trim()&&(((I=A.horaires)==null?void 0:I[ee])||[]).forEach(P=>{s.push({id:`${A.id}_${te}_${P}`,date:te,time:P,departure:A.departure,arrival:A.arrival,price:A.price,places:A.places||Ce})})})}s.sort((y,E)=>y.date.localeCompare(E.date)||y.time.localeCompare(E.time));const u=s.filter(y=>!he(y.date,y.time));oe(u);const w=((m=u[0])==null?void 0:m.date)||"";le(w),K(null),w?await J(w,a,d,u,!0):ie([])}catch(p){console.error("[GUICHET] searchTrips:error",p)}},[he,e==null?void 0:e.agencyId,e==null?void 0:e.companyId,J]);l.useEffect(()=>{if(!X){oe([]),ie([]),K(null),le("");return}Oe(ne,X)},[X,ne,Oe]);const Mt=l.useCallback(async a=>{le(a),K(null),await J(a,ne,X,void 0,!0)},[X,ne,J]);l.useEffect(()=>()=>{V.current&&(V.current(),V.current=void 0)},[]);const Q=l.useMemo(()=>{if(!b)return 0;const a=b.price,d=L==="aller_retour"?H+Y:H;return Math.max(0,a*Math.max(0,d))},[b,L,H,Y]),we=a=>/\d{7,}/.test((a||"").replace(/\D/g,"")),Gt=l.useCallback(async()=>{if(!(!b||!Z||!q)){if(!me){alert("Démarrez/activez votre poste.");return}if(!we(q)){alert("Téléphone invalide.");return}if(b.remainingSeats!==void 0){const a=L==="aller_retour"?H+Y:H;if(a>b.remainingSeats){alert(`Il reste ${b.remainingSeats} places.`);return}if(a<=0){alert("Nombre de places invalide.");return}}if(Q<=0){alert("Montant invalide.");return}Fe(!0);try{const a=await ha({companyId:e.companyId,companyCode:j.code,agencyId:e.agencyId,agencyCode:_.code,tripInstanceId:b.id,sellerCode:pe||ce}),d=z(D,`companies/${e.companyId}/agences/${e.agencyId}/reservations`),m=O(d),p=m.id,i={trajetId:b.id,date:b.date,heure:b.time,depart:b.departure,arrivee:b.arrival,nomClient:Z,telephone:q,email:null,seatsGo:H,seatsReturn:L==="aller_retour"?Y:0,montant:Q,statut:"payé",statutEmbarquement:"en_attente",checkInTime:null,reportInfo:null,compagnieId:e.companyId,agencyId:e.agencyId,companySlug:j.slug,compagnieNom:j.name,agencyNom:_.name,agencyTelephone:_.phone,canal:"guichet",paiement:"espèces",paiementSource:"encaisse_guichet",guichetierId:e.uid,guichetierCode:pe||ce,shiftId:(o==null?void 0:o.id)||null,referenceCode:a,qrCode:p,tripType:L,createdAt:ue.now()};await mt(m,i),It({id:p,nomClient:Z,telephone:q,date:i.date,heure:i.heure,depart:i.depart,arrivee:i.arrivee,seatsGo:i.seatsGo,seatsReturn:i.seatsReturn,montant:i.montant,statut:i.statut,paiement:i.paiement,compagnieId:e.companyId,compagnieNom:j.name,agencyId:e.agencyId,agencyNom:_.name,nomAgence:_.name,agenceTelephone:_.phone,canal:"guichet",createdAt:new Date,companySlug:j.slug,referenceCode:a,qrCode:p,guichetierId:e.uid,guichetierCode:pe||ce,shiftId:(o==null?void 0:o.id)||null,email:void 0}),At({nom:j.name,logoUrl:j.logo||void 0,couleurPrimaire:c.primary,couleurSecondaire:c.secondary,slug:j.slug,telephone:j.phone||void 0}),qe(!0),Re(""),De(""),xe("aller_simple"),ye(1),de(0),await J(b.date,b.departure,b.arrival)}catch(a){console.error("[GUICHET] reservation:error",a),alert("Erreur lors de la réservation.")}finally{Fe(!1)}}},[b,Z,q,me,we,L,H,Y,Q,e,o,j,_,pe,ce,c,J]),Lt=l.useCallback(async a=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;if(a.canal&&a.canal!=="guichet"){alert("Annulation autorisée ici uniquement pour les ventes guichet.");return}if(a.statutEmbarquement==="embarqué"){alert("Impossible d'annuler : passager déjà embarqué.");return}const d=prompt("Motif d'annulation (optionnel) :")||void 0;if(window.confirm("Confirmer l'annulation de cette réservation ?"))try{Be(a.id);const m=O(D,`companies/${e.companyId}/agences/${e.agencyId}/reservations/${a.id}`);await tt(m,{statut:"annulé",updatedAt:at(),cancelReason:d||null,canceledBy:{id:e.uid,name:e.displayName||e.email||null}}),se(p=>p.map(i=>i.id===a.id?{...i,montant:0}:i))}catch(m){console.error("[GUICHET] cancelReservation:error",m),alert("Échec de l'annulation.")}finally{Be(null)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId]),jt=l.useCallback(a=>{Ne({id:a.id,nomClient:a.nomClient,telephone:a.telephone,seatsGo:a.seatsGo??1,seatsReturn:a.seatsReturn??0,montant:a.montant??0}),fe(!0)},[]),Pt=l.useCallback(async a=>{if(!(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)))try{_e(!0);const d=O(D,`companies/${e.companyId}/agences/${e.agencyId}/reservations/${a.id}`);await tt(d,{nomClient:a.nomClient,telephone:a.telephone||null,seatsGo:Math.max(1,a.seatsGo||1),seatsReturn:Math.max(0,a.seatsReturn||0),montant:Math.max(0,a.montant||0),updatedAt:at(),editedBy:{id:e.uid,name:e.displayName||e.email||null,reason:a.editReason||null}}),se(m=>m.map(p=>p.id===a.id?{...p,nomClient:a.nomClient,telephone:a.telephone,seatsGo:Math.max(1,a.seatsGo||1),seatsReturn:Math.max(0,a.seatsReturn||0),montant:Math.max(0,a.montant||0)}:p)),fe(!1),Ne(null)}catch(d){console.error("[GUICHET] saveEditedReservation:error",d),alert("Échec de la modification.")}finally{_e(!1)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,e==null?void 0:e.uid]),We=l.useCallback(async()=>{try{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!(o!=null&&o.id)){se([]);return}Ee(!0);const a=z(D,`companies/${e.companyId}/agences/${e.agencyId}/reservations`),m=(await ae(B(a,R("shiftId","==",o.id),R("canal","==","guichet"),nt("createdAt","asc")))).docs.map(p=>{const i=p.data();return{id:p.id,referenceCode:i.referenceCode,date:i.date,heure:i.heure,depart:i.depart,arrivee:i.arrivee,nomClient:i.nomClient,telephone:i.telephone,seatsGo:i.seatsGo||1,seatsReturn:i.seatsReturn||0,montant:i.montant||0,paiement:i.paiement,createdAt:i.createdAt,guichetierCode:i.guichetierCode||"",canal:i.canal,statutEmbarquement:i.statutEmbarquement}});se(m)}catch(a){console.error("[GUICHET] loadReport:error",a)}finally{Ee(!1)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,o==null?void 0:o.id]),Xe=l.useMemo(()=>{const a={billets:0,montant:0};for(const d of re){const m=(d.seatsGo||0)+(d.seatsReturn||0);a.billets+=m,a.montant+=d.montant||0}return a},[re]),Ut=l.useMemo(()=>{var i,s,x,u,w,y;const a=((s=(i=o==null?void 0:o.startAt)==null?void 0:i.toDate)==null?void 0:s.call(i))||((u=(x=o==null?void 0:o.startTime)==null?void 0:x.toDate)==null?void 0:u.call(x)),d=((y=(w=o==null?void 0:o.endAt)==null?void 0:w.toDate)==null?void 0:y.call(w))||new Date;if(!a)return new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"});const m=a.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}),p=d.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"});return m===p?m:`du ${m} au ${p}`},[o==null?void 0:o.startAt,o==null?void 0:o.startTime,o==null?void 0:o.endAt]),Ke=l.useCallback(async()=>{try{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!(e!=null&&e.uid)){Me([]);return}Ge(!0);const a=`companies/${e.companyId}/agences/${e.agencyId}`,d=z(D,`${a}/shiftReports`),m=await ae(B(d,R("userId","==",e.uid),R("accountantValidated","==",!1))),p=await ae(B(d,R("userId","==",e.uid),R("accountantValidated","==",!0),R("managerValidated","==",!1))),i=[...m.docs,...p.docs].reduce((s,x)=>{const u=x.data();return s.push({shiftId:x.id,companyId:u.companyId,agencyId:u.agencyId,userId:u.userId,userName:u.userName,userCode:u.userCode,startAt:u.startAt,endAt:u.endAt,billets:u.billets||0,montant:u.montant||0,details:Array.isArray(u.details)?u.details:[],accountantValidated:!!u.accountantValidated,managerValidated:!!u.managerValidated,createdAt:u.createdAt,updatedAt:u.updatedAt}),s},[]).sort((s,x)=>{var u,w,y,E;return(((w=(u=x.endAt)==null?void 0:u.toMillis)==null?void 0:w.call(u))??0)-(((E=(y=s.endAt)==null?void 0:y.toMillis)==null?void 0:E.call(y))??0)});Me(i)}catch(a){console.error("[GUICHET] loadPendingReports:error",a)}finally{Ge(!1)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,e==null?void 0:e.uid]),Ze=l.useCallback(async()=>{try{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!(e!=null&&e.uid)){je([]);return}Pe(!0);const a=`companies/${e.companyId}/agences/${e.agencyId}`,d=z(D,`${a}/shiftReports`),p=(await ae(B(d,R("userId","==",e.uid),R("accountantValidated","==",!0),R("managerValidated","==",!0),nt("endAt","desc"),Qt(50)))).docs.map(i=>{const s=i.data();return{shiftId:i.id,companyId:s.companyId,agencyId:s.agencyId,userId:s.userId,userName:s.userName,userCode:s.userCode,startAt:s.startAt,endAt:s.endAt,billets:s.billets||0,montant:s.montant||0,details:Array.isArray(s.details)?s.details:[],accountantValidated:!!s.accountantValidated,managerValidated:!!s.managerValidated,createdAt:s.createdAt,updatedAt:s.updatedAt}});je(p)}catch(a){console.error("[GUICHET] loadHistory:error",a)}finally{Pe(!1)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,e==null?void 0:e.uid]);return l.useEffect(()=>{C==="rapport"&&(o!=null&&o.id&&(N==="active"||N==="paused"||N==="pending")?We():se([]),Ke())},[C,We,Ke,o==null?void 0:o.id,N]),l.useEffect(()=>{C==="historique"&&Ze()},[C,Ze]),n("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100",children:[t("style",{children:`
        @media print {
          body * { visibility: hidden !important; }
          #report-print, #report-print * { visibility: visible !important; }
          #report-print { position: absolute; left: 0; top: 0; width: 100%; }
          .no-print { display: none !important; }
        }
        @page { size: auto; margin: 10mm; }
      `}),t("div",{className:"sticky top-0 z-10 border-b bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70",children:t("div",{className:"max-w-7xl mx-auto px-4 py-3",children:n("div",{className:"flex flex-wrap items-center gap-3",children:[n("div",{className:"flex items-center gap-3 min-w-0",children:[G?t("img",{src:G,alt:"logo",className:"h-10 w-10 rounded object-contain border flex-shrink-0"}):t("div",{className:"h-10 w-10 rounded bg-gray-200 grid place-items-center flex-shrink-0",children:t(Bt,{className:"h-5 w-5 text-gray-500"})}),n("div",{className:"min-w-0",children:[t("div",{className:"text-lg font-bold truncate",style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},title:F,children:F}),n("div",{className:"text-xs text-gray-500 flex items-center gap-1 truncate",children:[t(Ie,{className:"h-3.5 w-3.5 flex-shrink-0"}),t("span",{className:"truncate",children:ht})]})]})]}),t("div",{className:"order-3 md:order-none w-full md:w-auto",children:n("div",{className:"inline-flex rounded-xl p-1 bg-gray-100 shadow-inner w-full md:w-auto",children:[t("button",{type:"button",className:`px-4 py-2 rounded-lg text-sm font-medium transition ${C==="guichet"?"text-white":"hover:bg-white"}`,onClick:()=>v("guichet"),style:C==="guichet"?{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`}:{},children:"Guichet"}),t("button",{type:"button",className:`px-4 py-2 rounded-lg text-sm font-medium transition ${C==="rapport"?"text-white":"hover:bg-white"}`,onClick:()=>v("rapport"),style:C==="rapport"?{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`}:{},children:"Rapport"}),t("button",{type:"button",className:`px-4 py-2 rounded-lg text-sm font-medium transition ${C==="historique"?"text-white":"hover:bg-white"}`,onClick:()=>v("historique"),style:C==="historique"?{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`}:{color:c.primary},children:"Historique"})]})}),n("div",{className:"ml-auto flex items-center gap-3 flex-wrap",children:[t("div",{className:"px-3 py-1 rounded-lg text-xs font-medium transition-colors",style:{backgroundColor:N==="active"?"#DCFCE7":N==="paused"?"#FEF3C7":N==="pending"?"#E0E7FF":"#F3F4F6",color:N==="active"?"#15803D":N==="paused"?"#92400E":N==="pending"?"#1D4ED8":"#374151"},title:N==="pending"?"En attente d’activation par la comptabilité":void 0,children:N==="active"?"En service":N==="paused"?"En pause":N==="pending"?"En attente d’activation":"Hors service"}),N==="active"&&n(ve,{children:[t("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-gray-50 transition",onClick:()=>f().catch(a=>alert((a==null?void 0:a.message)||"Erreur")),children:"Pause"}),t("button",{className:"px-3 py-2 rounded-lg text-white text-sm shadow-sm hover:shadow transition",style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`},onClick:()=>{window.confirm("Clôturer ce poste ? Vous ne pourrez plus vendre après clôture.")&&(U().catch(a=>alert((a==null?void 0:a.message)||"Erreur")),v("rapport"))},children:"Clôturer"})]}),N==="paused"&&n(ve,{children:[t("button",{className:"px-3 py-2 rounded-lg text-white text-sm shadow-sm hover:shadow transition",style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`},onClick:()=>M().catch(a=>alert((a==null?void 0:a.message)||"Erreur")),children:"Continuer"}),t("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-gray-50 transition",onClick:()=>{window.confirm("Clôturer ce poste ?")&&(U().catch(a=>alert((a==null?void 0:a.message)||"Erreur")),v("rapport"))},children:"Clôturer"})]}),N==="pending"&&n("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-gray-50 transition",onClick:()=>$().catch(()=>{}),children:[t(Ot,{className:"h-4 w-4 inline mr-1"})," Actualiser"]}),N==="none"&&t("button",{className:"px-3 py-2 rounded-lg text-white text-sm shadow-sm hover:shadow transition",style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`},onClick:()=>T().catch(a=>alert((a==null?void 0:a.message)||"Erreur")),children:"Demander l’activation"}),t("div",{className:"h-6 w-px bg-gray-200"}),n("div",{className:"hidden sm:flex items-center gap-3 rounded-xl border bg-white px-3 py-2 max-w-[280px]",children:[t("div",{className:"h-8 w-8 rounded-full bg-gray-100 grid place-items-center",children:t(Wt,{className:"h-4 w-4 text-gray-500"})}),n("div",{className:"leading-tight min-w-0",children:[t("div",{className:"text-sm font-medium truncate",children:((e==null?void 0:e.displayName)||(e==null?void 0:e.email))??"—"}),n("div",{className:"text-xs text-gray-500 truncate",children:[(e==null?void 0:e.role)||"guichetier"," • ",be]})]}),n("button",{className:"ml-1 px-2.5 py-1.5 rounded-lg border text-xs bg-white hover:bg-gray-50 inline-flex items-center gap-1",onClick:k,title:"Se déconnecter",children:[t(et,{className:"h-4 w-4"}),"Quitter"]})]})]})]})})}),C==="rapport"&&n("div",{id:"report-print",className:"max-w-7xl mx-auto px-4 py-6 space-y-6",children:[t("div",{className:"bg-white rounded-2xl border shadow-sm p-4",children:n("div",{className:"flex items-center justify-between",children:[t("div",{className:"text-2xl font-bold",style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:"Rapport"}),t("div",{className:"text-sm text-gray-600",children:Ut})]})}),(N==="active"||N==="paused"||N==="pending")&&n("div",{className:"space-y-3",children:[n("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[n("div",{className:"rounded-xl border p-4 bg-white shadow-sm hover:shadow transition",children:[t("div",{className:"text-sm text-gray-500",children:"Billets"}),t("div",{className:"text-2xl font-bold",children:Xe.billets})]}),n("div",{className:"rounded-xl border p-4 bg-white shadow-sm hover:shadow transition",children:[t("div",{className:"text-sm text-gray-500",children:"Montant"}),n("div",{className:"text-2xl font-bold",children:[Xe.montant.toLocaleString("fr-FR")," FCFA"]})]}),n("div",{className:"rounded-xl border p-4 bg-white shadow-sm hover:shadow transition",children:[t("div",{className:"text-sm text-gray-500",children:"Réservations"}),t("div",{className:"text-2xl font-bold",children:re.length})]})]}),n("div",{className:"rounded-xl border bg-white p-4 shadow-sm hover:shadow transition",children:[t("div",{className:"font-semibold mb-3",children:"Ventes du poste en cours (canal: guichet, paiement: espèces)"}),wt?t("div",{className:"text-gray-500",children:"Chargement…"}):re.length?t("div",{className:"overflow-hidden rounded-lg border",children:n("table",{className:"w-full text-sm",children:[t("thead",{className:"bg-gray-50",children:n("tr",{children:[t("th",{className:"px-3 py-2 text-left",children:"Date"}),t("th",{className:"px-3 py-2 text-left",children:"Heure"}),t("th",{className:"px-3 py-2 text-left",children:"Trajet"}),t("th",{className:"px-3 py-2 text-left",children:"Client"}),t("th",{className:"px-3 py-2 text-left",children:"Tél."}),t("th",{className:"px-3 py-2 text-right",children:"Billets"}),t("th",{className:"px-3 py-2 text-right",children:"Montant"}),t("th",{className:"px-3 py-2 text-right",children:"Réf."}),t("th",{className:"px-3 py-2 text-right",children:"Actions"})]})}),t("tbody",{children:re.map(a=>n("tr",{className:"border-t",children:[t("td",{className:"px-3 py-2",children:a.date}),t("td",{className:"px-3 py-2",children:a.heure}),n("td",{className:"px-3 py-2",children:[a.depart," → ",a.arrivee]}),t("td",{className:"px-3 py-2",children:a.nomClient}),t("td",{className:"px-3 py-2",children:a.telephone||""}),t("td",{className:"px-3 py-2 text-right",children:(a.seatsGo||0)+(a.seatsReturn||0)}),n("td",{className:"px-3 py-2 text-right",children:[a.montant.toLocaleString("fr-FR")," FCFA"]}),t("td",{className:"px-3 py-2 text-right text-xs text-gray-500",children:a.referenceCode||a.id}),t("td",{className:"px-3 py-2",children:n("div",{className:"flex items-center justify-end gap-2",children:[n("button",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs text-white",style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`},title:"Modifier (nom, tél., places, montant)",onClick:()=>jt(a),children:[t(Xt,{className:"h-3.5 w-3.5"})," Modifier"]}),n("button",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-md border text-xs hover:bg-red-50",style:{borderColor:"#FCA5A5",color:"#B91C1C"},title:"Annuler la réservation",onClick:()=>Lt(a),disabled:ze===a.id,children:[t(Kt,{className:"h-3.5 w-3.5"})," ",ze===a.id?"Annulation…":"Annuler"]})]})})]},a.id))})]})}):t("div",{className:"text-gray-500",children:"Aucune vente pour ce poste pour le moment."})]})]}),n("div",{className:"rounded-2xl border bg-white p-4 shadow-sm hover:shadow transition",children:[t("div",{className:"font-semibold mb-2",children:"Mes sessions en attente de validation"}),vt?t("div",{className:"text-gray-500",children:"Chargement…"}):Te.length===0?t("div",{className:"text-gray-500",children:"Aucune session en attente."}):t("div",{className:"space-y-3",children:Te.map(a=>{var p,i,s,x,u;const d=(i=(p=a.startAt)==null?void 0:p.toDate)!=null&&i.call(p)?a.startAt.toDate():new Date,m=(x=(s=a.endAt)==null?void 0:s.toDate)!=null&&x.call(s)?a.endAt.toDate():new Date;return n("div",{className:"border rounded-xl p-4 hover:shadow-sm transition",children:[n("div",{className:"flex items-center justify-between",children:[n("div",{children:[n("div",{className:"font-semibold",children:["Session #",a.shiftId.slice(0,6)," — ",a.userName||"Guichetier"," (",a.userCode||"—",")"]}),n("div",{className:"text-xs text-gray-500",children:["Début: ",d.toLocaleString("fr-FR")," — Fin: ",m.toLocaleString("fr-FR")]})]}),n("div",{className:"flex items-center gap-2",children:[n("span",{className:`px-2 py-1 rounded text-xs ${a.accountantValidated?"bg-green-100 text-green-700":"bg-amber-100 text-amber-700"}`,children:["Comptable ",a.accountantValidated?"OK":"en attente"]}),n("span",{className:`px-2 py-1 rounded text-xs ${a.managerValidated?"bg-green-100 text-green-700":"bg-amber-100 text-amber-700"}`,children:["Chef ",a.managerValidated?"OK":"en attente"]})]})]}),!!((u=a.details)!=null&&u.length)&&t("div",{className:"mt-3 overflow-hidden rounded border",children:n("table",{className:"w-full text-sm",children:[t("thead",{className:"bg-gray-50",children:n("tr",{children:[t("th",{className:"px-3 py-2 text-left",children:"Trajet"}),t("th",{className:"px-3 py-2 text-left",children:"Heures"}),t("th",{className:"px-3 py-2 text-right",children:"Billets"}),t("th",{className:"px-3 py-2 text-right",children:"Montant"})]})}),t("tbody",{children:a.details.map((w,y)=>n("tr",{className:"border-t",children:[t("td",{className:"px-3 py-2",children:w.trajet}),t("td",{className:"px-3 py-2 text-xs text-gray-600",children:(w.heures||[]).join(", ")}),t("td",{className:"px-3 py-2 text-right",children:w.billets}),n("td",{className:"px-3 py-2 text-right",children:[w.montant.toLocaleString("fr-FR")," FCFA"]})]},y))})]})})]},a.shiftId)})})]})]}),C==="historique"&&n("div",{className:"max-w-7xl mx-auto px-4 py-6 space-y-6",children:[n("div",{className:"bg-white rounded-2xl border shadow-sm p-4",children:[t("div",{className:"text-lg font-semibold",children:"Historique de mes sessions (validées)"}),n("div",{className:"text-sm text-gray-500",children:["Guichetier : ",((e==null?void 0:e.displayName)||(e==null?void 0:e.email))??"—"," (",be,")"]})]}),t("div",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:Ct?t("div",{className:"text-gray-500",children:"Chargement…"}):Le.length===0?t("div",{className:"text-gray-500",children:"Aucune session validée trouvée."}):t("div",{className:"space-y-3",children:Le.map(a=>{var p,i,s,x,u;const d=(i=(p=a.startAt)==null?void 0:p.toDate)!=null&&i.call(p)?a.startAt.toDate():new Date,m=(x=(s=a.endAt)==null?void 0:s.toDate)!=null&&x.call(s)?a.endAt.toDate():new Date;return n("div",{className:"border rounded-xl p-4 hover:shadow-sm transition",children:[n("div",{className:"flex items-center justify-between",children:[n("div",{children:[n("div",{className:"font-semibold",children:["Session #",a.shiftId.slice(0,6)," — ",a.userName||"Guichetier"," (",a.userCode||"—",")"]}),n("div",{className:"text-xs text-gray-500",children:["Début: ",d.toLocaleString("fr-FR")," — Fin: ",m.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})," ",m.toLocaleTimeString("fr-FR")]})]}),n("div",{className:"flex items-center gap-2",children:[t("span",{className:"px-2 py-1 rounded text-xs bg-green-100 text-green-700",children:"Comptable OK"}),t("span",{className:"px-2 py-1 rounded text-xs bg-green-100 text-green-700",children:"Chef OK"})]})]}),!!((u=a.details)!=null&&u.length)&&t("div",{className:"mt-3 overflow-hidden rounded border",children:n("table",{className:"w-full text-sm",children:[t("thead",{className:"bg-gray-50",children:n("tr",{children:[t("th",{className:"px-3 py-2 text-left",children:"Trajet"}),t("th",{className:"px-3 py-2 text-left",children:"Heures"}),t("th",{className:"px-3 py-2 text-right",children:"Billets"}),t("th",{className:"px-3 py-2 text-right",children:"Montant"})]})}),t("tbody",{children:a.details.map((w,y)=>n("tr",{className:"border-t",children:[t("td",{className:"px-3 py-2",children:w.trajet}),t("td",{className:"px-3 py-2 text-xs text-gray-600",children:(w.heures||[]).join(", ")}),t("td",{className:"px-3 py-2 text-right",children:w.billets}),n("td",{className:"px-3 py-2 text-right",children:[w.montant.toLocaleString("fr-FR")," FCFA"]})]},y))})]})}),t("div",{className:"no-print mt-3 flex items-center justify-end",children:t("button",{className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",onClick:()=>window.print(),title:"Imprimer le rapport",children:"🖨️ Imprimer"})})]},a.shiftId)})})})]}),C==="guichet"&&n("div",{className:"max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6",children:[n("div",{className:"lg:col-span-2 space-y-6",children:[n("div",{className:"rounded-2xl border shadow-sm p-6 bg-white hover:shadow transition",children:[n("div",{className:"mb-4",children:[t("h1",{className:"text-2xl font-bold",children:"Guichet de vente"}),n("p",{className:"text-gray-500 text-sm flex items-center gap-2",children:[t(Ie,{className:"h-4 w-4"}),t("span",{children:"Départ :"}),t("span",{className:"font-medium",children:ne||"—"})]})]}),N==="pending"&&n("div",{className:"mb-4 p-3 rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-800 text-sm",children:["Demande envoyée. En attente d’activation par la comptabilité. Cliquez sur ",t("b",{children:"Actualiser"})," dans l’entête pour vérifier."]}),N==="none"&&n("div",{className:"mb-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-sm",children:["Cliquez sur ",t("b",{children:"Demander l’activation"})," (en haut) pour créer votre poste."]}),t("div",{className:"mb-2 text-sm text-gray-600",children:"Choisissez une ville d'arrivée :"}),n("div",{className:"flex flex-wrap gap-2",children:[ke.length===0&&t("span",{className:"text-gray-400 text-sm",children:"Aucune destination configurée."}),ke.map(a=>{const d=X.toLowerCase()===a.toLowerCase();return t("button",{onClick:()=>yt(a),className:`px-3 py-2 rounded-full text-sm border transition ${d?"text-white":"text-gray-700 hover:bg-gray-50"}`,style:d?{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`,borderColor:"transparent"}:{borderColor:"#E5E7EB",backgroundColor:"white"},children:a},a)})]})]}),n("div",{className:"rounded-2xl border shadow-sm p-6 bg-white hover:shadow transition",children:[n("h3",{className:"font-semibold mb-3 flex items-center gap-2",children:[t(Zt,{className:"h-5 w-5"}),t("span",{children:"Dates disponibles"})]}),t("div",{className:"flex flex-wrap gap-2",children:Tt.map(a=>{const d=Nt.some(i=>i.date===a),m=bt===a,p=new Date(a);return n("button",{disabled:!d,onClick:()=>d&&Mt(a),className:`w-16 h-16 rounded-xl border text-center transition ${m?"text-white":""} ${d?"hover:shadow-sm":"opacity-40 cursor-not-allowed"}`,style:m?{background:c.primary,borderColor:c.primary}:{background:"white",borderColor:"#E5E7EB"},children:[t("div",{className:"text-xs",children:p.toLocaleDateString("fr-FR",{weekday:"short"})}),t("div",{className:"text-lg font-bold",children:p.getDate()})]},a)})})]}),n("div",{className:"rounded-2xl border shadow-sm p-6 bg-white hover:shadow transition",children:[n("h3",{className:"font-semibold mb-2 flex items-center gap-2",children:[t(Yt,{className:"h-5 w-5"}),t("span",{children:"Horaires disponibles"})]}),Se.length===0?t("div",{className:"text-gray-400 text-sm",children:"Aucun horaire pour cette date."}):t("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-2 gap-2",children:Se.map(a=>{const d=(b==null?void 0:b.id)===a.id,m=ga(a.remainingSeats,a.places||Ce);return t("button",{onClick:()=>K(a),className:`text-left px-4 py-3 rounded-xl border transition ${d?"shadow ring-1":"hover:shadow-sm"}`,style:d?{borderColor:c.primary,backgroundColor:"#F5F7FF"}:{borderColor:"#E5E7EB",backgroundColor:"white"},children:n("div",{className:"flex items-start justify-between gap-3",children:[n("div",{children:[n("div",{className:"font-semibold",children:[t("span",{className:"text-base mr-2",style:{color:c.primary},children:a.time}),a.departure," → ",a.arrival]}),t("div",{className:"text-xs text-gray-500",children:new Date(a.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})})]}),n("div",{className:"text-right",children:[n("div",{className:"font-bold",style:{color:c.primary},children:[a.price.toLocaleString("fr-FR")," FCFA"]}),t("div",{className:`inline-flex mt-1 px-2 py-0.5 rounded-full text-[11px] ${m.bg} ${m.text}`,children:m.label})]})]})},a.id)})})]})]}),n("div",{className:"bg-white rounded-2xl shadow-sm border h-max sticky top-24 p-6 transition duration-200 ease-out hover:shadow",children:[t("h3",{className:"text-xl font-bold mb-4",style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:"Détails de la réservation"}),!me&&t("div",{className:"mb-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-sm",children:N==="pending"?"Votre poste est en attente d’activation par la comptabilité.":"Demandez l’activation de votre poste, puis démarrez la vente (espèces uniquement)."}),b?n("div",{className:"mb-4 p-4 rounded-xl border",style:{borderColor:c.primary,backgroundColor:"#F8FAFF"},children:[n("div",{className:"flex items-start justify-between gap-3",children:[n("div",{children:[n("div",{className:"font-semibold",children:[b.departure," → ",b.arrival]}),t("div",{className:"text-sm text-gray-500",children:new Date(b.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})})]}),t("div",{className:"px-2 py-1 rounded-md bg-white shadow text-sm",style:{color:c.primary},children:b.time})]}),n("div",{className:"mt-2 text-sm",children:["Prix unitaire : ",n("span",{className:"font-semibold",children:[b.price.toLocaleString("fr-FR")," FCFA"]})]})]}):t("div",{className:"mb-4 p-4 rounded-xl border border-dashed text-gray-500 text-sm",children:"Sélectionnez un horaire pour continuer."}),n("div",{className:"mb-3 inline-flex bg-gray-100 p-1 rounded-xl w-full shadow-inner",children:[t("button",{type:"button",className:`flex-1 py-2 rounded-lg text-sm transition ${L==="aller_simple"?"text-white":"hover:bg-white"}`,onClick:()=>{xe("aller_simple"),de(0)},style:L==="aller_simple"?{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`}:{},children:"Aller simple"}),t("button",{type:"button",className:`flex-1 py-2 rounded-lg text-sm transition ${L==="aller_retour"?"text-white":"hover:bg-white"}`,onClick:()=>xe("aller_retour"),style:L==="aller_retour"?{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`}:{},children:"Aller-retour"})]}),n("div",{className:"space-y-3",children:[t("input",{className:"w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-200",placeholder:"Nom complet du passager",value:Z,onChange:a=>Re(a.target.value)}),t("input",{className:"w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-200",placeholder:"Téléphone",value:q,onChange:a=>De(a.target.value)})]}),n("div",{className:"mt-4 space-y-3",children:[n("div",{children:[t("div",{className:"text-sm mb-1",children:"Nombre de places (Aller)"}),n("div",{className:"flex items-center gap-2",children:[t("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50 transition",onClick:()=>ye(a=>Math.max(1,a-1)),children:"-"}),t("div",{className:"flex-1 text-center font-bold py-2 rounded bg-gray-50",children:H}),t("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50 transition",onClick:()=>ye(a=>a+1),children:"+"})]})]}),L==="aller_retour"&&n("div",{children:[t("div",{className:"text-sm mb-1",children:"Nombre de places (Retour)"}),n("div",{className:"flex items-center gap-2",children:[t("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50 transition",onClick:()=>de(a=>Math.max(0,a-1)),children:"-"}),t("div",{className:"flex-1 text-center font-bold py-2 rounded bg-gray-50",children:Y}),t("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50 transition",onClick:()=>de(a=>a+1),children:"+"})]})]})]}),n("div",{className:"mt-4 p-4 rounded-xl bg-gray-50 flex items-center justify-between",children:[t("div",{className:"text-sm text-gray-600",children:"Total à payer (ESPÈCES)"}),n("div",{className:"text-2xl font-bold",style:{color:c.primary},children:[Q.toLocaleString("fr-FR")," FCFA"]})]})]})]}),t("div",{className:"sticky bottom-0 z-10",children:t("div",{className:"max-w-7xl mx-auto px-4 pb-4",children:n("div",{className:"bg-white/95 backdrop-blur rounded-2xl border shadow-md p-3 flex items-center justify-between",children:[n("div",{className:"flex items-center gap-3",children:[t("div",{className:"h-10 w-10 rounded-full bg-gradient-to-br from-gray-200 to-gray-100 grid place-items-center border",children:t(ct,{className:"h-5 w-5 text-gray-500"})}),n("div",{className:"leading-tight",children:[n("div",{className:"text-sm font-semibold",children:[((e==null?void 0:e.displayName)||(e==null?void 0:e.email))??"—"," ",n("span",{className:"text-gray-500",children:["(",be,")"]})]}),t("div",{className:"text-xs text-gray-500",children:(e==null?void 0:e.role)||"guichetier"})]})]}),n("div",{className:"flex items-center gap-3",children:[n("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-gray-50 transition hidden sm:inline-flex items-center gap-2",onClick:k,title:"Se déconnecter",children:[t(et,{className:"h-4 w-4"}),"Déconnexion"]}),C==="guichet"&&n(ve,{children:[t("div",{className:"text-sm text-gray-600",children:"Total:"}),n("div",{className:"text-xl font-extrabold",style:{color:c.primary},children:[Q.toLocaleString("fr-FR")," FCFA"]}),t("button",{className:"px-5 py-3 rounded-xl text-white font-bold disabled:opacity-50 shadow-sm hover:shadow transition",disabled:!me||!b||!Z||!q||!we(q)||Q<=0||$e,style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`},onClick:Gt,title:"Valider la réservation",children:$e?"Traitement…":"Valider la réservation"})]})]})]})})}),t(ua,{open:St,onClose:()=>{fe(!1),Ne(null)},initial:Rt,onSave:Pt,isSaving:Dt}),Ue&&He&&Ve&&t(ma,{open:Ue,onClose:()=>qe(!1),reservation:He,company:Ve})]})};export{Aa as default};
