import{r as s,a as n,j as a,J as jt,M as rt,F as V,a0 as Pt,bg as Ht,_ as st,bh as Vt,X as Bt,l as zt,bi as Ot,bj as Wt,T as Yt}from"./react-KXT1Riez.js";import{q as ke,o as O,t as B,u as Q,r as z,w as R,E as Ee,D as Kt,T as he,v as ct,y as ot,x as Ie,J as Qt,H as Xt}from"./firebase-DYTOaTLw.js";import{u as Jt,c as Zt,d as w}from"../index-b0dmvJTQ.js";import{u as ea}from"./useActiveShift-D7kMrDfh.js";import{R as ta}from"./ReceiptModal-kieGttHh.js";import"./vendor-B27hBV_J.js";import"./ticketMessages-B5n9y2Of.js";import"./jspdf.es.min-CKqfBJjn.js";import"./html2canvas-iRN4OxZ6.js";function aa(f){return(f||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9 ]/g," ").trim().replace(/\s+/g,"-").toUpperCase()}function lt(f,e,u=5){const v=(e||"").toUpperCase().replace(/[^A-Z0-9]/g,"");if(v)return v.slice(0,u);const C=(f||"").trim();if(!C)return"ORG";const I=C.split(/\s+/).filter(Boolean);if(I.length>=2){const c=I.slice(0,3).map(q=>q[0]||"").join("");if(c)return c.toUpperCase().slice(0,u)}return aa(C).replace(/-/g,"").slice(0,Math.max(3,u))}const ge={PAYE:"pay√©",ANNULE:"annul√©",EN_ATTENTE:"en_attente",REPORTE:"report√©",CONFIRME:"confirme"},M={EN_ATTENTE:"en_attente",EMBARQUE:"embarqu√©",ANNULE:"annul√©",NO_SHOW:"no_show"},na={ESPECES:"esp√®ces",MOBILE_MONEY:"mobile_money",CARTE:"carte",VIREMENT:"virement"},Se={GUICHET:"guichet",WEB:"web",MOBILE:"mobile",AGENCE:"agence"},it=8,re=30,dt="compagnie-par-defaut";function Re({totalSeats:f,trajetId:e,reservations:u}){const v=u.filter(C=>C.trajetId===e&&[ge.PAYE,ge.CONFIRME].includes(String(C.statut).toLowerCase())).reduce((C,I)=>C+(I.seatsGo||0),0);return Math.max(0,f-v)}async function ra(f){try{if(!f)return null;const e=await ke(O(w,"users",f));if(!e.exists())return null;const u=e.data();return u.staffCode||u.codeCourt||u.code||null}catch{return null}}async function sa(f){const{companyId:e,companyCode:u="COMP",agencyCode:v="AGC",tripInstanceId:C,sellerCode:I}=f,c=O(w,`companies/${e}/counters/byTrip/trips/${C}`),q=await Xt(w,async _=>{const $=await _.get(c),T=($.exists()&&$.data().lastSeq||0)+1;return $.exists()?_.update(c,{lastSeq:T,updatedAt:he.now()}):_.set(c,{lastSeq:T,updatedAt:he.now()}),T}).catch(async()=>(await ct(c,{lastSeq:1,updatedAt:he.now()},{merge:!0}),1));return`${u}-${v}-${I}-${String(q).padStart(3,"0")}`}function oa(f,e){if(f===void 0)return{bg:"bg-gray-100",text:"text-gray-600",label:"Calcul‚Ä¶"};if(f<=0)return{bg:"bg-red-100",text:"text-red-700",label:"Complet"};const u=f/Math.max(1,e)*100,v=`${f} place${f>1?"s":""} restantes`;return u>60?{bg:"bg-green-100",text:"text-green-700",label:v}:u>30?{bg:"bg-amber-100",text:"text-amber-700",label:v}:{bg:"bg-red-100",text:"text-red-700",label:v}}const la=({open:f,onClose:e,initial:u,onSave:v,isSaving:C})=>{const[I,c]=s.useState((u==null?void 0:u.nomClient)||""),[q,_]=s.useState((u==null?void 0:u.telephone)||""),[$,H]=s.useState((u==null?void 0:u.seatsGo)??1),[T,m]=s.useState((u==null?void 0:u.seatsReturn)??0),[N,j]=s.useState((u==null?void 0:u.montant)??0),[X,se]=s.useState("");return s.useEffect(()=>{u&&(c(u.nomClient||""),_(u.telephone||""),H(u.seatsGo??1),m(u.seatsReturn??0),j(u.montant??0),se(""))},[u]),!f||!u?null:a("div",{className:"fixed inset-0 z-50 grid place-items-center bg-black/30 p-4",children:n("div",{className:"w-full max-w-md rounded-2xl bg-white border shadow-lg p-5",children:[a("div",{className:"text-lg font-semibold mb-3",children:"Modifier la r√©servation"}),n("div",{className:"space-y-3",children:[a("input",{className:"w-full border rounded-lg px-3 py-2",placeholder:"Nom du client",value:I,onChange:F=>c(F.target.value)}),a("input",{className:"w-full border rounded-lg px-3 py-2",placeholder:"T√©l√©phone",value:q,onChange:F=>_(F.target.value)}),n("div",{className:"grid grid-cols-2 gap-2",children:[n("div",{children:[a("div",{className:"text-sm mb-1",children:"Places (Aller)"}),n("div",{className:"flex items-center gap-2",children:[a("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50",onClick:()=>H(Math.max(1,$-1)),children:"-"}),a("div",{className:"flex-1 text-center font-semibold py-2 rounded bg-gray-50",children:$}),a("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50",onClick:()=>H($+1),children:"+"})]})]}),n("div",{children:[a("div",{className:"text-sm mb-1",children:"Places (Retour)"}),n("div",{className:"flex items-center gap-2",children:[a("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50",onClick:()=>m(Math.max(0,T-1)),children:"-"}),a("div",{className:"flex-1 text-center font-semibold py-2 rounded bg-gray-50",children:T}),a("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50",onClick:()=>m(T+1),children:"+"})]})]})]}),n("div",{children:[a("div",{className:"text-sm mb-1",children:"Montant (FCFA)"}),a("input",{type:"number",className:"w-full border rounded-lg px-3 py-2",value:N,onChange:F=>j(Math.max(0,Number(F.target.value||0)))})]}),a("input",{className:"w-full border rounded-lg px-3 py-2",placeholder:"Motif de modification (optionnel)",value:X,onChange:F=>se(F.target.value)})]}),n("div",{className:"mt-5 flex items-center justify-end gap-2",children:[a("button",{className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",onClick:e,children:"Annuler"}),a("button",{disabled:C||!I,className:"px-4 py-2 rounded-lg text-white disabled:opacity-50",style:{background:"linear-gradient(90deg, #2563EB, #1D4ED8)"},onClick:()=>v({id:u.id,nomClient:I,telephone:q,seatsGo:$,seatsReturn:T,montant:N,editReason:X||void 0}),children:C?"Enregistrement‚Ä¶":"Enregistrer"})]})]})})},xa=()=>{const f=Jt(),{user:e,company:u,signOutSafe:v}=f??{},C=s.useCallback(async()=>{try{if(typeof v=="function"){await v();return}if(typeof(f==null?void 0:f.logout)=="function"){await f.logout();return}window.location.href="/logout"}catch(t){console.error("logout error",t),window.location.href="/login"}},[v,f]),I=ea(),{activeShift:c,startShift:q,pauseShift:_,continueShift:$,closeShift:H,refresh:T}=I,m=Zt(u)||{primary:"#EA580C",secondary:"#F97316"},[N,j]=s.useState("guichet"),[X,se]=s.useState(null),[F,mt]=s.useState("Compagnie"),[pt,ut]=s.useState("Agence"),[ia,ht]=s.useState(""),[J,gt]=s.useState(""),[W,yt]=s.useState(""),[bt,oe]=s.useState(""),[$e,xt]=s.useState([]),[Te,Z]=s.useState([]),[Fe,le]=s.useState([]),[y,Y]=s.useState(null),[L,De]=s.useState(""),[D,Me]=s.useState(""),[A,ye]=s.useState("aller_simple"),[E,be]=s.useState(1),[G,ie]=s.useState(0),[xe,Le]=s.useState(!1),[ee,te]=s.useState([]),[ft,Ge]=s.useState(!1),[Ue,qe]=s.useState([]),[Nt,_e]=s.useState(!1),[je,Pe]=s.useState([]),[vt,He]=s.useState(!1),[Ve,Be]=s.useState(!1),[ze,Ct]=s.useState(null),[Oe,wt]=s.useState(null),[fe,At]=s.useState((e==null?void 0:e.staffCode)||(e==null?void 0:e.codeCourt)||(e==null?void 0:e.code)||"GUEST"),Ne=(e==null?void 0:e.staffCode)||(e==null?void 0:e.codeCourt)||(e==null?void 0:e.code)||"GUEST",x=(c==null?void 0:c.status)??"none",ae=x==="active"&&!!(e!=null&&e.companyId)&&!!(e!=null&&e.agencyId),[We,Ye]=s.useState("");s.useRef();const[de,Et]=s.useState([]),[It,ve]=s.useState(!1),[St,Ce]=s.useState(null),[Rt,Ke]=s.useState(!1),[Qe,Xe]=s.useState(null),[P,kt]=s.useState({name:"Compagnie",code:"COMP",slug:dt,logo:null,phone:""}),[K,$t]=s.useState({name:"Agence",code:"AGC",phone:""}),[ne,Tt]=s.useState("GUEST"),Ft=s.useMemo(()=>Array.from({length:it},(t,o)=>{const d=new Date;return d.setDate(d.getDate()+o),d.toISOString().split("T")[0]}),[]),ce=s.useCallback((t,o)=>{const[d,p]=o.split(":").map(Number),l=new Date(t);return l.setHours(d,p,0,0),l.getTime()<Date.now()},[]);s.useEffect(()=>{(async()=>{try{if(e!=null&&e.uid){const r=await ra(e.uid);r&&(Tt(r),At(r))}if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const t=await ke(O(w,"companies",e.companyId));if(t.exists()){const r=t.data(),i=r.nom||r.name||"Compagnie";se(r.logoUrl||r.logo||null),mt(i),ht(r.telephone||""),kt({name:i,code:lt(i,r.code),slug:r.slug||dt,logo:r.logoUrl||r.logo||null,phone:r.telephone||""})}const o=await ke(O(w,`companies/${e.companyId}/agences/${e.agencyId}`));if(o.exists()){const r=o.data(),i=(r==null?void 0:r.ville)||(r==null?void 0:r.city)||(r==null?void 0:r.nomVille)||(r==null?void 0:r.villeDepart)||"";gt((i||"").toString()),ut((r==null?void 0:r.nomAgence)||(r==null?void 0:r.nom)||i||"Agence"),$t({name:(r==null?void 0:r.nomAgence)||(r==null?void 0:r.nom)||i||"Agence",code:lt((r==null?void 0:r.nomAgence)||(r==null?void 0:r.nom)||i,r==null?void 0:r.code),phone:(r==null?void 0:r.telephone)||""})}const d=B(w,`companies/${e.companyId}/agences/${e.agencyId}/weeklyTrips`),p=await Q(z(d,R("active","==",!0))),l=Array.from(new Set(p.docs.map(r=>r.data().arrival).filter(Boolean))).sort((r,i)=>r.localeCompare(i,"fr"));xt(l)}catch(t){console.error("[GUICHET] init:error",t)}})()},[e==null?void 0:e.uid,e==null?void 0:e.companyId,e==null?void 0:e.agencyId]),s.useEffect(()=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const t=B(w,`companies/${e.companyId}/agences/${e.agencyId}/reservations`),o=z(t,Ee("createdAt","asc")),d=Kt(o,p=>{const l=p.docs.map(r=>{const i=r.data();return{id:r.id,referenceCode:i.referenceCode,date:i.date,heure:i.heure,depart:i.depart,arrivee:i.arrivee,nomClient:i.nomClient,telephone:i.telephone,seatsGo:i.seatsGo||1,seatsReturn:i.seatsReturn||0,montant:i.montant||0,paiement:i.paiement,createdAt:i.createdAt,guichetierCode:i.guichetierCode||"",canal:i.canal,statutEmbarquement:i.statutEmbarquement,statut:i.statut,trajetId:i.trajetId}});Et(l),Z(r=>r.map(i=>{const h=Re({totalSeats:i.places||re,trajetId:i.id,reservations:l});return{...i,remainingSeats:h}}))},p=>{console.error("[GUICHET] allReservations listener error",p)});return()=>d()},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId]);const me=s.useCallback(async(t,o,d,p,l=!1)=>{try{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const i=(p??Te).map(g=>{if(g.date!==t)return g;const b=Re({totalSeats:g.places||re,trajetId:g.id,reservations:de});return{...g,remainingSeats:b}}),h=i.filter(g=>g.date===t&&!ce(g.date,g.time)).sort((g,b)=>g.time.localeCompare(b.time));if(le(h),l&&h.length>0){const g=h.find(b=>{const S=b.remainingSeats;return S===void 0?!0:S>0})||h[0];Y(b=>b??g)}Z(i)}catch(r){console.error("[GUICHET] loadRemainingForDate:error",r)}},[ce,e==null?void 0:e.companyId,e==null?void 0:e.agencyId,de]),Je=s.useCallback(async(t,o)=>{var d;try{if(Z([]),le([]),Y(null),oe(""),!t||!o||!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const p=B(w,`companies/${e.companyId}/agences/${e.agencyId}/weeklyTrips`),l=(await Q(z(p,R("active","==",!0)))).docs.map(b=>({id:b.id,...b.data()})),r=[],i=new Date;for(let b=0;b<it;b++){const S=new Date(i);S.setDate(i.getDate()+b);const _t=S.toLocaleDateString("fr-FR",{weekday:"long"}).toLowerCase(),we=S.toISOString().split("T")[0];l.forEach(k=>{var nt;k.active&&(k.departure||"").toLowerCase().trim()===t.toLowerCase().trim()&&(k.arrival||"").toLowerCase().trim()===o.toLowerCase().trim()&&(((nt=k.horaires)==null?void 0:nt[_t])||[]).forEach(Ae=>{r.push({id:`${k.id}_${we}_${Ae}`,date:we,time:Ae,departure:k.departure,arrival:k.arrival,price:k.price,places:k.places||re,remainingSeats:Re({totalSeats:k.places||re,trajetId:`${k.id}_${we}_${Ae}`,reservations:de})})})})}r.sort((b,S)=>b.date.localeCompare(S.date)||b.time.localeCompare(S.time));const h=r.filter(b=>!ce(b.date,b.time));Z(h);const g=((d=h[0])==null?void 0:d.date)||"";oe(g),Y(null),g?await me(g,t,o,h,!0):le([])}catch(p){console.error("[GUICHET] searchTrips:error",p)}},[ce,e==null?void 0:e.agencyId,e==null?void 0:e.companyId,me,de]);s.useEffect(()=>{if(!W){Z([]),le([]),Y(null),oe("");return}Je(J,W)},[W,J,Je]);const Dt=s.useCallback(async t=>{oe(t),Y(null),await me(t,J,W,void 0,!0)},[W,J,me]),U=s.useMemo(()=>{if(!y)return 0;const t=y.price,o=A==="aller_retour"?E+G:E;return Math.max(0,t*Math.max(0,o))},[y,A,E,G]),pe=t=>/\d{7,}/.test((t||"").replace(/\D/g,"")),ue=s.useMemo(()=>{if(!ae||!y||y.remainingSeats!==void 0&&y.remainingSeats<=0)return!1;const t=A==="aller_retour"?E+G:E;return!(t<=0||y.remainingSeats!==void 0&&t>y.remainingSeats||!L.trim()||!pe(D)||U<=0||xe)},[ae,y,A,E,G,L,D,U,xe]),Mt=s.useCallback(async()=>{if(!(!y||!L||!D)){if(!ae){alert("D√©marrez/activez votre poste.");return}if(!pe(D)){alert("T√©l√©phone invalide.");return}if(y.remainingSeats!==void 0){const t=A==="aller_retour"?E+G:E;if(t>y.remainingSeats){alert(`Il reste ${y.remainingSeats} places.`);return}if(t<=0){alert("Nombre de places invalide.");return}}if(U<=0){alert("Montant invalide.");return}Le(!0);try{const t=await sa({companyId:e.companyId,companyCode:P.code,agencyId:e.agencyId,agencyCode:K.code,tripInstanceId:y.id,sellerCode:ne||Ne}),o=B(w,`companies/${e.companyId}/agences/${e.agencyId}/reservations`),d=O(o),p=d.id,l={trajetId:y.id,date:y.date,heure:y.time,depart:y.departure,arrivee:y.arrival,nomClient:L,telephone:D,email:null,seatsGo:E,seatsReturn:A==="aller_retour"?G:0,montant:U,statut:ge.PAYE,statutEmbarquement:M.EN_ATTENTE,checkInTime:null,reportInfo:null,compagnieId:e.companyId,agencyId:e.agencyId,companySlug:P.slug,compagnieNom:P.name,agencyNom:K.name,agencyTelephone:K.phone,canal:Se.GUICHET,paiement:na.ESPECES,paiementSource:"encaisse_guichet",guichetierId:e.uid,guichetierCode:ne||Ne,shiftId:(c==null?void 0:c.id)||null,referenceCode:t,qrCode:p,tripType:A,createdAt:he.now()};await ct(d,l),Ct({id:p,nomClient:L,telephone:D,date:l.date,heure:l.heure,depart:l.depart,arrivee:l.arrivee,seatsGo:l.seatsGo,seatsReturn:l.seatsReturn,montant:l.montant,statut:l.statut,paiement:l.paiement,agencyNom:K.name,agenceTelephone:K.phone,createdAt:new Date,referenceCode:t}),wt({nom:P.name,logoUrl:P.logo||void 0,couleurPrimaire:m.primary,couleurSecondaire:m.secondary,slug:P.slug,telephone:P.phone||void 0}),Be(!0),Ye(`‚úÖ R√©servation confirm√©e pour ${L} ‚Ä¢ ${E+(G||0)} place(s) ‚Ä¢ ${U.toLocaleString("fr-FR")} FCFA`),setTimeout(()=>Ye(""),4e3),De(""),Me(""),ye("aller_simple"),be(1),ie(0)}catch(t){console.error("[GUICHET] reservation:error",t),alert("Erreur lors de la r√©servation.")}finally{Le(!1)}}},[y,L,D,ae,pe,A,E,G,U,e,c,P,K,ne,Ne,m]),Lt=s.useCallback(async t=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;if(t.canal&&t.canal!==Se.GUICHET){alert("Annulation autoris√©e uniquement pour les ventes guichet.");return}if(t.statutEmbarquement===M.EMBARQUE){alert("Impossible d'annuler : passager d√©j√† embarqu√©.");return}if(t.statutEmbarquement===M.ANNULE||t.montant===0){alert("Cette r√©servation est d√©j√† annul√©e.");return}const o=prompt("Motif d'annulation (obligatoire, min. 5 caract√®res) :")||"";if(!o.trim()||o.length<5){alert("Veuillez indiquer un motif d'annulation (min. 5 caract√®res).");return}if(window.confirm(`Confirmer l'annulation pour ${t.nomClient} (${t.montant.toLocaleString("fr-FR")} FCFA) ?`))try{Xe(t.id);const d=O(w,`companies/${e.companyId}/agences/${e.agencyId}/reservations/${t.id}`);await ot(d,{statut:ge.ANNULE,statutEmbarquement:M.ANNULE,montantOriginal:t.montant,montant:0,updatedAt:Ie(),cancelReason:o.trim(),canceledBy:{id:e.uid,name:e.displayName||e.email||null,code:ne,timestamp:Ie()}}),te(p=>p.map(l=>l.id===t.id?{...l,montant:0,statutEmbarquement:M.ANNULE}:l)),alert(`‚úÖ Annulation enregistr√©e pour ${t.nomClient}`)}catch(d){console.error("[GUICHET] cancelReservation:error",d),alert("√âchec de l'annulation. Veuillez r√©essayer.")}finally{Xe(null)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,ne]),Gt=s.useCallback(t=>{if(t.statutEmbarquement===M.EMBARQUE){alert("üö´ Modification impossible : le passager est d√©j√† embarqu√©.");return}if(t.statutEmbarquement===M.ANNULE||t.montant===0){alert("Cette r√©servation est d√©j√† annul√©e.");return}Ce({id:t.id,nomClient:t.nomClient,telephone:t.telephone,seatsGo:t.seatsGo??1,seatsReturn:t.seatsReturn??0,montant:t.montant??0}),ve(!0)},[]),Ut=s.useCallback(async t=>{if(!(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)))try{Ke(!0);const o=O(w,`companies/${e.companyId}/agences/${e.agencyId}/reservations/${t.id}`);await ot(o,{nomClient:t.nomClient,telephone:t.telephone||null,seatsGo:Math.max(1,t.seatsGo||1),seatsReturn:Math.max(0,t.seatsReturn||0),montant:Math.max(0,t.montant||0),updatedAt:Ie(),editedBy:{id:e.uid,name:e.displayName||e.email||null,reason:t.editReason||null}}),te(d=>d.map(p=>p.id===t.id?{...p,nomClient:t.nomClient,telephone:t.telephone,seatsGo:Math.max(1,t.seatsGo||1),seatsReturn:Math.max(0,t.seatsReturn||0),montant:Math.max(0,t.montant||0)}:p)),ve(!1),Ce(null)}catch(o){console.error("[GUICHET] saveEditedReservation:error",o),alert("√âchec de la modification.")}finally{Ke(!1)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,e==null?void 0:e.uid]),Ze=s.useCallback(async()=>{try{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!(c!=null&&c.id)){te([]);return}Ge(!0);const t=B(w,`companies/${e.companyId}/agences/${e.agencyId}/reservations`),d=(await Q(z(t,R("shiftId","==",c.id),R("canal","==",Se.GUICHET),Ee("createdAt","asc")))).docs.map(p=>{const l=p.data();return{id:p.id,referenceCode:l.referenceCode,date:l.date,heure:l.heure,depart:l.depart,arrivee:l.arrivee,nomClient:l.nomClient,telephone:l.telephone,seatsGo:l.seatsGo||1,seatsReturn:l.seatsReturn||0,montant:l.montant||0,paiement:l.paiement,createdAt:l.createdAt,guichetierCode:l.guichetierCode||"",canal:l.canal,statutEmbarquement:l.statutEmbarquement}});te(d)}catch(t){console.error("[GUICHET] loadReport:error",t)}finally{Ge(!1)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,c==null?void 0:c.id]),et=s.useMemo(()=>{const t={billets:0,montant:0};for(const o of ee){if(o.statutEmbarquement===M.ANNULE||o.montant===0)continue;const d=(o.seatsGo||0)+(o.seatsReturn||0);t.billets+=d,t.montant+=o.montant||0}return t},[ee]),qt=s.useMemo(()=>{var l,r,i,h,g,b;const t=((r=(l=c==null?void 0:c.startAt)==null?void 0:l.toDate)==null?void 0:r.call(l))||((h=(i=c==null?void 0:c.startTime)==null?void 0:i.toDate)==null?void 0:h.call(i)),o=((b=(g=c==null?void 0:c.endAt)==null?void 0:g.toDate)==null?void 0:b.call(g))||new Date;if(!t)return new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"});const d=t.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}),p=o.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"});return d===p?d:`du ${d} au ${p}`},[c==null?void 0:c.startAt,c==null?void 0:c.startTime,c==null?void 0:c.endAt]),tt=s.useCallback(async()=>{try{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!(e!=null&&e.uid)){qe([]);return}_e(!0);const t=`companies/${e.companyId}/agences/${e.agencyId}`,o=B(w,`${t}/shiftReports`),d=await Q(z(o,R("userId","==",e.uid),R("accountantValidated","==",!1))),p=await Q(z(o,R("userId","==",e.uid),R("accountantValidated","==",!0),R("managerValidated","==",!1))),l=[...d.docs,...p.docs].reduce((r,i)=>{const h=i.data();return r.push({shiftId:i.id,companyId:h.companyId,agencyId:h.agencyId,userId:h.userId,userName:h.userName,userCode:h.userCode,startAt:h.startAt,endAt:h.endAt,billets:h.billets||0,montant:h.montant||0,details:Array.isArray(h.details)?h.details:[],accountantValidated:!!h.accountantValidated,managerValidated:!!h.managerValidated,createdAt:h.createdAt,updatedAt:h.updatedAt}),r},[]).sort((r,i)=>{var h,g,b,S;return(((g=(h=i.endAt)==null?void 0:h.toMillis)==null?void 0:g.call(h))??0)-(((S=(b=r.endAt)==null?void 0:b.toMillis)==null?void 0:S.call(b))??0)});qe(l)}catch(t){console.error("[GUICHET] loadPendingReports:error",t)}finally{_e(!1)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,e==null?void 0:e.uid]),at=s.useCallback(async()=>{try{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!(e!=null&&e.uid)){Pe([]);return}He(!0);const t=`companies/${e.companyId}/agences/${e.agencyId}`,o=B(w,`${t}/shiftReports`),p=(await Q(z(o,R("userId","==",e.uid),R("accountantValidated","==",!0),R("managerValidated","==",!0),Ee("endAt","desc"),Qt(50)))).docs.map(l=>{const r=l.data();return{shiftId:l.id,companyId:r.companyId,agencyId:r.agencyId,userId:r.userId,userName:r.userName,userCode:r.userCode,startAt:r.startAt,endAt:r.endAt,billets:r.billets||0,montant:r.montant||0,details:Array.isArray(r.details)?r.details:[],accountantValidated:!!r.accountantValidated,managerValidated:!!r.managerValidated,createdAt:r.createdAt,updatedAt:r.updatedAt}});Pe(p)}catch(t){console.error("[GUICHET] loadHistory:error",t)}finally{He(!1)}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,e==null?void 0:e.uid]);return s.useEffect(()=>{N==="rapport"&&(c!=null&&c.id&&(x==="active"||x==="paused"||x==="pending")?Ze():te([]),tt())},[N,Ze,tt,c==null?void 0:c.id,x]),s.useEffect(()=>{N==="historique"&&at()},[N,at]),n("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100",children:[a("style",{children:`
        @media print {
          body * { visibility: hidden !important; }
          #report-print, #report-print * { visibility: visible !important; }
          #report-print { position: absolute; left: 0; top: 0; width: 100%; }
          .no-print { display: none !important; }
        }
        @page { size: auto; margin: 10mm; }
        @keyframes pulse-once {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.8; }
        }
        .animate-pulse-once {
          animation: pulse-once 2s ease-in-out;
        }
        .animate-pulse {
          animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: .5; }
        }
      `}),a("div",{className:"sticky top-0 z-10 border-b bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70",children:a("div",{className:"max-w-7xl mx-auto px-4 py-3",children:n("div",{className:"flex flex-wrap items-center gap-3",children:[n("div",{className:"flex items-center gap-3 min-w-0",children:[X?a("img",{src:X,alt:"logo",className:"h-10 w-10 rounded object-contain border flex-shrink-0"}):a("div",{className:"h-10 w-10 rounded bg-gray-200 grid place-items-center flex-shrink-0",children:a(jt,{className:"h-5 w-5 text-gray-500"})}),n("div",{className:"min-w-0",children:[a("div",{className:"text-lg font-bold truncate",style:{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},title:F,children:F}),n("div",{className:"text-xs text-gray-500 flex items-center gap-1 truncate",children:[a(rt,{className:"h-3.5 w-3.5 flex-shrink-0"}),a("span",{className:"truncate",children:pt})]})]})]}),a("div",{className:"order-3 md:order-none w-full md:w-auto",children:n("div",{className:"inline-flex rounded-xl p-1 bg-gray-100 shadow-inner w-full md:w-auto",children:[a("button",{type:"button",className:`px-4 py-2 rounded-lg text-sm font-medium transition ${N==="guichet"?"text-white":"hover:bg-white"}`,onClick:()=>j("guichet"),style:N==="guichet"?{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`}:{},children:"Guichet"}),a("button",{type:"button",className:`px-4 py-2 rounded-lg text-sm font-medium transition ${N==="rapport"?"text-white":"hover:bg-white"}`,onClick:()=>j("rapport"),style:N==="rapport"?{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`}:{},children:"Rapport"}),a("button",{type:"button",className:`px-4 py-2 rounded-lg text-sm font-medium transition ${N==="historique"?"text-white":"hover:bg-white"}`,onClick:()=>j("historique"),style:N==="historique"?{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`}:{color:m.primary},children:"Historique"})]})}),n("div",{className:"ml-auto flex items-center gap-3 flex-wrap",children:[n("div",{className:"px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-2",style:{backgroundColor:x==="active"?"#DCFCE7":x==="paused"?"#FEF3C7":x==="pending"?"#E0E7FF":"#F3F4F6",color:x==="active"?"#15803D":x==="paused"?"#92400E":x==="pending"?"#1D4ED8":"#374151"},title:x==="pending"?"En attente d'activation par la comptabilit√©":void 0,children:[x==="active"&&n(V,{children:[a("div",{className:"h-2 w-2 rounded-full bg-green-500 animate-pulse"}),a("span",{children:"En service"})]}),x==="paused"&&n(V,{children:[a("div",{className:"h-2 w-2 rounded-full bg-amber-500"}),a("span",{children:"En pause"})]}),x==="pending"&&n(V,{children:[n("svg",{className:"h-3 w-3 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[a("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),a("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),a("span",{children:"En attente d'activation"})]}),x==="none"&&n(V,{children:[a("div",{className:"h-2 w-2 rounded-full bg-gray-500"}),a("span",{children:"Hors service"})]})]}),x==="active"&&n(V,{children:[a("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-gray-50 transition",onClick:()=>_().catch(t=>alert((t==null?void 0:t.message)||"Erreur")),children:"Pause"}),a("button",{className:"px-3 py-2 rounded-lg text-white text-sm shadow-sm hover:shadow transition",style:{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`},onClick:()=>{window.confirm("Cl√¥turer ce poste ? Vous ne pourrez plus vendre apr√®s cl√¥ture.")&&(H().catch(t=>alert((t==null?void 0:t.message)||"Erreur")),j("rapport"))},children:"Cl√¥turer"})]}),x==="paused"&&n(V,{children:[a("button",{className:"px-3 py-2 rounded-lg text-white text-sm shadow-sm hover:shadow transition",style:{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`},onClick:()=>$().catch(t=>alert((t==null?void 0:t.message)||"Erreur")),children:"Continuer"}),a("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-gray-50 transition",onClick:()=>{window.confirm("Cl√¥turer ce poste ?")&&(H().catch(t=>alert((t==null?void 0:t.message)||"Erreur")),j("rapport"))},children:"Cl√¥turer"})]}),x==="pending"&&n("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-gray-50 transition",onClick:()=>T().catch(()=>{}),children:[a(Pt,{className:"h-4 w-4 inline mr-1"})," Actualiser"]}),x==="none"&&a("button",{className:"px-3 py-2 rounded-lg text-white text-sm shadow-sm hover:shadow transition",style:{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`},onClick:()=>q().catch(t=>alert((t==null?void 0:t.message)||"Erreur")),children:"Demander l'activation"}),a("div",{className:"h-6 w-px bg-gray-200"}),n("div",{className:"hidden sm:flex items-center gap-3 rounded-xl border bg-white px-3 py-2 max-w-[280px]",children:[a("div",{className:"h-8 w-8 rounded-full bg-gray-100 grid place-items-center",children:a(Ht,{className:"h-4 w-4 text-gray-500"})}),n("div",{className:"leading-tight min-w-0",children:[a("div",{className:"text-sm font-medium truncate",children:((e==null?void 0:e.displayName)||(e==null?void 0:e.email))??"‚Äî"}),n("div",{className:"text-xs text-gray-500 truncate",children:[(e==null?void 0:e.role)||"guichetier"," ‚Ä¢ ",fe]})]}),n("button",{className:"ml-1 px-2.5 py-1.5 rounded-lg border text-xs bg-white hover:bg-gray-50 inline-flex items-center gap-1",onClick:C,title:"Se d√©connecter",children:[a(st,{className:"h-4 w-4"}),"Quitter"]})]})]})]})})}),N==="rapport"&&n("div",{id:"report-print",className:"max-w-7xl mx-auto px-4 py-6 space-y-6",children:[a("div",{className:"bg-white rounded-2xl border shadow-sm p-4",children:n("div",{className:"flex items-center justify-between",children:[a("div",{className:"text-2xl font-bold",style:{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:"Rapport"}),a("div",{className:"text-sm text-gray-600",children:qt})]})}),(x==="active"||x==="paused"||x==="pending")&&n("div",{className:"space-y-3",children:[n("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[n("div",{className:"rounded-xl border p-4 bg-white shadow-sm hover:shadow transition",children:[a("div",{className:"text-sm text-gray-500",children:"Billets vendus"}),a("div",{className:"text-2xl font-bold",children:et.billets})]}),n("div",{className:"rounded-xl border p-4 bg-white shadow-sm hover:shadow transition",children:[a("div",{className:"text-sm text-gray-500",children:"Montant encaiss√©"}),n("div",{className:"text-2xl font-bold",children:[et.montant.toLocaleString("fr-FR")," FCFA"]})]}),n("div",{className:"rounded-xl border p-4 bg-white shadow-sm hover:shadow transition",children:[a("div",{className:"text-sm text-gray-500",children:"R√©servations"}),a("div",{className:"text-2xl font-bold",children:ee.filter(t=>t.montant>0).length})]})]}),n("div",{className:"rounded-xl border bg-white p-4 shadow-sm hover:shadow transition",children:[a("div",{className:"font-semibold mb-3",children:"Ventes du poste en cours (canal: guichet, paiement: esp√®ces)"}),ft?a("div",{className:"text-gray-500",children:"Chargement‚Ä¶"}):ee.length?a("div",{className:"overflow-hidden rounded-lg border",children:n("table",{className:"w-full text-sm",children:[a("thead",{className:"bg-gray-50",children:n("tr",{children:[a("th",{className:"px-3 py-2 text-left",children:"Date"}),a("th",{className:"px-3 py-2 text-left",children:"Heure"}),a("th",{className:"px-3 py-2 text-left",children:"Trajet"}),a("th",{className:"px-3 py-2 text-left",children:"Client"}),a("th",{className:"px-3 py-2 text-left",children:"T√©l."}),a("th",{className:"px-3 py-2 text-right",children:"Billets"}),a("th",{className:"px-3 py-2 text-right",children:"Montant"}),a("th",{className:"px-3 py-2 text-right",children:"Statut"}),a("th",{className:"px-3 py-2 text-right",children:"R√©f."}),a("th",{className:"px-3 py-2 text-right",children:"Actions"})]})}),a("tbody",{children:ee.map(t=>{const o=t.statutEmbarquement===M.ANNULE||t.montant===0,d=t.statutEmbarquement===M.EMBARQUE;return n("tr",{className:`border-t ${o?"bg-red-50":d?"bg-green-50":""}`,children:[a("td",{className:"px-3 py-2",children:t.date}),a("td",{className:"px-3 py-2",children:t.heure}),n("td",{className:"px-3 py-2",children:[t.depart," ‚Üí ",t.arrivee]}),a("td",{className:"px-3 py-2",children:t.nomClient}),a("td",{className:"px-3 py-2",children:t.telephone||""}),a("td",{className:"px-3 py-2 text-right",children:(t.seatsGo||0)+(t.seatsReturn||0)}),n("td",{className:"px-3 py-2 text-right",children:[o?a("span",{className:"text-gray-400 line-through",children:t.montant.toLocaleString("fr-FR")}):t.montant.toLocaleString("fr-FR")," FCFA"]}),a("td",{className:"px-3 py-2 text-right",children:a("span",{className:`px-2 py-1 rounded text-xs ${o?"bg-red-100 text-red-700":d?"bg-green-100 text-green-700":"bg-blue-100 text-blue-700"}`,children:o?"Annul√©":d?"Embarqu√©":"Actif"})}),a("td",{className:"px-3 py-2 text-right text-xs text-gray-500",children:t.referenceCode||t.id}),a("td",{className:"px-3 py-2",children:n("div",{className:"flex items-center justify-end gap-2",children:[!o&&!d&&n("button",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs text-white",style:{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`},title:"Modifier (nom, t√©l., places, montant)",onClick:()=>Gt(t),children:[a(Vt,{className:"h-3.5 w-3.5"})," Modifier"]}),!o&&!d&&n("button",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-md border text-xs hover:bg-red-50",style:{borderColor:"#FCA5A5",color:"#B91C1C"},title:"Annuler la r√©servation",onClick:()=>Lt(t),disabled:Qe===t.id,children:[a(Bt,{className:"h-3.5 w-3.5"})," ",Qe===t.id?"Annulation‚Ä¶":"Annuler"]}),d&&a("span",{className:"text-xs text-gray-500",children:"Embarqu√©"}),o&&a("span",{className:"text-xs text-gray-500",children:"Annul√©"})]})})]},t.id)})})]})}):a("div",{className:"text-gray-500",children:"Aucune vente pour ce poste pour le moment."})]})]}),n("div",{className:"rounded-2xl border bg-white p-4 shadow-sm hover:shadow transition",children:[a("div",{className:"font-semibold mb-2",children:"Mes sessions en attente de validation"}),Nt?a("div",{className:"text-gray-500",children:"Chargement‚Ä¶"}):Ue.length===0?a("div",{className:"text-gray-500",children:"Aucune session en attente."}):a("div",{className:"space-y-3",children:Ue.map(t=>{var p,l,r,i,h;const o=(l=(p=t.startAt)==null?void 0:p.toDate)!=null&&l.call(p)?t.startAt.toDate():new Date,d=(i=(r=t.endAt)==null?void 0:r.toDate)!=null&&i.call(r)?t.endAt.toDate():new Date;return n("div",{className:"border rounded-xl p-4 hover:shadow-sm transition",children:[n("div",{className:"flex items-center justify-between",children:[n("div",{children:[n("div",{className:"font-semibold",children:["Session #",t.shiftId.slice(0,6)," ‚Äî ",t.userName||"Guichetier"," (",t.userCode||"‚Äî",")"]}),n("div",{className:"text-xs text-gray-500",children:["D√©but: ",o.toLocaleString("fr-FR")," ‚Äî Fin: ",d.toLocaleString("fr-FR")]})]}),n("div",{className:"flex items-center gap-2",children:[n("span",{className:`px-2 py-1 rounded text-xs ${t.accountantValidated?"bg-green-100 text-green-700":"bg-amber-100 text-amber-700"}`,children:["Comptable ",t.accountantValidated?"OK":"en attente"]}),n("span",{className:`px-2 py-1 rounded text-xs ${t.managerValidated?"bg-green-100 text-green-700":"bg-amber-100 text-amber-700"}`,children:["Chef ",t.managerValidated?"OK":"en attente"]})]})]}),!!((h=t.details)!=null&&h.length)&&a("div",{className:"mt-3 overflow-hidden rounded border",children:n("table",{className:"w-full text-sm",children:[a("thead",{className:"bg-gray-50",children:n("tr",{children:[a("th",{className:"px-3 py-2 text-left",children:"Trajet"}),a("th",{className:"px-3 py-2 text-left",children:"Heures"}),a("th",{className:"px-3 py-2 text-right",children:"Billets"}),a("th",{className:"px-3 py-2 text-right",children:"Montant"})]})}),a("tbody",{children:t.details.map((g,b)=>n("tr",{className:"border-t",children:[a("td",{className:"px-3 py-2",children:g.trajet}),a("td",{className:"px-3 py-2 text-xs text-gray-600",children:(g.heures||[]).join(", ")}),a("td",{className:"px-3 py-2 text-right",children:g.billets}),n("td",{className:"px-3 py-2 text-right",children:[g.montant.toLocaleString("fr-FR")," FCFA"]})]},b))})]})})]},t.shiftId)})})]})]}),N==="historique"&&n("div",{className:"max-w-7xl mx-auto px-4 py-6 space-y-6",children:[n("div",{className:"bg-white rounded-2xl border shadow-sm p-4",children:[a("div",{className:"text-lg font-semibold",children:"Historique de mes sessions (valid√©es)"}),n("div",{className:"text-sm text-gray-500",children:["Guichetier : ",((e==null?void 0:e.displayName)||(e==null?void 0:e.email))??"‚Äî"," (",fe,")"]})]}),a("div",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:vt?a("div",{className:"text-gray-500",children:"Chargement‚Ä¶"}):je.length===0?a("div",{className:"text-gray-500",children:"Aucune session valid√©e trouv√©e."}):a("div",{className:"space-y-3",children:je.map(t=>{var p,l,r,i,h;const o=(l=(p=t.startAt)==null?void 0:p.toDate)!=null&&l.call(p)?t.startAt.toDate():new Date,d=(i=(r=t.endAt)==null?void 0:r.toDate)!=null&&i.call(r)?t.endAt.toDate():new Date;return n("div",{className:"border rounded-xl p-4 hover:shadow-sm transition",children:[n("div",{className:"flex items-center justify-between",children:[n("div",{children:[n("div",{className:"font-semibold",children:["Session #",t.shiftId.slice(0,6)," ‚Äî ",t.userName||"Guichetier"," (",t.userCode||"‚Äî",")"]}),n("div",{className:"text-xs text-gray-500",children:["D√©but: ",o.toLocaleString("fr-FR")," ‚Äî Fin: ",d.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})," ",d.toLocaleTimeString("fr-FR")]})]}),n("div",{className:"flex items-center gap-2",children:[a("span",{className:"px-2 py-1 rounded text-xs bg-green-100 text-green-700",children:"Comptable OK"}),a("span",{className:"px-2 py-1 rounded text-xs bg-green-100 text-green-700",children:"Chef OK"})]})]}),!!((h=t.details)!=null&&h.length)&&a("div",{className:"mt-3 overflow-hidden rounded border",children:n("table",{className:"w-full text-sm",children:[a("thead",{className:"bg-gray-50",children:n("tr",{children:[a("th",{className:"px-3 py-2 text-left",children:"Trajet"}),a("th",{className:"px-3 py-2 text-left",children:"Heures"}),a("th",{className:"px-3 py-2 text-right",children:"Billets"}),a("th",{className:"px-3 py-2 text-right",children:"Montant"})]})}),a("tbody",{children:t.details.map((g,b)=>n("tr",{className:"border-t",children:[a("td",{className:"px-3 py-2",children:g.trajet}),a("td",{className:"px-3 py-2 text-xs text-gray-600",children:(g.heures||[]).join(", ")}),a("td",{className:"px-3 py-2 text-right",children:g.billets}),n("td",{className:"px-3 py-2 text-right",children:[g.montant.toLocaleString("fr-FR")," FCFA"]})]},b))})]})}),a("div",{className:"no-print mt-3 flex items-center justify-end",children:a("button",{className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",onClick:()=>window.print(),title:"Imprimer le rapport",children:"üñ®Ô∏è Imprimer"})})]},t.shiftId)})})})]}),N==="guichet"&&n("div",{className:"max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6",children:[n("div",{className:"lg:col-span-2 space-y-6",children:[n("div",{className:"rounded-2xl border shadow-sm p-6 bg-white hover:shadow transition",children:[n("div",{className:"mb-4",children:[a("h1",{className:"text-2xl font-bold",children:"Guichet de vente"}),n("p",{className:"text-gray-500 text-sm flex items-center gap-2",children:[a(rt,{className:"h-4 w-4"}),a("span",{children:"D√©part :"}),a("span",{className:"font-medium",children:J||"‚Äî"})]})]}),We&&a("div",{className:"mb-4 p-3 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-800 animate-pulse-once text-sm",children:n("div",{className:"flex items-center gap-2",children:[a(zt,{className:"h-4 w-4"}),a("span",{children:We})]})}),x==="pending"&&n("div",{className:"mb-4 p-3 rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-800 text-sm",children:["Demande envoy√©e. En attente d'activation par la comptabilit√©. Cliquez sur ",a("b",{children:"Actualiser"})," dans l'ent√™te pour v√©rifier."]}),x==="none"&&n("div",{className:"mb-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-sm",children:["Cliquez sur ",a("b",{children:"Demander l'activation"})," (en haut) pour cr√©er votre poste."]}),a("div",{className:"mb-2 text-sm text-gray-600",children:"Choisissez une ville d'arriv√©e :"}),n("div",{className:"flex flex-wrap gap-2",children:[$e.length===0&&a("span",{className:"text-gray-400 text-sm",children:"Aucune destination configur√©e."}),$e.map(t=>{const o=W.toLowerCase()===t.toLowerCase();return a("button",{onClick:()=>yt(t),className:`px-3 py-2 rounded-full text-sm border transition ${o?"text-white":"text-gray-700 hover:bg-gray-50"}`,style:o?{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`,borderColor:"transparent"}:{borderColor:"#E5E7EB",backgroundColor:"white"},children:t},t)})]})]}),n("div",{className:"rounded-2xl border shadow-sm p-6 bg-white hover:shadow transition",children:[n("h3",{className:"font-semibold mb-3 flex items-center gap-2",children:[a(Ot,{className:"h-5 w-5"}),a("span",{children:"Dates disponibles"})]}),a("div",{className:"flex flex-wrap gap-2",children:Ft.map(t=>{const o=Te.some(l=>l.date===t),d=bt===t,p=new Date(t);return n("button",{disabled:!o,onClick:()=>o&&Dt(t),className:`w-16 h-16 rounded-xl border text-center transition ${d?"text-white":""} ${o?"hover:shadow-sm":"opacity-40 cursor-not-allowed"}`,style:d?{background:m.primary,borderColor:m.primary}:{background:"white",borderColor:"#E5E7EB"},children:[a("div",{className:"text-xs",children:p.toLocaleDateString("fr-FR",{weekday:"short"})}),a("div",{className:"text-lg font-bold",children:p.getDate()})]},t)})})]}),n("div",{className:"rounded-2xl border shadow-sm p-6 bg-white hover:shadow transition",children:[n("h3",{className:"font-semibold mb-2 flex items-center gap-2",children:[a(Wt,{className:"h-5 w-5"}),a("span",{children:"Horaires disponibles"})]}),Fe.length===0?a("div",{className:"text-gray-400 text-sm",children:"Aucun horaire pour cette date."}):a("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-2 gap-2",children:Fe.map(t=>{const o=(y==null?void 0:y.id)===t.id,d=oa(t.remainingSeats,t.places||re);return a("button",{onClick:()=>Y(t),className:`text-left px-4 py-3 rounded-xl border transition ${o?"shadow ring-1":"hover:shadow-sm"}`,style:o?{borderColor:m.primary,backgroundColor:"#F5F7FF"}:{borderColor:"#E5E7EB",backgroundColor:"white"},children:n("div",{className:"flex items-start justify-between gap-3",children:[n("div",{children:[n("div",{className:"font-semibold",children:[a("span",{className:"text-base mr-2",style:{color:m.primary},children:t.time}),t.departure," ‚Üí ",t.arrival]}),a("div",{className:"text-xs text-gray-500",children:new Date(t.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})})]}),n("div",{className:"text-right",children:[n("div",{className:"font-bold",style:{color:m.primary},children:[t.price.toLocaleString("fr-FR")," FCFA"]}),a("div",{className:`inline-flex mt-1 px-2 py-0.5 rounded-full text-[11px] ${d.bg} ${d.text}`,children:d.label})]})]})},t.id)})})]})]}),n("div",{className:"bg-white rounded-2xl shadow-sm border h-max sticky top-24 p-6 transition duration-200 ease-out hover:shadow",children:[a("h3",{className:"text-xl font-bold mb-4",style:{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:"D√©tails de la r√©servation"}),!ae&&a("div",{className:"mb-4 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 text-sm",children:x==="pending"?"Votre poste est en attente d'activation par la comptabilit√©.":"Demandez l'activation de votre poste, puis d√©marrez la vente (esp√®ces uniquement)."}),y?n("div",{className:"mb-4 p-4 rounded-xl border",style:{borderColor:m.primary,backgroundColor:"#F8FAFF"},children:[n("div",{className:"flex items-start justify-between gap-3",children:[n("div",{children:[n("div",{className:"font-semibold",children:[y.departure," ‚Üí ",y.arrival]}),a("div",{className:"text-sm text-gray-500",children:new Date(y.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})})]}),a("div",{className:"px-2 py-1 rounded-md bg-white shadow text-sm",style:{color:m.primary},children:y.time})]}),n("div",{className:"mt-2 text-sm",children:["Prix unitaire : ",n("span",{className:"font-semibold",children:[y.price.toLocaleString("fr-FR")," FCFA"]})]}),n("div",{className:"mt-2 text-xs text-gray-500",children:["Places disponibles : ",a("span",{className:"font-medium",children:y.remainingSeats??"Calcul..."})]})]}):a("div",{className:"mb-4 p-4 rounded-xl border border-dashed text-gray-500 text-sm",children:"S√©lectionnez un horaire pour continuer."}),n("div",{className:"mb-3 inline-flex bg-gray-100 p-1 rounded-xl w-full shadow-inner",children:[a("button",{type:"button",className:`flex-1 py-2 rounded-lg text-sm transition ${A==="aller_simple"?"text-white":"hover:bg-white"}`,onClick:()=>{ye("aller_simple"),ie(0)},style:A==="aller_simple"?{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`}:{},children:"Aller simple"}),a("button",{type:"button",className:`flex-1 py-2 rounded-lg text-sm transition ${A==="aller_retour"?"text-white":"hover:bg-white"}`,onClick:()=>ye("aller_retour"),style:A==="aller_retour"?{background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`}:{},children:"Aller-retour"})]}),n("div",{className:"space-y-3",children:[a("input",{className:"w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-200",placeholder:"Nom complet du passager",value:L,onChange:t=>De(t.target.value)}),a("input",{className:"w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-200",placeholder:"T√©l√©phone",value:D,onChange:t=>Me(t.target.value)})]}),n("div",{className:"mt-4 space-y-3",children:[n("div",{children:[a("div",{className:"text-sm mb-1",children:"Nombre de places (Aller)"}),n("div",{className:"flex items-center gap-2",children:[a("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50 transition",onClick:()=>be(t=>Math.max(1,t-1)),children:"-"}),a("div",{className:"flex-1 text-center font-bold py-2 rounded bg-gray-50",children:E}),a("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50 transition",onClick:()=>be(t=>t+1),children:"+"})]})]}),A==="aller_retour"&&n("div",{children:[a("div",{className:"text-sm mb-1",children:"Nombre de places (Retour)"}),n("div",{className:"flex items-center gap-2",children:[a("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50 transition",onClick:()=>ie(t=>Math.max(0,t-1)),children:"-"}),a("div",{className:"flex-1 text-center font-bold py-2 rounded bg-gray-50",children:G}),a("button",{type:"button",className:"px-3 py-2 rounded border bg-white hover:bg-gray-50 transition",onClick:()=>ie(t=>t+1),children:"+"})]})]})]}),n("div",{className:"mt-4 p-4 rounded-xl bg-gray-50 flex items-center justify-between",children:[a("div",{className:"text-sm text-gray-600",children:"Total √† payer (ESP√àCES)"}),n("div",{className:"text-2xl font-bold",style:{color:m.primary},children:[U.toLocaleString("fr-FR")," FCFA"]})]}),!ue&&y&&a("div",{className:"mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200 text-blue-800 text-sm",children:L.trim()?D?pe(D)?U<=0?"Montant invalide":y.remainingSeats===void 0?"V√©rification des places...":y.remainingSeats<=0?"Plus de places disponibles":E>(y.remainingSeats||0)?"Pas assez de places disponibles":"Remplissez tous les champs obligatoires":"T√©l√©phone invalide":"Entrez un num√©ro de t√©l√©phone":"Entrez le nom du passager"})]})]}),a("div",{className:"sticky bottom-0 z-10",children:a("div",{className:"max-w-7xl mx-auto px-4 pb-4",children:n("div",{className:"bg-white/95 backdrop-blur rounded-2xl border shadow-md p-3 flex items-center justify-between",children:[n("div",{className:"flex items-center gap-3",children:[a("div",{className:"h-10 w-10 rounded-full bg-gradient-to-br from-gray-200 to-gray-100 grid place-items-center border",children:a(Yt,{className:"h-5 w-5 text-gray-500"})}),n("div",{className:"leading-tight",children:[n("div",{className:"text-sm font-semibold",children:[((e==null?void 0:e.displayName)||(e==null?void 0:e.email))??"‚Äî"," ",n("span",{className:"text-gray-500",children:["(",fe,")"]})]}),a("div",{className:"text-xs text-gray-500",children:(e==null?void 0:e.role)||"guichetier"})]})]}),n("div",{className:"flex items-center gap-3",children:[n("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-gray-50 transition hidden sm:inline-flex items-center gap-2",onClick:C,title:"Se d√©connecter",children:[a(st,{className:"h-4 w-4"}),"D√©connexion"]}),N==="guichet"&&n(V,{children:[a("div",{className:"text-sm text-gray-600",children:"Total:"}),n("div",{className:"text-xl font-extrabold",style:{color:m.primary},children:[U.toLocaleString("fr-FR")," FCFA"]}),a("button",{className:"px-5 py-3 rounded-xl text-white font-bold disabled:opacity-50 shadow-sm hover:shadow transition",disabled:!ue,style:{background:ue?`linear-gradient(90deg, ${m.primary}, ${m.secondary})`:"#9CA3AF"},onClick:Mt,title:ue?"Valider la r√©servation":"V√©rifiez les informations (trajet, places, client)",children:xe?"Traitement‚Ä¶":"Valider la r√©servation"})]})]})]})})}),a(la,{open:It,onClose:()=>{ve(!1),Ce(null)},initial:St,onSave:Ut,isSaving:Rt}),Ve&&ze&&Oe&&a(ta,{open:Ve,onClose:()=>Be(!1),reservation:ze,company:Oe})]})};export{xa as default};
