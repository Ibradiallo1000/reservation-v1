import{r as l,j as e,a,F as P}from"./vendor-Bq-8_m9i.js";import{A as j,B as R,_ as z,$ as D,q as M,o as $}from"./firebase-CURBI7X6.js";import{y as L,d as O,Q as T,R as W}from"./agence-Bsj2lp2X.js";import{a as B}from"./router-DoGdw-3y.js";import{b0 as U,Z as A,Y as V,L as J,m as K,J as Q}from"./icons-C0JHUK9Z.js";import"./compagnie-DiuZFnHS.js";import"./courier-CoQgRaHG.js";const Y=r=>r.trim().toLowerCase(),Z=r=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.trim()),G=new Set(["admin_platforme","admin_compagnie","company_accountant","agency_accountant","chef_garage","chefagence","chefembarquement","guichetier","agency_fleet_controller","financial_director","agentcourrier"]),H=r=>{const t=(r||"").trim().toLowerCase();return t==="company_ceo"?"admin_compagnie":t==="chefagence"?"chefAgence":t==="agentcourrier"?"agentCourrier":t==="chefembarquement"||t==="agency_boarding_officer"||t==="embarquement"?"chefEmbarquement":G.has(t)?t==="chefagence"?"chefAgence":t:"unauthenticated"},X=r=>{switch(r){case"admin_platforme":return"/admin/dashboard";case"admin_compagnie":return"/compagnie/command-center";case"company_accountant":return"/chef-comptable";case"chef_garage":return"/compagnie/garage/dashboard";case"chefAgence":return"/agence/dashboard";case"chefEmbarquement":return"/agence/boarding";case"agency_accountant":return"/agence/comptabilite";case"guichetier":return"/agence/guichet";case"agentCourrier":return"/agence/courrier";default:return"/login"}},ie=()=>{const r=B(),[t,C]=l.useState("email"),[f,k]=l.useState(""),[w,_]=l.useState(""),[v,E]=l.useState(!0),[g,o]=l.useState(""),[p,b]=l.useState(!1),x=l.useRef(!1),S=l.useCallback(s=>{if(s.preventDefault(),o(""),!Z(f)){o("Adresse e-mail invalide");return}C("password")},[f]),I=l.useCallback(async s=>{if(s.preventDefault(),x.current)return;o(""),b(!0);const y=i=>{console.info("[LoginPage] step:",i,new Date().toISOString())};try{y("before setPersistence"),await j(L,v?R:z),y("after setPersistence, before signInWithEmailAndPassword");const i=await D(L,Y(f),w);y("after signInWithEmailAndPassword (Auth OK)");const u=await M($(O,"users",i.user.uid));y("after getDoc(users)");const d=u.exists()?u.data():{},h=d.role;let N=h;h==="comptable"&&d.agencyId?N="agency_accountant":h==="comptable"&&!d.agencyId&&(N="company_accountant");const c=H(N),m=d.companyId??"",F=d.agencyId??"";if(console.info("[LoginPage] post-getDoc:",{role:c,companyId:m||"(empty)",agencyId:F||"(empty)",rawRole:h}),c==="unauthenticated"){console.error("[LoginPage] role normalized to unauthenticated; raw role:",d.role),o("Profil incomplet (rôle manquant ou invalide). Contactez l’administrateur."),b(!1);return}let n=X(c);if(c==="chefEmbarquement"){n="/agence/boarding",x.current=!0,r(n,{replace:!0}),b(!1);return}c==="admin_compagnie"&&m?n=`/compagnie/${m}/command-center`:c==="admin_compagnie"&&!m?(console.warn("[LoginPage] admin_compagnie without companyId, redirecting to /login"),n="/login"):c==="chef_garage"&&m?n=`/compagnie/${m}/garage/dashboard`:c==="chef_garage"&&!m&&(console.warn("[LoginPage] chef_garage without companyId, redirecting to /login"),n="/login"),c==="company_accountant"&&m&&(n=`/compagnie/${m}/finances`),(!n||n==="")&&(n=c==="guichetier"?"/agence/guichet":"/login",console.warn("[LoginPage] path was empty, using fallback:",n)),console.info("[LoginPage] navigating to:",n),x.current=!0,r(n,{replace:!0})}catch(i){const u=i==null?void 0:i.code,d=(i==null?void 0:i.message)||"Erreur inconnue";console.error("❌ LoginPage - Erreur de connexion:",i),console.error("❌ LoginPage - Code:",u,"Message:",d),T(),x.current=!1,u==="auth/network-request-failed"?(o("Erreur réseau (auth/network-request-failed). Vérifiez votre connexion, les domaines autorisés (Firebase Console > Auth > Paramètres), et que identitytoolkit.googleapis.com / securetoken.googleapis.com ne sont pas bloqués (proxy, pare-feu)."),W().then(h=>{console.info("[LoginPage] Firebase Auth connectivity check:",h)})):o(u==="auth/wrong-password"?"Mot de passe incorrect.":u==="auth/user-not-found"?"Aucun compte associé à cet e-mail.":u==="auth/invalid-email"?"Format d'email invalide.":u==="auth/too-many-requests"?"Trop de tentatives. Réessayez plus tard.":`Connexion impossible: ${d}`)}finally{b(!1)}},[f,w,v,r]),q=l.useMemo(()=>{const s=f.split("@")[0]||"Utilisateur";return s.charAt(0).toUpperCase()+s.slice(1)},[f]);return e("div",{className:"min-h-screen flex items-center justify-center p-4 sm:p-6",style:{background:"linear-gradient(160deg, #fafafa 0%, #f1f5f9 50%, #e2e8f0 100%)"},"aria-busy":p,children:a("div",{className:"w-full max-w-[420px] bg-white rounded-2xl shadow-lg p-8 sm:p-10 animate-fadein",style:{boxShadow:"0 4px 24px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04)"},children:[a("div",{className:"text-center mb-8",children:[e("img",{src:"/images/teliya-logo.jpg",alt:"Teliya",className:"h-12 w-auto mx-auto mb-4 object-contain"}),e("h1",{className:"text-xl font-semibold text-slate-800 tracking-tight",children:"Teliya"}),e("p",{className:"text-sm text-slate-500 mt-1",children:"Plateforme de gestion transport"})]}),e("h2",{className:"text-lg font-medium text-slate-800 mb-6",children:t==="email"?"Connexion":`Bonjour ${q}`}),t==="email"&&a("form",{onSubmit:S,className:"space-y-5",children:[a("div",{children:[e("label",{htmlFor:"login-email",className:"sr-only",children:"Adresse e-mail"}),a("div",{className:"relative",children:[e(U,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400 pointer-events-none","aria-hidden":!0}),e("input",{id:"login-email",type:"email",autoComplete:"email",className:"w-full border border-slate-200 rounded-xl pl-11 pr-4 py-3 text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:border-slate-300 transition-shadow",placeholder:"email@domaine.com",value:f,onChange:s=>k(s.target.value),autoFocus:!0,"aria-invalid":!!g,"aria-describedby":g?"login-email-error":void 0})]})]}),g&&a("p",{id:"login-email-error",className:"text-sm text-red-600 flex items-center gap-2",role:"alert",children:[e(A,{className:"h-4 w-4 flex-shrink-0"}),g]}),e("button",{type:"submit",className:"w-full bg-slate-800 text-white py-3 px-4 rounded-xl font-medium hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-colors",children:"Continuer"})]}),t==="password"&&a("form",{onSubmit:I,className:"space-y-5",children:[a("div",{children:[e("label",{htmlFor:"login-password",className:"sr-only",children:"Mot de passe"}),a("div",{className:"relative",children:[e(V,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400 pointer-events-none","aria-hidden":!0}),e("input",{id:"login-password",type:"password",autoComplete:"current-password",className:"w-full border border-slate-200 rounded-xl pl-11 pr-4 py-3 text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:border-slate-300 transition-shadow",placeholder:"Mot de passe",value:w,onChange:s=>_(s.target.value),autoFocus:!0,"aria-invalid":!!g,"aria-describedby":g?"login-password-error":void 0})]})]}),g&&a("p",{id:"login-password-error",className:"text-sm text-red-600 flex items-center gap-2",role:"alert",children:[e(A,{className:"h-4 w-4 flex-shrink-0"}),g]}),e("div",{className:"text-right text-sm",children:e("a",{href:"/forgot-password",className:"text-slate-500 hover:text-slate-700 focus:outline-none focus:underline",children:"Mot de passe oublié ?"})}),a("div",{className:"flex justify-between items-center text-sm",children:[a("label",{className:"flex items-center gap-2 text-slate-600 cursor-pointer",children:[e("input",{type:"checkbox",checked:v,onChange:s=>E(s.target.checked),className:"rounded border-slate-300 text-slate-700 focus:ring-slate-400"}),"Se souvenir de moi"]}),a("button",{type:"button",onClick:()=>{C("email"),_(""),o("")},className:"flex items-center gap-1.5 text-slate-600 hover:text-slate-800 focus:outline-none focus:underline",children:[e(J,{className:"h-4 w-4","aria-hidden":!0}),"Changer d'email"]})]}),e("button",{type:"submit",disabled:p,className:"w-full bg-slate-800 text-white py-3 px-4 rounded-xl font-medium flex justify-center items-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-colors","aria-busy":p,children:p?a(P,{children:[e(K,{className:"h-5 w-5 animate-spin","aria-hidden":!0}),"Connexion en cours..."]}):a(P,{children:["Connexion",e(Q,{className:"h-5 w-5","aria-hidden":!0})]})}),e("div",{className:"text-center pt-2",children:e("a",{href:"/test-firebase",className:"text-sm text-slate-500 hover:text-slate-700 focus:outline-none focus:underline",children:"Problèmes de connexion ? Testez Firebase ici"})})]})]})})};export{ie as default};
