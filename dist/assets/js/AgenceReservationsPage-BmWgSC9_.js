import{d as Ne,b as we,r as u,j as t,a}from"./react-DB_4kGOy.js";import{x as G,A as I,q as Ce,o as H,w as le,y as T,B as ke,T as $,H as $e}from"./firebase-lLzYRzUk.js";import{u as Se,d as w}from"../index-Bkmir__O.js";import"./vendor-C-DAJou6.js";const V=r=>{const h=new Date(r);return h.setHours(0,0,0,0),h},L=r=>{const h=new Date(r);return h.setHours(23,59,59,999),h},S=r=>`${(r||0).toLocaleString("fr-FR")} FCFA`,ie=r=>r.toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),de=r=>{const h=(r||"").toString().toLowerCase().trim().replace(/\s|_|-/g,"");return h.includes("ligne")||h==="online"||h==="web"},C=({color:r,children:h})=>{const x={green:{bg:"#DCFCE7",fg:"#166534"},emerald:{bg:"#D1FAE5",fg:"#065F46"},amber:{bg:"#FEF3C7",fg:"#92400E"},gray:{bg:"#F3F4F6",fg:"#374151"},red:{bg:"#FEE2E2",fg:"#B91C1C"},indigo:{bg:"#E0E7FF",fg:"#3730A3"}}[r];return t("span",{className:"px-2 py-0.5 rounded text-xs font-medium",style:{backgroundColor:x.bg,color:x.fg},children:h})},q=({label:r,value:h,icon:b,primary:x,secondary:p})=>a("div",{className:"rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow border",style:{borderColor:`${x}22`,background:`linear-gradient(180deg, #ffffff, ${p}0f)`},children:[a("div",{className:"flex items-center justify-between",children:[t("div",{className:"text-sm text-gray-600",children:r}),t("div",{className:"h-9 w-9 rounded-xl grid place-items-center",style:{background:`linear-gradient(135deg, ${x}22, ${p}22)`},children:t("span",{className:"text-gray-700",children:b??"📊"})})]}),t("div",{className:"text-2xl font-extrabold mt-1",style:{background:`linear-gradient(90deg, ${x}, ${p})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:h})]}),Te=({tickets:r,amount:h,primary:b,secondary:x})=>a("div",{className:"relative rounded-2xl border bg-white p-4 shadow-sm hover:shadow-md transition-shadow",style:{borderColor:`${b}22`},children:[t("div",{className:"absolute inset-x-0 -top-px h-1 rounded-t-2xl",style:{background:`linear-gradient(90deg, ${b}, ${x})`}}),a("div",{className:"flex items-start justify-between gap-3",children:[a("div",{className:"min-w-0",children:[t("div",{className:"text-sm text-gray-500",children:"Guichet"}),t("div",{className:"font-semibold truncate",children:"Réservations en ligne"}),t("div",{className:"mt-2 inline-flex items-center gap-2 text-xs",children:t("span",{"aria-label":"Statut en ligne",className:"px-2 py-0.5 rounded-full font-medium border",style:{backgroundColor:"#f0fdf4",color:"#166534",borderColor:"#bbf7d0"},children:"En ligne"})})]}),t("div",{"aria-hidden":!0,className:"h-10 w-10 rounded-xl grid place-items-center shadow-inner",style:{background:`linear-gradient(45deg, ${b}22, ${x}22)`},children:"🌐"})]}),a("div",{className:"grid grid-cols-2 gap-3 mt-3 text-sm",children:[a("div",{children:[t("div",{className:"text-xs text-gray-500",children:"Billets"}),t("div",{className:"font-medium",children:r})]}),a("div",{className:"text-right",children:[t("div",{className:"text-xs text-gray-500",children:"Montant"}),t("div",{className:"font-medium",children:S(h)})]})]})]}),Re=()=>{const{user:r,company:h}=Se(),{id:b}=Ne(),x=we(),p=r==null?void 0:r.companyId,f=b||(r==null?void 0:r.agencyId),c={primary:(h==null?void 0:h.couleurPrimaire)||"#e85d04",secondary:(h==null?void 0:h.couleurSecondaire)||"#ffb703",background:"#f7f8fa"},[D,U]=u.useState("day"),[F,oe]=u.useState(()=>{const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}),[A,ce]=u.useState(""),[R,me]=u.useState(""),[k,J]=u.useState([V(new Date),L(new Date)]);u.useEffect(()=>{if(D==="day"){const e=F?new Date(F):new Date;J([V(e),L(e)])}else{const e=V(A?new Date(A):new Date),s=L(R?new Date(R):new Date);J([e,s])}},[D,F,A,R]);const[E,ue]=u.useState([]),[W,he]=u.useState({}),[pe,ge]=u.useState({}),v=u.useRef({});u.useEffect(()=>{if(!p||!f)return;const e=G(w,`companies/${p}/agences/${f}/shifts`),s=I(e,async m=>{const i=m.docs.map(o=>{const l=o.data();return{id:o.id,userId:l.userId||l.openedById||"",userName:l.userName||l.openedByName||l.userEmail||"",userEmail:l.userEmail,userCode:l.userCode||l.openedByCode||"",status:l.status,startTime:l.startTime||l.openedAt,endTime:l.endTime||l.closedAt,comptable:l.comptable,chef:l.chef}}),n=Array.from(new Set(i.map(o=>o.userId).filter(o=>!!o&&!W[o])));if(n.length){const o=await Promise.all(n.map(async l=>{const y=await Ce(H(w,"users",l)),g=y.exists()?y.data():{};return[l,{name:g.displayName||g.nom||g.email||"",email:g.email||"",code:g.staffCode||g.codeCourt||g.code||""}]}));he(l=>Object.fromEntries([...Object.entries(l),...o]))}const d=i.filter(o=>{var l;return!(o.status==="validated"&&((l=o.chef)!=null&&l.validated))});ue(d)});return()=>s()},[p,f]),u.useEffect(()=>{var s,m;if(!p||!f)return;const e=G(w,`companies/${p}/agences/${f}/reservations`);for(const i of Object.keys(v.current))E.find(n=>n.id===i&&(n.status==="active"||n.status==="paused"))||((m=(s=v.current)[i])==null||m.call(s),delete v.current[i]);for(const i of E){if(!(i.status==="active"||i.status==="paused")||v.current[i.id])continue;const n=le(e,T("shiftId","==",i.id),T("statut","==","payé"),T("canal","==","guichet"));v.current[i.id]=I(n,d=>{let o=0,l=0;d.forEach(y=>{const g=y.data(),B=(g.seatsGo||0)+(g.seatsReturn||0);o+=B,l+=g.montant||0}),ge(y=>({...y,[i.id]:{tickets:o,amount:l}}))})}return()=>{var i,n;for(const d of Object.keys(v.current))(n=(i=v.current)[d])==null||n.call(i);v.current={}}},[E,p,f]);const[j,fe]=u.useState([]);u.useEffect(()=>{if(!p||!f||!k[0]||!k[1])return;const e=G(w,`companies/${p}/agences/${f}/reservations`),s=le(e,T("createdAt",">=",$.fromDate(k[0])),T("createdAt","<=",$.fromDate(k[1])),T("statut","==","payé"),ke("createdAt","asc")),m=I(s,i=>{const n=i.docs.map(d=>({id:d.id,...d.data()}));fe(n)});return()=>m()},[p,f,k]);const N=u.useMemo(()=>{let e=0,s=0,m=0,i=0;for(const n of j){const d=(n.seatsGo||0)+(n.seatsReturn||0);de(n.canal)?(m+=d,i+=n.montant||0):(e+=d,s+=n.montant||0)}return{gTickets:e,gMontant:s,oTickets:m,oMontant:i}},[j]),Y=u.useMemo(()=>{const e={};for(const s of j){const m=`${s.depart||"?"} → ${s.arrivee||"?"}`,i=s.date||"",n=s.heure||"",d=`${m} • ${i} ${n}`;e[d]||(e[d]={key:d,trajet:m,date:i,heure:n,billetsGuichet:0,billetsOnline:0,billetsTotal:0,montantGuichet:0,montantOnline:0,montantTotal:0});const o=(s.seatsGo||0)+(s.seatsReturn||0);de(s.canal)?(e[d].billetsOnline+=o,e[d].montantOnline+=s.montant||0):(e[d].billetsGuichet+=o,e[d].montantGuichet+=s.montant||0),e[d].billetsTotal+=o,e[d].montantTotal+=s.montant||0}return Object.values(e).sort((s,m)=>s.date===m.date?s.heure.localeCompare(m.heure):s.date.localeCompare(m.date))},[j]),[O,ye]=u.useState([]),[P,xe]=u.useState(!1),[M,be]=u.useState("");u.useEffect(()=>{if(!p||!f)return;const e=G(w,`companies/${p}/agences/${f}/shifts`);return I(e,s=>{const i=s.docs.map(n=>({id:n.id,...n.data()})).filter(n=>{var d,o;return n.status==="validated"&&((d=n==null?void 0:n.comptable)==null?void 0:d.validated)&&((o=n==null?void 0:n.chef)==null?void 0:o.validated)});ye(i)})},[p,f]);const _=u.useMemo(()=>{const e=M.trim().toLowerCase(),s=e?O.filter(m=>(m.userCode||"").toLowerCase().includes(e)):O;return P?s:s.slice(0,5)},[O,P,M]),[z,Q]=u.useState(null),ve=u.useCallback(async e=>{if(!p||!f||!(r!=null&&r.uid))return;Q(e);const s=`companies/${p}/agences/${f}`,m=H(w,`${s}/shiftReports/${e}`),i=H(w,`${s}/shifts/${e}`);try{await $e(w,async n=>{var g;const[d,o]=await Promise.all([n.get(m),n.get(i)]);if(!o.exists())throw new Error("Poste introuvable.");const l=o.data(),y=!!((g=l==null?void 0:l.comptable)!=null&&g.validated);d.exists()?n.update(m,{managerValidated:!0,managerStamp:{by:{id:r.uid,name:r.displayName||r.email||""},at:$.now(),note:"Validé par le chef d’agence"},updatedAt:$.now()}):n.set(m,{managerValidated:!0,managerStamp:{by:{id:r.uid,name:r.displayName||r.email||""},at:$.now(),note:"Validé par le chef d’agence"},updatedAt:$.now()}),n.update(i,{status:y?"validated":l.status||"closed",chef:{...l.chef||{},validated:!0,at:$.now(),by:{id:r.uid,name:r.displayName||r.email||""},note:"Validation chef d’agence"}})})}finally{Q(null)}},[p,f,r==null?void 0:r.uid,r==null?void 0:r.displayName,r==null?void 0:r.email]);return t("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100",style:{background:c.background},children:a("div",{className:"max-w-7xl mx-auto px-4 py-6 space-y-6",children:[a("div",{className:"rounded-2xl bg-white border shadow-sm p-4 space-y-4",children:[a("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[a("div",{className:"font-semibold",children:["Période : ",a("span",{className:"text-gray-600",children:[ie(k[0])," → ",ie(k[1])]})]}),a("div",{className:"flex items-center gap-3",children:[a("label",{className:"flex items-center gap-2 text-sm",children:[t("input",{type:"radio",name:"mode",checked:D==="day",onChange:()=>U("day")})," Jour"]}),a("label",{className:"flex items-center gap-2 text-sm",children:[t("input",{type:"radio",name:"mode",checked:D==="range",onChange:()=>U("range")})," Intervalle"]}),D==="day"?t("input",{type:"date",className:"border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2",style:{outlineColor:c.primary},value:F,onChange:e=>oe(e.target.value)}):a("div",{className:"flex items-center gap-2",children:[t("input",{type:"date",className:"border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2",style:{outlineColor:c.primary},value:A,onChange:e=>ce(e.target.value)}),t("span",{className:"text-gray-500",children:"→"}),t("input",{type:"date",className:"border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2",style:{outlineColor:c.primary},value:R,onChange:e=>me(e.target.value)})]})]})]}),a("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3",children:[t(q,{label:"Billets (Guichet)",value:String(N.gTickets),primary:c.primary,secondary:c.secondary}),t(q,{label:"Montant (Guichet)",value:S(N.gMontant),primary:c.primary,secondary:c.secondary}),t(q,{label:"Billets (En ligne)",value:String(N.oTickets),primary:c.primary,secondary:c.secondary}),t(q,{label:"Montant (En ligne)",value:S(N.oMontant),primary:c.primary,secondary:c.secondary})]})]}),a("div",{className:"rounded-2xl bg-white border shadow-sm p-4",children:[t("div",{className:"text-lg font-bold mb-3 flex items-center gap-2",children:"🧾 Guichets en activité"}),E.length===0&&N.oTickets===0?t("div",{className:"text-gray-500",children:"Aucun poste en attente / en service / en pause / clôturé."}):a("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3",children:[N.oTickets>0&&t(Te,{tickets:N.oTickets,amount:N.oMontant,primary:c.primary,secondary:c.secondary}),E.map(e=>{var l,y,g,B,X,Z,ee,te,ae,ne,re,se;const s=W[e.userId]||{},m=s.name||e.userName||e.userEmail||e.userId,i=(s.code||e.userCode||"").trim()||"—",n=pe[e.id],d={active:{label:"En service",dot:"#22c55e"},paused:{label:"En pause",dot:"#f59e0b"},closed:{label:"Clôturé",dot:"#64748b"},pending:{label:"En attente",dot:"#6366f1"},validated:{label:"Validé",dot:"#10b981"}},o=d[e.status]||d.pending;return a("div",{className:"relative rounded-2xl border bg-white p-4 shadow-sm hover:shadow-md transition-shadow",style:{borderColor:`${c.primary}22`},children:[t("div",{className:"absolute inset-x-0 -top-px h-1 rounded-t-2xl",style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`}}),a("div",{className:"flex items-start justify-between gap-3",children:[a("div",{className:"min-w-0",children:[t("div",{className:"text-sm text-gray-500",children:"Guichetier"}),a("div",{className:"font-semibold truncate",children:[m," ",a("span",{className:"text-gray-500 text-xs",children:["(",i,")"]})]}),a("div",{className:"mt-2 inline-flex flex-wrap items-center gap-2 text-xs",children:[a("span",{className:"px-2 py-0.5 rounded-full font-medium border",style:{backgroundColor:"#f8fafc",borderColor:"#e2e8f0"},children:[t("span",{className:"inline-block w-2 h-2 rounded-full mr-1",style:{backgroundColor:o.dot}}),o.label]}),(l=e.comptable)!=null&&l.validated?a(C,{color:"emerald",children:["✅ Comptable OK",(g=(y=e.comptable)==null?void 0:y.by)!=null&&g.name?` • ${e.comptable.by.name}`:""]}):t(C,{color:"amber",children:"Comptabilité en attente"}),(B=e.chef)!=null&&B.validated?a(C,{color:"emerald",children:["🗞️ Chef OK",(Z=(X=e.chef)==null?void 0:X.by)!=null&&Z.name?` • ${e.chef.by.name}`:""]}):t(C,{color:"amber",children:"Chef en attente"})]})]}),t("div",{"aria-hidden":!0,className:"h-10 w-10 rounded-xl grid place-items-center shadow-inner",style:{background:`linear-gradient(45deg, ${c.primary}22, ${c.secondary}22)`},children:"🧾"})]}),a("div",{className:"grid grid-cols-2 gap-3 mt-3 text-sm",children:[a("div",{children:[t("div",{className:"text-xs text-gray-500",children:"Début"}),t("div",{className:"font-medium",children:e.startTime?new Date(((te=(ee=e.startTime).toDate)==null?void 0:te.call(ee))??e.startTime).toLocaleString("fr-FR"):"—"})]}),a("div",{className:"text-right",children:[t("div",{className:"text-xs text-gray-500",children:"Fin"}),t("div",{className:"font-medium",children:e.endTime?new Date(((ne=(ae=e.endTime).toDate)==null?void 0:ne.call(ae))??e.endTime).toLocaleString("fr-FR"):"—"})]})]}),a("div",{className:"mt-3 rounded-xl border bg-gray-50 px-3 py-2 text-sm flex items-center justify-between",children:[a("div",{children:["Billets : ",t("b",{children:n?n.tickets:0})]}),a("div",{children:["Montant : ",t("b",{children:S(n?n.amount:0)})]})]}),((re=e.comptable)==null?void 0:re.validated)&&!((se=e.chef)!=null&&se.validated)&&["closed","paused","active","validated"].includes(e.status)&&t("div",{className:"mt-3",children:t("button",{onClick:()=>ve(e.id).catch(K=>alert((K==null?void 0:K.message)||"Erreur")),disabled:z===e.id,className:"w-full px-3 py-2 rounded-lg text-white shadow-sm disabled:opacity-50 focus:outline-none focus:ring-2",style:{background:`linear-gradient(90deg, ${c.primary}, ${c.secondary})`,outlineColor:c.primary},title:"Valider ce poste (Chef d’agence)",children:z===e.id?"Validation…":"Valider (Chef d’agence)"})})]},e.id)})]}),a("div",{className:"text-xs text-gray-500 mt-2",children:["Lorsqu’un poste est ",t("b",{children:"validé"})," (Comptable + Chef), il est archivé dans “Rapports de poste (validés)” plus bas."]})]}),a("div",{className:"rounded-2xl bg-white border shadow-sm",children:[t("div",{className:"px-4 py-3 font-semibold",children:"Départs (regroupés par trajet / date / heure)"}),t("div",{className:"overflow-x-auto",children:Y.length===0?t("div",{className:"px-4 py-6 text-gray-500",children:"Aucun départ sur la période."}):a("table",{className:"w-full text-sm",children:[t("thead",{style:{background:`${c.secondary}22`},className:"text-gray-700",children:a("tr",{children:[t("th",{className:"px-3 py-2 text-left",children:"Trajet"}),t("th",{className:"px-3 py-2 text-left",children:"Date"}),t("th",{className:"px-3 py-2 text-left",children:"Heure"}),t("th",{className:"px-3 py-2 text-right",children:"Billets (Guichet)"}),t("th",{className:"px-3 py-2 text-right",children:"Billets (En ligne)"}),t("th",{className:"px-3 py-2 text-right",children:"Billets (Total)"}),t("th",{className:"px-3 py-2 text-right",children:"Montant (Guichet)"}),t("th",{className:"px-3 py-2 text-right",children:"Montant (En ligne)"}),t("th",{className:"px-3 py-2 text-right",children:"Montant (Total)"}),t("th",{className:"px-3 py-2 text-right",children:"Actions"})]})}),t("tbody",{children:Y.map(e=>a("tr",{className:"border-t hover:bg-gray-50",children:[t("td",{className:"px-3 py-2",children:e.trajet}),t("td",{className:"px-3 py-2",children:e.date}),t("td",{className:"px-3 py-2",children:e.heure}),t("td",{className:"px-3 py-2 text-right",children:e.billetsGuichet}),t("td",{className:"px-3 py-2 text-right",children:e.billetsOnline}),t("td",{className:"px-3 py-2 text-right font-semibold",children:e.billetsTotal}),t("td",{className:"px-3 py-2 text-right",children:S(e.montantGuichet)}),t("td",{className:"px-3 py-2 text-right",children:S(e.montantOnline)}),t("td",{className:"px-3 py-2 text-right font-semibold",children:S(e.montantTotal)}),t("td",{className:"px-3 py-2 text-right",children:t("button",{onClick:()=>x("/agence/embarquement",{state:{trajet:e.trajet,date:e.date,heure:e.heure}}),className:"px-3 py-1.5 rounded-lg border hover:bg-gray-50 focus:outline-none focus:ring-2",style:{outlineColor:c.primary},title:"Afficher la liste d'embarquement",children:"Afficher"})})]},e.key))})]})})]}),a("div",{className:"rounded-2xl bg-white border shadow-sm",children:[a("div",{className:"px-4 py-3 flex items-center justify-between gap-3",children:[t("div",{className:"font-semibold",children:"Rapports de poste (validés)"}),a("div",{className:"flex items-center gap-2",children:[t("input",{placeholder:"Filtrer par code guichetier",className:"border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2",style:{outlineColor:c.primary},value:M,onChange:e=>be(e.target.value)}),O.length>5&&t("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-slate-50",onClick:()=>xe(e=>!e),children:P?"Réduire":"Voir tout"})]})]}),_.length===0?t("div",{className:"px-4 py-6 text-gray-500",children:M?"Aucun rapport ne correspond à ce code.":"Aucun rapport validé."}):t("div",{className:"overflow-x-auto",children:a("table",{className:"w-full text-sm",children:[t("thead",{className:"bg-slate-50",children:a("tr",{children:[t("th",{className:"px-3 py-2 text-left",children:"Guichetier"}),t("th",{className:"px-3 py-2 text-left",children:"Code"}),t("th",{className:"px-3 py-2 text-left",children:"Début"}),t("th",{className:"px-3 py-2 text-left",children:"Fin"}),t("th",{className:"px-3 py-2 text-left",children:"Validations"}),t("th",{className:"px-3 py-2 text-right",children:"Actions"})]})}),t("tbody",{children:_.map(e=>{var i,n,d,o,l,y;const s=e.userName||e.userEmail||e.userId,m=e.userCode||"—";return a("tr",{className:"border-t hover:bg-gray-50",children:[t("td",{className:"px-3 py-2",children:s}),t("td",{className:"px-3 py-2",children:m}),t("td",{className:"px-3 py-2",children:e.startTime?new Date(((n=(i=e.startTime).toDate)==null?void 0:n.call(i))??e.startTime).toLocaleString("fr-FR"):"—"}),t("td",{className:"px-3 py-2",children:e.endTime?new Date(((o=(d=e.endTime).toDate)==null?void 0:o.call(d))??e.endTime).toLocaleString("fr-FR"):"—"}),t("td",{className:"px-3 py-2",children:a("div",{className:"flex items-center gap-2 text-xs",children:[(l=e.comptable)!=null&&l.validated?t(C,{color:"green",children:"Comptable OK"}):t(C,{color:"amber",children:"Comptable en attente"}),(y=e.chef)!=null&&y.validated?t(C,{color:"green",children:"Chef OK"}):t(C,{color:"amber",children:"Chef en attente"})]})}),a("td",{className:"px-3 py-2 text-right",children:[t("button",{className:"px-3 py-1.5 rounded-lg border hover:bg-gray-50 mr-2 focus:outline-none focus:ring-2",style:{outlineColor:c.primary},onClick:()=>x(`/agence/rapport/${e.id}`),title:"Ouvrir le rapport",children:"Afficher"}),t("button",{className:"px-3 py-1.5 rounded-lg border hover:bg-gray-50 focus:outline-none focus:ring-2",style:{outlineColor:c.primary},onClick:()=>window.print(),title:"Imprimer",children:"Imprimer"})]})]},e.id)})})]})}),a("div",{className:"text-xs text-gray-500 px-4 py-3 border-t",children:["Un poste n’apparaît ici qu’après ",t("b",{children:"double validation"})," (Comptable + Chef)."]})]})]})})};export{Re as default};
