import{b as Y,r as l,j as e,a as s}from"./react-DB_4kGOy.js";import{q as Z,o as ee,x as j,w as k,B as A,y as te,z as $}from"./firebase-lLzYRzUk.js";import{u as ae,b as se,d as R}from"../index-Bkmir__O.js";import"./vendor-C-DAJou6.js";const ne=a=>`${(a||0).toLocaleString("fr-FR")} FCFA`,U=a=>a==="active"?{bg:"#DCFCE7",txt:"#166534",label:"En service"}:a==="paused"?{bg:"#FEF3C7",txt:"#92400E",label:"En pause"}:{bg:"#F3F4F6",txt:"#374151",label:"Clôturé"},de=()=>{const{user:a,company:V}=ae(),m=se(V)||{primary:"#2563eb",secondary:"#7c3aed"};Y();const[p,q]=l.useState(""),[h,B]=l.useState(""),[u,M]=l.useState("all"),[g,G]=l.useState(""),[x,_]=l.useState([]),[z,I]=l.useState(!1),[D,E]=l.useState(null),C=l.useMemo(()=>({background:`linear-gradient(90deg, ${m.primary}, ${m.secondary})`}),[m.primary,m.secondary]),[H,O]=l.useState("Compagnie"),[L,P]=l.useState(null);l.useEffect(()=>{(async()=>{if(!(a!=null&&a.companyId))return;const t=await Z(ee(R,"companies",a.companyId));if(t.exists()){const n=t.data();O(n.nom||n.name||"Compagnie"),P(n.logoUrl||n.logo||null)}})().catch(()=>{})},[a==null?void 0:a.companyId]);const S=l.useCallback(async()=>{try{if(!(a!=null&&a.companyId)||!(a!=null&&a.agencyId))return;E(null),I(!0);const t=j(R,`companies/${a.companyId}/agences/${a.agencyId}/shifts`);let n=k(t,A("startTime","desc"));u!=="all"&&(n=k(t,te("status","==",u),A("startTime","desc")));const T=await $(n),y=j(R,`companies/${a.companyId}/agences/${a.agencyId}/reservations`),c=(await $(y)).docs.map(r=>({id:r.id,...r.data()})),N=p?new Date(p+"T00:00:00").getTime():null,f=h?new Date(h+"T23:59:59").getTime():null,v=[];for(const r of T.docs){const o=r.data();if(N&&(o.startTime??0)<N||f&&(o.startTime??0)>f)continue;const i=(o.guichetierCode||o.sellerCode||"").toString();if(g&&!i.toLowerCase().includes(g.toLowerCase()))continue;const F=c.filter(d=>d.shiftId===r.id),Q=F.length,W=F.reduce((d,w)=>d+(w.seatsGo||0)+(w.seatsReturn||0),0),X=F.reduce((d,w)=>d+(w.montant||0),0);v.push({id:r.id,guichetierCode:i||null,status:o.status||"closed",startTime:o.startTime||o.startedAt||null,endTime:o.endTime||o.closedAt||null,reservations:Q,billets:W,montant:X})}_(v)}catch(t){E((t==null?void 0:t.message)||"Erreur de chargement.")}finally{I(!1)}},[a==null?void 0:a.companyId,a==null?void 0:a.agencyId,u,p,h,g]);l.useEffect(()=>{S()},[S]);const J=t=>{window.open(`/agence/reports?shiftId=${encodeURIComponent(t)}`,"_blank")},K=t=>{window.open(`/agence/reports?shiftId=${encodeURIComponent(t)}&print=1`,"_blank")};return e("div",{className:"max-w-7xl mx-auto px-4 py-6",children:s("div",{className:"rounded-2xl overflow-hidden border shadow-sm bg-white mb-4",children:[e("div",{className:"p-4 text-white",style:C,children:s("div",{className:"flex items-center justify-between",children:[s("div",{className:"flex items-center gap-3",children:[L?e("img",{src:L,className:"h-8 w-8 object-contain bg-white/90 rounded p-1"}):e("div",{className:"h-8 w-8 rounded bg-white/30"}),s("div",{children:[e("div",{className:"text-lg font-semibold",children:"Historique des postes — Agence"}),e("div",{className:"text-xs opacity-90",children:H})]})]}),s("div",{className:"hidden sm:flex gap-2",children:[e("button",{onClick:S,className:"px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm",children:"Actualiser"}),e("button",{onClick:()=>{if(!x.length)return;const t=["Shift","Guichetier","Statut","Début","Fin","Ventes","Billets","Montant"],n=x.map(c=>{const N=U(c.status).label,f=c.startTime?new Date(c.startTime).toLocaleString("fr-FR"):"",v=c.endTime?new Date(c.endTime).toLocaleString("fr-FR"):"";return[c.id,c.guichetierCode||"",N,f,v,String(c.reservations),String(c.billets),String(c.montant)].map(o=>{const i=(o??"").toString();return/[",\n;]/.test(i)?`"${i.replace(/"/g,'""')}"`:i}).join(";")}).join(`
`),T=new Blob([t.join(";")+`
`+n],{type:"text/csv;charset=utf-8;"}),y=URL.createObjectURL(T),b=document.createElement("a");b.href=y,b.download="historique_agence_shifts.csv",b.click(),setTimeout(()=>URL.revokeObjectURL(y),400)},className:"px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm",children:"Export CSV"})]})]})}),s("div",{className:"p-3 border-b grid grid-cols-1 sm:grid-cols-5 gap-2",children:[s("div",{className:"sm:col-span-1",children:[e("label",{className:"text-xs text-gray-500",children:"Du"}),e("input",{type:"date",value:p,onChange:t=>q(t.target.value),className:"w-full border rounded-lg px-3 py-2"})]}),s("div",{className:"sm:col-span-1",children:[e("label",{className:"text-xs text-gray-500",children:"Au"}),e("input",{type:"date",value:h,onChange:t=>B(t.target.value),className:"w-full border rounded-lg px-3 py-2"})]}),s("div",{className:"sm:col-span-1",children:[e("label",{className:"text-xs text-gray-500",children:"Statut"}),s("select",{value:u,onChange:t=>M(t.target.value),className:"w-full border rounded-lg px-3 py-2",children:[e("option",{value:"all",children:"Tous"}),e("option",{value:"active",children:"En service"}),e("option",{value:"paused",children:"En pause"}),e("option",{value:"closed",children:"Clôturé"})]})]}),s("div",{className:"sm:col-span-2",children:[e("label",{className:"text-xs text-gray-500",children:"Code guichetier"}),e("input",{placeholder:"ex: G001",value:g,onChange:t=>G(t.target.value),className:"w-full border rounded-lg px-3 py-2"})]})]}),s("div",{className:"p-3",children:[D&&e("div",{className:"mb-3 p-3 rounded-lg bg-red-50 text-red-700 text-sm border border-red-200",children:D}),e("div",{className:"overflow-auto rounded-xl border",children:s("table",{className:"min-w-full text-sm",children:[e("thead",{children:s("tr",{className:"text-left text-white",style:C,children:[e("th",{className:"px-3 py-2",children:"Guichetier"}),e("th",{className:"px-3 py-2",children:"Statut"}),e("th",{className:"px-3 py-2",children:"Début"}),e("th",{className:"px-3 py-2",children:"Fin"}),e("th",{className:"px-3 py-2 text-right",children:"Ventes"}),e("th",{className:"px-3 py-2 text-right",children:"Billets"}),e("th",{className:"px-3 py-2 text-right",children:"Montant"}),e("th",{className:"px-3 py-2 text-right",children:"Actions"})]})}),e("tbody",{className:"bg-white",children:z?e("tr",{children:e("td",{colSpan:8,className:"px-3 py-6 text-center text-gray-500",children:"Chargement…"})}):x.length===0?e("tr",{children:e("td",{colSpan:8,className:"px-3 py-6 text-center text-gray-500",children:"Aucun résultat."})}):x.map(t=>{const n=U(t.status);return s("tr",{className:"border-t hover:bg-gray-50",children:[e("td",{className:"px-3 py-2",children:t.guichetierCode||"—"}),e("td",{className:"px-3 py-2",children:e("span",{className:"text-xs px-2 py-1 rounded",style:{backgroundColor:n.bg,color:n.txt},children:n.label})}),e("td",{className:"px-3 py-2",children:t.startTime?new Date(t.startTime).toLocaleString("fr-FR"):"—"}),e("td",{className:"px-3 py-2",children:t.endTime?new Date(t.endTime).toLocaleString("fr-FR"):"—"}),e("td",{className:"px-3 py-2 text-right",children:t.reservations}),e("td",{className:"px-3 py-2 text-right",children:t.billets}),e("td",{className:"px-3 py-2 text-right font-medium",children:ne(t.montant)}),e("td",{className:"px-3 py-2 text-right",children:s("div",{className:"flex justify-end gap-2",children:[e("button",{onClick:()=>J(t.id),className:"px-3 py-1.5 rounded-lg text-sm text-white",style:C,children:"Voir rapport"}),e("button",{onClick:()=>K(t.id),className:"px-3 py-1.5 rounded-lg text-sm border",children:"Imprimer"})]})})]},t.id)})})]})}),e("div",{className:"text-xs text-gray-500 mt-3",children:"Vue agence : appliquez les filtres pour retrouver une session d’un guichetier et ouvrir/ imprimer son rapport."})]})]})})};export{de as default};
