import{j as e,U as k,M,a2 as B,a9 as F,aw as U,m as q,ax as $,s as H,r as c,f as V,_ as z,ay as G,az as O}from"./react-PtMwKKf1.js";import{l as W,k as C,q as J,D as K,E as Q,w as I,m as X,T as S,B as Y,d as v,u as A}from"./firebase-eGIzIftJ.js";import{m as p,u as Z,d as u}from"../index-B745l0NT.js";import"./vendor-B5FTF_2c.js";const ee={payé:"bg-emerald-100 text-emerald-800",preuve_recue:"bg-amber-100 text-amber-800",annulé:"bg-red-100 text-red-800",refusé:"bg-red-100 text-red-800",en_attente:""},se=({reservation:s,onValider:h,onRefuser:d,onSupprimer:f,isLoading:n})=>{var g;return e.jsxs("div",{className:"bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition",children:[e.jsx("div",{className:"grid grid-cols-1",children:e.jsxs("div",{className:"p-4 flex flex-col gap-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2 font-semibold text-slate-800",children:[e.jsx(k,{className:"w-4 h-4 text-slate-400"}),s.nomClient||s.clientNom||"--"]}),e.jsx("p",{className:"text-sm text-slate-500",children:s.telephone||"--"}),s.email&&e.jsx("p",{className:"text-sm text-slate-500",children:s.email}),e.jsx("span",{className:`inline-block text-xs px-2 py-1 rounded-full ${ee[s.statut]}`,children:s.statut.replace("_"," ")})]}),e.jsx("div",{className:"text-right text-xs text-slate-400 font-mono",children:s.referenceCode})]}),e.jsxs("div",{className:"flex justify-between items-center text-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4 text-slate-400"}),e.jsxs("span",{className:"font-semibold",children:[s.depart," → ",s.arrivee]})]}),e.jsxs("div",{className:"text-sm text-slate-500",children:[s.date," à ",s.heure]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-slate-800",children:[e.jsx(B,{className:"w-4 h-4 text-slate-400"}),s.agencyNom||"--"]}),e.jsx("div",{className:"text-sm text-slate-500",children:s.agencyTelephone||"--"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-slate-800",children:[e.jsx(F,{className:"w-4 h-4 text-slate-400"}),e.jsxs("span",{className:"font-semibold",children:[(g=s.montant)==null?void 0:g.toLocaleString()," FCFA"]})]}),e.jsxs("div",{className:"text-sm text-slate-500",children:["Places : ",s.seatsGo,s.seatsReturn?` + ${s.seatsReturn}`:""]})]}),s.preuveMessage&&e.jsxs("div",{className:"text-sm text-slate-600 bg-slate-50 border p-2 rounded",children:[e.jsx("p",{className:"font-medium text-slate-700 mb-1",children:"Message :"}),s.preuveMessage]})]})}),e.jsxs("div",{className:"border-t px-4 py-3 flex flex-wrap gap-2 bg-slate-50 justify-end",children:[s.statut==="preuve_recue"&&e.jsxs(e.Fragment,{children:[e.jsxs(p.button,{disabled:n,whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>h(s.id),className:`px-3 py-2 rounded bg-emerald-600 text-white text-xs flex items-center gap-1 ${n?"opacity-50 cursor-not-allowed":"hover:bg-emerald-700"}`,children:[e.jsx(U,{className:"w-4 h-4"}),n?"...":"Valider"]}),e.jsxs(p.button,{disabled:n,whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>d(s.id),className:`px-3 py-2 rounded bg-red-600 text-white text-xs flex items-center gap-1 ${n?"opacity-50 cursor-not-allowed":"hover:bg-red-700"}`,children:[e.jsx(q,{className:"w-4 h-4"}),n?"...":"Refuser"]})]}),s.preuveUrl&&e.jsxs("a",{href:s.preuveUrl,target:"_blank",rel:"noreferrer",className:"px-3 py-2 rounded border border-gray-300 text-xs text-slate-600 hover:bg-gray-50 flex items-center gap-1",children:[e.jsx($,{className:"w-4 h-4"})," Voir preuve"]}),e.jsxs(p.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>f(s.id),className:"px-3 py-2 rounded text-red-600 text-xs hover:text-red-800 flex items-center gap-1",children:[e.jsx(H,{className:"w-4 h-4"})," Supprimer"]})]})]})},te=8,ie=()=>{const{user:s}=Z(),[h,d]=c.useState([]),[f,n]=c.useState(!1),[g,j]=c.useState(null),[x,E]=c.useState(""),[y,T]=c.useState("preuve_recue"),N=c.useRef(null);c.useRef(Date.now()),c.useEffect(()=>{if(!(s!=null&&s.companyId))return;n(!0),(async()=>{const o=(await W(C(u,"companies",s.companyId,"agences"))).docs.map(i=>i.id).map(i=>J(C(u,"companies",s.companyId,"agences",i,"reservations"),y?I("statut","==",y):I("statut","in",["preuve_recue","payé","annulé","refusé"]),Q("createdAt","desc"),K(te))).map(i=>X(i,D=>{const R=D.docs.map(m=>{const w=m.data();return{id:m.id,...w,agenceId:w.agenceId||w.agencyId||""}});R.filter(m=>m.createdAt instanceof S?S.now().seconds-m.createdAt.seconds<10:!1).length>0&&N.current&&N.current.play().catch(()=>{}),d(R),n(!1)}));return()=>o.forEach(i=>i())})()},[s==null?void 0:s.companyId,y]);const _=async(t,a)=>{if(!a||!(s!=null&&s.companyId))return alert("Aucune agence associée à cette réservation");try{j(t),await A(v(u,"companies",s.companyId,"agences",a,"reservations",t),{statut:"payé",validatedAt:new Date,validatedBy:s.uid}),alert("Réservation validée ✅"),d(l=>l.filter(r=>r.id!==t))}catch(l){console.error("Erreur validation:",l),alert("Une erreur est survenue lors de la validation ❌")}finally{j(null)}},L=async(t,a)=>{if(!a||!(s!=null&&s.companyId))return alert("Aucune agence associée à cette réservation");const l=window.prompt("Raison du refus ?")||"Non spécifié";try{j(t),await A(v(u,"companies",s.companyId,"agences",a,"reservations",t),{statut:"refusé",refusalReason:l,refusedAt:new Date,refusedBy:s.uid}),alert("Réservation refusée ❌"),d(r=>r.filter(o=>o.id!==t))}catch(r){console.error("Erreur refus:",r),alert("Erreur lors du refus")}finally{j(null)}},P=async(t,a)=>{if(!a||!(s!=null&&s.companyId))return alert("Aucune agence associée à cette réservation");if(window.confirm("Supprimer cette réservation ?"))try{await Y(v(u,"companies",s.companyId,"agences",a,"reservations",t)),d(l=>l.filter(r=>r.id!==t))}catch{alert("Erreur lors de la suppression ❌")}},b=h.filter(t=>{var a,l,r,o;return((a=t.nomClient)==null?void 0:a.toLowerCase().includes(x.toLowerCase()))||((l=t.telephone)==null?void 0:l.includes(x))||((r=t.referenceCode)==null?void 0:r.toLowerCase().includes(x.toLowerCase()))||((o=t.email)==null?void 0:o.toLowerCase().includes(x.toLowerCase()))});return e.jsxs("div",{className:"p-4 md:p-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[(s==null?void 0:s.companyLogo)&&e.jsx(V.LazyLoadImage,{src:s.companyLogo,alt:"Logo",effect:"blur",className:"h-10 w-10 rounded border object-cover"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Réservations en ligne"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Preuves de paiement"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 w-full md:w-auto",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(z,{className:"w-4 h-4 text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"Rechercher...",className:"pl-10 pr-4 py-2 border border-gray-300 rounded-lg w-full",value:x,onChange:t=>E(t.target.value)})]}),e.jsxs("select",{value:y,onChange:t=>T(t.target.value),className:"border border-gray-300 rounded-lg px-3 py-2 min-w-[180px]",children:[e.jsx("option",{value:"",children:"Tous les statuts"}),e.jsx("option",{value:"preuve_recue",children:"Preuve reçue"}),e.jsx("option",{value:"payé",children:"Payé"}),e.jsx("option",{value:"annulé",children:"Annulé"}),e.jsx("option",{value:"refusé",children:"Refusé"})]})]})]}),f&&h.length===0&&e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(p.div,{animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"},children:e.jsx(G,{className:"h-8 w-8 text-blue-600"})})}),!f&&b.length===0&&e.jsxs(p.div,{initial:{opacity:0},animate:{opacity:1},className:"bg-white rounded-xl border p-8 text-center",children:[e.jsx(O,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-4 text-lg font-medium text-gray-900",children:"Aucune réservation trouvée"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:b.map(t=>e.jsx(se,{reservation:t,onValider:()=>_(t.id,t.agenceId),onRefuser:()=>L(t.id,t.agenceId),onSupprimer:()=>P(t.id,t.agenceId),isLoading:g===t.id},t.id))})]})};export{ie as default};
