import{c as j,r as f,j as t,a as n,ap as Q,F as G,aq as Y,ar as Z,as as ee,at as te}from"./react-DgrrIcw2.js";import{l as M,k as O}from"./firebase-eGIzIftJ.js";import{u as ae,d as U}from"../index-p6Te0bSg.js";import"./vendor-BHjJ2Hjk.js";var _={exports:{}};(function(u,B){(function(C,x){x()})(j,function(){function C(a,r){return typeof r>"u"?r={autoBom:!1}:typeof r!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),r={autoBom:!r}),r.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob(["\uFEFF",a],{type:a.type}):a}function x(a,r,d){var s=new XMLHttpRequest;s.open("GET",a),s.responseType="blob",s.onload=function(){y(s.response,r,d)},s.onerror=function(){console.error("could not download file")},s.send()}function k(a){var r=new XMLHttpRequest;r.open("HEAD",a,!1);try{r.send()}catch{}return 200<=r.status&&299>=r.status}function p(a){try{a.dispatchEvent(new MouseEvent("click"))}catch{var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),a.dispatchEvent(r)}}var g=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof j=="object"&&j.global===j?j:void 0,F=g.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),y=g.saveAs||(typeof window!="object"||window!==g?function(){}:"download"in HTMLAnchorElement.prototype&&!F?function(a,r,d){var s=g.URL||g.webkitURL,c=document.createElement("a");r=r||a.name||"download",c.download=r,c.rel="noopener",typeof a=="string"?(c.href=a,c.origin===location.origin?p(c):k(c.href)?x(a,r,d):p(c,c.target="_blank")):(c.href=s.createObjectURL(a),setTimeout(function(){s.revokeObjectURL(c.href)},4e4),setTimeout(function(){p(c)},0))}:"msSaveOrOpenBlob"in navigator?function(a,r,d){if(r=r||a.name||"download",typeof a!="string")navigator.msSaveOrOpenBlob(C(a,d),r);else if(k(a))x(a,r,d);else{var s=document.createElement("a");s.href=a,s.target="_blank",setTimeout(function(){p(s)})}}:function(a,r,d,s){if(s=s||open("","_blank"),s&&(s.document.title=s.document.body.innerText="downloading..."),typeof a=="string")return x(a,r,d);var c=a.type==="application/octet-stream",D=/constructor/i.test(g.HTMLElement)||g.safari,v=/CriOS\/[\d]+/.test(navigator.userAgent);if((v||c&&D||F)&&typeof FileReader<"u"){var A=new FileReader;A.onloadend=function(){var h=A.result;h=v?h:h.replace(/^data:[^;]*;/,"data:attachment/file;"),s?s.location.href=h:location=h,s=null},A.readAsDataURL(a)}else{var w=g.URL||g.webkitURL,S=w.createObjectURL(a);s?s.location=S:location.href=S,s=null,setTimeout(function(){w.revokeObjectURL(S)},4e4)}});g.saveAs=y.saveAs=y,u.exports=y})})(_);var ne=_.exports;const ce=()=>{const{user:u}=ae(),[B,C]=f.useState([]),[x,k]=f.useState([]),[p,g]=f.useState(null),[F,y]=f.useState({agences:!0,reservations:!0}),[a,r]=f.useState(!1),[d,s]=f.useState(""),[c,D]=f.useState(""),[v,A]=f.useState(""),[w,S]=f.useState(""),[h,q]=f.useState("tous"),[L,R]=f.useState(1),E=10,X=async()=>{if(u!=null&&u.companyId)try{const i=(await M(O(U,"companies",u.companyId,"agences"))).docs.map(o=>({id:o.id,nom:o.data().ville||o.data().nom}));C(i)}finally{y(e=>({...e,agences:!1}))}},K=async()=>{if(u!=null&&u.companyId)try{const i=(await M(O(U,"companies",u.companyId,"agences"))).docs.map(l=>({id:l.id,nom:l.data().ville||l.data().nom}));C(i);const o=[];for(const l of i){const z=O(U,"companies",u.companyId,"agences",l.id,"reservations"),J=(await M(z)).docs.map(b=>{var H;return{id:b.id,agencyId:l.id,nomClient:b.data().nomClient,telephone:b.data().telephone,montant:b.data().montant||0,canal:b.data().canal||"",statut:b.data().statut,depart:b.data().depart||"",arrivee:b.data().arrivee||"",createdAt:((H=b.data().createdAt)==null?void 0:H.toDate())||null}});o.push(...J)}const m={};o.forEach(l=>{m[l.agencyId]||(m[l.agencyId]=[]),m[l.agencyId].push(l)});const T=Object.keys(m).map(l=>({agencyId:l,reservations:m[l]}));k(T)}finally{y(e=>({...e,reservations:!1}))}};f.useEffect(()=>{X(),K()},[u]);const I=e=>{const i=B.find(o=>o.id===e);return i?i.nom:"Agence inconnue"},N=()=>{var i;let e=((i=x.find(o=>o.agencyId===p))==null?void 0:i.reservations)||[];return d&&(e=e.filter(o=>{var m;return(m=o.depart)==null?void 0:m.toLowerCase().includes(d.toLowerCase())})),c&&(e=e.filter(o=>{var m;return(m=o.arrivee)==null?void 0:m.toLowerCase().includes(c.toLowerCase())})),v&&(e=e.filter(o=>o.createdAt&&new Date(o.createdAt)>=new Date(v))),w&&(e=e.filter(o=>o.createdAt&&new Date(o.createdAt)<=new Date(w))),h!=="tous"&&(e=e.filter(o=>o.canal.toLowerCase()===h.toLowerCase())),e},P=N().slice((L-1)*E,L*E),$=Math.ceil(N().length/E),V=()=>{const e=N();if(e.length===0)return;const i=`Nom,Téléphone,Départ,Arrivée,Canal,Montant,Date
`,o=e.map(l=>[`"${l.nomClient}"`,l.telephone,`"${l.depart}"`,`"${l.arrivee}"`,l.canal,l.montant||0,l.createdAt?new Date(l.createdAt).toLocaleDateString():""].join(",")).join(`
`),m=i+o,T=new Blob([m],{type:"text/csv;charset=utf-8;"});ne.saveAs(T,`reservations-${I(p||"")}-${new Date().toISOString().split("T")[0]}.csv`)},W=N().reduce((e,i)=>e+(i.montant||0),0);return t("div",{className:"min-h-screen bg-gray-50 p-6",children:n("div",{className:"max-w-7xl mx-auto",children:[n("div",{className:"flex justify-between items-center mb-6",children:[t("h1",{className:"text-2xl font-bold text-gray-800",children:"Gestion des Réservations"}),n("div",{className:"flex space-x-2",children:[n("button",{onClick:()=>r(!a),className:"flex items-center px-4 py-2 bg-white border rounded-lg text-gray-700 hover:bg-gray-50",children:[t(Q,{className:"mr-2"}),"Filtres"]}),p&&n(G,{children:[n("button",{onClick:V,disabled:N().length===0,className:"flex items-center px-4 py-2 bg-white border rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50",children:[t(Y,{className:"mr-2"}),"Exporter"]}),n("button",{onClick:()=>window.print(),className:"flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[t(Z,{className:"mr-2"}),"Imprimer"]})]})]})]}),F.agences||F.reservations?t("div",{className:"flex justify-center items-center h-64",children:t("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):n(G,{children:[t("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8",children:x.map(e=>{const i=e.reservations.reduce((o,m)=>o+(m.montant||0),0);return n("div",{onClick:()=>{g(p===e.agencyId?null:e.agencyId),R(1),s(""),D(""),A(""),S("")},className:`p-6 bg-white rounded-xl shadow-sm border transition-all cursor-pointer hover:shadow-md ${p===e.agencyId?"border-blue-500 ring-2 ring-blue-100":"border-gray-200"}`,children:[t("h2",{className:"font-bold text-lg text-gray-800 mb-2",children:I(e.agencyId)}),n("div",{className:"flex justify-between text-sm text-gray-600",children:[n("span",{children:[e.reservations.length," réservations"]}),n("span",{className:"font-medium",children:[i.toLocaleString()," FCFA"]})]}),t("div",{className:"mt-4 h-2 bg-gray-200 rounded-full overflow-hidden",children:t("div",{className:"h-full bg-blue-500",style:{width:`${Math.min(100,e.reservations.length/50*100)}%`}})})]},e.agencyId)})}),p&&n("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[n("div",{className:"p-6 border-b border-gray-200",children:[t("div",{className:"flex justify-between items-center",children:n("h3",{className:"text-xl font-semibold text-gray-800",children:[I(p),n("span",{className:"ml-2 text-sm font-normal text-gray-500",children:["(",N().length," réservations - ",W.toLocaleString()," FCFA)"]})]})}),a&&n("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[n("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Départ"}),t("input",{placeholder:"Filtrer par départ",value:d,onChange:e=>s(e.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),n("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Arrivée"}),t("input",{placeholder:"Filtrer par arrivée",value:c,onChange:e=>D(e.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),n("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date début"}),t("input",{type:"date",value:v,onChange:e=>A(e.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),n("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date fin"}),t("input",{type:"date",value:w,onChange:e=>S(e.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),n("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Canal"}),n("select",{value:h,onChange:e=>q(e.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",children:[t("option",{value:"tous",children:"Tous les canaux"}),t("option",{value:"guichet",children:"Guichet"}),t("option",{value:"en ligne",children:"En ligne"})]})]})]})]}),t("div",{className:"overflow-x-auto",children:n("table",{className:"min-w-full divide-y divide-gray-200",children:[t("thead",{className:"bg-gray-50",children:n("tr",{children:[t("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Client"}),t("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Téléphone"}),t("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Trajet"}),t("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Canal"}),t("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Montant"}),t("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"})]})}),t("tbody",{className:"bg-white divide-y divide-gray-200",children:P.length===0?t("tr",{children:t("td",{colSpan:6,className:"px-6 py-4 text-center text-gray-500",children:Object.values({filterDepart:d,filterArrivee:c,filterStart:v,filterEnd:w,filterCanal:h}).some(Boolean)?"Aucune réservation ne correspond aux filtres":"Aucune réservation trouvée"})}):P.map(e=>{var i;return n("tr",{className:"hover:bg-gray-50",children:[t("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:e.nomClient}),t("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.telephone}),n("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[t("span",{className:"font-medium",children:e.depart})," → ",t("span",{className:"font-medium",children:e.arrivee})]}),t("td",{className:"px-6 py-4 whitespace-nowrap",children:t("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${e.canal==="guichet"?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:e.canal})}),n("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[(i=e.montant)==null?void 0:i.toLocaleString()," FCFA"]}),t("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.createdAt?new Date(e.createdAt).toLocaleDateString("fr-FR"):""})]},e.id)})})]})}),N().length>E&&n("div",{className:"px-6 py-4 border-t border-gray-200 flex items-center justify-between",children:[n("button",{onClick:()=>R(e=>Math.max(1,e-1)),disabled:L===1,className:"flex items-center px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50",children:[t(ee,{className:"mr-1"}),"Précédent"]}),n("span",{className:"text-sm text-gray-700",children:["Page ",L," sur ",$]}),n("button",{onClick:()=>R(e=>e+1),disabled:L===$,className:"flex items-center px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50",children:["Suivant",t(te,{className:"ml-1"})]})]})]})]})]})})};export{ce as default};
