import{c as F,r as p,j as e,am as z,an as J,ao as Q,ap as Y,aq as Z}from"./react-PtMwKKf1.js";import{l as T,k as M}from"./firebase-eGIzIftJ.js";import{u as ee,d as O}from"../index-B745l0NT.js";import"./vendor-B5FTF_2c.js";var H={exports:{}};(function(m,U){(function(A,h){h()})(F,function(){function A(a,s){return typeof s>"u"?s={autoBom:!1}:typeof s!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),s={autoBom:!s}),s.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob(["\uFEFF",a],{type:a.type}):a}function h(a,s,c){var n=new XMLHttpRequest;n.open("GET",a),n.responseType="blob",n.onload=function(){b(n.response,s,c)},n.onerror=function(){console.error("could not download file")},n.send()}function L(a){var s=new XMLHttpRequest;s.open("HEAD",a,!1);try{s.send()}catch{}return 200<=s.status&&299>=s.status}function u(a){try{a.dispatchEvent(new MouseEvent("click"))}catch{var s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),a.dispatchEvent(s)}}var x=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof F=="object"&&F.global===F?F:void 0,S=x.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),b=x.saveAs||(typeof window!="object"||window!==x?function(){}:"download"in HTMLAnchorElement.prototype&&!S?function(a,s,c){var n=x.URL||x.webkitURL,i=document.createElement("a");s=s||a.name||"download",i.download=s,i.rel="noopener",typeof a=="string"?(i.href=a,i.origin===location.origin?u(i):L(i.href)?h(a,s,c):u(i,i.target="_blank")):(i.href=n.createObjectURL(a),setTimeout(function(){n.revokeObjectURL(i.href)},4e4),setTimeout(function(){u(i)},0))}:"msSaveOrOpenBlob"in navigator?function(a,s,c){if(s=s||a.name||"download",typeof a!="string")navigator.msSaveOrOpenBlob(A(a,c),s);else if(L(a))h(a,s,c);else{var n=document.createElement("a");n.href=a,n.target="_blank",setTimeout(function(){u(n)})}}:function(a,s,c,n){if(n=n||open("","_blank"),n&&(n.document.title=n.document.body.innerText="downloading..."),typeof a=="string")return h(a,s,c);var i=a.type==="application/octet-stream",k=/constructor/i.test(x.HTMLElement)||x.safari,y=/CriOS\/[\d]+/.test(navigator.userAgent);if((y||i&&k||S)&&typeof FileReader<"u"){var w=new FileReader;w.onloadend=function(){var g=w.result;g=y?g:g.replace(/^data:[^;]*;/,"data:attachment/file;"),n?n.location.href=g:location=g,n=null},w.readAsDataURL(a)}else{var v=x.URL||x.webkitURL,N=v.createObjectURL(a);n?n.location=N:location.href=N,n=null,setTimeout(function(){v.revokeObjectURL(N)},4e4)}});x.saveAs=b.saveAs=b,m.exports=b})})(H);var te=H.exports;const le=()=>{const{user:m}=ee(),[U,A]=p.useState([]),[h,L]=p.useState([]),[u,x]=p.useState(null),[S,b]=p.useState({agences:!0,reservations:!0}),[a,s]=p.useState(!1),[c,n]=p.useState(""),[i,k]=p.useState(""),[y,w]=p.useState(""),[v,N]=p.useState(""),[g,G]=p.useState("tous"),[C,E]=p.useState(1),D=10,_=async()=>{if(m!=null&&m.companyId)try{const l=(await T(M(O,"companies",m.companyId,"agences"))).docs.map(r=>({id:r.id,nom:r.data().ville||r.data().nom}));A(l)}finally{b(t=>({...t,agences:!1}))}},q=async()=>{if(m!=null&&m.companyId)try{const l=(await T(M(O,"companies",m.companyId,"agences"))).docs.map(o=>({id:o.id,nom:o.data().ville||o.data().nom}));A(l);const r=[];for(const o of l){const V=M(O,"companies",m.companyId,"agences",o.id,"reservations"),W=(await T(V)).docs.map(f=>{var $;return{id:f.id,agencyId:o.id,nomClient:f.data().nomClient,telephone:f.data().telephone,montant:f.data().montant||0,canal:f.data().canal||"",statut:f.data().statut,depart:f.data().depart||"",arrivee:f.data().arrivee||"",createdAt:(($=f.data().createdAt)==null?void 0:$.toDate())||null}});r.push(...W)}const d={};r.forEach(o=>{d[o.agencyId]||(d[o.agencyId]=[]),d[o.agencyId].push(o)});const I=Object.keys(d).map(o=>({agencyId:o,reservations:d[o]}));L(I)}finally{b(t=>({...t,reservations:!1}))}};p.useEffect(()=>{_(),q()},[m]);const R=t=>{const l=U.find(r=>r.id===t);return l?l.nom:"Agence inconnue"},j=()=>{var l;let t=((l=h.find(r=>r.agencyId===u))==null?void 0:l.reservations)||[];return c&&(t=t.filter(r=>{var d;return(d=r.depart)==null?void 0:d.toLowerCase().includes(c.toLowerCase())})),i&&(t=t.filter(r=>{var d;return(d=r.arrivee)==null?void 0:d.toLowerCase().includes(i.toLowerCase())})),y&&(t=t.filter(r=>r.createdAt&&new Date(r.createdAt)>=new Date(y))),v&&(t=t.filter(r=>r.createdAt&&new Date(r.createdAt)<=new Date(v))),g!=="tous"&&(t=t.filter(r=>r.canal.toLowerCase()===g.toLowerCase())),t},B=j().slice((C-1)*D,C*D),P=Math.ceil(j().length/D),X=()=>{const t=j();if(t.length===0)return;const l=`Nom,Téléphone,Départ,Arrivée,Canal,Montant,Date
`,r=t.map(o=>[`"${o.nomClient}"`,o.telephone,`"${o.depart}"`,`"${o.arrivee}"`,o.canal,o.montant||0,o.createdAt?new Date(o.createdAt).toLocaleDateString():""].join(",")).join(`
`),d=l+r,I=new Blob([d],{type:"text/csv;charset=utf-8;"});te.saveAs(I,`reservations-${R(u||"")}-${new Date().toISOString().split("T")[0]}.csv`)},K=j().reduce((t,l)=>t+(l.montant||0),0);return e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Gestion des Réservations"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:()=>s(!a),className:"flex items-center px-4 py-2 bg-white border rounded-lg text-gray-700 hover:bg-gray-50",children:[e.jsx(z,{className:"mr-2"}),"Filtres"]}),u&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:X,disabled:j().length===0,className:"flex items-center px-4 py-2 bg-white border rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50",children:[e.jsx(J,{className:"mr-2"}),"Exporter"]}),e.jsxs("button",{onClick:()=>window.print(),className:"flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(Q,{className:"mr-2"}),"Imprimer"]})]})]})]}),S.agences||S.reservations?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8",children:h.map(t=>{const l=t.reservations.reduce((r,d)=>r+(d.montant||0),0);return e.jsxs("div",{onClick:()=>{x(u===t.agencyId?null:t.agencyId),E(1),n(""),k(""),w(""),N("")},className:`p-6 bg-white rounded-xl shadow-sm border transition-all cursor-pointer hover:shadow-md ${u===t.agencyId?"border-blue-500 ring-2 ring-blue-100":"border-gray-200"}`,children:[e.jsx("h2",{className:"font-bold text-lg text-gray-800 mb-2",children:R(t.agencyId)}),e.jsxs("div",{className:"flex justify-between text-sm text-gray-600",children:[e.jsxs("span",{children:[t.reservations.length," réservations"]}),e.jsxs("span",{className:"font-medium",children:[l.toLocaleString()," FCFA"]})]}),e.jsx("div",{className:"mt-4 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500",style:{width:`${Math.min(100,t.reservations.length/50*100)}%`}})})]},t.agencyId)})}),u&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("h3",{className:"text-xl font-semibold text-gray-800",children:[R(u),e.jsxs("span",{className:"ml-2 text-sm font-normal text-gray-500",children:["(",j().length," réservations - ",K.toLocaleString()," FCFA)"]})]})}),a&&e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Départ"}),e.jsx("input",{placeholder:"Filtrer par départ",value:c,onChange:t=>n(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Arrivée"}),e.jsx("input",{placeholder:"Filtrer par arrivée",value:i,onChange:t=>k(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date début"}),e.jsx("input",{type:"date",value:y,onChange:t=>w(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date fin"}),e.jsx("input",{type:"date",value:v,onChange:t=>N(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Canal"}),e.jsxs("select",{value:g,onChange:t=>G(t.target.value),className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"tous",children:"Tous les canaux"}),e.jsx("option",{value:"guichet",children:"Guichet"}),e.jsx("option",{value:"en ligne",children:"En ligne"})]})]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Client"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Téléphone"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Trajet"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Canal"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Montant"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:B.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-6 py-4 text-center text-gray-500",children:Object.values({filterDepart:c,filterArrivee:i,filterStart:y,filterEnd:v,filterCanal:g}).some(Boolean)?"Aucune réservation ne correspond aux filtres":"Aucune réservation trouvée"})}):B.map(t=>{var l;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:t.nomClient}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.telephone}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[e.jsx("span",{className:"font-medium",children:t.depart})," → ",e.jsx("span",{className:"font-medium",children:t.arrivee})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${t.canal==="guichet"?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:t.canal})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[(l=t.montant)==null?void 0:l.toLocaleString()," FCFA"]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.createdAt?new Date(t.createdAt).toLocaleDateString("fr-FR"):""})]},t.id)})})]})}),j().length>D&&e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>E(t=>Math.max(1,t-1)),disabled:C===1,className:"flex items-center px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50",children:[e.jsx(Y,{className:"mr-1"}),"Précédent"]}),e.jsxs("span",{className:"text-sm text-gray-700",children:["Page ",C," sur ",P]}),e.jsxs("button",{onClick:()=>E(t=>t+1),disabled:C===P,className:"flex items-center px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50",children:["Suivant",e.jsx(Z,{className:"ml-1"})]})]})]})]})]})})};export{le as default};
