import{r as o,j as r}from"./react-PtMwKKf1.js";import{k as $,A as te,T as ae,l as G,d as k,f as ne,t as oe,q as ie,u as J,B as ce}from"./firebase-eGIzIftJ.js";import{d as f,u as le}from"../index-B745l0NT.js";import{E as de}from"./jspdf.es.min-CVY3qeSi.js";import{a as pe}from"./jspdf.plugin.autotable-CtA5BUKo.js";import"./vendor-B5FTF_2c.js";const me=async(s,c,u,m,l,i,d)=>{try{const p=$(f,"companies",s,"agences",d,"weeklyTrips");return(await te(p,{departure:c,arrival:u,price:m,horaires:l,places:i,active:!0,createdAt:ae.now()})).id}catch(p){throw console.error("Erreur lors de la cr√©ation du trajet hebdomadaire :",p),p}},U=({label:s,value:c,onChange:u})=>{const[m,l]=o.useState([]);return o.useEffect(()=>{(async()=>{const p=(await G($(f,"villes"))).docs.map(b=>b.data().nom);l(p)})()},[]),r.jsxs("div",{children:[r.jsx("label",{className:"block font-medium mb-1",children:s}),r.jsx("input",{list:"liste-villes",className:"w-full border px-3 py-2 rounded",value:c,onChange:i=>u(i.target.value),placeholder:"Entrer une ville"}),r.jsx("datalist",{id:"liste-villes",children:m.map((i,d)=>r.jsx("option",{value:i},d))})]})},ue=async(s,c)=>{const u=l=>l.trim().toLowerCase().replace(/\s+/g," ").replace(/\b\w/g,i=>i.toUpperCase()),m=[s,c].map(u);for(const l of m){const i=k(f,"villes",l);(await ne(i)).exists()||await oe(i,{nom:l})}},B=["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"],je=()=>{const{user:s,company:c}=le(),[u,m]=o.useState(""),[l,i]=o.useState(""),[d,p]=o.useState(""),[b,A]=o.useState(""),[E,v]=o.useState({}),[D,h]=o.useState(""),[y,j]=o.useState(!1),[P,O]=o.useState([]),[M,W]=o.useState(null),[w,z]=o.useState(null),[I,_]=o.useState(""),[V,he]=o.useState(""),[F,K]=o.useState(1),H=10,L={primary:(c==null?void 0:c.couleurPrimaire)||"#06b6d4",secondary:(c==null?void 0:c.couleurSecondaire)||"#8b5cf6"};o.useEffect(()=>{R()},[s,F,I,V]);const R=async()=>{if(!(s!=null&&s.companyId)||!(s!=null&&s.agencyId))return;const e=ie($(f,"companies",s.companyId,"agences",s.agencyId,"weeklyTrips")),S=(await G(e)).docs.map(x=>({id:x.id,...x.data()})).sort((x,T)=>{var N,q;return(((N=T.createdAt)==null?void 0:N.seconds)||0)-(((q=x.createdAt)==null?void 0:q.seconds)||0)}).filter(x=>{var T,N;return(x.departure.toLowerCase().includes(I.toLowerCase())||x.arrival.toLowerCase().includes(I.toLowerCase()))&&(V===""||((N=(T=x.horaires)==null?void 0:T[V])==null?void 0:N.length)>0)}).slice((F-1)*H,F*H);O(S)},Q=async e=>{if(!(!(s!=null&&s.companyId)||!(s!=null&&s.agencyId))&&confirm("Voulez-vous vraiment supprimer ce trajet ?")){j(!0);try{await ce(k(f,"companies",s.companyId,"agences",s.agencyId,"weeklyTrips",e)),R(),h("üóëÔ∏è Trajet supprim√© avec succ√®s.")}catch(t){console.error(t),h("‚ùå Erreur lors de la suppression du trajet.")}finally{j(!1)}}},X=(e,t,a)=>{v(n=>{const g={...n};return g[e]||(g[e]=[]),g[e][t]=a,g})},Y=e=>{v(t=>({...t,[e]:[...t[e]||[],""]}))},Z=(e,t)=>{v(a=>{const n={...a};return n[e]?(n[e].splice(t,1),n):a})},C=e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase(),ee=()=>{m(""),i(""),p(""),A(""),v({}),z(null)},se=()=>{const e=new de;e.text("Liste des trajets",14,14),pe(e,{head:[["D√©part","Arriv√©e","Prix","Places"]],body:P.map(t=>[t.departure,t.arrival,`${t.price} FCFA`,t.places||""])}),e.save("trajets_agence.pdf")},re=async()=>{if(!(s!=null&&s.companyId)||!(s!=null&&s.agencyId))return h("‚ùå Agence non reconnue. Reconnectez-vous.");j(!0),h("");const e={};for(const n in E){const g=E[n].filter(S=>S&&S.trim()!=="");g.length>0&&(e[n]=g)}const t=C(u.trim()),a=C(l.trim());if(!t||!a||!d.trim()||!b.trim()||Object.keys(e).length===0)return j(!1),h("‚ö†Ô∏è Tous les champs sont obligatoires (d√©part, arriv√©e, prix, places et au moins un horaire).");try{if(w)await J(k(f,"companies",s.companyId,"agences",s.agencyId,"weeklyTrips",w),{departure:t,arrival:a,price:parseInt(d),places:parseInt(b),horaires:e}),h("‚úÖ Trajet modifi√© avec succ√®s.");else{const n=await me(s.companyId,t,a,parseInt(d),e,parseInt(b),s.agencyId);await ue(t,a),h("‚úÖ Trajet ajout√© avec succ√®s !")}ee(),R()}catch(n){console.error("Erreur Firebase:",n),h("‚ùå Erreur lors de l'enregistrement. V√©rifiez la console.")}finally{j(!1)}};return r.jsxs("div",{className:"min-h-screen bg-gray-50 p-6 text-gray-800",children:[r.jsxs("div",{className:"mb-8 p-6 rounded-xl bg-white shadow-md border border-gray-200 flex justify-between items-center",children:[r.jsx("h1",{className:"text-3xl font-bold",style:{color:L.primary},children:"Gestion des Trajets"}),r.jsx("button",{onClick:se,className:"px-6 py-2 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition-all",style:{background:`linear-gradient(to right, ${L.primary}, ${L.secondary})`},children:"üìÑ Exporter la liste"})]}),r.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[r.jsxs("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-6",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:w?"Modifier le trajet":"Ajouter un trajet"}),r.jsx(U,{label:"Ville de d√©part",value:u,onChange:m}),r.jsx(U,{label:"Ville d'arriv√©e",value:l,onChange:i}),r.jsx("input",{type:"number",placeholder:"Prix (FCFA)",value:d,onChange:e=>p(e.target.value),className:"border p-2 w-full rounded mb-3"}),r.jsx("input",{type:"number",placeholder:"Nombre de places",value:b,onChange:e=>A(e.target.value),className:"border p-2 w-full rounded mb-4",min:"1"}),B.map(e=>r.jsxs("div",{className:"mb-2",children:[r.jsxs("p",{className:"font-semibold",children:[C(e)," :"]}),(E[e]||[]).map((t,a)=>r.jsxs("div",{className:"flex gap-2 my-1",children:[r.jsx("input",{type:"time",value:t,onChange:n=>X(e,a,n.target.value),className:"border p-1 rounded"}),r.jsx("button",{type:"button",onClick:()=>Z(e,a),className:"text-red-600",children:"√ó"})]},a)),r.jsx("button",{type:"button",onClick:()=>Y(e),className:"bg-blue-500 hover:bg-blue-700 text-white px-2 py-1 rounded mt-1 text-sm",children:"+ Ajouter un horaire"})]},e)),r.jsx("button",{onClick:re,disabled:y,className:`mt-4 px-4 py-2 rounded text-white ${w?"bg-yellow-600 hover:bg-yellow-700":"bg-green-600 hover:bg-green-700"}`,children:y?"‚è≥ En cours...":w?"Mettre √† jour":"Enregistrer le trajet"}),D&&r.jsx("p",{className:`mt-2 p-2 rounded ${D.includes("‚ùå")?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:D})]}),r.jsxs("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-6",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Liste des trajets"}),r.jsx("input",{type:"text",placeholder:"Rechercher par ville...",value:I,onChange:e=>{_(e.target.value),K(1)},className:"border p-2 w-full rounded mb-4"}),P.length>0?P.map(e=>r.jsxs("div",{className:"border rounded p-3 mb-2 shadow hover:shadow-md transition-shadow",children:[r.jsxs("div",{className:`cursor-pointer font-semibold flex justify-between items-center ${e.active?"text-green-700":"text-red-500"}`,onClick:()=>W(M===e.id?null:e.id),children:[r.jsxs("span",{children:[e.departure," ‚Üí ",e.arrival," ‚Ä¢ ",e.price," FCFA"]}),r.jsx("span",{className:"text-xs bg-gray-100 px-2 py-1 rounded",children:e.active?"üü¢ Actif":"üî¥ Inactif"})]}),M===e.id&&r.jsxs("div",{className:"mt-2 text-sm space-y-2",children:[r.jsxs("p",{children:[r.jsx("strong",{children:"Places :"})," ",e.places||"Non sp√©cifi√©"]}),B.map(t=>{var n;const a=(n=e.horaires)==null?void 0:n[t];return a!=null&&a.length?r.jsxs("p",{className:"ml-2",children:[C(t)," : ",a.sort().join(", ")]},t):null}),r.jsxs("div",{className:"mt-3 flex gap-2",children:[r.jsx("button",{onClick:()=>Q(e.id),disabled:y,className:"bg-red-600 hover:bg-red-800 text-white px-3 py-1 rounded text-sm",children:"Supprimer"}),r.jsx("button",{onClick:()=>{z(e.id),m(e.departure),i(e.arrival),p(e.price.toString()),A((e.places||"").toString()),v(e.horaires)},disabled:y,className:"bg-yellow-500 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm",children:"Modifier"}),r.jsx("button",{onClick:()=>{if(!(s!=null&&s.companyId)||!(s!=null&&s.agencyId)){alert("Votre session a expir√©. Merci de vous reconnecter.");return}J(k(f,"companies",s.companyId,"agences",s.agencyId,"weeklyTrips",e.id),{active:!e.active})},disabled:y,className:`px-3 py-1 rounded text-white text-sm ${e.active?"bg-gray-600 hover:bg-gray-800":"bg-green-600 hover:bg-green-800"}`,children:e.active?"D√©sactiver":"Activer"})]})]})]},e.id)):r.jsx("div",{className:"text-gray-500 italic p-4 border rounded text-center",children:y?"Chargement...":"Aucun trajet disponible"})]})]})]})};export{je as default};
