import{r as h,b as de,j as e,a as m,n as W,J as ae,aI as ue,ab as me,Q as re,a1 as ge,d as he,T as fe}from"./react-KXT1Riez.js";import{d as V,u as pe,e as ve}from"../index-CBC3XRHi.js";import{o as xe,q as ye,r as B,t as X,D as Q,T as Z,u as ie,w as ee}from"./firebase-DYTOaTLw.js";import{S as be,C as R,a as L,b as z,c as F}from"./skeleton-CKJa9pMg.js";import{R as Ne,X as we,Y as te,T as Ae,j as Ce}from"./generateCategoricalChart-BbxwyVEQ.js";import{C as De}from"./CartesianGrid-Cw598Xwk.js";import{a as ne,L as Se}from"./LineChart-BQT43Qvh.js";import"./vendor-B27hBV_J.js";import"./clsx-B-dksMZM.js";function $e(s){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"XOF",maximumFractionDigits:0}).format(s||0)}function U(s){return(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/-/g," ").trim()}function J(s){return(s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}function Te(s){const c=J(s);return c==="paye"||c==="paid"||c==="payed"}function O(s){const c=s.getFullYear(),g=String(s.getMonth()+1).padStart(2,"0"),p=String(s.getDate()).padStart(2,"0");return`${c}-${g}-${p}`}function se(s){try{if(!s)return null;if(s instanceof Date)return s;if(typeof(s==null?void 0:s.toDate)=="function")return s.toDate();if(typeof s=="string"){const c=new Date(s);return isNaN(c.getTime())?null:c}return null}catch{return null}}const ke=["reservations","reservation","bookings","reserves","resas"];async function Ee(s,c){const g=[];for(const p of ke){g.push(p);const d=X(V,`companies/${s}/agences/${c}/${p}`);try{return console.log("‚ñ∂ Test chemin:",`companies/${s}/agences/${c}/${p}`),await ie(B(d)),{ref:d,nameTried:g}}catch(v){console.warn(`‚ö†Ô∏è Chemin refus√© (${p}) ‚Üí`,(v==null?void 0:v.message)||v);continue}}return{ref:null,nameTried:g}}function Me({companyId:s,dateFrom:c,dateTo:g}){const[p,d]=h.useState(!0),[v,y]=h.useState(null),[C,T]=h.useState([]),[N,A]=h.useState([]);h.useEffect(()=>{if(!s)return;console.log("üè¢ Dashboard companyId =",s);const a=xe(V,`companies/${s}`);ye(a).then(n=>y({id:s,...n.data()})).catch(n=>{console.error("‚úñ get company meta:",n)})},[s]),h.useEffect(()=>{if(!s)return;const a=B(X(V,`companies/${s}/agences`));console.log("üì° Listen agences:",`companies/${s}/agences`);const n=Q(a,t=>{const o=t.docs.map(r=>({id:r.id,nom:r.data().nom||r.id,ville:r.data().ville}));console.log("‚úÖ Agencies size:",o.length,o.map(r=>r.id)),T(o)},t=>console.error("‚úñ onSnapshot agences:",t));return()=>n()},[s]),h.useEffect(()=>{if(!s)return;d(!0);const a=Z.fromDate(c),n=Z.fromDate(g);let t=!1;const o=[];return(async()=>{try{const u=(await ie(X(V,`companies/${s}/agences`))).docs.map(D=>D.id);if(console.log("üìÑ Agences trouv√©es:",u.length,u),u.length===0){t||(A([]),d(!1));return}const l=[];let w=0;for(const D of u){const{ref:P,nameTried:H}=await Ee(s,D);if(!P){console.error("‚úñ Impossible d'ouvrir une sous-collection de r√©servations pour",D," (essay√©:",H.join(", "),")"),w+=1,w===u.length&&!t&&(A(l),d(!1));continue}const K=B(P,ee("createdAt",">=",a),ee("createdAt","<=",n));console.log("üì° Listen r√©servations:",P.path);const f=Q(K,b=>{const oe=b.docs.map(S=>{const x=S.data();return{id:S.id,agencyId:D,agenceId:D,agencyNom:x.agencyNom,agencyVille:x.agencyVille,depart:x.depart,arrival:x.arrival,departNormalized:x.departNormalized,arrivee:x.arrivee,date:x.date,heure:x.heure,canal:x.canal,statut:x.statut,montant:x.montant||0,seatsGo:x.seatsGo||1,clientPhone:x.clientPhone,clientId:x.clientId,createdAt:x.createdAt}}),ce=l.filter(S=>S.agencyId!==D&&S.agenceId!==D);l.splice(0,l.length,...ce,...oe);const le=l.filter(S=>{const x=se(S.createdAt)??(S.date?new Date(`${S.date}T${S.heure||"00:00"}:00`):null);return x?x>=c&&x<=g:!1});t||A(le)},b=>{console.error(`‚úñ onSnapshot r√©servations (${P.path}):`,b)});o.push(f),w+=1}}catch(r){console.error("‚úñ Dashboard attach error:",r)}finally{t||d(!1)}})(),()=>{t=!0,o.forEach(r=>r())}},[s,c.getTime(),g.getTime()]);const i=h.useMemo(()=>N.filter(a=>Te(a.statut)),[N]),k=C.length,j=h.useMemo(()=>{const a=new Map;return C.forEach(n=>a.set(n.id,{id:n.id,nom:n.nom,ville:n.ville,reservations:0,revenus:0})),i.forEach(n=>{const t=n.agencyId||n.agenceId;if(!t)return;const o=a.get(t)||{id:t,nom:n.agencyNom||t,ville:n.agencyVille,reservations:0,revenus:0};o.reservations+=n.seatsGo||1,o.revenus+=n.montant||0,a.set(t,o)}),Array.from(a.values()).sort((n,t)=>t.revenus-n.revenus)},[C,i]);h.useMemo(()=>{const a=new Set;return i.forEach(n=>{n.clientId?a.add("id:"+n.clientId):n.clientPhone&&a.add("tel:"+n.clientPhone)}),a.size},[i]);const G=h.useMemo(()=>{const a=new Set;return i.forEach(n=>{const t=U(n.depart||n.departNormalized),o=U(n.arrival||n.arrivee);t&&a.add(t),o&&a.add(o)}),a.size},[i]),I=h.useMemo(()=>{const a=new Map;return i.forEach(n=>{const t=J(n.canal),o=t.includes("ligne")||t==="online"||t==="web"?"En ligne":t.includes("guichet")?"Guichet":"Autres";a.set(o,(a.get(o)||0)+1)}),Array.from(a).map(([n,t])=>({name:n,value:t})).sort((n,t)=>t.value-n.value)},[i]),$=h.useMemo(()=>{const a=new Map;return N.forEach(n=>{const t=J(n.statut)||"‚Äî";a.set(t,(a.get(t)||0)+1)}),Array.from(a).map(([n,t])=>({name:n,value:t}))},[N]),E=h.useMemo(()=>{const a=i.reduce((f,b)=>f+(b.montant||0),0),n="vs p√©riode pr√©c√©dente",t=i.length,o=new Set;i.forEach(f=>{f.clientId?o.add(`id:${f.clientId}`):f.clientPhone&&o.add(`tel:${f.clientPhone}`)});const r=o.size;i.reduce((f,b)=>f+(b.seatsGo||1),0);const u="N/A",l=new Set;i.forEach(f=>{const b=f.agencyId||f.agenceId;b&&l.add(b)});const w=I.reduce((f,b)=>f+b.value,0),D=I.filter(f=>f.name==="En ligne").reduce((f,b)=>f+b.value,0),P=I.filter(f=>f.name==="Guichet").reduce((f,b)=>f+b.value,0),H=w?Math.round(D/w*100):0,K=w?Math.round(P/w*100):0;return{caPeriode:a,caPeriodeFormatted:$e(a),caDeltaText:n,reservationsCount:t,clientsUniques:r,agencesActives:l.size,totalAgences:k,villesCouvertes:G,tauxRemplissageText:u,parCanal:I,parStatut:$,partEnLigne:H,partGuichet:K}},[i,k,G,I,$]),M=h.useMemo(()=>{const a=new Map;for(let t=new Date(c);t<=g;t.setDate(t.getDate()+1))a.set(O(t),{reservations:0,revenue:0});return i.forEach(t=>{const o=se(t.createdAt)??(t.date?new Date(`${t.date}T${t.heure||"00:00"}:00`):new Date),r=O(o),u=a.get(r)||{reservations:0,revenue:0};u.reservations+=t.seatsGo||1,u.revenue+=t.montant||0,a.set(r,u)}),{daily:Array.from(a).map(([t,o])=>({date:t,reservations:o.reservations,revenue:o.revenue}))}},[i,c.getTime(),g.getTime()]),Y=h.useMemo(()=>{const a=new Map;return i.forEach(n=>{const t=U(n.depart||n.departNormalized),o=U(n.arrival||n.arrivee);if(!t||!o)return;const r=`${t} ‚Üí ${o}`,u=a.get(r)||{reservations:0,revenus:0};u.reservations+=n.seatsGo||1,u.revenus+=n.montant||0,a.set(r,u)}),Array.from(a).map(([n,t])=>({trajet:n,reservations:t.reservations,revenus:t.revenus})).sort((n,t)=>t.reservations-n.reservations).slice(0,12)},[i]),_=h.useMemo(()=>{var r,u;const a=[],n=((r=$.find(l=>l.name.includes("attente")))==null?void 0:r.value)||0;n>50&&a.push({level:"warning",message:`${n} r√©servations en attente`});const t=((u=$.find(l=>l.name.includes("preuve")))==null?void 0:u.value)||0;t>0&&a.push({level:"info",message:`${t} preuve(s) re√ßue(s) √† valider`});const o=j.filter(l=>l.reservations===0);return o.length>0&&a.push({level:"warning",message:`${o.length} agence(s) sans vente`}),a},[j,$]);function q(a){const t=[["id","agencyId","date","heure","depart","arrivee","montant","canal","statut","seatsGo","clientPhone"].join(",")].concat(a.map(l=>[l.id,l.agencyId||l.agenceId||"",l.date||"",l.heure||"",l.depart||l.departNormalized||"",l.arrival||l.arrivee||"",String(l.montant||0),l.canal||"",l.statut||"",String(l.seatsGo||1),l.clientPhone||""].map(w=>`"${String(w).replace(/"/g,'""')}"`).join(","))).join(`
`),o=new Blob([t],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(o),u=document.createElement("a");u.href=r,u.download=`reservations_${O(c)}_${O(g)}.csv`,u.click(),URL.revokeObjectURL(r)}return{loading:p,company:v,kpis:E,series:M,perAgency:j,topTrajets:Y,alerts:_,rawReservations:N,exportCSV:q}}const Ie=({items:s,couleurPrimaire:c="#f97316",couleurSecondaire:g="#fb923c",loading:p=!1})=>{const d=de();return p?e("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:Array.from({length:5}).map((v,y)=>e(be,{className:"h-20 rounded-xl"},y))}):e("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:s.map(({icon:v,label:y,value:C,sub:T,to:N},A)=>{const i=m("div",{className:"p-4 rounded-xl shadow-sm bg-white border border-gray-100 flex flex-col gap-2 transition hover:shadow-md hover:-translate-y-0.5",style:{borderTop:`3px solid ${c}`},children:[m("div",{className:"flex items-center gap-2 text-gray-700",children:[e(v,{size:20,style:{color:c},className:"flex-shrink-0"}),e("span",{className:"font-medium text-sm",children:y})]}),e("div",{className:"text-2xl font-bold",style:{color:c},children:C}),T&&e("div",{className:"text-xs text-gray-500",style:{color:g},children:T})]},A);return N?e("button",{onClick:()=>d(N),className:"text-left focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-xl transition",style:{boxShadow:"none"},children:i},A):i})})},Re=({range:s,setRange:c,customStart:g,setCustomStart:p,customEnd:d,setCustomEnd:v})=>m("div",{className:"flex flex-wrap gap-2 items-center",children:[[{key:"day",label:"Jour"},{key:"month",label:"Mois en cours"},{key:"prev_month",label:"Mois pr√©c√©dent"},{key:"ytd",label:"Depuis janvier"},{key:"12m",label:"12 derniers mois"},{key:"custom",label:"Personnalis√©"}].map(y=>e("button",{onClick:()=>c(y.key),className:`px-3 py-1 text-sm rounded-full border transition ${s===y.key?"bg-orange-600 text-white border-orange-600":"bg-white text-gray-700 hover:bg-gray-100 border-gray-300"}`,children:y.label},y.key)),s==="custom"&&m("div",{className:"flex items-center gap-2",children:[m("div",{className:"flex items-center gap-1",children:[e(W,{className:"h-4 w-4 text-gray-500"}),e("input",{type:"date",value:g||"",onChange:y=>p(y.target.value||null),className:"border rounded px-2 py-1 text-sm"})]}),e("span",{className:"text-gray-500",children:"‚Üí"}),m("div",{className:"flex items-center gap-1",children:[e(W,{className:"h-4 w-4 text-gray-500"}),e("input",{type:"date",value:d||"",onChange:y=>v(y.target.value||null),className:"border rounded px-2 py-1 text-sm"})]})]})]});function Le({data:s,loading:c}){return c?e("div",{className:"h-72 flex items-center justify-center text-sm text-muted-foreground",children:"Chargement‚Ä¶"}):!s||s.length===0?e("div",{className:"h-72 flex items-center justify-center text-sm text-muted-foreground",children:"Aucune donn√©e sur la p√©riode."}):e("div",{className:"h-72",children:e(Ne,{width:"100%",height:"100%",children:m(Se,{data:s,margin:{top:10,right:18,bottom:0,left:0},children:[e(De,{strokeDasharray:"3 3"}),e(we,{dataKey:"date",tick:{fontSize:12}}),e(te,{yAxisId:"left",tick:{fontSize:12}}),e(te,{yAxisId:"right",orientation:"right",tick:{fontSize:12}}),e(Ae,{}),e(Ce,{}),e(ne,{yAxisId:"left",type:"monotone",dataKey:"revenue",name:"Chiffre d‚Äôaffaires",stroke:"#ef4444",strokeWidth:2,dot:!1,activeDot:{r:4}}),e(ne,{yAxisId:"right",type:"monotone",dataKey:"reservations",name:"R√©servations",stroke:"#3b82f6",strokeWidth:2,dot:!1,activeDot:{r:4}})]})})})}const ze=({totalAgencies:s,healthyAgencies:c,atRiskAgencies:g,trend:p})=>{const d={up:{label:"Tendance positive",icon:e(re,{className:"h-4 w-4 text-emerald-600"}),color:"text-emerald-700"},down:{label:"Tendance n√©gative",icon:e(me,{className:"h-4 w-4 text-red-600"}),color:"text-red-700"},stable:{label:"Tendance stable",icon:e(ue,{className:"h-4 w-4 text-gray-500"}),color:"text-gray-700"}}[p];return m(F,{children:[e(L,{children:e(R,{children:"Sant√© du r√©seau"})}),m(z,{children:[m("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[m("div",{className:"flex items-center gap-3",children:[e(ae,{className:"h-5 w-5 text-gray-600"}),m("div",{children:[e("div",{className:"text-sm text-gray-500",children:"Agences actives"}),e("div",{className:"text-lg font-semibold",children:s})]})]}),m("div",{children:[e("div",{className:"text-sm text-gray-500",children:"Agences performantes"}),e("div",{className:"text-lg font-semibold text-emerald-700",children:c})]}),m("div",{children:[e("div",{className:"text-sm text-gray-500",children:"Agences √† risque"}),e("div",{className:"text-lg font-semibold text-red-700",children:g})]})]}),m("div",{className:`mt-4 flex items-center gap-2 text-sm ${d.color}`,children:[d.icon,e("span",{children:d.label})]})]})]})},Fe=({alerts:s=[],loading:c=!1})=>{const g=d=>{var N,A,i;const v=["ca","chiffre","revenu","financier","argent","perte","bloc","arr√™t","panne","interruption","syst√®me","critique","urgence","important","grave","anomalie","s√©curit√©","violation","erreur"],y=((N=d.title)==null?void 0:N.toLowerCase())||"",C=((A=d.description)==null?void 0:A.toLowerCase())||"",T=((i=d.type)==null?void 0:i.toLowerCase())||"";return v.some(k=>y.includes(k)||C.includes(k)||T.includes(k)||d.level==="high"||d.severity==="high")},p=s.filter(g);return c?m(F,{children:[e(L,{children:e(R,{children:"Alertes critiques"})}),e(z,{children:e("div",{className:"text-sm text-gray-500",children:"Chargement des alertes..."})})]}):p.length===0?m(F,{children:[e(L,{children:e(R,{children:"Alertes critiques"})}),e(z,{children:e("div",{className:"text-sm text-gray-500",children:"‚úÖ Aucune alerte critique d√©tect√©e."})})]}):m(F,{children:[e(L,{children:e(R,{children:"Alertes critiques n√©cessitant d√©cision"})}),e(z,{className:"space-y-3",children:p.map((d,v)=>m("div",{className:"flex items-start gap-3 p-3 rounded-lg border border-red-200 bg-red-50",children:[e(ge,{className:"h-5 w-5 text-red-600 mt-0.5 flex-shrink-0"}),m("div",{className:"flex-1",children:[e("div",{className:"font-medium text-red-700",children:d.title}),d.description&&e("div",{className:"text-sm text-red-600 mt-1",children:d.description}),d.date&&e("div",{className:"text-xs text-red-400 mt-1",children:d.date})]})]},d.id||`alert-${v}`))})]})},Pe="month";function Ke(){const{user:s}=pe(),{companyId:c}=he(),g=c??(s==null?void 0:s.companyId)??"",{setHeader:p,resetHeader:d}=ve();h.useEffect(()=>(p({title:"Dashboard Compagnie"}),()=>d()),[p,d]);const[v,y]=h.useState(Pe),[C,T]=h.useState(null),[N,A]=h.useState(null),[i,k]=h.useState(new Date);h.useEffect(()=>{const r=setInterval(()=>k(new Date),6e4);return()=>clearInterval(r)},[]);const{dateFrom:j,dateTo:G,periodLabel:I}=h.useMemo(()=>{const r=new Date(i.getFullYear(),i.getMonth(),i.getDate(),23,59,59);let u=new Date(i.getFullYear(),i.getMonth(),1),l=r;v==="day"&&(u=new Date(i.getFullYear(),i.getMonth(),i.getDate(),0,0,0),l=new Date(i.getFullYear(),i.getMonth(),i.getDate(),23,59,59));const w=new Intl.DateTimeFormat("fr-FR",{month:"long",year:"numeric"}).format(u);return{dateFrom:u,dateTo:l,periodLabel:w}},[v,C,N,i]);if(!g)return m("div",{className:"p-6",children:[e("h1",{className:"text-xl font-semibold mb-2",children:"Dashboard Compagnie"}),e("p",{className:"text-sm text-muted-foreground",children:"Company ID introuvable."})]});const{loading:$,company:E,kpis:M,series:Y,perAgency:_,alerts:q}=Me({companyId:g,dateFrom:j,dateTo:G}),a=_??[],n=a.filter(r=>(r.revenus??0)>0).length,t=a.filter(r=>(r.revenus??0)===0).length,o=(q==null?void 0:q.map((r,u)=>({id:r.id??`alert-${u}`,title:r.title??"Alerte",description:r.description,level:r.level??"medium"})))??[];return m("div",{className:"space-y-5 p-4 md:p-6",children:[m("div",{className:"flex justify-between items-center",children:[m("div",{children:[e("h2",{className:"text-2xl font-bold",children:"R√©servations"}),m("p",{className:"text-sm text-muted-foreground",children:["P√©riode : ",I]})]}),e(Re,{range:v,setRange:y,customStart:C,setCustomStart:T,customEnd:N,setCustomEnd:A})]}),e(Ie,{loading:$,couleurPrimaire:E==null?void 0:E.couleurPrimaire,couleurSecondaire:E==null?void 0:E.couleurSecondaire,items:[{icon:re,label:"CA",value:M.caPeriodeFormatted,sub:M.caDeltaText,to:`/compagnie/${g}/reservations`},{icon:fe,label:"Billets vendus",value:String(M.reservationsCount||0),sub:"Tous canaux",to:`/compagnie/${g}/reservations`},{icon:ae,label:"Agences actives",value:String(M.agencesActives),sub:`${M.totalAgences} au total`,to:`/compagnie/${g}/agences`}]}),m(F,{children:[e(L,{children:e(R,{children:"√âvolution"})}),e(z,{children:e(Le,{data:Y.daily,loading:$})})]}),m(F,{children:[e(L,{children:e(R,{children:"Sant√© du r√©seau"})}),e(z,{children:e(ze,{totalAgencies:M.totalAgences,healthyAgencies:n,atRiskAgencies:t,trend:"stable"})})]}),m(F,{children:[e(L,{children:e(R,{children:"Alertes critiques"})}),e(z,{children:e(Fe,{alerts:o,loading:$})})]})]})}export{Ke as default};
