import{r,j as e,a as n,au as X,C as q,X as z,Y as H,T as J,L as Q,av as U,f as V,v as W}from"./vendor-Bq-8_m9i.js";import{m as Z,P as _,w as ee,G as te,O as p,l as ae,d as y}from"./agence-Bsj2lp2X.js";import{u as N,t as E,M as se}from"./firebase-CURBI7X6.js";import"./compagnie-DiuZFnHS.js";import"./router-DoGdw-3y.js";import"./icons-C0JHUK9Z.js";import"./courier-CoQgRaHG.js";const ne=new Intl.NumberFormat("fr-FR"),ue=()=>{const h=Z(),[A,v]=r.useState(!0),[w,C]=r.useState(null),[F,P]=r.useState(0),[c,B]=r.useState(""),[m,L]=r.useState(""),[l,I]=r.useState({totalCommission:0,subscriptionRevenue:0,totalPlatformRevenue:0,commissionByMonth:[]});return r.useEffect(()=>{(async()=>{v(!0),C(null);try{const g=await N(E(y,"companies")),O=await N(E(y,"plans")),D={};O.docs.forEach(a=>{const s=a.data();D[a.id]=Number(s.priceMonthly)||0});let f=0;g.docs.forEach(a=>{const s=a.data(),d=s.planId||"",o=D[d];o&&o>0&&s.status!=="inactif"&&(f+=o)});const Y=await N(se(y,"reservations")),j=a=>Number.isFinite(Number(a))?Number(a):0;let x=0;const b={},i=new Date,k=new Date(i.getFullYear(),i.getMonth()-5,1),K=new Date(i.getFullYear(),i.getMonth(),i.getDate()),G=c?new Date(c):k,T=m?new Date(m):K;Y.docs.forEach(a=>{var u,R,M;const s=a.data(),d=j(s.commission),o=((R=(u=s.createdAt)==null?void 0:u.toDate)==null?void 0:R.call(u))??((M=s.createdAt)!=null&&M.seconds?new Date(s.createdAt.seconds*1e3):null);if(!o||o<G||o>T)return;x+=d;const S=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}`;b[S]=(b[S]||0)+d});const $=Object.entries(b).sort(([a],[s])=>a.localeCompare(s)).map(([a,s])=>({month:a,commission:s}));I({totalCommission:x,subscriptionRevenue:f,totalPlatformRevenue:x+f,commissionByMonth:$})}catch(g){console.error(g),C(h?"Erreur lors du chargement des finances.":"Connexion indisponible. Impossible de charger les finances.")}finally{v(!1)}})()},[c,m,h,F]),A?e(_,{}):n("div",{className:"p-6 space-y-6",children:[!h&&e(ee,{message:"Connexion instable: les chiffres peuvent être incomplets."}),w&&e(te,{message:w,onRetry:()=>P(t=>t+1)}),e("h1",{className:"text-2xl font-bold mb-4",children:"Finances Teliya – Revenus plateforme"}),e("p",{className:"text-gray-600 text-sm",children:"Commission et revenus d'abonnement uniquement. Aucun détail par compagnie."}),n("div",{className:"mb-6 flex flex-wrap gap-4 items-center",children:[n("label",{className:"flex items-center gap-2",children:[e("span",{className:"text-sm text-gray-600",children:"Du"}),e("input",{type:"date",value:c,onChange:t=>B(t.target.value),className:"border rounded px-2 py-1 text-sm"})]}),n("label",{className:"flex items-center gap-2",children:[e("span",{className:"text-sm text-gray-600",children:"Au"}),e("input",{type:"date",value:m,onChange:t=>L(t.target.value),className:"border rounded px-2 py-1 text-sm"})]})]}),n("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[n("div",{className:"bg-white border rounded-xl p-4 shadow-sm",children:[e("p",{className:"text-sm text-gray-500",children:"Commissions"}),e("p",{className:"text-xl font-bold text-orange-600",children:p(l.totalCommission)})]}),n("div",{className:"bg-white border rounded-xl p-4 shadow-sm",children:[e("p",{className:"text-sm text-gray-500",children:"Revenus abonnements (MRR)"}),e("p",{className:"text-xl font-bold text-blue-600",children:p(l.subscriptionRevenue)})]}),n("div",{className:"bg-white border rounded-xl p-4 shadow-sm",children:[e("p",{className:"text-sm text-gray-500",children:"Revenus totaux plateforme"}),e("p",{className:"text-xl font-bold text-green-600",children:p(l.totalPlatformRevenue)})]})]}),l.commissionByMonth.length>0&&n("div",{className:"w-full h-[350px] bg-white p-4 rounded-xl shadow-sm border",children:[e("h3",{className:"text-lg font-semibold mb-4",children:"Commissions par mois"}),e(W,{width:"100%",height:"90%",children:n(X,{data:l.commissionByMonth.map(t=>({...t,monthLabel:V(new Date(t.month+"-01"),"MMM yyyy")})),children:[e(q,{strokeDasharray:"3 3"}),e(z,{dataKey:"monthLabel"}),e(H,{tickFormatter:t=>ne.format(t/1e3)+"k"}),e(J,{formatter:t=>[p(t),"Commission"]}),e(Q,{}),e(U,{dataKey:"commission",fill:"#ea580c",name:`Commission (${ae()})`})]})})]})]})};export{ue as default};
