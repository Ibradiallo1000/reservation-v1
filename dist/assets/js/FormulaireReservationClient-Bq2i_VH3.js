import{a as ee,u as se,b as te,r as o,j as e,d as ae,e as re,f as le,aV as oe,h as ne,P as ce,aX as ie}from"./react-BKlva80Y.js";import{q,w as R,j as P,k as U,d as de,e as me,y as ue}from"./firebase-1zyXmG6H.js";import{s as he,h as x,d as C}from"../index-BlZmgUmn.js";import"./vendor-CZDa83Cj.js";const je=({company:m})=>{const z=ee(),p=se(),{tripData:_}=z.state||{},{slug:V}=te(),f=V||(m==null?void 0:m.slug)||"",[s,J]=o.useState(_),[g,O]=o.useState(m),[A,G]=o.useState({}),[T,E]=o.useState(!1),[c,B]=o.useState({fullName:"",phone:"",email:""}),[n,H]=o.useState(1),[L,xe]=o.useState(1),[S,pe]=o.useState("aller_simple"),u=Number((s==null?void 0:s.price)||0),[Q,W]=o.useState(u);o.useEffect(()=>{if(!s){const a=sessionStorage.getItem("reservationDraft");if(a){const t=JSON.parse(a);J(t.tripData)}}if(!(m!=null&&m.id)){const a=sessionStorage.getItem("companyInfo");if(a){const t=JSON.parse(a);O(i=>({...i,...t}))}}},[]);const r=o.useMemo(()=>({...g,primaryColor:g.couleurPrimaire||"#3b82f6",secondaryColor:g.couleurSecondaire||"#93c5fd",paymentMethods:A}),[g,A]),X={colors:{primary:r.primaryColor,secondary:r.secondaryColor,text:he(r.primaryColor),background:"#ffffff"},classes:{card:"bg-white rounded-xl shadow-sm border border-gray-200",button:"transition-all hover:scale-105 active:scale-95",header:"sticky top-0 z-50 px-4 py-3"}},{colors:l,classes:y}=X;if(o.useEffect(()=>{(async()=>{if(!r.id)return;const t=q(P(C,"paymentMethods"),R("companyId","==",r.id)),b=(await U(t)).docs.reduce((j,N)=>{const d=N.data(),v=d.name.toLowerCase().replace(/\s+/g,"_");return j[v]={url:d.defaultPaymentUrl||"",logoUrl:d.logoUrl||"",ussdPattern:d.ussdPattern||"",merchantNumber:d.merchantNumber||""},j},{});G(b)})()},[r]),o.useEffect(()=>{W(u*((n||0)+(S==="aller_retour"&&L||0)))},[n,L,S,u]),!s)return e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-white p-4",children:e.jsxs("div",{className:"text-center max-w-sm",children:[e.jsx("h2",{className:"text-lg font-semibold mb-2 text-red-600",children:"Erreur"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Données de trajet manquantes. Veuillez recommencer depuis la page d'accueil."}),e.jsx("button",{onClick:()=>p(`/${f}`),className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition",children:"Retour à l'accueil"})]})});const I=a=>{const{name:t,value:i}=a.target;B(b=>({...b,[t]:i}))},F=(a,t)=>{const i=Math.max(1,Math.min(10,t));H(i)},K=async a=>{a.preventDefault(),E(!0);try{if(!c.fullName||!c.phone)throw new Error("Veuillez remplir tous les champs obligatoires");const t=s.id,i=q(P(C,"reservations"),R("trajetId","==",t),R("statut","in",["payé","preuve_recue"])),j=(await U(i)).docs.reduce((D,w)=>{const h=w.data();return D+(h.seatsGo||0)},0),N=(s.places||0)-j;if(N<n)throw new Error(`Il ne reste que ${N} place(s) pour l'aller.`);let d="",v="";if(s.agencyId){const D=de(C,"agences",s.agencyId),w=await me(D);if(w.exists()){const h=w.data();d=h.nom||"",v=h.telephone||h.phone||""}}const Z=`RES${Date.now()}`,M={nomClient:c.fullName,telephone:c.phone,email:c.email,depart:s.departure,arrivee:s.arrival,date:s.date,heure:s.time,montant:u*n,seatsGo:n,seatsReturn:0,tripType:S,canal:"en_ligne",statut:"en_attente",companyId:s.companyId,agencyId:s.agencyId,agencyNom:d,agencyTelephone:v,trajetId:t,referenceCode:Z,commission:u*n*.05,companySlug:f,companyName:r.nom,primaryColor:r.primaryColor,tripData:s,createdAt:new Date,updatedAt:new Date},$=await ue(P(C,"reservations"),M),k={...M,id:$.id};sessionStorage.setItem("reservationDraft",JSON.stringify(k)),sessionStorage.setItem("companyInfo",JSON.stringify(r)),console.log("Redirection vers upload avec : ",k),p(`/${f}/upload-preuve/${$.id}`,{state:{companyInfo:r,draft:k}})}catch(t){alert(t.message)}finally{E(!1)}},Y=a=>new Date(a).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"});return e.jsxs("div",{className:"min-h-screen",style:{background:l.background},children:[e.jsx("header",{className:y.header,style:{backgroundColor:x(l.primary,.95),backdropFilter:"blur(10px)"},children:e.jsxs("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e.jsx("button",{onClick:()=>{window.history.length>1?p(-1):p(`/${f}`)},className:"p-2 rounded-full hover:bg-white/10 transition",style:{color:l.text},children:e.jsx(ae,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[r.logoUrl&&e.jsx(re.LazyLoadImage,{src:r.logoUrl,alt:`Logo ${r.nom}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:l.text,backgroundColor:x(l.primary,.2)}}),e.jsx("h1",{className:"text-lg font-bold",style:{color:l.text},children:"Réservation"})]})]})}),e.jsxs("main",{className:"max-w-4xl mx-auto p-4",children:[e.jsx("div",{className:`p-4 rounded-xl mb-4 ${y.card}`,children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-lg font-bold",style:{color:l.primary},children:[s.departure," → ",s.arrival]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm mt-1",children:[e.jsx(le,{className:"h-4 w-4 opacity-70"}),e.jsx("span",{children:Y(s.date)}),e.jsx(oe,{className:"h-4 w-4 opacity-70 ml-2"}),e.jsx("span",{children:s.time})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm opacity-80",children:"Prix unitaire"}),e.jsxs("div",{className:"font-bold",children:[u.toLocaleString()," FCFA"]})]})]})}),e.jsx("div",{className:`rounded-xl overflow-hidden ${y.card}`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",style:{color:l.primary},children:"Informations du passager"}),e.jsxs("form",{onSubmit:K,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Nom complet *"}),e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-70"}),e.jsx("input",{type:"text",name:"fullName",value:c.fullName,onChange:I,className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none",style:{borderColor:x(l.primary,.3)},required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Téléphone *"}),e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-70"}),e.jsx("input",{type:"tel",name:"phone",value:c.phone,onChange:I,className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none",style:{borderColor:x(l.primary,.3)},required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Email"}),e.jsxs("div",{className:"relative",children:[e.jsx(ie,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-70"}),e.jsx("input",{type:"email",name:"email",value:c.email,onChange:I,className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:outline-none",style:{borderColor:x(l.primary,.3)}})]})]})]}),e.jsxs("div",{className:"pt-4",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Nombre de places"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1 opacity-80",children:"Aller"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"p-1 w-8 h-8 rounded-lg border border-gray-300 hover:bg-gray-50 flex items-center justify-center",onClick:()=>F("go",n-1),disabled:n<=1,children:"-"}),e.jsx("div",{className:"flex-1 text-center font-medium py-1 border border-gray-200 rounded-lg",children:n}),e.jsx("button",{type:"button",className:"p-1 w-8 h-8 rounded-lg border border-gray-300 hover:bg-gray-50 flex items-center justify-center",onClick:()=>F("go",n+1),disabled:n>=10,children:"+"})]})]})})]}),e.jsxs("div",{className:"pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"font-medium",children:"Total:"}),e.jsxs("span",{className:"text-lg font-bold",children:[Q.toLocaleString()," FCFA"]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mb-3",children:[u.toLocaleString()," FCFA × ",n," place(s)"]}),e.jsx("button",{type:"submit",className:`w-full py-3 px-4 rounded-lg font-medium ${y.button}`,style:{backgroundColor:l.primary,color:l.text},disabled:T,children:T?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsxs("svg",{className:"animate-spin h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Traitement..."]}):"Réserver maintenant"})]})]})]})})]})]})};export{je as default};
