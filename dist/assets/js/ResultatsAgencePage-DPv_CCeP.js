import{a as se,u as re,r as o,j as e,C as te,f as ae,h as oe,o as U,T as le,i as ie}from"./react-PtMwKKf1.js";import{l as k,k as S,q as ne,w as ce}from"./firebase-eGIzIftJ.js";import{d as $}from"../index-C4y8wfzK.js";import"./vendor-B5FTF_2c.js";const de=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],b=(r,y=1)=>{const m=parseInt(r.slice(1,3),16),f=parseInt(r.slice(3,5),16),n=parseInt(r.slice(5,7),16);return`rgba(${m}, ${f}, ${n}, ${y})`},A=r=>{if(r.length<7)return"#000000";const y=parseInt(r.slice(1,3),16),m=parseInt(r.slice(3,5),16),f=parseInt(r.slice(5,7),16);return(.299*y+.587*m+.114*f)/255>.5?"#000000":"#ffffff"},fe=({company:r})=>{var E;const y=se(),m=re(),f=new URLSearchParams(y.search),n=f.get("departure")||"",j=f.get("arrival")||"",[D,z]=o.useState([]),[x,T]=o.useState(""),[l,I]=o.useState(""),[M,L]=o.useState(!0),[P,_]=o.useState(null),q=o.useMemo(()=>{const s=r.couleurPrimaire||"#3b82f6",a=r.couleurSecondaire||"#93c5fd";return{colors:{primary:s,secondary:a,text:A(s),textOnPrimary:A(s),background:"#ffffff"},classes:{card:"bg-white rounded-xl shadow-sm border border-gray-200",button:"transition-all hover:scale-105 active:scale-95",animations:"transition-all duration-300 ease-in-out",header:"sticky top-0 z-50 px-4 py-3"}}},[r]),{colors:t,classes:u}=q,N=o.useMemo(()=>{const s=new Date;return Array.from({length:8},(a,g)=>{const h=new Date(s);return h.setDate(h.getDate()+g),h.toISOString().split("T")[0]})},[]),c=o.useMemo(()=>D.filter(s=>s.date===x),[D,x]);o.useEffect(()=>{(async()=>{var a;if(!(!r.id||!n||!j)){L(!0);try{const h=(await k(S($,"companies",r.id,"agences"))).docs.map(p=>({id:p.id})),C=[];for(const p of h){const J=(await k(ne(S($,"companies",r.id,"agences",p.id,"weeklyTrips"),ce("active","==",!0)))).docs.map(d=>({id:d.id,...d.data()})),K=(await k(S($,"companies",r.id,"agences",p.id,"reservations"))).docs.map(d=>d.data());for(const d of N){const Q=new Date(d),W=de[Q.getDay()];for(const i of J){if(i.departure.toLowerCase()!==n.toLowerCase()||i.arrival.toLowerCase()!==j.toLowerCase())continue;const X=((a=i.horaires)==null?void 0:a[W])||[];for(const R of X){const F=`${i.id}_${d}_${R}`,Z=K.filter(v=>v.trajetId===F&&v.statut==="payé"),O=(i.places||30)-Z.reduce((v,ee)=>v+ee.seatsGo,0);O>0&&C.push({id:F,date:d,time:R,departure:i.departure,arrival:i.arrival,price:i.price,places:i.places||30,remainingSeats:O,agencyId:p.id})}}}}z(C);const H=[...new Set(C.map(p=>p.date))];T(H[0]||"")}catch(g){console.error("Erreur Firestore:",g),_("Erreur lors du chargement des trajets")}finally{L(!1)}}})()},[r.id,N,n,j]),o.useEffect(()=>{var s;if(c.length>0){const a=[...c].sort((g,h)=>g.time.localeCompare(h.time));I(((s=a[0])==null?void 0:s.time)||"")}},[x,c]);const G=s=>{T(s)},B=s=>{I(s)},V=()=>{const s=c.find(a=>a.time===l);s&&m(`/${r.slug}/booking`,{state:{tripData:{...s,companyId:r.id,agencyId:s.agencyId,compagnieNom:r.nom,logoUrl:r.logoUrl},companyInfo:{id:r.id,slug:r.slug,nom:r.nom,logoUrl:r.logoUrl,primaryColor:t.primary}}})},Y=s=>new Date(s).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"}),w=(s,a)=>new Date(`${s}T${a}`).getTime()<new Date().getTime();return M?e.jsx("div",{className:"flex items-center justify-center min-h-screen",style:{background:t.background},children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2",style:{borderColor:t.primary}})}):P?e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",style:{background:t.background},children:e.jsxs("div",{className:`p-4 rounded-lg max-w-md ${u.card}`,children:[e.jsx("h2",{className:"text-xl font-bold mb-2 text-gray-900",children:"Erreur"}),e.jsx("p",{className:"text-gray-700",children:P}),e.jsx("button",{onClick:()=>m(`/${r.slug}`),className:`mt-4 px-4 py-2 rounded ${u.button}`,style:{backgroundColor:t.primary,color:t.textOnPrimary},children:"Retour à la compagnie"})]})}):e.jsxs("div",{className:"min-h-screen",style:{background:t.background,color:t.text},children:[e.jsx("header",{className:u.header,style:{backgroundColor:b(t.primary,.95),color:t.textOnPrimary,backdropFilter:"blur(10px)"},children:e.jsxs("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e.jsx("button",{onClick:()=>m(`/${r.slug}`),className:"p-2 rounded-full hover:bg-white/10 transition",style:{color:t.textOnPrimary},children:e.jsx(te,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[r.logoUrl&&e.jsx(ae.LazyLoadImage,{src:r.logoUrl,alt:`Logo ${r.nom}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:t.textOnPrimary,backgroundColor:b(t.primary,.2)}}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold",children:"Résultats de recherche"}),e.jsxs("p",{className:"text-xs opacity-80",children:[n," → ",j]})]})]})]})}),e.jsxs("main",{className:"max-w-4xl mx-auto p-4 sm:p-6 pb-24",children:[e.jsxs("div",{className:`p-4 rounded-xl mb-6 ${u.card}`,children:[e.jsx("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2",children:e.jsxs("span",{children:[n," → ",j]})}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-3 flex items-center gap-2 text-gray-800",children:[e.jsx(oe,{className:"h-5 w-5",style:{color:t.primary}}),"Choisissez votre date de départ"]}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-4 scrollbar-hide",children:N.map(s=>e.jsxs("button",{onClick:()=>G(s),className:`flex flex-col items-center min-w-[90px] p-3 rounded-xl border transition-all flex-shrink-0 ${x===s?"shadow-md":"bg-white hover:bg-gray-50 border-gray-200 text-gray-800"}`,style:{backgroundColor:x===s?t.primary:void 0,borderColor:x===s?t.primary:void 0,color:x===s?t.textOnPrimary:void 0},children:[e.jsx("span",{className:"text-xs font-medium",children:Y(s)}),e.jsx("span",{className:"text-sm mt-1",children:new Date(s).toLocaleDateString("fr-FR",{day:"numeric"})})]},s))})]}),c.length===0?e.jsxs("div",{className:`p-6 rounded-xl text-center ${u.card} text-gray-800`,children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-full inline-flex mb-3",children:e.jsx(U,{className:"h-6 w-6 text-gray-500"})}),e.jsx("h3",{className:"text-lg font-medium mb-1",children:"Aucun trajet disponible pour cette date"}),e.jsx("p",{className:"text-sm opacity-80",children:"Veuillez choisir une autre date"})]}):e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:`rounded-xl overflow-hidden ${u.card}`,children:[e.jsxs("div",{className:"p-4 border-b",style:{borderColor:b(t.primary,.1)},children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2 mb-3 text-gray-800",children:[e.jsx(U,{className:"h-5 w-5",style:{color:t.primary}}),"Choisissez votre heure de départ"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2",children:c.sort((s,a)=>s.time.localeCompare(a.time)).map(s=>e.jsxs("button",{onClick:()=>B(s.time),disabled:w(s.date,s.time),className:`p-3 rounded-lg border flex flex-col items-center transition ${l===s.time?"bg-blue-50 text-blue-600":w(s.date,s.time)?"bg-gray-50 text-gray-400":"border-gray-200 hover:border-blue-300 hover:bg-blue-50 text-gray-800"}`,style:{borderColor:l===s.time?t.primary:void 0,backgroundColor:l===s.time?b(t.primary,.1):void 0},children:[e.jsx("span",{className:"font-medium",children:s.time}),e.jsxs("span",{className:"text-xs mt-1",children:[s.remainingSeats," places"]})]},s.id))})]}),c.filter(s=>s.time===l&&!w(s.date,s.time)).map(s=>e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 text-gray-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full",style:{backgroundColor:b(t.primary,.1),color:t.primary},children:e.jsx(le,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium opacity-80",children:"Prix"}),e.jsxs("p",{className:"text-lg font-bold text-gray-900",children:[s.price.toLocaleString()," FCFA"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full",style:{backgroundColor:b(t.primary,.1),color:t.primary},children:e.jsx(ie,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium opacity-90",children:"Places disponibles"}),e.jsx("p",{className:`text-lg font-bold ${s.remainingSeats===0?"text-red-600":s.remainingSeats<=10?"text-yellow-600":"text-green-600"}`,children:s.remainingSeats})]})]})]})},s.id))]})})]}),l&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white shadow-lg p-4 border-t border-gray-200",children:e.jsxs("div",{className:"max-w-xl mx-auto flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total"}),e.jsxs("p",{className:"text-xl font-bold text-gray-900",children:[((E=c.find(s=>s.time===l))==null?void 0:E.price.toLocaleString())||"0"," FCFA"]})]}),e.jsx("button",{onClick:V,disabled:!l,className:`px-6 py-3 rounded-lg font-bold ${u.button} ${l?"":"opacity-50 cursor-not-allowed"}`,style:{backgroundColor:t.primary,color:t.textOnPrimary},children:"Réserver maintenant"})]})})]})]})};export{fe as default};
