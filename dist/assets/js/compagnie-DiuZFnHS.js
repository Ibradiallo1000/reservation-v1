const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/firebase-CURBI7X6.js","assets/js/vendor-Bq-8_m9i.js","assets/css/vendor-DroWa5sQ.css"])))=>i.map(i=>d[i]);
var kl=Object.defineProperty;var Il=(a,n,r)=>n in a?kl(a,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[n]=r;var xr=(a,n,r)=>Il(a,typeof n!="symbol"?n+"":n,r);import{R as Je,j as e,a as t,r as l,u as mt,i as Rl,k as _l,A as va,l as Vn,m as Ve,F as Ae,g as ht,n as vr,p as fa,o as Ua,q as Tl,f as yt,b as Yt,s as Ut,v as Pl,C as Dl,X as Ml,Y as Nr,T as $l,L as Ll,w as wr,x as jl,y as Fl,z as Ol,D as ql,G as Ul,H as Bl,I as Gl,J as ms,K as us,M as zl,N as Ba,O as Vl,P as Hl,Q as Yl,S as Kl,U as ps,Z as Wl,V as Jl,W as Xl,$ as Cr,a0 as Sr,a1 as Ql,a2 as Zl,a3 as ei,a4 as ti,_ as ai,h as ni}from"./vendor-Bq-8_m9i.js";import{r as ce,t as Q,w as ne,u as ee,q as Se,o as me,F as st,O as ri,M as Dt,G as Re,I as ot,T as fe,K as $a,H as Hn,v as Bt,x as Oe,E as Na,y as He,D as Jt,P as si,Q as li,L as Ar,S as gs,f as ii,U as oi,V as Er,W as ci,X as di,Y as mi,Z as ui}from"./firebase-CURBI7X6.js";import{B as je,C as La,d as G,s as tt,h as Fe,u as Qe,a as pi,c as gi,b as Pe,e as lt,f as Yn,g as mn,i as Kn,I as un,A as Wn,j as kr,k as Jn,l as hi,m as Tt,n as pn,o as hs,P as gn,p as ln,q as Ir,r as fi,t as ja,v as Rr,w as Xn,x as Qn,y as qn,z as kn,D as yi,E as bi,F as fs,G as ys,H as xi,J as Ga,K as vi}from"./agence-Bsj2lp2X.js";import{a as Be,u as Xt,d as De,L as on,c as Ni,b as wi}from"./router-DoGdw-3y.js";import{a7 as bs,T as hn,v as ft,al as xs,a6 as At,m as Ft,z as Ot,_ as rt,am as Zn,an as Ci,o as Kt,b as _a,ao as dt,i as xt,ae as wt,ap as Si,aq as er,ar as wa,ad as Rt,f as ia,R as kt,a9 as St,A as nt,S as fn,as as Ta,C as ya,D as Ca,Z as Ct,af as tr,at as Ai,au as Pa,av as Un,I as sa,aw as Fa,p as ar,ax as vs,ay as Ei,ab as Da,B as yn,az as ki,aA as Ii,V as Ns,aB as bn,aC as ba,aD as In,a8 as qt,aE as Ri,t as nr,U as xn,aF as Wt,N as ws,O as vn,J as Nn,g as Oa,aG as Cs,aH as _i,G as Ti,aI as Pi,n as xa,aJ as Di,aK as Mi,c as $i,aL as Li,aM as ji,a2 as Ss,a3 as As,ai as Es,X as cn,aN as Fi,a5 as rr,aO as Oi,aP as qi,aQ as Ui,aR as sr,l as Ht,aS as Bi,aT as lr,aU as wn,aV as ks,aW as Is,aX as Rs,aY as _s,aZ as Ts,a_ as Ps,a$ as Ds,$ as Gi,ah as zi,j as Cn,b0 as Ms,b1 as _r,b2 as Vi,b3 as Hi,b4 as Yi,b5 as Ki,b6 as Wi,b7 as Ji,b8 as $s}from"./icons-C0JHUK9Z.js";const Xi="modulepreload",Qi=function(a){return"/"+a},Tr={},vt=function(n,r,s){let i=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));i=Promise.allSettled(r.map(m=>{if(m=Qi(m),m in Tr)return;Tr[m]=!0;const h=m.endsWith(".css"),d=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${d}`))return;const p=document.createElement("link");if(p.rel=h?"stylesheet":Xi,h||(p.as="script"),p.crossOrigin="",p.href=m,c&&p.setAttribute("nonce",c),document.head.appendChild(p),h)return new Promise((f,x)=>{p.addEventListener("load",f),p.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${m}`)))})}))}function u(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return i.then(o=>{for(const c of o||[])c.status==="rejected"&&u(c.reason);return n().catch(u)})},Ls=Je.createContext(void 0),Pr={},js=({children:a})=>{const[n,r]=Je.useState(Pr),s=Je.useCallback(o=>{r(o||{})},[]),i=Je.useCallback(()=>{r(Pr)},[]),u=Je.useMemo(()=>({header:n,setHeader:s,resetHeader:i}),[n,s,i]);return e(Ls.Provider,{value:u,children:a})},ut=()=>{const a=Je.useContext(Ls);if(!a)throw new Error("usePageHeader must be used within PageHeaderProvider");return a},Dr=()=>e("div",{className:"text-center text-red-600 p-8",children:"404 â€“ Page introuvable"});function Bn({error:a}){const n=Be();return t("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:[e("h2",{className:"text-2xl font-bold mb-4",children:"Erreur Technique"}),e("p",{className:"mb-6",children:(a==null?void 0:a.message)||"Une erreur est survenue"}),t("div",{className:"flex gap-4",children:[e(je,{onClick:()=>window.location.reload(),children:"RÃ©essayer"}),e(je,{variant:"secondary",onClick:()=>n("/"),children:"Retour Ã  l'accueil"})]})]})}class Zi extends l.Component{constructor(){super(...arguments);xr(this,"state",{hasError:!1})}static getDerivedStateFromError(r){return{hasError:!0,error:r}}render(){return this.state.hasError?this.props.fallback||e(Bn,{error:this.state.error}):this.props.children}}const eo=64,to=[{id:"accueil",labelKey:"home",icon:e(bs,{className:"w-5 h-5"}),pathSuffix:""},{id:"mes-billets",labelKey:"myTickets",icon:e(hn,{className:"w-5 h-5"}),pathSuffix:"mes-billets"},{id:"reservations",labelKey:"reservations",icon:e(ft,{className:"w-5 h-5"}),pathSuffix:"mes-reservations"},{id:"aide",labelKey:"help",icon:e(xs,{className:"w-5 h-5"}),pathSuffix:"aide"}];function ao({slug:a,primaryColor:n="#ea580c"}){const{t:r}=mt(),s=Xt(),i=Be(),o=s.pathname.split("/").filter(Boolean),c=a??o[0]??"",m=o[1]??"",h=p=>p.id==="accueil"?!m||m==="":m===p.pathSuffix,d=p=>{if(!c)return;const f=p.pathSuffix?`/${c}/${p.pathSuffix}`:`/${c}`;i(f)};return e("nav",{className:"fixed bottom-0 left-0 right-0 z-50 md:hidden",style:{height:eo,paddingBottom:"env(safe-area-inset-bottom, 0)",backgroundColor:"#ffffff",borderTop:"1px solid #e5e7eb",boxShadow:"0 -2px 10px rgba(0,0,0,0.06)"},children:e("div",{className:"h-full max-w-lg mx-auto flex items-stretch justify-around",children:to.map(p=>{const f=h(p);return t("button",{type:"button",onClick:()=>d(p),className:"flex-1 flex flex-col items-center justify-center gap-0.5 min-w-0 px-1 py-2 transition-colors touch-manipulation",style:{color:f?n:"#6b7280"},"aria-current":f?"page":void 0,"aria-label":r(p.labelKey),children:[e("span",{className:f?"opacity-100":"opacity-70",children:p.icon}),e("span",{className:"text-[10px] font-medium truncate w-full text-center",style:{color:f?n:"#6b7280"},children:r(p.labelKey)})]},p.id)})})})}const no=l.lazy(()=>vt(()=>Promise.resolve().then(()=>Eu),void 0)),ro=l.lazy(()=>vt(()=>Promise.resolve().then(()=>Ru),void 0)),so=l.lazy(()=>vt(()=>Promise.resolve().then(()=>oc),void 0)),lo=l.lazy(()=>vt(()=>Promise.resolve().then(()=>pc),void 0)),io=l.lazy(()=>vt(()=>Promise.resolve().then(()=>xc),void 0)),oo=l.lazy(()=>vt(()=>Promise.resolve().then(()=>xo),void 0)),co=l.lazy(()=>vt(()=>Promise.resolve().then(()=>No),void 0)),mo=l.lazy(()=>vt(()=>Promise.resolve().then(()=>Du),void 0)),uo=l.lazy(()=>vt(()=>Promise.resolve().then(()=>Vu),void 0)),po=l.lazy(()=>vt(()=>Promise.resolve().then(()=>To),void 0)),go=l.lazy(()=>vt(()=>Promise.resolve().then(()=>Yu),void 0)),ho=new Set(["login","register","admin","agence","villes","reservation","contact","compagnie"]),Rn=new Map;function fo(){const{pathname:a}=Xt(),n=l.useMemo(()=>a.split("/").filter(Boolean),[a]),r=n[0]??null,s=n[1]??null,[i,u]=l.useState(null),[o,c]=l.useState(null),[m,h]=l.useState(!0),[d,p]=l.useState(!1),[f,x]=l.useState(null),b=l.useMemo(()=>typeof window<"u"&&(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768),[]);if(l.useEffect(()=>{let M=!0,_=null;async function F(){var k;if(h(!0),x(null),p(!1),u(null),c(null),!r||ho.has(r.toLowerCase())){if(!M)return;p(!0),h(!1);return}const D=Rn.get(r);if(D){if(!M)return;u(D),c(D.id),h(!1)}if(!D)try{const S=sessionStorage.getItem(`company-${r}`);if(S){const O=JSON.parse(S);if(Rn.set(r,O),!M)return;u(O),c(O.id),h(!1)}}catch{}try{let S=null;if(!D&&!o){const O=ce(Q(G,"companies"),ne("slug","==",r)),I=await ee(O);if(!I.empty)S=I.docs[0].id;else{const $=await Se(me(G,"companies",r));$.exists()&&(S=$.id)}}else S=((k=D||i)==null?void 0:k.id)||o;if(!S){if(!M)return;p(!0),h(!1);return}_=st(me(G,"companies",S),O=>{if(!M)return;if(!O.exists()){p(!0),u(null),c(null);return}const I=yo(S,r,O.data());c(S),u(I),Rn.set(r,I);try{sessionStorage.setItem(`company-${r}`,JSON.stringify(I))}catch{}h(!1)},O=>{M&&(x(O instanceof Error?O:new Error("Erreur chargement compagnie")),p(!0),h(!1))})}catch(S){if(!M)return;x(S instanceof Error?S:new Error("Erreur chargement compagnie")),p(!0),h(!1)}}return F(),()=>{M=!1,_&&_()}},[r]),m)return null;if(f)return e(Bn,{error:f});if(d||!i)return e(Dr,{});if(i.publicPageEnabled===!1)return t("div",{className:"min-h-screen flex flex-col items-center justify-center p-6",children:[e("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Site dÃ©sactivÃ©"}),e("p",{className:"text-gray-700 text-center max-w-xl",children:"Cette compagnie nâ€™a pas de page publique active avec son plan actuel. Veuillez rÃ©server directement au guichet."})]});if(!i.onlineBookingEnabled&&(s==="booking"||s==="receipt"||s==="confirmation"||s==="upload-preuve"||s==="reservation"||s==="details"))return t("div",{className:"min-h-screen flex flex-col items-center justify-center p-6",children:[e("h1",{className:"text-2xl font-bold text-orange-600 mb-4",children:"RÃ©servation en ligne indisponible"}),e("p",{className:"text-gray-700 text-center max-w-xl",children:"La rÃ©servation en ligne nâ€™est pas incluse dans le plan actuel de cette compagnie. Vous pouvez vous rendre au guichet pour effectuer votre rÃ©servation."})]});const j={company:i};let L;switch(s){case"resultats":L=e(ro,{...j});break;case"booking":L=e(so,{});break;case"mes-reservations":L=e(lo,{});break;case"mes-billets":L=e(io,{});break;case"mentions":L=e(oo,{});break;case"confidentialite":L=e(co,{});break;case"receipt":case"confirmation":L=e(mo,{});break;case"upload-preuve":L=e(uo,{});break;case"details":case"reservation":L=e(po,{});break;case"aide":L=e(go,{company:i});break;case null:L=e(no,{...j,isMobile:b});break;default:L=e(Dr,{})}return e(La,{currency:i==null?void 0:i.devise,children:e(Zi,{fallback:e(Bn,{}),children:t(l.Suspense,{fallback:null,children:[e("div",{className:"min-h-screen pb-20 md:pb-0",children:L}),e(ao,{slug:r,primaryColor:(i==null?void 0:i.couleurPrimaire)??void 0})]})})})}function yo(a,n,r){var s;if(!r||typeof r!="object")throw new Error("DonnÃ©es compagnie invalides");return{id:a,slug:n,nom:r.nom??"Compagnie",themeStyle:r.themeStyle??"clair",imagesSlider:Array.isArray(r.imagesSlider)?r.imagesSlider:[],footerConfig:{customLinks:Array.isArray((s=r.footerConfig)==null?void 0:s.customLinks)?r.footerConfig.customLinks.map(i=>({label:(i==null?void 0:i.label)??"Lien",url:(i==null?void 0:i.url)??"#",external:!!(i!=null&&i.external)})):[]},...r}}const ep=Object.freeze(Object.defineProperty({__proto__:null,default:fo},Symbol.toStringTag,{value:"Module"})),bo=()=>{var p;const{slug:a}=De(),n=Be(),{i18n:r}=mt(),s=r.language==="en"?"en":"fr",[i,u]=l.useState(null),[o,c]=l.useState(!0);if(l.useEffect(()=>{(async()=>{const x=ce(Q(G,"companies"),ne("slug","==",a)),b=await ee(x);if(!b.empty){const P=b.docs[0].data();u({id:b.docs[0].id,name:P.name,couleurPrimaire:P.couleurPrimaire||"#3B82F6",logoUrl:P.logoUrl,mentionsLegales:P.mentionsLegales})}c(!1)})()},[a]),o)return e("div",{className:"min-h-screen flex items-center justify-center text-gray-500",children:"Chargement..."});const m=(i==null?void 0:i.couleurPrimaire)||"#3B82F6",h=tt(m),d=((p=i==null?void 0:i.mentionsLegales)==null?void 0:p[s])||"Mentions lÃ©gales indisponibles.";return t("div",{className:"min-h-screen bg-gray-50",children:[e("header",{className:"px-6 py-4 shadow-sm",style:{backgroundColor:m,color:h},children:t("div",{className:"max-w-6xl mx-auto flex items-center justify-between",children:[t("div",{className:"flex items-center",children:[e("button",{onClick:()=>n(`/${a}`),className:"mr-4 text-white hover:text-gray-200",title:"Retour Ã  la page d'accueil",children:e(At,{className:"w-5 h-5"})}),e("h1",{className:"text-xl font-bold",children:"Mentions lÃ©gales"})]}),(i==null?void 0:i.logoUrl)&&e("img",{src:i.logoUrl,alt:"Logo",className:"h-10 w-10 object-contain rounded-full border bg-white",style:{borderColor:Fe(m,.2)}})]})}),e("main",{className:"max-w-4xl mx-auto px-6 py-8 text-gray-800",children:e("p",{className:"whitespace-pre-wrap leading-relaxed text-justify text-sm md:text-base",children:d})})]})},xo=Object.freeze(Object.defineProperty({__proto__:null,default:bo},Symbol.toStringTag,{value:"Module"})),vo=()=>{var p;const{slug:a}=De(),n=Be(),{i18n:r}=mt(),s=r.language==="en"?"en":"fr",[i,u]=l.useState(null),[o,c]=l.useState(!0);if(l.useEffect(()=>{(async()=>{const x=ce(Q(G,"companies"),ne("slug","==",a)),b=await ee(x);if(!b.empty){const P=b.docs[0].data();u({id:b.docs[0].id,name:P.name,couleurPrimaire:P.couleurPrimaire||"#3B82F6",logoUrl:P.logoUrl,politiqueConfidentialite:P.politiqueConfidentialite})}c(!1)})()},[a]),o)return e("div",{className:"min-h-screen flex items-center justify-center text-gray-500",children:"Chargement..."});const m=(i==null?void 0:i.couleurPrimaire)||"#3B82F6",h=tt(m),d=((p=i==null?void 0:i.politiqueConfidentialite)==null?void 0:p[s])||"Politique de confidentialitÃ© indisponible.";return t("div",{className:"min-h-screen bg-gray-50",children:[e("header",{className:"px-6 py-4 shadow-sm",style:{backgroundColor:m,color:h},children:t("div",{className:"max-w-6xl mx-auto flex items-center justify-between",children:[t("div",{className:"flex items-center",children:[e("button",{onClick:()=>n(`/${a}`),className:"mr-4 text-white hover:text-gray-200",title:"Retour Ã  la page d'accueil",children:e(At,{className:"w-5 h-5"})}),e("h1",{className:"text-xl font-bold",children:"Politique de confidentialitÃ©"})]}),(i==null?void 0:i.logoUrl)&&e("img",{src:i.logoUrl,alt:"Logo",className:"h-10 w-10 object-contain rounded-full border bg-white",style:{borderColor:Fe(m,.2)}})]})}),e("main",{className:"max-w-4xl mx-auto px-6 py-8 text-gray-800",children:e("p",{className:"whitespace-pre-wrap leading-relaxed text-justify text-sm md:text-base",children:d})})]})},No=Object.freeze(Object.defineProperty({__proto__:null,default:vo},Symbol.toStringTag,{value:"Module"})),wo=()=>{var p;const{slug:a}=De(),n=Be(),{i18n:r}=mt(),s=r.language==="en"?"en":"fr",[i,u]=l.useState(null),[o,c]=l.useState(!0);if(l.useEffect(()=>{(async()=>{const x=ce(Q(G,"companies"),ne("slug","==",a)),b=await ee(x);if(!b.empty){const P=b.docs[0].data();u({id:b.docs[0].id,name:P.name,couleurPrimaire:P.couleurPrimaire||"#3B82F6",logoUrl:P.logoUrl,conditionsUtilisation:P.conditionsUtilisation})}c(!1)})()},[a]),o)return e("div",{className:"min-h-screen flex items-center justify-center text-gray-500",children:"Chargement..."});const m=(i==null?void 0:i.couleurPrimaire)||"#3B82F6",h=tt(m),d=((p=i==null?void 0:i.conditionsUtilisation)==null?void 0:p[s])||"Conditions gÃ©nÃ©rales non disponibles.";return t("div",{className:"min-h-screen bg-gray-50",children:[e("header",{className:"px-6 py-4 shadow-sm",style:{backgroundColor:m,color:h},children:t("div",{className:"max-w-6xl mx-auto flex items-center justify-between",children:[t("div",{className:"flex items-center",children:[e("button",{onClick:()=>n(`/${a}`),className:"mr-4 text-white hover:text-gray-200",title:"Retour Ã  la page d'accueil",children:e(At,{className:"w-5 h-5"})}),e("h1",{className:"text-xl font-bold",children:"Conditions gÃ©nÃ©rales"})]}),(i==null?void 0:i.logoUrl)&&e("img",{src:i.logoUrl,alt:"Logo",className:"h-10 w-10 object-contain rounded-full border bg-white",style:{borderColor:Fe(m,.2)}})]})}),e("main",{className:"max-w-4xl mx-auto px-6 py-8 text-gray-800",children:e("p",{className:"whitespace-pre-wrap leading-relaxed text-justify text-sm md:text-base",children:d})})]})},tp=Object.freeze(Object.defineProperty({__proto__:null,default:wo},Symbol.toStringTag,{value:"Module"})),Co=()=>{var p;const{slug:a}=De(),n=Be(),{i18n:r}=mt(),s=r.language==="en"?"en":"fr",[i,u]=l.useState(null),[o,c]=l.useState(!0);if(l.useEffect(()=>{(async()=>{const x=ce(Q(G,"companies"),ne("slug","==",a)),b=await ee(x);if(!b.empty){const P=b.docs[0].data();u({id:b.docs[0].id,name:P.name,couleurPrimaire:P.couleurPrimaire||"#3B82F6",logoUrl:P.logoUrl,politiqueCookies:P.politiqueCookies})}c(!1)})()},[a]),o)return e("div",{className:"min-h-screen flex items-center justify-center text-gray-500",children:"Chargement..."});const m=(i==null?void 0:i.couleurPrimaire)||"#3B82F6",h=tt(m),d=((p=i==null?void 0:i.politiqueCookies)==null?void 0:p[s])||"Politique de cookies non disponible.";return t("div",{className:"min-h-screen bg-gray-50",children:[e("header",{className:"px-6 py-4 shadow-sm",style:{backgroundColor:m,color:h},children:t("div",{className:"max-w-6xl mx-auto flex items-center justify-between",children:[t("div",{className:"flex items-center",children:[e("button",{onClick:()=>n(`/${a}`),className:"mr-4 text-white hover:text-gray-200",title:"Retour Ã  la page d'accueil",children:e(At,{className:"w-5 h-5"})}),e("h1",{className:"text-xl font-bold",children:"Politique des cookies"})]}),(i==null?void 0:i.logoUrl)&&e("img",{src:i.logoUrl,alt:"Logo",className:"h-10 w-10 object-contain rounded-full border bg-white",style:{borderColor:Fe(m,.2)}})]})}),e("main",{className:"max-w-4xl mx-auto px-6 py-8 text-gray-800",children:e("p",{className:"whitespace-pre-wrap leading-relaxed text-justify text-sm md:text-base",children:d})})]})},ap=Object.freeze(Object.defineProperty({__proto__:null,default:Co},Symbol.toStringTag,{value:"Module"})),Fs="pendingReservation",So=a=>`mb:lastStep:${a||""}`,Ao=()=>{try{const a=localStorage.getItem(Fs);return a?JSON.parse(a):null}catch{return null}},aa=()=>{try{localStorage.removeItem(Fs),console.log("ðŸ§¹ pendingReservation nettoyÃ© du localStorage")}catch(a){console.error("Erreur lors du nettoyage localStorage:",a)}try{sessionStorage.removeItem("reservationDraft"),console.log("ðŸ§¹ reservationDraft nettoyÃ© du sessionStorage")}catch(a){console.error("Erreur lors du nettoyage sessionStorage:",a)}try{["currentReservation","lastReservationId","pending_payment","mb_pending"].forEach(n=>{localStorage.removeItem(n),sessionStorage.removeItem(n)})}catch{}},Eo=a=>a?{text:a,icon:e(wt,{className:"h-4 w-4"})}:{text:"Non prÃ©cisÃ©",icon:e(wt,{className:"h-4 w-4"})},ko=a=>new Date(a).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"});async function Io(a,n){var o;const r=await ee(ce(Q(G,"companies"),ne("slug","==",a)));if(r.empty)throw new Error("Compagnie introuvable");const s=r.docs[0].id,i=await ee(ce(Dt(G,"reservations"),ne(ri(),"==",n)));for(const c of i.docs)if(c.ref.path.includes(`/companies/${s}/`)){const m=(o=c.ref.parent.parent)==null?void 0:o.id;return{ref:c.ref,companyId:s,agencyId:m}}const u=await ee(Q(G,"companies",s,"agences"));for(const c of u.docs){const m=me(G,"companies",s,"agences",c.id,"reservations",n);if((await Se(m)).exists())return{ref:m,companyId:s,agencyId:c.id}}throw new Error("RÃ©servation introuvable")}async function Ro(a,n){const r=ce(Dt(G,"reservations"),ne("companySlug","==",a),ne("publicToken","==",n),Re(1)),s=await ee(r);if(s.empty)throw new Error("RÃ©servation introuvable");const i=s.docs[0],u=i.ref.path.split("/");return{ref:i.ref,companyId:u[1],agencyId:u[3],hardId:i.id}}const _n=[{key:"verification",label:"Preuve envoyÃ©e",description:"Preuve envoyÃ©e. En attente de vÃ©rification par la compagnie.",icon:e(Zn,{className:"h-4 w-4"}),isFinal:!1},{key:"confirme",label:"Paiement confirmÃ©",description:"Paiement confirmÃ©. Votre billet est disponible.",icon:e(er,{className:"h-4 w-4"}),isFinal:!0}],_o=()=>{var B;const a=Be(),{slug:n="",id:r}=De(),s=Xt(),i=Qe(),o=new URLSearchParams(s.search).get("r")||"",{companyInfo:c}=s.state||{},[m,h]=l.useState(null),[d,p]=l.useState(""),[f,x]=l.useState(!0),[b,P]=l.useState(c||null),[C,j]=l.useState(null),[L,M]=l.useState(!1),[_,F]=Rl(),k=(b==null?void 0:b.couleurPrimaire)||(b==null?void 0:b.primaryColor)||"#3b82f6",S=(b==null?void 0:b.secondaryColor)||"#60a5fa";l.useEffect(()=>{try{localStorage.setItem(So(n),"details")}catch{}},[n]),l.useEffect(()=>{if(!r&&!o||!n){j("ParamÃ¨tres manquants"),x(!1);return}let V;return(async()=>{try{x(!0),console.log(`ðŸ” Recherche rÃ©servation: ID=${r}, token=${o}, slug=${n}`);let K,z=r||"";const T=s.state||{};if(r)T!=null&&T.companyId&&(T!=null&&T.agencyId)?K=me(G,"companies",T.companyId,"agences",T.agencyId,"reservations",r):K=(await Io(n,r)).ref;else{const W=await Ro(n,o);K=W.ref,z=W.hardId}V=st(K,async W=>{var re;if(!W.exists()){console.warn("âŒ RÃ©servation introuvable dans Firestore, nettoyage du cache..."),aa(),j("RÃ©servation introuvable ou expirÃ©e. Veuillez crÃ©er une nouvelle rÃ©servation."),x(!1);return}const q=W.data(),H={...q,id:W.id,updatedAt:(q==null?void 0:q.updatedAt)||new Date().toISOString()},le=(()=>{var he;const pe=((he=q.statut)==null?void 0:he.toLowerCase())||"";return["preuve_recue","verif","vÃ©rif"].some(y=>pe.includes(y))?"verification":["pay","confirm","valid"].some(y=>pe.includes(y))?"confirme":["refuse","refusÃ©","reject","rejetÃ©"].some(y=>pe.includes(y))?"refuse":["annule","cancel","cancelled"].some(y=>pe.includes(y))?"annule":"en_attente"})(),te={...H,statut:le};h(te);const ae=Ao();(le==="confirme"||le==="annule"||le==="refuse")&&(ae==null?void 0:ae.id)===W.id&&(console.log("âœ… RÃ©servation terminÃ©e, nettoyage du cache"),aa()),ae&&ae.id!==W.id&&(console.log("ðŸ”„ ID diffÃ©rent dÃ©tectÃ©, nettoyage ancien cache"),aa());const de=te.agencyNom||te.agenceNom;if(de)p(de);else{const pe=K.path.split("/")[1],he=K.path.split("/")[3];try{const A=(await Se(me(G,"companies",pe,"agences",he))).data();p((A==null?void 0:A.nom)||(A==null?void 0:A.name)||"")}catch{}}if(!b)try{const pe=K.path.split("/")[1],he=await Se(me(G,"companies",pe));if(he.exists()){const y=he.data();P({id:he.id,name:(y==null?void 0:y.name)||(y==null?void 0:y.nom),primaryColor:y==null?void 0:y.primaryColor,secondaryColor:y==null?void 0:y.secondaryColor,couleurPrimaire:y==null?void 0:y.couleurPrimaire,logoUrl:y==null?void 0:y.logoUrl})}}catch{}if(x(!1),!r&&z){const pe=((re=s==null?void 0:s.state)==null?void 0:re.slug)||te.companySlug||n;window.history.replaceState({},"",`/${pe}/reservation/${z}`)}},W=>{console.error("âŒ Erreur Firestore:",W),aa(),j((W==null?void 0:W.message)||"Erreur de connexion au serveur"),x(!1)})}catch(K){console.error("âŒ Erreur gÃ©nÃ©rale:",K),aa(),j((K==null?void 0:K.message)||"Impossible de localiser la rÃ©servation"),x(!1)}})(),()=>{V&&V()}},[r,o,n,s,b]),l.useEffect(()=>{if((m==null?void 0:m.statut)==="confirme"){const V=`celebrated-${m.id}`;if(!localStorage.getItem(V)){M(!0),localStorage.setItem(V,"true");const K=setTimeout(()=>M(!1),5e3);return()=>clearTimeout(K)}}},[m==null?void 0:m.statut,m==null?void 0:m.id]);const O=pi(m),I=gi(m),$=String((m==null?void 0:m.canal)||"").toLowerCase(),R=m?Math.max(0,_n.findIndex(V=>V.key===m.statut)):-1,w={en_attente:"Veuillez envoyer votre preuve de paiement.",verification:"Preuve envoyÃ©e. En attente de vÃ©rification par la compagnie.",confirme:"Paiement confirmÃ©. Votre billet est disponible.",refuse:"Cette rÃ©servation a Ã©tÃ© refusÃ©e par la compagnie.",annule:"Cette rÃ©servation a Ã©tÃ© annulÃ©e."};l.useEffect(()=>{var z;if(!O||!m)return;const V=window.location.pathname,K=`/${((z=s==null?void 0:s.state)==null?void 0:z.slug)||m.companySlug||n}/receipt/${m.id}`;V!==K&&(console.log("ðŸš€ Redirection automatique vers le billet"),a(K,{replace:!0,state:{reservation:{...m,agencyNom:d,canal:$},companyInfo:b}}))},[O,m,d,b,$,n,s,a]);const N=$==="guichet"?"EspÃ¨ces":(m==null?void 0:m.paymentMethodLabel)||(m!=null&&m.canal&&m.canal!=="en_ligne"?String(m.canal).replace(/_/g," "):"En ligne"),g=Eo(N),v=m!=null&&m.updatedAt&&!isNaN(new Date(m.updatedAt).getTime())?new Date(m.updatedAt).toLocaleString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):null,U=()=>{aa(),a(-1)},E=()=>{aa();const V=(m==null?void 0:m.companySlug)||n;a(`/${V}`,{replace:!0})};return f?e("div",{className:"min-h-screen flex items-center justify-center p-4",style:{background:"#f8fafc"},children:t("div",{className:"flex flex-col items-center space-y-3",children:[e(Ft,{className:"h-8 w-8 animate-spin",style:{color:k}}),e("p",{className:"text-gray-700 text-sm",children:"Chargement de votre rÃ©servation..."})]})}):C||!m?e("div",{className:"min-h-screen flex items-center justify-center p-4",style:{background:"#f8fafc"},children:t("div",{className:"bg-white rounded-xl shadow-sm p-6 max-w-md w-full text-center border border-gray-100",children:[e(Ot,{className:"h-10 w-10 text-red-500 mx-auto mb-3"}),e("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"RÃ©servation introuvable"}),e("p",{className:"text-gray-600 mb-5",children:C||"Cette rÃ©servation a expirÃ© ou a Ã©tÃ© supprimÃ©e."}),t("div",{className:"space-y-3",children:[e("button",{onClick:E,className:"w-full px-5 py-3 rounded-lg text-sm font-medium shadow-sm",style:{backgroundColor:k,color:tt(k)},children:"CrÃ©er une nouvelle rÃ©servation"}),e("button",{onClick:U,className:"w-full px-5 py-2.5 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors",children:"Retour"})]}),e("p",{className:"text-xs text-gray-500 mt-4 pt-4 border-t border-gray-200",children:"ðŸ’¡ Conseil : Videz le cache de votre navigateur si le problÃ¨me persiste."})]})}):t("div",{className:"min-h-screen pb-32",style:{background:"linear-gradient(180deg, #f8fafc, #ffffff)"},children:[e(va,{children:m.statut==="confirme"&&e(_l,{width:_,height:F,recycle:!1,numberOfPieces:200,colors:[k,S,"#ffffff"]})}),e("header",{className:"sticky top-0 z-10 px-5 py-3 shadow-sm",style:{backgroundColor:k,color:tt(k),boxShadow:"0 1px 0 rgba(0,0,0,0.06)"},children:t("div",{className:"flex items-center justify-between max-w-md mx-auto",children:[e("button",{onClick:U,className:"p-1.5 rounded-full hover:bg-black/10 transition-colors","aria-label":"Retour",children:e(At,{className:"h-5 w-5"})}),e("h1",{className:"font-semibold text-base tracking-tight",children:"DÃ©tails de rÃ©servation"}),b!=null&&b.logoUrl?e(Vn.LazyLoadImage,{src:b.logoUrl,alt:"Logo",className:"h-8 w-8 rounded-full object-cover border",style:{borderColor:"rgba(255,255,255,0.25)"},effect:"blur"}):e("div",{className:"h-8 w-8 rounded-full flex items-center justify-center text-sm font-medium border",style:{backgroundColor:"rgba(255,255,255,0.15)",borderColor:"rgba(255,255,255,0.35)",color:tt(k)},children:((B=b==null?void 0:b.name)==null?void 0:B.charAt(0))||"C"})]})}),t("main",{className:"max-w-md mx-auto px-4 py-5 space-y-5",children:[m.canal==="en_ligne"&&m.statut!=="refuse"&&m.statut!=="annule"&&t(Ve.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.05},className:"rounded-xl p-4 border shadow-xs bg-white",style:{borderColor:"rgba(0,0,0,0.06)"},children:[t("div",{className:"flex justify-between items-center mb-3",children:[e("h2",{className:"text-sm font-semibold text-gray-800",children:"Suivi de paiement"}),v&&e("span",{className:"text-xs text-gray-500",children:v})]}),t("div",{className:"relative",children:[e("div",{className:"absolute top-3 left-0 right-0 h-1 bg-gray-200 rounded-full z-0"}),e(Ve.div,{className:"absolute top-3 left-0 h-1 rounded-full z-0",style:{backgroundColor:k},initial:{width:0},animate:{width:`${Math.max(0,(R+1)/_n.length*100)}%`},transition:{type:"spring",stiffness:120,damping:18}}),e("div",{className:"relative z-10 flex justify-between",children:_n.map((V,K)=>{const z=K<=R,T=K===R&&m.statut!=="confirme",W=V.icon;return t("div",{className:"flex flex-col items-center w-1/2",children:[t("div",{className:"relative mb-1",children:[e("div",{className:"h-6 w-6 rounded-full flex items-center justify-center",style:{backgroundColor:z?k:"#e5e7eb",color:z?tt(k):"#6b7280",border:T?`2px solid ${tt(k)}`:"none"},children:K<R?e(rt,{className:"h-3.5 w-3.5"}):T&&m.statut==="verification"?e(Ft,{className:"h-3.5 w-3.5 animate-spin"}):W}),T&&m.statut==="verification"&&e("span",{className:"absolute inset-0 rounded-full",style:{border:`2px solid ${k}`,opacity:.45,animation:"pingStep 1.2s cubic-bezier(0,0,0.2,1) infinite"}})]}),e("span",{className:`text-xs text-center ${z?"font-medium text-gray-900":"text-gray-500"}`,children:V.label})]},V.key)})})]})]}),t(Ve.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.15},className:"p-4 rounded-xl flex items-start gap-3 border bg-white",style:{borderColor:m.statut==="confirme"?Fe("#10b981",.2):m.statut==="verification"?Fe("#7c3aed",.2):m.statut==="refuse"?Fe("#ef4444",.2):m.statut==="annule"?Fe("#9ca3af",.2):"rgba(0,0,0,0.06)"},children:[e("div",{className:"p-2 rounded-lg flex-shrink-0",style:{backgroundColor:"#ffffff",color:m.statut==="confirme"?"#059669":m.statut==="verification"?"#6d28d9":m.statut==="refuse"?"#dc2626":m.statut==="annule"?"#6b7280":k},children:m.statut==="confirme"?e(rt,{className:"h-4 w-4"}):m.statut==="refuse"||m.statut==="annule"?e(Ot,{className:"h-4 w-4"}):m.statut==="verification"?e(Zn,{className:"h-4 w-4"}):e(Ft,{className:"h-4 w-4 animate-spin"})}),t("div",{className:"flex-1",children:[e("p",{className:"font-medium text-sm mb-1",children:m.statut==="confirme"?"Paiement confirmÃ©":m.statut==="refuse"?"RefusÃ©e par la compagnie":m.statut==="annule"?"AnnulÃ©e":m.statut==="verification"?"En vÃ©rification":"En attente de preuve"}),t("p",{className:"text-xs text-gray-600",children:[w[m.statut]||w.en_attente,m.reason&&m.statut==="refuse"&&t("span",{className:"block mt-1 text-red-600 font-medium",children:["Raison : ",m.reason]})]}),m.referenceCode&&t("p",{className:"mt-2 text-xs text-gray-700 flex items-center gap-1",children:[e(Ci,{className:"h-3 w-3"}),e("span",{className:"font-semibold",children:"NÂ°"})," ",m.referenceCode]}),d&&t("p",{className:"text-xs text-gray-600 mt-1 flex items-center gap-1",children:[e(Kt,{className:"h-3 w-3"}),e("span",{className:"font-semibold",children:"Agence :"})," ",d]})]})]}),t(Ve.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.22},className:"rounded-xl shadow-xs border overflow-hidden bg-white",style:{borderColor:"rgba(0,0,0,0.06)"},children:[e("div",{className:"p-4 border-b",style:{borderColor:"rgba(0,0,0,0.06)"},children:t("h2",{className:"font-semibold text-sm flex items-center gap-2",style:{color:"#111827"},children:[e(hn,{className:"h-4 w-4",style:{color:k}}),"DÃ©tails du voyage"]})}),t("div",{className:"p-4 space-y-4",children:[t("div",{className:"flex items-start gap-3",children:[e("div",{className:"p-1.5 rounded-lg bg-gray-100 flex-shrink-0",children:e(Kt,{className:"h-4 w-4 text-gray-600"})}),t("div",{children:[e("p",{className:"text-xs text-gray-500 mb-1",children:"ItinÃ©raire"}),t("p",{className:"text-sm font-medium text-gray-900",children:[m.depart," ",e(_a,{className:"inline h-3 w-3 mx-1 text-gray-400"})," ",m.arrivee]})]})]}),t("div",{className:"grid grid-cols-2 gap-4",children:[t("div",{className:"flex items-start gap-3",children:[e("div",{className:"p-1.5 rounded-lg bg-gray-100 flex-shrink-0",children:e(dt,{className:"h-4 w-4 text-gray-600"})}),t("div",{children:[e("p",{className:"text-xs text-gray-500 mb-1",children:"Date"}),e("p",{className:"text-sm font-medium text-gray-900",children:ko(m.date)})]})]}),t("div",{className:"flex items-start gap-3",children:[e("div",{className:"p-1.5 rounded-lg bg-gray-100 flex-shrink-0",children:e(xt,{className:"h-4 w-4 text-gray-600"})}),t("div",{children:[e("p",{className:"text-xs text-gray-500 mb-1",children:"Heure"}),e("p",{className:"text-sm font-medium text-gray-900",children:m.heure})]})]})]}),t("div",{className:"flex items-start gap-3",children:[e("div",{className:"p-1.5 rounded-lg bg-gray-100 flex-shrink-0",children:e(wt,{className:"h-4 w-4 text-gray-600"})}),t("div",{className:"flex-1",children:[e("p",{className:"text-xs text-gray-500 mb-1",children:"Paiement"}),t("div",{className:"flex justify-between items-center",children:[e("p",{className:"text-sm font-medium text-gray-900",children:i(m.montant)}),e("span",{className:"text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded",children:g.text})]})]})]}),m.tripType==="aller-retour"&&t("div",{className:"text-xs text-gray-600 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200",children:[e("p",{className:"font-medium text-gray-700 mb-1",children:"Aller-retour"}),t("div",{className:"flex justify-between",children:[t("span",{children:["Aller: ",m.seatsGo," place(s)"]}),t("span",{children:["Retour: ",m.seatsReturn," place(s)"]})]})]})]})]}),t(Ve.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.35},className:"text-center pt-4",children:[t("div",{className:"flex items-center justify-center gap-1 text-sm text-gray-600",children:[e(Si,{className:"h-3.5 w-3.5 text-rose-400 fill-rose-400"}),e("span",{children:"Merci pour votre confiance"})]}),e("p",{className:"text-sm font-medium mt-1",style:{color:k},children:m.companyName||(b==null?void 0:b.name)||"Votre compagnie"})]})]}),e("div",{className:"fixed bottom-0 left-0 w-full z-40 px-4 py-3 shadow-md border-t",style:{backgroundColor:"#ffffff",borderColor:"rgba(0,0,0,0.06)"},children:e("div",{className:"max-w-md mx-auto",children:m.statut!=="refuse"&&m.statut!=="annule"?t(Ae,{children:[t("button",{onClick:()=>{var K;const V=((K=s==null?void 0:s.state)==null?void 0:K.slug)||m.companySlug||n;a(`/${V}/receipt/${m.id}`,{state:{reservation:{...m,agencyNom:d,canal:$},companyInfo:b}})},className:`w-full py-3 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shadow-sm transition-all ${I?"hover:opacity-95":"opacity-70 cursor-not-allowed"}`,style:{background:I?`linear-gradient(135deg, ${k}, ${S})`:`linear-gradient(135deg, ${Fe(k,.5)}, ${Fe(S,.5)})`,color:tt(k)},disabled:!I,children:[e(rt,{className:"h-4 w-4"}),O?"Voir mon billet":I?"Voir mon reÃ§u (QR aprÃ¨s confirmation)":"En attente de confirmation"]}),e("button",{onClick:E,className:"w-full mt-3 py-2.5 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors",children:"CrÃ©er une nouvelle rÃ©servation"})]}):t("div",{className:"space-y-3",children:[t("div",{className:"text-center py-3 text-gray-600",children:[e("p",{className:"font-medium mb-1",children:m.statut==="refuse"?"RÃ©servation refusÃ©e":"RÃ©servation annulÃ©e"}),e("p",{className:"text-sm",children:m.statut==="refuse"?"Pour toute question, contactez la compagnie.":"Vous pouvez crÃ©er une nouvelle rÃ©servation."})]}),e("button",{onClick:E,className:"w-full py-3 rounded-lg text-sm font-medium shadow-sm",style:{backgroundColor:k,color:tt(k)},children:"CrÃ©er une nouvelle rÃ©servation"})]})})}),e("style",{children:`
          @keyframes pingStep {
            0% { transform: scale(1); opacity: .45; }
            80% { transform: scale(1.75); opacity: 0; }
            100% { transform: scale(1.75); opacity: 0; }
          }
        `})]})},To=Object.freeze(Object.defineProperty({__proto__:null,default:_o},Symbol.toStringTag,{value:"Module"}));function Os(a,n){return{id:a,url:typeof n.url=="string"?n.url:"",nom:typeof n.nom=="string"?n.nom:void 0,type:typeof n.type=="string"?n.type:void 0}}async function Po(){const a=Q(G,"mediaPlatform");return(await ee(a)).docs.map(r=>Os(r.id,r.data()))}async function Do(a){const n=Q(G,"companies",a,"imagesBibliotheque"),r=ce(n,ot("createdAt","desc"));return(await ee(r)).docs.map(i=>Os(i.id,i.data()))}function Mo(a){const[n,r]=l.useState([]),[s,i]=l.useState([]),[u,o]=l.useState(!0),[c,m]=l.useState(null);return l.useEffect(()=>{let h=!1;async function d(){o(!0),m(null);try{const[p,f]=await Promise.all([Po(),a?Do(a):Promise.resolve([])]);h||(r(p),i(f))}catch(p){h||(m(p instanceof Error?p:new Error(String(p))),r([]),i([]))}finally{h||o(!1)}}return d(),()=>{h=!0}},[a]),{platformMedia:n,companyMedia:s,loading:u,error:c}}const $o=({onSelect:a,onClose:n,title:r="Choisir une image",source:s="company",companyId:i})=>{const{platformMedia:u,companyMedia:o,loading:c,error:m}=Mo(i),h=s==="platform"?u:o,d=m?"Impossible de charger les images. RÃ©essayez plus tard.":null,p=l.useRef(null);return l.useEffect(()=>{const x=b=>{b.key==="Escape"&&n()};return document.addEventListener("keydown",x),setTimeout(()=>{var b;return(b=p.current)==null?void 0:b.focus()},0),()=>document.removeEventListener("keydown",x)},[n]),e("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-[1px] flex items-center justify-center z-50",onClick:x=>{x.target===x.currentTarget&&n()},children:t("div",{ref:p,role:"dialog","aria-modal":"true","aria-labelledby":"image-selector-title",tabIndex:-1,className:"bg-white rounded-xl shadow-xl p-5 w-[92vw] max-w-2xl outline-none",children:[t("div",{className:"flex items-center justify-between mb-4",children:[e("h2",{id:"image-selector-title",className:"text-lg font-bold",children:r}),e("button",{onClick:n,className:"px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm",children:"Fermer"})]}),c?e("div",{className:"grid grid-cols-3 gap-4",children:Array.from({length:6}).map((x,b)=>e("div",{className:"h-32 w-full rounded bg-gray-100 animate-pulse"},b))}):d?e("p",{className:"text-red-600 text-sm",children:d}):h.length===0?e("p",{className:"text-gray-600 text-sm",children:s==="platform"?"Aucune image plateforme disponible.":"Aucune image trouvÃ©e pour cette compagnie."}):e("div",{className:"grid grid-cols-3 gap-4",children:h.map(x=>e("button",{type:"button",onClick:()=>a(x.url),className:"group relative rounded overflow-hidden border hover:shadow-md transition focus:outline-none focus:ring-2 focus:ring-orange-500",title:x.nom||"Image",children:e("img",{src:x.url,alt:x.nom||"image",className:"h-32 w-full object-cover transition group-hover:scale-[1.02]",loading:"lazy",decoding:"async"})},x.id))}),e("div",{className:"flex justify-end mt-5",children:e("button",{onClick:n,className:"px-4 py-2 rounded-lg border hover:bg-gray-50 text-sm",children:"Fermer"})})]})})},Lo=()=>{var F,D;const{user:a,logout:n,company:r}=Pe(),s=Be(),i=lt(r)||{colors:{primary:"#FF6600",secondary:"#F97316"}},u=Yn(),[o,c]=mn(),[m,h]=l.useState(0),[d,p]=l.useState({}),[f,x]=l.useState(new Set),b=l.useRef(null),[P,C]=l.useState(null),[j,L]=l.useState("Compagnie");l.useEffect(()=>{const k=()=>{b.current||(b.current=new Audio("/notification.mp3"),b.current.preload="auto"),document.removeEventListener("click",k),document.removeEventListener("keydown",k)};return document.addEventListener("click",k),document.addEventListener("keydown",k),()=>{document.removeEventListener("click",k),document.removeEventListener("keydown",k)}},[]),l.useEffect(()=>{a!=null&&a.companyId&&(async()=>{try{const k=await Se(me(G,"companies",a.companyId));if(k.exists()){const S=k.data();C(S.logoUrl||S.logo||null),L(S.nom||S.name||"Compagnie")}}catch(k){console.error("[ChefComptable] Error loading company:",k)}})()},[a==null?void 0:a.companyId]),l.useEffect(()=>{const k=Object.values(d).reduce((S,O)=>S+O,0);h(k)},[d]),l.useEffect(()=>{if(!(a!=null&&a.companyId))return;let k=[];return(async()=>{try{(await ee(Q(G,"companies",a.companyId,"agences"))).forEach(O=>{const I=O.id,$=ce(Q(G,"companies",a.companyId,"agences",I,"reservations"),ne("statut","==","preuve_recue")),R=st($,w=>{p(N=>({...N,[I]:w.size})),w.docChanges().forEach(N=>{var g,v;if(N.type==="added"){const U=N.doc.id,E=`${I}_${U}`,V=(v=(g=N.doc.data().createdAt)==null?void 0:g.toDate)==null?void 0:v.call(g);if(V&&Date.now()-V.getTime()>3e4){x(K=>{const z=new Set(K);return z.add(E),z});return}x(K=>{if(K.has(E))return K;if(b.current)try{b.current.currentTime=0,b.current.play().catch(()=>{})}catch{}const z=new Set(K);return z.add(E),z})}})},w=>{console.error("[ChefComptable] Listener error:",w)});k.push(R)})}catch(S){console.error("[ChefComptable] Init error:",S)}})(),()=>{k.forEach(S=>S())}},[a==null?void 0:a.companyId]);const M=async()=>{try{await n(),s("/login")}catch(k){console.error(k)}},_=[{label:"Vue Globale",icon:wa,path:"/chef-comptable",end:!0},{label:"RÃ©servations",icon:wt,path:"/chef-comptable/reservations-en-ligne",badge:m},{label:"Finances",icon:Rt,path:"/chef-comptable/finances"},{label:"TrÃ©sorerie",icon:ia,path:"/chef-comptable/treasury"},{label:"Rapports",icon:ft,path:"/chef-comptable/rapports"}];return Kn(_),e(La,{currency:r==null?void 0:r.devise,children:e("div",{className:o?"agency-dark":"",children:e(un,{sections:_,role:(a==null?void 0:a.role)||"company_accountant",userName:(a==null?void 0:a.displayName)||void 0,userEmail:(a==null?void 0:a.email)||void 0,brandName:j,logoUrl:P||void 0,primaryColor:((F=i==null?void 0:i.colors)==null?void 0:F.primary)||(i==null?void 0:i.primary),secondaryColor:((D=i==null?void 0:i.colors)==null?void 0:D.secondary)||(i==null?void 0:i.secondary),onLogout:M,headerRight:e(Wn,{isOnline:u,darkMode:o,onDarkModeToggle:c}),mainClassName:"agency-content-transition"})})})},np=Object.freeze(Object.defineProperty({__proto__:null,default:Lo},Symbol.toStringTag,{value:"Module"})),jo=()=>{const{user:a,company:n}=Pe(),r=lt(n)||{primary:"#2563eb",secondary:"#3b82f6"},s=Qe(),[i,u]=l.useState(!0),[o,c]=l.useState("week"),[m,h]=l.useState({totalReservations:0,totalAmount:0,totalAgencies:0,activeAgencies:0,pendingValidations:0,totalOnlineAmount:0,cashAmount:0,mobileMoneyAmount:0}),[d,p]=l.useState([]),[f,x]=l.useState([]),[b,P]=l.useState([]),C=()=>{const D=new Date,k=new Date;switch(o){case"today":k.setHours(0,0,0,0);break;case"week":k.setDate(D.getDate()-7),k.setHours(0,0,0,0);break;case"month":k.setMonth(D.getMonth()-1),k.setHours(0,0,0,0);break;case"all":k.setFullYear(2020);break}return{start:k,end:D}};l.useEffect(()=>{a!=null&&a.companyId&&j()},[a==null?void 0:a.companyId,o]);const j=async()=>{var D,k;u(!0);try{const S=C(),O=Q(G,`companies/${a.companyId}/agences`),$=(await ee(O)).docs.map(T=>({id:T.id,...T.data()}));let R=0,w=0,N=0,g=0,v=0,U=0;const E={},B=[];for(const T of $){const W=T.id,q=Q(G,`companies/${a.companyId}/agences/${W}/reservations`),H=ce(q,ne("createdAt",">=",fe.fromDate(S.start)),ne("createdAt","<=",fe.fromDate(S.end)),ot("createdAt","desc")),le=await ee(H);let te=0,ae=0,de=0,re=0;le.forEach(pe=>{const he=pe.data();R++,te++;const y=he.montant||0;w+=y,ae+=y,(he.statut==="en_attente"||he.statut==="verification")&&N++,String(he.canal||"").toLowerCase()==="en_ligne"&&(g+=y,de++,re+=y);const J=String(he.paiement||"").toLowerCase();(J.includes("esp")||J.includes("cash"))&&(v+=y),(J.includes("mobile")||J.includes("mm")||J.includes("orange")||J.includes("mtn"))&&(U+=y),B.push({...he,id:pe.id,agencyId:W,agencyName:T.nomAgence||T.nom||T.ville||"Agence",createdAt:he.createdAt instanceof fe?he.createdAt.toDate():new Date})}),E[W]={reservations:te,amount:ae,onlineReservations:de,onlineAmount:re,lastActivity:((k=(D=le.docs[0])==null?void 0:D.data())==null?void 0:k.createdAt)||null}}const V=$.map(T=>{const W=E[T.id]||{reservations:0,amount:0,onlineReservations:0,onlineAmount:0};let q=null;const H=W.lastActivity;return H instanceof fe?q=H.toDate():H instanceof Date?q=H:H&&typeof H=="object"&&"toDate"in H&&(q=H.toDate()),{id:T.id,name:T.nomAgence||T.nom||T.ville||"Agence",ville:T.ville||T.city||"",reservations:W.reservations,amount:W.amount,onlineReservations:W.onlineReservations,onlineAmount:W.onlineAmount,lastActivity:q}}),K=B.sort((T,W)=>{const q=T.createdAt instanceof Date?T.createdAt:new Date;return(W.createdAt instanceof Date?W.createdAt:new Date).getTime()-q.getTime()}).slice(0,10),z=[];V.forEach(T=>{if(T.lastActivity){const W=Math.floor((new Date().getTime()-T.lastActivity.getTime())/864e5);W>7&&z.push({type:"warning",title:`Agence ${T.name} inactive`,description:`Aucune activitÃ© depuis ${W} jours`})}}),N>5&&z.push({type:"info",title:`${N} validations en attente`,description:"Des rÃ©servations nÃ©cessitent votre attention"}),h({totalReservations:R,totalAmount:w,totalAgencies:$.length,activeAgencies:V.filter(T=>T.reservations>0).length,pendingValidations:N,totalOnlineAmount:g,cashAmount:v,mobileMoneyAmount:U}),p(V),x(K),P(z)}catch(S){console.error("[VueGlobale] Erreur chargement donnÃ©es:",S)}finally{u(!1)}},L=D=>s(D),M=D=>D.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}),_=D=>D.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),F=({icon:D,label:k,value:S,sublabel:O,theme:I,emphasis:$})=>t("div",{className:`relative overflow-hidden rounded-xl border border-gray-200 p-5 bg-white shadow-sm
        hover:shadow-md transition-all duration-300
        ${$?"ring-2 ring-offset-2":""}`,style:$?{"--tw-ring-color":I.primary}:void 0,children:[e("div",{className:"absolute top-0 right-0 h-20 w-20 opacity-10",children:e("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-200 to-gray-300 rounded-full blur-xl"})}),t("div",{className:"flex items-start justify-between mb-4",children:[e("div",{className:"text-sm font-medium text-gray-500 uppercase tracking-wider",children:k}),e("div",{className:"h-10 w-10 rounded-xl grid place-items-center",style:{background:`linear-gradient(135deg, ${I.primary}20, ${I.secondary}20)`},children:e("span",{className:"text-gray-700",children:D})})]}),t("div",{className:"space-y-1",children:[e("div",{className:`font-bold ${$?"text-3xl":"text-2xl"} text-gray-900`,children:S}),O&&e("div",{className:"text-xs font-medium text-gray-500",children:O})]})]});return i?e("div",{className:"flex items-center justify-center py-20",children:t("div",{className:"text-center",children:[e("div",{className:"h-12 w-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-3"}),e("div",{className:"text-gray-600",children:"Chargement des donnÃ©es globales..."})]})}):t("div",{className:"space-y-6",children:[t("div",{className:"rounded-xl border border-gray-200 shadow-sm p-6 bg-gradient-to-r from-white to-gray-50/50",children:[t("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center",children:e(wa,{className:"h-6 w-6 text-blue-600"})}),t("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:"Vue Globale Compagnie"}),e("div",{className:"text-sm text-gray-600",children:"Tableau de bord financier multi-agences"})]})]}),t("div",{className:"flex flex-wrap items-center gap-3",children:[t("div",{className:"flex rounded-xl border border-gray-300 p-1 bg-white",children:[e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${o==="today"?"bg-blue-50 text-blue-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>c("today"),children:"Aujourd'hui"}),e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${o==="week"?"bg-blue-50 text-blue-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>c("week"),children:"7 jours"}),e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${o==="month"?"bg-blue-50 text-blue-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>c("month"),children:"30 jours"}),e("button",{className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${o==="all"?"bg-blue-50 text-blue-700":"text-gray-600 hover:bg-gray-100"}`,onClick:()=>c("all"),children:"Toutes"})]}),t("button",{onClick:j,className:"inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 text-sm font-medium",children:[e(kt,{className:"h-4 w-4"}),"Actualiser"]})]})]}),e("div",{className:"mt-4 p-3 rounded-xl bg-gradient-to-r from-gray-50 to-gray-100/50 border border-gray-200",children:t("div",{className:"text-sm text-gray-600",children:["PÃ©riode analysÃ©e: ",M(C().start)," â†’ ",M(C().end)]})})]}),t("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6",children:[e(F,{icon:e(wt,{className:"h-6 w-6"}),label:"RÃ©servations totales",value:m.totalReservations.toString(),sublabel:`${m.activeAgencies}/${m.totalAgencies} agences actives`,theme:r,emphasis:!1}),e(F,{icon:e(Rt,{className:"h-6 w-6"}),label:"Chiffre d'affaires",value:L(m.totalAmount),sublabel:`${L(m.totalOnlineAmount)} en ligne`,theme:r,emphasis:!0}),e(F,{icon:e(St,{className:"h-6 w-6"}),label:"Agences",value:m.totalAgencies.toString(),sublabel:`${m.activeAgencies} avec activitÃ©`,theme:r,emphasis:!1}),e(F,{icon:e(nt,{className:"h-6 w-6"}),label:"Validations en attente",value:m.pendingValidations.toString(),sublabel:"NÃ©cessitent votre attention",theme:r,emphasis:!1})]}),t("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8",children:[t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"RÃ©partition des paiements"}),e("div",{className:"text-sm text-gray-600",children:L(m.totalAmount)})]}),t("div",{className:"space-y-4",children:[t("div",{className:"space-y-2",children:[t("div",{className:"flex justify-between text-sm",children:[e("span",{className:"font-medium text-gray-700",children:"EspÃ¨ces"}),t("span",{className:"text-gray-900",children:[L(m.cashAmount),"(",m.totalAmount>0?(m.cashAmount/m.totalAmount*100).toFixed(1):"0","%)"]})]}),e("div",{className:"h-2 rounded-full bg-gray-200 overflow-hidden",children:e("div",{className:"h-full rounded-full bg-blue-500",style:{width:`${m.totalAmount>0?m.cashAmount/m.totalAmount*100:0}%`}})})]}),t("div",{className:"space-y-2",children:[t("div",{className:"flex justify-between text-sm",children:[e("span",{className:"font-medium text-gray-700",children:"Mobile Money"}),t("span",{className:"text-gray-900",children:[L(m.mobileMoneyAmount),"(",m.totalAmount>0?(m.mobileMoneyAmount/m.totalAmount*100).toFixed(1):"0","%)"]})]}),e("div",{className:"h-2 rounded-full bg-gray-200 overflow-hidden",children:e("div",{className:"h-full rounded-full bg-green-500",style:{width:`${m.totalAmount>0?m.mobileMoneyAmount/m.totalAmount*100:0}%`}})})]}),t("div",{className:"space-y-2",children:[t("div",{className:"flex justify-between text-sm",children:[e("span",{className:"font-medium text-gray-700",children:"En ligne"}),t("span",{className:"text-gray-900",children:[L(m.totalOnlineAmount),"(",m.totalAmount>0?(m.totalOnlineAmount/m.totalAmount*100).toFixed(1):"0","%)"]})]}),e("div",{className:"h-2 rounded-full bg-gray-200 overflow-hidden",children:e("div",{className:"h-full rounded-full bg-purple-500",style:{width:`${m.totalAmount>0?m.totalOnlineAmount/m.totalAmount*100:0}%`}})})]})]})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Top 5 Agences (CA)"}),t("div",{className:"text-sm text-gray-600",children:[d.filter(D=>D.amount>0).length," agences avec activitÃ©"]})]}),d.filter(D=>D.amount>0).length===0?e("div",{className:"text-center py-8 text-gray-500",children:"Aucune activitÃ© d'agence sur la pÃ©riode"}):e("div",{className:"space-y-4",children:d.filter(D=>D.amount>0).sort((D,k)=>k.amount-D.amount).slice(0,5).map((D,k)=>t("div",{className:"flex items-center justify-between p-3 rounded-xl border border-gray-200 hover:bg-gray-50/50",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center",children:t("div",{className:"text-sm font-bold text-blue-600",children:["#",k+1]})}),t("div",{children:[e("div",{className:"font-medium text-gray-900",children:D.name}),e("div",{className:"text-xs text-gray-500",children:D.ville})]})]}),t("div",{className:"text-right",children:[e("div",{className:"font-bold text-gray-900",children:L(D.amount)}),t("div",{className:"text-xs text-gray-500",children:[D.reservations," rÃ©servations"]})]})]},D.id))})]})]}),b.length>0&&t("div",{className:"rounded-xl border border-gray-200 bg-gradient-to-r from-white to-gray-50/50 p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-4",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center",children:e(nt,{className:"h-5 w-5 text-amber-600"})}),t("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Alertes et notifications"}),e("div",{className:"text-sm text-amber-700",children:"Points nÃ©cessitant votre attention"})]})]}),t("span",{className:"px-3 py-1 rounded-full bg-amber-100 text-amber-800 text-xs font-medium",children:[b.length," alerte",b.length>1?"s":""]})]}),e("div",{className:"space-y-3",children:b.map((D,k)=>t("div",{className:`p-3 rounded-lg border ${D.type==="error"?"border-red-200 bg-red-50":D.type==="warning"?"border-amber-200 bg-amber-50":"border-blue-200 bg-blue-50"}`,children:[t("div",{className:"flex items-center justify-between",children:[e("div",{className:"font-medium text-gray-900",children:D.title}),e("span",{className:`text-xs px-2 py-1 rounded-full ${D.type==="error"?"bg-red-100 text-red-800":D.type==="warning"?"bg-amber-100 text-amber-800":"bg-blue-100 text-blue-800"}`,children:D.type==="error"?"Urgent":D.type==="warning"?"Avertissement":"Information"})]}),e("div",{className:"text-sm text-gray-600 mt-1",children:D.description})]},k))})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"RÃ©servations rÃ©centes"}),t("div",{className:"text-sm text-gray-600",children:[f.length," plus rÃ©centes"]})]}),f.length===0?e("div",{className:"text-center py-8 text-gray-500",children:"Aucune rÃ©servation rÃ©cente"}):e("div",{className:"overflow-hidden rounded-xl border border-gray-200",children:e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gradient-to-r from-gray-50 to-gray-100/50",children:t("tr",{children:[e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Date"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Agence"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Client"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Trajet"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Montant"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Statut"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:f.map((D,k)=>{const S=D.createdAt instanceof Date?D.createdAt:new Date;return t("tr",{className:`hover:bg-gray-50/50 ${k%2===0?"bg-white":"bg-gray-50/30"}`,children:[e("td",{className:"px-4 py-3",children:e("div",{className:"font-medium",children:_(S)})}),e("td",{className:"px-4 py-3",children:e("span",{className:"text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700",children:D.agencyName||"Agence inconnue"})}),t("td",{className:"px-4 py-3",children:[e("div",{className:"font-medium",children:D.nomClient||"Sans nom"}),D.telephone&&e("div",{className:"text-xs text-gray-500",children:D.telephone})]}),e("td",{className:"px-4 py-3",children:t("div",{className:"font-medium",children:[D.depart||"N/A"," â†’ ",D.arrivee||"N/A"]})}),e("td",{className:"px-4 py-3",children:e("span",{className:"font-bold text-gray-900",children:L(D.montant||0)})}),e("td",{className:"px-4 py-3",children:e("span",{className:`text-xs px-2 py-1 rounded-full ${D.statut==="confirme"?"bg-emerald-100 text-emerald-800":D.statut==="en_attente"?"bg-amber-100 text-amber-800":D.statut==="verification"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:D.statut==="confirme"?"ConfirmÃ©":D.statut==="en_attente"?"En attente":D.statut==="verification"?"Ã€ vÃ©rifier":D.statut||"Inconnu"})})]},D.id)})})]})})})]})]})},Mr="/splash/son.mp3",$r=a=>{if(!a)return"en_attente";const n=a.toLowerCase().trim();return n.includes("preuve")||n.includes("verif")?"verification":n.includes("pay")||n.includes("confirm")||n.includes("valid")?"confirme":n.includes("refus")?"refuse":n.includes("annul")||n.includes("cancel")?"annule":(n.includes("attente")||n==="pending","en_attente")},Lr=20,Fo=()=>{const[a,n]=l.useState(null),[r,s]=l.useState(new Set),[i,u]=l.useState(!1);return{initializeAudio:()=>{if(a||typeof window>"u")return;const d=new Audio(Mr);d.preload="auto",d.load(),d.addEventListener("canplaythrough",()=>{n(d),u(!0)}),d.addEventListener("error",()=>u(!1))},playNotification:d=>{!i||!a||r.has(d)||(a.currentTime=0,a.play().catch(()=>{}),s(p=>{const f=new Set(p);return f.add(d),f}))},resetNotification:d=>{s(p=>{const f=new Set(p);return f.delete(d),f})},playSoundNow:()=>{a&&i?(a.currentTime=0,a.play().catch(()=>{})):new Audio(Mr).play().catch(()=>{})},isAudioReady:i}},jr=({children:a,className:n=""})=>e("span",{className:`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${n}`,children:a}),Sa=({tone:a,label:n,value:r,icon:s})=>{const i={blue:{bg:"bg-blue-50",text:"text-blue-700",border:"border-blue-100"},amber:{bg:"bg-amber-50",text:"text-amber-700",border:"border-amber-100"},emerald:{bg:"bg-emerald-50",text:"text-emerald-700",border:"border-emerald-100"},red:{bg:"bg-red-50",text:"text-red-700",border:"border-red-100"},gray:{bg:"bg-gray-50",text:"text-gray-700",border:"border-gray-100"}}[a];return t("div",{className:`rounded-xl border ${i.border} p-4 bg-white shadow-sm hover:shadow-md transition-shadow`,children:[t("div",{className:"flex items-center justify-between mb-2",children:[e("div",{className:`px-2.5 py-1 rounded-lg text-xs font-medium ${i.bg} ${i.text}`,children:n}),e("div",{className:`h-8 w-8 rounded-lg flex items-center justify-center ${i.bg}`,children:e("span",{className:i.text,children:s})})]}),e("div",{className:"text-2xl font-bold text-gray-900",children:r})]})},Tn=a=>{switch(a){case"en_attente":return{label:"En attente",color:"bg-blue-100 text-blue-800 border-blue-300",icon:e(xt,{className:"h-3 w-3"}),priority:0};case"verification":return{label:"Ã€ vÃ©rifier",color:"bg-amber-100 text-amber-800 border-amber-300",icon:e(Ct,{className:"h-3 w-3"}),priority:1};case"confirme":return{label:"ConfirmÃ©",color:"bg-emerald-100 text-emerald-800 border-emerald-300",icon:e(rt,{className:"h-3 w-3"}),priority:2};case"refuse":return{label:"RefusÃ©",color:"bg-red-100 text-red-800 border-red-300",icon:e(Ot,{className:"h-3 w-3"}),priority:3};case"annule":return{label:"AnnulÃ©",color:"bg-gray-100 text-gray-800 border-gray-300",icon:e(Ot,{className:"h-3 w-3"}),priority:4};default:return{label:"Inconnu",color:"bg-gray-100 text-gray-800 border-gray-300",icon:e(Ct,{className:"h-3 w-3"}),priority:5}}},Oo=()=>{const{user:a,company:n}=Pe(),r=Be(),s=lt(n)||{primary:"#2563eb"},i=Qe(),{initializeAudio:u,playNotification:o,resetNotification:c,playSoundNow:m,isAudioReady:h}=Fo(),[d,p]=l.useState([]),[f,x]=l.useState([]),[b,P]=l.useState({}),[C,j]=l.useState(!0),[L,M]=l.useState(!1),[_,F]=l.useState(null),[D,k]=l.useState(""),[S,O]=l.useState(""),[I,$]=l.useState(1),[R,w]=l.useState(!1),[N,g]=l.useState(!1),[v,U]=l.useState("7days"),E=y=>{const A=new Date,J=new Date;switch(y){case"today":J.setHours(0,0,0,0);break;case"7days":J.setDate(J.getDate()-7),J.setHours(0,0,0,0);break;case"30days":J.setDate(J.getDate()-30),J.setHours(0,0,0,0);break}return{start:J,end:A}};l.useEffect(()=>{const y=()=>{u(),document.removeEventListener("click",y),document.removeEventListener("keydown",y),document.removeEventListener("touchstart",y)};return document.addEventListener("click",y),document.addEventListener("keydown",y),document.addEventListener("touchstart",y),()=>{document.removeEventListener("click",y),document.removeEventListener("keydown",y),document.removeEventListener("touchstart",y)}},[]),l.useEffect(()=>{a!=null&&a.companyId&&(async()=>{try{const y=await ee(Q(G,"companies",a.companyId,"agences")),A={};y.forEach(J=>{const se=J.data();A[J.id]={name:se.nomAgence||se.nom||se.ville||"Agence",ville:se.ville||se.city||""}}),P(A)}catch(y){console.error("Erreur chargement agences:",y),ht.error("Erreur",{description:"Impossible de charger les agences"})}})()},[a==null?void 0:a.companyId]),l.useEffect(()=>{if(!(a!=null&&a.companyId)){j(!1);return}let y=[];return(async()=>{try{const A=await ee(Q(G,"companies",a.companyId,"agences"));if(A.empty){j(!1);return}A.docs.map(se=>se.id).forEach(se=>{const ye=ce(Q(G,"companies",a.companyId,"agences",se,"reservations"),ne("statut","==","preuve_recue"),ot("createdAt","desc")),X=st(ye,ge=>{p(Ee=>{const Ne=new Map;return Ee.forEach(ie=>{Ne.set(`${ie.agencyId}_${ie.id}`,ie)}),ge.docChanges().forEach(ie=>{const Ie=ie.doc.data(),Me={...Ie,id:ie.doc.id,companyId:Ie.companyId??a.companyId,agencyId:Ie.agencyId??se,statut:$r(Ie.statut),clientNom:Ie.nomClient??Ie.clientNom,createdAt:Ie.createdAt??fe.now()},Ke=`${Me.agencyId}_${Me.id}`;ie.type==="removed"?(Ne.delete(Ke),c(Ke)):(ie.type==="added"&&Me.statut==="verification"&&(h&&o(Ke),ht("ðŸ†• Nouvelle preuve reÃ§ue",{description:`${Me.clientNom||"Client"} a envoyÃ© une preuve de paiement`,duration:4e3,action:{label:"Voir",onClick:()=>{const Ue=document.getElementById(`reservation-${Me.id}`);Ue&&(Ue.scrollIntoView({behavior:"smooth",block:"center"}),Ue.classList.add("ring-2","ring-amber-500"),setTimeout(()=>{Ue.classList.remove("ring-2","ring-amber-500")},2e3))}}})),Ne.set(Ke,Me))}),Array.from(Ne.values()).sort((ie,Ie)=>{const Me=ie.createdAt instanceof fe?ie.createdAt.toMillis():new Date(ie.createdAt).getTime();return(Ie.createdAt instanceof fe?Ie.createdAt.toMillis():new Date(Ie.createdAt).getTime())-Me})})},ge=>{console.error("Erreur Firestore (verification):",ge),ht.error("Erreur de connexion",{description:"Impossible de charger les rÃ©servations Ã  vÃ©rifier"})});y.push(X)}),B(),j(!1)}catch(A){console.error("Erreur initiale:",A),j(!1),ht.error("Erreur",{description:"Impossible de charger les agences"})}})(),()=>{y.forEach(A=>A())}},[a==null?void 0:a.companyId,h]);const B=async(y=1)=>{if(a!=null&&a.companyId)try{const A=await ee(Q(G,"companies",a.companyId,"agences"));if(A.empty)return;const J=A.docs.map(X=>X.id),se=[];for(const X of J){const ge=ce(Q(G,"companies",a.companyId,"agences",X,"reservations"),ne("statut","not-in",["preuve_recue"]),ot("createdAt","desc"),Re(Lr*y));(await ee(ge)).docs.forEach(Ne=>{const ie=Ne.data(),Ie=$r(ie.statut);se.push({...ie,id:Ne.id,companyId:ie.companyId??a.companyId,agencyId:ie.agencyId??X,statut:Ie,clientNom:ie.nomClient??ie.clientNom,createdAt:ie.createdAt??fe.now()})})}const ye=Array.from(new Map(se.map(X=>[`${X.agencyId}_${X.id}`,X])).values());x(ye),$(y)}catch(A){console.error("Erreur chargement autres rÃ©servations:",A)}},V=l.useMemo(()=>{const y=new Map;return d.forEach(A=>{const J=`${A.agencyId}_${A.id}`;y.set(J,A)}),f.forEach(A=>{var se;const J=`${A.agencyId}_${A.id}`;(!y.has(J)||((se=y.get(J))==null?void 0:se.statut)!=="verification")&&y.set(J,A)}),Array.from(y.values()).sort((A,J)=>{const se=A.createdAt instanceof fe?A.createdAt.toMillis():new Date(A.createdAt).getTime();return(J.createdAt instanceof fe?J.createdAt.toMillis():new Date(J.createdAt).getTime())-se})},[d,f]),K=(y,A)=>{if(A==="today"){const se=new Date;se.setHours(0,0,0,0);const ye=new Date;return ye.setHours(23,59,59,999),y.filter(X=>{let ge;if(X.createdAt instanceof fe)ge=X.createdAt.toDate();else if(typeof X.createdAt=="string")ge=new Date(X.createdAt);else if(X.createdAt instanceof Date)ge=X.createdAt;else return!1;return ge>=se&&ge<=ye})}const{start:J}=E(A);return y.filter(se=>{let ye;if(se.createdAt instanceof fe)ye=se.createdAt.toDate();else if(typeof se.createdAt=="string")ye=new Date(se.createdAt);else if(se.createdAt instanceof Date)ye=se.createdAt;else return!1;return ye>=J})},z=l.useMemo(()=>{const y=K(V,v);let A=y;if(S==="verification"?A=K(d,v):S&&(A=y.filter(se=>se.statut===S)),!D)return A;const J=D.toLowerCase();return A.filter(se=>[se.clientNom||"",se.telephone||"",se.referenceCode||"",se.depart||"",se.arrivee||"",se.email||"",se.preuveMessage||""].join(" ").toLowerCase().includes(J))},[V,d,D,S,v]),T=l.useMemo(()=>{const y=K(V,v),A=K(d,v);return{enAttente:y.filter(J=>J.statut==="en_attente").length,verification:A.length,confirme:y.filter(J=>J.statut==="confirme").length,refuse:y.filter(J=>J.statut==="refuse").length,annule:y.filter(J=>J.statut==="annule").length,total:y.length,totalAmount:y.reduce((J,se)=>J+(se.montant||0),0)}},[V,d,v]),W=async y=>{if(!(a!=null&&a.companyId)||!y.agencyId||!y.id){ht.error("Erreur",{description:"Informations manquantes"});return}F(y.id);try{const A=me(G,"companies",a.companyId,"agences",y.agencyId,"reservations",y.id);await kr(A,"confirme",{userId:a.uid??"",userRole:a.role??"admin_compagnie"},{validatedAt:fe.now()}),p(J=>J.filter(se=>!(se.id===y.id&&se.agencyId===y.agencyId))),c(`${y.agencyId}_${y.id}`),setTimeout(()=>{B(I)},500),ht.success("RÃ©servation confirmÃ©e",{description:`Le billet est maintenant disponible pour ${y.clientNom}`}),m()}catch(A){console.error("Erreur lors de la validation:",A),ht.error("Erreur",{description:"Impossible de confirmer la rÃ©servation"})}finally{F(null)}},q=async y=>{if(!(a!=null&&a.companyId)||!y.agencyId||!y.id){ht.error("Erreur",{description:"Informations manquantes"});return}F(y.id);try{const A=window.prompt("Raison du refus ?")||"Raison non spÃ©cifiÃ©e",J=me(G,"companies",a.companyId,"agences",y.agencyId,"reservations",y.id);await kr(J,"refuse",{userId:a.uid??"",userRole:a.role??"admin_compagnie"},{refusedAt:fe.now(),reason:A}),p(se=>se.filter(ye=>!(ye.id===y.id&&ye.agencyId===y.agencyId))),c(`${y.agencyId}_${y.id}`),setTimeout(()=>{B(I)},500),ht.info("RÃ©servation refusÃ©e",{description:`La rÃ©servation de ${y.clientNom} a Ã©tÃ© refusÃ©e`})}catch(A){console.error("Erreur lors du refus:",A),ht.error("Erreur",{description:"Impossible de refuser la rÃ©servation"})}finally{F(null)}},H=async y=>{if(!(a!=null&&a.companyId)||!y.agencyId||!y.id){ht.error("Erreur",{description:"Informations manquantes"});return}if(window.confirm("ÃŠtes-vous sÃ»r de vouloir supprimer cette rÃ©servation ?")){F(y.id);try{await $a(me(G,"companies",a.companyId,"agences",y.agencyId,"reservations",y.id)),y.statut==="verification"?(p(A=>A.filter(J=>!(J.id===y.id&&J.agencyId===y.agencyId))),c(`${y.agencyId}_${y.id}`)):x(A=>A.filter(J=>!(J.id===y.id&&J.agencyId===y.agencyId))),ht.success("RÃ©servation supprimÃ©e",{description:"La rÃ©servation a Ã©tÃ© supprimÃ©e avec succÃ¨s"})}catch(A){console.error("Erreur lors de la suppression:",A),ht.error("Erreur",{description:"Impossible de supprimer la rÃ©servation"})}finally{F(null)}}},le=y=>{if(!y.companySlug||!y.id){ht.error("Erreur",{description:"Impossible d'afficher les dÃ©tails"});return}r(`/${y.companySlug}/reservation/${y.id}`,{state:{companyId:a==null?void 0:a.companyId,agencyId:y.agencyId,companyInfo:{id:a==null?void 0:a.companyId}}})},te=()=>{M(!0),B(I),setTimeout(()=>M(!1),1e3)},ae=()=>{B(I+1)},de=l.useMemo(()=>{const y=K(V,v),A={};return y.forEach(J=>{J.agencyId&&b[J.agencyId]&&(A[J.agencyId]||(A[J.agencyId]={count:0,amount:0}),A[J.agencyId].count++,A[J.agencyId].amount+=J.montant||0)}),Object.entries(A).map(([J,se])=>{var ye,X;return{id:J,name:((ye=b[J])==null?void 0:ye.name)||"Agence inconnue",ville:((X=b[J])==null?void 0:X.ville)||"",count:se.count,amount:se.amount}}).sort((J,se)=>se.count-J.count).slice(0,5)},[V,b,v]),re=y=>i(y),pe=y=>{if(!y)return"N/A";let A;if(y instanceof fe)A=y.toDate();else if(typeof y=="string")A=new Date(y);else if(y instanceof Date)A=y;else return"N/A";return A.toLocaleDateString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})},he=y=>y.preuveUrl??y.paymentProofUrl??y.paiementPreuveUrl??y.proofUrl??y.receiptUrl;return t("div",{className:"space-y-6",children:[e("div",{className:"rounded-xl border border-gray-200 shadow-sm p-6 bg-gradient-to-r from-white to-gray-50/50",children:t("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t("div",{className:"flex-1",children:[t("div",{className:"mb-2",children:[e("h1",{className:"text-2xl font-bold text-gray-900",children:"RÃ©servations en ligne"}),e("p",{className:"text-sm text-gray-600 mt-1",children:"Gestion des rÃ©servations et paiements"})]}),t("div",{className:"flex flex-wrap items-center gap-4 mt-3",children:[t("div",{className:"flex items-center gap-2",children:[e("div",{className:`h-3 w-3 rounded-full ${d.length>0?"bg-amber-500 animate-pulse":"bg-gray-300"}`}),e("span",{className:"text-sm text-gray-600",children:d.length>0?`${d.length} preuve${d.length>1?"s":""} Ã  vÃ©rifier`:"Tout est Ã  jour"})]}),e("div",{className:"text-sm text-gray-400",children:"â€¢ Mise Ã  jour en temps rÃ©el"})]})]}),e("div",{className:"flex items-center gap-2",children:e("button",{onClick:te,className:"p-2.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-xl transition-colors",title:"Actualiser manuellement",children:e(kt,{className:`h-4 w-4 ${L?"animate-spin":""}`})})})]})}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-4 shadow-sm",children:[t("div",{className:"grid grid-cols-1 sm:grid-cols-4 gap-3",children:[e("div",{className:"sm:col-span-2",children:t("div",{className:"relative",children:[e(fn,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e("input",{type:"text",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-xl bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:s.primary},placeholder:"Rechercher par nom, tÃ©lÃ©phone ou rÃ©fÃ©rence...",value:D,onChange:y=>k(y.target.value)})]})}),e("div",{children:t("select",{value:S,onChange:y=>O(y.target.value),className:"w-full border border-gray-300 rounded-xl px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:s.primary},children:[e("option",{value:"",children:"Toutes les rÃ©servations"}),t("option",{value:"verification",children:["Ã€ vÃ©rifier (",T.verification,")"]}),t("option",{value:"en_attente",children:["En attente (",T.enAttente,")"]}),t("option",{value:"confirme",children:["ConfirmÃ©es (",T.confirme,")"]}),t("option",{value:"refuse",children:["RefusÃ©es (",T.refuse,")"]}),t("option",{value:"annule",children:["AnnulÃ©es (",T.annule,")"]})]})}),e("div",{children:t("select",{value:v,onChange:y=>U(y.target.value),className:"w-full border border-gray-300 rounded-xl px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:s.primary},children:[e("option",{value:"today",children:"Aujourd'hui"}),e("option",{value:"7days",children:"7 derniers jours"}),e("option",{value:"30days",children:"30 derniers jours"})]})})]}),t("div",{className:"mt-3 flex gap-2",children:[t("button",{onClick:()=>w(!R),className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl border-2 border-gray-200 bg-white text-gray-700 font-medium shadow-sm hover:shadow-md hover:border-gray-300 hover:bg-gray-50 transition-all duration-200",children:[R?e(Ta,{className:"h-4 w-4"}):e(ya,{className:"h-4 w-4"}),R?"Masquer les stats":"Afficher les stats"]}),t(je,{variant:"primary",className:"flex-1",children:[e(Ca,{className:"h-4 w-4 mr-2"}),"Exporter"]})]})]}),R&&t(Ae,{children:[t("div",{className:"grid grid-cols-2 sm:grid-cols-5 gap-3 sm:gap-4",children:[e(Sa,{tone:"amber",label:"Ã€ vÃ©rifier",value:T.verification.toString(),icon:e(Ct,{className:"h-4 w-4"})}),e(Sa,{tone:"blue",label:"En attente",value:T.enAttente.toString(),icon:e(xt,{className:"h-4 w-4"})}),e(Sa,{tone:"emerald",label:"ConfirmÃ©es",value:T.confirme.toString(),icon:e(rt,{className:"h-4 w-4"})}),e(Sa,{tone:"red",label:"RefusÃ©es",value:T.refuse.toString(),icon:e(Ot,{className:"h-4 w-4"})}),e(Sa,{tone:"gray",label:"AnnulÃ©es",value:T.annule.toString(),icon:e(Ot,{className:"h-4 w-4"})})]}),e("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:t("div",{className:"flex items-center justify-between mb-4",children:[t("div",{className:"flex items-center gap-2",children:[e(dt,{className:"h-5 w-5 text-gray-500"}),t("div",{className:"text-lg font-bold text-gray-900",children:["PÃ©riode : ",v==="today"?"Aujourd'hui":v==="7days"?"7 derniers jours":"30 derniers jours"]})]}),t("div",{className:"text-sm text-gray-600",children:["Total : ",T.total," rÃ©servations â€¢ ",re(T.totalAmount)]})]})}),de.length>0&&t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Top 5 Agences"}),e("div",{className:"text-sm text-gray-600",children:"Par nombre de rÃ©servations"})]}),e("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4",children:de.map((y,A)=>t("div",{className:"p-4 rounded-xl border border-gray-200 bg-gradient-to-br from-gray-50 to-gray-100/50",children:[t("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center",children:t("div",{className:"text-sm font-bold text-blue-600",children:["#",A+1]})}),t("div",{className:"min-w-0",children:[e("div",{className:"font-medium text-gray-900 truncate",children:y.name}),e("div",{className:"text-xs text-gray-500 truncate",children:y.ville})]})]}),t("div",{className:"space-y-2",children:[t("div",{className:"flex justify-between",children:[e("span",{className:"text-sm text-gray-500",children:"RÃ©servations"}),e("span",{className:"font-bold text-gray-900",children:y.count})]}),t("div",{className:"flex justify-between",children:[e("span",{className:"text-sm text-gray-500",children:"Montant"}),e("span",{className:"font-bold text-gray-900",children:re(y.amount)})]})]})]},y.id))})]})]}),d.length>0&&(!S||S==="verification")&&t("div",{className:"space-y-4",children:[e("div",{className:"flex items-center justify-between",children:t("div",{children:[t("div",{className:"text-lg font-bold text-gray-900 flex items-center gap-2",children:[e("div",{className:"h-2 w-2 rounded-full bg-amber-500 animate-pulse"}),"Preuves de paiement Ã  vÃ©rifier"]}),t("div",{className:"text-sm text-gray-600",children:[d.length," preuve",d.length>1?"s":""," en attente de validation"]})]})}),e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:K(d,v).filter(y=>!D||[y.clientNom,y.telephone,y.referenceCode,y.preuveMessage].join(" ").toLowerCase().includes(D.toLowerCase())).map(y=>{Tn(y.statut);const A=_===y.id,J=he(y),se=y.agencyId?b[y.agencyId]:null;return t("div",{id:`reservation-${y.id}`,className:"border-2 border-amber-200 rounded-xl overflow-hidden hover:shadow-md transition-all duration-300 bg-gradient-to-b from-amber-50/50 to-white",children:[t("div",{className:"p-4 bg-gradient-to-r from-amber-50 to-amber-100/50 border-b border-amber-200",children:[t("div",{className:"flex items-center justify-between mb-2",children:[t("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-amber-100 flex items-center justify-center",children:e(St,{className:"h-3 w-3 text-amber-600"})}),e("span",{className:"text-sm font-medium text-gray-900 truncate",children:(se==null?void 0:se.name)||"Agence inconnue"})]}),t(jr,{className:"bg-amber-100 text-amber-800 border-amber-300",children:[e(Ct,{className:"h-3 w-3"}),e("span",{className:"ml-1",children:"Ã€ vÃ©rifier"})]})]}),y.referenceCode&&t("div",{className:"text-xs font-mono text-gray-600",children:["#",y.referenceCode]})]}),t("div",{className:"p-4 space-y-3",children:[t("div",{className:"bg-blue-50 rounded-lg p-3 border border-blue-100",children:[t("div",{className:"flex items-center gap-2 mb-1",children:[e(tr,{className:"h-4 w-4 text-blue-600"}),e("span",{className:"text-sm font-medium text-gray-700",children:"TÃ©lÃ©phone client"})]}),e("div",{className:"text-lg font-bold text-gray-900",children:y.telephone||"Non renseignÃ©"})]}),y.preuveMessage&&t("div",{className:"bg-amber-50 rounded-lg p-3 border border-amber-200",children:[t("div",{className:"flex items-center gap-2 mb-1",children:[e(ft,{className:"h-4 w-4 text-amber-600"}),e("span",{className:"text-sm font-medium text-gray-700",children:"Message de preuve"})]}),e("div",{className:"text-sm text-gray-800",children:y.preuveMessage})]}),t("div",{className:"space-y-2",children:[t("div",{className:"flex items-center justify-between",children:[e("span",{className:"text-sm text-gray-500",children:"Client"}),e("span",{className:"text-sm font-medium text-gray-900 truncate max-w-[150px] text-right",children:y.clientNom||"Sans nom"})]}),t("div",{className:"flex items-center justify-between",children:[e("span",{className:"text-sm text-gray-500",children:"Trajet"}),t("span",{className:"text-sm font-medium text-gray-900 text-right",children:[y.depart||"N/A"," â†’ ",y.arrivee||"N/A"]})]}),t("div",{className:"flex items-center justify-between",children:[e("span",{className:"text-sm text-gray-500",children:"Montant"}),e("span",{className:"text-sm font-bold text-gray-900",children:re(y.montant||0)})]})]}),J&&t("a",{href:J,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800 font-medium p-2 rounded-lg hover:bg-blue-50 w-full justify-center border border-blue-200",children:[e(ft,{className:"h-4 w-4"}),"Voir la preuve de paiement complÃ¨te"]}),t("div",{className:"text-xs text-gray-400",children:["ReÃ§u le: ",pe(y.createdAt)]})]}),t("div",{className:"p-4 border-t border-amber-200 bg-amber-50/50 space-y-2",children:[t("div",{className:"grid grid-cols-2 gap-2",children:[e(je,{variant:"primary",onClick:()=>W(y),disabled:A,className:"flex items-center justify-center gap-2",children:A?e(Ve.div,{animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"},children:e(Ai,{className:"h-4 w-4"})}):t(Ae,{children:[e(rt,{className:"h-4 w-4"}),"Valider"]})}),t(je,{variant:"secondary",onClick:()=>q(y),disabled:A,className:"border-red-300 text-red-700 hover:bg-red-50",children:[e(Ot,{className:"h-4 w-4"}),"Refuser"]})]}),t("div",{className:"grid grid-cols-2 gap-2",children:[t(je,{variant:"secondary",onClick:()=>le(y),className:"flex items-center justify-center gap-2",children:[e(Pa,{className:"h-4 w-4"}),"DÃ©tails"]}),e(je,{variant:"secondary",onClick:()=>H(y),disabled:A,children:"Supprimer"})]})]})]},`${y.agencyId}_${y.id}`)})})]}),(S!=="verification"&&S!==""||S===""&&f.length>0)&&t("div",{className:"space-y-4",children:[t("div",{className:"flex items-center justify-between",children:[t("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:S?`${Tn(S).label}s`:"Toutes les rÃ©servations"}),e("div",{className:"text-sm text-gray-600",children:S?`${z.filter(y=>y.statut!=="verification").length} rÃ©servation${z.filter(y=>y.statut!=="verification").length>1?"s":""}`:"Historique des rÃ©servations"})]}),e("button",{onClick:()=>g(!N),className:"text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition-colors",children:N?t(Ae,{children:[e(Ta,{className:"h-4 w-4"}),"RÃ©duire"]}):t(Ae,{children:[e(ya,{className:"h-4 w-4"}),"DÃ©velopper"]})})]}),N&&e(Ae,{children:z.filter(y=>y.statut!=="verification").length===0?e("div",{className:"text-center py-8 border border-gray-200 rounded-xl",children:e("div",{className:"text-gray-500",children:"Aucune rÃ©servation Ã  afficher"})}):t(Ae,{children:[e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:z.filter(y=>y.statut!=="verification").map(y=>{const A=Tn(y.statut);y.id;const J=y.agencyId?b[y.agencyId]:null;return t("div",{className:"border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-all duration-300 bg-white",children:[t("div",{className:"p-4 bg-gradient-to-r from-gray-50 to-gray-100/50 border-b",children:[t("div",{className:"flex items-center justify-between mb-2",children:[t("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-blue-100 flex items-center justify-center",children:e(St,{className:"h-3 w-3 text-blue-600"})}),e("span",{className:"text-sm font-medium text-gray-900 truncate",children:(J==null?void 0:J.name)||"Agence inconnue"})]}),t(jr,{className:A.color,children:[A.icon,e("span",{className:"ml-1",children:A.label})]})]}),y.referenceCode&&t("div",{className:"text-xs font-mono text-gray-600",children:["#",y.referenceCode]})]}),t("div",{className:"p-4 space-y-2",children:[t("div",{className:"flex items-center justify-between",children:[e("span",{className:"text-sm text-gray-500",children:"Client"}),e("span",{className:"text-sm font-medium text-gray-900",children:y.clientNom||"Sans nom"})]}),t("div",{className:"flex items-center justify-between",children:[e("span",{className:"text-sm text-gray-500",children:"TÃ©lÃ©phone"}),e("span",{className:"text-sm font-medium text-gray-900",children:y.telephone||"N/A"})]}),t("div",{className:"flex items-center justify-between",children:[e("span",{className:"text-sm text-gray-500",children:"Montant"}),e("span",{className:"text-sm font-bold text-gray-900",children:re(y.montant||0)})]}),t("div",{className:"text-xs text-gray-400",children:["CrÃ©Ã© le: ",pe(y.createdAt)]})]}),e("div",{className:"p-4 border-t bg-gray-50 space-y-2",children:t(je,{variant:"secondary",onClick:()=>le(y),className:"w-full flex items-center justify-center gap-2",children:[e(Pa,{className:"h-4 w-4"}),"Voir dÃ©tails"]})})]},`${y.agencyId}_${y.id}`)})}),!S&&f.length>0&&I*Lr<=f.length&&e("div",{className:"text-center pt-6",children:t(je,{variant:"secondary",onClick:ae,children:[e(kt,{className:"h-4 w-4 mr-2"}),"Charger plus de rÃ©servations"]})})]})})]})]})},qo=()=>{var $,R;const{user:a,company:n}=Pe(),r=lt(n)||{primary:"#2563eb",secondary:"#3b82f6"},s=Qe(),[i,u]=l.useState(!0),[o,c]=l.useState("month"),[m,h]=l.useState({start:null,end:null}),[d,p]=l.useState(null),[f,x]=l.useState(new Date),b=()=>{const w=new Date,N=new Date(w.getFullYear(),w.getMonth(),1),g=new Date(w.getFullYear(),w.getMonth()+1,0,23,59,59);return{start:N,end:g,label:N.toLocaleDateString("fr-FR",{month:"long",year:"numeric"}),isCurrentMonth:!0}},P=(w,N,g)=>{const v=new Date;if(w==="custom"&&N&&g){const V=new Date(g);return V.setHours(23,59,59),{start:N,end:V,label:`${N.toLocaleDateString("fr-FR")} â†’ ${g.toLocaleDateString("fr-FR")}`,isCurrentMonth:!1}}let U=new Date,E="";switch(w){case"day":U.setHours(0,0,0,0),E="Aujourd'hui";break;case"week":U.setDate(v.getDate()-7),U.setHours(0,0,0,0),E="7 derniers jours";break;case"month":return b();case"quarter":U.setMonth(v.getMonth()-3),U.setHours(0,0,0,0),E="Trimestre Ã©coulÃ©";break;case"year":U.setFullYear(v.getFullYear()-1),U.setHours(0,0,0,0),E="AnnÃ©e Ã©coulÃ©e";break}const B=new Date;return B.setHours(23,59,59,999),{start:U,end:B,label:E,isCurrentMonth:!1}};l.useEffect(()=>{a!=null&&a.companyId&&C()},[a==null?void 0:a.companyId,o,m]);const C=async()=>{var w;u(!0);try{const N=o==="custom"&&m.start&&m.end?P("custom",m.start,m.end):P(o),g=Q(G,`companies/${a.companyId}/agences`),U=(await ee(g)).docs.map(ae=>({id:ae.id,name:ae.data().nomAgence||ae.data().nom||ae.data().ville||"Agence",ville:ae.data().ville||""})),E=[];let B=0,V=0,K=0,z=0,T=0;for(const ae of U){const de=Q(G,`companies/${a.companyId}/agences/${ae.id}/reservations`),re=ce(de,ne("statut","==","confirme"),ne("createdAt",">=",fe.fromDate(N.start)),ne("createdAt","<=",fe.fromDate(N.end))),pe=await ee(re);let he=0,y=0,A=0;pe.forEach(J=>{const se=J.data(),ye=se.montant||0;A+=ye,String(se.canal||"").toLowerCase()==="en_ligne"?(y+=ye,K+=ye):(he+=ye,V+=ye);const ge=String(se.paiement||"").toLowerCase();ge.includes("cash")||ge.includes("esp")?z+=ye:(ge.includes("mobile")||ge.includes("mtn")||ge.includes("orange")||ge.includes("wave"))&&(T+=ye)}),B+=A,E.push({id:ae.id,name:ae.name,revenue:A,guichetRevenue:he,onlineRevenue:y})}const W=[];let q=null,H=null;try{for(const ae of U){const de=me(G,`companies/${a.companyId}/agences/${ae.id}/expenses/current`),re=await Se(de);if(re.exists()){const pe=re.data(),he=(w=pe.lastUpdated)==null?void 0:w.toDate();if(!he||he>=N.start&&he<=N.end){const y={id:ae.id,name:ae.name,total:pe.total||0,salaries:pe.salaries||0,operations:pe.operations||0,marketing:pe.marketing||0,other:pe.other||0};W.push(y),q=(q||0)+y.total,H||(H={salaries:0,operations:0,marketing:0,other:0}),H.salaries+=y.salaries,H.operations+=y.operations,H.marketing+=y.marketing,H.other+=y.other}}}}catch{console.warn("Aucune donnÃ©e de dÃ©penses disponible")}const le=E.map(ae=>{const de=W.find(y=>y.id===ae.id),re=(de==null?void 0:de.total)||null,pe=re!==null?ae.revenue-re:null,he=pe!==null&&ae.revenue>0?pe/ae.revenue*100:null;return{id:ae.id,name:ae.name,revenue:ae.revenue,expenses:re,profit:pe,margin:he}}).sort((ae,de)=>de.revenue-ae.revenue),te={period:N,revenue:{total:B,guichet:V,online:K,byAgency:E.sort((ae,de)=>de.revenue-ae.revenue)},paymentMethods:{cash:z,mobileMoney:T,total:z+T},expenses:{total:q,byAgency:W,detail:H},agencies:le};p(te),x(new Date)}catch(N){console.error("[Finances] Erreur chargement donnÃ©es:",N)}finally{u(!1)}},j=()=>{C()},L=(w,N)=>{const g=N?new Date(N):null;h(v=>({...v,[w]:g}))},M=w=>w==null?"N/A":s(w),_=w=>w==null?"N/A":`${w>=0?"+":""}${w.toFixed(1)}%`,F=w=>w>=1e6?`${(w/1e6).toFixed(1)}M`:w>=1e3?`${(w/1e3).toFixed(0)}K`:w.toString(),D=({icon:w,label:N,value:g,sublabel:v,trend:U,theme:E,emphasis:B,warning:V=!1,info:K=!1})=>t("div",{className:`relative overflow-hidden rounded-xl border p-5 bg-white shadow-sm
        hover:shadow-md transition-all duration-300
        ${B?"ring-2 ring-offset-2":""}
        ${V?"border-amber-300 bg-amber-50/30":K?"border-blue-300 bg-blue-50/30":"border-gray-200"}`,style:B?{"--tw-ring-color":E.primary}:void 0,children:[e("div",{className:"absolute top-0 right-0 h-20 w-20 opacity-10",children:e("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-200 to-gray-300 rounded-full blur-xl"})}),t("div",{className:"flex items-start justify-between mb-4",children:[e("div",{className:"text-sm font-medium text-gray-500 uppercase tracking-wider",children:N}),e("div",{className:`h-10 w-10 rounded-xl grid place-items-center ${V?"bg-amber-100":K?"bg-blue-100":""}`,style:!V&&!K?{background:`linear-gradient(135deg, ${E.primary}20, ${E.secondary}20)`}:void 0,children:e("span",{className:V?"text-amber-600":K?"text-blue-600":"text-gray-700",children:w})})]}),t("div",{className:"space-y-1",children:[e("div",{className:`font-bold ${B?"text-3xl":"text-2xl"} 
          ${V?"text-amber-700":K?"text-blue-700":"text-gray-900"}`,children:g}),v&&e("div",{className:`text-xs font-medium ${V?"text-amber-600":K?"text-blue-600":"text-gray-500"}`,children:v}),U!=null&&t("div",{className:`inline-flex items-center gap-1 text-xs font-medium ${U>=0?"text-emerald-600":"text-red-600"}`,children:[U>=0?e(ki,{className:"h-3 w-3"}):e(Ii,{className:"h-3 w-3"}),Math.abs(U).toFixed(1),"% vs pÃ©riode prÃ©cÃ©dente"]})]})]}),k=({period:w})=>t("div",{className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200",children:[e(dt,{className:"h-3 w-3 text-blue-600"}),e("span",{className:"text-sm font-medium text-blue-700",children:w.label}),w.isCurrentMonth&&e("span",{className:"text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700",children:"En cours"})]});if(i)return e("div",{className:"flex items-center justify-center py-20",children:t("div",{className:"text-center",children:[e("div",{className:"h-12 w-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-3"}),e("div",{className:"text-gray-600",children:"Calcul des donnÃ©es financiÃ¨res..."})]})});if(!d)return t("div",{className:"text-center py-20",children:[e(nt,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e("div",{className:"text-lg font-medium text-gray-900 mb-2",children:"DonnÃ©es non disponibles"}),e("div",{className:"text-gray-600",children:"Impossible de charger les donnÃ©es financiÃ¨res"})]});const S=d.expenses.total!==null,O=S&&d.expenses.total!==null?d.revenue.total-d.expenses.total:null,I=O!==null&&d.revenue.total>0?O/d.revenue.total*100:null;return t("div",{className:"space-y-6",children:[t("div",{className:"rounded-xl border border-gray-200 shadow-sm p-6 bg-gradient-to-r from-white to-gray-50/50",children:[t("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-emerald-50 to-green-50 flex items-center justify-center",children:e(Rt,{className:"h-6 w-6 text-emerald-600"})}),t("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:"Finances Compagnie"}),e("div",{className:"text-sm text-gray-600",children:"DonnÃ©es consolidÃ©es pour la prise de dÃ©cision"})]})]}),t("div",{className:"flex items-center gap-3",children:[t("button",{onClick:j,className:"inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 text-sm font-medium",children:[e(kt,{className:"h-4 w-4"}),"Actualiser"]}),t("button",{className:"inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 text-sm font-medium",children:[e(Ca,{className:"h-4 w-4"}),"Exporter"]})]})]}),t("div",{className:"mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t("div",{className:"flex items-center gap-3",children:[e(k,{period:d.period}),t("div",{className:"text-sm text-gray-600",children:["DonnÃ©es consolidÃ©es de ",d.revenue.byAgency.length," agences"]})]}),t("div",{className:"text-xs text-gray-500",children:["DerniÃ¨re mise Ã  jour : ",f.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})]})]})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-5",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center",children:e(dt,{className:"h-5 w-5 text-gray-600"})}),t("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"PÃ©riode d'analyse"}),e("div",{className:"text-sm text-gray-600",children:"SÃ©lectionnez la pÃ©riode Ã  analyser"})]})]}),t("div",{className:"text-sm text-gray-600",children:[e("span",{className:"font-medium",children:"PÃ©riode :"})," ",d.period.start.toLocaleDateString("fr-FR")," â†’ ",d.period.end.toLocaleDateString("fr-FR")]})]}),t("div",{className:"space-y-4",children:[t("div",{className:"flex flex-wrap gap-2",children:[e("button",{className:`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${o==="day"?"bg-blue-50 text-blue-700 border border-blue-200":"text-gray-600 hover:bg-gray-100 border border-gray-200"}`,onClick:()=>c("day"),children:"Aujourd'hui"}),e("button",{className:`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${o==="week"?"bg-blue-50 text-blue-700 border border-blue-200":"text-gray-600 hover:bg-gray-100 border border-gray-200"}`,onClick:()=>c("week"),children:"7 derniers jours"}),e("button",{className:`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${o==="month"?"bg-blue-50 text-blue-700 border border-blue-200":"text-gray-600 hover:bg-gray-100 border border-gray-200"}`,onClick:()=>c("month"),children:"Mois en cours"}),e("button",{className:`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${o==="quarter"?"bg-blue-50 text-blue-700 border border-blue-200":"text-gray-600 hover:bg-gray-100 border border-gray-200"}`,onClick:()=>c("quarter"),children:"Trimestre"}),e("button",{className:`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${o==="year"?"bg-blue-50 text-blue-700 border border-blue-200":"text-gray-600 hover:bg-gray-100 border border-gray-200"}`,onClick:()=>c("year"),children:"AnnÃ©e"}),e("button",{className:`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${o==="custom"?"bg-blue-50 text-blue-700 border border-blue-200":"text-gray-600 hover:bg-gray-100 border border-gray-200"}`,onClick:()=>c("custom"),children:"PÃ©riode personnalisÃ©e"})]}),o==="custom"&&t("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 p-4 rounded-lg border border-blue-200 bg-blue-50",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Date de dÃ©but"}),e("input",{type:"date",className:"w-full border border-gray-300 rounded-lg px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:r.primary},value:(($=m.start)==null?void 0:$.toISOString().split("T")[0])||"",onChange:w=>L("start",w.target.value)})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Date de fin"}),e("input",{type:"date",className:"w-full border border-gray-300 rounded-lg px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:r.primary},value:((R=m.end)==null?void 0:R.toISOString().split("T")[0])||"",onChange:w=>L("end",w.target.value)})]}),e("div",{className:"sm:col-span-2",children:t("button",{onClick:()=>{m.start&&m.end&&C()},disabled:!m.start||!m.end,className:"w-full inline-flex items-center justify-center px-4 py-2.5 rounded-lg text-white font-medium disabled:opacity-50",style:{background:`linear-gradient(135deg, ${r.primary}, ${r.secondary})`},children:[e(Un,{className:"h-4 w-4 mr-2"}),"Appliquer la pÃ©riode"]})})]}),t("div",{className:"flex items-start gap-3 p-3 rounded-lg bg-gray-50 border border-gray-200",children:[e(sa,{className:"h-5 w-5 text-gray-500 mt-0.5 flex-shrink-0"}),t("div",{className:"text-sm text-gray-600",children:[e("span",{className:"font-medium",children:"Mois en cours par dÃ©faut :"}),"La pÃ©riode d'analyse est automatiquement dÃ©finie sur le mois civil en cours pour correspondre aux pratiques comptables standards."]})]})]})]}),t("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6",children:[e(D,{icon:e(Fa,{className:"h-6 w-6"}),label:"Chiffre d'affaires",value:M(d.revenue.total),sublabel:`${d.revenue.byAgency.length} agences actives`,theme:r,emphasis:!0}),S?e(D,{icon:e(ar,{className:"h-6 w-6"}),label:"DÃ©penses totales",value:M(d.expenses.total),sublabel:`${d.expenses.byAgency.length} agences renseignÃ©es`,theme:r,emphasis:!1}):e(D,{icon:e(nt,{className:"h-6 w-6"}),label:"DÃ©penses totales",value:"DonnÃ©es manquantes",sublabel:"Ã€ renseigner par les agences",theme:r,emphasis:!1,warning:!0}),S?e(D,{icon:e(vs,{className:"h-6 w-6"}),label:"BÃ©nÃ©fice net",value:M(O),sublabel:`Marge : ${_(I)}`,theme:r,emphasis:!1}):e(D,{icon:e(Ei,{className:"h-6 w-6"}),label:"BÃ©nÃ©fice net",value:"Non calculable",sublabel:"En attente des donnÃ©es de dÃ©penses",theme:r,emphasis:!1,info:!0}),e(D,{icon:e(Da,{className:"h-6 w-6"}),label:"Transactions",value:F(d.revenue.total),sublabel:`${d.paymentMethods.total>0?`${(d.paymentMethods.cash/d.paymentMethods.total*100).toFixed(0)}% espÃ¨ces`:"0 transaction"}`,theme:r,emphasis:!1})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"RÃ©partition du chiffre d'affaires par canal"}),e("div",{className:"text-sm text-gray-600",children:"Analyse des points de vente"})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t("div",{className:"p-5 rounded-xl border border-gray-200 bg-gradient-to-br from-blue-50 to-indigo-50",children:[t("div",{className:"flex items-center gap-3 mb-4",children:[e("div",{className:"h-12 w-12 rounded-xl bg-white border border-blue-200 flex items-center justify-center",children:e(St,{className:"h-6 w-6 text-blue-600"})}),t("div",{children:[e("div",{className:"font-bold text-gray-900",children:"Guichet"}),e("div",{className:"text-sm text-gray-600",children:"Ventes en agence"})]})]}),t("div",{className:"space-y-4",children:[e("div",{className:"text-3xl font-bold text-gray-900",children:M(d.revenue.guichet)}),e("div",{className:"text-sm text-gray-500",children:d.revenue.total>0?`${(d.revenue.guichet/d.revenue.total*100).toFixed(1)}% du chiffre d'affaires total`:"Aucune vente"}),t("div",{className:"pt-4 border-t border-blue-200",children:[e("div",{className:"text-sm font-medium text-gray-700 mb-2",children:"Top agences guichet :"}),e("div",{className:"space-y-2",children:d.revenue.byAgency.filter(w=>w.guichetRevenue>0).sort((w,N)=>N.guichetRevenue-w.guichetRevenue).slice(0,3).map((w,N)=>t("div",{className:"flex items-center justify-between",children:[t("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-blue-100 flex items-center justify-center",children:t("span",{className:"text-xs font-bold text-blue-600",children:["#",N+1]})}),e("span",{className:"text-sm text-gray-700 truncate",children:w.name})]}),e("span",{className:"text-sm font-medium text-gray-900",children:F(w.guichetRevenue)})]},w.id))})]})]})]}),t("div",{className:"p-5 rounded-xl border border-gray-200 bg-gradient-to-br from-purple-50 to-pink-50",children:[t("div",{className:"flex items-center gap-3 mb-4",children:[e("div",{className:"h-12 w-12 rounded-xl bg-white border border-purple-200 flex items-center justify-center",children:e(wa,{className:"h-6 w-6 text-purple-600"})}),t("div",{children:[e("div",{className:"font-bold text-gray-900",children:"En ligne"}),e("div",{className:"text-sm text-gray-600",children:"RÃ©servations web"})]})]}),t("div",{className:"space-y-4",children:[e("div",{className:"text-3xl font-bold text-gray-900",children:M(d.revenue.online)}),e("div",{className:"text-sm text-gray-500",children:d.revenue.total>0?`${(d.revenue.online/d.revenue.total*100).toFixed(1)}% du chiffre d'affaires total`:"Aucune vente"}),t("div",{className:"pt-4 border-t border-purple-200",children:[e("div",{className:"text-sm font-medium text-gray-700 mb-2",children:"Top agences en ligne :"}),e("div",{className:"space-y-2",children:d.revenue.byAgency.filter(w=>w.onlineRevenue>0).sort((w,N)=>N.onlineRevenue-w.onlineRevenue).slice(0,3).map((w,N)=>t("div",{className:"flex items-center justify-between",children:[t("div",{className:"flex items-center gap-2",children:[e("div",{className:"h-6 w-6 rounded-md bg-purple-100 flex items-center justify-center",children:t("span",{className:"text-xs font-bold text-purple-600",children:["#",N+1]})}),e("span",{className:"text-sm text-gray-700 truncate",children:w.name})]}),e("span",{className:"text-sm font-medium text-gray-900",children:F(w.onlineRevenue)})]},w.id))})]})]})]})]})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Moyens de paiement utilisÃ©s"}),e("div",{className:"text-sm text-gray-600",children:"RÃ©partition des encaissements"})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t("div",{className:"p-5 rounded-xl border border-gray-200",children:[t("div",{className:"flex items-center gap-3 mb-4",children:[e("div",{className:"h-12 w-12 rounded-xl bg-emerald-100 flex items-center justify-center",children:e(yn,{className:"h-6 w-6 text-emerald-600"})}),t("div",{children:[e("div",{className:"font-bold text-gray-900",children:"EspÃ¨ces"}),e("div",{className:"text-sm text-gray-600",children:"Paiements en cash"})]})]}),t("div",{className:"space-y-2",children:[e("div",{className:"text-3xl font-bold text-gray-900",children:M(d.paymentMethods.cash)}),e("div",{className:"text-sm text-gray-500",children:d.paymentMethods.total>0?`${(d.paymentMethods.cash/d.paymentMethods.total*100).toFixed(1)}% des encaissements`:"Aucun paiement"}),e("div",{className:"mt-4",children:e("div",{className:"h-2 w-full bg-gray-200 rounded-full overflow-hidden",children:e("div",{className:"h-full bg-emerald-500 rounded-full",style:{width:`${d.paymentMethods.total>0?d.paymentMethods.cash/d.paymentMethods.total*100:0}%`}})})})]})]}),t("div",{className:"p-5 rounded-xl border border-gray-200",children:[t("div",{className:"flex items-center gap-3 mb-4",children:[e("div",{className:"h-12 w-12 rounded-xl bg-blue-100 flex items-center justify-center",children:e(tr,{className:"h-6 w-6 text-blue-600"})}),t("div",{children:[e("div",{className:"font-bold text-gray-900",children:"Mobile Money"}),e("div",{className:"text-sm text-gray-600",children:"Paiements mobiles"})]})]}),t("div",{className:"space-y-2",children:[e("div",{className:"text-3xl font-bold text-gray-900",children:M(d.paymentMethods.mobileMoney)}),e("div",{className:"text-sm text-gray-500",children:d.paymentMethods.total>0?`${(d.paymentMethods.mobileMoney/d.paymentMethods.total*100).toFixed(1)}% des encaissements`:"Aucun paiement"}),e("div",{className:"mt-4",children:e("div",{className:"h-2 w-full bg-gray-200 rounded-full overflow-hidden",children:e("div",{className:"h-full bg-blue-500 rounded-full",style:{width:`${d.paymentMethods.total>0?d.paymentMethods.mobileMoney/d.paymentMethods.total*100:0}%`}})})})]})]})]}),e("div",{className:"mt-6 p-4 rounded-lg bg-gray-50 border border-gray-200",children:t("div",{className:"text-sm text-gray-600",children:[e("span",{className:"font-medium",children:"Note :"}),"Les moyens de paiement (espÃ¨ces, mobile money) peuvent Ãªtre utilisÃ©s dans les deux canaux (guichet et en ligne). Cette rÃ©partition montre comment l'argent est physiquement encaissÃ©."]})})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Performance par agence"}),t("div",{className:"text-sm text-gray-600",children:[d.agencies.length," agences",!S&&" (bÃ©nÃ©fice non calculable - dÃ©penses manquantes)"]})]}),e("div",{className:"overflow-hidden rounded-xl border border-gray-200",children:t("table",{className:"w-full text-sm",children:[e("thead",{className:"bg-gradient-to-r from-gray-50 to-gray-100/50",children:t("tr",{children:[e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Agence"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Chiffre d'affaires"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"DÃ©penses"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"BÃ©nÃ©fice"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Marge"}),e("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"DÃ©tail"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:d.agencies.map(w=>{const N=w.expenses!==null;return t("tr",{className:"hover:bg-gray-50/50",children:[e("td",{className:"px-4 py-3",children:e("div",{className:"font-medium text-gray-900",children:w.name})}),e("td",{className:"px-4 py-3",children:e("div",{className:"font-bold text-gray-900",children:M(w.revenue)})}),e("td",{className:"px-4 py-3",children:N?e("div",{className:"font-medium text-gray-700",children:M(w.expenses)}):e("div",{className:"text-amber-600 text-sm bg-amber-50 px-2 py-1 rounded inline-block",children:"Non renseignÃ©es"})}),e("td",{className:"px-4 py-3",children:N&&w.profit!==null?e("div",{className:`font-bold ${w.profit>=0?"text-emerald-700":"text-red-700"}`,children:M(w.profit)}):e("div",{className:"text-gray-400 text-sm",children:"-"})}),e("td",{className:"px-4 py-3",children:N&&w.margin!==null?e("div",{className:`font-medium ${w.margin>=0?"text-emerald-600":"text-red-600"}`,children:_(w.margin)}):e("div",{className:"text-gray-400 text-sm",children:"-"})}),e("td",{className:"px-4 py-3",children:t("button",{className:"inline-flex items-center gap-1 text-sm text-blue-600 hover:text-blue-800 font-medium",children:["Voir dÃ©tail",e(_a,{className:"h-3 w-3"})]})})]},w.id)})})]})}),e("div",{className:"mt-6 p-4 rounded-lg bg-gray-50 border border-gray-200",children:t("div",{className:"text-sm text-gray-700",children:[e("strong",{children:"Mode de calcul :"}),t("ul",{className:"mt-2 space-y-1",children:[e("li",{children:"â€¢ Chiffre d'affaires = Somme des transactions validÃ©es"}),e("li",{children:"â€¢ DÃ©penses = Saisies individuelles par chaque agence"}),e("li",{children:"â€¢ BÃ©nÃ©fice = CA - DÃ©penses (calculÃ© uniquement si dÃ©penses renseignÃ©es)"}),e("li",{children:"â€¢ Marge = (BÃ©nÃ©fice / CA) Ã— 100"})]}),e("div",{className:"mt-3 text-amber-600",children:!S&&t(Ae,{children:[e(nt,{className:"h-4 w-4 inline mr-1"}),e("strong",{children:"Action requise :"})," Demandez aux agences de renseigner leurs dÃ©penses pour calculer les bÃ©nÃ©fices."]})})]})})]}),S&&d.expenses.detail&&t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"DÃ©tail des dÃ©penses consolidÃ©es"}),t("div",{className:"text-sm text-gray-600",children:[d.expenses.byAgency.length," agences ont renseignÃ© leurs dÃ©penses"]})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[t("div",{className:"p-4 rounded-xl border border-gray-200",children:[e("div",{className:"text-sm text-gray-500 mb-2",children:"Salaires"}),e("div",{className:"text-2xl font-bold text-gray-900",children:M(d.expenses.detail.salaries)}),e("div",{className:"text-sm text-gray-500",children:d.expenses.total?`${(d.expenses.detail.salaries/d.expenses.total*100).toFixed(1)}% des dÃ©penses`:"0%"})]}),t("div",{className:"p-4 rounded-xl border border-gray-200",children:[e("div",{className:"text-sm text-gray-500 mb-2",children:"OpÃ©rations"}),e("div",{className:"text-2xl font-bold text-gray-900",children:M(d.expenses.detail.operations)}),e("div",{className:"text-sm text-gray-500",children:d.expenses.total?`${(d.expenses.detail.operations/d.expenses.total*100).toFixed(1)}% des dÃ©penses`:"0%"})]}),t("div",{className:"p-4 rounded-xl border border-gray-200",children:[e("div",{className:"text-sm text-gray-500 mb-2",children:"Marketing"}),e("div",{className:"text-2xl font-bold text-gray-900",children:M(d.expenses.detail.marketing)}),e("div",{className:"text-sm text-gray-500",children:d.expenses.total?`${(d.expenses.detail.marketing/d.expenses.total*100).toFixed(1)}% des dÃ©penses`:"0%"})]}),t("div",{className:"p-4 rounded-xl border border-gray-200",children:[e("div",{className:"text-sm text-gray-500 mb-2",children:"Autres"}),e("div",{className:"text-2xl font-bold text-gray-900",children:M(d.expenses.detail.other)}),e("div",{className:"text-sm text-gray-500",children:d.expenses.total?`${(d.expenses.detail.other/d.expenses.total*100).toFixed(1)}% des dÃ©penses`:"0%"})]})]})]}),!S&&t("div",{className:"rounded-xl border border-amber-300 bg-amber-50 p-5 shadow-sm",children:[t("div",{className:"flex items-center gap-3 mb-4",children:[e(nt,{className:"h-6 w-6 text-amber-600"}),e("div",{className:"text-lg font-bold text-amber-800",children:"DonnÃ©es de dÃ©penses incomplÃ¨tes"})]}),t("div",{className:"text-amber-700",children:[e("p",{className:"mb-3",children:"Pour calculer les bÃ©nÃ©fices et marges rÃ©elles, les agences doivent renseigner leurs dÃ©penses individuelles."}),t("div",{className:"bg-white p-4 rounded-lg border border-amber-200",children:[e("h4",{className:"font-medium text-amber-800 mb-3",children:"ProcÃ©dure recommandÃ©e :"}),t("ol",{className:"space-y-2 text-sm",children:[t("li",{className:"flex items-start gap-2",children:[e("div",{className:"h-6 w-6 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center flex-shrink-0",children:"1"}),e("span",{children:"Chaque agence saisit ses dÃ©penses mensuelles dans son espace administratif"})]}),t("li",{className:"flex items-start gap-2",children:[e("div",{className:"h-6 w-6 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center flex-shrink-0",children:"2"}),e("span",{children:"Les dÃ©penses sont catÃ©gorisÃ©es (salaires, opÃ©rations, marketing, autres)"})]}),t("li",{className:"flex items-start gap-2",children:[e("div",{className:"h-6 w-6 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center flex-shrink-0",children:"3"}),e("span",{children:"Le systÃ¨me consolide automatiquement les donnÃ©es au niveau compagnie"})]}),t("li",{className:"flex items-start gap-2",children:[e("div",{className:"h-6 w-6 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center flex-shrink-0",children:"4"}),e("span",{children:"Les bÃ©nÃ©fices et marges sont calculÃ©s pour chaque agence et globalement"})]})]})]})]})]})]})},Uo=()=>{const{user:a,company:n}=Pe(),r=lt(n)||{primary:"#2563eb",secondary:"#3b82f6"},[s,i]=l.useState("comptable"),[u,o]=l.useState("monthly"),[c,m]=l.useState({start:"",end:""}),[h,d]=l.useState(null),[p,f]=l.useState([]),[x,b]=l.useState(null),P=()=>{const I=new Date,$=new Date(I.getFullYear(),I.getMonth(),1),R=new Date(I.getFullYear(),I.getMonth()+1,0);return{start:$.toISOString().split("T")[0],end:R.toISOString().split("T")[0],label:$.toLocaleDateString("fr-FR",{month:"long",year:"numeric"})}},C=[{id:"financial-summary",title:"Rapport financier mensuel",description:"Chiffre d'affaires, dÃ©penses et bÃ©nÃ©fices consolidÃ©s pour la pÃ©riode",category:"comptable",frequency:["monthly","quarterly"],icon:e(Fa,{className:"h-5 w-5"}),color:"blue"},{id:"revenue-report",title:"Rapport des recettes",description:"DÃ©tail des recettes par agence, par canal et par moyen de paiement",category:"comptable",frequency:["daily","weekly","monthly"],icon:e(yn,{className:"h-5 w-5"}),color:"emerald"},{id:"expense-report",title:"Rapport des dÃ©penses",description:"Analyse des dÃ©penses par agence et par catÃ©gorie (salaires, opÃ©rations, etc.)",category:"comptable",frequency:["monthly","quarterly"],icon:e(ar,{className:"h-5 w-5"}),color:"amber"},{id:"profit-margin",title:"Rapport bÃ©nÃ©fice & marge",description:"BÃ©nÃ©fice net et marges par agence, avec analyse des performances",category:"comptable",frequency:["monthly","quarterly"],icon:e(vs,{className:"h-5 w-5"}),color:"purple"},{id:"cash-flow",title:"Rapport de trÃ©sorerie",description:"EntrÃ©es et sorties d'argent, analyse des flux de trÃ©sorerie",category:"comptable",frequency:["weekly","monthly"],icon:e(wt,{className:"h-5 w-5"}),color:"indigo"},{id:"agency-performance",title:"Performance des agences",description:"Classement et analyse des agences par CA et par indicateurs clÃ©s",category:"operationnel",frequency:["weekly","monthly"],icon:e(St,{className:"h-5 w-5"}),color:"blue"},{id:"agency-activity",title:"ActivitÃ© par agence",description:"Volume de transactions, taux d'occupation, activitÃ© dÃ©taillÃ©e",category:"operationnel",frequency:["daily","weekly"],icon:e(Da,{className:"h-5 w-5"}),color:"emerald"},{id:"online-reservations",title:"RÃ©servations en ligne",description:"Statistiques des rÃ©servations web, validation et conversion",category:"operationnel",frequency:["daily","weekly"],icon:e(wa,{className:"h-5 w-5"}),color:"purple"},{id:"monthly-evolution",title:"Ã‰volution mensuelle",description:"Comparaison pÃ©riode Ã  pÃ©riode, tendances et projections",category:"analytique",frequency:["monthly","quarterly"],icon:e(Rt,{className:"h-5 w-5"}),color:"indigo"},{id:"payment-methods",title:"Analyse des moyens de paiement",description:"Ã‰volution des usages, rÃ©partition espÃ¨ces vs mobile money",category:"analytique",frequency:["monthly","quarterly"],icon:e(tr,{className:"h-5 w-5"}),color:"amber"}],j=async I=>{if(a){d(I);try{let $="",R="monthly";if(u==="custom"&&c.start&&c.end){const g=new Date(c.start),v=new Date(c.end);$=`${g.toLocaleDateString("fr-FR")} â†’ ${v.toLocaleDateString("fr-FR")}`,R="custom"}else $=P().label,R=u;const w=C.find(g=>g.id===I);if(!w)return;await new Promise(g=>setTimeout(g,1500));const N={id:`${I}-${Date.now()}`,title:w.title,type:w.category,period:R,periodLabel:$,generatedAt:new Date,generatedBy:a.email||"Utilisateur",fileSize:`${Math.floor(Math.random()*5)+1}.${Math.floor(Math.random()*9)} MB`,status:"ready",downloadUrl:"#"};f(g=>[N,...g]),alert(`âœ… Rapport "${w.title}" gÃ©nÃ©rÃ© avec succÃ¨s pour ${$}`)}catch($){console.error("Erreur gÃ©nÃ©ration rapport:",$),alert("âŒ Erreur lors de la gÃ©nÃ©ration du rapport")}finally{d(null)}}},L=I=>{console.log("TÃ©lÃ©chargement rapport:",I),alert(`ðŸ“¥ TÃ©lÃ©chargement du rapport "${I.title}" dÃ©marrÃ©`)},M=I=>{b(x===I.id?null:I.id)},_=C.filter(I=>I.category===s&&I.frequency.includes(u)),D=(()=>{var R;const I=p.length,$=p.reduce((w,N)=>{if(N.fileSize){const g=parseFloat(N.fileSize);return w+(isNaN(g)?0:g)}return w},0);return{totalGenerated:I,totalSizeMB:$,lastGeneration:((R=p[0])==null?void 0:R.generatedAt)||null}})(),k=({category:I})=>{const $={comptable:{label:"Comptable",color:"bg-blue-100 text-blue-800 border-blue-300"},operationnel:{label:"OpÃ©rationnel",color:"bg-emerald-100 text-emerald-800 border-emerald-300"},analytique:{label:"Analytique",color:"bg-purple-100 text-purple-800 border-purple-300"}}[I];return e("span",{className:`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${$.color}`,children:$.label})},S=({period:I})=>t("span",{className:"inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-300",children:[e(dt,{className:"h-3 w-3"}),{daily:"Quotidien",weekly:"Hebdomadaire",monthly:"Mensuel",quarterly:"Trimestriel",custom:"PersonnalisÃ©"}[I]]}),O=({status:I})=>{const $={generating:{label:"GÃ©nÃ©ration...",icon:e(kt,{className:"h-3 w-3 animate-spin"}),color:"bg-amber-100 text-amber-800 border-amber-300"},ready:{label:"PrÃªt",icon:e(rt,{className:"h-3 w-3"}),color:"bg-emerald-100 text-emerald-800 border-emerald-300"},failed:{label:"Ã‰chec",icon:e(Ot,{className:"h-3 w-3"}),color:"bg-red-100 text-red-800 border-red-300"}}[I];return t("span",{className:`inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium border ${$.color}`,children:[$.icon,$.label]})};return t("div",{className:"space-y-6",children:[t("div",{className:"rounded-xl border border-gray-200 shadow-sm p-6 bg-gradient-to-r from-white to-gray-50/50",children:[t("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-indigo-50 to-purple-50 flex items-center justify-center",children:e(ft,{className:"h-6 w-6 text-indigo-600"})}),t("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:"Rapports comptables"}),e("div",{className:"text-sm text-gray-600",children:"GÃ©nÃ©ration de documents officiels pour la direction"})]})]}),e("div",{className:"flex items-center gap-3",children:t("button",{className:"inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 text-sm font-medium",children:[e(Pa,{className:"h-4 w-4"}),"Voir historique"]})})]}),e("div",{className:"mt-4 p-4 rounded-lg bg-blue-50 border border-blue-200",children:t("div",{className:"flex items-start gap-3",children:[e(sa,{className:"h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0"}),t("div",{children:[e("div",{className:"font-medium text-blue-800",children:"Documentation officielle"}),e("div",{className:"text-sm text-blue-700 mt-1",children:"Cette interface permet de gÃ©nÃ©rer des rapports comptables et financiers officiels destinÃ©s Ã  la direction, aux audits et aux partenaires. Tous les chiffres prÃ©sentÃ©s sont issus des donnÃ©es rÃ©elles de la compagnie."})]})]})})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-5",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center",children:e(Un,{className:"h-5 w-5 text-gray-600"})}),t("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Configuration du rapport"}),e("div",{className:"text-sm text-gray-600",children:"DÃ©finissez les paramÃ¨tres de gÃ©nÃ©ration"})]})]}),t("div",{className:"text-sm text-gray-600",children:[_.length," rapport",_.length>1?"s":""," disponible",_.length>1?"s":""]})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"CatÃ©gorie de rapport"}),t("select",{value:s,onChange:I=>i(I.target.value),className:"w-full border border-gray-300 rounded-xl px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:r.primary},children:[e("option",{value:"comptable",children:"Rapports comptables"}),e("option",{value:"operationnel",children:"Rapports opÃ©rationnels"}),e("option",{value:"analytique",children:"Rapports analytiques"})]})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"PÃ©riode"}),t("select",{value:u,onChange:I=>o(I.target.value),className:"w-full border border-gray-300 rounded-xl px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:r.primary},children:[e("option",{value:"monthly",children:"Mensuel (mois en cours)"}),e("option",{value:"weekly",children:"Hebdomadaire"}),e("option",{value:"quarterly",children:"Trimestriel"}),e("option",{value:"custom",children:"PÃ©riode personnalisÃ©e"})]})]}),e("div",{className:"flex items-end",children:t("button",{className:"w-full inline-flex items-center justify-center px-4 py-2.5 rounded-xl text-white font-medium",style:{background:`linear-gradient(135deg, ${r.primary}, ${r.secondary})`},children:[e(Un,{className:"h-4 w-4 mr-2"}),"Appliquer la configuration"]})})]}),u==="custom"&&t("div",{className:"mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 p-4 rounded-lg border border-blue-200 bg-blue-50",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Date de dÃ©but"}),e("input",{type:"date",className:"w-full border border-gray-300 rounded-lg px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:r.primary},value:c.start,onChange:I=>m($=>({...$,start:I.target.value}))})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Date de fin"}),e("input",{type:"date",className:"w-full border border-gray-300 rounded-lg px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:r.primary},value:c.end,onChange:I=>m($=>({...$,end:I.target.value}))})]})]}),t("div",{className:"mt-4 flex items-center justify-between p-3 rounded-lg bg-gray-50 border border-gray-200",children:[t("div",{className:"text-sm text-gray-700",children:[e("span",{className:"font-medium",children:"PÃ©riode par dÃ©faut : "}),u==="custom"&&c.start&&c.end?`${new Date(c.start).toLocaleDateString("fr-FR")} â†’ ${new Date(c.end).toLocaleDateString("fr-FR")}`:P().label]}),t("div",{className:"text-sm text-gray-600",children:[u==="monthly"&&"Mois en cours automatiquement sÃ©lectionnÃ©",u==="weekly"&&"7 derniers jours",u==="quarterly"&&"Trimestre en cours",u==="custom"&&"PÃ©riode personnalisÃ©e"]})]})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Historique des gÃ©nÃ©rations"}),e("div",{className:"text-sm text-gray-600",children:"DonnÃ©es rÃ©elles depuis la crÃ©ation"})]}),p.length===0?t("div",{className:"text-center py-8",children:[e(ft,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e("div",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun rapport gÃ©nÃ©rÃ©"}),e("div",{className:"text-gray-600",children:"GÃ©nÃ©rez votre premier rapport pour voir apparaÃ®tre les statistiques ici"})]}):t("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t("div",{className:"p-4 rounded-xl border border-gray-200",children:[t("div",{className:"flex items-center justify-between mb-4",children:[e("div",{className:"text-sm font-medium text-gray-500 uppercase tracking-wider",children:"Rapports gÃ©nÃ©rÃ©s"}),e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center",children:e(ft,{className:"h-5 w-5 text-blue-600"})})]}),e("div",{className:"text-3xl font-bold text-gray-900",children:D.totalGenerated}),e("div",{className:"text-sm text-gray-500 mt-2",children:"Depuis le dÃ©but"})]}),t("div",{className:"p-4 rounded-xl border border-gray-200",children:[t("div",{className:"flex items-center justify-between mb-4",children:[e("div",{className:"text-sm font-medium text-gray-500 uppercase tracking-wider",children:"Volume total"}),e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-emerald-50 to-green-50 flex items-center justify-center",children:e(Da,{className:"h-5 w-5 text-emerald-600"})})]}),t("div",{className:"text-3xl font-bold text-gray-900",children:[D.totalSizeMB.toFixed(1)," MB"]}),e("div",{className:"text-sm text-gray-500 mt-2",children:"Stockage rÃ©el utilisÃ©"})]}),t("div",{className:"p-4 rounded-xl border border-gray-200",children:[t("div",{className:"flex items-center justify-between mb-4",children:[e("div",{className:"text-sm font-medium text-gray-500 uppercase tracking-wider",children:"DerniÃ¨re gÃ©nÃ©ration"}),e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-amber-50 to-orange-50 flex items-center justify-center",children:e(xt,{className:"h-5 w-5 text-amber-600"})})]}),e("div",{className:"text-xl font-bold text-gray-900",children:D.lastGeneration?D.lastGeneration.toLocaleDateString("fr-FR",{day:"2-digit",month:"short"}):"Jamais"}),e("div",{className:"text-sm text-gray-500 mt-2",children:"Date rÃ©elle"})]})]})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[t("div",{className:"text-lg font-bold text-gray-900",children:[s==="comptable"&&"Rapports comptables disponibles",s==="operationnel"&&"Rapports opÃ©rationnels disponibles",s==="analytique"&&"Rapports analytiques disponibles"]}),t("div",{className:"text-sm text-gray-600",children:[_.length," rapport",_.length>1?"s":""]})]}),_.length===0?t("div",{className:"text-center py-12",children:[e(nt,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e("div",{className:"text-lg font-medium text-gray-900 mb-2",children:"Aucun rapport disponible"}),t("div",{className:"text-gray-600",children:['Aucun rapport de type "',s,`" n'est disponible pour la pÃ©riode "`,u,`". Changez de catÃ©gorie ou de pÃ©riode pour voir d'autres rapports.`]})]}):e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:_.map(I=>{const $=h===I.id;return t("div",{className:"border border-gray-200 rounded-xl p-5 hover:shadow-md transition-shadow",children:[t("div",{className:"flex items-start justify-between mb-4",children:[e("div",{className:`h-12 w-12 rounded-xl flex items-center justify-center ${I.color==="blue"?"bg-blue-50":I.color==="emerald"?"bg-emerald-50":I.color==="amber"?"bg-amber-50":I.color==="purple"?"bg-purple-50":"bg-indigo-50"}`,children:e("span",{className:I.color==="blue"?"text-blue-600":I.color==="emerald"?"text-emerald-600":I.color==="amber"?"text-amber-600":I.color==="purple"?"text-purple-600":"text-indigo-600",children:I.icon})}),e(k,{category:I.category})]}),e("h3",{className:"font-bold text-gray-900 mb-2",children:I.title}),e("p",{className:"text-sm text-gray-600 mb-4",children:I.description}),e("div",{className:"space-y-2 mb-4",children:t("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e(dt,{className:"h-3 w-3"}),t("span",{children:["Disponible en : ",I.frequency.map(R=>R==="daily"?"Quotidien":R==="weekly"?"Hebdomadaire":R==="monthly"?"Mensuel":"Trimestriel").join(", ")]})]})}),e("div",{className:"flex gap-2",children:e("button",{onClick:()=>j(I.id),disabled:$,className:"flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg text-white text-sm font-medium disabled:opacity-50",style:{background:`linear-gradient(135deg, ${r.primary}, ${r.secondary})`},children:$?t(Ae,{children:[e(kt,{className:"h-4 w-4 mr-2 animate-spin"}),"GÃ©nÃ©ration..."]}):t(Ae,{children:[e(Ns,{className:"h-4 w-4 mr-2"}),"GÃ©nÃ©rer"]})})})]},I.id)})})]}),p.length>0&&t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center justify-between mb-5",children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Rapports gÃ©nÃ©rÃ©s rÃ©cemment"}),t("div",{className:"text-sm text-gray-600",children:[p.length," rapport",p.length>1?"s":""]})]}),e("div",{className:"space-y-3",children:p.slice(0,5).map(I=>t("div",{className:"border border-gray-200 rounded-xl overflow-hidden",children:[e("div",{className:"p-4 bg-gradient-to-r from-gray-50 to-gray-100/50 border-b",children:t("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:`h-10 w-10 rounded-xl flex items-center justify-center ${I.type==="comptable"?"bg-blue-50":I.type==="operationnel"?"bg-emerald-50":"bg-purple-50"}`,children:e(ft,{className:I.type==="comptable"?"h-5 w-5 text-blue-600":I.type==="operationnel"?"h-5 w-5 text-emerald-600":"h-5 w-5 text-purple-600"})}),t("div",{children:[e("div",{className:"font-medium text-gray-900",children:I.title}),e("div",{className:"text-sm text-gray-500",children:I.periodLabel})]})]}),t("div",{className:"flex items-center gap-3",children:[e(O,{status:I.status}),e(S,{period:I.period}),e("button",{onClick:()=>M(I),className:"p-1 hover:bg-gray-100 rounded",children:x===I.id?e(Ta,{className:"h-4 w-4 text-gray-500"}):e(ya,{className:"h-4 w-4 text-gray-500"})})]})]})}),x===I.id&&e("div",{className:"p-4 border-t",children:t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t("div",{children:[e("div",{className:"text-sm font-medium text-gray-500 mb-2",children:"Informations du rapport"}),t("div",{className:"space-y-2",children:[t("div",{className:"flex justify-between text-sm",children:[e("span",{className:"text-gray-600",children:"GÃ©nÃ©rÃ© le :"}),e("span",{className:"font-medium text-gray-900",children:I.generatedAt.toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})})]}),t("div",{className:"flex justify-between text-sm",children:[e("span",{className:"text-gray-600",children:"Par :"}),e("span",{className:"font-medium text-gray-900",children:I.generatedBy})]}),t("div",{className:"flex justify-between text-sm",children:[e("span",{className:"text-gray-600",children:"PÃ©riode :"}),e("span",{className:"font-medium text-gray-900",children:I.periodLabel})]}),I.fileSize&&t("div",{className:"flex justify-between text-sm",children:[e("span",{className:"text-gray-600",children:"Taille :"}),e("span",{className:"font-medium text-gray-900",children:I.fileSize})]})]})]}),t("div",{children:[e("div",{className:"text-sm font-medium text-gray-500 mb-2",children:"Actions"}),t("div",{className:"flex gap-2",children:[t("button",{onClick:()=>L(I),className:"flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 text-sm font-medium",children:[e(Ca,{className:"h-4 w-4 mr-2"}),"TÃ©lÃ©charger"]}),t("button",{onClick:()=>j(I.id.split("-")[0]),className:"flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg text-white text-sm font-medium",style:{background:`linear-gradient(135deg, ${r.primary}, ${r.secondary})`},children:[e(kt,{className:"h-4 w-4 mr-2"}),"RegÃ©nÃ©rer"]})]})]})]})})]},I.id))}),p.length>5&&e("div",{className:"mt-4 text-center",children:t("button",{className:"text-sm text-blue-600 hover:text-blue-800 font-medium",children:["Voir tous les rapports gÃ©nÃ©rÃ©s (",p.length,")"]})})]}),t("div",{className:"rounded-xl border border-blue-300 bg-blue-50 p-5 shadow-sm",children:[t("div",{className:"flex items-center gap-3 mb-4",children:[e(sa,{className:"h-6 w-6 text-blue-600"}),e("div",{className:"text-lg font-bold text-blue-800",children:"Ã€ propos des rapports gÃ©nÃ©rÃ©s"})]}),t("div",{className:"text-blue-700",children:[e("p",{className:"mb-3",children:"Les rapports gÃ©nÃ©rÃ©s sont des documents officiels contenant des donnÃ©es financiÃ¨res rÃ©elles. Ils sont destinÃ©s Ã  :"}),t("ul",{className:"space-y-2 mb-4",children:[t("li",{className:"flex items-start gap-2",children:[e("div",{className:"h-5 w-5 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center flex-shrink-0 mt-0.5",children:"âœ“"}),e("span",{children:"La direction gÃ©nÃ©rale pour le pilotage stratÃ©gique"})]}),t("li",{className:"flex items-start gap-2",children:[e("div",{className:"h-5 w-5 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center flex-shrink-0 mt-0.5",children:"âœ“"}),e("span",{children:"Les audits internes et externes"})]}),t("li",{className:"flex items-start gap-2",children:[e("div",{className:"h-5 w-5 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center flex-shrink-0 mt-0.5",children:"âœ“"}),e("span",{children:"Les partenaires financiers et institutionnels"})]}),t("li",{className:"flex items-start gap-2",children:[e("div",{className:"h-5 w-5 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center flex-shrink-0 mt-0.5",children:"âœ“"}),e("span",{children:"Les autoritÃ©s de rÃ©gulation (le cas Ã©chÃ©ant)"})]})]}),t("div",{className:"bg-white p-4 rounded-lg border border-blue-200",children:[e("div",{className:"text-sm font-medium text-blue-800 mb-2",children:"ProcÃ©dure de gÃ©nÃ©ration"}),t("div",{className:"text-sm text-blue-700 space-y-1",children:[e("p",{children:"1. SÃ©lectionnez la catÃ©gorie et la pÃ©riode du rapport"}),e("p",{children:'2. Cliquez sur "GÃ©nÃ©rer" pour crÃ©er le document'}),e("p",{children:"3. TÃ©lÃ©chargez le rapport au format PDF"}),e("p",{children:"4. Le rapport est automatiquement archivÃ© dans l'historique"})]})]})]})]})]})},Bo=()=>{const{company:a}=Pe(),n=lt(a)||{primary:"#2563eb"},r=Jn(),[s,i]=l.useState({emailNotifications:!0,pushNotifications:!0,lowBalanceAlert:!0,alertThreshold:5e5,autoValidation:!1,validationDelay:2,minAmountForValidation:1e4,twoFactorAuth:!1,sessionTimeout:30,ipRestriction:!1,defaultCurrency:"XOF",dateFormat:"DD/MM/YYYY",showAmountsInThousands:!0,autoReportGeneration:!0,reportFrequency:"weekly",reportEmail:"",keepReportsFor:12}),[u,o]=l.useState(!1),[c,m]=l.useState("idle"),h=()=>{o(!0),setTimeout(()=>{o(!1),m("success"),setTimeout(()=>m("idle"),3e3)},1e3)},d=b=>{typeof s[b]=="boolean"&&i(P=>({...P,[b]:!P[b]}))},p=(b,P)=>{i(C=>({...C,[b]:P}))},f=({label:b,description:P,checked:C,onChange:j,icon:L})=>t("div",{className:"flex items-start justify-between p-4 border border-gray-200 rounded-xl hover:bg-gray-50/50",children:[t("div",{className:"flex items-start gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center",children:L}),t("div",{children:[e("div",{className:"font-medium text-gray-900",children:b}),e("div",{className:"text-sm text-gray-600 mt-1",children:P})]})]}),e("button",{onClick:j,className:`relative inline-flex h-6 w-11 items-center rounded-full ${C?"bg-[var(--btn-primary,#FF6600)]":"bg-gray-300"}`,children:e("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition ${C?"translate-x-6":"translate-x-1"}`})})]}),x=({label:b,description:P,value:C,onChange:j,type:L="text",options:M,icon:_})=>t("div",{className:"p-4 border border-gray-200 rounded-xl",children:[t("div",{className:"flex items-start gap-3 mb-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center",children:_}),t("div",{className:"flex-1",children:[e("div",{className:"font-medium text-gray-900",children:b}),e("div",{className:"text-sm text-gray-600 mt-1",children:P})]})]}),L==="select"&&M?e("select",{value:C,onChange:F=>j(F.target.value),className:"w-full border border-gray-300 rounded-lg px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:n.primary},children:M.map(F=>e("option",{value:F.value,children:F.label},F.value))}):e("input",{type:L,value:C,onChange:F=>j(L==="number"?Number(F.target.value):F.target.value),className:"w-full border border-gray-300 rounded-lg px-4 py-2.5 bg-white focus:outline-none focus:ring-2 focus:border-transparent",style:{outlineColor:n.primary}})]});return t("div",{className:"space-y-6",children:[t("div",{className:"rounded-xl border border-gray-200 shadow-sm p-6 bg-gradient-to-r from-white to-gray-50/50",children:[t("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-12 w-12 rounded-xl bg-gradient-to-br from-slate-50 to-gray-50 flex items-center justify-center",children:e(bn,{className:"h-6 w-6 text-gray-600"})}),t("div",{children:[e("div",{className:"text-xl font-bold text-gray-900",children:"ParamÃ¨tres comptables"}),e("div",{className:"text-sm text-gray-600",children:"Configuration de l'espace chef comptable"})]})]}),t(je,{variant:"primary",onClick:h,disabled:u,className:"inline-flex items-center gap-2",children:[u?e(kt,{className:"h-4 w-4 animate-spin"}):c==="success"?e(rt,{className:"h-4 w-4"}):e(ba,{className:"h-4 w-4"}),u?"Enregistrement...":c==="success"?"EnregistrÃ© !":"Enregistrer"]})]}),c==="success"&&e("div",{className:"mt-4 p-3 rounded-lg bg-emerald-50 border border-emerald-200",children:e("div",{className:"text-emerald-700 text-sm",children:"Les paramÃ¨tres ont Ã©tÃ© enregistrÃ©s avec succÃ¨s."})})]}),t("div",{className:"space-y-6",children:[t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center gap-3 mb-5",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center",children:e(In,{className:"h-5 w-5 text-blue-600"})}),t("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Alertes et notifications"}),e("div",{className:"text-sm text-gray-600",children:"Configurez les notifications systÃ¨me"})]})]}),t("div",{className:"space-y-3",children:[e(f,{label:"Notifications par email",description:"Recevoir les alertes importantes par email",checked:s.emailNotifications,onChange:()=>d("emailNotifications"),icon:e(In,{className:"h-5 w-5"})}),e(f,{label:"Notifications push",description:"Alerte en temps rÃ©el dans le navigateur",checked:s.pushNotifications,onChange:()=>d("pushNotifications"),icon:e(nt,{className:"h-5 w-5"})}),e(f,{label:"Alerte solde bas",description:"Recevoir une alerte quand le solde d'une caisse est bas",checked:s.lowBalanceAlert,onChange:()=>d("lowBalanceAlert"),icon:e(wt,{className:"h-5 w-5"})}),e(x,{label:"Seuil d'alerte solde bas",description:`Montant minimum dÃ©clenchant une alerte (${r})`,value:s.alertThreshold,onChange:b=>p("alertThreshold",b),type:"number",icon:e(nt,{className:"h-5 w-5"})})]})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center gap-3 mb-5",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-emerald-50 to-green-50 flex items-center justify-center",children:e(rt,{className:"h-5 w-5 text-emerald-600"})}),t("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Validation automatique"}),e("div",{className:"text-sm text-gray-600",children:"ParamÃ¨tres de validation des rÃ©servations"})]})]}),t("div",{className:"space-y-3",children:[e(f,{label:"Validation automatique",description:"Valider automatiquement les rÃ©servations avec preuve",checked:s.autoValidation,onChange:()=>d("autoValidation"),icon:e(kt,{className:"h-5 w-5"})}),e(x,{label:"DÃ©lai de validation",description:"Heures avant validation automatique",value:s.validationDelay,onChange:b=>p("validationDelay",b),type:"number",icon:e(Pa,{className:"h-5 w-5"})}),e(x,{label:"Montant minimum",description:`Montant minimum pour validation auto (${r})`,value:s.minAmountForValidation,onChange:b=>p("minAmountForValidation",b),type:"number",icon:e(wt,{className:"h-5 w-5"})})]})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center gap-3 mb-5",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-amber-50 to-orange-50 flex items-center justify-center",children:e(qt,{className:"h-5 w-5 text-amber-600"})}),t("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"SÃ©curitÃ©"}),e("div",{className:"text-sm text-gray-600",children:"ParamÃ¨tres de sÃ©curitÃ© de l'espace"})]})]}),t("div",{className:"space-y-3",children:[e(f,{label:"Authentification Ã  deux facteurs",description:"Exiger une validation supplÃ©mentaire pour la connexion",checked:s.twoFactorAuth,onChange:()=>d("twoFactorAuth"),icon:e(qt,{className:"h-5 w-5"})}),e(x,{label:"DÃ©lai de session",description:"Minutes avant dÃ©connexion automatique",value:s.sessionTimeout,onChange:b=>p("sessionTimeout",b),type:"number",icon:e(Ri,{className:"h-5 w-5"})}),e(f,{label:"Restriction d'adresse IP",description:"Limiter l'accÃ¨s Ã  certaines adresses IP",checked:s.ipRestriction,onChange:()=>d("ipRestriction"),icon:e(nt,{className:"h-5 w-5"})})]})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center gap-3 mb-5",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-purple-50 to-pink-50 flex items-center justify-center",children:e(Pa,{className:"h-5 w-5 text-purple-600"})}),t("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Affichage"}),e("div",{className:"text-sm text-gray-600",children:"PrÃ©fÃ©rences d'affichage des donnÃ©es"})]})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e(x,{label:"Devise par dÃ©faut",description:"Devise d'affichage des montants",value:s.defaultCurrency,onChange:b=>p("defaultCurrency",b),type:"select",options:[{value:"XOF",label:`${hi("XOF")} / XOF (Franc CFA)`},{value:"EUR",label:"EUR (Euro)"},{value:"USD",label:"USD (Dollar)"}],icon:e(wt,{className:"h-5 w-5"})}),e(x,{label:"Format de date",description:"Format d'affichage des dates",value:s.dateFormat,onChange:b=>p("dateFormat",b),type:"select",options:[{value:"DD/MM/YYYY",label:"JJ/MM/AAAA (franÃ§ais)"},{value:"MM/DD/YYYY",label:"MM/JJ/AAAA (amÃ©ricain)"},{value:"YYYY-MM-DD",label:"AAAA-MM-JJ (international)"}],icon:e(dt,{className:"h-5 w-5"})}),e("div",{className:"md:col-span-2",children:e(f,{label:"Montants en milliers",description:"Afficher les montants en milliers (ex: 15K au lieu de 15000)",checked:s.showAmountsInThousands,onChange:()=>d("showAmountsInThousands"),icon:e(ft,{className:"h-5 w-5"})})})]})]}),t("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm",children:[t("div",{className:"flex items-center gap-3 mb-5",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-50 to-blue-50 flex items-center justify-center",children:e(ft,{className:"h-5 w-5 text-indigo-600"})}),t("div",{children:[e("div",{className:"text-lg font-bold text-gray-900",children:"Rapports"}),e("div",{className:"text-sm text-gray-600",children:"Configuration des rapports automatiques"})]})]}),t("div",{className:"space-y-3",children:[e(f,{label:"GÃ©nÃ©ration automatique",description:"GÃ©nÃ©rer automatiquement les rapports pÃ©riodiques",checked:s.autoReportGeneration,onChange:()=>d("autoReportGeneration"),icon:e(kt,{className:"h-5 w-5"})}),e(x,{label:"FrÃ©quence des rapports",description:"FrÃ©quence de gÃ©nÃ©ration des rapports",value:s.reportFrequency,onChange:b=>p("reportFrequency",b),type:"select",options:[{value:"daily",label:"Quotidien"},{value:"weekly",label:"Hebdomadaire"},{value:"monthly",label:"Mensuel"},{value:"quarterly",label:"Trimestriel"}],icon:e(dt,{className:"h-5 w-5"})}),e(x,{label:"Email des rapports",description:"Adresse email pour recevoir les rapports",value:s.reportEmail,onChange:b=>p("reportEmail",b),type:"text",icon:e(In,{className:"h-5 w-5"})}),e(x,{label:"Conservation des rapports",description:"Nombre de mois de conservation",value:s.keepReportsFor,onChange:b=>p("keepReportsFor",b),type:"number",icon:e(qt,{className:"h-5 w-5"})})]})]})]})]})},rp=Object.freeze(Object.defineProperty({__proto__:null,Finances:qo,Parametres:Bo,Rapports:Uo,ReservationsEnLigne:Oo,VueGlobale:jo},Symbol.toStringTag,{value:"Module"}));async function Go(){return(await ee(Q(G,"villes"))).docs.map(r=>{const s=r.data();return((s==null?void 0:s.nom)??"").toString().trim()}).filter(Boolean).sort((r,s)=>r.localeCompare(s,"fr"))}function qs(){const[a,n]=l.useState([]),[r,s]=l.useState(!0),[i,u]=l.useState(null);return l.useEffect(()=>{let o=!1;return(async()=>{s(!0),u(null);try{const m=await Go();o||n(m)}catch(m){o||(u(m instanceof Error?m:new Error(String(m))),n([]))}finally{o||s(!1)}})(),()=>{o=!0}},[]),{villes:a,loading:r,error:i}}const Gn=({value:a,onChange:n,placeholder:r="Villeâ€¦",required:s=!1})=>{const{villes:i}=qs(),[u,o]=l.useState(!1),[c,m]=l.useState(0),h=l.useRef(null),d=C=>C.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/['â€™`-]/g," ").replace(/\s+/g," ").trim(),p=l.useMemo(()=>{const C=d(a);if(!C)return i;const j=[],L=[];for(const M of i){const _=d(M);_.startsWith(C)?j.push(M):_.includes(C)&&L.push(M)}return[...j,...L]},[i,a]);l.useEffect(()=>{m(0)},[p]);const f=()=>{i.length>0&&o(!0)};l.useEffect(()=>{const C=j=>{h.current&&!h.current.contains(j.target)&&o(!1)};return document.addEventListener("mousedown",C),()=>document.removeEventListener("mousedown",C)},[]);const x=C=>{n(C),o(!1)},b=C=>{if(!u||p.length===0){C.key==="Escape"&&o(!1);return}switch(C.key){case"ArrowDown":C.preventDefault(),m(j=>Math.min(j+1,p.length-1));break;case"ArrowUp":C.preventDefault(),m(j=>Math.max(0,j-1));break;case"Enter":C.preventDefault(),p[c]&&x(p[c]);break;case"Escape":C.preventDefault(),o(!1);break}},P=u&&p.length>0;return t("div",{ref:h,className:"flex-1 relative z-20",children:[t("div",{className:"flex items-center border border-gray-200 rounded-xl px-3 py-2 bg-white",children:[e(Kt,{className:"h-5 w-5 text-gray-500 mr-2 shrink-0"}),e("input",{type:"text",value:a,onChange:C=>n(C.target.value),onFocus:f,onKeyDown:b,placeholder:r,required:s,className:"flex-1 outline-none text-gray-900 placeholder-gray-400 bg-white caret-gray-900 min-w-0",autoComplete:"off"})]}),P&&e("ul",{className:"absolute top-full left-0 right-0 mt-1 max-h-60 overflow-y-auto rounded-xl bg-white border border-gray-200 shadow-lg z-50",role:"listbox",children:p.map((C,j)=>e("li",{className:`px-3 py-2 text-gray-900 hover:bg-gray-100 cursor-pointer ${j===c?"bg-gray-100":""}`,onMouseEnter:()=>m(j),onMouseDown:L=>{L.preventDefault(),x(C)},children:C},C))})]})};function zo(a){return(a||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}function Vo(a){const n=zo(a);return n?/(agence\s*)?principal(e)?/.test(n)?"AP":n.split(/\s+/).filter(Boolean).map(s=>s[0]).join("").toUpperCase().slice(0,2):""}async function Ho(a){const{companyId:n,companyCode:r,agencyCode:s,agencyName:i,tripInstanceId:u,sellerCode:o}=a,c=s&&s.trim()?s.toUpperCase():Vo(i)||"AG",m=me(G,`companies/${n}/counters/byTrip/trips/${u}`),h=await Hn(G,async d=>{const p=await d.get(m),x=(p.exists()&&p.data().lastSeq||0)+1;return p.exists()?d.update(m,{lastSeq:x,updatedAt:fe.now()}):d.set(m,{lastSeq:x,updatedAt:fe.now()}),x}).catch(async()=>(await Bt(m,{lastSeq:1,updatedAt:fe.now()},{merge:!0}),1));return`${r.toUpperCase()}-${c}-${o}-${String(h).padStart(4,"0")}`}async function Yo(a){return Ho({...a,sellerCode:"WEB"})}const Ma="pendingReservation",sn=a=>["preuve_recue","confirme"].includes(String(a||"").toLowerCase()),Fr=a=>{try{localStorage.setItem(Ma,JSON.stringify(a))}catch{}},Pn=()=>{try{const a=localStorage.getItem(Ma);return a?JSON.parse(a):null}catch{return null}},Ko=()=>{try{const a=localStorage.getItem(Ma);if(!a)return;const n=JSON.parse(a);sn(n==null?void 0:n.status)||localStorage.removeItem(Ma)}catch{}},Wo=()=>{try{localStorage.removeItem(Ma)}catch{}},Jo=(a,n)=>{try{localStorage.setItem(`lastPaymentMethod_${a}`,n)}catch{}},Xo=a=>{if(!a)return null;try{return localStorage.getItem(`lastPaymentMethod_${a}`)}catch{return null}},Qo=a=>{if(a)try{localStorage.removeItem(`lastPaymentMethod_${a}`)}catch{}},Zo=(a,n)=>{try{localStorage.setItem(`paymentTriggeredAt_${a}`,String(n))}catch{}},ec=a=>{if(!a)return null;try{const n=localStorage.getItem(`paymentTriggeredAt_${a}`);return n?Number(n):null}catch{return null}},tc=a=>{if(a)try{localStorage.removeItem(`paymentTriggeredAt_${a}`)}catch{}},ac=()=>Math.random().toString(36).slice(2,8).toUpperCase(),za=a=>(a==null?void 0:a.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/-/g," ").replace(/\s+/g," "))||"",Or=a=>`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`,Va=a=>a&&a.charAt(0).toUpperCase()+a.slice(1).toLowerCase(),nc=(a,n)=>new Date(a.getTime()+n*6e4),rc=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],sc=a=>a.replace(/\D/g,"").slice(0,8).replace(/(\d{2})(?=\d)/g,"$1 ").trim(),lc=a=>a.replace(/\s/g,"").length===8,qr=({reservationId:a,paymentMethods:n,paymentMethodKey:r,onChoosePayment:s,message:i,setMessage:u,referenceInputRef:o,canConfirm:c,submitProofInline:m,uploading:h,paymentHints:d,existing:p,selectedTrip:f,seats:x,theme:b})=>{var M;const P=((p==null?void 0:p.statut)==="preuve_recue"||(p==null?void 0:p.statut)==="confirme")??!1,C=(p==null?void 0:p.statut)==="preuve_recue",j=(p==null?void 0:p.statut)==="confirme",L=!!r;return t("section",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:[e("h2",{className:"text-sm font-semibold text-gray-900 mb-2",children:a?"Paiement":"Preuve de paiement"}),C&&t("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[t("div",{className:"flex items-center gap-2 text-blue-800",children:[e(xt,{className:"w-4 h-4"}),e("span",{className:"text-sm font-medium",children:"Preuve envoyÃ©e"})]}),e("p",{className:"text-xs text-blue-700 mt-1",children:"Votre preuve de paiement est en cours de vÃ©rification par la compagnie."})]}),j&&t("div",{className:"mb-4 p-3 bg-emerald-50 border border-emerald-200 rounded-lg",children:[t("div",{className:"flex items-center gap-2 text-emerald-800",children:[e(nr,{className:"w-4 h-4"}),e("span",{className:"text-sm font-medium",children:"Paiement confirmÃ©"})]}),e("p",{className:"text-xs text-emerald-700 mt-1",children:"Votre paiement a Ã©tÃ© validÃ©. Votre billet est confirmÃ©."})]}),!P&&t("div",{className:"mb-3",children:[e("h3",{className:"text-sm font-semibold text-gray-900 mb-1",children:"Choisissez votre moyen de paiement"}),e("p",{className:"text-xs text-gray-600",children:"Cliquez sur un moyen de paiement pour continuer"})]}),e("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2",children:Object.entries(n).map(([_,F])=>F&&t("button",{onClick:()=>!P&&s(_),disabled:P,className:`h-12 px-3 rounded-xl border flex items-center gap-2 text-sm w-full transition-all duration-200 ${P?"opacity-50 cursor-not-allowed":"cursor-pointer hover:shadow-md hover:-translate-y-0.5"} ${r===_?"bg-white shadow-sm":""}`,style:{borderColor:r===_?b.primary:"#e5e7eb",backgroundColor:!P&&!r?`${b.primary}08`:"#f9fafb",cursor:P?"not-allowed":"pointer"},title:P?"Le paiement a dÃ©jÃ  Ã©tÃ© traitÃ©":`Payer avec ${_.replace(/_/g," ")}`,children:[F.logoUrl?e("img",{src:F.logoUrl,alt:_,className:"h-6 w-6 object-contain rounded"}):e("div",{className:"h-6 w-6 rounded bg-gray-100"}),t("div",{className:"text-left min-w-0",children:[e("div",{className:"font-medium capitalize truncate",children:_.replace(/_/g," ")}),F.merchantNumber&&t("div",{className:"text-[11px] text-gray-500 truncate",children:["NÂ° ",F.merchantNumber]})]}),r===_&&!P&&e("div",{className:"ml-auto h-5 w-5 rounded-full flex items-center justify-center",style:{backgroundColor:b.primary,color:"#fff"},children:e(rt,{className:"w-3 h-3"})})]},_))}),L&&t(Ve.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:"mt-4",children:[t("div",{className:"mb-3",children:[e("h3",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Preuve de paiement"}),e("p",{className:"text-xs text-gray-600 mb-3",children:d}),r&&((M=n[r])==null?void 0:M.ussdPattern)&&!P&&t("div",{className:"mt-1 text-xs text-gray-600",children:["Code USSD : ",e("span",{className:"font-mono bg-gray-50 px-2 py-1 rounded",children:n[r].ussdPattern.replace("MERCHANT",n[r].merchantNumber||"").replace("AMOUNT",String((p==null?void 0:p.montant)||(f?f.price*x:0)))})]})]}),!P&&t(Ae,{children:[e("div",{className:"mt-3",children:t("div",{children:[e("textarea",{ref:o,rows:3,className:"w-full border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:outline-none",placeholder:"Ex : code reÃ§u par SMS (ex. 123456) ou nÂ° de transfert",value:i,onChange:_=>u(_.target.value)}),e("div",{className:"text-xs text-gray-500 mt-1",children:"Minimum 4 caractÃ¨res"})]})}),t("div",{className:"mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e("div",{className:"text-xs text-amber-600",children:!c&&r&&t("span",{className:"flex items-center gap-1",children:[e(Ct,{className:"w-3 h-3"}),"Entrez une rÃ©fÃ©rence (â‰¥ 4 caractÃ¨res)"]})}),e("button",{onClick:m,disabled:h||!c||P,title:c?P?"Le paiement a dÃ©jÃ  Ã©tÃ© traitÃ©":"":"Ajoutez la rÃ©fÃ©rence",className:"h-11 px-5 rounded-xl font-semibold shadow-sm disabled:opacity-60 disabled:cursor-not-allowed transition hover:brightness-[0.98]",style:{background:`linear-gradient(135deg, ${b.primary}, ${b.secondary})`,color:"#fff"},children:h?"Envoiâ€¦":"Confirmer l'envoi"})]})]})]}),!L&&!P&&e(Ve.div,{initial:{opacity:0},animate:{opacity:1},className:"mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg",children:t("div",{className:"flex items-center gap-2 text-gray-700",children:[e(sa,{className:"w-4 h-4 text-gray-500"}),e("p",{className:"text-xs",children:"Choisissez un moyen de paiement ci-dessus pour continuer."})]})})]})};function ic(){var We;const{slug:a,id:n}=De(),r=Xt(),s=Be(),i=Qe(),u=Tt(),o=l.useRef(null),c=l.useRef(null),m=l.useRef(null),h=l.useRef(null),d=r.state||{},p=new URLSearchParams(r.search),f=za(p.get("departure")||""),x=za(p.get("arrival")||""),[b,P]=l.useState({id:"",name:"",couleurPrimaire:"#f43f5e",couleurSecondaire:"#f97316",logoUrl:"",code:""}),C=l.useMemo(()=>({primary:b.couleurPrimaire,secondary:b.couleurSecondaire,lightPrimary:`${b.couleurPrimaire}1A`,lightSecondary:`${b.couleurSecondaire}1A`,veryLightPrimary:`${b.couleurPrimaire}08`}),[b]),[j,L]=l.useState({}),[M,_]=l.useState({}),[F,D]=l.useState(null),[k,S]=l.useState(null),[O,I]=l.useState([]),[$,R]=l.useState([]),[w,N]=l.useState(""),[g,v]=l.useState(""),[U,E]=l.useState(1),[B,V]=l.useState({fullName:"",phone:""}),[K,z]=l.useState(""),[T,W]=l.useState(null),[q,H]=l.useState(!1),[le,te]=l.useState(!1),[ae,de]=l.useState(!0),[re,pe]=l.useState(""),[he,y]=l.useState({}),[A,J]=l.useState(null),[se,ye]=l.useState(!1),[X,ge]=l.useState("personal"),Ee=l.useMemo(()=>{if(A){const Z=String(A.statut||"").toLowerCase();return sn(Z)}return!1},[A]);l.useMemo(()=>!!T&&!A,[T,A]),l.useEffect(()=>{if(!F&&T){const Z=Xo(T);Z&&M[Z]&&D(Z)}},[F,T,M]),l.useEffect(()=>{if(!k&&T){const Z=ec(T);Z&&S(Z)}},[k,T]),l.useEffect(()=>{A&&(A.statut==="en_attente_paiement"&&(ge("payment"),F&&ge("proof")),(A.statut==="preuve_recue"||A.statut==="confirme")&&ge("proof"))},[A,F]),l.useEffect(()=>{Ko()},[a,s,n]),l.useEffect(()=>{(A==null?void 0:A.statut)==="confirme"&&(Wo(),Qo(A.id),tc(A.id))},[A==null?void 0:A.statut,A==null?void 0:A.id]),l.useEffect(()=>{(async()=>{if(n){de(!0);try{if(!d.companyId||!d.agencyId){pe("Information manquante (company/agency). Revenez en arriÃ¨re et rÃ©essayez."),de(!1);return}const ue=me(G,"companies",d.companyId,"agences",d.agencyId,"reservations",n),ve=await Se(ue);if(!ve.exists()){pe("RÃ©servation introuvable."),de(!1);return}const be=ve.data(),Ze=await Se(me(G,"companies",d.companyId)),$e=Ze.exists()?Ze.data():{};P({id:d.companyId,name:$e.nom||$e.name||"",code:($e.code||"").toString().toUpperCase(),couleurPrimaire:$e.couleurPrimaire||"#f43f5e",couleurSecondaire:$e.couleurSecondaire||"#f97316",logoUrl:$e.logoUrl||""});const Xe=await Se(me(G,"companies",d.companyId,"agences",d.agencyId)),ke=Xe.exists()?Xe.data():{};L({id:d.agencyId,nom:ke.nomAgence||ke.nom||ke.name||"Agence",telephone:ke.telephone,code:(ke.code||ke.codeAgence||"").toString().toUpperCase()||void 0});const Qt=await ee(ce(Q(G,"paymentMethods"),ne("companyId","==",d.companyId))),it={};Qt.forEach(_e=>{const Ye=_e.data();Ye.name&&(it[Ye.name]={url:Ye.defaultPaymentUrl||"",logoUrl:Ye.logoUrl||"",ussdPattern:Ye.ussdPattern||"",merchantNumber:Ye.merchantNumber||""})}),_(it),J({id:n,companyId:d.companyId,agencyId:d.agencyId,canal:be.canal,statut:be.statut,nomClient:be.nomClient,telephone:be.telephone,depart:be.depart,arrivee:be.arrivee||be.arrival,date:be.date,heure:be.heure,montant:be.montant??be.montant_total,seatsGo:be.seatsGo,referenceCode:be.referenceCode}),W(n),de(!1)}catch(ue){console.error(ue),pe((ue==null?void 0:ue.message)||"Erreur de chargement"),de(!1)}}})()},[n,d.companyId,d.agencyId]),l.useEffect(()=>{if(n)return;if(!a||!f||!x){de(!1);return}(async()=>{var ue,ve,be,Ze;de(!0);try{const $e=await ee(ce(Q(G,"companies"),ne("slug","==",a)));if($e.empty)throw new Error("Compagnie introuvable");const Xe=$e.docs[0],ke=Xe.data();P({id:Xe.id,name:ke.nom||ke.name||"",code:(ke.code||"").toString().toUpperCase(),couleurPrimaire:ke.couleurPrimaire||"#f43f5e",couleurSecondaire:ke.couleurSecondaire||"#f97316",logoUrl:ke.logoUrl||""});const it=(await ee(Q(G,"companies",Xe.id,"agences"))).docs.map(Le=>({id:Le.id,...Le.data()}));if(it[0]){const Le=it[0];L({id:Le.id,nom:Le.nomAgence||Le.nom||Le.name,telephone:Le.telephone,code:(Le.code||Le.codeAgence||"").toString().toUpperCase()||void 0})}const _e=await ee(ce(Q(G,"paymentMethods"),ne("companyId","==",Xe.id))),Ye={};_e.forEach(Le=>{const gt=Le.data();gt.name&&(Ye[gt.name]={url:gt.defaultPaymentUrl||"",logoUrl:gt.logoUrl||"",ussdPattern:gt.ussdPattern||"",merchantNumber:gt.merchantNumber||""})}),_(Ye);const zt=Array.from({length:8},(Le,gt)=>{const ea=new Date;return ea.setDate(ea.getDate()+gt),Or(ea)}),bt=[];for(const Le of it){const[gt,ea]=await Promise.all([ee(ce(Q(G,"companies",Xe.id,"agences",Le.id,"weeklyTrips"),ne("active","==",!0))),ee(Q(G,"companies",Xe.id,"agences",Le.id,"reservations"))]),wl=gt.docs.map(ct=>({id:ct.id,...ct.data()})).filter(ct=>za(ct.depart||ct.departure||"")===f&&za(ct.arrivee||ct.arrival||"")===x),Cl=ea.docs.map(ct=>({id:ct.id,...ct.data()}));zt.forEach(ct=>{const Sl=new Date(ct),Al=rc[Sl.getDay()];wl.forEach(Vt=>{var hr;(((hr=Vt.horaires)==null?void 0:hr[Al])||[]).forEach(An=>{if(ct===Or(new Date)){const ta=new Date,En=Ua(`${String(ta.getHours()).padStart(2,"0")}:${String(ta.getMinutes()).padStart(2,"0")}`,"HH:mm",new Date);if(Ua(An,"HH:mm",new Date)<=En)return}const fr=`${Vt.id}_${ct}_${An}`,yr=Vt.places||30,El=Cl.filter(ta=>String(ta.trajetId)===fr&&["confirme","paye"].includes(pn(ta.statut))).reduce((ta,En)=>ta+(En.seatsGo||0),0),br=yr-El;br>0&&bt.push({id:fr,date:ct,time:An,departure:Vt.depart||Vt.departure||"",arrival:Vt.arrivee||Vt.arrival||"",price:Vt.price,agencyId:Le.id,companyId:Xe.id,places:yr,remainingSeats:br})})})})}const da=bt.sort((Le,gt)=>Le.date.localeCompare(gt.date)||Le.time.localeCompare(gt.time)),Zt=[...new Set(da.map(Le=>Le.date))];I(da),R(Zt),N(Zt[0]||""),sessionStorage.setItem(`preload_${a}_${f}_${x}`,JSON.stringify({company:{id:Xe.id,name:ke.nom||"",couleurPrimaire:ke.couleurPrimaire||"#f43f5e",couleurSecondaire:ke.couleurSecondaire||"#f97316",logoUrl:ke.logoUrl||"",code:(ke.code||"MT").toString().toUpperCase()},trips:da,dates:Zt,agencyInfo:{nom:((ue=it[0])==null?void 0:ue.nomAgence)||((ve=it[0])==null?void 0:ve.nom)||"",telephone:((be=it[0])==null?void 0:be.telephone)||"",code:(Ze=it[0])==null?void 0:Ze.code}}))}catch($e){pe(($e==null?void 0:$e.message)||"Erreur de chargement")}finally{de(!1)}})()},[a,f,x,n]),l.useEffect(()=>{T&&X==="personal"&&ge("payment")},[T,X]),l.useEffect(()=>{F&&X==="payment"&&ge("proof")},[F,X]);const Ne=l.useMemo(()=>{if(!w)return[];const Z=O.filter(ue=>ue.date===w);if(vr(fa(w))){const ue=new Date,ve=Ua(`${String(ue.getHours()).padStart(2,"0")}:${String(ue.getMinutes()).padStart(2,"0")}`,"HH:mm",new Date);return Z.filter(be=>Ua(be.time,"HH:mm",new Date)>ve)}return Z},[O,w]);l.useEffect(()=>{!n&&Ne.length&&!g&&v(Ne[0].time)},[Ne,g,n]);const ie=Ne.find(Z=>Z.time===g),Ie=(ie==null?void 0:ie.price)??((We=Ne[0])==null?void 0:We.price),Me=(Z,ue)=>{const ve=Z/ue;return ve>.7?"#16a34a":ve>.3?"#f59e0b":"#dc2626"},Ke=()=>{const Z={};return B.fullName.trim()||(Z.fullName="Le nom complet est requis"),B.phone.trim()?lc(B.phone)||(Z.phone="NumÃ©ro invalide (format attendu : 22 22 22 22)"):Z.phone="Le numÃ©ro de tÃ©lÃ©phone est requis",y(Z),Object.keys(Z).length>0?(Z.fullName&&c.current?(c.current.scrollIntoView({behavior:"smooth",block:"center"}),c.current.focus()):Z.phone&&m.current&&(m.current.scrollIntoView({behavior:"smooth",block:"center"}),m.current.focus()),!1):!0},Ue=l.useCallback(async()=>{if(Ee){const ue=Pn();ue&&sn(ue.status)&&ue.slug===a&&s(`/${a}/reservation/${ue.id}`,{replace:!0,state:{companyId:ue.companyId,agencyId:ue.agencyId}});return}if(!Ke()){pe("Veuillez corriger les erreurs ci-dessus");return}if(!ie){pe("Veuillez sÃ©lectionner un horaire");return}const Z=Pn();if(Z&&sn(Z.status)&&Z.slug===a){s(`/${a}/reservation/${Z.id}`,{replace:!0,state:{companyId:Z.companyId,agencyId:Z.agencyId}});return}if(!q){H(!0),pe(""),y({});try{let ue=function(Le){return Le?Le.trim().split(/\s+/).map(ea=>ea[0]).join("").toUpperCase().slice(0,3):""};const ve=await Se(me(G,"companies",ie.companyId,"agences",ie.agencyId)),be=ve.exists()?ve.data():{},Ze=be.nomAgence||be.nom||be.name||"Agence",$e=(be.code||be.codeAgence||"").toString().toUpperCase()||void 0,Xe=await Se(me(G,"companies",ie.companyId)),ke=Xe.exists()?Xe.data():{},Qt=(ke.code||b.code||"").toString().trim(),it=Qt?Qt.toUpperCase():ue(ke.nom||ke.name);console.log("Company Code utilisÃ© :",it);const _e=await Yo({companyId:ie.companyId,companyCode:it,agencyId:ie.agencyId,agencyCode:$e,agencyName:Ze,tripInstanceId:ie.id}),Ye=new Date,zt={nomClient:B.fullName.trim(),telephone:B.phone.trim(),depart:ie.departure,arrivee:ie.arrival,date:ie.date,heure:ie.time,montant:ie.price*U,seatsGo:U,seatsReturn:0,tripType:"aller_simple",statut:"en_attente_paiement",canal:"en_ligne",companyId:ie.companyId,companySlug:a,companyName:b.name,agencyId:ie.agencyId,agencyNom:Ze,nomAgence:Ze,referenceCode:_e,trajetId:ie.id,holdUntil:nc(Ye,15),createdAt:Oe(),updatedAt:Oe()},bt=await Na(Q(G,"companies",ie.companyId,"agences",ie.agencyId,"reservations"),zt),da=ac(),Zt=`${window.location.origin}/${a}/mon-billet?r=${encodeURIComponent(da)}`;await He(me(G,"companies",ie.companyId,"agences",ie.agencyId,"reservations",bt.id),{publicToken:da,publicUrl:Zt});try{await navigator.clipboard.writeText(Zt)}catch{}W(bt.id),ge("payment"),setTimeout(()=>{var Le;(Le=o.current)==null||Le.scrollIntoView({behavior:"smooth",block:"center"})},100),ye(!0),Fr({slug:a,id:bt.id,referenceCode:_e,status:"en_attente_paiement",companyId:ie.companyId,agencyId:ie.agencyId}),sessionStorage.setItem("reservationDraft",JSON.stringify({...zt,id:bt.id,publicUrl:Zt})),sessionStorage.setItem("companyInfo",JSON.stringify({id:b.id,name:b.name,logoUrl:b.logoUrl,couleurPrimaire:b.couleurPrimaire,couleurSecondaire:b.couleurSecondaire,slug:a}))}catch(ue){pe((ue==null?void 0:ue.message)||"Impossible de crÃ©er la rÃ©servation")}finally{H(!1)}}},[Ee,ie,B,U,q,a,b,s,Ke]),at=l.useCallback(Z=>{var Ze;if(D(Z),T){Jo(T,Z);const $e=Date.now();S($e),Zo(T,$e)}ge("proof"),setTimeout(()=>{var $e,Xe;($e=h.current)==null||$e.scrollIntoView({behavior:"smooth",block:"center"}),(Xe=h.current)==null||Xe.focus()},300);const ue=M[Z||""];if(!ue)return;const ve=A?A.montant||0:ie?ie.price*U:Ie||0,be=(Ze=ue.ussdPattern)==null?void 0:Ze.replace("MERCHANT",ue.merchantNumber||"").replace("AMOUNT",String(ve));if(ue.url)try{new URL(ue.url),window.open(ue.url,"_blank","noopener,noreferrer")}catch{}else be&&(window.location.href=`tel:${encodeURIComponent(be)}`)},[M,A,ie,U,Ie,T]),Ge=l.useMemo(()=>{if(!F)return"Choisissez un moyen de paiement pour voir les instructions.";switch(F){case"orangemoney":return"AprÃ¨s votre paiement Orange Money, copiez le code reÃ§u par SMS";case"moov":return"AprÃ¨s votre paiement Moov Money, indiquez la rÃ©fÃ©rence reÃ§ue par SMS";case"wave":return"AprÃ¨s votre paiement Wave, copiez le code du reÃ§u";case"cash":return"Paiement au guichet : entrez le nÂ° du reÃ§u";default:return"Copiez la rÃ©fÃ©rence reÃ§ue par SMS aprÃ¨s paiement"}},[F]),qe=l.useMemo(()=>!T||!F?!1:K.trim().length>=4,[T,F,K]),pt=async()=>{const Z=(A==null?void 0:A.companyId)||b.id,ue=(A==null?void 0:A.agencyId)||(j==null?void 0:j.id);if(!T||!Z||!ue){pe("RÃ©servation introuvable");return}if(!F){pe("SÃ©lectionnez un moyen de paiement");return}if(!qe){pe("Ajoutez la rÃ©fÃ©rence du paiement (â‰¥ 4 caractÃ¨res) avant de confirmer.");return}if(!le){te(!0),pe("");try{const ve=A!=null&&A.canal&&A.canal.toLowerCase()!=="en_ligne"?A.canal:"en_ligne",be=hs((A==null?void 0:A.statut)??"en_attente_paiement","preuve_recue",{userId:"client_anonymous",userRole:"client"});await He(me(G,"companies",Z,"agences",ue,"reservations",T),{statut:"preuve_recue",canal:ve,preuveVia:F,preuveMessage:K.trim(),paymentHint:F,paymentTriggeredAt:k?new Date(k):null,auditLog:Jt(be),updatedAt:Oe()}),J($e=>$e&&{...$e,statut:"preuve_recue",canal:ve}),s(`/${a}/reservation/${T}`,{replace:!0,state:{companyId:Z,agencyId:ue}});const Ze=Pn();Ze&&Ze.id===T&&Fr({...Ze,status:"preuve_recue"})}catch{pe("Ã‰chec de l'envoi de la preuve")}finally{te(!1)}}},Nt=Z=>e("section",{className:"bg-white rounded-2xl border border-gray-100 shadow-sm",children:t("div",{className:"flex items-center justify-between gap-4 px-4 sm:px-5 py-3",children:[t("div",{className:"flex items-center gap-3 min-w-0",children:[b.logoUrl&&e("img",{src:b.logoUrl,alt:"",className:"h-8 w-8 rounded-full object-cover ring-1 ring-gray-200"}),t("div",{className:"min-w-0",children:[t("div",{className:"flex items-center text-gray-900 font-semibold",children:[e("span",{className:"truncate",children:A!=null&&A.depart?Va(A.depart):Va(f)}),e("svg",{viewBox:"0 0 24 24",className:"mx-2 h-5 w-5 shrink-0",style:{color:C.primary},children:e("path",{fill:"currentColor",d:"M5 12h12l-4-4 1.4-1.4L21.8 12l-7.4 5.4L13 16l4-4H5z"})}),e("span",{className:"truncate",children:A!=null&&A.arrivee?Va(A.arrivee):Va(x)})]}),e("p",{className:"text-xs text-gray-500",children:A!=null&&A.date?`${A.date} Â· ${A.heure||""}`:"SÃ©lectionnez la date et l'heure"})]})]}),e("div",{className:"text-right",children:Z?e("div",{className:"text-lg sm:text-xl font-extrabold",style:{color:C.primary},children:Z}):t(Ae,{children:[e("div",{className:"text-xs text-gray-500",children:"Ã€ partir de"}),e("div",{className:"text-lg sm:text-xl font-extrabold",style:{color:C.primary},children:((A==null?void 0:A.montant)??Ie)!=null?i((A==null?void 0:A.montant)??Ie):"â€”"})]})})]})}),Gt=()=>e("div",{className:"flex items-center justify-center mb-4",children:t("div",{className:"flex items-center",children:[e("div",{className:`h-8 w-8 rounded-full flex items-center justify-center ${X==="personal"?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"1"}),e("div",{className:`h-1 w-12 ${X==="personal"?"bg-gray-300":"bg-gray-200"}`}),e("div",{className:`h-8 w-8 rounded-full flex items-center justify-center ${X==="payment"?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"2"}),e("div",{className:`h-1 w-12 ${X==="proof"?"bg-gray-300":"bg-gray-200"}`}),e("div",{className:`h-8 w-8 rounded-full flex items-center justify-center ${X==="proof"?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:"3"})]})}),Pt=()=>se?e("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4",children:e(Ve.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},className:"bg-white rounded-t-2xl sm:rounded-2xl max-w-md w-full",children:t("div",{className:"p-6",children:[e("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Ã‰tape suivante : Paiement"}),t("div",{className:"space-y-3 mb-6",children:[t("div",{className:"flex items-start gap-3",children:[e("div",{className:"h-6 w-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold",children:"1"}),t("div",{children:[e("p",{className:"font-medium text-gray-900",children:"Choisissez un moyen de paiement"}),e("p",{className:"text-sm text-gray-600",children:"SÃ©lectionnez Orange Money, Moov Money, etc."})]})]}),t("div",{className:"flex items-start gap-3",children:[e("div",{className:"h-6 w-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold",children:"2"}),t("div",{children:[e("p",{className:"font-medium text-gray-900",children:"Effectuez le paiement"}),e("p",{className:"text-sm text-gray-600",children:"Sortez de l'app pour payer (USSD ou app externe)"})]})]}),t("div",{className:"flex items-start gap-3",children:[e("div",{className:"h-6 w-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold",children:"3"}),t("div",{children:[e("p",{className:"font-medium text-gray-900",children:"Revenez coller la rÃ©fÃ©rence"}),e("p",{className:"text-sm text-gray-600",children:"AprÃ¨s paiement, copiez le code reÃ§u par SMS"})]})]})]}),e("div",{className:"flex gap-3",children:e("button",{onClick:()=>ye(!1),className:"flex-1 h-11 border border-gray-300 rounded-xl font-medium hover:bg-gray-50 transition",children:"Compris"})})]})})}):null;if(ae)return e("div",{className:"min-h-screen grid place-items-center bg-gray-50",children:e(Ve.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"bg-white/70 backdrop-blur rounded-2xl p-6 shadow-sm",children:t("div",{className:"flex items-center gap-3",children:[b.logoUrl&&e("img",{src:b.logoUrl,alt:"",className:"h-10 w-10 rounded-full object-cover ring-1 ring-gray-200"}),t("div",{children:[e("div",{className:"h-4 w-40 bg-gray-200 rounded mb-2"}),e("div",{className:"h-3 w-24 bg-gray-200 rounded"})]})]})})});const Et=e("header",{className:"sticky top-0 z-50 shadow-sm",style:{backgroundColor:C.primary},children:t("div",{className:"max-w-[1100px] mx-auto px-3 sm:px-4 py-2 flex items-center justify-between text-white",children:[e("button",{onClick:()=>s(-1),className:"p-2 rounded-full hover:bg-white/10 transition","aria-label":"Retour",children:e(At,{className:"h-5 w-5"})}),t("div",{className:"flex items-center gap-2",children:[b.logoUrl&&e("img",{src:b.logoUrl,alt:"",className:"h-7 w-7 rounded-full object-cover ring-1 ring-white/30"}),e("span",{className:"font-semibold tracking-wide",children:b.name||"MALI TRANS"})]}),e("div",{className:"w-9"})]})}),Y=String((A==null?void 0:A.canal)||"").toLowerCase();String((A==null?void 0:A.statut)||"").toLowerCase();const oe=!!A&&(A.statut==="preuve_recue"||A.statut==="confirme"||Y==="guichet"),Ce=A&&t("div",{className:"max-w-[1100px] mx-auto px-3 sm:px-4 py-4 space-y-4",children:[Nt("Billet"),t("section",{className:"bg-white rounded-2xl border p-4",children:[t("div",{className:"text-sm text-gray-600 mb-3",children:[e("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200 mr-2",children:Y==="guichet"?"Guichet":"En ligne"}),t("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 border",children:["RÃ©fÃ©rence: ",A.referenceCode||A.id]})]}),t("div",{className:"grid sm:grid-cols-2 gap-3 text-sm",children:[t("div",{children:[e("span",{className:"text-gray-500",children:"Passager"}),e("div",{className:"font-medium",children:A.nomClient||"â€”"})]}),t("div",{children:[e("span",{className:"text-gray-500",children:"TÃ©lÃ©phone"}),e("div",{className:"font-medium",children:A.telephone||"â€”"})]}),t("div",{children:[e("span",{className:"text-gray-500",children:"Trajet"}),t("div",{className:"font-medium",children:[A.depart," â†’ ",A.arrivee]})]}),t("div",{children:[e("span",{className:"text-gray-500",children:"Date & heure"}),t("div",{className:"font-medium",children:[A.date," Â· ",A.heure]})]}),t("div",{children:[e("span",{className:"text-gray-500",children:"Places"}),e("div",{className:"font-medium",children:A.seatsGo||1})]}),t("div",{children:[e("span",{className:"text-gray-500",children:"Montant"}),e("div",{className:"font-medium",children:i(A.montant??0)})]})]})]})]}),Te=t("div",{className:"max-w-[1100px] mx-auto px-3 sm:px-4 py-4 space-y-4",children:[Nt(),(j==null?void 0:j.nom)&&t("div",{className:"text-xs text-gray-500 px-1",children:["Agence : ",j.nom," â€” ",j.telephone]}),(A==null?void 0:A.statut)&&e("div",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:t("div",{className:"flex items-center gap-3",children:[A.statut==="en_attente_paiement"&&t(Ae,{children:[e(xt,{className:"w-5 h-5 text-amber-500"}),t("div",{children:[e("div",{className:"font-medium text-gray-900",children:"En attente de paiement"}),e("div",{className:"text-sm text-gray-600",children:"Veuillez effectuer le paiement et envoyer la preuve"})]})]}),A.statut==="preuve_recue"&&t(Ae,{children:[e(xt,{className:"w-5 h-5 text-blue-500"}),t("div",{children:[e("div",{className:"font-medium text-gray-900",children:"Preuve reÃ§ue â€“ en vÃ©rification"}),e("div",{className:"text-sm text-gray-600",children:"Votre preuve de paiement est en cours de vÃ©rification par la compagnie"})]})]}),A.statut==="confirme"&&t(Ae,{children:[e(nr,{className:"w-5 h-5 text-emerald-500"}),t("div",{children:[e("div",{className:"font-medium text-gray-900",children:"Paiement confirmÃ©"}),e("div",{className:"text-sm text-gray-600",children:"Votre billet est confirmÃ© et valide pour le voyage"})]})]})]})}),re&&e("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-800",children:re}),k&&(A==null?void 0:A.statut)==="en_attente_paiement"&&!F&&e("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800",children:"ðŸ’¡ AprÃ¨s votre paiement, choisissez un moyen de paiement ci-dessous, puis collez le code reÃ§u par SMS."}),e(qr,{reservationId:T,paymentMethods:M,paymentMethodKey:F,onChoosePayment:at,message:K,setMessage:z,referenceInputRef:h,canConfirm:qe,submitProofInline:pt,uploading:le,paymentHints:Ge,existing:A,selectedTrip:ie,seats:U,theme:C}),A&&A.statut&&e("div",{className:"text-sm text-gray-600",children:A.canal&&t("span",{className:"mr-3",children:["Canal : ",e("b",{children:A.canal})]})})]});return t("div",{className:"min-h-screen bg-gradient-to-br from-white to-gray-50",children:[Et,e(Pt,{}),!u&&e("div",{className:"max-w-[1100px] mx-auto px-3 sm:px-4 pt-3",children:e("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800",children:"Connexion instable: certaines actions (chargement, paiement, envoi de preuve) peuvent Ã©chouer."})}),A?oe?Ce:Te:t("main",{className:"max-w-[1100px] mx-auto px-3 sm:px-4 py-4 space-y-4 sm:space-y-5",children:[Nt(),(j==null?void 0:j.nom)&&t("div",{className:"text-xs text-gray-500 px-1",children:["Agence : ",j.nom," â€” ",j.telephone]}),re&&e("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-800",children:re}),Ee&&e("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4",children:t("div",{className:"flex items-start gap-3",children:[e(Ct,{className:"h-5 w-5 text-amber-600 mt-0.5"}),t("div",{className:"flex-1",children:[e("h3",{className:"font-medium text-amber-800 mb-1",children:"Une rÃ©servation est dÃ©jÃ  en cours"}),e("p",{className:"text-sm text-amber-700",children:"Vous avez dÃ©jÃ  une rÃ©servation en attente de paiement. Veuillez terminer le paiement et envoyer la preuve."})]})]})}),t("section",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:[e("h2",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Choisissez votre date de dÃ©part"}),e("div",{className:"flex gap-2 overflow-x-auto scrollbar-none",children:$.map(Z=>t("button",{onClick:()=>{N(Z),v("")},className:"h-10 px-3 rounded-xl border text-sm whitespace-nowrap transition",style:{borderColor:w===Z?C.primary:"#e5e7eb",color:w===Z?"#111827":"#374151",backgroundColor:w===Z?C.lightPrimary:"#f9fafb"},children:[e("span",{className:"font-medium",children:yt(fa(Z),"EEE d",{locale:Yt})}),vr(fa(Z))&&e("span",{className:"ml-2 text-xs text-gray-500",children:"Aujourd'hui"}),Tl(fa(Z))&&e("span",{className:"ml-2 text-xs text-gray-500",children:"Demain"})]},Z))})]}),!!Ne.length&&t("section",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:[e("h2",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Choisissez votre heure de dÃ©part"}),e("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2",children:Ne.map(Z=>e("button",{onClick:()=>v(Z.time),className:"h-11 px-3 rounded-lg border text-sm text-left transition",style:{borderColor:g===Z.time?C.secondary:"#e5e7eb",backgroundColor:g===Z.time?C.lightSecondary:"#f9fafb"},children:t("div",{className:"flex items-center justify-between",children:[e("span",{className:"font-semibold",children:Z.time}),t("span",{className:"text-[11px] px-2 h-5 rounded-md grid place-items-center whitespace-nowrap leading-none",style:{color:Me(Z.remainingSeats,Z.places),border:`1px solid ${Me(Z.remainingSeats,Z.places)}`},children:[Z.remainingSeats," pl."]})]})},Z.id))})]}),ie&&!Ee&&e(Ae,{children:t("section",{className:"bg-white rounded-2xl border border-gray-100 p-4",children:[e(Gt,{}),e("h2",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Informations personnelles"}),t("p",{className:"text-xs text-gray-500 mb-3",children:["Entrez votre ",e("span",{className:"font-medium",children:"nom complet"})," et votre ",e("span",{className:"font-medium",children:"numÃ©ro de tÃ©lÃ©phone"})," utilisÃ©s pour voyager."]}),t("div",{className:"grid sm:grid-cols-2 gap-3",children:[t("div",{className:"relative",children:[e("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e(xn,{className:"h-5 w-5 text-gray-400"})}),e("input",{ref:c,className:`h-11 pl-10 pr-3 w-full border rounded-lg focus:ring-2 focus:outline-none ${he.fullName?"border-red-300":"border-gray-200"}`,placeholder:"Nom complet *",value:B.fullName,onChange:Z=>{V(ue=>({...ue,fullName:Z.target.value})),he.fullName&&y(ue=>({...ue,fullName:""}))}}),he.fullName&&t("div",{className:"text-xs text-red-600 mt-1 flex items-center gap-1",children:[e(Ct,{className:"w-3 h-3"})," ",he.fullName]})]}),t("div",{className:"relative",children:[e("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e(Wt,{className:"h-5 w-5 text-gray-400"})}),e("input",{ref:m,inputMode:"numeric",autoComplete:"tel",maxLength:11,className:`h-11 pl-10 pr-3 w-full border rounded-lg focus:ring-2 focus:outline-none ${he.phone?"border-red-300":"border-gray-200"}`,placeholder:"TÃ©lÃ©phone * (ex: 22 22 22 22)",value:B.phone,onChange:Z=>{const ue=sc(Z.target.value);V(ve=>({...ve,phone:ue})),he.phone&&y(ve=>({...ve,phone:""}))}}),he.phone&&t("div",{className:"text-xs text-red-600 mt-1 flex items-center gap-1",children:[e(Ct,{className:"w-3 h-3"})," ",he.phone]})]}),t("div",{className:"sm:col-span-2 flex items-center gap-4 mt-2",children:[e("span",{className:"text-sm text-gray-600",children:"Places"}),e("button",{onClick:()=>E(Z=>Math.max(1,Z-1)),className:"w-9 h-9 rounded-full border grid place-items-center hover:bg-gray-50",style:{borderColor:C.lightPrimary,color:C.primary},children:e(ws,{className:"w-4 h-4"})}),e("span",{className:"px-3 py-1.5 rounded-lg text-sm font-semibold",style:{background:C.lightPrimary,color:C.primary},children:U}),e("button",{onClick:()=>E(Z=>Math.min(Math.min(5,ie.remainingSeats),Z+1)),className:"w-9 h-9 rounded-full border grid place-items-center hover:bg-gray-50",style:{borderColor:C.lightPrimary,color:C.primary},children:e(vn,{className:"w-4 h-4"})}),t("span",{className:"text-xs",style:{color:Me(ie.remainingSeats,ie.places)},children:[ie.remainingSeats," pl. dispo"]})]})]}),!T&&e("button",{onClick:Ue,disabled:q||Ee,title:Ee?"Une rÃ©servation est dÃ©jÃ  en cours":"",className:"mt-4 w-full h-11 rounded-xl font-semibold shadow-sm disabled:opacity-60 transition hover:brightness-[0.98] flex items-center justify-center gap-2",style:{background:`linear-gradient(135deg, ${C.secondary}, ${C.primary})`,color:"#fff"},children:q?"Traitementâ€¦":t(Ae,{children:["Passer au paiement",e(Nn,{className:"w-4 h-4"}),e("span",{className:"font-bold",children:i(ie.price*U)})]})}),T&&!A&&e(Ve.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-4 p-3 bg-emerald-50 border border-emerald-200 rounded-lg",children:t("div",{className:"flex items-center gap-2 text-emerald-800",children:[e(rt,{className:"w-4 h-4"}),t("div",{children:[e("p",{className:"text-sm font-medium",children:"RÃ©servation crÃ©Ã©e avec succÃ¨s !"}),e("p",{className:"text-xs text-emerald-700 mt-0.5",children:"Choisissez maintenant un moyen de paiement ci-dessous pour continuer."})]})]})})]})}),T&&e("section",{ref:o,className:"bg-white rounded-2xl border border-gray-100 p-4",children:e(qr,{reservationId:T,paymentMethods:M,paymentMethodKey:F,onChoosePayment:at,message:K,setMessage:z,referenceInputRef:h,canConfirm:qe,submitProofInline:pt,uploading:le,paymentHints:Ge,existing:A,selectedTrip:ie,seats:U,theme:C})})]})]})}const oc=Object.freeze(Object.defineProperty({__proto__:null,default:ic},Symbol.toStringTag,{value:"Module"}));Ut.locale("fr");const Dn=a=>a?typeof a=="string"?Ut(a):typeof a=="object"&&"seconds"in a?Ut(a.seconds*1e3):null:null,cc=a=>(a||"").replace(/[^\d+]/g,"").replace(/^00/,"+").trim(),dc=({s:a})=>{const n=(a||"").toLowerCase(),r=n.includes("pay")||n.includes("confirm")?"bg-emerald-100 text-emerald-700 border border-emerald-200":n.includes("attent")?"bg-amber-100 text-amber-700 border border-amber-200":n.includes("annul")||n.includes("refus")?"bg-rose-100 text-rose-700 border border-rose-200":"bg-slate-100 text-slate-700 border border-slate-200",s=n.includes("pay")?"PayÃ©":n.includes("confirm")?"ConfirmÃ©e":n.includes("attent")?"En attente":n.includes("annul")?"AnnulÃ©e":n.includes("refus")?"RefusÃ©e":a||"â€”";return e("span",{className:`inline-flex items-center text-xs px-2 py-0.5 rounded-full ${r}`,children:s})},Ur=5,mc=5,uc=()=>{const{slug:a}=De(),n=Be(),r=Qe(),[s,i]=l.useState({primary:"#ea580c",secondary:"#f97316"}),[u,o]=l.useState(""),[c,m]=l.useState(!1),[h,d]=l.useState([]),[p,f]=l.useState(""),[x,b]=l.useState(Ur),[P,C]=l.useState(!1),j=Tt(),L=l.useMemo(()=>a?"Mes rÃ©servations":"Retrouver mes rÃ©servations",[a]);l.useEffect(()=>{(async()=>{if(a)try{const k=await ee(ce(Q(G,"companies"),ne("slug","==",a)));if(!k.empty){const S=k.docs[0].data();i(O=>({...O,primary:(S==null?void 0:S.couleurPrimaire)||O.primary,secondary:(S==null?void 0:S.couleurSecondaire)||O.secondary}))}}catch{}})()},[a]);const M=async(k,S)=>{const O=await ee(Q(G,"companies",k,"agences")),I=[];for(const $ of O.docs){const R=ce(Q(G,"companies",k,"agences",$.id,"reservations"),ne("telephone","==",u));(await ee(R)).forEach(N=>{const g=N.data();I.push({id:N.id,companyId:k,agencyId:$.id,companySlug:(S==null?void 0:S.slug)||void 0,couleurPrimaire:S==null?void 0:S.couleurPrimaire,couleurSecondaire:S==null?void 0:S.couleurSecondaire,nomClient:g.nomClient||g.clientNom,telephone:g.telephone,depart:g.depart||g.departure,arrivee:g.arrivee||g.arrival,arrival:g.arrival,date:g.date,heure:g.heure,nombre_places:g.nombre_places??g.seatsGo??g.seats??void 0,seatsGo:g.seatsGo,montant_total:g.montant_total??g.montant??void 0,statut:g.statut,lieu_depart:g.lieu_depart,canal:g.canal||void 0})})}return I},_=async()=>{if(!cc(u)){f("Entrez le numÃ©ro utilisÃ© lors de vos rÃ©servations (format local ou international).");return}f(""),m(!0),C(!0),d([]),b(Ur);try{let S=[];if(a){const O=await ee(ce(Q(G,"companies"),ne("slug","==",a)));if(O.empty)f("Compagnie introuvable.");else{const I=O.docs[0],$=I.data();i(R=>({...R,primary:($==null?void 0:$.couleurPrimaire)||R.primary,secondary:($==null?void 0:$.couleurSecondaire)||R.secondary})),S=S.concat(await M(I.id,$))}}else{const O=await ee(Q(G,"companies"));for(const I of O.docs)S=S.concat(await M(I.id,I.data()))}S.sort((O,I)=>{var w,N;const $=(((w=Dn(O.date))==null?void 0:w.valueOf())||0)+(O.heure?Ut(`1970-01-01T${O.heure}`).valueOf()%864e5:0);return(((N=Dn(I.date))==null?void 0:N.valueOf())||0)+(I.heure?Ut(`1970-01-01T${I.heure}`).valueOf()%864e5:0)-$}),S.length||f("Aucune rÃ©servation trouvÃ©e pour ce numÃ©ro."),d(S)}catch(S){console.error(S),f(j?"Erreur lors de la recherche. RÃ©essayez.":"Connexion indisponible. Impossible de rechercher vos rÃ©servations.")}finally{m(!1)}},F=h.slice(0,x),D=x<h.length;return t("div",{className:"min-h-screen bg-gray-50",children:[e("header",{className:"sticky top-0 z-20 border-b",style:{backgroundColor:s.primary},children:t("div",{className:"max-w-3xl mx-auto px-3 py-2 flex items-center gap-2 text-white",children:[e("button",{onClick:()=>n(a?`/${a}`:"/"),className:"p-2 rounded hover:bg-white/10",children:e(At,{className:"w-5 h-5"})}),e("h1",{className:"font-semibold",children:L})]})}),t("main",{className:"max-w-3xl mx-auto p-4 space-y-4",children:[t("section",{className:"bg-white border rounded-xl p-4",children:[e("label",{className:"text-sm font-medium text-gray-800",children:"NumÃ©ro de tÃ©lÃ©phone"}),t("p",{className:"mt-1 text-xs text-gray-500",children:["Saisissez le numÃ©ro utilisÃ© lors de vos rÃ©servations format local, puis appuyez sur"," ",e("span",{className:"font-medium",children:"Rechercher"}),"."]}),t("div",{className:"mt-3 flex gap-2",children:[t("div",{className:"relative flex-1",children:[e(Wt,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e("input",{type:"tel",value:u,onChange:k=>o(k.target.value),placeholder:"70 00 00 00",className:"w-full h-11 pl-9 pr-3 border rounded-lg focus:ring-2 focus:ring-orange-200 outline-none",onKeyDown:k=>k.key==="Enter"&&_()})]}),t("button",{onClick:_,disabled:c,className:"h-11 px-4 rounded-lg text-white shadow-sm disabled:opacity-60 inline-flex items-center gap-2",style:{background:`linear-gradient(135deg, ${s.secondary}, ${s.primary})`},children:[e(fn,{className:"w-4 h-4"}),"Rechercher"]})]}),p&&e("p",{className:"mt-2 text-sm text-red-600",children:p})]}),t("section",{className:"bg-white border rounded-xl overflow-hidden",children:[t("div",{className:"p-3 border-b flex items-center gap-2 text-gray-800",children:[e(ft,{className:"w-4 h-4",style:{color:s.primary}}),e("span",{className:"text-sm font-medium",children:"RÃ©sultats"}),t("span",{className:"ml-auto text-xs text-gray-500",children:[h.length," Ã©lÃ©ment(s)"]})]}),c?e(gn,{blocks:3}):P?F.length===0?t("div",{className:"p-6 text-sm text-gray-500",children:[j?"Aucun rÃ©sultat.":"Hors ligne: impossible de charger les rÃ©servations.",e("div",{className:"mt-3",children:e("button",{onClick:_,className:"text-sm px-3 py-1.5 rounded-lg border hover:bg-gray-50",style:{borderColor:`${s.primary}40`},children:"RÃ©essayer"})})]}):t(Ae,{children:[e("ul",{className:"",children:F.map(k=>{var N;const S=((N=Dn(k.date))==null?void 0:N.format("dddd D MMMM YYYY"))||"â€”",O=k.heure||"",I=k.depart||"â€”",$=k.arrivee||k.arrival||"â€”",R=k.nombre_places??k.seatsGo??void 0,w=k.montant_total??k.montant??void 0;return e("li",{className:"relative",children:t("div",{className:"m-3 rounded-2xl border bg-white shadow-sm hover:shadow-md transition-all overflow-hidden",style:{borderColor:`${s.primary}30`},children:[e("span",{className:"absolute left-0 top-0 bottom-0 w-1.5 rounded-l-2xl",style:{backgroundColor:s.primary}}),e("div",{className:"p-4 pl-5",children:t("div",{className:"flex items-start justify-between gap-3",children:[t("div",{className:"min-w-0",children:[t("div",{className:"text-sm font-semibold text-gray-900 truncate",children:[I," ",e("span",{className:"text-gray-400",children:"â†’"})," ",$]}),t("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[t("span",{className:"inline-flex items-center gap-1 text-xs px-2 py-1 rounded-md border",style:{backgroundColor:`${s.secondary}15`,borderColor:`${s.secondary}30`,color:"#374151"},children:[e(dt,{className:"w-3.5 h-3.5"}),S," ",O&&`Â· ${O}`]}),k.lieu_depart&&t("span",{className:"inline-flex items-center gap-1 text-xs px-2 py-1 rounded-md border text-gray-700 bg-gray-50",children:[e(Kt,{className:"w-3.5 h-3.5 text-gray-500"}),"DÃ©part : ",k.lieu_depart]}),typeof R=="number"&&t("span",{className:"inline-flex items-center gap-1 text-xs px-2 py-1 rounded-md border text-gray-700 bg-gray-50",children:[e(Oa,{className:"w-3.5 h-3.5 text-gray-500"}),R," place(s)"]}),typeof w=="number"&&t("span",{className:"inline-flex items-center gap-1 text-xs px-2 py-1 rounded-md border",style:{backgroundColor:`${s.primary}12`,borderColor:`${s.primary}30`,color:"#374151"},children:[e(wt,{className:"w-3.5 h-3.5"}),r(w)]})]}),t("div",{className:"mt-3 flex items-center gap-2",children:[e(dc,{s:k.statut}),k.canal&&e("span",{className:"text-xs px-2 py-0.5 rounded-full bg-gray-100 border text-gray-700",children:k.canal==="guichet"?"Guichet":"En ligne"})]})]}),e("div",{className:"shrink-0",children:e("button",{onClick:()=>n(`/${k.companySlug||a||""}/reservation/${k.id}`,{state:{companyId:k.companyId,agencyId:k.agencyId}}),className:"text-sm px-3 py-1.5 rounded-lg border shadow-sm hover:bg-gray-50",style:{borderColor:`${s.primary}40`},children:"Voir billet"})})]})})]})},`${k.companyId}_${k.agencyId}_${k.id}`)})}),D&&e("div",{className:"p-4 border-t flex justify-center",children:e("button",{onClick:()=>b(k=>Math.min(k+mc,h.length)),className:"text-sm px-4 py-2 rounded-lg border hover:bg-gray-50",style:{borderColor:`${s.primary}40`},children:"Voir plus"})})]}):e("div",{className:"p-6 text-sm text-gray-500",children:"Lancez une recherche pour afficher vos rÃ©servations."})]})]})]})},pc=Object.freeze(Object.defineProperty({__proto__:null,default:uc},Symbol.toStringTag,{value:"Module"}));Ut.locale("fr");const ma=[{code:"ML",name:"Mali",dialCode:"+223"},{code:"SN",name:"SÃ©nÃ©gal",dialCode:"+221"},{code:"CI",name:"CÃ´te d'Ivoire",dialCode:"+225"},{code:"BF",name:"Burkina Faso",dialCode:"+226"},{code:"GN",name:"GuinÃ©e",dialCode:"+224"},{code:"NE",name:"Niger",dialCode:"+227"},{code:"TG",name:"Togo",dialCode:"+228"},{code:"BJ",name:"BÃ©nin",dialCode:"+229"},{code:"GH",name:"Ghana",dialCode:"+233"}],gc="ML",Br="mesBillets_lastPhone",Gr="mesBillets_lastCountry",zr=a=>a?typeof a=="string"?Ut(a):typeof a=="object"&&"seconds"in a?Ut(a.seconds*1e3):null:null;function hc(a){const n=a.replace(/\D/g,"").slice(0,10),r=[];for(let s=0;s<n.length;s+=2)r.push(n.slice(s,s+2));return r.join(" ")}function fc(a,n){const r=n.replace(/\D/g,"");return`+${a.replace(/\D/g,"")}${r}`}const yc={a_venir:"Ã€ venir",voyages_effectues:"Voyages effectuÃ©s",en_verification:"En vÃ©rification",annules:"AnnulÃ©s / RemboursÃ©s"},bc=()=>{const{slug:a}=De(),n=Be(),r=Qe(),[s,i]=l.useState({primary:"#ea580c",secondary:"#f97316"}),[u,o]=l.useState(null),[c,m]=l.useState(gc),[h,d]=l.useState(""),[p,f]=l.useState(!1),[x,b]=l.useState([]),[P,C]=l.useState(""),[j,L]=l.useState(!1),[M,_]=l.useState(!1),F=Tt(),D=l.useMemo(()=>a?"Mon portefeuille":"Retrouver mes billets",[a]),k=l.useMemo(()=>ma.find(N=>N.code===c)??ma[0],[c]);l.useEffect(()=>{(async()=>{if(a)try{const N=await ee(ce(Q(G,"companies"),ne("slug","==",a)));if(!N.empty){const g=N.docs[0].data();i(U=>({...U,primary:(g==null?void 0:g.couleurPrimaire)||U.primary,secondary:(g==null?void 0:g.couleurSecondaire)||U.secondary}));const v=((g==null?void 0:g.countryCode)||(g==null?void 0:g.pays)||"").toString().toUpperCase();if(v){const U=ma.find(E=>E.code===v||E.name.toUpperCase().startsWith(v));o(U?U.code:null),U&&m(U.code)}}}catch{}})()},[a]),l.useEffect(()=>{u&&ma.some(N=>N.code===u)&&m(u)},[u]),l.useEffect(()=>{try{const N=localStorage.getItem(Br),g=localStorage.getItem(Gr);N&&d(N),!a&&g&&ma.some(v=>v.code===g)&&m(g)}catch{}},[a]);const S=(N,g,v,U)=>{const E=N.data();return{id:N.id,companyId:g,agencyId:v,companySlug:(U==null?void 0:U.slug)||void 0,couleurPrimaire:U==null?void 0:U.couleurPrimaire,couleurSecondaire:U==null?void 0:U.couleurSecondaire,nomClient:E.nomClient||E.clientNom,telephone:E.telephone,depart:E.depart||E.departure,arrivee:E.arrivee||E.arrival,arrival:E.arrival,date:E.date,heure:E.heure,nombre_places:E.nombre_places??E.seatsGo??E.seats??void 0,seatsGo:E.seatsGo,montant_total:E.montant_total??E.montant??void 0,montant:E.montant,statut:E.statut,lieu_depart:E.lieu_depart,canal:E.canal||void 0}},O=async(N,g)=>{const v=await ee(Q(G,"companies",N,"agences")),U=fc(k.dialCode,h),E=h.replace(/\D/g,""),B=new Set,V=[];for(const K of v.docs){const z=Q(G,"companies",N,"agences",K.id,"reservations"),[T,W]=await Promise.all([ee(ce(z,ne("telephone","==",U))),E.length>=8?ee(ce(z,ne("telephone","==",E))):Promise.resolve({docs:[]})]),q=H=>{const le=`${N}_${K.id}_${H.id}`;B.has(le)||(B.add(le),V.push(S(H,N,K.id,g)))};T.docs.forEach(H=>q(H)),W.docs.forEach(H=>q(H))}return V},I=async()=>{if(h.replace(/\D/g,"").length<8){C("Entrez un numÃ©ro valide (au moins 8 chiffres).");return}C(""),f(!0),L(!0),b([]);try{let g=[];if(a){const v=await ee(ce(Q(G,"companies"),ne("slug","==",a)));if(v.empty)C("Compagnie introuvable.");else{const U=v.docs[0],E=U.data();i(B=>({...B,primary:(E==null?void 0:E.couleurPrimaire)||B.primary,secondary:(E==null?void 0:E.couleurSecondaire)||B.secondary})),g=g.concat(await O(U.id,E))}}else{const v=await ee(Q(G,"companies"));for(const U of v.docs)g=g.concat(await O(U.id,U.data()))}g=g.filter(v=>fi(v.statut)),g.length||C("Aucun billet trouvÃ© pour ce numÃ©ro."),b(g);try{localStorage.setItem(Br,h),localStorage.setItem(Gr,c)}catch{}}catch(g){console.error(g),C(F?"Erreur lors de la recherche. RÃ©essayez.":"Connexion indisponible. Impossible de rechercher vos billets.")}finally{f(!1)}},$=l.useMemo(()=>{const N=[],g=[],v=[],U=[],E=B=>{var V;return(((V=zr(B.date))==null?void 0:V.valueOf())||0)+(B.heure?Ut(`1970-01-01T${B.heure}`).valueOf()%864e5:0)};return x.forEach(B=>{const V=ln(B),K=Ir(V);K&&(K.section==="a_venir"?N.push(B):K.section==="voyages_effectues"?g.push(B):K.section==="en_verification"?v.push(B):U.push(B))}),N.sort((B,V)=>E(B)-E(V)),g.sort((B,V)=>E(V)-E(B)),v.sort((B,V)=>E(B)-E(V)),U.sort((B,V)=>E(V)-E(B)),[{id:"a_venir",items:N},{id:"voyages_effectues",items:g},{id:"en_verification",items:v},{id:"annules",items:U}]},[x]),R=N=>{const g=N.companySlug||a||"";n(`/${g}/receipt/${N.id}`,{state:{companyId:N.companyId,agencyId:N.agencyId}})},w=N=>{const g=N.target.value.replace(/\D/g,"").slice(0,10);d(g)};return t("div",{className:"min-h-screen bg-gray-50",children:[e("header",{className:"sticky top-0 z-20 border-b border-white/10",style:{backgroundColor:s.primary},children:t("div",{className:"max-w-3xl mx-auto px-3 py-2.5 flex items-center gap-2 text-white",children:[e("button",{onClick:()=>n(a?`/${a}`:"/"),className:"p-2 rounded-lg hover:bg-white/10 transition-colors","aria-label":"Retour",children:e(At,{className:"w-5 h-5"})}),e("h1",{className:"font-semibold text-base",children:D})]})}),t("main",{className:"max-w-3xl mx-auto p-4 space-y-5",children:[t("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",style:{borderColor:`${s.primary}15`},children:[e("label",{className:"block text-sm font-medium text-gray-800",children:"NumÃ©ro de tÃ©lÃ©phone"}),e("p",{className:"mt-1 text-xs text-gray-500",children:"Saisissez le numÃ©ro utilisÃ© pour vos billets (format international)."}),t("div",{className:"mt-3 flex gap-2",children:[e("div",{className:"flex flex-1 rounded-xl border bg-gray-50/80 overflow-hidden",children:t("div",{className:"flex items-center",children:[t("div",{className:"relative",children:[t("button",{type:"button",onClick:()=>_(N=>!N),className:"flex items-center gap-1.5 pl-3 pr-2 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-100 transition-colors",children:[e(Wt,{className:"w-4 h-4 text-gray-500"}),e("span",{className:"tabular-nums",children:k.dialCode}),e(ya,{className:"w-4 h-4 text-gray-400"})]}),M&&t(Ae,{children:[e("div",{className:"fixed inset-0 z-10","aria-hidden":!0,onClick:()=>_(!1)}),e("div",{className:"absolute left-0 top-full mt-1 z-20 w-56 max-h-64 overflow-auto rounded-xl border bg-white shadow-lg py-1",style:{borderColor:`${s.primary}25`},children:ma.map(N=>t("button",{type:"button",onClick:()=>{m(N.code),_(!1)},className:"w-full flex items-center gap-2 px-3 py-2 text-left text-sm hover:bg-gray-50",style:{backgroundColor:N.code===c?`${s.primary}10`:void 0},children:[e("span",{className:"tabular-nums text-gray-600 w-12",children:N.dialCode}),e("span",{className:"text-gray-900",children:N.name})]},N.code))})]})]}),e("div",{className:"w-px h-8",style:{backgroundColor:`${s.primary}20`}}),e("input",{type:"tel",inputMode:"numeric",placeholder:"78 95 00 00",value:hc(h),onChange:w,onKeyDown:N=>N.key==="Enter"&&I(),className:"flex-1 min-w-0 py-2.5 px-3 bg-transparent text-gray-900 placeholder-gray-400 text-sm outline-none"})]})}),t("button",{type:"button",onClick:I,disabled:p,className:"shrink-0 h-11 px-4 rounded-xl font-medium text-white shadow-sm disabled:opacity-60 inline-flex items-center gap-2 transition-opacity",style:{backgroundColor:s.primary},children:[e(fn,{className:"w-4 h-4"}),"Rechercher"]})]}),P&&e("p",{className:"mt-2 text-sm text-red-600",role:"alert",children:P})]}),t("section",{className:"rounded-2xl border bg-white overflow-hidden shadow-sm",style:{borderColor:`${s.primary}15`},children:[t("div",{className:"px-4 py-3 border-b flex items-center justify-between",children:[t("div",{className:"flex items-center gap-2",children:[e(ia,{className:"w-4 h-4",style:{color:s.primary}}),e("span",{className:"text-sm font-medium text-gray-800",children:"Mon portefeuille"})]}),x.length>0&&t("span",{className:"text-xs text-gray-500",children:[x.length," billet",x.length!==1?"s":""]})]}),p?e(gn,{blocks:3}):j?$.every(N=>N.items.length===0)?t("div",{className:"p-8 text-sm text-gray-500 text-center",children:[F?"Aucun billet pour ce numÃ©ro.":"Hors ligne: impossible de charger les billets pour le moment.",e("div",{className:"mt-3",children:e("button",{type:"button",onClick:I,className:"text-xs px-3 py-1.5 rounded-lg border hover:bg-gray-50",style:{borderColor:`${s.primary}40`},children:"RÃ©essayer"})})]}):e("div",{className:"p-3 space-y-6",children:$.map(N=>N.items.length>0&&t("div",{children:[e("h2",{className:"text-xs font-semibold uppercase tracking-wide text-gray-500 mb-2 px-0.5",children:yc[N.id]}),e("ul",{className:"space-y-2",children:N.items.map(g=>{const v=(g.depart??"").trim()||"â€”",U=(g.arrivee??g.arrival??"").trim()||"â€”",E=zr(g.date),B=E?E.format("ddd D MMM")+(g.heure?` â€¢ ${g.heure}`:""):"â€”",V=g.nombre_places??g.seatsGo??void 0,K=g.montant_total??g.montant??void 0,z=Ir(ln(g));return e("li",{className:"list-none",children:t("div",{className:"rounded-2xl border bg-white p-3 shadow-sm transition-shadow active:shadow-md min-h-0",style:{borderColor:`${s.primary}18`,borderRadius:"16px"},children:[t("div",{className:"flex items-center justify-between gap-2",children:[t("p",{className:"min-w-0 flex-1 text-sm font-semibold text-gray-900 truncate",children:[e("span",{children:v}),e(Nn,{className:"inline-block h-3.5 w-3.5 mx-1 shrink-0 align-middle",style:{color:s.primary},"aria-hidden":!0}),e("span",{children:U})]}),typeof K=="number"&&e("span",{className:"shrink-0 text-sm font-bold tabular-nums",style:{color:s.primary},children:r(K)})]}),e("p",{className:"mt-1 text-xs text-gray-500",children:B}),typeof V=="number"&&t("p",{className:"mt-0.5 text-xs text-gray-500",children:[V," place",V>1?"s":""]}),t("div",{className:"mt-2.5 flex flex-wrap items-center justify-between gap-2",children:[t("div",{className:"flex flex-wrap items-center gap-1.5",children:[z&&e("span",{className:"rounded-full px-2 py-0.5 text-xs font-medium border",style:N.id==="annules"?{backgroundColor:"rgb(254 226 226)",borderColor:"rgb(252 165 165)",color:"rgb(153 27 27)"}:N.id==="en_verification"?{backgroundColor:"rgb(254 243 199)",borderColor:"rgb(253 224 71)",color:"rgb(113 63 18)"}:{backgroundColor:"rgb(209 250 229)",borderColor:"rgb(134 239 172)",color:"rgb(4 120 87)"},children:z.label}),g.canal&&e("span",{className:"rounded-full border px-2 py-0.5 text-xs font-medium",style:{backgroundColor:`${s.primary}10`,borderColor:`${s.primary}25`,color:s.primary},children:g.canal==="guichet"?"Guichet":"En ligne"})]}),t("button",{type:"button",onClick:()=>R(g),className:"shrink-0 inline-flex items-center gap-0.5 rounded-lg py-1 px-2 text-xs font-medium transition-opacity active:opacity-90",style:{color:s.primary,backgroundColor:`${s.primary}12`},children:["Voir",e(_a,{className:"h-3.5 w-3.5"})]})]})]})},`${g.companyId}_${g.agencyId}_${g.id}`)})})]},N.id))}):e("div",{className:"p-8 text-sm text-gray-500 text-center",children:"Lancez une recherche pour afficher vos billets."})]})]})]})},xc=Object.freeze(Object.defineProperty({__proto__:null,default:bc},Symbol.toStringTag,{value:"Module"})),Mt=l.forwardRef(({className:a,...n},r)=>e("div",{ref:r,className:ja("rounded-xl border border-gray-200 bg-white text-gray-900 shadow-sm",a),...n}));Mt.displayName="Card";const $t=l.forwardRef(({className:a,...n},r)=>e("div",{ref:r,className:ja("flex flex-col space-y-1.5 p-6",a),...n}));$t.displayName="CardHeader";const Lt=l.forwardRef(({className:a,...n},r)=>e("h3",{ref:r,className:ja("text-lg font-semibold leading-none tracking-tight",a),...n}));Lt.displayName="CardTitle";const jt=l.forwardRef(({className:a,...n},r)=>e("div",{ref:r,className:ja("p-6 pt-0",a),...n}));jt.displayName="CardContent";const vc=l.forwardRef(({className:a,...n},r)=>e("div",{ref:r,className:ja("flex items-center p-6 pt-0",a),...n}));vc.displayName="CardFooter";const sp={trial:"Essai",active:"Actif",grace:"Grace",restricted:"Restreint",suspended:"Suspendu"},lp={trial:"bg-amber-100 text-amber-700",active:"bg-green-100 text-green-700",grace:"bg-orange-100 text-orange-700",restricted:"bg-red-100 text-red-700",suspended:"bg-gray-100 text-gray-700"},Nc=({subscriptionStatus:a,trialEndsAt:n,companyName:r})=>{const s=a??"active",i=l.useMemo(()=>{if(s!=="trial"||!n)return null;const u=new Date,o=n.getTime()-u.getTime();return o<=0?0:Math.ceil(o/(1e3*60*60*24))},[s,n]);return s==="active"?null:s==="trial"?e("div",{className:"bg-blue-50 border-b border-blue-200 px-4 md:px-6 py-2.5",children:t("div",{className:"flex items-center gap-2 max-w-7xl mx-auto",children:[e(sa,{className:"h-4 w-4 text-blue-600 shrink-0"}),t("p",{className:"text-sm text-blue-800",children:[e("strong",{children:"PÃ©riode d'essai"}),i!==null&&t(Ae,{children:[" â€” ",i<=0?"expirÃ©e":t(Ae,{children:["il reste ",t("strong",{children:[i," jour",i>1?"s":""]})]})]}),". Effectuez un paiement pour maintenir l'accÃ¨s complet."]})]})}):s==="grace"?e("div",{className:"bg-amber-50 border-b border-amber-200 px-4 md:px-6 py-2.5",children:t("div",{className:"flex items-center gap-2 max-w-7xl mx-auto",children:[e(xt,{className:"h-4 w-4 text-amber-600 shrink-0"}),t("p",{className:"text-sm text-amber-800",children:[e("strong",{children:"Abonnement expirÃ© â€” PÃ©riode de grÃ¢ce."})," ","Veuillez rÃ©gulariser votre paiement pour Ã©viter la restriction de votre compte."]})]})}):s==="restricted"?e("div",{className:"bg-red-50 border-b border-red-200 px-4 md:px-6 py-2.5",children:t("div",{className:"flex items-center gap-2 max-w-7xl mx-auto",children:[e(Cs,{className:"h-4 w-4 text-red-600 shrink-0"}),t("p",{className:"text-sm text-red-800",children:[e("strong",{children:"Compte restreint."})," ","La crÃ©ation de rÃ©servations et d'agences est dÃ©sactivÃ©e. Le tableau de bord reste accessible. Contactez Teliya pour rÃ©gulariser votre abonnement."]})]})}):s==="suspended"?e("div",{className:"bg-red-100 border-b border-red-300 px-4 md:px-6 py-3",children:t("div",{className:"flex items-center gap-2 max-w-7xl mx-auto",children:[e(_i,{className:"h-4 w-4 text-red-700 shrink-0"}),t("p",{className:"text-sm text-red-900 font-medium",children:[e("strong",{children:"Compte suspendu."})," ","L'accÃ¨s est limitÃ©. Seul le paiement est disponible. Contactez le support Teliya."]})]})}):null},wc=()=>{var R,w;const a=De(),{user:n,logout:r,company:s,loading:i}=Pe(),u=Yn(),[o,c]=mn(),m=a.companyId,h=n==null?void 0:n.companyId,d=m||h,p=!!((n==null?void 0:n.role)==="admin_platforme"&&m),[f,x]=Je.useState(s);Je.useEffect(()=>{if(!m||m===h){x(s);return}(async()=>{try{const g=await Se(me(G,"companies",m));if(g.exists()){const v=g.data();x({id:g.id,nom:v.nom||"",slug:v.slug||"",logoUrl:v.logoUrl,...v})}}catch(g){console.error("Error loading company:",g)}})()},[m,h,s]);const b=lt(f),[P,C]=Je.useState(0),[j,L]=Je.useState(0);Je.useEffect(()=>{if(!d)return;let N=[];const g=new Map;return(async()=>(await ee(Q(G,"companies",d,"agences"))).docs.forEach(U=>{const E=U.id,B=ce(Q(G,"companies",d,"agences",E,"reservations"),ne("statut","==","preuve_recue")),V=st(B,K=>{g.set(E,K.size),C(Array.from(g.values()).reduce((z,T)=>z+T,0))});N.push(V)}))(),()=>N.forEach(v=>v())},[d]),Je.useEffect(()=>{if(!d)return;const N=ce(Q(G,"companies",d,"avis"),ne("visible","==",!1)),g=st(N,v=>L(v.size));return()=>g()},[d]);const M=m?`/compagnie/${m}`:"/compagnie",_=[{label:"Poste de Pilotage",icon:Ti,path:`${M}/command-center`},{label:"Revenus & LiquiditÃ©s",icon:Fa,path:`${M}/revenus-liquidites`},{label:"Performance RÃ©seau",icon:Rt,path:`${M}/dashboard`},{label:"OpÃ©rations",icon:Pi,path:`${M}/operations-reseau`,badge:P},{label:"Flotte",icon:xa,path:`${M}/fleet`},{label:"ContrÃ´le & Audit",icon:Di,path:`${M}/comptabilite`},{label:"Avis Clients",icon:Mi,path:`${M}/avis-clients`,badge:j},{label:"Configuration",icon:bn,path:`${M}/parametres`}];if(Kn(_),i)return e("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:t("div",{className:"text-center",children:[e("div",{className:"w-12 h-12 border-4 border-t-transparent rounded-full animate-spin mx-auto mb-4",style:{borderColor:`${b.colors.primary} transparent transparent transparent`}}),e("p",{className:"text-sm text-gray-500",children:"Chargement..."})]})});const F=f==null?void 0:f.subscriptionStatus,D=f==null?void 0:f.trialEndsAt,k=D instanceof fe?D.toDate():D instanceof Date?D:null,S=t(Ae,{children:[p&&e("div",{className:"bg-yellow-50 border-b border-yellow-200 px-6 py-2",children:t("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[t("span",{className:"text-sm text-yellow-800",children:["Mode inspection : ",e("strong",{children:f==null?void 0:f.nom})]}),e("button",{onClick:()=>window.location.href="/admin/compagnies",className:"text-sm bg-yellow-600 text-white px-3 py-1 rounded-lg hover:bg-yellow-700 transition",children:"Retour admin"})]})}),e(Nc,{subscriptionStatus:F,trialEndsAt:k,companyName:f==null?void 0:f.nom})]}),O=(((R=b==null?void 0:b.colors)==null?void 0:R.primary)??"#FF6600").trim(),I=(((w=b==null?void 0:b.colors)==null?void 0:w.secondary)??"#FFFFFF").trim(),$=Je.useMemo(()=>o?{"--teliya-primary":Rr(O),"--teliya-secondary":Rr(I)}:{"--teliya-primary":O,"--teliya-secondary":I},[o,O,I]);return e(La,{currency:f==null?void 0:f.devise,children:e(js,{children:e("div",{className:o?"agency-dark":"",style:$,children:e(un,{sections:_,role:(n==null?void 0:n.role)||"admin_compagnie",userName:(n==null?void 0:n.displayName)||void 0,userEmail:(n==null?void 0:n.email)||void 0,brandName:(f==null?void 0:f.nom)||"Compagnie",logoUrl:f==null?void 0:f.logoUrl,primaryColor:b.colors.primary,secondaryColor:b.colors.secondary,onLogout:r,banner:S,headerRight:e(Wn,{isOnline:u,darkMode:o,onDarkModeToggle:c}),mainClassName:"agency-content-transition"})})})})},ip=Object.freeze(Object.defineProperty({__proto__:null,default:wc},Symbol.toStringTag,{value:"Module"})),Us={primary:"#3B82F6",secondary:"#6366F1"},Bs=l.createContext(Us);function Gs(){return l.useContext(Bs)??Us}const Cc=Bs.Provider,Sc=()=>{const a=De(),{user:n,logout:r,company:s,loading:i}=Pe(),u=a.companyId,o=n==null?void 0:n.companyId,[c,m]=Je.useState(s??null),[h,d]=mn();Je.useEffect(()=>(h?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),()=>document.documentElement.classList.remove("dark")),[h]);const p=lt(c),f=Je.useMemo(()=>{var C;return{primary:(p==null?void 0:p.primary)??"#475569",secondary:(p==null?void 0:p.secondary)??"#64748b",primaryDark:p==null?void 0:p.primaryDark,primaryLight:p==null?void 0:p.primaryLight,buttonText:((C=p==null?void 0:p.colors)==null?void 0:C.buttonText)??"#ffffff"}},[p]);Je.useEffect(()=>{if(!u||u===o){m(s);return}(async()=>{try{const j=await Se(me(G,"companies",u));if(j.exists()){const L=j.data();m({id:j.id,nom:L.nom||"",slug:L.slug??"",logoUrl:L.logoUrl,...L})}}catch(j){console.error("Error loading company:",j)}})()},[u,o,s]);const x=u?`/compagnie/${u}/garage`:"/compagnie/garage",b=[{label:"Tableau de bord",icon:$i,path:`${x}/dashboard`,end:!0},{label:"Liste flotte",icon:Li,path:`${x}/fleet`,end:!0},{label:"Maintenance",icon:ji,path:`${x}/maintenance`,end:!0},{label:"Transit",icon:Kt,path:`${x}/transit`,end:!0},{label:"Incidents",icon:nt,path:`${x}/incidents`,end:!0}],P=e("button",{type:"button",onClick:d,className:"p-2 rounded-lg transition text-xs bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-200",title:h?"Mode jour":"Mode nuit",children:h?e(Ss,{className:"w-4 h-4"}):e(As,{className:"w-4 h-4"})});return i?e("div",{className:"min-h-screen flex items-center justify-center bg-slate-100",children:t("div",{className:"text-center",children:[e("div",{className:"w-12 h-12 border-4 border-slate-300 border-t-slate-600 rounded-full animate-spin mx-auto mb-4"}),e("p",{className:"text-sm text-slate-600",children:"Chargement..."})]})}):e("div",{className:h?"agency-dark":"",children:e(La,{currency:c==null?void 0:c.devise,children:e(js,{children:e(Cc,{value:f,children:e(un,{sections:b,role:(n==null?void 0:n.role)||"chef_garage",userName:(n==null?void 0:n.displayName)||void 0,userEmail:(n==null?void 0:n.email)||void 0,brandName:(c==null?void 0:c.nom)||"Garage",logoUrl:c==null?void 0:c.logoUrl,primaryColor:f.primary,secondaryColor:f.secondary,onLogout:r,mainClassName:"garage-content",headerRight:P})})})})})},op=Object.freeze(Object.defineProperty({__proto__:null,default:Sc},Symbol.toStringTag,{value:"Module"})),Ac=()=>{var D,k,S;const a=De(),{user:n,logout:r,company:s,loading:i}=Pe(),u=Yn(),[o,c]=mn(),m=a.companyId,h=n==null?void 0:n.companyId,d=m||h,p=!!((n==null?void 0:n.role)==="admin_platforme"&&m),[f,x]=l.useState(s);l.useEffect(()=>{if(!m||m===h){x(s);return}(async()=>{try{const O=await Se(me(G,"companies",m));if(O.exists()){const I=O.data();x({id:O.id,nom:I.nom||"",slug:I.slug||"",logoUrl:I.logoUrl,...I})}}catch(O){console.error("[AccountantLayout] Error loading company:",O)}})()},[m,h,s]);const b=lt(f),[P,C]=l.useState(0),j=l.useRef(null),L=l.useRef(new Set);l.useEffect(()=>{const O=()=>{j.current||(j.current=new Audio("/notification.mp3"),j.current.preload="auto"),document.removeEventListener("click",O),document.removeEventListener("keydown",O)};return document.addEventListener("click",O),document.addEventListener("keydown",O),()=>{document.removeEventListener("click",O),document.removeEventListener("keydown",O)}},[]),l.useEffect(()=>{if(!d)return;const O=[],I=new Map;return(async()=>{try{(await ee(Q(G,"companies",d,"agences"))).docs.forEach(R=>{const w=R.id,N=ce(Q(G,"companies",d,"agences",w,"reservations"),ne("statut","==","preuve_recue")),g=st(N,v=>{I.set(w,v.size),C(Array.from(I.values()).reduce((U,E)=>U+E,0)),v.docChanges().forEach(U=>{var E,B;if(U.type==="added"){const V=`${w}_${U.doc.id}`,z=(B=(E=U.doc.data().createdAt)==null?void 0:E.toDate)==null?void 0:B.call(E);if(z&&Date.now()-z.getTime()>3e4){L.current.add(V);return}if(!L.current.has(V)){if(j.current)try{j.current.currentTime=0,j.current.play().catch(()=>{})}catch{}L.current.add(V)}}})});O.push(g)})}catch($){console.error("[AccountantLayout] Init error:",$)}})(),()=>O.forEach($=>$())},[d]);const M=`/compagnie/${d}/accounting`,_=[{label:"Vue Globale",icon:wa,path:M,end:!0},{label:"RÃ©servations",icon:wt,path:`${M}/reservations-en-ligne`,badge:P},{label:"Finances",icon:Rt,path:`${M}/finances`},{label:"TrÃ©sorerie",icon:ia,path:`${M}/treasury`},{label:"Rapports",icon:ft,path:`${M}/rapports`},{label:"ParamÃ¨tres",icon:bn,path:`${M}/parametres`}];if(Kn(_),i)return e("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:t("div",{className:"text-center",children:[e("div",{className:"w-12 h-12 border-4 border-t-transparent rounded-full animate-spin mx-auto mb-4",style:{borderColor:`${((D=b==null?void 0:b.colors)==null?void 0:D.primary)??"#FF6600"} transparent transparent transparent`}}),e("p",{className:"text-sm text-gray-500",children:"Chargement..."})]})});const F=p?e("div",{className:"bg-yellow-50 border-b border-yellow-200 px-6 py-2",children:t("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[t("span",{className:"text-sm text-yellow-800",children:["Mode inspection comptable : ",e("strong",{children:f==null?void 0:f.nom})]}),e("button",{onClick:()=>window.location.href="/admin/compagnies",className:"text-sm bg-yellow-600 text-white px-3 py-1 rounded-lg hover:bg-yellow-700 transition",children:"Retour admin"})]})}):null;return e(La,{currency:f==null?void 0:f.devise,children:e("div",{className:o?"agency-dark":"",children:e(un,{sections:_,role:(n==null?void 0:n.role)||"company_accountant",userName:(n==null?void 0:n.displayName)||void 0,userEmail:(n==null?void 0:n.email)||void 0,brandName:(f==null?void 0:f.nom)||"Compagnie",logoUrl:f==null?void 0:f.logoUrl,primaryColor:(k=b==null?void 0:b.colors)==null?void 0:k.primary,secondaryColor:(S=b==null?void 0:b.colors)==null?void 0:S.secondary,onLogout:r,banner:F,headerRight:e(Wn,{isOnline:u,darkMode:o,onDarkModeToggle:c}),mainClassName:"agency-content-transition"})})})},cp=Object.freeze(Object.defineProperty({__proto__:null,default:Ac},Symbol.toStringTag,{value:"Module"}));function Ha(a){return(a||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/-/g," ").trim()}function zn(a){return(a||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}function Vr(a){const n=pn(a)||zn(a);return n==="paye"||n==="paid"||n==="payed"}function Ya(a){const n=a.getFullYear(),r=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${n}-${r}-${s}`}function Hr(a){try{if(!a)return null;if(a instanceof Date)return a;if(typeof(a==null?void 0:a.toDate)=="function")return a.toDate();if(typeof a=="string"){const n=new Date(a);return isNaN(n.getTime())?null:n}return null}catch{return null}}const Ec=["reservations","reservation","bookings","reserves","resas"];async function Yr(a,n){const r=[];for(const s of Ec){r.push(s);const i=Q(G,`companies/${a}/agences/${n}/${s}`);try{return console.log("â–¶ Test chemin:",`companies/${a}/agences/${n}/${s}`),await ee(ce(i)),{ref:i,nameTried:r}}catch(u){console.warn(`âš ï¸ Chemin refusÃ© (${s}) â†’`,(u==null?void 0:u.message)||u);continue}}return{ref:null,nameTried:r}}function kc({companyId:a,dateFrom:n,dateTo:r}){const s=Qe(),[i,u]=l.useState(!0),[o,c]=l.useState(null),[m,h]=l.useState([]),[d,p]=l.useState([]),[f,x]=l.useState([]);l.useEffect(()=>{if(!a)return;console.log("ðŸ¢ Dashboard companyId =",a);const $=me(G,`companies/${a}`);Se($).then(R=>c({id:a,...R.data()})).catch(R=>{console.error("âœ– get company meta:",R)})},[a]),l.useEffect(()=>{if(!a)return;const $=ce(Q(G,`companies/${a}/agences`));console.log("ðŸ“¡ Listen agences:",`companies/${a}/agences`);const R=st($,w=>{const N=w.docs.map(g=>{const v=g.data(),U=v.nomAgence??v.nom??"";return{id:g.id,nom:U,ville:v.ville}});h(N)},w=>console.error("âœ– onSnapshot agences:",w));return()=>R()},[a]),l.useEffect(()=>{if(!a)return;u(!0);const $=fe.fromDate(n),R=fe.fromDate(r);let w=!1;const N=[];return(async()=>{try{const v=(await ee(Q(G,`companies/${a}/agences`))).docs.map(B=>B.id);if(console.log("ðŸ“„ Agences trouvÃ©es:",v.length,v),v.length===0){w||(p([]),u(!1));return}const U=[];let E=0;for(const B of v){const{ref:V,nameTried:K}=await Yr(a,B);if(!V){console.error("âœ– Impossible d'ouvrir une sous-collection de rÃ©servations pour",B," (essayÃ©:",K.join(", "),")"),E+=1,E===v.length&&!w&&(p(U),u(!1));continue}const z=ce(V,ne("createdAt",">=",$),ne("createdAt","<=",R));console.log("ðŸ“¡ Listen rÃ©servations:",V.path);const T=st(z,W=>{const q=W.docs.map(te=>{const ae=te.data();return{id:te.id,agencyId:B,agenceId:B,agencyNom:ae.agencyNom,agencyVille:ae.agencyVille,depart:ae.depart,arrival:ae.arrival,departNormalized:ae.departNormalized,arrivee:ae.arrivee,date:ae.date,heure:ae.heure,canal:ae.canal,statut:ae.statut,montant:ae.montant||0,seatsGo:ae.seatsGo||1,clientPhone:ae.clientPhone,clientId:ae.clientId,createdAt:ae.createdAt}}),H=U.filter(te=>te.agencyId!==B&&te.agenceId!==B);U.splice(0,U.length,...H,...q);const le=U.filter(te=>{const ae=Hr(te.createdAt)??(te.date?new Date(`${te.date}T${te.heure||"00:00"}:00`):null);return ae?ae>=n&&ae<=r:!1});w||p(le)},W=>{console.error(`âœ– onSnapshot rÃ©servations (${V.path}):`,W)});N.push(T),E+=1}}catch(g){console.error("âœ– Dashboard attach error:",g)}finally{w||u(!1)}})(),()=>{w=!0,N.forEach(g=>g())}},[a,n.getTime(),r.getTime()]),l.useEffect(()=>{if(!a)return;const $=r.getTime()-n.getTime(),R=new Date(n.getTime()-864e5),w=new Date(R.getTime()-$),N=fe.fromDate(w),g=fe.fromDate(R);(async()=>{try{const U=(await ee(Q(G,`companies/${a}/agences`))).docs.map(B=>B.id),E=[];for(const B of U){const{ref:V}=await Yr(a,B);if(!V)continue;const K=ce(V,ne("createdAt",">=",N),ne("createdAt","<=",g),Re(500));(await ee(K)).docs.forEach(T=>{const W=T.data();E.push({id:T.id,agencyId:B,agenceId:B,agencyNom:W.agencyNom,agencyVille:W.agencyVille,statut:W.statut,montant:W.montant||0,seatsGo:W.seatsGo||1,createdAt:W.createdAt,date:W.date,heure:W.heure})})}x(E)}catch(v){console.error("âœ– Previous period reservations:",v),x([])}})()},[a,n.getTime(),r.getTime()]);const b=l.useMemo(()=>d.filter($=>Vr($.statut)),[d]),P=l.useMemo(()=>f.filter($=>Vr($.statut)),[f]),C=l.useMemo(()=>{const $=new Map;return P.forEach(R=>{const w=R.agencyId||R.agenceId;w&&$.set(w,($.get(w)??0)+(R.montant||0))}),$},[P]),j=m.length,L=l.useMemo(()=>{const $=new Map;return m.forEach(R=>$.set(R.id,{id:R.id,nom:R.nom,ville:R.ville,reservations:0,revenus:0})),b.forEach(R=>{const w=R.agencyId||R.agenceId;if(!w)return;const N=$.get(w)||{id:w,nom:R.agencyNom||"Agence inconnue",ville:R.agencyVille,reservations:0,revenus:0};N.reservations+=R.seatsGo||1,N.revenus+=R.montant||0,$.set(w,N)}),Array.from($.values()).map(R=>{const w=C.get(R.id)??0,N=w>0?Math.round((R.revenus-w)/w*100*10)/10:void 0;return{...R,variation:N}}).sort((R,w)=>w.revenus-R.revenus)},[m,b,C]);l.useMemo(()=>{const $=new Set;return b.forEach(R=>{R.clientId?$.add("id:"+R.clientId):R.clientPhone&&$.add("tel:"+R.clientPhone)}),$.size},[b]);const M=l.useMemo(()=>{const $=new Set;return b.forEach(R=>{const w=Ha(R.depart||R.departNormalized),N=Ha(R.arrival||R.arrivee);w&&$.add(w),N&&$.add(N)}),$.size},[b]),_=l.useMemo(()=>{const $=new Map;return b.forEach(R=>{const w=zn(R.canal),N=w.includes("ligne")||w==="online"||w==="web"?"En ligne":w.includes("guichet")?"Guichet":"Autres";$.set(N,($.get(N)||0)+1)}),Array.from($).map(([R,w])=>({name:R,value:w})).sort((R,w)=>w.value-R.value)},[b]),F=l.useMemo(()=>{const $=new Map;return d.forEach(R=>{const w=zn(R.statut)||"â€”";$.set(w,($.get(w)||0)+1)}),Array.from($).map(([R,w])=>({name:R,value:w}))},[d]),D=l.useMemo(()=>{const $=b.reduce((q,H)=>q+(H.montant||0),0),R=P.reduce((q,H)=>q+(H.montant||0),0),w=R>0?Math.round(($-R)/R*1e3)/10:null,N="vs pÃ©riode prÃ©cÃ©dente",g=b.length,v=new Set;b.forEach(q=>{q.clientId?v.add(`id:${q.clientId}`):q.clientPhone&&v.add(`tel:${q.clientPhone}`)});const U=v.size;b.reduce((q,H)=>q+(H.seatsGo||1),0);const E="N/A",B=new Set;b.forEach(q=>{const H=q.agencyId||q.agenceId;H&&B.add(H)});const V=_.reduce((q,H)=>q+H.value,0),K=_.filter(q=>q.name==="En ligne").reduce((q,H)=>q+H.value,0),z=_.filter(q=>q.name==="Guichet").reduce((q,H)=>q+H.value,0),T=V?Math.round(K/V*100):0,W=V?Math.round(z/V*100):0;return{caPeriode:$,caPeriodeFormatted:s($),caDeltaText:N,caDeltaPercent:w,reservationsCount:g,clientsUniques:U,agencesActives:B.size,totalAgences:j,villesCouvertes:M,tauxRemplissageText:E,parCanal:_,parStatut:F,partEnLigne:T,partGuichet:W}},[b,P,j,M,_,F]),k=l.useMemo(()=>{const $=new Map;for(let w=new Date(n);w<=r;w.setDate(w.getDate()+1))$.set(Ya(w),{reservations:0,revenue:0});return b.forEach(w=>{const N=Hr(w.createdAt)??(w.date?new Date(`${w.date}T${w.heure||"00:00"}:00`):new Date),g=Ya(N),v=$.get(g)||{reservations:0,revenue:0};v.reservations+=w.seatsGo||1,v.revenue+=w.montant||0,$.set(g,v)}),{daily:Array.from($).map(([w,N])=>({date:w,reservations:N.reservations,revenue:N.revenue}))}},[b,n.getTime(),r.getTime()]),S=l.useMemo(()=>{const $=new Map;return b.forEach(R=>{const w=Ha(R.depart||R.departNormalized),N=Ha(R.arrival||R.arrivee);if(!w||!N)return;const g=`${w} â†’ ${N}`,v=$.get(g)||{reservations:0,revenus:0};v.reservations+=R.seatsGo||1,v.revenus+=R.montant||0,$.set(g,v)}),Array.from($).map(([R,w])=>({trajet:R,reservations:w.reservations,revenus:w.revenus})).sort((R,w)=>w.reservations-R.reservations).slice(0,12)},[b]),O=l.useMemo(()=>{var g,v;const $=[],R=((g=F.find(U=>U.name.includes("attente")))==null?void 0:g.value)||0;R>50&&$.push({level:"warning",message:`${R} rÃ©servations en attente`});const w=((v=F.find(U=>U.name.includes("preuve")))==null?void 0:v.value)||0;w>0&&$.push({level:"info",message:`${w} preuve(s) reÃ§ue(s) Ã  valider`});const N=L.filter(U=>U.reservations===0);return N.length>0&&$.push({level:"warning",message:`${N.length} agence(s) sans vente`}),$},[L,F]);function I($){const w=[["id","agencyId","date","heure","depart","arrivee","montant","canal","statut","seatsGo","clientPhone"].join(",")].concat($.map(U=>[U.id,U.agencyId||U.agenceId||"",U.date||"",U.heure||"",U.depart||U.departNormalized||"",U.arrival||U.arrivee||"",String(U.montant||0),U.canal||"",U.statut||"",String(U.seatsGo||1),U.clientPhone||""].map(E=>`"${String(E).replace(/"/g,'""')}"`).join(","))).join(`
`),N=new Blob([w],{type:"text/csv;charset=utf-8;"}),g=URL.createObjectURL(N),v=document.createElement("a");v.href=g,v.download=`reservations_${Ya(n)}_${Ya(r)}.csv`,v.click(),URL.revokeObjectURL(g)}return{loading:i,company:o,kpis:D,series:k,perAgency:L,topTrajets:S,alerts:O,rawReservations:d,exportCSV:I}}const Ic=({className:a="",...n})=>e("div",{className:`animate-pulse rounded-md bg-gray-200 ${a}`,...n}),Rc=({items:a,couleurPrimaire:n="#f97316",couleurSecondaire:r="#fb923c",loading:s=!1})=>{const i=Be();return s?e("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:Array.from({length:5}).map((u,o)=>e(Ic,{className:"h-20 rounded-xl"},o))}):e("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:a.map(({icon:u,label:o,value:c,sub:m,to:h},d)=>{const p=t("div",{className:"p-4 rounded-xl shadow-sm bg-white border border-gray-100 flex flex-col gap-2 transition hover:shadow-md hover:-translate-y-0.5",style:{borderTop:`3px solid ${n}`},children:[t("div",{className:"flex items-center gap-2 text-gray-700",children:[e(u,{size:20,style:{color:n},className:"flex-shrink-0"}),e("span",{className:"font-medium text-sm",children:o})]}),e("div",{className:"text-2xl font-bold",style:{color:n},children:c}),m&&e("div",{className:"text-xs text-gray-500",style:{color:r},children:m})]},d);return h?e("button",{onClick:()=>i(h),className:"text-left focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-xl transition",style:{boxShadow:"none"},children:p},d):p})})},_c=({range:a,setRange:n,customStart:r,setCustomStart:s,customEnd:i,setCustomEnd:u})=>t("div",{className:"flex flex-wrap gap-2 items-center",children:[[{key:"day",label:"Jour"},{key:"month",label:"Mois en cours"},{key:"prev_month",label:"Mois prÃ©cÃ©dent"},{key:"ytd",label:"Depuis janvier"},{key:"12m",label:"12 derniers mois"},{key:"custom",label:"PersonnalisÃ©"}].map(o=>e("button",{onClick:()=>n(o.key),className:`px-3 py-1 text-sm rounded-full border transition ${a===o.key?"bg-[var(--btn-primary,#FF6600)] text-white border-[var(--btn-primary,#FF6600)]":"bg-white text-gray-700 hover:bg-gray-100 border-gray-300"}`,children:o.label},o.key)),a==="custom"&&t("div",{className:"flex items-center gap-2",children:[t("div",{className:"flex items-center gap-1",children:[e(dt,{className:"h-4 w-4 text-gray-500"}),e("input",{type:"date",value:r||"",onChange:o=>s(o.target.value||null),className:"border rounded px-2 py-1 text-sm"})]}),e("span",{className:"text-gray-500",children:"â†’"}),t("div",{className:"flex items-center gap-1",children:[e(dt,{className:"h-4 w-4 text-gray-500"}),e("input",{type:"date",value:i||"",onChange:o=>u(o.target.value||null),className:"border rounded px-2 py-1 text-sm"})]})]})]}),Tc="#ef4444",Pc="#3b82f6";function Dc({data:a,loading:n,primaryColor:r,secondaryColor:s}){const i=r||Tc,u=s||Pc;return n?e("div",{className:"h-72 flex items-center justify-center text-sm text-muted-foreground",children:"Chargementâ€¦"}):!a||a.length===0?e("div",{className:"h-72 flex items-center justify-center text-sm text-muted-foreground",children:"Aucune donnÃ©e sur la pÃ©riode."}):e("div",{className:"h-72 w-full",children:e(Pl,{width:"100%",height:"100%",children:t(jl,{data:a,margin:{top:10,right:18,bottom:0,left:0},children:[t("defs",{children:[t("linearGradient",{id:"fillRevenue",x1:"0",y1:"0",x2:"0",y2:"1",children:[e("stop",{offset:"0%",stopColor:i,stopOpacity:.2}),e("stop",{offset:"100%",stopColor:i,stopOpacity:0})]}),t("linearGradient",{id:"fillReservations",x1:"0",y1:"0",x2:"0",y2:"1",children:[e("stop",{offset:"0%",stopColor:u,stopOpacity:.2}),e("stop",{offset:"100%",stopColor:u,stopOpacity:0})]})]}),e(Dl,{strokeDasharray:"3 3",stroke:"#e5e7eb"}),e(Ml,{dataKey:"date",tick:{fontSize:12}}),e(Nr,{yAxisId:"left",tick:{fontSize:12}}),e(Nr,{yAxisId:"right",orientation:"right",tick:{fontSize:12}}),e($l,{}),e(Ll,{}),e(wr,{yAxisId:"left",type:"monotone",dataKey:"revenue",name:"Chiffre dâ€™affaires",stroke:i,strokeWidth:2,fill:"url(#fillRevenue)",dot:!1,activeDot:{r:4,fill:i}}),e(wr,{yAxisId:"right",type:"monotone",dataKey:"reservations",name:"RÃ©servations",stroke:u,strokeWidth:2,fill:"url(#fillReservations)",dot:!1,activeDot:{r:4,fill:u}})]})})})}const Mc=({totalAgencies:a,healthyAgencies:n,atRiskAgencies:r,trend:s})=>{const i={up:{label:"Tendance positive",icon:e(Rt,{className:"h-4 w-4 text-emerald-600"}),color:"text-emerald-700"},down:{label:"Tendance nÃ©gative",icon:e(ar,{className:"h-4 w-4 text-red-600"}),color:"text-red-700"},stable:{label:"Tendance stable",icon:e(ws,{className:"h-4 w-4 text-gray-500"}),color:"text-gray-700"}}[s];return t(Mt,{children:[e($t,{children:e(Lt,{children:"SantÃ© du rÃ©seau"})}),t(jt,{children:[t("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t("div",{className:"flex items-center gap-3",children:[e(St,{className:"h-5 w-5 text-gray-600"}),t("div",{children:[e("div",{className:"text-sm text-gray-500",children:"Agences actives"}),e("div",{className:"text-lg font-semibold",children:a})]})]}),t("div",{children:[e("div",{className:"text-sm text-gray-500",children:"Agences performantes"}),e("div",{className:"text-lg font-semibold text-emerald-700",children:n})]}),t("div",{children:[e("div",{className:"text-sm text-gray-500",children:"Agences Ã  risque"}),e("div",{className:"text-lg font-semibold text-red-700",children:r})]})]}),t("div",{className:`mt-4 flex items-center gap-2 text-sm ${i.color}`,children:[i.icon,e("span",{children:i.label})]})]})]})},$c=({alerts:a=[],loading:n=!1})=>{const r=i=>{var h,d,p;const u=["ca","chiffre","revenu","financier","argent","perte","bloc","arrÃªt","panne","interruption","systÃ¨me","critique","urgence","important","grave","anomalie","sÃ©curitÃ©","violation","erreur"],o=((h=i.title)==null?void 0:h.toLowerCase())||"",c=((d=i.description)==null?void 0:d.toLowerCase())||"",m=((p=i.type)==null?void 0:p.toLowerCase())||"";return u.some(f=>o.includes(f)||c.includes(f)||m.includes(f)||i.level==="high"||i.severity==="high")},s=a.filter(r);return n?t(Mt,{children:[e($t,{children:e(Lt,{children:"Alertes critiques"})}),e(jt,{children:e("div",{className:"text-sm text-gray-500",children:"Chargement des alertes..."})})]}):s.length===0?t(Mt,{children:[e($t,{children:e(Lt,{children:"Alertes critiques"})}),e(jt,{children:e("div",{className:"text-sm text-gray-500",children:"âœ… Aucune alerte critique dÃ©tectÃ©e."})})]}):t(Mt,{children:[e($t,{children:e(Lt,{children:"Alertes critiques nÃ©cessitant dÃ©cision"})}),e(jt,{className:"space-y-3",children:s.map((i,u)=>t("div",{className:"flex items-start gap-3 p-3 rounded-lg border border-red-200 bg-red-50",children:[e(nt,{className:"h-5 w-5 text-red-600 mt-0.5 flex-shrink-0"}),t("div",{className:"flex-1",children:[e("div",{className:"font-medium text-red-700",children:i.title}),i.description&&e("div",{className:"text-sm text-red-600 mt-1",children:i.description}),i.date&&e("div",{className:"text-xs text-red-400 mt-1",children:i.date})]})]},i.id||`alert-${u}`))})]})},Lc="month";function jc(){const{user:a}=Pe(),{companyId:n}=De(),r=Tt(),s=n??(a==null?void 0:a.companyId)??"",i=Qe(),{setHeader:u,resetHeader:o}=ut();l.useEffect(()=>(u({title:"Performance RÃ©seau"}),()=>o()),[u,o]);const[c,m]=l.useState(Lc),[h,d]=l.useState(null),[p,f]=l.useState(null),[x,b]=l.useState(new Date);l.useEffect(()=>{const g=setInterval(()=>b(new Date),6e4);return()=>clearInterval(g)},[]);const{dateFrom:P,dateTo:C,periodLabel:j}=l.useMemo(()=>{const g=new Date(x.getFullYear(),x.getMonth(),x.getDate(),23,59,59);let v=new Date(x.getFullYear(),x.getMonth(),1),U=g;c==="day"&&(v=new Date(x.getFullYear(),x.getMonth(),x.getDate(),0,0,0),U=new Date(x.getFullYear(),x.getMonth(),x.getDate(),23,59,59));const E=new Intl.DateTimeFormat("fr-FR",{month:"long",year:"numeric"}).format(v);return{dateFrom:v,dateTo:U,periodLabel:E}},[c,h,p,x]);if(!s)return t("div",{className:"p-6",children:[e("h1",{className:"text-xl font-semibold mb-2",children:"Dashboard Compagnie"}),e("p",{className:"text-sm text-muted-foreground",children:"Company ID introuvable."})]});const{loading:L,company:M,kpis:_,series:F,perAgency:D,alerts:k}=kc({companyId:s,dateFrom:P,dateTo:C}),S=D??[],O=S,I=O.filter(g=>(g.revenus??0)>0&&(g.variation===void 0||g.variation>=-15)).length,$=O.filter(g=>(g.revenus??0)===0||g.variation!==void 0&&g.variation<-15).length,R=l.useMemo(()=>{const g=_.caDeltaPercent;return g==null?"stable":g>0?"up":g<0?"down":"stable"},[_.caDeltaPercent]),w=(k==null?void 0:k.map((g,v)=>({id:g.id??`alert-${v}`,title:g.title??"Alerte",description:g.description,level:g.level??"medium"})))??[],N=l.useMemo(()=>[...S.map(v=>({...v,ca:v.revenus??0}))].sort((v,U)=>U.ca-v.ca),[S]);return t("div",{className:"space-y-6 p-4 md:p-6",children:[!r&&e(Xn,{message:"Connexion instable: certains blocs de performance peuvent Ãªtre retardÃ©s."}),t("div",{className:"flex justify-between items-center",children:[t("div",{children:[e("h2",{className:"text-2xl font-bold",children:"Performance RÃ©seau"}),t("p",{className:"text-sm text-muted-foreground",children:["CA par agence, classement et alertes â€” PÃ©riode : ",j]})]}),e(_c,{range:c,setRange:m,customStart:h,setCustomStart:d,customEnd:p,setCustomEnd:f})]}),e(Rc,{loading:L,couleurPrimaire:M==null?void 0:M.couleurPrimaire,couleurSecondaire:M==null?void 0:M.couleurSecondaire,items:[{icon:Rt,label:"CA",value:_.caPeriodeFormatted,sub:_.caDeltaPercent!=null?`Variation : ${_.caDeltaPercent>=0?"+":""}${_.caDeltaPercent}%`:_.caDeltaText,to:`/compagnie/${s}/reservations`},{icon:hn,label:"Billets vendus",value:String(_.reservationsCount||0),sub:"Tous canaux",to:`/compagnie/${s}/reservations`},{icon:St,label:"Agences actives",value:String(_.agencesActives),sub:`${_.totalAgences} au total`,to:`/compagnie/${s}/parametres`}]}),_.caDeltaPercent!=null&&t("div",{className:"flex items-center gap-2 text-sm",children:[e("span",{className:"text-gray-600",children:"Variation vs pÃ©riode prÃ©cÃ©dente :"}),t("span",{className:`font-semibold ${_.caDeltaPercent>=0?"text-emerald-600":"text-red-600"}`,children:[_.caDeltaPercent>=0?"+":"",_.caDeltaPercent,"%"]})]}),t(Mt,{children:[e($t,{children:e(Lt,{children:"Ã‰volution"})}),e(jt,{children:e(Dc,{data:F.daily,loading:L,primaryColor:M==null?void 0:M.couleurPrimaire,secondaryColor:M==null?void 0:M.couleurSecondaire})})]}),t(Mt,{children:[e($t,{children:e(Lt,{children:"Classement agences (CA pÃ©riode)"})}),e(jt,{children:L?e("p",{className:"text-sm text-gray-500",children:"Chargementâ€¦"}):N.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucune donnÃ©e pour la pÃ©riode."}):e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full text-sm",children:[e("thead",{children:t("tr",{className:"border-b",children:[e("th",{className:"text-left py-2",children:"Rang"}),e("th",{className:"text-left py-2",children:"Agence"}),e("th",{className:"text-right py-2",children:"CA"})]})}),e("tbody",{children:N.map((g,v)=>t("tr",{className:"border-b",children:[e("td",{className:"py-2 font-medium",children:v+1}),e("td",{className:"py-2",children:g.nom||"Agence inconnue"}),e("td",{className:"py-2 text-right",children:i(g.revenus??0)})]},g.id??v))})]})})})]}),t(Mt,{children:[e($t,{children:e(Lt,{children:"SantÃ© du rÃ©seau"})}),e(jt,{children:e(Mc,{totalAgencies:_.totalAgences,healthyAgencies:I,atRiskAgencies:$,trend:R})})]}),t(Mt,{children:[e($t,{children:e(Lt,{children:"Alertes par agence"})}),e(jt,{children:e($c,{alerts:w,loading:L})})]})]})}const dp=Object.freeze(Object.defineProperty({__proto__:null,default:jc},Symbol.toStringTag,{value:"Module"})),Kr={weekStartsOn:1,locale:Yt};function qa(a,n=new Date,r,s){const i=new Date(n.getTime());if(a==="custom"&&r&&s){const u=new Date(r);u.setHours(0,0,0,0);const o=new Date(s);return o.setHours(23,59,59,999),{start:u,end:o}}switch(a){case"day":{const u=ms(i),o=us(i);return{start:u,end:o}}case"week":{const u=Bl(i,Kr),o=Gl(i,Kr);return{start:u,end:o}}case"month":{const u=ql(i),o=Ul(i);return{start:u,end:o}}case"year":{const u=Fl(i),o=Ol(i);return{start:u,end:o}}default:return qa("month",i)}}function Fc(a,n){const r=typeof a=="number"?new Date(a):a;return zl(r,{start:n.start,end:n.end})}function zs(a,n,r,s){return a==="custom"&&r&&s?`${new Date(r).toLocaleDateString("fr-FR")} â†’ ${new Date(s).toLocaleDateString("fr-FR")}`:`${n.start.toLocaleDateString("fr-FR")} â†’ ${n.end.toLocaleDateString("fr-FR")}`}const Oc=[{kind:"day",label:"Jour"},{kind:"week",label:"Semaine"},{kind:"month",label:"Mois"},{kind:"year",label:"AnnÃ©e"},{kind:"custom",label:"PersonnalisÃ©"}],ir=({period:a,customStart:n,customEnd:r,onPeriodChange:s,className:i=""})=>{const u=l.useMemo(()=>qa(a,new Date,n,r),[a,n,r]),o=zs(a,u,n,r);return t("div",{className:`flex flex-wrap items-center gap-3 ${i}`,children:[e("div",{className:"flex flex-wrap gap-1",children:Oc.map(c=>e("button",{type:"button",onClick:()=>{if(c.kind==="custom"){const m=new Date,h=new Date(m);h.setDate(h.getDate()-30),s("custom",h.toISOString().slice(0,10),m.toISOString().slice(0,10))}else s(c.kind)},className:`px-3 py-1.5 rounded-lg text-sm font-medium transition ${a===c.kind?"bg-indigo-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:c.label},c.kind))}),a==="custom"&&t("div",{className:"flex items-center gap-2 flex-wrap",children:[e("input",{type:"date",value:n??"",onChange:c=>s("custom",c.target.value||void 0,r),className:"border border-gray-300 rounded-lg px-2 py-1.5 text-sm"}),e("span",{className:"text-gray-500 text-sm",children:"â†’"}),e("input",{type:"date",value:r??"",onChange:c=>s("custom",n,c.target.value||void 0),className:"border border-gray-300 rounded-lg px-2 py-1.5 text-sm"})]}),e("span",{className:"text-sm text-gray-500",children:o})]})};function qc(a,n){return a<=0?0:n/a}function Uc(a){const n=Number(a.revenueFromDailyStats)||0,r=(Number(a.expensesTotal)||0)+(Number(a.tripCostsTotal)||0)+(Number(a.discrepancyDeduction)||0),s=n-r;return{revenue:n,cost:r,profit:s,margin:qc(n,s)}}const or="tripCosts";function Bc(a){return(Number(a.fuelCost)||0)+(Number(a.driverCost)||0)+(Number(a.assistantCost)||0)+(Number(a.tollCost)||0)+(Number(a.maintenanceCost)||0)+(Number(a.otherOperationalCost)||0)}function Vs(a){return Q(G,"companies",a,or)}function Gc(a,n){return me(G,"companies",a,or,n)}async function zc(a,n,r){const s=me(Vs(a)),i=fe.now();return await Bt(s,{tripId:n.tripId,agencyId:n.agencyId,date:n.date,fuelCost:Number(n.fuelCost)||0,driverCost:Number(n.driverCost)||0,assistantCost:Number(n.assistantCost)||0,tollCost:Number(n.tollCost)||0,maintenanceCost:Number(n.maintenanceCost)||0,otherOperationalCost:Number(n.otherOperationalCost)||0,createdAt:i,createdBy:r}),s.id}async function Vc(a,n,r){const s=Gc(a,n),i={updatedAt:Oe()};r.fuelCost!==void 0&&(i.fuelCost=Number(r.fuelCost)||0),r.driverCost!==void 0&&(i.driverCost=Number(r.driverCost)||0),r.assistantCost!==void 0&&(i.assistantCost=Number(r.assistantCost)||0),r.tollCost!==void 0&&(i.tollCost=Number(r.tollCost)||0),r.maintenanceCost!==void 0&&(i.maintenanceCost=Number(r.maintenanceCost)||0),r.otherOperationalCost!==void 0&&(i.otherOperationalCost=Number(r.otherOperationalCost)||0),await He(s,i)}async function Hc(a,n){const r=[];n!=null&&n.date&&r.push(ne("date","==",n.date)),n!=null&&n.agencyId&&r.push(ne("agencyId","==",n.agencyId));const s=ce(Vs(a),...r,ot("createdAt","desc"),Re(n==null?void 0:n.limitCount));return(await ee(s)).docs.map(u=>({id:u.id,...u.data()}))}const Yc="riskSettings",Kc="current",_t={minimumMarginPercent:10,maxTransitHours:12,maxCashDiscrepancy:5e3,minimumOccupancyRate:50,vehicleCostExplosionPercent:50,maintenanceSpikeCountThreshold:5,tripFuelCostMarginThreshold:.2};function Wr(a){return!a||typeof a!="object"?_t:{minimumMarginPercent:Number(a.minimumMarginPercent)>=0?Number(a.minimumMarginPercent):_t.minimumMarginPercent,maxTransitHours:Number(a.maxTransitHours)>0?Number(a.maxTransitHours):_t.maxTransitHours,maxCashDiscrepancy:Number(a.maxCashDiscrepancy)>=0?Number(a.maxCashDiscrepancy):_t.maxCashDiscrepancy,minimumOccupancyRate:Number(a.minimumOccupancyRate)>=0&&Number(a.minimumOccupancyRate)<=100?Number(a.minimumOccupancyRate):_t.minimumOccupancyRate,vehicleCostExplosionPercent:Number(a.vehicleCostExplosionPercent)>=0?Number(a.vehicleCostExplosionPercent):_t.vehicleCostExplosionPercent??50,maintenanceSpikeCountThreshold:Number(a.maintenanceSpikeCountThreshold)>=0?Number(a.maintenanceSpikeCountThreshold):_t.maintenanceSpikeCountThreshold??5,tripFuelCostMarginThreshold:Number(a.tripFuelCostMarginThreshold)>=0?Number(a.tripFuelCostMarginThreshold):_t.tripFuelCostMarginThreshold??.2}}async function Jr(a){const n=me(G,"companies",a,Yc,Kc),r=await Se(n);return r.exists()?Wr(r.data()):Wr(null)}function Wc(a,n){let r=0,s=0,i=0;for(const p of a){const f=Number(p.currentBalance)||0;p.accountType==="company_bank"||p.accountType==="agency_bank"?r+=f:p.accountType==="company_mobile_money"||p.accountType==="mobile_money"?s+=f:p.accountType==="agency_cash"&&(i+=f)}const u=n.reduce((p,f)=>p+(Number(f.remainingAmount)||0),0),o=r+s+i-u,c=new Map,m=new Map;for(const p of a)p.accountType==="agency_cash"&&p.agencyId&&c.set(p.agencyId,(c.get(p.agencyId)??0)+(Number(p.currentBalance)||0));for(const p of n){const f=p.agencyId??"";f&&m.set(f,(m.get(f)??0)+(Number(p.remainingAmount)||0))}const h=new Set([...c.keys(),...m.keys()]),d=Array.from(h).map(p=>{const f=c.get(p)??0,x=m.get(p)??0;return{agencyId:p,cash:f,payables:x,net:f-x}});return{totalBank:r,totalMobileMoney:s,totalAgencyCash:i,totalPayables:u,netPosition:o,byAgency:d}}function Jc(a){return`${a}_agency_cash`}function Xc(a){return`company_bank_${a}`}const Hs="financialAccounts";function la(a,n){return me(G,`companies/${a}/${Hs}/${n}`)}async function mp(a,n,r,s){const i=Jc(n),u={companyId:a,currency:r,isActive:!0},o=fe.now(),c=la(a,i);(await Se(c)).exists()||await Bt(c,{...u,agencyId:n,accountType:"agency_cash",accountName:s?`Caisse ${s}`:`Caisse agence ${n}`,currentBalance:0,createdAt:o,updatedAt:Oe()})}async function Qc(a,n,r,s){const i=Xc(n),u=la(a,i);if((await Se(u)).exists())return;const c=fe.now();await Bt(u,{companyId:a,agencyId:null,accountType:"company_bank",accountName:r,currency:s,currentBalance:0,isActive:!0,createdAt:c,updatedAt:Oe()})}async function Zc(a,n){const r=Q(G,`companies/${a}/${Hs}`),s=[ne("isActive","==",!0)];(n==null?void 0:n.agencyId)!==void 0&&(n.agencyId===null?s.push(ne("agencyId","==",null)):s.push(ne("agencyId","==",n.agencyId))),n!=null&&n.accountType&&s.push(ne("accountType","==",n.accountType));const i=ce(r,...s);return(await ee(i)).docs.map(o=>{const c=o.data();return{id:o.id,agencyId:c.agencyId??null,accountType:c.accountType,accountName:c.accountName,currentBalance:Number(c.currentBalance??0),currency:c.currency??""}})}const Ys="payables";function ed(a){return Q(G,`companies/${a}/${Ys}`)}function Ks(a,n){return me(G,`companies/${a}/${Ys}/${n}`)}async function Xr(a,n,r){const s=ed(a),i=[ne("status","==",n)];r!=null&&r.agencyId&&i.push(ne("agencyId","==",r.agencyId));const u=ce(s,...i,ot("createdAt","desc"),Re((r==null?void 0:r.limitCount)??100));return(await ee(u)).docs.map(c=>({id:c.id,...c.data()}))}async function td(a,n){const[r,s]=await Promise.all([Xr(a,"pending",{limitCount:n==null?void 0:n.limitCount}),Xr(a,"partially_paid",{limitCount:n==null?void 0:n.limitCount})]),i=new Map;return r.forEach(u=>i.set(u.id,u)),s.forEach(u=>i.set(u.id,u)),Array.from(i.values())}const ze={GARAGE:"GARAGE",EN_SERVICE:"EN_SERVICE",EN_TRANSIT:"EN_TRANSIT",EN_MAINTENANCE:"EN_MAINTENANCE",ACCIDENTE:"ACCIDENTE",HORS_SERVICE:"HORS_SERVICE"},Ws="vehicles",ad=[{code:"ML",label:"Mali (ML)"}],nd={ML:{patterns:[/^[A-Z]{2}[0-9]{3}[A-Z]{2}$/,/^[A-Z]{2}[0-9]{4}MD$/]}};function Js(a){return String(a??"").replace(/\s/g,"").replace(/-/g,"").toUpperCase()}function Xs(a,n){var i;const r=Js(n);if(!r)return!1;const s=nd[a];return(i=s==null?void 0:s.patterns)!=null&&i.length?s.patterns.some(u=>u.test(r)):!0}function Qs(a,n,r){const s=String(a??"").toUpperCase().replace(/\s/g,"").slice(0,2),i=String(n??"").replace(/\D/g,"").slice(0,4),u=String(r??"").toUpperCase().replace(/\s/g,"").slice(0,2);return!s||!i||!u?"":`${s} ${i} ${u}`.trim()}const Zs="vehicleModels";function rd(a){return Q(G,"companies",a,Zs)}function sd(a){return String(a??"").trim().toUpperCase().replace(/\s+/g,"_").replace(/[^A-Z0-9_]/g,"")||"UNKNOWN"}function ld(a){return String(a??"").trim().toUpperCase()}async function id(a){const n=rd(a),s=(await ee(ce(n,Re(500)))).docs.map(i=>i.data().label??"").filter(Boolean);return[...new Set(s)].sort((i,u)=>i.localeCompare(u))}async function el(a,n){const r=ld(n);if(!r)return r;const s=sd(r),i=me(G,"companies",a,Zs,s);return(await Se(i)).exists()||await Bt(i,{label:r,createdAt:fe.now()}),r}const xe={NORMAL:"NORMAL",MAINTENANCE:"MAINTENANCE",ACCIDENTE:"ACCIDENTE",HORS_SERVICE:"HORS_SERVICE"},we={GARAGE:"GARAGE",AFFECTE:"AFFECTE",EN_TRANSIT:"EN_TRANSIT"},od={NORMAL:["MAINTENANCE","ACCIDENTE"],MAINTENANCE:["NORMAL"],ACCIDENTE:["MAINTENANCE"],HORS_SERVICE:["NORMAL"]},cd={GARAGE:["AFFECTE","EN_TRANSIT"],AFFECTE:["EN_TRANSIT"],EN_TRANSIT:["GARAGE"]};function tl(a,n){return od[a].includes(n)}function al(a,n){return cd[a].includes(n)}const It={AFFECTE:"AFFECTE",DEPART_CONFIRME:"DEPART_CONFIRME",ARRIVE:"ARRIVE",CANCELLED:"CANCELLED"},nl="affectations";function Sn(a,n){return Q(G,"companies",a,"agences",n,nl)}function rl(a,n,r){return me(G,"companies",a,"agences",n,nl,r)}async function dd(a,n,r){const s=Sn(a,n);let i=ce(s,Re((r==null?void 0:r.limitCount)??200));return r!=null&&r.status&&(i=ce(s,ne("status","==",r.status),Re(r.limitCount??200))),(await ee(i)).docs.map(o=>({id:o.id,...o.data()}))}async function up(a){const n=Q(G,"companies",a,"agences"),r=await ee(n),s=[];for(const i of r.docs){const u=Sn(a,i.id);(await ee(ce(u,Re(300)))).docs.forEach(c=>{s.push({id:c.id,agencyId:i.id,...c.data()})})}return s}async function cr(a,n,r){const s=await Se(rl(a,n,r));return s.exists()?{id:s.id,...s.data()}:null}async function pp(a,n,r,s,i,u){const o=await dd(a,n,{limitCount:200}),c=(r??"").trim().toLowerCase(),m=(s??"").trim().toLowerCase(),h=(i??"").trim().slice(0,10),d=(u??"").trim().replace(/\D/g,"").slice(0,4),p=f=>{const x=f.trim().match(/(\d{1,2})[:\h]*(\d{0,2})/);return x?x[1].padStart(2,"0")+(x[2]||"00").padStart(2,"0"):""};for(const f of o){if(f.status!==It.AFFECTE&&f.status!==It.DEPART_CONFIRME)continue;const x=(f.departureCity??"").trim().toLowerCase(),b=(f.arrivalCity??"").trim().toLowerCase();if(x!==c||b!==m)continue;const P=f.departureTime;if(!P)continue;let C="",j="";if(typeof P=="string")C=P.slice(0,10),j=p(P.slice(11,16)||P);else if(typeof P=="object"&&P.seconds!=null){const L=new Date(P.seconds*1e3);C=L.toISOString().slice(0,10),j=p(L.toTimeString().slice(0,5))}if(C===h&&!(d&&j&&j!==d))return f}return null}async function dr(a,n){const r=Q(G,"companies",a,"agences"),s=await ee(r);for(const i of s.docs){const u=i.id,o=Sn(a,u),c=ce(o,ne("vehicleId","==",n),ne("status","in",[It.AFFECTE,It.DEPART_CONFIRME]),Re(1)),m=await ee(c);if(!m.empty){const h=m.docs[0];return{agencyId:u,affectationId:h.id,data:{id:h.id,...h.data()}}}}return null}async function md(a,n,r){const s=me(Sn(a,n));return await Bt(s,{...r,assignedAt:r.assignedAt??fe.now()}),s.id}async function mr(a,n,r,s,i){const u=rl(a,n,r),o={status:s,...i};await He(u,o)}function ur(a){return Q(G,"companies",a,Ws)}function oa(a,n){return me(G,"companies",a,Ws,n)}function pr(a){const n=a.status;if(a.technicalStatus!=null&&a.operationalStatus!=null)return a;if(!n)return{...a,technicalStatus:xe.NORMAL,operationalStatus:we.GARAGE};let s=xe.NORMAL,i=we.GARAGE;switch(n){case ze.EN_MAINTENANCE:s=xe.MAINTENANCE;break;case ze.ACCIDENTE:s=xe.ACCIDENTE;break;case ze.HORS_SERVICE:s=xe.HORS_SERVICE;break;case ze.EN_TRANSIT:i=we.EN_TRANSIT;break;case ze.EN_SERVICE:i=we.AFFECTE;break}return{...a,technicalStatus:s,operationalStatus:i}}async function sl(a,n=500){const r=ur(a),s=ce(r,ot("plateNumber"),Re(Math.min(n*3,1500)));return(await ee(s)).docs.filter(o=>o.data().isArchived!==!0).slice(0,n).map(o=>{const c=pr(o.data());return{id:o.id,...c}})}async function ud(a,n){const r=n.pageSize??20,s=ur(a),i=n.orderByField==="updatedAt"?"updatedAt":n.orderByField==="technicalStatus"?"technicalStatus":"plateNumber",u=n.orderByField==="updatedAt"?"desc":"asc";let o=ce(s,ot(i,u),Re((r+1)*3));n.startAfterDoc&&(o=ce(s,ot(i,u),si(n.startAfterDoc),Re((r+1)*3)));const c=await ee(o),m=c.docs.filter(x=>x.data().isArchived!==!0),h=m.length>r,d=m.slice(0,r).map(x=>{const b=pr(x.data());return{id:x.id,...b}}),p=d.length>0?d[d.length-1].id:null,f=p?c.docs.find(x=>x.id===p)??null:null;return{vehicles:d,lastDoc:h?f:null,hasMore:h}}async function ca(a,n){const r=await Se(oa(a,n));if(!r.exists())return null;const s=pr(r.data());return{id:r.id,...s}}async function gp(a,n,r,s,i,u,o){const c=await ca(a,r);if(!c)throw new Error("VÃ©hicule introuvable");const m=c.operationalStatus??we.GARAGE,h=c.technicalStatus??xe.NORMAL,d=(c.currentCity??"").trim().toLowerCase()===(s??"").trim().toLowerCase();if(m!==we.GARAGE||h!==xe.NORMAL||!d)throw new Error("VÃ©hicule non assignable : doit Ãªtre GARAGE, NORMAL et dans la ville de l'agence.");if(await dr(a,r))throw new Error("Ce vÃ©hicule est dÃ©jÃ  affectÃ©.");const f=fe.now(),x={vehicleId:r,vehiclePlate:c.plateNumber??"",vehicleModel:c.model??"",tripId:i.tripId,departureCity:i.departureCity,arrivalCity:i.arrivalCity,departureTime:i.departureTime,driverName:i.driverName,driverPhone:i.driverPhone,convoyeurName:i.convoyeurName,convoyeurPhone:i.convoyeurPhone,status:It.AFFECTE,assignedBy:u,assignedAt:f};return md(a,n,x)}async function hp(a,n,r,s,i){const u=await cr(a,n,r);if(!u)throw new Error("Affectation introuvable.");if(u.status!==It.AFFECTE)throw new Error("Seule une affectation au statut AFFECTE peut Ãªtre annulÃ©e.");const o=await ca(a,u.vehicleId);if(o&&(o.operationalStatus??we.GARAGE)===we.AFFECTE){const c=fe.now(),m={field:"operationalStatus",from:we.AFFECTE,to:we.GARAGE,changedBy:s,role:i,timestamp:c};await He(oa(a,u.vehicleId),{operationalStatus:we.GARAGE,status:ze.GARAGE,statusHistory:Jt(m),updatedAt:Oe()})}await mr(a,n,r,It.CANCELLED)}async function fp(a,n,r,s,i){const u=await cr(a,n,r);if(!u)throw new Error("Affectation introuvable.");if(u.status!==It.AFFECTE)throw new Error("Seule une affectation au statut AFFECTE peut Ãªtre confirmÃ©e au dÃ©part.");const o=await ca(a,u.vehicleId);if(!o)throw new Error("VÃ©hicule introuvable.");const c=o.operationalStatus??we.GARAGE;if(c!==we.AFFECTE&&c!==we.GARAGE)throw new Error("VÃ©hicule doit Ãªtre GARAGE ou AFFECTE pour confirmer le dÃ©part.");if(!al(c,we.EN_TRANSIT))throw new Error("Transition opÃ©rationnelle non autorisÃ©e.");const m=fe.now(),h={field:"operationalStatus",from:c,to:we.EN_TRANSIT,changedBy:s,role:i,timestamp:m};await He(oa(a,u.vehicleId),{operationalStatus:we.EN_TRANSIT,status:ze.EN_TRANSIT,destinationCity:u.arrivalCity||null,statusHistory:Jt(h),updatedAt:Oe()}),await mr(a,n,r,It.DEPART_CONFIRME,{departureConfirmedAt:m})}async function yp(a,n,r,s,i,u){const o=await cr(a,n,r);if(!o)throw new Error("Affectation introuvable.");if(o.status!==It.DEPART_CONFIRME)throw new Error("Seule une affectation au statut DEPART_CONFIRME peut Ãªtre confirmÃ©e Ã  l'arrivÃ©e.");const c=await ca(a,o.vehicleId);if(!c)throw new Error("VÃ©hicule introuvable.");const m=c.operationalStatus??we.GARAGE,d=(c.destinationCity??"").trim().toLowerCase()===(s??"").trim().toLowerCase();if(m!==we.EN_TRANSIT||!d)throw new Error("VÃ©hicule doit Ãªtre EN_TRANSIT et la destination doit Ãªtre la ville de cette agence.");if(!al(m,we.GARAGE))throw new Error("Transition opÃ©rationnelle non autorisÃ©e.");const p=fe.now(),f={field:"operationalStatus",from:m,to:we.GARAGE,changedBy:i,role:u,timestamp:p};await He(oa(a,o.vehicleId),{operationalStatus:we.GARAGE,status:ze.GARAGE,currentCity:s.trim(),destinationCity:null,statusHistory:Jt(f),updatedAt:Oe()}),await mr(a,n,r,It.ARRIVE,{arrivalConfirmedAt:p})}async function pd(a,n,r,s,i){const u=await ca(a,n);if(!u)throw new Error("VÃ©hicule introuvable");const o=u.technicalStatus??xe.NORMAL;if(!tl(o,r))throw new Error(`Transition technique non autorisÃ©e : ${o} â†’ ${r}`);const c={field:"technicalStatus",from:o,to:r,changedBy:s,role:i,timestamp:fe.now()},m=r===xe.MAINTENANCE?ze.EN_MAINTENANCE:r===xe.ACCIDENTE?ze.ACCIDENTE:r===xe.HORS_SERVICE?ze.HORS_SERVICE:ze.GARAGE;await He(oa(a,n),{technicalStatus:r,status:m,...r!==xe.NORMAL?{destinationCity:null}:{},statusHistory:Jt(c),updatedAt:Oe()})}async function gd(a,n){const r=me(ur(a)),s=fe.now(),i=n.status??ze.GARAGE;let u=xe.NORMAL,o=we.GARAGE;i===ze.EN_MAINTENANCE?u=xe.MAINTENANCE:i===ze.ACCIDENTE?u=xe.ACCIDENTE:i===ze.HORS_SERVICE?u=xe.HORS_SERVICE:i===ze.EN_TRANSIT?o=we.EN_TRANSIT:i===ze.EN_SERVICE&&(o=we.AFFECTE);const c=(n.plateNumber??"").trim(),m=await el(a,n.model??""),h={...n,country:n.country??"ML",plateNumber:c||Js(n.plateNumber??""),model:m,status:i,technicalStatus:u,operationalStatus:o,statusHistory:[],isArchived:!1,createdAt:s,updatedAt:s};return await Bt(r,h),r.id}async function hd(a,n,r,s,i){const u=await ca(a,n);if(!u)throw new Error("VÃ©hicule introuvable.");u.operationalStatus??we.GARAGE;const o={updatedAt:Oe()};if(r.model!==void 0&&(o.model=await el(a,r.model)),r.technicalStatus!==void 0){const c=u.technicalStatus??xe.NORMAL;if(!tl(c,r.technicalStatus))throw new Error(`Transition technique non autorisÃ©e : ${c} â†’ ${r.technicalStatus}`);const m={field:"technicalStatus",from:c,to:r.technicalStatus,changedBy:s,role:i,timestamp:fe.now()};o.technicalStatus=r.technicalStatus,o.statusHistory=Jt(m);const h=r.technicalStatus===xe.MAINTENANCE?ze.EN_MAINTENANCE:r.technicalStatus===xe.ACCIDENTE?ze.ACCIDENTE:r.technicalStatus===xe.HORS_SERVICE?ze.HORS_SERVICE:ze.GARAGE;o.status=h,r.technicalStatus!==xe.NORMAL&&(o.destinationCity=null)}r.insuranceExpiryDate!==void 0&&(o.insuranceExpiryDate=r.insuranceExpiryDate??null),r.inspectionExpiryDate!==void 0&&(o.inspectionExpiryDate=r.inspectionExpiryDate??null),r.vignetteExpiryDate!==void 0&&(o.vignetteExpiryDate=r.vignetteExpiryDate??null),r.notes!==void 0&&(o.notes=r.notes??null),await He(oa(a,n),o)}async function fd(a,n,r,s){const i=await ca(a,n);if(!i)throw new Error("VÃ©hicule introuvable.");if(i.isArchived===!0)throw new Error("Ce vÃ©hicule est dÃ©jÃ  archivÃ©.");if((i.operationalStatus??we.GARAGE)!==we.GARAGE)throw new Error("Impossible d'archiver : le vÃ©hicule n'est pas au garage.");if(await dr(a,n))throw new Error("Impossible d'archiver : ce vÃ©hicule a une affectation active.");const c=fe.now(),m={field:"archived",from:!1,to:!0,changedBy:r,role:s,timestamp:c};await He(oa(a,n),{isArchived:!0,archivedAt:Oe(),archivedBy:r,statusHistory:Jt(m),updatedAt:Oe()})}const yd=5e4,bd=1e5,Qr=2,xd=l.memo(function({companyId:n,navigate:r,data:s}){const{globalRevenue:i,pendingRevenue:u,financialPosition:o,revenueVariationPercent:c,healthStatus:m,prioritizedRisks:h,top3Agencies:d}=s;return t(Ae,{children:[t("section",{className:"bg-white rounded-xl border border-slate-200 p-3 sm:p-4 md:p-5 shadow-sm overflow-hidden","aria-label":"Ã‰tat global",children:[e("h2",{className:"text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4",children:"1. Ã‰tat global"}),t("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2 sm:gap-3 md:gap-4 mb-4",children:[t("div",{className:"p-2 sm:p-3 rounded-lg bg-indigo-50 border border-indigo-100 min-w-0",children:[e("div",{className:"text-xs sm:text-sm text-indigo-700",children:"CA pÃ©riode actuelle"}),e("div",{className:"text-lg sm:text-xl font-bold text-indigo-800 truncate",children:i.toLocaleString("fr-FR")})]}),t("div",{className:"p-2 sm:p-3 rounded-lg bg-emerald-50 border border-emerald-100 min-w-0",children:[e("div",{className:"text-xs sm:text-sm text-emerald-700",children:"LiquiditÃ©s disponibles"}),e("div",{className:"text-lg sm:text-xl font-bold text-emerald-800 truncate",children:o.netPosition.toLocaleString("fr-FR")})]}),t("div",{className:"p-2 sm:p-3 rounded-lg bg-violet-50 border border-violet-100 min-w-0",children:[e("div",{className:"text-xs sm:text-sm text-violet-700",children:"Variation vs pÃ©riode prÃ©c."}),t("div",{className:`text-lg sm:text-xl font-bold truncate ${c>=0?"text-emerald-700":"text-rose-700"}`,children:[c>=0?"+":"",c.toFixed(1),"%"]})]}),t("div",{className:"p-2 sm:p-3 rounded-lg bg-slate-50 border border-slate-200 min-w-0",children:[e("div",{className:"text-xs sm:text-sm text-slate-700",children:"SantÃ©"}),e("div",{className:"text-lg sm:text-xl font-bold text-slate-800 truncate",children:m==="critical"?"Critique":m==="attention"?"Attention":"Stable"})]}),e("div",{className:"p-2 sm:p-3 rounded-lg border flex items-center justify-center min-w-0",children:t("span",{className:"text-base sm:text-lg font-semibold truncate",children:[m==="critical"&&e("span",{className:"text-red-600",children:"ðŸ”´ Critique"}),m==="attention"&&e("span",{className:"text-amber-600",children:"ðŸŸ¡ Attention"}),m==="stable"&&e("span",{className:"text-emerald-600",children:"ðŸŸ¢ Stable"})]})})]})]}),t("section",{className:"bg-white rounded-xl border border-slate-200 p-3 sm:p-4 md:p-5 shadow-sm overflow-hidden","aria-label":"Risques prioritaires",children:[e("h2",{className:"text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4",children:"2. Risques prioritaires"}),h.length===0?e("p",{className:"text-sm text-slate-500",children:"Aucun risque prioritaire."}):e("ul",{className:"space-y-2",children:h.map(p=>t("li",{className:"flex flex-wrap items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg bg-slate-50 border border-slate-100 min-w-0",children:[e("span",{className:`inline-flex px-2 py-0.5 rounded text-xs font-medium ${p.level==="critical"?"bg-red-100 text-red-800":"bg-amber-100 text-amber-800"}`,children:p.level==="critical"?"Critique":"Attention"}),e("span",{className:"text-sm text-slate-700",children:p.label}),e(on,{to:`/compagnie/${n}/${p.actionRoute}`,className:"text-sm font-medium text-indigo-600 hover:text-indigo-800",children:"Corriger â†’"})]},p.id))})]}),t("section",{className:"bg-white rounded-xl border border-slate-200 p-3 sm:p-4 md:p-5 shadow-sm overflow-hidden","aria-label":"Performance rÃ©seau",children:[e("h2",{className:"text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4",children:"7. Performance rÃ©seau"}),t("div",{children:[e("h3",{className:"text-sm font-medium text-slate-600 mb-2",children:"Top 3 agences (CA)"}),t("ul",{className:"space-y-1 text-sm",children:[d.map(p=>t("li",{className:"flex justify-between",children:[e("span",{children:p.nom}),e("span",{className:"font-medium",children:p.revenue.toLocaleString("fr-FR")})]},p.agencyId)),d.length===0&&e("li",{className:"text-slate-500",children:"â€”"})]})]})]}),t("section",{className:"bg-white rounded-xl border border-slate-200 p-3 sm:p-4 md:p-5 shadow-sm overflow-hidden","aria-label":"Actions rapides",children:[e("h2",{className:"text-base sm:text-lg font-semibold text-slate-800 mb-3 sm:mb-4",children:"8. Actions rapides"}),t("div",{className:"flex flex-wrap gap-2 sm:gap-3",children:[e("button",{type:"button",onClick:()=>r(`/compagnie/${n}/fleet`),className:"px-4 py-2 rounded-lg bg-indigo-100 text-indigo-800 font-medium text-sm hover:bg-indigo-200 transition",children:"Voir la flotte"}),e("button",{type:"button",onClick:()=>r(`/compagnie/${n}/operations-reseau`),className:"px-4 py-2 rounded-lg bg-amber-100 text-amber-800 font-medium text-sm hover:bg-amber-200 transition",children:"Voir sessions ouvertes"}),e("button",{type:"button",onClick:()=>r(`/compagnie/${n}/dashboard`),className:"px-4 py-2 rounded-lg bg-rose-100 text-rose-800 font-medium text-sm hover:bg-rose-200 transition",children:"Voir agences Ã  risque"}),e("button",{type:"button",onClick:()=>window.print(),className:"px-4 py-2 rounded-lg bg-slate-100 text-slate-800 font-medium text-sm hover:bg-slate-200 transition",children:"Export synthÃ¨se direction"})]})]})]})}),vd=yt(new Date,"yyyy-MM-dd"),Nd="shiftReports";function wd(a){return(Number(a.fuelCost)||0)+(Number(a.driverCost)||0)+(Number(a.assistantCost)||0)+(Number(a.tollCost)||0)+(Number(a.maintenanceCost)||0)+(Number(a.otherOperationalCost)||0)}function Cd(){const{user:a}=Pe(),{companyId:n}=De(),r=n??(a==null?void 0:a.companyId)??"",s=Be(),{setHeader:i,resetHeader:u}=ut(),[o,c]=l.useState([]),[m,h]=l.useState([]),[d,p]=l.useState({total:0,enService:0,enTransit:0,maintenance:0,accidente:0,horsService:0,garage:0}),[f,x]=l.useState([]),[b,P]=l.useState(!0),[C,j]=l.useState([]),[L,M]=l.useState([]),[_,F]=l.useState(0),[D,k]=l.useState([]),[S,O]=l.useState(_t),[I,$]=l.useState([]),[R,w]=l.useState([]),[N,g]=l.useState("month"),[v,U]=l.useState(""),[E,B]=l.useState(""),V=Je.useMemo(()=>{const X=qa(N,new Date,v||void 0,E||void 0);return{startStr:yt(X.start,"yyyy-MM-dd"),endStr:yt(X.end,"yyyy-MM-dd")}},[N,v,E]),K=l.useRef(0);l.useEffect(()=>(i({title:"Centre de commande"}),()=>u()),[i,u]),l.useEffect(()=>{if(!r)return;let X=!1;return(async()=>{const Ee=await ee(Q(G,"companies",r,"agences"));if(X)return;const Ne=Ee.docs.map(Ue=>({id:Ue.id,nom:Ue.data().nom??Ue.id})),ie=await Promise.all(Ne.map(Ue=>ee(ce(Q(G,"companies",r,"agences",Ue.id,"shifts"),ne("status","!=","validated"),Re(500))))),Ie=await Promise.all(Ne.map(Ue=>ee(ce(Q(G,"companies",r,"agences",Ue.id,"reservations"),Re(2e3)))));if(X)return;const Me=new Set;ie.forEach(Ue=>Ue.docs.forEach(at=>Me.add(at.id)));let Ke=0;Ie.forEach(Ue=>{Ue.docs.forEach(at=>{const Ge=at.data(),qe=Ge.shiftId??Ge.createdInSessionId;pn(Ge.statut)==="paye"&&qe&&Me.has(qe)&&(Ke+=Number(Ge.montant)||0)})}),X||F(Ke)})(),()=>{X=!0}},[r]),l.useEffect(()=>{if(!r){P(!1);return}const X=++K.current,{startStr:ge,endStr:Ee}=V;(async()=>{P(!0);const ie=Q(G,"companies",r,"agences"),Ie=ce(Dt(G,"dailyStats"),ne("companyId","==",r),ne("date",">=",ge),ne("date","<=",Ee),Re(2e3)),Me=ce(Dt(G,"agencyLiveState"),ne("companyId","==",r),Re(200)),Ke=ce(Dt(G,"expenses"),ne("companyId","==",r),Re(500)),Ue=Q(G,"companies",r,or),at=ce(Ue,ne("date",">=",ge),ne("date","<=",Ee),Re(1e3)),Ge=ce(Dt(G,Nd),ne("companyId","==",r),ne("status","==","validated"),Re(500));let qe=[],pt=[],Nt=[],Gt=[],Pt=[],Et=_t;const Y=[],oe=new Map;try{const[We,Z,ue,ve,be,Ze,$e]=await Promise.all([ee(ie),ee(Ie),ee(Me),ee(Ke),ee(at),Jr(r),ee(Ge)]);if(K.current!==X)return;qe=We.docs.map(_e=>{const Ye=_e.data();return{id:_e.id,nom:Ye.nom??_e.id,nomAgence:Ye.nomAgence}}),pt=Z.docs.map(_e=>({..._e.data(),agencyId:_e.data().agencyId})),Nt=ue.docs.map(_e=>_e.data()),Gt=ve.docs.map(_e=>_e.data()),Pt=be.docs.map(_e=>_e.data()),Et=Ze,$e.docs.forEach(_e=>{const Ye=_e.data();Y.push({...Ye,agencyId:Ye.agencyId??""})});const Xe=await Promise.all(qe.map(_e=>ee(ce(Q(G,"companies",r,"agences",_e.id,"shifts"),ne("status","!=","validated"),Re(500))))),ke=await Promise.all(qe.map(_e=>ee(ce(Q(G,"companies",r,"agences",_e.id,"reservations"),Re(2e3)))));if(K.current!==X)return;const Qt=new Set;Xe.forEach(_e=>_e.docs.forEach(Ye=>Qt.add(Ye.id)));const it=new Map;ke.forEach((_e,Ye)=>{const zt=qe[Ye].id;_e.docs.forEach(bt=>it.set(`${zt}/${bt.id}`,bt.data()))}),it.forEach(_e=>{const Ye=_e.trajetId??"_unknown",zt=Number(_e.montant)||0,bt=_e.date??"";bt>=ge&&bt<=Ee&&oe.set(Ye,(oe.get(Ye)??0)+zt)})}catch{qe=(await ee(ie)).docs.slice(0,50).map(ve=>{const be=ve.data();return{id:ve.id,nom:be.nom??ve.id,nomAgence:be.nomAgence}});const[Z,ue]=await Promise.all([Promise.all(qe.map(async ve=>{const be=await Se(me(G,`companies/${r}/agences/${ve.id}/dailyStats/${vd}`));return be.exists()?{...be.data(),agencyId:ve.id}:null})),Promise.all(qe.map(async ve=>{const be=await Se(me(G,`companies/${r}/agences/${ve.id}/agencyLiveState/current`));return be.exists()?{...be.data(),agencyId:ve.id}:null}))]);pt=Z.filter(ve=>ve!=null),Nt=ue.filter(ve=>ve!=null);try{Et=await Jr(r)}catch{}try{Pt=(await ee(at)).docs.map(be=>be.data())}catch{Pt=[]}try{Gt=(await ee(Ke)).docs.map(be=>be.data())}catch{Gt=[]}}let Ce=[],Te=[];try{const[We,Z]=await Promise.all([Zc(r),td(r,{limitCount:300})]);if(K.current!==X)return;Ce=We.map(ue=>({id:ue.id,agencyId:ue.agencyId,accountType:ue.accountType,currentBalance:ue.currentBalance})),Te=Z.map(ue=>({id:ue.id,agencyId:ue.agencyId,remainingAmount:ue.remainingAmount,status:ue.status}))}catch{}if(K.current===X){x(qe),c(pt),h(Nt),j(Gt),M(Y),k(Pt),O(Et),$(Ce),w(Te);try{const We=await sl(r);if(K.current!==X)return;const Z=We.length,ue=We.filter(ke=>(ke.operationalStatus??we.GARAGE)===we.GARAGE&&(ke.technicalStatus??xe.NORMAL)===xe.NORMAL).length,ve=We.filter(ke=>(ke.operationalStatus??we.GARAGE)===we.EN_TRANSIT).length,be=We.filter(ke=>(ke.technicalStatus??xe.NORMAL)===xe.MAINTENANCE).length,Ze=We.filter(ke=>(ke.technicalStatus??xe.NORMAL)===xe.ACCIDENTE).length,$e=We.filter(ke=>(ke.technicalStatus??xe.NORMAL)===xe.HORS_SERVICE).length,Xe=We.filter(ke=>(ke.operationalStatus??we.GARAGE)===we.GARAGE).length;p({total:Z,garage:Xe,enService:ue,enTransit:ve,maintenance:be,accidente:Ze,horsService:$e})}catch{p(We=>We)}P(!1)}})()},[r,V.startStr,V.endStr]);const z=l.useMemo(()=>{const X=new Map(f.map(ge=>[ge.id,ge.nomAgence??ge.nom]));return ge=>X.get(ge)??ge},[f]),T=l.useMemo(()=>o.reduce((X,ge)=>X+(Number(ge.totalRevenue)||0),0),[o]),W=l.useMemo(()=>{const X=[],ge=new Set(o.map(Ne=>Ne.agencyId).filter(Boolean)),Ee=f.filter(Ne=>!ge.has(Ne.id));return f.length>0&&Ee.length===f.length?X.push({type:"activity",message:"Aucune activitÃ© enregistrÃ©e aujourd'hui",level:"info"}):Ee.length>0&&Ee.length<=5&&X.push({type:"activity",message:`Agences sans activitÃ© aujourd'hui : ${Ee.map(Ne=>Ne.nomAgence??Ne.nom).join(", ")}`,level:"info"}),X},[o,f]),q=l.useMemo(()=>[...o].map(X=>({agencyId:X.agencyId??"",nom:z(X.agencyId??""),revenue:Number(X.totalRevenue)||0})).filter(X=>X.revenue>0).sort((X,ge)=>ge.revenue-X.revenue).slice(0,10),[o,z]),H=l.useMemo(()=>{const X=new Map;C.forEach(Ne=>{const ie=Ne.agencyId??"_company";X.set(ie,(X.get(ie)??0)+(Number(Ne.amount)||0))});const ge=new Map;L.forEach(Ne=>{var Me;const ie=Ne.agencyId??"",Ie=Number((Me=Ne.validationAudit)==null?void 0:Me.computedDifference)??0;Ie<0&&ge.set(ie,(ge.get(ie)??0)+Math.abs(Ie))});const Ee=new Map;return D.forEach(Ne=>{const ie=Ne.agencyId??"";Ee.set(ie,(Ee.get(ie)??0)+wd(Ne))}),{expensesByAgency:X,discrepancyDeductionByAgency:ge,tripCostsByAgency:Ee}},[C,L,D]),le=l.useMemo(()=>{const{expensesByAgency:X,discrepancyDeductionByAgency:ge,tripCostsByAgency:Ee}=H,Ne=new Set([...o.map(ie=>ie.agencyId).filter(Boolean),...X.keys(),...ge.keys(),...Ee.keys()]);return Array.from(Ne).map(ie=>{var Ge;const Ie=((Ge=o.find(qe=>qe.agencyId===ie))==null?void 0:Ge.totalRevenue)??0,Me=X.get(ie)??0,Ke=Ee.get(ie)??0,Ue=ge.get(ie)??0;return{...Uc({revenueFromDailyStats:Number(Ie)||0,expensesTotal:Me,tripCostsTotal:Ke,discrepancyDeduction:Ue}),agencyId:ie,nom:z(ie)}})},[o,H,z]),te=l.useMemo(()=>Wc(I.map(X=>({id:X.id,agencyId:X.agencyId,accountType:X.accountType,currentBalance:X.currentBalance})),R.map(X=>({id:X.id,agencyId:X.agencyId,remainingAmount:X.remainingAmount,status:X.status}))),[I,R]),ae=0,de=0,re=l.useMemo(()=>({accountsBelowCritical:I.filter(X=>X.currentBalance<yd&&X.currentBalance>=0).length,accountsBelowWarning:I.filter(X=>X.currentBalance<bd&&X.currentBalance>=0).length,agenciesAtRiskCount:le.filter(X=>X.revenue===0).length}),[I,le]),{accountsBelowCritical:pe,accountsBelowWarning:he,agenciesAtRiskCount:y}=re,A=l.useMemo(()=>{const X=pe>0||y>=Qr?"critical":he>0?"attention":"stable",ge=[],Ee=le.filter(Ne=>Ne.revenue===0);return Ee.length>0&&ge.push({id:"agencies-drop",label:`Agences en baisse / sans revenu (${Ee.length})`,level:Ee.length>=Qr?"critical":"warning",actionRoute:"dashboard"}),pe>0&&ge.push({id:"accounts-critical",label:`Comptes sous seuil critique (${pe})`,level:"critical",actionRoute:"revenus-liquidites"}),{healthStatus:X,prioritizedRisks:ge}},[de,pe,he,y,le]),{healthStatus:J,prioritizedRisks:se}=A,ye=l.useMemo(()=>({globalRevenue:T,pendingRevenue:_,financialPosition:te,revenueVariationPercent:ae,healthStatus:J,prioritizedRisks:se,top3Agencies:q.slice(0,3)}),[T,_,te,ae,J,se,q]);return r?b?e("div",{className:"p-6 flex items-center justify-center min-h-[200px]",children:e("div",{className:"text-gray-500",children:"Chargement du centre de commandeâ€¦"})}):t("div",{className:"min-w-0 w-full space-y-4 sm:space-y-6 p-3 sm:p-4 md:p-6 max-w-7xl mx-auto overflow-x-hidden",children:[t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4",children:[e("p",{className:"text-sm text-gray-600",children:Qn(new Date)}),e(ir,{period:N,customStart:v||void 0,customEnd:E||void 0,onPeriodChange:(X,ge,Ee)=>{g(X),U(ge??""),B(Ee??"")}})]}),e(xd,{companyId:r,navigate:s,data:ye}),t("section",{className:"bg-white rounded-xl border p-3 sm:p-4 shadow-sm","aria-label":"Network Operational Status",children:[t("h2",{className:"text-base sm:text-lg font-semibold mb-3 flex items-center gap-2",children:[e(xa,{className:"w-4 h-4 sm:w-5 sm:h-5 shrink-0"})," 3. Network Operational Status"]}),t("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 sm:gap-3",children:[t("div",{className:"p-2 sm:p-3 rounded-lg bg-gray-100 min-w-0",children:[e("div",{className:"font-bold",children:d.total}),e("div",{className:"text-xs text-gray-600",children:"Total vÃ©hicules"})]}),t("div",{className:"p-2 sm:p-3 rounded-lg bg-emerald-50 min-w-0",children:[e("div",{className:"font-bold",children:d.enService}),e("div",{className:"text-xs text-emerald-700",children:"Disponibles (Garage + Normal)"})]}),t("div",{className:"p-2 sm:p-3 rounded-lg bg-blue-50 min-w-0",children:[e("div",{className:"font-bold",children:d.enTransit}),e("div",{className:"text-xs text-blue-700",children:"En transit"})]}),t("div",{className:"p-2 sm:p-3 rounded-lg bg-orange-50 min-w-0",children:[e("div",{className:"font-bold",children:d.maintenance}),e("div",{className:"text-xs text-orange-700",children:"Maintenance"})]}),t("div",{className:"p-2 sm:p-3 rounded-lg bg-red-50 min-w-0",children:[e("div",{className:"font-bold",children:d.accidente}),e("div",{className:"text-xs text-red-700",children:"AccidentÃ©s"})]})]}),e("div",{className:"mt-3",children:e("button",{type:"button",onClick:()=>s(`/compagnie/${r}/garage/fleet`),className:"px-4 py-2 rounded-lg bg-indigo-100 text-indigo-800 font-medium text-sm hover:bg-indigo-200 transition",children:"Voir la flotte"})})]}),t("section",{className:"bg-white rounded-xl border p-3 sm:p-4 shadow-sm","aria-label":"Alertes",children:[t("h2",{className:"text-base sm:text-lg font-semibold mb-3 flex items-center gap-2",children:[e(nt,{className:"w-4 h-4 sm:w-5 sm:h-5 shrink-0"})," 4. Alertes"]}),W.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucune alerte."}):e("ul",{className:"space-y-2",children:W.slice(0,7).map((X,ge)=>t("li",{className:`flex items-center gap-2 text-xs sm:text-sm p-2 rounded break-words min-w-0 ${X.level==="error"?"bg-red-50 text-red-800":X.level==="warning"?"bg-amber-50 text-amber-800":"bg-gray-50 text-gray-700"}`,children:[e("span",{className:"w-2 h-2 rounded-full bg-current"}),X.message]},ge))})]}),t("section",{className:"bg-white rounded-xl border p-3 sm:p-4 shadow-sm","aria-label":"Position financiÃ¨re",children:[t("h2",{className:"text-base sm:text-lg font-semibold mb-3 flex items-center gap-2",children:[e(ia,{className:"w-4 h-4 sm:w-5 sm:h-5 shrink-0"})," 5. Position financiÃ¨re"]}),e("div",{className:"flex flex-wrap items-center gap-3 sm:gap-4 min-w-0",children:t("div",{className:"p-2 sm:p-3 rounded-lg bg-emerald-50 border border-emerald-200 min-w-0",children:[e("div",{className:"text-lg sm:text-xl font-bold text-emerald-800 truncate",children:te.netPosition.toLocaleString("fr-FR")}),e("div",{className:"text-xs text-emerald-700",children:"Position nette"})]})})]})]}):e("div",{className:"p-6",children:e("p",{className:"text-gray-500",children:"Compagnie introuvable."})})}const bp=Object.freeze(Object.defineProperty({__proto__:null,default:Cd},Symbol.toStringTag,{value:"Module"})),Sd=new Set(["admin_platforme","admin_compagnie","company_accountant","agency_accountant","chef_garage","chefagence","chefembarquement","guichetier","agency_fleet_controller","financial_director"]),Zr=a=>{const n=(a||"").toString().trim().toLowerCase();return n==="company_ceo"?"admin_compagnie":n==="chefagence"?"chefAgence":n==="chefembarquement"||n==="agency_boarding_officer"||n==="embarquement"?"chefEmbarquement":Sd.has(n)?n:"unauthenticated"};function Ad(){const[a,n]=l.useState(null),[r,s]=l.useState("unauthenticated"),[i,u]=l.useState(!0);return l.useEffect(()=>{const o=li(qn,async c=>{if(n(c),!c){s("unauthenticated"),u(!1);return}u(!0);const m=me(G,"users",c.uid),h=st(m,d=>{const p=Zr(d.exists()?d.data().role:void 0);s(p),u(!1)},()=>{Se(m).then(d=>{const p=Zr(d.exists()?d.data().role:void 0);s(p)}).finally(()=>u(!1))});return()=>h()});return()=>o()},[]),{user:a,role:r,loading:i}}function Ed({anyOf:a,redirectTo:n="/login",children:r,fallback:s}){const{user:i,role:u,loading:o}=Ad(),c=Xt();return o?s??e("div",{className:"min-h-[50vh] flex items-center justify-center text-slate-500",children:"Chargement des autorisationsâ€¦"}):i?a.includes(u)?e(Ae,{children:r}):e("div",{className:"min-h-screen flex items-center justify-center bg-slate-50",children:t("div",{className:"bg-white border border-slate-200 rounded-2xl shadow p-8 max-w-md text-center",children:[e("h1",{className:"text-xl font-semibold text-slate-900",children:"AccÃ¨s non autorisÃ©"}),t("p",{className:"mt-2 text-slate-600",children:["Ton rÃ´le ",e("span",{className:"font-mono",children:String(u)})," nâ€™a pas accÃ¨s Ã  cette page."]}),e("a",{href:"/",className:"mt-6 inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700",children:"Retour Ã  lâ€™accueil"})]})}):e(Ni,{to:n,replace:!0,state:{from:c}})}const ll="paymentProposals",kd=7,Id=a=>Q(G,"companies",a,ll);function gr(a,n){return me(G,"companies",a,ll,n)}async function Rd(a,n){const r=gr(a,n);await He(r,{approvalStatus:"expired"})}async function _d(a,n){var c,m,h,d;const r=ce(Id(a),ne("approvalStatus","==","pending"),ot("proposedAt","desc"),Re(n==null?void 0:n.limitCount)),s=await ee(r),i=Date.now(),u=kd*24*60*60*1e3,o=[];for(const p of s.docs){const f=p.data(),x=((m=(c=f.proposedAt)==null?void 0:c.toMillis)==null?void 0:m.call(c))??0,b=((d=(h=f.expiresAt)==null?void 0:h.toMillis)==null?void 0:d.call(h))??x+u;if(i>b){try{await Rd(a,p.id)}catch{}continue}o.push({id:p.id,...f})}return o}const Td="current",ua={paymentApprovalThreshold:1e6,requireCeoForPayablesAbove:5e6,requireCeoForBankTransfer:!0,maintenanceApprovalThreshold:5e5,fuelExpenseAnomalyLimit:2e5,createdAt:{},updatedAt:{}},Pd="financialSettings";function Dd(a){return me(G,"companies",a,Pd,Td)}async function Md(a){const n=await Se(Dd(a));if(!n.exists())return{...ua};const r=n.data();return{paymentApprovalThreshold:Number(r.paymentApprovalThreshold??ua.paymentApprovalThreshold),requireCeoForPayablesAbove:Number(r.requireCeoForPayablesAbove??ua.requireCeoForPayablesAbove),requireCeoForBankTransfer:r.requireCeoForBankTransfer??ua.requireCeoForBankTransfer,maintenanceApprovalThreshold:Number(r.maintenanceApprovalThreshold??ua.maintenanceApprovalThreshold??5e5),fuelExpenseAnomalyLimit:Number(r.fuelExpenseAnomalyLimit??ua.fuelExpenseAnomalyLimit??2e5),createdAt:r.createdAt??fe.now(),updatedAt:r.updatedAt??fe.now()}}const $d="financialMovements";function Ld(a){return Q(G,`companies/${a}/${$d}`)}function jd(a,n){return`${a}_${n}`}const Fd="financialMovementIdempotency";function Od(a,n){return me(G,`companies/${a}/${Fd}/${n}`)}async function qd(a,n,r){const s=Od(n,r);if((await a.get(s)).exists())throw new Error("Un mouvement existe dÃ©jÃ  pour cette rÃ©fÃ©rence (idempotence).");a.set(s,{createdAt:fe.now()})}async function il(a,n){const r=Number(n.amount);if(r<=0)return"";const s=jd(n.referenceType,n.referenceId);await qd(a,n.companyId,s);const i=n.fromAccountId?la(n.companyId,n.fromAccountId):null,u=n.toAccountId?la(n.companyId,n.toAccountId):null;if(i){const d=await a.get(i);if(!d.exists())throw new Error("Compte source introuvable.");if(Number(d.data().currentBalance??0)<r)throw new Error("Solde insuffisant sur le compte source.")}const o=n.performedAt??fe.now(),c=n.entryType??(n.toAccountId!=null?"credit":"debit"),m="pending";i&&a.update(i,{currentBalance:Ar(-r),updatedAt:Oe()}),u&&a.update(u,{currentBalance:Ar(r),updatedAt:Oe()});const h=me(Ld(n.companyId));return a.set(h,{companyId:n.companyId,fromAccountId:n.fromAccountId??null,toAccountId:n.toAccountId??null,amount:r,currency:n.currency,movementType:n.movementType,referenceType:n.referenceType,referenceId:n.referenceId,uniqueReferenceKey:s,agencyId:n.agencyId,performedBy:n.performedBy,performedAt:o,notes:n.notes??null,entryType:c,reconciliationStatus:m,externalReferenceId:n.externalReferenceId??null,settlementDate:n.settlementDate??null,performedByRole:n.performedByRole??null,approvedBy:n.approvedBy??null,approvedByRole:n.approvedByRole??null}),h.id}async function xp(a){Number(a.amount)<=0||await Hn(G,async r=>{await il(r,a)})}const Ud="payable_payment";function Bd(a,n){return n<=0?"pending":n>=a?"paid":"partially_paid"}async function Gd(a){const n=a.approvedByRole??"admin_compagnie";await Hn(G,async r=>{var _,F;const s=gr(a.companyId,a.proposalId),i=await r.get(s);if(!i.exists())throw new Error("Proposition de paiement introuvable.");const u=i.data();if(u.approvalStatus!=="pending")throw new Error("Cette proposition a dÃ©jÃ  Ã©tÃ© traitÃ©e.");const o=fe.now(),c=(F=(_=u.expiresAt)==null?void 0:_.toMillis)==null?void 0:F.call(_);if(c!=null&&o.toMillis()>c)throw new Error("Proposal expired");const m=Number(u.amount),h=Ks(a.companyId,u.payableId),d=await r.get(h);if(!d.exists())throw new Error("Compte Ã  payer introuvable.");const p=d.data();if(Number(p.remainingAmount??0)<m)throw new Error("Solde restant insuffisant sur le compte Ã  payer.");const f=la(a.companyId,u.fromAccountId),x=await r.get(f);if(!x.exists())throw new Error("Compte source introuvable.");if(Number(x.data().currentBalance??0)<m)throw new Error("Solde insuffisant sur le compte source.");const P=`${u.payableId}_ceo_${a.proposalId}`,C=await il(r,{companyId:a.companyId,fromAccountId:u.fromAccountId,toAccountId:null,amount:m,currency:u.currency,movementType:"payable_payment",referenceType:Ud,referenceId:P,agencyId:u.agencyId,performedBy:a.approvedBy,performedByRole:"admin_compagnie",notes:`Paiement approuvÃ© CEO: ${p.supplierName} - ${p.description}`.slice(0,200)}),j=Number(p.amountPaid??0)+m,L=Number(p.totalAmount??0);r.update(h,{amountPaid:j,remainingAmount:L-j,status:Bd(L,j),lastPaymentAt:o,updatedAt:Oe()});const M=Array.isArray(u.approvalHistory)?[...u.approvalHistory]:[];M.push({action:"approved",by:a.approvedBy,role:n,timestamp:o}),r.update(s,{approvalStatus:"approved",approvedBy:a.approvedBy,approvedAt:Oe(),approvedByRole:n,executedMovementId:C,approvalHistory:M})})}async function zd(a){const n=gr(a.companyId,a.proposalId),r=await Se(n);if(!r.exists())throw new Error("Proposition de paiement introuvable.");const s=r.data();if(s.approvalStatus!=="pending")throw new Error("Cette proposition a dÃ©jÃ  Ã©tÃ© traitÃ©e.");const i=Array.isArray(s.approvalHistory)?[...s.approvalHistory]:[],u=a.approvedByRole??"admin_compagnie";i.push({action:"rejected",by:a.approvedBy,role:u,timestamp:fe.now()}),await He(n,{approvalStatus:"rejected",approvedBy:a.approvedBy,approvedAt:Oe(),approvedByRole:u,rejectionReason:a.rejectionReason??null,approvalHistory:i})}function Vd(){const{user:a}=Pe(),{companyId:n}=De(),r=n??(a==null?void 0:a.companyId)??"",{setHeader:s,resetHeader:i}=ut(),[u,o]=l.useState([]),[c,m]=l.useState(!0),[h,d]=l.useState(null),[p,f]=l.useState(null),[x,b]=l.useState({}),P=l.useCallback(async()=>{var L,M;if(!r){m(!1);return}m(!0),f(null);try{const[_,F]=await Promise.all([_d(r,{limitCount:200}),Md(r)]),D=F.paymentApprovalThreshold,k=Date.now(),S=24*60*60*1e3,O=new Map;for(const R of _)if(!O.has(R.payableId)){const w=await Se(Ks(r,R.payableId));O.set(R.payableId,w.exists()?w.data():{})}const I=new Map;for(const R of _){const w=((M=(L=R.proposedAt)==null?void 0:L.toMillis)==null?void 0:M.call(L))??0;if(k-w<=S){const N=Number(R.amount)??0;I.set(R.payableId,(I.get(R.payableId)??0)+N)}}const $=_.map(R=>{const w=O.get(R.payableId),N=(w==null?void 0:w.supplierName)??"â€”",g=I.get(R.payableId)??Number(R.amount),U=(Number(R.amount)??0)>D||g>D?"Threshold exceeded":"Normal";return{id:R.id,proposal:{...R,id:R.id},supplierName:N,cumulativeAmountLast24h:g,threshold:D,statusIndicator:U}});o($)}catch(_){f(_ instanceof Error?_.message:"Erreur lors du chargement."),o([])}finally{m(!1)}},[r]);l.useEffect(()=>(s({title:"Approbations de paiement"}),()=>i()),[s,i]),l.useEffect(()=>{P()},[P]);const C=async L=>{if(!(!r||!(a!=null&&a.uid))){d(L),f(null);try{await Gd({companyId:r,proposalId:L,approvedBy:a.uid,approvedByRole:a.role??"admin_compagnie"}),await P()}catch(M){f(M instanceof Error?M.message:"Impossible d'approuver.")}finally{d(null)}}},j=async L=>{if(!(!r||!(a!=null&&a.uid))){d(L),f(null);try{await zd({companyId:r,proposalId:L,approvedBy:a.uid,approvedByRole:a.role??"admin_compagnie",rejectionReason:x[L]||null}),b(M=>{const _={...M};return delete _[L],_}),await P()}catch(M){f(M instanceof Error?M.message:"Impossible de rejeter.")}finally{d(null)}}};return r?t("div",{className:"p-4 max-w-6xl mx-auto",children:[e("div",{className:"mb-4 flex items-center gap-2",children:t(on,{to:`/compagnie/${r}/command-center`,className:"inline-flex items-center gap-1 text-sm text-indigo-600 hover:text-indigo-800",children:[e(Es,{className:"w-4 h-4"})," Retour au centre de commande"]})}),p&&e("div",{className:"mb-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm",children:p}),c?e("div",{className:"flex items-center justify-center py-12",children:e(Ft,{className:"w-8 h-8 animate-spin text-slate-400"})}):u.length===0?e("div",{className:"rounded-xl border border-slate-200 bg-slate-50 p-8 text-center text-slate-600",children:"Aucune demande de paiement en attente d'approbation."}):e("div",{className:"rounded-xl border border-slate-200 bg-white overflow-hidden",children:e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full text-sm",children:[e("thead",{children:t("tr",{className:"border-b bg-slate-50 text-left",children:[e("th",{className:"p-3 font-medium text-slate-700",children:"Fournisseur"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Agence"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Montant"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Devise"}),e("th",{className:"p-3 font-medium text-slate-700",children:"ProposÃ© par"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Date"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Payable ID"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Cumul 24h"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Seuil"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Indicateur"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Actions"})]})}),e("tbody",{children:u.map(L=>{var D,k;const M=L.proposal,_=(k=(D=M.proposedAt)==null?void 0:D.toMillis)==null?void 0:k.call(D),F=h===L.id;return t("tr",{className:"border-b hover:bg-slate-50/50",children:[e("td",{className:"p-3",children:L.supplierName}),e("td",{className:"p-3 font-mono text-xs",children:M.agencyId}),e("td",{className:"p-3 font-medium",children:Number(M.amount).toLocaleString("fr-FR")}),e("td",{className:"p-3",children:M.currency}),e("td",{className:"p-3",children:M.proposedBy}),e("td",{className:"p-3",children:_?yt(_,"dd MMM yyyy HH:mm",{locale:Yt}):"â€”"}),e("td",{className:"p-3 font-mono text-xs truncate max-w-[120px]",title:M.payableId,children:M.payableId}),e("td",{className:"p-3",children:L.cumulativeAmountLast24h.toLocaleString("fr-FR")}),e("td",{className:"p-3",children:L.threshold.toLocaleString("fr-FR")}),e("td",{className:"p-3",children:t("span",{className:L.statusIndicator==="Threshold exceeded"?"text-amber-700 font-medium flex items-center gap-1":"text-slate-600",children:[L.statusIndicator==="Threshold exceeded"&&e(Cs,{className:"w-4 h-4 inline"}),L.statusIndicator]})}),e("td",{className:"p-3",children:t("div",{className:"flex items-center gap-2",children:[t("button",{type:"button",onClick:()=>C(L.id),disabled:F,className:"inline-flex items-center gap-1 px-2 py-1 rounded bg-emerald-600 text-white text-xs font-medium hover:bg-emerald-700 disabled:opacity-50",children:[F?e(Ft,{className:"w-3 h-3 animate-spin"}):e(nr,{className:"w-3 h-3"}),"Approuver"]}),t("div",{className:"flex flex-col gap-1",children:[e("input",{type:"text",placeholder:"Motif rejet (optionnel)",value:x[L.id]??"",onChange:S=>b(O=>({...O,[L.id]:S.target.value})),className:"border border-slate-200 rounded px-2 py-1 text-xs w-32"}),t("button",{type:"button",onClick:()=>j(L.id),disabled:F,className:"inline-flex items-center gap-1 px-2 py-1 rounded bg-red-600 text-white text-xs font-medium hover:bg-red-700 disabled:opacity-50",children:[F?e(Ft,{className:"w-3 h-3 animate-spin"}):e(cn,{className:"w-3 h-3"}),"Rejeter"]})]})]})})]},L.id)})})]})})})]}):e("div",{className:"p-4 text-slate-600",children:"Aucune compagnie sÃ©lectionnÃ©e."})}function Hd(){return e(Ed,{anyOf:["admin_compagnie","admin_platforme"],children:e(Vd,{})})}const vp=Object.freeze(Object.defineProperty({__proto__:null,default:Hd},Symbol.toStringTag,{value:"Module"})),ol=["view_global_dashboard","view_agency_dashboard","manage_treasury","manage_multi_bank","validate_sessions","manage_company_finances","manage_agency_finances","manage_global_fleet","manage_agency_fleet","view_profit_analysis","manage_roles","access_enterprise_features","manage_reservations","manage_guichet","manage_boarding","manage_personnel","manage_company_settings","view_company_stats","view_agency_stats","manage_agency_trajets","view_anomaly_engine","view_predictive_insights","use_simulation_engine","manage_logistics"],Yd={admin_platforme:ol,admin_compagnie:["view_global_dashboard","manage_company_finances","manage_global_fleet","manage_roles","manage_treasury","manage_multi_bank","validate_sessions","view_profit_analysis","view_anomaly_engine","view_predictive_insights","use_simulation_engine","manage_reservations","manage_personnel","manage_company_settings","view_company_stats","access_enterprise_features","manage_logistics"],financial_director:["view_global_dashboard","manage_company_finances","manage_treasury","manage_multi_bank","validate_sessions","view_profit_analysis","view_anomaly_engine","view_predictive_insights","use_simulation_engine","view_company_stats"],company_accountant:["manage_company_finances","manage_treasury","validate_sessions","view_company_stats"],chef_garage:["manage_global_fleet","view_company_stats"],chefAgence:["view_agency_dashboard","manage_agency_finances","manage_agency_fleet","manage_reservations","manage_guichet","manage_boarding","manage_personnel","manage_agency_trajets","view_agency_stats","manage_logistics"],superviseur:["view_agency_dashboard","manage_agency_finances","manage_reservations","manage_guichet","manage_boarding","manage_agency_fleet","manage_personnel","view_agency_stats"],agentCourrier:["view_agency_dashboard","manage_reservations","manage_logistics"],agency_accountant:["manage_agency_finances","view_agency_stats"],guichetier:["manage_guichet","manage_reservations"],chefEmbarquement:["manage_boarding","manage_reservations"],agency_fleet_controller:["manage_agency_fleet"],unauthenticated:[],user:[]};function Kd(a){return Yd[a]??[]}const cl=["view_agency_dashboard","manage_agency_finances","manage_reservations","manage_guichet","manage_boarding","manage_agency_fleet","manage_personnel","manage_agency_trajets","view_agency_stats"],dl=[...cl,"manage_treasury","manage_multi_bank","view_global_dashboard","manage_company_finances","validate_sessions","manage_global_fleet","manage_roles","manage_company_settings","view_company_stats","view_profit_analysis","view_anomaly_engine"],Wd=[...dl,"view_predictive_insights","use_simulation_engine","access_enterprise_features"],Jd={starter:cl,growth:dl,enterprise:Wd};function Xd(a){return Jd[a]??[]}const Qd=new Set(["admin_platforme"]);function Zd(a,n){if(Qd.has(a))return new Set(ol);const r=Kd(a),s=Xd(n),i=new Set(s);return new Set(r.filter(u=>i.has(u)))}const Aa="starter",em=new Set,tm=5*60*1e3;let Ra=null;function am(a){return!Ra||Ra.companyId!==a||Date.now()-Ra.fetchedAt>tm?null:Ra.plan}function nm(a,n){Ra={companyId:a,plan:n,fetchedAt:Date.now()}}function rm(){const{user:a,loading:n}=Pe(),[r,s]=l.useState(Aa),[i,u]=l.useState(!1),o=(a==null?void 0:a.companyId)??"",c=(a==null?void 0:a.role)??"unauthenticated";l.useEffect(()=>{if(!o){s(Aa);return}const f=am(o);if(f!=null){s(f),u(!1);return}let x=!1;return u(!0),(async()=>{try{const P=me(G,"companies",o,"subscription","current"),C=await Se(P),j=C.exists()?C.data().plan??Aa:Aa;x||(s(j),nm(o,j))}catch(P){console.warn("[useCapabilities] Failed to fetch subscription:",P),x||s(Aa)}finally{x||u(!1)}})(),()=>{x=!0}},[o]);const m=l.useMemo(()=>n||i||!a?em:Zd(c,r),[c,r,n,i,a]),h=l.useCallback(f=>m.has(f),[m]),d=l.useCallback(f=>f.every(x=>m.has(x)),[m]),p=l.useCallback(f=>f.some(x=>m.has(x)),[m]);return{hasCapability:h,hasAll:d,hasAny:p,capabilities:m,plan:r,loading:n||i}}const sm=({message:a,capability:n})=>{const r=Be();return e("div",{className:"min-h-[60vh] flex items-center justify-center p-6",children:t("div",{className:"text-center max-w-md",children:[e(Fi,{className:"mx-auto h-14 w-14 text-orange-500 mb-4"}),e("h1",{className:"text-xl font-bold text-gray-900 mb-2",children:"AccÃ¨s non autorisÃ©"}),e("p",{className:"text-gray-600 mb-1",children:a??"Votre rÃ´le ou votre plan d'abonnement ne permet pas d'accÃ©der Ã  cette fonctionnalitÃ©."}),n&&t("p",{className:"text-xs text-gray-400 mb-4 font-mono",children:["CapacitÃ© requise : ",n]}),t("div",{className:"flex justify-center gap-3 mt-6",children:[e("button",{type:"button",onClick:()=>r(-1),className:"px-4 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-50 transition",children:"Retour"}),e("button",{type:"button",onClick:()=>r("/"),className:"px-4 py-2 text-sm rounded-lg bg-orange-600 text-white hover:bg-orange-700 transition",children:"Accueil"})]})]})})},lm="shiftReports";function Ea(a){return yt(a,"yyyy-MM-dd")}function ml(){const{user:a}=Pe(),{companyId:n}=De(),r=n??(a==null?void 0:a.companyId)??"",{setHeader:s,resetHeader:i}=ut(),{hasCapability:u,loading:o}=rm(),[c,m]=l.useState([]),[h,d]=l.useState([]),[p,f]=l.useState([]),[x,b]=l.useState(""),[P,C]=l.useState(!0);l.useEffect(()=>(s({title:"Finances compagnie"}),()=>i()),[s,i]),l.useEffect(()=>{if(!r){C(!1);return}const S=Ea(new Date);Ea(Ba(new Date,6));const O=Ea(Ba(new Date,29));(async()=>{C(!0);try{const $=(await ee(Q(G,"companies",r,"agences"))).docs.map(g=>({id:g.id,nom:g.data().nom??g.id}));f($);const R=ce(Dt(G,"dailyStats"),ne("companyId","==",r),ne("date",">=",O),ne("date","<=",S),Re(500)),w=await ee(R);m(w.docs.map(g=>g.data()));const N=[];for(const g of $.slice(0,30)){const v=Q(G,"companies",r,"agences",g.id,lm),U=ce(v,ne("status","==","validated"),Re(20));try{(await ee(U)).docs.forEach(B=>{var z;const V=B.data();(((z=V.validationAudit)==null?void 0:z.computedDifference)??0)!==0&&N.push({...V,agencyId:g.id})})}catch{const E=ce(v,ne("status","==","validated"),Re(20));(await ee(E)).docs.forEach(V=>{var T;const K=V.data();(((T=K.validationAudit)==null?void 0:T.computedDifference)??0)!==0&&N.push({...K,agencyId:g.id})})}}d(N)}catch(I){console.error("CompanyFinances load:",I)}finally{C(!1)}})()},[r]);const j=l.useMemo(()=>new Map(p.map(S=>[S.id,S.nom])),[p]),L=l.useMemo(()=>{const S=Ea(new Date);return c.filter(O=>O.date===S).reduce((O,I)=>O+(Number(I.totalRevenue)||0),0)},[c]),M=l.useMemo(()=>{const S=new Date,O=Ba(S,6);return c.filter(I=>{if(!I.date)return!1;const $=new Date(I.date);return $>=ms(O)&&$<=us(S)}).reduce((I,$)=>I+(Number($.totalRevenue)||0),0)},[c]),_=l.useMemo(()=>c.reduce((S,O)=>S+(Number(O.totalRevenue)||0),0),[c]),F=l.useMemo(()=>{const S=Ea(new Date),O=new Map;return c.forEach(I=>{const $=I.agencyId??"";if(!$)return;const R=O.get($)??{today:0,week:0,month:0},w=Number(I.totalRevenue)||0;R.month+=w,I.date===S&&(R.today+=w);const N=I.date?new Date(I.date):null;N&&N>=Ba(new Date,6)&&(R.week+=w),O.set($,R)}),Array.from(O.entries()).map(([I,$])=>({agencyId:I,nom:j.get(I)??I,...$}))},[c,j]),D=l.useMemo(()=>x?h.filter(S=>S.agencyId===x):h,[h,x]),k=()=>{const S=[["Agence","Shift ID","Ã‰cart (reÃ§u - attendu)","Date"].join(";"),...D.map(R=>{var w,N;return[j.get(R.agencyId??"")??R.agencyId,R.shiftId??"",(((w=R.validationAudit)==null?void 0:w.computedDifference)??0).toString(),(N=R.validationAudit)!=null&&N.validatedAt?String(R.validationAudit.validatedAt):""].join(";")})],O=new Blob(["\uFEFF"+S.join(`
`)],{type:"text/csv;charset=utf-8"}),I=URL.createObjectURL(O),$=document.createElement("a");$.href=I,$.download=`ecarts-comptables-${yt(new Date,"yyyy-MM-dd")}.csv`,$.click(),URL.revokeObjectURL(I)};return o?e("div",{className:"p-6 flex items-center justify-center min-h-[200px]",children:e("div",{className:"text-gray-500",children:"Chargementâ€¦"})}):u("manage_company_finances")?r?P?e("div",{className:"p-6 flex items-center justify-center min-h-[200px]",children:e("div",{className:"text-gray-500",children:"Chargementâ€¦"})}):t("div",{className:"space-y-6 p-4 md:p-6 max-w-6xl mx-auto",children:[t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[t("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(Fa,{className:"w-5 h-5"})," Revenus consolidÃ©s (sessions validÃ©es)"]}),t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t("div",{className:"p-4 rounded-lg bg-indigo-50 border border-indigo-100",children:[e("div",{className:"text-2xl font-bold text-indigo-700",children:L.toLocaleString("fr-FR")}),e("div",{className:"text-sm text-indigo-800",children:"Aujourd'hui"})]}),t("div",{className:"p-4 rounded-lg bg-purple-50 border border-purple-100",children:[e("div",{className:"text-2xl font-bold text-purple-700",children:M.toLocaleString("fr-FR")}),e("div",{className:"text-sm text-purple-800",children:"7 derniers jours"})]}),t("div",{className:"p-4 rounded-lg bg-teal-50 border border-teal-100",children:[e("div",{className:"text-2xl font-bold text-teal-700",children:_.toLocaleString("fr-FR")}),e("div",{className:"text-sm text-teal-800",children:"30 derniers jours"})]})]}),e("div",{className:"mt-4 overflow-x-auto",children:t("table",{className:"w-full text-sm",children:[e("thead",{children:t("tr",{className:"border-b",children:[e("th",{className:"text-left py-2",children:"Agence"}),e("th",{className:"text-right py-2",children:"Aujourd'hui"}),e("th",{className:"text-right py-2",children:"7 jours"}),e("th",{className:"text-right py-2",children:"30 jours"})]})}),e("tbody",{children:F.map(S=>t("tr",{className:"border-b",children:[e("td",{className:"py-2",children:S.nom}),e("td",{className:"py-2 text-right",children:S.today.toLocaleString("fr-FR")}),e("td",{className:"py-2 text-right",children:S.week.toLocaleString("fr-FR")}),e("td",{className:"py-2 text-right",children:S.month.toLocaleString("fr-FR")})]},S.agencyId))})]})})]}),t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[t("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(nt,{className:"w-5 h-5"})," Ã‰carts comptables (computedDifference â‰  0)"]}),t("div",{className:"flex flex-wrap gap-2 mb-3",children:[t("select",{className:"border rounded px-3 py-1.5 text-sm",value:x,onChange:S=>b(S.target.value),children:[e("option",{value:"",children:"Toutes les agences"}),p.map(S=>e("option",{value:S.id,children:S.nom},S.id))]}),t("button",{type:"button",onClick:k,className:"inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-sm",children:[e(Ca,{className:"w-4 h-4"})," Exporter CSV"]})]}),D.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucun Ã©cart enregistrÃ©."}):e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full text-sm",children:[e("thead",{children:t("tr",{className:"border-b",children:[e("th",{className:"text-left py-2",children:"Agence"}),e("th",{className:"text-left py-2",children:"Shift"}),e("th",{className:"text-right py-2",children:"Ã‰cart"})]})}),e("tbody",{children:D.map((S,O)=>{var I,$;return t("tr",{className:"border-b",children:[e("td",{className:"py-2",children:j.get(S.agencyId??"")??S.agencyId}),e("td",{className:"py-2",children:S.shiftId??"â€”"}),t("td",{className:"py-2 text-right",children:[(((I=S.validationAudit)==null?void 0:I.computedDifference)??0)>=0?"+":"",((($=S.validationAudit)==null?void 0:$.computedDifference)??0).toLocaleString("fr-FR")]})]},O)})})]})})]}),e("p",{className:"text-xs text-gray-500",children:"AccÃ¨s : CEO (admin_compagnie) et comptable compagnie (company_accountant). Aucune validation ni modification des sessions depuis cette page."})]}):e("div",{className:"p-6",children:e("p",{className:"text-gray-500",children:"Compagnie introuvable."})}):e(sm,{capability:"manage_company_finances"})}const Np=Object.freeze(Object.defineProperty({__proto__:null,default:ml},Symbol.toStringTag,{value:"Module"}));function im({country:a,part1:n,part2:r,part3:s,onChange:i,onBlur:u,error:o,required:c=!1,className:m="",disabled:h=!1}){const d=P=>{const C=P.target.value.toUpperCase().replace(/[^A-Z]/g,"").slice(0,2);i(C,r,s)},p=P=>{const C=P.target.value.replace(/\D/g,"").slice(0,4);i(n,C,s)},f=P=>{const C=P.target.value.toUpperCase().replace(/[^A-Z]/g,"").slice(0,2);i(n,r,C)},x=Qs(n,r,s),b=!x||Xs(a,x);return t("div",{className:m,children:[t("div",{className:"flex items-center gap-1 flex-wrap",children:[e("input",{type:"text",value:n,onChange:d,onBlur:u,placeholder:"AA",maxLength:2,disabled:h,className:`w-12 text-center border rounded-lg px-2 py-2 text-sm font-mono uppercase ${o||x&&!b?"border-red-500":"border-slate-300"}`,required:c,"aria-label":"Plaque partie 1 (2 lettres)"}),e("span",{className:"text-slate-400 font-medium",children:"|"}),e("input",{type:"text",inputMode:"numeric",value:r,onChange:p,onBlur:u,placeholder:"100",maxLength:4,disabled:h,className:`w-14 text-center border rounded-lg px-2 py-2 text-sm font-mono ${o||x&&!b?"border-red-500":"border-slate-300"}`,required:c,"aria-label":"Plaque partie 2 (3 ou 4 chiffres)"}),e("span",{className:"text-slate-400 font-medium",children:"|"}),e("input",{type:"text",value:s,onChange:f,onBlur:u,placeholder:"AF",maxLength:2,disabled:h,className:`w-12 text-center border rounded-lg px-2 py-2 text-sm font-mono uppercase ${o||x&&!b?"border-red-500":"border-slate-300"}`,required:c,"aria-label":"Plaque partie 3 (2 lettres)"})]}),(o||x&&!b)&&e("p",{className:"mt-1 text-xs text-red-600",children:o||"Format plaque invalide. Mali : AA 100 AF (3 chiffres) ou AB 1234 MD (4 chiffres)."})]})}const om={GARAGE:"Garage",EN_SERVICE:"En service",EN_TRANSIT:"En transit",EN_MAINTENANCE:"Maintenance",ACCIDENTE:"AccidentÃ©",HORS_SERVICE:"Hors service"},Mn={NORMAL:"Normal",MAINTENANCE:"Maintenance",ACCIDENTE:"AccidentÃ©",HORS_SERVICE:"Hors service"},cm={GARAGE:"Garage",AFFECTE:"AffectÃ©",EN_TRANSIT:"En transit"},es={GARAGE:"bg-slate-200 text-slate-800",EN_SERVICE:"bg-emerald-100 text-emerald-800",EN_TRANSIT:"bg-blue-100 text-blue-800",EN_MAINTENANCE:"bg-amber-100 text-amber-800",ACCIDENTE:"bg-red-100 text-red-800",HORS_SERVICE:"bg-slate-300 text-slate-700"};function dm(a){if(!a)return"â€”";const n=typeof a=="object"&&"toDate"in a?a.toDate():a instanceof Date?a:null;return n?yt(n,"dd/MM/yyyy HH:mm",{locale:Yt}):"â€”"}function mm({view:a}){const{companyId:n}=De(),r=n??"",{setHeader:s,resetHeader:i}=ut(),{user:u}=Pe(),o=Gs(),[c,m]=l.useState([]),[h,d]=l.useState(!0),[p,f]=l.useState(null),[x,b]=l.useState(null),[P,C]=l.useState(null),[j,L]=l.useState(!1),[M,_]=l.useState(!1),[F,D]=l.useState(""),[k,S]=l.useState(""),[O,I]=l.useState("plate"),$=Y=>Y==="status"?"technicalStatus":Y==="updatedAt"?"updatedAt":"plate",[R,w]=l.useState({country:"ML",platePart1:"",platePart2:"",platePart3:"",model:"",year:new Date().getFullYear(),currentCity:"",status:ze.GARAGE,insuranceExpiryDate:"",inspectionExpiryDate:"",vignetteExpiryDate:"",notes:""}),[N,g]=l.useState(null),[v,U]=l.useState([]),{villes:E}=qs(),[B,V]=l.useState(null),[K,z]=l.useState({model:"",technicalStatus:xe.NORMAL,insuranceExpiryDate:"",inspectionExpiryDate:"",vignetteExpiryDate:"",notes:""}),[T,W]=l.useState(!1),[q,H]=l.useState(0),[le,te]=l.useState("plate"),[ae,de]=l.useState(!1),re=l.useRef(null),he=P??(a==="maintenance"?"maintenance":a==="transit"?"transit":a==="incidents"?"accidented":"all"),y=l.useCallback(async(Y=0)=>{if(!r){d(!1);return}d(!0),f(null);try{const oe=Y===0?null:re.current,{vehicles:Ce,lastDoc:Te,hasMore:We}=await ud(r,{pageSize:20,startAfterDoc:oe??void 0,orderByField:le});re.current=Te,m(Ce.map(Z=>({id:Z.id,country:Z.country??"ML",plateNumber:Z.plateNumber??"",model:Z.model??"",year:Number(Z.year)??0,status:Z.status??"GARAGE",technicalStatus:Z.technicalStatus??xe.NORMAL,operationalStatus:Z.operationalStatus??we.GARAGE,currentCity:Z.currentCity??"",destinationCity:Z.destinationCity??null,updatedAt:Z.updatedAt??null,insuranceExpiryDate:Z.insuranceExpiryDate??null,inspectionExpiryDate:Z.inspectionExpiryDate??null,vignetteExpiryDate:Z.vignetteExpiryDate??null,notes:Z.notes??null}))),de(!!We),H(Y)}catch(oe){f(oe instanceof Error?oe.message:"Erreur chargement flotte."),m([])}finally{d(!1)}},[r,le]);l.useEffect(()=>(s({title:a==="maintenance"?"Maintenance":a==="transit"?"Transit":a==="incidents"?"Incidents":"Flotte â€” Chef Garage"}),()=>i()),[s,i,a]),l.useEffect(()=>{y(0)},[y]),l.useEffect(()=>{r&&id(r).then(U).catch(()=>U([]))},[r]);const A=async(Y,oe)=>{if(!(!r||!(u!=null&&u.uid))){b(Y);try{await pd(r,Y,oe,u.uid,u.role??"chef_garage"),await y(q)}catch(Ce){f(Ce instanceof Error?Ce.message:"Erreur mise Ã  jour statut technique.")}finally{b(null)}}},J=Y=>{const oe=Ce=>{if(!Ce)return"";const Te=typeof Ce=="object"&&"toDate"in Ce?Ce.toDate():Ce instanceof Date?Ce:null;return Te?yt(Te,"yyyy-MM-dd"):""};V(Y.id),z({model:Y.model??"",technicalStatus:Y.technicalStatus??xe.NORMAL,insuranceExpiryDate:oe(Y.insuranceExpiryDate),inspectionExpiryDate:oe(Y.inspectionExpiryDate),vignetteExpiryDate:oe(Y.vignetteExpiryDate),notes:Y.notes??""})},se=async Y=>{if(Y.preventDefault(),!(!r||!B||!(u!=null&&u.uid))){W(!0),f(null);try{const oe=Ce=>Ce!=null&&Ce.trim()?fe.fromDate(new Date(Ce.trim())):null;await hd(r,B,{model:K.model.trim()||void 0,technicalStatus:K.technicalStatus,insuranceExpiryDate:oe(K.insuranceExpiryDate),inspectionExpiryDate:oe(K.inspectionExpiryDate),vignetteExpiryDate:oe(K.vignetteExpiryDate),notes:K.notes.trim()||null},u.uid,u.role??"chef_garage"),V(null),await y(q)}catch(oe){f(oe instanceof Error?oe.message:"Erreur mise Ã  jour vÃ©hicule.")}finally{W(!1)}}},[ye,X]=l.useState(null),[ge,Ee]=l.useState(!1),Ne=Y=>{Y.operationalStatus===we.GARAGE&&X(Y)},ie=async()=>{if(!(!r||!ye||!(u!=null&&u.uid))){Ee(!0),f(null);try{if(await dr(r,ye.id)){f("Impossible d'archiver : ce vÃ©hicule a une affectation active."),X(null);return}await fd(r,ye.id,u.uid,u.role??"chef_garage"),X(null),await y(q)}catch(Y){f(Y instanceof Error?Y.message:"Erreur archivage.")}finally{Ee(!1)}}},Ie=Y=>{if(!(Y!=null&&Y.trim()))return;const oe=new Date(Y.trim());return isNaN(oe.getTime())?void 0:fe.fromDate(oe)},Me=async Y=>{var Te,We;Y.preventDefault(),g(null);const oe=Qs(R.platePart1,R.platePart2,R.platePart3);if(!r||!oe||!R.model.trim()||!R.currentCity.trim())return;if(!((Te=R.country)!=null&&Te.trim())){f("Veuillez sÃ©lectionner un pays.");return}if(!Xs(R.country,oe)){g("Format plaque invalide. Mali : AA 100 AF ou AB 1234 MD.");return}const Ce=R.currentCity.trim();if(!E.length||!E.includes(Ce)){f("Veuillez sÃ©lectionner une ville dans la liste (pas de saisie libre).");return}_(!0),f(null);try{const Z={country:R.country.trim(),plateNumber:oe,model:R.model.trim(),year:R.year,status:R.status,currentCity:Ce},ue=Ie(R.insuranceExpiryDate),ve=Ie(R.inspectionExpiryDate),be=Ie(R.vignetteExpiryDate);ue&&(Z.insuranceExpiryDate=ue),ve&&(Z.inspectionExpiryDate=ve),be&&(Z.vignetteExpiryDate=be),(We=R.notes)!=null&&We.trim()&&(Z.notes=R.notes.trim()),await gd(r,Z),w({country:"ML",platePart1:"",platePart2:"",platePart3:"",model:"",year:new Date().getFullYear(),currentCity:"",status:ze.GARAGE,insuranceExpiryDate:"",inspectionExpiryDate:"",vignetteExpiryDate:"",notes:""}),L(!1),await y(q)}catch(Z){f(Z instanceof Error?Z.message:"Erreur ajout vÃ©hicule.")}finally{_(!1)}},Ke=c.length,Ue=c.filter(Y=>Y.operationalStatus===we.GARAGE&&Y.technicalStatus===xe.NORMAL).length,at=c.filter(Y=>Y.operationalStatus===we.EN_TRANSIT).length,Ge=c.filter(Y=>Y.technicalStatus===xe.MAINTENANCE).length,qe=c.filter(Y=>Y.technicalStatus===xe.ACCIDENTE).length,pt=c.filter(Y=>Y.technicalStatus===xe.HORS_SERVICE).length,Nt=he==="all"?c:he==="available"?c.filter(Y=>Y.operationalStatus===we.GARAGE&&Y.technicalStatus===xe.NORMAL):he==="transit"?c.filter(Y=>Y.operationalStatus===we.EN_TRANSIT):he==="maintenance"?c.filter(Y=>Y.technicalStatus===xe.MAINTENANCE):he==="accidented"?c.filter(Y=>Y.technicalStatus===xe.ACCIDENTE):he==="hors_service"?c.filter(Y=>Y.technicalStatus===xe.HORS_SERVICE):c,Gt=l.useMemo(()=>{const Y=new Set(c.map(oe=>oe.currentCity).filter(Boolean));return Array.from(Y).sort()},[c]),Pt=l.useMemo(()=>{let Y=Nt;if(F.trim()){const Ce=F.trim().toLowerCase();Y=Y.filter(Te=>(Te.plateNumber??"").toLowerCase().includes(Ce)||(Te.model??"").toLowerCase().includes(Ce))}k&&(Y=Y.filter(Ce=>(Ce.currentCity??"")===k));const oe=Ce=>{const Te=Ce.updatedAt;return Te?typeof Te.toDate=="function"?Te.toDate().getTime():Te instanceof Date?Te.getTime():0:0};return[...Y].sort((Ce,Te)=>O==="plate"?(Ce.plateNumber??"").localeCompare(Te.plateNumber??""):O==="status"?(Ce.status??"").localeCompare(Te.status??""):oe(Te)-oe(Ce))},[Nt,F,k,O]),Et=(u==null?void 0:u.role)==="chef_garage";return r?t("div",{className:"p-4 sm:p-6 max-w-6xl mx-auto garage-dashboard",children:[p&&e("div",{className:"mb-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm",children:p}),t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6",children:[t("h1",{className:"text-xl font-semibold text-slate-800 flex items-center gap-2",children:[e(xa,{className:"w-5 h-5 text-slate-600"})," Flotte"]}),Et&&t("button",{type:"button",onClick:()=>{g(null),L(!0)},className:"inline-flex items-center gap-2 px-4 py-2 rounded-lg text-white text-sm font-medium transition hover:opacity-90",style:{backgroundColor:o.secondary},children:[e(vn,{className:"w-4 h-4"})," Ajouter un vÃ©hicule"]})]}),t("div",{className:"flex flex-wrap items-center gap-3 mb-4",children:[e("input",{type:"text",placeholder:"Rechercher (plaque, modÃ¨le)",value:F,onChange:Y=>D(Y.target.value),className:"border border-slate-300 rounded-lg px-3 py-2 text-sm w-48 max-w-full"}),t("select",{value:k,onChange:Y=>S(Y.target.value),className:"border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white",children:[e("option",{value:"",children:"Toutes les villes"}),Gt.map(Y=>e("option",{value:Y,children:Y},Y))]}),t("select",{value:O,onChange:Y=>{const oe=Y.target.value;I(oe),te($(oe)),re.current=null},className:"border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white",children:[e("option",{value:"plate",children:"Trier par plaque"}),e("option",{value:"status",children:"Trier par statut technique"}),e("option",{value:"updatedAt",children:"Trier par derniÃ¨re MAJ"})]})]}),e("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2 sm:gap-3 mb-6",children:[{key:"all",count:Ke,label:"Total vÃ©hicules",className:"bg-slate-100 hover:bg-slate-200"},{key:"available",count:Ue,label:"Disponibles",className:"bg-emerald-50 hover:bg-emerald-100"},{key:"transit",count:at,label:"En transit",className:"bg-blue-50 hover:bg-blue-100"},{key:"maintenance",count:Ge,label:"Maintenance",className:"bg-amber-50 hover:bg-amber-100"},{key:"accidented",count:qe,label:"AccidentÃ©s",className:"bg-red-50 hover:bg-red-100"},{key:"hors_service",count:pt,label:"Hors service",className:"bg-slate-200 hover:bg-slate-300"}].map(({key:Y,count:oe,label:Ce,className:Te})=>t("button",{type:"button",onClick:()=>C(Y),className:`p-3 rounded-lg text-left transition ${Te}`,style:he===Y?{boxShadow:`0 0 0 2px ${o.primary}`}:void 0,children:[e("div",{className:"text-xl font-bold text-slate-800",children:oe}),e("div",{className:"text-xs text-slate-600",children:Ce})]},Y))}),h?e("div",{className:"flex justify-center py-12",children:e(Ft,{className:"w-8 h-8 animate-spin text-slate-400"})}):Pt.length===0?e("div",{className:"rounded-xl border border-slate-200 bg-slate-50 p-8 text-center text-slate-600",children:he?"Aucun vÃ©hicule pour ce filtre.":"Aucun vÃ©hicule enregistrÃ©."}):t("div",{className:"rounded-xl border border-slate-200 bg-white overflow-hidden",children:[e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full text-sm",children:[e("thead",{children:t("tr",{className:"border-b text-left",style:{backgroundColor:o.primaryLight??"#f1f5f9"},children:[e("th",{className:"p-3 font-medium text-slate-700",children:"Pays"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Plaque"}),e("th",{className:"p-3 font-medium text-slate-700",children:"ModÃ¨le"}),e("th",{className:"p-3 font-medium text-slate-700",children:"AnnÃ©e"}),e("th",{className:"p-3 font-medium text-slate-700",children:"OpÃ©rationnel"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Technique"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Ville actuelle"}),e("th",{className:"p-3 font-medium text-slate-700",children:"Destination"}),e("th",{className:"p-3 font-medium text-slate-700",children:"DerniÃ¨re MAJ"}),Et&&e("th",{className:"p-3 font-medium text-slate-700",children:"Statut technique"}),Et&&e("th",{className:"p-3 font-medium text-slate-700",children:"Actions"})]})}),e("tbody",{children:Pt.map(Y=>{const oe=x===Y.id;return t("tr",{className:"border-b hover:bg-slate-50/50",children:[e("td",{className:"p-3 text-slate-600",children:Y.country}),e("td",{className:"p-3 font-medium",children:Y.plateNumber}),e("td",{className:"p-3",children:Y.model}),e("td",{className:"p-3",children:Y.year}),e("td",{className:"p-3",children:e("span",{className:`inline-flex px-2 py-0.5 rounded text-xs font-medium ${es[Y.status]??"bg-slate-100"}`,children:cm[Y.operationalStatus]??Y.operationalStatus})}),e("td",{className:"p-3",children:e("span",{className:`inline-flex px-2 py-0.5 rounded text-xs font-medium ${es[Y.status]??"bg-slate-100"}`,children:Mn[Y.technicalStatus]??Y.technicalStatus})}),e("td",{className:"p-3",children:Y.currentCity}),e("td",{className:"p-3",children:Y.destinationCity??"â€”"}),e("td",{className:"p-3 text-slate-600",children:dm(Y.updatedAt)}),Et&&e("td",{className:"p-3",children:e("select",{value:Y.technicalStatus,onChange:Ce=>A(Y.id,Ce.target.value),disabled:oe,className:"text-xs border border-slate-300 rounded px-2 py-1 bg-white",children:Object.entries(xe).map(([Ce,Te])=>e("option",{value:Te,children:Mn[Te]},Ce))})}),Et&&t("td",{className:"p-3 flex items-center gap-1",children:[e("button",{type:"button",onClick:()=>J(Y),className:"p-1.5 rounded border border-slate-300 hover:bg-slate-100 text-slate-600",title:"Modifier",children:e(rr,{className:"w-4 h-4"})}),e("button",{type:"button",onClick:()=>Ne(Y),disabled:Y.operationalStatus!==we.GARAGE||x===Y.id,className:"p-1.5 rounded border border-slate-300 hover:bg-amber-50 hover:border-amber-300 text-slate-600 disabled:opacity-50 disabled:cursor-not-allowed",title:Y.operationalStatus!==we.GARAGE?"Archivage possible uniquement au garage":"Archiver",children:e(Oi,{className:"w-4 h-4"})})]})]},Y.id)})})]})}),t("div",{className:"flex items-center justify-between px-3 py-2 border-t border-slate-200 bg-slate-50 text-sm text-slate-600",children:[t("span",{children:["Page ",q+1]}),t("div",{className:"flex gap-2",children:[e("button",{type:"button",onClick:()=>y(q-1),disabled:q===0,className:"px-3 py-1 rounded border border-slate-300 bg-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50",children:"PrÃ©cÃ©dent"}),e("button",{type:"button",onClick:()=>y(q+1),disabled:!ae,className:"px-3 py-1 rounded border border-slate-300 bg-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50",children:"Suivant"})]})]})]}),j&&e("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:t("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] flex flex-col border border-slate-200 dark:border-gray-700",children:[t("div",{className:"flex items-center justify-between p-4 border-b border-slate-200 dark:border-gray-700 shrink-0",children:[e("h3",{className:"text-lg font-semibold text-slate-800 dark:text-gray-100",children:"Ajouter un vÃ©hicule"}),e("button",{type:"button",onClick:()=>L(!1),className:"p-1 rounded hover:bg-slate-100 dark:hover:bg-gray-700",children:e(cn,{className:"w-5 h-5 text-slate-600 dark:text-gray-400"})})]}),t("form",{onSubmit:Me,className:"flex flex-col flex-1 min-h-0",children:[t("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Pays"}),e("select",{value:R.country,onChange:Y=>{w(oe=>({...oe,country:Y.target.value})),g(null)},className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100",required:!0,children:ad.map(Y=>e("option",{value:Y.code,children:Y.label},Y.code))})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Plaque (Mali)"}),e(im,{country:R.country,part1:R.platePart1,part2:R.platePart2,part3:R.platePart3,onChange:(Y,oe,Ce)=>{w(Te=>({...Te,platePart1:Y,platePart2:oe,platePart3:Ce})),g(null)},error:N,required:!0,className:"dark:bg-gray-700"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"ModÃ¨le"}),e("input",{type:"text",list:"vehicle-models-list",value:R.model,onChange:Y=>w(oe=>({...oe,model:Y.target.value.toUpperCase()})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100 uppercase",required:!0,placeholder:"Ex. TOYOTA HIACE"}),e("datalist",{id:"vehicle-models-list",children:v.map(Y=>e("option",{value:Y},Y))})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"AnnÃ©e"}),e("input",{type:"number",value:R.year,onChange:Y=>w(oe=>({...oe,year:parseInt(Y.target.value,10)||oe.year})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100",min:1990,max:new Date().getFullYear()+1})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Statut initial"}),e("select",{value:R.status,onChange:Y=>w(oe=>({...oe,status:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100",children:Object.entries(ze).map(([Y,oe])=>e("option",{value:oe,children:om[oe]},Y))})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Ville actuelle"}),e(Gn,{value:R.currentCity,onChange:Y=>w(oe=>({...oe,currentCity:Y})),placeholder:"SÃ©lectionner une ville",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Expiration assurance (optionnel)"}),e("input",{type:"date",value:R.insuranceExpiryDate,onChange:Y=>w(oe=>({...oe,insuranceExpiryDate:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Expiration contrÃ´le technique (optionnel)"}),e("input",{type:"date",value:R.inspectionExpiryDate,onChange:Y=>w(oe=>({...oe,inspectionExpiryDate:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Expiration vignette (optionnel)"}),e("input",{type:"date",value:R.vignetteExpiryDate,onChange:Y=>w(oe=>({...oe,vignetteExpiryDate:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Notes (optionnel)"}),e("textarea",{value:R.notes,onChange:Y=>w(oe=>({...oe,notes:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm min-h-[60px] bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100",rows:2})]})]}),t("div",{className:"flex gap-2 p-4 border-t border-slate-200 dark:border-gray-700 shrink-0 bg-white dark:bg-gray-800 rounded-b-xl",children:[e("button",{type:"button",onClick:()=>L(!1),className:"flex-1 px-4 py-2 rounded-lg border border-slate-300 dark:border-gray-600 text-slate-700 dark:text-gray-300 text-sm font-medium hover:bg-slate-50 dark:hover:bg-gray-700",children:"Annuler"}),e("button",{type:"submit",disabled:M,className:"flex-1 px-4 py-2 rounded-lg text-white text-sm font-medium hover:opacity-90 disabled:opacity-50",style:{backgroundColor:o.secondary},children:M?"Ajoutâ€¦":"Ajouter"})]})]})]})}),ye&&e("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:t("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-sm w-full p-4 border border-slate-200 dark:border-gray-700",children:[e("h3",{className:"text-lg font-semibold text-slate-800 dark:text-gray-100 mb-2",children:"Archiver ce vÃ©hicule ?"}),e("p",{className:"text-sm text-slate-600 dark:text-gray-300 mb-4",children:"Ce vÃ©hicule sera retirÃ© de la flotte active mais son historique sera conservÃ©."}),t("div",{className:"flex gap-2",children:[e("button",{type:"button",onClick:()=>X(null),disabled:ge,className:"flex-1 px-4 py-2 rounded-lg border border-slate-300 dark:border-gray-600 text-slate-700 dark:text-gray-300 text-sm font-medium hover:bg-slate-50 dark:hover:bg-gray-700 disabled:opacity-50",children:"Annuler"}),e("button",{type:"button",onClick:ie,disabled:ge,className:"flex-1 px-4 py-2 rounded-lg bg-amber-600 text-white text-sm font-medium hover:bg-amber-700 disabled:opacity-50",children:ge?"â€¦":"Archiver"})]})]})}),B&&e("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:t("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] flex flex-col border border-slate-200 dark:border-gray-700",children:[t("div",{className:"flex items-center justify-between p-4 border-b border-slate-200 dark:border-gray-700 shrink-0",children:[e("h3",{className:"text-lg font-semibold text-slate-800 dark:text-gray-100",children:"Modifier le vÃ©hicule"}),e("button",{type:"button",onClick:()=>V(null),className:"p-1 rounded hover:bg-slate-100 dark:hover:bg-gray-700",children:e(cn,{className:"w-5 h-5 text-slate-600 dark:text-gray-400"})})]}),t("form",{onSubmit:se,className:"flex flex-col flex-1 min-h-0",children:[t("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"ModÃ¨le"}),e("input",{type:"text",list:"vehicle-models-edit",value:K.model,onChange:Y=>z(oe=>({...oe,model:Y.target.value.toUpperCase()})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100 uppercase",required:!0}),e("datalist",{id:"vehicle-models-edit",children:v.map(Y=>e("option",{value:Y},Y))})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Statut technique"}),e("select",{value:K.technicalStatus,onChange:Y=>z(oe=>({...oe,technicalStatus:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100",children:Object.entries(xe).map(([Y,oe])=>e("option",{value:oe,children:Mn[oe]},Y))})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Expiration assurance (optionnel)"}),e("input",{type:"date",value:K.insuranceExpiryDate,onChange:Y=>z(oe=>({...oe,insuranceExpiryDate:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Expiration contrÃ´le technique (optionnel)"}),e("input",{type:"date",value:K.inspectionExpiryDate,onChange:Y=>z(oe=>({...oe,inspectionExpiryDate:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Expiration vignette (optionnel)"}),e("input",{type:"date",value:K.vignetteExpiryDate,onChange:Y=>z(oe=>({...oe,vignetteExpiryDate:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1",children:"Notes (optionnel)"}),e("textarea",{value:K.notes,onChange:Y=>z(oe=>({...oe,notes:Y.target.value})),className:"w-full border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm min-h-[60px] bg-white dark:bg-gray-700 text-slate-900 dark:text-gray-100",rows:2})]})]}),t("div",{className:"flex gap-2 p-4 border-t border-slate-200 dark:border-gray-700 shrink-0 bg-white dark:bg-gray-800 rounded-b-xl",children:[e("button",{type:"button",onClick:()=>V(null),className:"flex-1 px-4 py-2 rounded-lg border border-slate-300 dark:border-gray-600 text-slate-700 dark:text-gray-300 text-sm font-medium hover:bg-slate-50 dark:hover:bg-gray-700",children:"Annuler"}),e("button",{type:"submit",disabled:T,className:"flex-1 px-4 py-2 rounded-lg text-white text-sm font-medium hover:opacity-90 disabled:opacity-50",style:{backgroundColor:o.secondary},children:T?"Enregistrementâ€¦":"Enregistrer"})]})]})]})})]}):e("div",{className:"p-6 text-slate-600 bg-slate-50 rounded-lg",children:"Compagnie introuvable."})}const wp=Object.freeze(Object.defineProperty({__proto__:null,default:mm},Symbol.toStringTag,{value:"Module"})),um={GARAGE:"bg-slate-200 text-slate-800",EN_SERVICE:"bg-emerald-100 text-emerald-800",EN_TRANSIT:"bg-blue-100 text-blue-800",EN_MAINTENANCE:"bg-amber-100 text-amber-800",ACCIDENTE:"bg-red-100 text-red-800",HORS_SERVICE:"bg-slate-300 text-slate-700"},$n=30;function na(a){return a?typeof a.toDate=="function"?a.toDate():a instanceof Date?a:null:null}function Ln(a){if(!a)return null;const n=new Date;n.setHours(0,0,0,0);const r=new Date(a);return r.setHours(0,0,0,0),Math.ceil((r.getTime()-n.getTime())/(24*60*60*1e3))}function pm(){const{companyId:a}=De(),n=a??"",{setHeader:r,resetHeader:s}=ut(),i=Gs(),[u,o]=l.useState([]),[c,m]=l.useState(!0),[h,d]=l.useState(null),p=l.useCallback(async()=>{if(!n){m(!1);return}m(!0),d(null);try{const _=await sl(n);o(_.map(F=>({id:F.id,plateNumber:F.plateNumber??"",status:F.status??"GARAGE",technicalStatus:F.technicalStatus??xe.NORMAL,operationalStatus:F.operationalStatus??we.GARAGE,updatedAt:F.updatedAt??null,insuranceExpiryDate:F.insuranceExpiryDate??null,inspectionExpiryDate:F.inspectionExpiryDate??null,vignetteExpiryDate:F.vignetteExpiryDate??null})))}catch(_){d(_ instanceof Error?_.message:"Erreur chargement flotte."),o([])}finally{m(!1)}},[n]);l.useEffect(()=>(r({title:"Tableau de bord â€” Garage"}),()=>s()),[r,s]),l.useEffect(()=>{p()},[p]);const f=u.length,x=u.filter(_=>_.operationalStatus===we.GARAGE&&_.technicalStatus===xe.NORMAL).length,b=u.filter(_=>_.operationalStatus===we.EN_TRANSIT).length,P=u.filter(_=>_.technicalStatus===xe.MAINTENANCE).length,C=u.filter(_=>_.technicalStatus===xe.ACCIDENTE).length,j=u.filter(_=>_.technicalStatus===xe.HORS_SERVICE).length,L=[...u].sort((_,F)=>{var S,O;const D=((S=na(_.updatedAt))==null?void 0:S.getTime())??0;return(((O=na(F.updatedAt))==null?void 0:O.getTime())??0)-D}).slice(0,10),M=[];return u.forEach(_=>{const F=na(_.insuranceExpiryDate),D=F!=null?Ln(F):null;D!=null&&D>=0&&D<=$n&&M.push({type:"insurance",plateNumber:_.plateNumber,daysLeft:D,label:"Assurance"});const k=na(_.inspectionExpiryDate),S=k!=null?Ln(k):null;S!=null&&S>=0&&S<=$n&&M.push({type:"inspection",plateNumber:_.plateNumber,daysLeft:S,label:"ContrÃ´le technique"});const O=na(_.vignetteExpiryDate),I=O!=null?Ln(O):null;I!=null&&I>=0&&I<=$n&&M.push({type:"vignette",plateNumber:_.plateNumber,daysLeft:I,label:"Vignette"})}),M.sort((_,F)=>_.daysLeft-F.daysLeft),n?t("div",{className:"p-4 sm:p-6 max-w-6xl mx-auto garage-dashboard-home",children:[h&&e("div",{className:"mb-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm",children:h}),t("h1",{className:"text-xl font-semibold text-slate-800 mb-6 flex items-center gap-2",children:[e(xa,{className:"w-5 h-5 text-slate-600"})," Tableau de bord"]}),c?e("div",{className:"flex justify-center py-12",children:e(Ft,{className:"w-8 h-8 animate-spin text-slate-400"})}):t(Ae,{children:[t("section",{className:"mb-8",children:[e("h2",{className:"text-sm font-semibold text-slate-700 mb-3",children:"Indicateurs"}),t("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3",children:[t("div",{className:"p-3 rounded-lg bg-slate-100",children:[e("div",{className:"text-xl font-bold text-slate-800",children:f}),e("div",{className:"text-xs text-slate-600",children:"Total vÃ©hicules"})]}),t("div",{className:"p-3 rounded-lg bg-emerald-50",children:[e("div",{className:"text-xl font-bold text-emerald-700",children:x}),e("div",{className:"text-xs text-emerald-800",children:"Disponibles"})]}),t("div",{className:"p-3 rounded-lg bg-blue-50",children:[e("div",{className:"text-xl font-bold text-blue-700",children:b}),e("div",{className:"text-xs text-blue-800",children:"En transit"})]}),t("div",{className:"p-3 rounded-lg bg-amber-50",children:[e("div",{className:"text-xl font-bold text-amber-700",children:P}),e("div",{className:"text-xs text-amber-800",children:"Maintenance"})]}),t("div",{className:"p-3 rounded-lg bg-red-50",children:[e("div",{className:"text-xl font-bold text-red-700",children:C}),e("div",{className:"text-xs text-red-800",children:"AccidentÃ©s"})]}),t("div",{className:"p-3 rounded-lg bg-slate-200",children:[e("div",{className:"text-xl font-bold text-slate-700",children:j}),e("div",{className:"text-xs text-slate-700",children:"Hors service"})]})]}),e("p",{className:"mt-2 text-xs text-slate-500",children:e(on,{to:`/compagnie/${n}/garage/fleet`,className:"inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium text-white hover:opacity-90 transition",style:{backgroundColor:i.secondary},children:"Voir la liste flotte â†’"})})]}),M.length>0&&t("section",{className:"mb-8",children:[t("h2",{className:"text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2",children:[e(nt,{className:"w-4 h-4 text-amber-600"})," Alertes (expiration sous 30 jours)"]}),e("ul",{className:"space-y-2",children:M.slice(0,15).map((_,F)=>t("li",{className:"flex flex-wrap items-center gap-2 p-3 rounded-lg bg-amber-50 border border-amber-200 text-sm text-amber-900",children:[e("span",{className:"font-medium",children:_.plateNumber}),e("span",{children:_.label}),e("span",{children:_.daysLeft===0?"expire aujourd'hui":_.daysLeft===1?"expire demain":`expire dans ${_.daysLeft} jours`})]},`${_.plateNumber}-${_.type}-${F}`))})]}),t("section",{children:[e("h2",{className:"text-sm font-semibold text-slate-700 mb-3",children:"DerniÃ¨res mises Ã  jour"}),L.length===0?e("p",{className:"text-sm text-slate-500",children:"Aucune activitÃ© rÃ©cente."}):e("ul",{className:"space-y-2 text-sm",children:L.map(_=>t("li",{className:"flex flex-wrap items-center gap-2 text-slate-600",children:[e("span",{className:"font-medium text-slate-800",children:_.plateNumber}),e("span",{className:`inline-flex px-1.5 py-0.5 rounded text-xs ${um[_.status]??""}`,children:_.operationalStatus==="EN_TRANSIT"?"En transit":_.technicalStatus==="MAINTENANCE"?"Maintenance":_.technicalStatus==="ACCIDENTE"?"AccidentÃ©":_.technicalStatus==="HORS_SERVICE"?"Hors service":"Disponible"}),e("span",{children:_.updatedAt&&na(_.updatedAt)?yt(na(_.updatedAt),"dd/MM/yyyy HH:mm",{locale:Yt}):"â€”"})]},_.id))}),e("p",{className:"mt-2 text-xs text-slate-500",children:e(on,{to:`/compagnie/${n}/garage/fleet`,className:"inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium text-white hover:opacity-90 transition",style:{backgroundColor:i.secondary},children:"Voir la liste flotte â†’"})})]})]})]}):e("div",{className:"p-6 text-slate-600 bg-slate-50 rounded-lg",children:"Compagnie introuvable."})}const Cp=Object.freeze(Object.defineProperty({__proto__:null,default:pm},Symbol.toStringTag,{value:"Module"})),gm="expenses";function hm(a){return Q(G,`companies/${a}/${gm}`)}async function fm(a,n){const r=hm(a),s=[];(n==null?void 0:n.agencyId)!==void 0&&(n.agencyId===null?s.push(ne("agencyId","==",null)):s.push(ne("agencyId","==",n.agencyId))),n!=null&&n.status&&s.push(ne("status","==",n.status));const i=ce(r,...s,ot("createdAt","desc"),Re((n==null?void 0:n.limitCount)??50));return(await ee(i)).docs.map(o=>({id:o.id,...o.data()}))}const ym=100,bm=5e4;function ul(){const{user:a,company:n}=Pe(),{companyId:r}=De(),s=r??(a==null?void 0:a.companyId)??"",{setHeader:i,resetHeader:u}=ut(),[o,c]=l.useState([]),[m,h]=l.useState([]),[d,p]=l.useState([]),[f,x]=l.useState(""),[b,P]=l.useState([]),[C,j]=l.useState(!0),[L,M]=l.useState("month"),[_,F]=l.useState(""),[D,k]=l.useState("");l.useEffect(()=>(i({title:"TrÃ©sorerie"}),()=>u()),[i,u]),l.useEffect(()=>{if(!s){j(!1);return}(async()=>{var z;const B=((z=(await Se(me(G,"companies",s))).data())==null?void 0:z.nom)??(n==null?void 0:n.nom)??"";x(B);const[V,K]=await Promise.all([ee(Q(G,"companies",s,"agences")).then(T=>T.docs.map(W=>{const q=W.data(),H=q.nom??q.nomAgence??q.name??"";return{id:W.id,nom:H||W.id}})),fm(s,{limitCount:20})]);p(V),P(K)})()},[s,n]),l.useEffect(()=>{if(!s)return;j(!0);const E=ce(Q(G,`companies/${s}/financialAccounts`),ne("isActive","==",!0)),B=st(E,V=>{c(V.docs.map(K=>{const z=K.data();return{id:K.id,agencyId:z.agencyId??null,accountType:z.accountType??"",accountName:z.accountName??"",currentBalance:Number(z.currentBalance??0),currency:z.currency??""}})),j(!1)});return()=>B()},[s]),l.useEffect(()=>{if(!s)return;const E=ce(Q(G,`companies/${s}/financialMovements`),ot("performedAt","desc"),Re(ym)),B=st(E,V=>{h(V.docs.map(K=>{const z=K.data();return{id:K.id,amount:Number(z.amount??0),movementType:z.movementType??"",performedAt:z.performedAt,referenceId:z.referenceId??"",agencyId:z.agencyId??""}}))});return()=>B()},[s]);const S=l.useMemo(()=>new Map(d.map(E=>[E.id,E.nom])),[d]),O=E=>{const B=S.get(E);return B&&B!==E?B:"Agence inconnue"},I=l.useMemo(()=>o.reduce((E,B)=>E+B.currentBalance,0),[o]),$=l.useMemo(()=>{const E=new Map;return o.forEach(B=>{const V=B.agencyId??"_company";E.set(V,(E.get(V)??0)+B.currentBalance)}),E},[o]),R=l.useMemo(()=>{const E=o.filter(z=>z.accountType==="agency_cash").reduce((z,T)=>z+T.currentBalance,0),B=o.filter(z=>z.accountType==="agency_bank"||z.accountType==="company_bank").reduce((z,T)=>z+T.currentBalance,0),V=o.filter(z=>z.accountType==="mobile_money").reduce((z,T)=>z+T.currentBalance,0),K=o.filter(z=>z.accountType==="expense_reserve").reduce((z,T)=>z+T.currentBalance,0);return{cash:E,bank:B,mobile:V,reserve:K}},[o]),w=l.useMemo(()=>qa(L,new Date,_||void 0,D||void 0),[L,_,D]),N=l.useMemo(()=>m.filter(E=>{var V,K;const B=(K=(V=E.performedAt)==null?void 0:V.toMillis)==null?void 0:K.call(V);return B!=null&&Fc(B,w)}),[m,w]),g=l.useMemo(()=>N.reduce((E,B)=>E+B.amount,0),[N]),v=l.useMemo(()=>o.filter(E=>E.agencyId==null&&E.currentBalance<bm&&E.currentBalance>=0),[o]),U=l.useMemo(()=>[...b].sort((E,B)=>B.amount-E.amount).slice(0,10),[b]);return s?C&&o.length===0?e("div",{className:"p-6 flex items-center justify-center min-h-[200px]",children:e("div",{className:"text-gray-500",children:"Chargement trÃ©sorerieâ€¦"})}):t("div",{className:"space-y-6 p-4 md:p-6 max-w-6xl mx-auto",children:[t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e("p",{className:"text-sm text-gray-600",children:Qn(new Date)}),e(ir,{period:L,customStart:_||void 0,customEnd:D||void 0,onPeriodChange:(E,B,V)=>{M(E),F(B??""),k(V??"")}})]}),t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[t("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(ia,{className:"w-5 h-5"})," LiquiditÃ© totale"]}),e("div",{className:"text-2xl font-bold text-indigo-700",children:I.toLocaleString("fr-FR")}),t("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mt-3",children:[t("div",{className:"p-3 rounded-lg bg-amber-50",children:[e("div",{className:"text-sm text-amber-800",children:"Caisse (agences)"}),e("div",{className:"font-bold",children:R.cash.toLocaleString("fr-FR")})]}),t("div",{className:"p-3 rounded-lg bg-blue-50",children:[e("div",{className:"text-sm text-blue-800",children:"Banque"}),e("div",{className:"font-bold",children:R.bank.toLocaleString("fr-FR")})]}),t("div",{className:"p-3 rounded-lg bg-green-50",children:[e("div",{className:"text-sm text-green-800",children:"Mobile money"}),e("div",{className:"font-bold",children:R.mobile.toLocaleString("fr-FR")})]}),t("div",{className:"p-3 rounded-lg bg-slate-50",children:[e("div",{className:"text-sm text-slate-800",children:"RÃ©serve dÃ©penses"}),e("div",{className:"font-bold",children:R.reserve.toLocaleString("fr-FR")})]})]})]}),t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[t("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(St,{className:"w-5 h-5"})," Par agence"]}),e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full text-sm",children:[e("thead",{children:t("tr",{className:"border-b",children:[e("th",{className:"text-left py-2",children:"Agence"}),e("th",{className:"text-right py-2",children:"Solde"})]})}),t("tbody",{children:[d.map(E=>t("tr",{className:"border-b",children:[e("td",{className:"py-2",children:O(E.id)}),e("td",{className:"py-2 text-right font-medium",children:($.get(E.id)??0).toLocaleString("fr-FR")})]},E.id)),Array.from($.keys()).filter(E=>E!=="_company"&&!S.has(E)).map(E=>t("tr",{className:"border-b",children:[e("td",{className:"py-2 text-gray-500",children:"Agence inconnue"}),e("td",{className:"py-2 text-right font-medium",children:($.get(E)??0).toLocaleString("fr-FR")})]},E)),t("tr",{className:"border-b",children:[e("td",{className:"py-2",children:"Niveau compagnie"}),e("td",{className:"py-2 text-right font-medium",children:($.get("_company")??0).toLocaleString("fr-FR")})]})]})]})})]}),t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[t("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2",children:[e(Rt,{className:"w-5 h-5"})," Flux sur la pÃ©riode"]}),e("div",{className:"text-xl font-bold",children:g.toLocaleString("fr-FR")})]}),v.length>0&&t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[t("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2 text-amber-700",children:[e(Ct,{className:"w-5 h-5"})," Comptes Ã  faible solde"]}),e("ul",{className:"space-y-1 text-sm",children:v.map(E=>{const B=E.agencyId?(E.accountType==="agency_cash"?"Caisse ":E.accountType==="agency_bank"?"Banque ":"")+O(E.agencyId):f?`${f} â€” ${E.accountName}`:E.accountName;return t("li",{children:[B," â€” ",E.currentBalance.toLocaleString("fr-FR")," ",E.currency]},E.id)})})]}),t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[e("h2",{className:"text-lg font-semibold mb-3",children:"Derniers mouvements"}),e("div",{className:"overflow-x-auto max-h-64 overflow-y-auto",children:t("table",{className:"w-full text-sm",children:[e("thead",{children:t("tr",{className:"border-b",children:[e("th",{className:"text-left py-1",children:"Type"}),e("th",{className:"text-right py-1",children:"Montant"}),e("th",{className:"text-left py-1",children:"Agence"})]})}),e("tbody",{children:N.slice(0,30).map(E=>t("tr",{className:"border-b",children:[e("td",{className:"py-1",children:E.movementType}),t("td",{className:"py-1 text-right",children:["+",E.amount.toLocaleString("fr-FR")]}),e("td",{className:"py-1",children:E.agencyId?O(E.agencyId):"â€”"})]},E.id))})]})})]}),t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[e("h2",{className:"text-lg font-semibold mb-3",children:"DÃ©penses rÃ©centes"}),U.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucune dÃ©pense."}):e("ul",{className:"space-y-1 text-sm",children:U.map(E=>t("li",{children:[E.category," â€” ",E.amount.toLocaleString("fr-FR")," â€” ",E.status]},E.id))})]})]}):e("div",{className:"p-6",children:e("p",{className:"text-gray-500",children:"Compagnie introuvable."})})}const Sp=Object.freeze(Object.defineProperty({__proto__:null,default:ul},Symbol.toStringTag,{value:"Module"}));delete ps.Icon.Default.prototype._getIconUrl;ps.Icon.Default.mergeOptions({iconRetinaUrl:"/leaflet/marker-icon-2x.png",iconUrl:"/leaflet/marker-icon.png",shadowUrl:"/leaflet/marker-shadow.png"});const Ka=a=>a.replace(/\s+/g," ").trim().toLowerCase().replace(new RegExp("\\b\\p{L}","gu"),n=>n.toUpperCase()),ha=a=>a.replace(/\D/g,""),ts=a=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a),as=a=>{const n=ha(a);return n.length>=8&&n.length<=15},ra=a=>a.normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim().toLowerCase(),xm=a=>ra(a).replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),jn=a=>a.trim().toLowerCase(),vm=({open:a,onClose:n,onConfirm:r,agences:s,agencyIdToDelete:i,loading:u})=>{const[o,c]=l.useState("detach"),[m,h]=l.useState("");if(l.useEffect(()=>{a&&(c("detach"),h(""))},[a]),!a)return null;const d=s.filter(f=>f.id&&f.id!==i),p=o!=="transfer"||o==="transfer"&&m&&m.length>0;return e("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:t("div",{className:"w-full max-w-lg rounded-xl bg-white shadow-lg",children:[t("div",{className:"px-5 py-4 border-b",children:[e("h3",{className:"text-lg font-semibold",children:"Supprimer lâ€™agence"}),e("p",{className:"text-sm text-gray-500",children:"Choisissez quoi faire avec le personnel rattachÃ© Ã  cette agence."})]}),t("div",{className:"px-5 py-4 space-y-4",children:[t("label",{className:"flex items-start space-x-3",children:[e("input",{type:"radio",name:"staffAction",className:"mt-1",checked:o==="detach",onChange:()=>c("detach")}),t("div",{children:[e("div",{className:"font-medium",children:"DÃ©tacher le personnel"}),e("div",{className:"text-sm text-gray-500",children:"Les comptes restent actifs mais ne seront rattachÃ©s Ã  aucune agence (agencyId = null)."})]})]}),t("label",{className:"flex items-start space-x-3",children:[e("input",{type:"radio",name:"staffAction",className:"mt-1",checked:o==="transfer",onChange:()=>c("transfer")}),t("div",{className:"w-full",children:[e("div",{className:"font-medium",children:"TransfÃ©rer vers une autre agence"}),e("div",{className:"text-sm text-gray-500 mb-2",children:"DÃ©place tous les membres vers lâ€™agence sÃ©lectionnÃ©e."}),t("select",{className:"w-full border rounded px-3 py-2",disabled:o!=="transfer",value:m,onChange:f=>h(f.target.value),children:[e("option",{value:"",children:"â€” SÃ©lectionner lâ€™agence cible â€”"}),d.map(f=>t("option",{value:f.id,children:[f.nomAgence," â€¢ ",f.ville,", ",f.pays]},f.id))]})]})]}),t("label",{className:"flex items-start space-x-3",children:[e("input",{type:"radio",name:"staffAction",className:"mt-1",checked:o==="disable",onChange:()=>c("disable")}),t("div",{children:[e("div",{className:"font-medium",children:"DÃ©sactiver les comptes"}),e("div",{className:"text-sm text-gray-500",children:"Les comptes seront dÃ©sactivÃ©s (Auth.disabled = true) et dÃ©tachÃ©s."})]})]}),t("label",{className:"flex items-start space-x-3",children:[e("input",{type:"radio",name:"staffAction",className:"mt-1",checked:o==="delete",onChange:()=>c("delete")}),t("div",{children:[e("div",{className:"font-medium text-red-700",children:"Supprimer les comptes (dangereux)"}),e("div",{className:"text-sm text-red-600",children:"Efface dÃ©finitivement les utilisateurs (Auth + Firestore). Ã€ nâ€™utiliser quâ€™en dernier recours."})]})]})]}),t("div",{className:"px-5 py-4 border-t flex justify-end space-x-2",children:[e("button",{onClick:n,className:"px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50",disabled:u,children:"Annuler"}),e(je,{onClick:()=>r(o,o==="transfer"&&m||null),disabled:!p||u,variant:o==="delete"?"danger":"primary",children:u?"Traitement...":"Confirmer"})]})]})})},pl=()=>{var he;const{user:a,company:n}=Pe(),r=lt(n),{setHeader:s,resetHeader:i}=ut(),u=Be(),[o,c]=l.useState([]),[m,h]=l.useState(!1),[d,p]=l.useState(null),[f,x]=l.useState(1),[b,P]=l.useState(6),[C,j]=l.useState({nomAgence:"",ville:"",pays:"",quartier:"",type:"",emailGerant:"",nomGerant:"",telephone:"",latitude:"",longitude:""}),[L,M]=l.useState(""),[_,F]=l.useState(!1),[D,k]=l.useState(!1),[S,O]=l.useState(!1),[I,$]=l.useState(null),[R,w]=l.useState(!1),N=((he=r.colors)==null?void 0:he.primary)||(a==null?void 0:a.companyColor)||"#2563eb",{companyId:g}=De(),v=g??(a==null?void 0:a.companyId)??"",U=({onPositionChange:y})=>(Kl({click(A){y(A.latlng.lat,A.latlng.lng)}}),null);l.useEffect(()=>(s({title:"Agences",subtitle:o.length?`${o.length} agence${o.length>1?"s":""}`:"",bg:`linear-gradient(90deg, ${r.colors.primary} 0%, ${r.colors.secondary} 100%)`,fg:"#fff"}),()=>i()),[o.length,r.colors.primary,r.colors.secondary]);const E=async()=>{if(!v){console.warn("companyId manquant â€” impossible de charger les agences"),c([]);return}F(!0);try{await kn;const y=Q(G,"companies",v,"agences"),J=(await ee(ce(y))).docs.map(se=>({id:se.id,...se.data()}));c(J),x(1)}catch(y){console.error("Erreur Firestore (agences):",y==null?void 0:y.code,y==null?void 0:y.message,y),alert("Une erreur est survenue lors du chargement des agences : "+((y==null?void 0:y.message)||String(y)))}finally{F(!1)}};l.useEffect(()=>{if(!v){c([]);return}let y=!0;return(async()=>{try{if(await kn,!y)return;await E()}catch(A){console.warn("dbReady error",A)}})(),()=>{y=!1}},[v]);const B=f*b,V=B-b,K=l.useMemo(()=>o.slice(V,B),[o,V,B]),z=Math.ceil(o.length/b),T=y=>{const{name:A,value:J,type:se}=y.target;if(A==="emailGerant"&&M(""),A==="nomGerant"){j(ye=>({...ye,[A]:Ka(J)}));return}if(A==="telephone"){const ye=ha(J);j(X=>({...X,[A]:ye}));return}if((A==="latitude"||A==="longitude")&&J!==""){const ye=J.replace(",",".");j(X=>({...X,[A]:ye}));return}j(ye=>({...ye,[A]:se==="email"?J.trim():J}))},W=(y,A)=>{j(J=>({...J,latitude:String(y),longitude:String(A)}))},q=()=>{j({nomAgence:"",ville:"",pays:"",quartier:"",type:"",emailGerant:"",nomGerant:"",telephone:"",latitude:"",longitude:""}),p(null),h(!1),M("")},H=async()=>{if(!v){alert("Aucune compagnie associÃ©e");return}const y=n,A=(y==null?void 0:y.subscriptionStatus)??"active",J=bi(A,"CREATE_AGENCY");if(!J.allowed){alert(J.reason||"Action non autorisÃ©e par votre abonnement.");return}if(!(J.warning&&!confirm(J.warning+`

Souhaitez-vous continuer ?`))){if(!C.nomAgence.trim()){alert("Nom de l'agence requis");return}if(!ts(C.emailGerant)){M("Email invalide");return}if(!as(C.telephone)){alert("TÃ©lÃ©phone invalide");return}k(!0);try{const se=await Na(Q(G,"companies",v,"agences"),{companyId:v,nomAgence:C.nomAgence.trim(),nomAgenceNorm:ra(C.nomAgence),ville:C.ville.trim(),villeNorm:ra(C.ville),pays:C.pays.trim(),paysNorm:ra(C.pays),quartier:C.quartier||"",type:C.type||"",statut:"active",emailGerant:jn(C.emailGerant),nomGerant:Ka(C.nomGerant||""),telephone:ha(C.telephone),latitude:C.latitude?parseFloat(C.latitude):null,longitude:C.longitude?parseFloat(C.longitude):null,createdAt:Oe()}),ye=await fs({email:jn(C.emailGerant),role:"chefAgence",companyId:v,agencyId:se.id,fullName:Ka(C.nomGerant||""),phone:ha(C.telephone)});await He(se,{invitationId:ye.inviteId,invitationToken:ye.token}),alert(`âœ… Agence crÃ©Ã©e.

Lien dâ€™activation :
${ye.activationUrl}`),q(),E()}catch(se){console.error(se),alert("Erreur lors de la crÃ©ation de l'agence")}finally{k(!1)}}},le=async y=>{if(y.preventDefault(),d){if(!v||!d)return;try{const A=me(G,"companies",v,"agences",d);await He(A,{companyId:v,nomAgence:C.nomAgence,nomAgenceNorm:ra(C.nomAgence),ville:C.ville,villeNorm:ra(C.ville),pays:C.pays,paysNorm:ra(C.pays),slug:xm(C.nomAgence),quartier:C.quartier||"",type:C.type||"",nomGerant:C.nomGerant,emailGerant:jn(C.emailGerant),telephone:ha(C.telephone),latitude:C.latitude?parseFloat(C.latitude):null,longitude:C.longitude?parseFloat(C.longitude):null,updatedAt:Oe()}),alert("âœ… Agence mise Ã  jour avec succÃ¨s"),q(),E()}catch(A){console.error("Erreur update agence:",A),alert("Erreur: "+((A==null?void 0:A.message)||A))}return}await H()},te=y=>{j({nomAgence:y.nomAgence,ville:y.ville,pays:y.pays,quartier:y.quartier||"",type:y.type||"",emailGerant:y.emailGerant,nomGerant:Ka(y.nomGerant||""),telephone:ha(y.telephone||""),latitude:y.latitude!=null?String(y.latitude):"",longitude:y.longitude!=null?String(y.longitude):""}),p(y.id),h(!0),window.scrollTo({top:0,behavior:"smooth"})},ae=y=>{$(y),O(!0)},de=async(y,A)=>{if(!I||!v){O(!1);return}w(!0);try{await kn;const J={companyId:v,agencyId:I,action:y,transferToAgencyId:A||void 0},X=(await gs(yi,"companyDeleteAgencyCascade")(J)).data;X!=null&&X.success?(alert("Suppression traitÃ©e avec succÃ¨s."),O(!1),$(null),await E()):(console.warn("companyDeleteAgencyCascade returned:",X),alert((X==null?void 0:X.message)||"Erreur lors de la suppression de l'agence."))}catch(J){console.error("Erreur delete agency (function):",J);const se=(J==null?void 0:J.code)||(J==null?void 0:J.status)||"";if(se==="permission-denied"||se==="unauthenticated")alert("Permission refusÃ©e â€” vous n'Ãªtes pas autorisÃ© Ã  supprimer une agence.");else{const ye=J!=null&&J.details?`
DÃ©tails: ${JSON.stringify(J.details)}`:"";alert("Erreur lors de la suppression : "+((J==null?void 0:J.message)||String(J))+ye)}}finally{w(!1)}},re=async y=>{if(!v||!y.id)return;const A=y.statut==="active"?"inactive":"active";try{await He(me(G,"companies",v,"agences",y.id),{statut:A,updatedAt:Oe()}),E()}catch(J){console.error("Erreur lors du changement de statut:",J),alert("Une erreur est survenue lors du changement de statut")}},pe=y=>{u(`/compagnie/agence/${y}/dashboard`)};return t("div",{className:"p-6 max-w-7xl mx-auto",children:[t("div",{className:"flex justify-between items-center mb-8",children:[e("div",{}),t(je,{onClick:()=>h(!m),variant:"primary",children:[e("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),m?"Masquer le formulaire":"Ajouter une nouvelle agence"]})]}),m&&e("form",{onSubmit:le,className:"bg-white p-6 rounded-lg shadow-sm mb-8 border border-gray-200",children:t("fieldset",{disabled:D,className:D?"opacity-60":"",children:[e("h3",{className:"text-lg font-semibold mb-4",style:{color:N},children:d?"Modifier une agence":"Ajouter une nouvelle agence"}),t("div",{className:"grid md:grid-cols-2 gap-6",children:[t("div",{className:"space-y-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Nom de l'agence *"}),e("input",{name:"nomAgence",value:C.nomAgence,onChange:T,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Ville *"}),e("input",{name:"ville",value:C.ville,onChange:T,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Pays *"}),e("input",{name:"pays",value:C.pays,onChange:T,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Quartier"}),e("input",{name:"quartier",value:C.quartier,onChange:T,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Type"}),e("input",{name:"type",value:C.type,onChange:T,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),t("div",{className:"space-y-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Nom du gÃ©rant *"}),e("input",{name:"nomGerant",value:C.nomGerant,onChange:T,className:"form-input w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Email du gÃ©rant *"}),e("input",{name:"emailGerant",type:"email",value:C.emailGerant,onChange:T,className:`form-input w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 ${C.emailGerant&&!ts(C.emailGerant)?"border-red-500 focus:ring-red-400":"border-gray-300 focus:ring-blue-500"}`,required:!0}),L&&e("p",{className:"text-red-600 text-sm mt-1",children:L})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"TÃ©lÃ©phone *"}),e("input",{name:"telephone",inputMode:"numeric",value:C.telephone,onChange:T,minLength:8,maxLength:15,className:`form-input w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 ${C.telephone&&!as(C.telephone)?"border-red-500 focus:ring-red-400":"border-gray-300 focus:ring-blue-500"}`,required:!0,placeholder:"Ex.: 78953098"})]})]})]}),t("div",{className:"mt-6",children:[t("label",{className:"block text-sm font-medium mb-1",children:["ðŸ“ Position gÃ©ographique"," ",C.latitude&&C.longitude&&t("span",{className:"text-gray-500 ml-2",children:["(",C.latitude,", ",C.longitude,")"]})]}),e("p",{className:"text-sm text-gray-500 mb-2",children:"Cliquez sur la carte pour positionner l'agence"}),e("div",{className:"h-64 rounded-lg border border-gray-300 overflow-hidden",children:t(Vl,{center:[C.latitude?parseFloat(C.latitude):12.6392,C.longitude?parseFloat(C.longitude):-8.0029],zoom:C.latitude?15:12,className:"h-full w-full",scrollWheelZoom:!0,children:[e(Hl,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e(U,{onPositionChange:W}),C.latitude&&C.longitude&&e(Yl,{position:[parseFloat(C.latitude),parseFloat(C.longitude)]})]})})]}),t("div",{className:"flex justify-end space-x-3 mt-6",children:[e("button",{type:"button",onClick:q,className:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Annuler"}),e(je,{type:"submit",disabled:D,variant:"primary",children:d?"Mettre Ã  jour l'agence":D?"CrÃ©ationâ€¦":"Ajouter l'agence"})]})]})}),t("div",{className:"flex justify-between items-center mb-4",children:[e("h3",{className:"text-xl font-semibold",children:_?"Chargementâ€¦":`Liste des agences (${o.length})`}),t("div",{className:"flex items-center",children:[e("label",{className:"mr-2 text-sm",children:"Agences par page:"}),t("select",{value:b,onChange:y=>{P(Number(y.target.value)),x(1)},className:"border rounded p-1 text-sm",children:[e("option",{value:6,children:"6"}),e("option",{value:12,children:"12"}),e("option",{value:24,children:"24"})]})]})]}),o.length===0&&!_?t("div",{className:"bg-white p-8 rounded-xl shadow-sm border border-gray-200 text-center",children:[e("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})}),e("h3",{className:"mt-2 text-lg font-medium text-gray-900",children:"Aucune agence enregistrÃ©e"}),e("p",{className:"mt-1 text-sm text-gray-500",children:"Commencez par ajouter votre premiÃ¨re agence."}),e("div",{className:"mt-6",children:t(je,{onClick:()=>h(!0),variant:"primary",children:[e("svg",{className:"-ml-1 mr-2 h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Ajouter une agence"]})})]}):t(Ae,{children:[e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:K.map(y=>e("div",{className:"bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200 hover:shadow-sm transition-shadow",children:t("div",{className:"p-5",children:[t("div",{className:"flex justify-between items-start",children:[t("div",{children:[e("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:y.nomAgence}),t("p",{className:"text-sm text-gray-500",children:[y.ville,", ",y.pays]})]}),e("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${y.statut==="active"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:y.statut==="active"?"Active":"Inactive"})]}),t("div",{className:"mt-4 border-t border-gray-200 pt-4",children:[t("div",{className:"flex items-center text-sm text-gray-500 mb-2",children:[e("svg",{className:"flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})}),y.emailGerant]}),(y.invitationToken||y.invitationId)&&e("div",{className:"mb-2",children:e("a",{href:`/accept-invitation/${y.invitationToken||y.invitationId}`,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 underline hover:text-blue-800",children:"ðŸ‘‰ Accepter lâ€™invitation du gÃ©rant"})}),t("div",{className:"flex items-center text-sm text-gray-500",children:[e("svg",{className:"flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"})}),y.telephone]})]}),t("div",{className:"mt-5 flex justify-between space-x-2",children:[t("button",{onClick:()=>pe(y.id),className:"flex-1 inline-flex justify-center items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:[e("svg",{className:"-ml-1 mr-2 h-5 w-5 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2z"})}),"Dashboard"]}),t(je,{onClick:()=>{h(!0),te(y)},variant:"primary",size:"sm",children:[e("svg",{className:"-ml-1 mr-2 h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Modifier"]})]}),t("div",{className:"mt-3 flex space-x-2",children:[e("button",{onClick:()=>re(y),className:`flex-1 px-3 py-2 border rounded-md text-sm font-medium ${y.statut==="active"?"border-yellow-300 text-yellow-700 bg-yellow-100 hover:bg-yellow-200":"border-green-300 text-green-700 bg-green-100 hover:bg-green-200"}`,children:y.statut==="active"?"DÃ©sactiver":"Activer"}),e("button",{onClick:()=>ae(y.id),className:"flex-1 px-3 py-2 border border-red-300 rounded-md text-sm font-medium text-red-700 bg-red-100 hover:bg-red-200",children:"Supprimer"})]})]})},y.id))}),o.length>b&&t("div",{className:"flex justify-between items-center mt-6",children:[t("div",{className:"text-sm text-gray-500",children:["Affichage ",V+1,"-",Math.min(B,o.length)," sur ",o.length," agences"]}),t("div",{className:"flex space-x-2",children:[e("button",{onClick:()=>x(y=>Math.max(y-1,1)),disabled:f===1,className:`px-4 py-2 rounded-md ${f===1?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:"PrÃ©cÃ©dent"}),t("span",{className:"px-4 py-2 text-gray-700",children:["Page ",f," sur ",z]}),e("button",{onClick:()=>x(y=>Math.min(y+1,z)),disabled:f===z,className:`px-4 py-2 rounded-md ${f===z?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:"Suivant"})]})]})]}),e(vm,{open:S,onClose:()=>!R&&O(!1),onConfirm:(y,A)=>de(y,A),agences:o,agencyIdToDelete:I,loading:R})]})},Ap=Object.freeze(Object.defineProperty({__proto__:null,default:pl},Symbol.toStringTag,{value:"Module"})),Nm=({companyId:a})=>{const{user:n}=Pe(),r=a??(n==null?void 0:n.companyId),[s,i]=l.useState({accroche:"",instructionRecherche:"",logoUrl:"",faviconUrl:"",banniereUrl:"",couleurPrimaire:"#3B82F6",couleurSecondaire:"#10B981",couleurAccent:"#FBBF24",couleurTertiaire:"#F472B6",themeStyle:"moderne"}),[u,o]=l.useState({text:"",type:""}),[c,m]=l.useState(null),[h,d]=l.useState(null);l.useEffect(()=>{if(!r)return;(async()=>{try{const b=await Se(me(G,"companies",r));b.exists()&&i(P=>({...P,...b.data()}))}catch(b){console.error("Erreur chargement vitrine:",b)}})()},[r]);const p=async()=>{if(r){o({text:"Enregistrement...",type:"info"});try{await He(me(G,"companies",r),s),o({text:"Modifications enregistrÃ©es",type:"success"})}catch(x){console.error(x),o({text:"Erreur lors de l'enregistrement",type:"error"})}}},f=x=>{c&&(i(b=>({...b,...c==="logo"&&{logoUrl:x},...c==="favicon"&&{faviconUrl:x},...c==="banniereStatique"&&{banniereUrl:x}})),m(null))};return e("div",{className:"min-h-screen bg-gray-50 py-8 px-6",children:t("div",{className:"max-w-7xl mx-auto space-y-6",children:[t("div",{className:"bg-white rounded-xl shadow-sm p-6 border-l-4 flex items-center gap-4",style:{borderLeftColor:s.couleurPrimaire},children:[e(bn,{className:"h-8 w-8 text-gray-700"}),t("div",{children:[e("h1",{className:"text-2xl font-bold",children:"Personnalisation de la vitrine"}),e("p",{className:"text-gray-500",children:"Configuration de la page publique"})]})]}),t("div",{className:"bg-white rounded-xl p-6 border space-y-4",children:[t("h3",{className:"font-semibold flex items-center gap-2",children:[e(qi,{}),"Textes personnalisÃ©s"]}),e("input",{type:"text",placeholder:"Phrase d'accroche",value:s.accroche,onChange:x=>i({...s,accroche:x.target.value}),className:"w-full border rounded-lg px-4 py-2"}),e("input",{type:"text",placeholder:"Instruction de recherche",value:s.instructionRecherche,onChange:x=>i({...s,instructionRecherche:x.target.value}),className:"w-full border rounded-lg px-4 py-2"})]}),t("div",{className:"bg-white rounded-xl p-6 border",children:[t("h3",{className:"font-semibold flex items-center gap-2 mb-4",children:[e(Ui,{}),"Couleurs"]}),e("div",{className:"grid grid-cols-2 gap-6",children:["couleurPrimaire","couleurSecondaire","couleurAccent","couleurTertiaire"].map(x=>t("div",{children:[e("div",{className:"h-10 w-10 rounded border cursor-pointer",style:{backgroundColor:s[x]},onClick:()=>d(x)}),h===x&&e(Wl,{color:s[x],onChange:b=>i({...s,[x]:b})})]},x))})]}),t("div",{className:"bg-white rounded-xl p-6 border space-y-4",children:[t("h3",{className:"font-semibold flex items-center gap-2",children:[e(sr,{}),"Images"]}),e("button",{onClick:()=>m("logo"),className:"px-4 py-2 bg-gray-100 rounded",children:"Modifier logo"}),e("button",{onClick:()=>m("favicon"),className:"px-4 py-2 bg-gray-100 rounded",children:"Modifier favicon"}),e("button",{onClick:()=>m("banniereStatique"),className:"px-4 py-2 bg-gray-100 rounded",children:"Modifier banniÃ¨re"})]}),e("div",{className:"flex justify-end",children:t(je,{onClick:p,variant:"primary",children:[e(ba,{size:18,className:"inline mr-2"}),"Enregistrer"]})}),c&&r&&e($o,{companyId:r,onSelect:f,onClose:()=>m(null)})]})})},wm={admin_compagnie:"CEO / PropriÃ©taire",financial_director:"Directeur financier (DAF)",company_accountant:"Comptable (compagnie)",chef_garage:"Chef garage (flotte)",chef_agence:"Chef dâ€™agence",agency_accountant:"Comptable (agence)",guichetier:"Guichetier",agent_courrier:"Agent de courrier"},Cm=/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i,ns=/^\d{8,15}$/,Wa=a=>a.trim().replace(/\s+/g," ").toLowerCase().replace(new RegExp("(^|\\s)\\p{L}","gu"),n=>n.toUpperCase()),ka=a=>!a||a.trim()==="",Sm=({companyId:a})=>{const{user:n}=Pe(),[r,s]=l.useState([]),[i,u]=l.useState([]),[o,c]=l.useState(!1),[m,h]=l.useState(""),[d,p]=l.useState(""),[f,x]=l.useState(""),[b,P]=l.useState(""),[C,j]=l.useState("company_accountant"),[L,M]=l.useState(null),[_,F]=l.useState(""),[D,k]=l.useState(""),[S,O]=l.useState("company_accountant"),I=async()=>{if(!(n!=null&&n.companyId))return;const z=ce(Q(G,"agences"),ne("companyId","==",n.companyId)),W=(await ee(z)).docs.map(q=>({id:q.id,nomAgence:q.data().nomAgence,companyId:q.data().companyId}));u(W)},$=async()=>{if(n!=null&&n.companyId)try{const z=ce(Q(G,"users"),ne("companyId","==",n.companyId)),W=(await ee(z)).docs.map(q=>({id:q.id,...q.data()})).filter(q=>q.role!=="admin_plateforme").sort((q,H)=>(q.displayName||"").localeCompare(H.displayName||""));s(W)}catch(z){console.error("loadStaff err:",z),h("âŒ Erreur lors du chargement du personnel.")}};l.useEffect(()=>{I(),$()},[n==null?void 0:n.companyId]);const R=()=>{p(""),x(""),P(""),j("company_accountant")},w=()=>{const z=[];return ka(d)&&z.push("le nom complet"),(ka(f)||!Cm.test(f))&&z.push("un email valide"),!ka(b)&&!ns.test(b)&&z.push("un tÃ©lÃ©phone valide (8 Ã  15 chiffres) ou vide"),z.length?(h("âš ï¸ Merci de renseigner "+z.join(", ")+"."),!1):!0},N=async()=>{var z;if(!(n!=null&&n.companyId)){h("âš ï¸ Aucune compagnie associÃ©e.");return}if(w()){c(!0),h("");try{const T=Wa(d),W=await fs({email:f.trim().toLowerCase(),role:C,companyId:n.companyId,fullName:T,...b.trim()?{phone:b.trim()}:{},createdBy:n==null?void 0:n.uid});h(`Invitation crÃ©Ã©e avec succÃ¨s. Partagez ce lien avec l'invitÃ© : ${W.activationUrl}`),R()}catch(T){console.error("handleAdd err:",T);const W=(T==null?void 0:T.code)??((z=T==null?void 0:T.details)==null?void 0:z.code);h(W==="already-exists"?"âš ï¸ Une invitation en attente existe dÃ©jÃ  pour cet email.":"âŒ "+((T==null?void 0:T.message)??"Envoi impossible. Voir la console."))}finally{c(!1)}}},g=async(z,T)=>{c(!0),h("");try{const W=me(G,"users",z.uid);await He(W,{active:T}),s(q=>q.map(H=>H.uid===z.uid?{...H,active:T}:H))}catch(W){console.error("toggleActive err:",W),h("âŒ Erreur lors du changement de statut.")}finally{c(!1)}},v=z=>{M(z.uid),F(z.displayName||""),k(z.telephone||""),O(z.role)},U=async()=>{if(!L)return;const z=Wa(_||"");if(ka(z)){h("âš ï¸ Le nom est obligatoire.");return}if(ka(D)||!ns.test(D)){h("âš ï¸ TÃ©lÃ©phone invalide. 8â€“15 chiffres.");return}c(!0),h("");try{const T=me(G,"users",L);if(!(await Se(T)).exists())throw new Error("User introuvable");await He(T,{displayName:z,telephone:D.trim(),role:S}),s(q=>q.map(H=>H.uid===L?{...H,displayName:z,telephone:D.trim(),role:S}:H)),M(null)}catch(T){console.error("edit save err:",T),h("âŒ Erreur lors de la modification.")}finally{c(!1)}},E=async z=>{if(window.confirm(`Supprimer dÃ©finitivement "${z.displayName}" ?
Cette action effacera aussi son compte d'authentification.`)){c(!0),h("");try{const W=me(G,"users",z.uid);(await Se(W)).exists()&&await $a(W);const H=ii();await gs(H,"adminDeleteUser")({uid:z.uid}),s(te=>te.filter(ae=>ae.uid!==z.uid)),h("âœ… Compte supprimÃ© partout.")}catch(W){console.error("delete err:",W),h("âŒ Suppression partielle. VÃ©rifie la console et la Cloud Function.")}finally{c(!1)}}},B=l.useMemo(()=>{const z=new Map;return i.forEach(T=>z.set(T.id,T.nomAgence)),z},[i]),V=l.useMemo(()=>{const z={};for(const T of r){const W=T.agencyId?String(T.agencyId):"__company__";z[W]||(z[W]=[]),z[W].push(T)}return Object.values(z).forEach(T=>T.sort((W,q)=>(W.displayName||"").localeCompare(q.displayName||""))),z},[r]),K=l.useMemo(()=>["__company__",...i.map(T=>T.id)],[i]);return t("div",{className:"p-6 max-w-7xl mx-auto",children:[e("h1",{className:"text-2xl font-bold text-gray-900 mb-6",children:"ParamÃ¨tres de la compagnie â€” Personnel"}),t("div",{className:"mb-8 bg-white p-6 rounded-xl shadow-sm border",children:[e("h2",{className:"text-lg font-semibold mb-4",children:"Ajouter un membre (niveau compagnie)"}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e("input",{value:d,onChange:z=>p(Wa(z.target.value)),placeholder:"Nom complet (Ex. Ayoub Diallo)",className:"border p-3 rounded focus:ring-2"}),e("input",{value:f,onChange:z=>x(z.target.value.trim().toLowerCase()),placeholder:"Email (ex. nom@domaine.com)",type:"email",className:"border p-3 rounded focus:ring-2"}),e("input",{value:b,onChange:z=>P(z.target.value.replace(/\D/g,"")),placeholder:"TÃ©lÃ©phone (ex. 78953098)",inputMode:"numeric",className:"border p-3 rounded focus:ring-2"}),t("select",{value:C,onChange:z=>j(z.target.value),className:"border p-3 rounded focus:ring-2",children:[e("option",{value:"company_accountant",children:"Comptable (compagnie)"}),e("option",{value:"financial_director",children:"Directeur financier (DAF)"}),e("option",{value:"chef_garage",children:"Chef garage (flotte)"})]})]}),e(je,{onClick:N,disabled:o,className:"w-full",children:o?"â³ Traitement...":"Envoyer lâ€™invitation"}),m&&e("p",{className:"mt-3 text-center text-sm text-gray-700",children:m})]}),K.map(z=>{const T=V[z]||[],W=z==="__company__"?"Niveau compagnie":`Agence : ${B.get(z)||z}`;return t("div",{className:"bg-white rounded-xl shadow-sm border mb-6",children:[e("div",{className:"p-4 border-b",children:e("h2",{className:"text-lg font-semibold",children:W})}),T.length===0?e("p",{className:"p-6 text-gray-500",children:"Aucun personnel."}):e("div",{className:"divide-y",children:T.map(q=>t("div",{className:"p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e("div",{children:L===q.uid?t("div",{className:"grid grid-cols-1 sm:grid-cols-4 gap-2",children:[e("input",{value:_,onChange:H=>F(Wa(H.target.value)),className:"border p-2 rounded"}),e("input",{value:D,onChange:H=>k(H.target.value.replace(/\D/g,"")),placeholder:"TÃ©lÃ©phone",inputMode:"numeric",className:"border p-2 rounded"}),t("select",{value:S,onChange:H=>O(H.target.value),className:"border p-2 rounded",children:[e("option",{value:"company_accountant",children:"Comptable (compagnie)"}),e("option",{value:"financial_director",children:"Directeur financier (DAF)"}),e("option",{value:"chef_agence",children:"Chef dâ€™agence"}),e("option",{value:"chef_garage",children:"Chef garage (flotte)"}),e("option",{value:"agency_accountant",children:"Comptable (agence)"}),e("option",{value:"guichetier",children:"Guichetier"}),e("option",{value:"agent_courrier",children:"Agent de courrier"})]}),t("div",{className:"text-xs text-gray-500 flex items-center",children:["Statut:Â ",e("span",{className:q.active?"text-green-600":"text-red-600",children:q.active?"Actif":"DÃ©sactivÃ©"})]})]}):t(Ae,{children:[t("p",{className:"font-semibold text-gray-900",children:[q.displayName," ",t("span",{className:"text-gray-500 text-sm",children:["â€¢ ",wm[q.role]||q.role]})]}),t("p",{className:"text-sm text-gray-600",children:[q.email,q.telephone?` â€¢ ${q.telephone}`:""]}),t("p",{className:"text-xs",children:["Statut :"," ",e("span",{className:q.active?"text-green-600":"text-red-600",children:q.active?"Actif":"DÃ©sactivÃ©"})]})]})}),e("div",{className:"flex flex-wrap gap-2",children:L===q.uid?t(Ae,{children:[e(je,{onClick:U,disabled:o,variant:"primary",size:"sm",children:"Enregistrer"}),e("button",{onClick:()=>M(null),className:"px-3 py-1 rounded border",children:"Annuler"})]}):t(Ae,{children:[e("button",{onClick:()=>v(q),className:"px-3 py-1 rounded border",children:"Modifier"}),q.active?e("button",{onClick:()=>g(q,!1),disabled:o,className:"px-3 py-1 rounded text-white bg-amber-700",children:"DÃ©sactiver"}):e("button",{onClick:()=>g(q,!0),disabled:o,className:"px-3 py-1 rounded text-white bg-green-700",children:"Activer"}),e("button",{onClick:()=>E(q),disabled:o,className:"px-3 py-1 rounded text-white bg-red-600",children:"Supprimer"})]})})]},q.uid))})]},z)})]})},Am=({companyId:a})=>{const[n,r]=l.useState(""),[s,i]=l.useState(""),[u,o]=l.useState({text:"",type:""}),[c,m]=l.useState(!1);return t("div",{className:"bg-white rounded-xl border p-6 max-w-7xl mx-auto",children:[e("h2",{className:"text-xl font-bold mb-6",children:"SÃ©curitÃ©"}),t("div",{className:"space-y-4",children:[e("input",{type:"password",placeholder:"Nouveau mot de passe",value:n,onChange:d=>r(d.target.value),className:"w-full border rounded-lg px-4 py-2"}),e("input",{type:"password",placeholder:"Confirmer le mot de passe",value:s,onChange:d=>i(d.target.value),className:"w-full border rounded-lg px-4 py-2"}),e(je,{onClick:async()=>{if(o({text:"",type:""}),!n||!s){o({text:"Veuillez remplir les deux champs.",type:"error"});return}if(n.length<6){o({text:"Le mot de passe doit contenir au moins 6 caractÃ¨res.",type:"error"});return}if(n!==s){o({text:"Les mots de passe ne correspondent pas.",type:"error"});return}try{if(m(!0),!qn.currentUser){o({text:"Utilisateur non authentifiÃ©.",type:"error"});return}await oi(qn.currentUser,n),o({text:"Mot de passe mis Ã  jour avec succÃ¨s !",type:"success"}),r(""),i("")}catch(d){console.error(d),d.code==="auth/requires-recent-login"?o({text:"Veuillez vous reconnecter avant de modifier le mot de passe.",type:"error"}):o({text:"Erreur lors de la mise Ã  jour du mot de passe.",type:"error"})}finally{m(!1)}},disabled:c,variant:"primary",children:c?"Modification...":"Modifier le mot de passe"}),u.text&&e("p",{className:`text-sm mt-2 ${u.type==="success"?"text-green-600":"text-red-600"}`,children:u.text})]})]})},rs={facebook:"",instagram:"",whatsapp:"",tiktok:"",linkedin:"",youtube:""},Em=({companyId:a})=>{const{user:n}=Pe(),{companyId:r}=De(),s=r??(n==null?void 0:n.companyId)??null,[i,u]=l.useState(rs),[o,c]=l.useState(!0),[m,h]=l.useState(!1),[d,p]=l.useState({text:"",type:""});l.useEffect(()=>{if(!s)return;(async()=>{var b;try{const P=me(G,"companies",s),C=await Se(P);if(C.exists()){const j=C.data();u(j.socialMedia||rs),c(((b=j.footerConfig)==null?void 0:b.showSocialMedia)??!0)}}catch(P){console.error("Erreur chargement rÃ©seaux:",P)}})()},[s]);const f=async()=>{if(s){h(!0),p({text:"Enregistrement...",type:"info"});try{const x=me(G,"companies",s);await Bt(x,{socialMedia:i,footerConfig:{showSocialMedia:o}},{merge:!0}),p({text:"Modifications enregistrÃ©es âœ…",type:"success"})}catch(x){console.error("Erreur enregistrement rÃ©seaux:",x),p({text:"Erreur lors de l'enregistrement âŒ",type:"error"})}finally{h(!1)}}};return s?t("div",{className:"max-w-7xl mx-auto p-6 bg-white rounded-xl shadow-sm border",children:[e("h2",{className:"text-xl font-bold mb-6",children:"RÃ©seaux sociaux & affichage"}),e(va,{children:d.text&&e(Ve.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},className:`p-4 rounded mb-4 text-sm ${d.type==="success"?"bg-green-100 text-green-800":d.type==="error"?"bg-red-100 text-red-800":"bg-blue-100 text-blue-800"}`,children:d.text})}),e("div",{className:"space-y-4",children:["facebook","instagram","whatsapp","tiktok","linkedin","youtube"].map(x=>t("div",{children:[t("label",{className:"block text-sm font-medium mb-1 capitalize",children:["Lien ",x]}),e("input",{type:"url",value:i[x],onChange:b=>u(P=>({...P,[x]:b.target.value})),placeholder:`https://${x}.com/...`,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"})]},x))}),e("div",{className:"mt-6",children:t("label",{className:"inline-flex items-center text-sm",children:[e("input",{type:"checkbox",checked:o,onChange:x=>c(x.target.checked),className:"mr-2"}),"Afficher les icÃ´nes dans le pied de page"]})}),e("div",{className:"flex justify-end mt-6",children:t(je,{onClick:f,disabled:m,variant:"primary",children:[e(ba,{size:18}),m?"Enregistrement...":"Enregistrer"]})})]}):e("div",{className:"p-6 text-red-600",children:"Company ID introuvable."})},km=({companyId:a})=>{const{user:n}=Pe(),[r,s]=l.useState({fr:"",en:""}),[i,u]=l.useState({fr:"",en:""}),[o,c]=l.useState({fr:"",en:""}),[m,h]=l.useState({fr:"",en:""}),[d,p]=l.useState({text:"",type:"info"});l.useEffect(()=>{n!=null&&n.companyId&&(async()=>{const P=me(G,"companies",n.companyId),C=await Se(P);if(C.exists()){const j=C.data();s(j.mentionsLegales||{fr:"",en:""}),u(j.politiqueConfidentialite||{fr:"",en:""}),c(j.conditionsUtilisation||{fr:"",en:""}),h(j.politiqueCookies||{fr:"",en:""})}})()},[n]);const f=async()=>{if(n!=null&&n.companyId){p({text:"Enregistrement en cours...",type:"info"});try{const b=me(G,"companies",n.companyId);await He(b,{mentionsLegales:r,politiqueConfidentialite:i,conditionsUtilisation:o,politiqueCookies:m}),p({text:"Mentions mises Ã  jour avec succÃ¨s.",type:"success"})}catch(b){console.error(b),p({text:"Erreur lors de l'enregistrement.",type:"error"})}}},x=(b,P,C)=>t("div",{children:[e("h3",{className:"text-lg font-semibold mb-2",children:b}),e("label",{className:"text-sm font-medium",children:"ðŸ‡«ðŸ‡· FranÃ§ais"}),e("textarea",{rows:4,className:"w-full mb-4 p-2 border rounded",value:P.fr,onChange:j=>C({...P,fr:j.target.value})}),e("label",{className:"text-sm font-medium",children:"ðŸ‡¬ðŸ‡§ English"}),e("textarea",{rows:4,className:"w-full p-2 border rounded",value:P.en,onChange:j=>C({...P,en:j.target.value})})]});return t("div",{className:"max-w-7xl mx-auto p-6 bg-white rounded shadow",children:[e("h2",{className:"text-xl font-bold mb-6",children:"Mentions lÃ©gales & politiques multilingues"}),e(va,{children:d.text&&e(Ve.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:`p-4 rounded mb-4 ${d.type==="success"?"bg-green-100 text-green-800":d.type==="error"?"bg-red-100 text-red-800":"bg-blue-100 text-blue-800"}`,children:t("div",{className:"flex justify-between items-center",children:[t("div",{className:"flex items-center gap-2",children:[d.type==="success"?e(rt,{}):d.type==="error"?e(Ct,{}):e(ba,{}),e("span",{children:d.text})]}),d.type==="success"&&e("button",{onClick:()=>p({text:"",type:"info"}),className:"text-sm underline",children:"OK"})]})})}),t("div",{className:"space-y-6",children:[x("Mentions lÃ©gales",r,s),x("Politique de confidentialitÃ©",i,u),x("Conditions d'utilisation",o,c),x("Politique de cookies",m,h),e("div",{className:"flex justify-end",children:t(je,{onClick:f,variant:"primary",children:[e(ba,{size:18})," Enregistrer"]})})]})]})},Ja=new Intl.NumberFormat("fr-FR"),Xa={basic:{label:"Basic",color:"bg-gray-100 text-gray-700",icon:e(qt,{className:"h-3.5 w-3.5"})},standard:{label:"Standard",color:"bg-blue-100 text-blue-700",icon:e(qt,{className:"h-3.5 w-3.5"})},priority:{label:"Prioritaire",color:"bg-amber-100 text-amber-700",icon:e(wn,{className:"h-3.5 w-3.5"})},premium:{label:"Premium",color:"bg-purple-100 text-purple-700",icon:e(lr,{className:"h-3.5 w-3.5"})},enterprise:{label:"Enterprise",color:"bg-indigo-100 text-indigo-700",icon:e(Bi,{className:"h-3.5 w-3.5"})}},gl=({companyId:a})=>{const n=Jn(),[r,s]=l.useState(null),[i,u]=l.useState([]),[o,c]=l.useState({agences:0,users:0}),[m,h]=l.useState(!1),[d,p]=l.useState(!0);l.useEffect(()=>{if(!a)return;const L=[],M=me(G,"companies",a),_=st(M,k=>{k.exists()?s({id:k.id,...k.data()}):s(null),p(!1)});L.push(_);const F=ce(Q(G,"plans"),ot("priceMonthly","asc")),D=st(F,k=>{u(k.docs.map(S=>{const O=S.data();return{id:S.id,name:O.name??"",priceMonthly:Number(O.priceMonthly)||0,quotaReservations:Number(O.quotaReservations)||0,digitalFeePercent:Number(O.digitalFeePercent)||0,feeGuichet:Number(O.feeGuichet)||0,minimumMonthly:Number(O.minimumMonthly)||0,maxAgences:Number(O.maxAgences)||1,supportLevel:O.supportLevel||"basic",isTrial:!!O.isTrial,trialDurationDays:Number(O.trialDurationDays)||0,brandingLocked:!!O.brandingLocked,features:{publicPage:!0,onlineBooking:!0,guichet:!0}}}))});return L.push(D),(async()=>{try{const k=Q(G,`companies/${a}/agences`),S=Q(G,`companies/${a}/personnel`),[O,I]=await Promise.all([Er(k),Er(S)]);c({agences:O.data().count,users:I.data().count})}catch{}})(),()=>L.forEach(k=>k())},[a]);const f=l.useMemo(()=>{const L={};return i.forEach(M=>L[M.id]=M),L},[i]),x=l.useMemo(()=>{if(!r)return null;const L=r.planId;if(L&&f[L])return f[L];const M=r.plan;return i.find(_=>_.name===M)||null},[r,f,i]),b=l.useMemo(()=>{if(!r)return i;const L=r.planId,M=r.plan;return i.filter(_=>L?_.id!==L:_.name!==M)},[i,r]),P=async L=>{if(a){h(!0);try{const M=me(Q(G,`companies/${a}/billingRequests`));await Bt(M,{type:"planUpgrade",companyId:a,fromPlanId:(r==null?void 0:r.planId)||null,toPlanId:L.id,toPlanName:L.name,createdAt:Oe(),status:"pending"}),alert("Demande envoyÃ©e avec succÃ¨s.")}finally{h(!1)}}};if(d||!r)return e("div",{className:"p-6",children:"Chargementâ€¦"});const C=r.supportLevel||(x==null?void 0:x.supportLevel)||"basic",j=Xa[C]??Xa.basic;return t("div",{className:"space-y-6",children:[t("section",{className:"bg-white border border-gray-200 rounded-xl shadow-sm p-5",children:[t("div",{className:"flex items-center justify-between mb-4",children:[e("h2",{className:"text-lg font-semibold text-gray-900",children:"Votre plan"}),t("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium ${j.color}`,children:[j.icon,"Support ",j.label]})]}),x?t(Ae,{children:[t("div",{className:"grid md:grid-cols-4 gap-4",children:[t("div",{className:"rounded-lg border border-gray-200 p-4",children:[t("div",{className:"flex items-center gap-2",children:[e("h3",{className:"font-semibold text-gray-900",children:x.name}),x.isTrial&&e("span",{className:"inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700",children:"Essai"})]}),e("div",{className:"text-2xl font-bold mt-1",children:x.priceMonthly===0?e("span",{className:"text-green-600",children:"Gratuit"}):t(Ae,{children:[Ja.format(x.priceMonthly),t("span",{className:"text-sm font-normal text-gray-500",children:[" ",n,"/mois"]})]})})]}),t("div",{className:"rounded-lg border border-gray-200 p-4",children:[e("p",{className:"text-sm text-gray-500",children:"Agences"}),t("p",{className:"text-xl font-bold",children:[o.agences," /"," ",(x.maxAgences??0)===0?"âˆž":x.maxAgences]})]}),t("div",{className:"rounded-lg border border-gray-200 p-4",children:[e("p",{className:"text-sm text-gray-500",children:"Frais canal digital"}),t("p",{className:"text-xl font-bold text-[var(--btn-primary,#FF6600)]",children:[x.digitalFeePercent,"%"]}),e("p",{className:"text-xs text-gray-400 mt-1",children:"sur rÃ©servations en ligne"})]}),t("div",{className:"rounded-lg border border-gray-200 p-4",children:[e("p",{className:"text-sm text-gray-500",children:"Quota rÃ©servations"}),e("p",{className:"text-xl font-bold",children:(x.quotaReservations??0)===0?"IllimitÃ©":Ja.format(x.quotaReservations??0)}),e("p",{className:"text-xs text-gray-400 mt-1",children:"par mois"})]})]}),t("div",{className:"flex flex-wrap gap-2 mt-4 pt-3 border-t border-gray-100",children:[t("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[e(Ht,{className:"h-3 w-3"})," Gestion interne"]}),t("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[e(Ht,{className:"h-3 w-3"})," Page publique"]}),t("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[e(Ht,{className:"h-3 w-3"})," RÃ©servation en ligne"]}),t("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[e(Ht,{className:"h-3 w-3"})," Guichet"]}),t("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[e(Ht,{className:"h-3 w-3"})," Tableau de bord"]})]})]}):e("p",{className:"text-gray-500",children:"Aucun plan actif."})]}),b.length>0&&t("section",{className:"bg-white border border-gray-200 rounded-xl shadow-sm p-5",children:[e("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Autres plans disponibles"}),e("div",{className:"grid md:grid-cols-3 gap-4",children:b.map(L=>{const M=Xa[L.supportLevel]??Xa.basic;return t("div",{className:"rounded-xl border border-gray-200 p-4 flex flex-col",children:[t("div",{className:"flex items-start justify-between mb-2",children:[t("div",{children:[e("h4",{className:"font-semibold text-gray-900",children:L.name}),L.isTrial&&e("span",{className:"inline-flex items-center rounded-full bg-amber-100 px-1.5 py-0.5 text-xs text-amber-700 mt-1",children:"Essai"})]}),t("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium ${M.color}`,children:[M.icon,M.label]})]}),e("div",{className:"text-xl font-bold",children:L.priceMonthly===0?e("span",{className:"text-green-600",children:"Gratuit"}):t(Ae,{children:[Ja.format(L.priceMonthly),t("span",{className:"text-sm font-normal text-gray-500",children:[" ",n,"/mois"]})]})}),t("div",{className:"text-sm text-gray-600 space-y-1 mt-2 flex-1",children:[t("div",{className:"flex justify-between",children:[e("span",{children:"Max agences"}),e("strong",{children:L.maxAgences===0?"âˆž":L.maxAgences})]}),t("div",{className:"flex justify-between",children:[e("span",{children:"Frais digital"}),t("strong",{className:"text-[var(--btn-primary,#FF6600)]",children:[L.digitalFeePercent,"%"]})]}),t("div",{className:"flex justify-between",children:[e("span",{children:"Quota"}),e("strong",{children:(L.quotaReservations??0)===0?"IllimitÃ©":Ja.format(L.quotaReservations??0)})]})]}),e(je,{className:"mt-3",disabled:m,onClick:()=>P(L),variant:"primary",size:"sm",children:"Demander ce plan"})]},L.id)})})]})]})},Ep=Object.freeze(Object.defineProperty({__proto__:null,default:gl},Symbol.toStringTag,{value:"Module"})),Im=[{key:"wifi",label:"Wi-Fi Ã  bord",icon:e(ks,{className:"h-5 w-5"}),description:"Connexion Internet disponible pendant le trajet"},{key:"climatisation",label:"Climatisation",icon:e(Is,{className:"h-5 w-5"}),description:"Bus climatisÃ©"},{key:"usb",label:"Prise USB",icon:e(lr,{className:"h-5 w-5"}),description:"Recharge tÃ©lÃ©phone disponible"},{key:"boisson",label:"Boisson offerte",icon:e(Rs,{className:"h-5 w-5"}),description:"Boisson incluse pendant le voyage"},{key:"sieges_confort",label:"SiÃ¨ges confort",icon:e(_s,{className:"h-5 w-5"}),description:"SiÃ¨ges larges et confortables"},{key:"tv",label:"Ã‰cran / TV",icon:e(Ts,{className:"h-5 w-5"}),description:"Divertissement Ã  bord"},{key:"froid",label:"Eau fraÃ®che",icon:e(Ps,{className:"h-5 w-5"}),description:"Eau fraÃ®che disponible"}],Qa=6,Rm=({companyId:a})=>{const[n,r]=l.useState([]),[s,i]=l.useState(!0),[u,o]=l.useState({text:"",type:""});l.useEffect(()=>{if(!a)return;(async()=>{try{const d=me(G,"companies",a),p=await Se(d);if(p.exists()){const f=p.data();r(f.services||[])}}catch(d){console.error("Erreur chargement services:",d)}finally{i(!1)}})()},[a]);const c=h=>{r(d=>d.includes(h)?d.filter(p=>p!==h):d.length>=Qa?d:[...d,h])},m=async()=>{if(a)try{await He(me(G,"companies",a),{services:n}),o({text:"Services enregistrÃ©s avec succÃ¨s",type:"success"})}catch(h){console.error(h),o({text:"Erreur lors de l'enregistrement",type:"error"})}};return t("div",{className:"bg-white rounded-xl border p-6",children:[e("h2",{className:"text-lg font-semibold mb-2",children:"Services proposÃ©s"}),t("p",{className:"text-sm text-gray-500 mb-6",children:["SÃ©lectionnez les services rÃ©ellement disponibles Ã  bord.",e("br",{}),t("span",{className:"font-medium",children:["Maximum ",Qa," services."]})]}),s?e("p",{className:"text-gray-500",children:"Chargementâ€¦"}):e("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:Im.map(h=>{const d=n.includes(h.key),p=!d&&n.length>=Qa;return t("button",{onClick:()=>c(h.key),disabled:p,className:`flex items-start gap-3 p-4 rounded-xl border transition-all text-left
                  ${d?"border-blue-500 bg-blue-50":"border-gray-200 hover:bg-gray-50"}
                  ${p?"opacity-50 cursor-not-allowed":""}
                `,children:[e("div",{className:`p-2 rounded-lg ${d?"bg-blue-500 text-white":"bg-gray-100 text-gray-600"}`,children:h.icon}),t("div",{children:[e("p",{className:"font-medium text-sm",children:h.label}),e("p",{className:"text-xs text-gray-500",children:h.description})]})]},h.key)})}),t("div",{className:"flex justify-between items-center mt-6",children:[t("p",{className:"text-xs text-gray-500",children:[n.length,"/",Qa," sÃ©lectionnÃ©s"]}),t("button",{onClick:m,className:"flex items-center gap-2 px-5 py-2.5 rounded-lg text-white font-medium",style:{backgroundColor:"#2563eb"},children:[e(ba,{className:"h-4 w-4"}),"Enregistrer"]})]}),e(va,{children:u.text&&t(Ve.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:`mt-4 flex items-center gap-2 text-sm ${u.type==="success"?"text-green-600":"text-red-600"}`,children:[u.type==="success"?e(rt,{className:"h-4 w-4"}):e(Ct,{className:"h-4 w-4"}),u.text]})})]})};async function _m(a,n){const r=Q(G,"companies",a,"imagesBibliotheque");await Na(r,{url:n.url,nom:n.nom,type:n.type??"image",...n.uploadedBy!=null&&{uploadedBy:n.uploadedBy},createdAt:Oe()})}function Tm(){const[a,n]=l.useState(!1),[r,s]=l.useState(null);return{uploadImage:l.useCallback(async(u,o)=>{n(!0),s(null);try{await _m(u,o)}catch(c){throw s(c instanceof Error?c:new Error(String(c))),c}finally{n(!1)}},[]),loading:a,error:r}}const Pm=({label:a,dossier:n,onUpload:r,className:s})=>{const{user:i}=Pe(),{uploadImage:u}=Tm(),o=async c=>{var p,f;const m=c.currentTarget,h=(p=m.files)==null?void 0:p[0];if(!h)return;if(!(i!=null&&i.companyId)){alert("AccÃ¨s refusÃ©");return}const d=new FormData;d.append("file",h),d.append("upload_preset","ml_default"),d.append("public_id",`${n}/${Jl()}`);try{const b=(await Xl.post("https://api.cloudinary.com/v1_1/dj697honl/image/upload",d)).data.secure_url,P=((f=window.prompt("Nom de l'image"))==null?void 0:f.trim())||"Image";await u(i.companyId,{url:b,nom:P,type:"image",uploadedBy:i.uid}),r&&await r(b),alert("âœ… Image ajoutÃ©e avec succÃ¨s")}catch(x){console.error("Upload Cloudinary:",x),alert("âŒ Erreur lors de lâ€™upload")}finally{m&&(m.value="")}};return t("div",{className:`mb-4 ${s||""}`,children:[e("label",{className:"font-semibold block mb-1",children:a}),e("input",{type:"file",accept:"image/*",onChange:o})]})},hl=()=>{const{user:a}=Pe(),{companyId:n}=De(),r=(a==null?void 0:a.companyId)||n,s=!!((a==null?void 0:a.role)==="admin_platforme"&&n),[i,u]=l.useState([]),[o,c]=l.useState(!0);if(!r)return e("div",{className:"p-6",children:t("div",{className:"rounded-lg border p-6 bg-yellow-50 text-yellow-800",children:[e("p",{className:"font-medium",children:"AccÃ¨s non autorisÃ©"}),e("p",{className:"text-sm mt-1",children:"Aucune compagnie associÃ©e Ã  votre compte ou Ã  l'URL."})]})});l.useEffect(()=>{c(!0);const h=Q(G,"companies",r,"imagesBibliotheque"),d=ce(h,ot("createdAt","desc")),p=st(d,f=>{u(f.docs.map(x=>({id:x.id,...x.data()}))),c(!1)},f=>{console.error("Erreur chargement images compagnie:",f),u([]),c(!1)});return()=>p()},[r]);const m=async h=>{if(s){alert("Mode lecture seule : vous ne pouvez pas supprimer d'images.");return}if(window.confirm(`Supprimer lâ€™image Â« ${h.nom||"image"} Â» ?`))try{await $a(me(G,"companies",r,"imagesBibliotheque",h.id))}catch(d){console.error("Erreur suppression image:",d),alert("Erreur lors de la suppression")}};return t("div",{className:"p-6",children:[t("div",{className:"mb-6 flex items-center gap-3 flex-wrap",children:[e(sr,{className:"text-orange-600"}),e("h1",{className:"text-2xl font-bold",children:"BibliothÃ¨que dâ€™images de la compagnie"}),s&&e("span",{className:"ml-2 px-2.5 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full",children:"Mode inspection â€¢ Lecture seule"})]}),!s&&e("div",{className:"mb-6 max-w-sm",children:e(Pm,{label:"Ajouter une image",dossier:`companies/${r}`,collectionName:`companies/${r}/imagesBibliotheque`,onUpload:()=>{}})}),s&&i.length>0&&t("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 flex items-center gap-2",children:[e("span",{children:"ðŸ”"}),e("span",{children:"Vous Ãªtes en mode consultation. Les actions de suppression sont dÃ©sactivÃ©es."})]}),o?e(Dm,{}):i.length===0?e(Mm,{isInspectionMode:s}):e($m,{items:i,onDelete:m,isReadOnly:s})]})},Dm=()=>e("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:Array.from({length:8}).map((a,n)=>e("div",{className:"h-32 w-full rounded-lg bg-gray-100 animate-pulse"},n))}),Mm=({isInspectionMode:a})=>t("div",{className:"border rounded-lg p-10 bg-white text-center text-gray-600",children:[e("div",{className:"flex items-center justify-center mb-3 text-gray-400",children:e(sr,{size:32})}),e("div",{className:"font-semibold",children:"Aucune image"}),e("div",{className:"text-sm text-gray-500 mt-1",children:a?"Cette compagnie n'a pas encore d'images dans sa bibliothÃ¨que.":"Ajoutez votre premiÃ¨re image avec le bouton ci-dessus."})]}),$m=({items:a,onDelete:n,isReadOnly:r})=>e("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:a.map(s=>t("figure",{className:"relative rounded-lg overflow-hidden border bg-white hover:shadow-md transition group",children:[e("img",{src:s.url,alt:s.nom||"image",className:"h-32 w-full object-cover",loading:"lazy"}),!r&&e("button",{onClick:()=>n(s),className:`absolute top-2 right-2 hidden group-hover:flex items-center justify-center\r
                       bg-red-600 text-white rounded-full p-1.5 shadow hover:bg-red-700 transition`,title:"Supprimer",children:e(Ds,{size:14})}),r&&e("div",{className:"absolute top-2 right-2 bg-gray-800/70 text-white text-xs px-2 py-1 rounded-full",children:"Lecture seule"}),s.nom&&e("figcaption",{className:"text-xs px-2 py-1.5 border-t text-gray-600 truncate bg-gray-50",children:s.nom})]},s.id))}),kp=Object.freeze(Object.defineProperty({__proto__:null,default:hl},Symbol.toStringTag,{value:"Module"})),ss=a=>a.toLowerCase().trim().replace(/\s+/g,"_");async function Za(a,n,r){const s=me(G,"companies",a),i=r===null?{[`paymentMethods.${n}`]:ci()}:{[`paymentMethods.${n}`]:r};return He(s,i)}const fl=({companyId:a})=>{const{user:n,company:r}=Pe(),s=a??(n==null?void 0:n.companyId)??"",i=lt(r),{setHeader:u,resetHeader:o}=ut(),[c,m]=l.useState([]),[h,d]=l.useState({name:"",logoUrl:"",merchantNumber:"",defaultPaymentUrl:"",ussdPattern:""}),[p,f]=l.useState(null),[x,b]=l.useState(!1),[P,C]=l.useState(null);l.useEffect(()=>(u({title:"Moyens de paiement",subtitle:c.length>0?`${c.length} mÃ©thode${c.length>1?"s":""} configurÃ©e${c.length>1?"s":""}`:"Aucune mÃ©thode configurÃ©e",bg:`linear-gradient(90deg, ${i.colors.primary} 0%, ${i.colors.secondary} 100%)`,fg:"#fff"}),()=>o()),[c.length,i.colors.primary,i.colors.secondary]),l.useEffect(()=>{(async()=>{if(s)try{const D=ce(Q(G,"paymentMethods"),ne("companyId","==",s)),S=(await ee(D)).docs.map(O=>({id:O.id,...O.data()}));m(S)}catch(D){console.error("Error fetching payment methods:",D),C("Erreur lors du chargement des mÃ©thodes de paiement")}})()},[s]);const j=F=>{const{name:D,value:k}=F.target;d(S=>({...S,[D]:k}))},L=async F=>{if(F.preventDefault(),C(null),!s){C("Aucune compagnie associÃ©e.");return}const{name:D,logoUrl:k,merchantNumber:S,ussdPattern:O,defaultPaymentUrl:I}=h;if(!D||!k||!S||!O){C("Veuillez remplir tous les champs obligatoires.");return}b(!0);try{const $={...h,companyId:s},R=ss(D);if(p)await He(me(G,"paymentMethods",p),$),I&&I.trim()!==""?await Za(s,R,{url:I,logoUrl:k,ussdPattern:O}):await Za(s,R,null),m(w=>w.map(N=>N.id===p?{...$,id:p}:N));else{const w=await Na(Q(G,"paymentMethods"),$);I&&I.trim()!==""&&await Za(s,R,{url:I,logoUrl:k,ussdPattern:O}),m(N=>[{...$,id:w.id},...N])}d({name:"",logoUrl:"",merchantNumber:"",defaultPaymentUrl:"",ussdPattern:""}),f(null)}catch($){console.error("Error saving payment method:",$),C("Erreur lors de la sauvegarde")}finally{b(!1)}},M=F=>{f(F.id||null),d({name:F.name,logoUrl:F.logoUrl,merchantNumber:F.merchantNumber,defaultPaymentUrl:F.defaultPaymentUrl||"",ussdPattern:F.ussdPattern||""})},_=async F=>{if(!(!F.id||!s||!window.confirm(`Supprimer la mÃ©thode ${F.name} ?`)))try{await $a(me(G,"paymentMethods",F.id));const k=ss(F.name);await Za(s,k,null),m(S=>S.filter(O=>O.id!==F.id)),p===F.id&&(f(null),d({name:"",logoUrl:"",merchantNumber:"",defaultPaymentUrl:"",ussdPattern:""}))}catch(k){console.error("Error deleting payment method:",k),C("Erreur lors de la suppression")}};return t("div",{className:"max-w-7xl mx-auto p-6",children:[e("p",{className:"text-sm text-gray-600 mb-6",children:"Ces moyens de paiement (comptes mobile money, etc.) sont dÃ©finis au niveau de la compagnie et servent Ã  encaisser les paiements des rÃ©servations en ligne. Les clients les choisissent lors du dÃ©pÃ´t de preuve de paiement."}),P&&e("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded",children:e("p",{children:P})}),t("div",{className:"bg-white p-6 rounded-xl shadow-sm mb-8 border border-gray-100",children:[e("h2",{className:"text-xl font-semibold mb-4",children:"MÃ©thodes configurÃ©es"}),c.length===0?e("p",{className:"text-gray-500 italic",children:"Aucune mÃ©thode de paiement configurÃ©e"}):e("ul",{className:"divide-y divide-gray-200",children:c.map(F=>e("li",{className:"py-4",children:t("div",{className:"flex items-center justify-between",children:[t("div",{className:"flex items-center space-x-4 min-w-0",children:[e("img",{src:F.logoUrl,alt:F.name,className:"w-12 h-12 object-contain rounded border"}),t("div",{className:"min-w-0",children:[e("h3",{className:"font-medium text-gray-900 truncate",children:F.name}),t("p",{className:"text-sm text-gray-500 truncate",children:["NÂ° Marchand: ",F.merchantNumber]}),F.ussdPattern&&t("p",{className:"text-xs text-green-600 truncate",children:["USSD: ",F.ussdPattern]}),F.defaultPaymentUrl&&t("p",{className:"text-xs text-blue-600 truncate",children:["URL: ",F.defaultPaymentUrl]})]})]}),t("div",{className:"flex space-x-2 shrink-0",children:[e("button",{onClick:()=>M(F),className:"px-3 py-1 text-sm rounded transition",style:{backgroundColor:`${i.colors.primary}15`,color:i.colors.primary},children:"Modifier"}),e("button",{onClick:()=>_(F),className:"px-3 py-1 text-sm bg-red-50 text-red-700 rounded hover:bg-red-100 transition",children:"Supprimer"})]})]})},F.id))})]}),t("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[e("h2",{className:"text-xl font-semibold mb-4",children:p?"Modifier une mÃ©thode":"Ajouter une nouvelle mÃ©thode"}),t("form",{onSubmit:L,className:"space-y-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nom de la mÃ©thode *"}),e("input",{type:"text",name:"name",value:h.name,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-200",placeholder:"Ex: Orange Money",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"URL du logo *"}),e("input",{type:"url",name:"logoUrl",value:h.logoUrl,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-200",placeholder:"https://example.com/logo.png",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"NumÃ©ro de marchand *"}),e("input",{type:"text",name:"merchantNumber",value:h.merchantNumber,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-200",placeholder:"Ex: 770123456",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Code USSD (avec MERCHANT et AMOUNT) *"}),e("input",{type:"text",name:"ussdPattern",value:h.ussdPattern,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-200",placeholder:"Ex: *144*8*MERCHANT*AMOUNT#",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"URL de paiement par dÃ©faut (optionnel)"}),e("input",{type:"url",name:"defaultPaymentUrl",value:h.defaultPaymentUrl,onChange:j,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-200",placeholder:"https://payment.example.com/pay"})]}),e("div",{className:"pt-2",children:e("button",{type:"submit",disabled:x,className:"w-full flex justify-center py-2 px-4 rounded-md text-sm font-medium text-white transition",style:{backgroundColor:x?"#9ca3af":i.colors.primary},children:x?"En coursâ€¦":p?"Mettre Ã  jour":"Enregistrer"})})]})]})]})},Ip=Object.freeze(Object.defineProperty({__proto__:null,default:fl},Symbol.toStringTag,{value:"Module"})),yl="companyBanks";function bl(a){return Q(G,`companies/${a}/${yl}`)}function Lm(a,n){return me(G,`companies/${a}/${yl}/${n}`)}async function jm(a){return(await ee(bl(a))).docs.filter(r=>r.data().isActive!==!1).map(r=>({id:r.id,...r.data()}))}async function Fm(a,n){const r=fe.now(),s=await Na(bl(a),{...n,isActive:n.isActive??!0,createdAt:r,updatedAt:Oe()});return await Qc(a,s.id,n.name,n.currency),s.id}async function xl(a,n,r){const s=Lm(a,n),i={updatedAt:Oe()};if(r.name!==void 0&&(i.name=r.name),r.iban!==void 0&&(i.iban=r.iban),r.description!==void 0&&(i.description=r.description),r.currency!==void 0&&(i.currency=r.currency),r.isActive!==void 0&&(i.isActive=r.isActive),await He(s,i),r.name!=null){const u=la(a,`company_bank_${n}`);if((await Se(u)).exists()){const{updateDoc:c}=await vt(async()=>{const{updateDoc:m}=await import("./firebase-CURBI7X6.js").then(h=>h.a3);return{updateDoc:m}},__vite__mapDeps([0,1,2]));await c(u,{accountName:r.name,updatedAt:Oe()})}}}async function Om(a,n){await xl(a,n,{isActive:!1});const r=la(a,`company_bank_${n}`);if((await Se(r)).exists()){const{updateDoc:i}=await vt(async()=>{const{updateDoc:u}=await import("./firebase-CURBI7X6.js").then(o=>o.a3);return{updateDoc:u}},__vite__mapDeps([0,1,2]));await i(r,{isActive:!1,updatedAt:Oe()})}}const qm=({companyId:a})=>{const{company:n}=Pe(),r=lt(n),[s,i]=l.useState([]),[u,o]=l.useState("XOF"),[c,m]=l.useState(!0),[h,d]=l.useState(null),[p,f]=l.useState(null),[x,b]=l.useState(!1),[P,C]=l.useState(null),[j,L]=l.useState({name:"",iban:"",description:""}),M=async()=>{if(a){m(!0),d(null);try{const[S,O]=await Promise.all([Se(me(G,"companies",a)),jm(a)]);if(S.exists()){const I=S.data();o(I.devise||"XOF")}i(O)}catch(S){console.error(S),d("Impossible de charger les banques.")}finally{m(!1)}}};l.useEffect(()=>{M()},[a]);const _=()=>{C(null),L({name:"",iban:"",description:""}),b(!0)},F=S=>{C(S.id),L({name:S.name,iban:S.iban||"",description:S.description||""}),b(!0)},D=async S=>{if(S.preventDefault(),!!j.name.trim()){d(null),f(null);try{P?(await xl(a,P,{name:j.name.trim(),iban:j.iban.trim()||null,description:j.description.trim()||null}),f("Banque mise Ã  jour.")):(await Fm(a,{name:j.name.trim(),iban:j.iban.trim()||null,description:j.description.trim()||null,currency:u,isActive:!0}),f("Banque ajoutÃ©e.")),b(!1),await M()}catch(O){console.error(O),d("Erreur lors de l'enregistrement.")}}},k=async(S,O)=>{if(window.confirm(`DÃ©sactiver la banque Â« ${O} Â» ? Les comptables ne pourront plus la sÃ©lectionner pour de nouveaux virements.`)){d(null);try{await Om(a,S),f("Banque dÃ©sactivÃ©e."),await M()}catch(I){console.error(I),d("Erreur lors de la dÃ©sactivation.")}}};return t("div",{className:"max-w-3xl",children:[t("p",{className:"text-sm text-gray-600 mb-6",children:["Les banques dÃ©finies ici sont au niveau de la compagnie. Les comptables des agences pourront choisir l'une d'elles lors d'un ",e("strong",{children:"transfert caisse â†’ banque"}),", afin d'assurer la traÃ§abilitÃ© des fonds."]}),h&&e("div",{className:"mb-4 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm",children:h}),p&&e("div",{className:"mb-4 p-4 rounded-lg bg-green-50 border border-green-200 text-green-800 text-sm",children:p}),t("div",{className:"flex items-center justify-between mb-4",children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:"Banques de la compagnie"}),t("button",{type:"button",onClick:_,className:"inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-white shadow-sm",style:{backgroundColor:r.colors.primary},children:[e(vn,{className:"w-4 h-4"}),"Ajouter une banque"]})]}),c?e("div",{className:"py-8 text-center text-gray-500",children:"Chargementâ€¦"}):s.length===0?e("div",{className:"bg-white rounded-xl border border-gray-200 p-8 text-center text-gray-500",children:"Aucune banque configurÃ©e. Ajoutez les comptes bancaires de la compagnie pour que les comptables d'agence puissent enregistrer les virements caisse â†’ banque."}):e("ul",{className:"space-y-3",children:s.map(S=>t("li",{className:"bg-white rounded-xl border border-gray-200 p-4 flex items-center justify-between",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"w-10 h-10 rounded-lg flex items-center justify-center text-white",style:{backgroundColor:r.colors.primary},children:e(St,{className:"w-5 h-5"})}),t("div",{children:[e("div",{className:"font-medium text-gray-900",children:S.name}),S.iban&&e("div",{className:"text-sm text-gray-500",children:S.iban}),S.description&&e("div",{className:"text-sm text-gray-400",children:S.description})]})]}),t("div",{className:"flex items-center gap-2",children:[e("button",{type:"button",onClick:()=>F(S),className:"p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-gray-700",title:"Modifier",children:e(rr,{className:"w-4 h-4"})}),e("button",{type:"button",onClick:()=>k(S.id,S.name),className:"p-2 rounded-lg text-gray-500 hover:bg-red-50 hover:text-red-600",title:"DÃ©sactiver",children:e(Ds,{className:"w-4 h-4"})})]})]},S.id))}),x&&e("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:t("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full p-6",children:[e("h4",{className:"text-lg font-semibold text-gray-900 mb-4",children:P?"Modifier la banque":"Ajouter une banque"}),t("form",{onSubmit:D,className:"space-y-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nom de la banque *"}),e("input",{type:"text",value:j.name,onChange:S=>L(O=>({...O,name:S.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-offset-0",style:{outlineColor:r.colors.primary},placeholder:"Ex: BICIS - Compte principal",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"IBAN (optionnel)"}),e("input",{type:"text",value:j.iban,onChange:S=>L(O=>({...O,iban:S.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-offset-0",style:{outlineColor:r.colors.primary},placeholder:"Ex: SN12 1234 5678 9012 3456 7890 123"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description (optionnel)"}),e("input",{type:"text",value:j.description,onChange:S=>L(O=>({...O,description:S.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-offset-0",style:{outlineColor:r.colors.primary},placeholder:"Ex: Compte principal siÃ¨ge"})]}),t("div",{className:"flex gap-3 pt-2",children:[e("button",{type:"button",onClick:()=>b(!1),className:"flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Annuler"}),e("button",{type:"submit",className:"flex-1 px-4 py-2 rounded-lg text-white font-medium",style:{backgroundColor:r.colors.primary},children:P?"Enregistrer":"Ajouter"})]})]})]})})]})},Um=[{key:"agences",label:"Agences"},{key:"plan",label:"Plan & abonnement"},{key:"vitrine",label:"Vitrine publique"},{key:"personnel",label:"Personnel"},{key:"securite",label:"SÃ©curitÃ©"},{key:"reseaux",label:"RÃ©seaux sociaux"},{key:"legaux",label:"Mentions & politique"},{key:"services",label:"Services proposÃ©s"},{key:"medias",label:"MÃ©dias"},{key:"moyens-paiement",label:"Moyens de paiement"},{key:"banques",label:"Banques"}],Bm=()=>{const[a,n]=l.useState("vitrine"),{user:r,company:s}=Pe(),{companyId:i}=De(),u=i??(r==null?void 0:r.companyId)??"",[o,c]=l.useState(null),[m,h]=l.useState(!0),d=lt(o||s||void 0),{setHeader:p,resetHeader:f}=ut();l.useEffect(()=>{if(!u){c(null),h(!1);return}(async()=>{try{const P=me(G,"companies",u),C=await Se(P);C.exists()?c({id:C.id,...C.data()}):c(null)}catch(P){console.error("Erreur chargement compagnie:",P),c(null)}finally{h(!1)}})()},[u]),l.useEffect(()=>(p({title:"ParamÃ¨tres de la compagnie",bg:`linear-gradient(90deg, ${d.colors.primary} 0%, ${d.colors.secondary} 100%)`,fg:"#fff"}),()=>f()),[p,f,d.colors.primary,d.colors.secondary]);const x=()=>{switch(a){case"agences":return e(pl,{});case"plan":return e(gl,{companyId:u});case"vitrine":return e(Nm,{companyId:u});case"services":return e(Rm,{companyId:u});case"personnel":return e(Sm,{companyId:u});case"securite":return e(Am,{companyId:u});case"reseaux":return e(Em,{companyId:u});case"legaux":return e(km,{companyId:u});case"medias":return e(hl,{});case"moyens-paiement":return e(fl,{companyId:u});case"banques":return e(qm,{companyId:u});default:return null}};return t("div",{className:"max-w-7xl mx-auto p-4 md:p-6",children:[e("div",{className:"flex flex-wrap gap-2 md:gap-3 mb-6",children:Um.map(b=>{const P=a===b.key;return e("button",{onClick:()=>n(b.key),className:["px-4 py-2 rounded-full text-sm font-medium transition-all border",P?"shadow-sm":"hover:bg-gray-50"].join(" "),style:{backgroundColor:P?d.colors.primary:"#fff",color:P?"#fff":"#1f2937",borderColor:P?`${d.colors.primary}55`:"#e5e7eb"},children:b.label},b.key)})}),m?e("div",{className:"bg-white rounded-xl border p-8 text-center text-gray-600",children:"Chargementâ€¦"}):x()]})},Rp=Object.freeze(Object.defineProperty({__proto__:null,default:Bm},Symbol.toStringTag,{value:"Module"})),Fn=a=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"XOF",maximumFractionDigits:0}).format(a),Gm=(...a)=>a.filter(Boolean).join(" "),zm=()=>{const{user:a,company:n}=Pe(),{companyId:r}=De(),s=r??(a==null?void 0:a.companyId)??"",i=lt(n),{setHeader:u,resetHeader:o}=ut(),[c,m]=l.useState("month"),[h,d]=l.useState(""),[p,f]=l.useState(""),{start:x,end:b,label:P}=l.useMemo(()=>{const q=qa(c,new Date,h||void 0,p||void 0);return{start:q.start,end:q.end,label:zs(c,q,h||void 0,p||void 0)}},[c,h,p]),[C,j]=l.useState([]),[L,M]=l.useState([]),[_,F]=l.useState(null),[D,k]=l.useState({agences:!0,reservations:!0}),[S,O]=l.useState(!1),[I,$]=l.useState(""),[R,w]=l.useState(""),[N,g]=l.useState("tous"),[v,U]=l.useState(1);l.useEffect(()=>{if(!s)return;(async()=>{k(te=>({...te,agences:!0}));const le=(await ee(Q(G,"companies",s,"agences"))).docs.map(te=>({id:te.id,nom:te.data().nomAgence||te.data().nom||te.data().ville||"Agence",ville:te.data().ville,pays:te.data().pays}));j(le),k(te=>({...te,agences:!1}))})()},[s]),l.useEffect(()=>{if(!s||C.length===0)return;k(le=>({...le,reservations:!0}));const q=[],H={};return C.forEach(le=>{const te=Q(G,"companies",s,"agences",le.id,"reservations"),ae=ce(te,ne("createdAt",">=",fe.fromDate(x)),ne("createdAt","<=",fe.fromDate(b))),de=st(ae,re=>{const pe=re.docs.map(y=>{var J,se;const A=y.data();return{id:y.id,agencyId:le.id,nomClient:A.nomClient,telephone:A.telephone,montant:A.montant||0,canal:(A.canal||"").toLowerCase().includes("ligne")?"en ligne":"guichet",statut:A.statut,depart:A.depart||"",arrivee:A.arrivee||"",createdAt:((se=(J=A.createdAt)==null?void 0:J.toDate)==null?void 0:se.call(J))||null}});H[le.id]=pe;const he=Object.keys(H).map(y=>({agencyId:y,reservations:H[y]}));M(he),k(y=>({...y,reservations:!1}))});q.push(de)}),()=>{q.forEach(le=>le())}},[s,C,x,b]);const E=q=>C.find(H=>H.id===q)||null,B=q=>{const H=E(q||null);if(!H)return"Agence inconnue";const le=H.ville&&H.pays?` Â· ${H.ville}, ${H.pays}`:H.ville?` Â· ${H.ville}`:"";return`${H.nom}${le}`},V=l.useMemo(()=>{var ae;let H=((ae=L.find(de=>de.agencyId===_))==null?void 0:ae.reservations)||[];I&&(H=H.filter(de=>(de.depart||"").toLowerCase().includes(I.toLowerCase()))),R&&(H=H.filter(de=>(de.arrivee||"").toLowerCase().includes(R.toLowerCase()))),N!=="tous"&&(H=H.filter(de=>(de.canal||"").toLowerCase()===N));const le={};for(const de of H){const re=`${de.depart||"?"} â†’ ${de.arrivee||"?"}`;le[re]||(le[re]={trajet:re,billets:0,ca:0,guichet:0,enLigne:0,lastSale:null}),le[re].billets+=1,le[re].ca+=de.montant||0,de.canal==="guichet"?le[re].guichet+=1:le[re].enLigne+=1,(!le[re].lastSale||de.createdAt&&de.createdAt>le[re].lastSale)&&(le[re].lastSale=de.createdAt||null)}return Object.values(le).sort((de,re)=>re.ca-de.ca)},[L,_,I,R,N]),K=Math.ceil(V.length/10),z=V.slice((v-1)*10,v*10),T=l.useMemo(()=>{var de;const q=((de=L.find(re=>re.agencyId===_))==null?void 0:de.reservations)||[],H=q.reduce((re,pe)=>re+(pe.montant||0),0),le=q.length,te=q.filter(re=>re.canal==="guichet").length,ae=q.filter(re=>re.canal==="en ligne").length;return{ca:H,billets:le,guichet:te,enLigne:ae}},[L,_]),W=()=>{var de;const q=V;if(q.length===0)return;const H=`Trajet,Billets,Guichet,En ligne,CA
`,le=q.map(re=>[`"${re.trajet}"`,re.billets,re.guichet,re.enLigne,re.ca].join(",")).join(`
`),te=new Blob([H+le],{type:"text/csv;charset=utf-8;"}),ae=((de=E(_||""))==null?void 0:de.nom)||"agence";ti.saveAs(te,`reservations-agregees-${ae}-${new Date().toISOString().slice(0,10)}.csv`)};return l.useEffect(()=>{const q=t(Ae,{children:[t("button",{onClick:()=>O(H=>!H),className:"ml-2 flex items-center px-3 py-1 rounded-full text-sm border bg-white/10 text-white hover:bg-white/20 border-white/30",title:"Filtres & pÃ©riode personnalisÃ©e",children:[e(ei,{className:"mr-2"}),"Filtres"]}),_&&t(Ae,{children:[t("button",{onClick:W,className:"flex items-center px-3 py-1 rounded-full text-sm border bg-white/10 text-white hover:bg-white/20 border-white/30",children:[e(Cr,{className:"mr-2"}),"Exporter"]}),t("button",{onClick:()=>window.print(),className:"flex items-center px-3 py-1 rounded-full text-sm bg-white text-gray-900 hover:bg-gray-100",children:[e(Sr,{className:"mr-2"}),"Imprimer"]})]})]});return u({title:`RÃ©servations â€” ${P}`,subtitle:_?B(_):"",actions:q,bg:`linear-gradient(90deg, ${i.colors.primary} 0%, ${i.colors.secondary} 100%)`,fg:"#fff"}),()=>o()},[P,_,c,S,i.colors.primary,i.colors.secondary]),s?e("div",{className:"min-h-screen p-4 md:p-8",style:{background:"linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%)"},children:t("div",{className:"max-w-7xl mx-auto",children:[t("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6",children:[e("p",{className:"text-sm text-gray-600",children:Qn(new Date)}),e(ir,{period:c,customStart:h||void 0,customEnd:p||void 0,onPeriodChange:(q,H,le)=>{m(q),d(H??""),f(le??""),U(1),F(null)}})]}),S&&_&&e("div",{className:"rounded-xl p-4 mb-6 border shadow-sm",style:{background:"rgba(255,255,255,0.55)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderColor:"rgba(0,0,0,0.08)"},children:t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"DÃ©part"}),e("input",{placeholder:"ex: Bamako",value:I,onChange:q=>{$(q.target.value),U(1)},className:"w-full p-2 border rounded-md bg-white/70"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"ArrivÃ©e"}),e("input",{placeholder:"ex: SÃ©gou",value:R,onChange:q=>{w(q.target.value),U(1)},className:"w-full p-2 border rounded-md bg-white/70"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Canal"}),t("select",{value:N,onChange:q=>{g(q.target.value),U(1)},className:"w-full p-2 border rounded-md bg-white/70",children:[e("option",{value:"tous",children:"Tous"}),e("option",{value:"guichet",children:"Guichet"}),e("option",{value:"en ligne",children:"En ligne"})]})]})]})}),D.agences||D.reservations?e("div",{className:"flex justify-center items-center h-64",children:e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):t(Ae,{children:[e("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 mb-8",children:L.map(q=>{const H=E(q.agencyId),le=q.reservations.reduce((pe,he)=>pe+(he.montant||0),0),te=q.reservations.length,ae=q.reservations.filter(pe=>pe.canal==="guichet").length,de=te-ae,re=te?Math.round(ae/te*100):0;return t("div",{onClick:()=>{F(_===q.agencyId?null:q.agencyId),U(1)},className:Gm("relative p-6 rounded-xl cursor-pointer transition-all","border shadow-sm hover:shadow-md"),style:{background:"rgba(255,255,255,0.58)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderColor:_===q.agencyId?i.colors.secondary:"rgba(0,0,0,0.08)"},children:[e("div",{className:"absolute left-0 right-0 top-0 h-1.5 rounded-t-2xl",style:{background:`linear-gradient(90deg, ${i.colors.secondary}, ${i.colors.accent})`}}),t("div",{className:"flex items-start justify-between",children:[t("div",{children:[e("h2",{className:"text-base font-semibold text-gray-900",children:(H==null?void 0:H.nom)||"Agence"}),t("p",{className:"text-xs text-gray-500",children:[H!=null&&H.ville?H.ville:""," ",H!=null&&H.pays?`â€¢ ${H.pays}`:""]})]}),t("span",{className:"text-xs px-2 py-0.5 rounded-full",style:{backgroundColor:`${i.colors.secondary}15`,color:i.colors.secondary},children:[te," billets"]})]}),t("div",{className:"mt-4",children:[e("div",{className:"text-2xl font-bold",children:Fn(le)}),e("p",{className:"text-xs text-gray-500",children:"CA sur la pÃ©riode"})]}),t("div",{className:"mt-4",children:[t("div",{className:"flex justify-between text-xs text-gray-600 mb-1",children:[e("span",{children:"Guichet"}),t("span",{children:[ae,"/",te," (",re,"%)"]})]}),e("div",{className:"w-full h-2 bg-gray-200/70 rounded-full overflow-hidden",children:e("div",{className:"h-full",style:{width:`${re}%`,background:`linear-gradient(90deg, ${i.colors.primary}, ${i.colors.secondary})`}})}),t("div",{className:"flex justify-between text-xs text-gray-600 mt-1",children:[e("span",{children:"En ligne"}),t("span",{children:[de,"/",te," (",100-re,"%)"]})]})]})]},q.agencyId)})}),_&&t("div",{className:"rounded-xl border shadow-sm overflow-hidden",style:{background:"rgba(255,255,255,0.58)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderColor:"rgba(0,0,0,0.08)"},children:[e("div",{className:"p-6 border-b",children:t("div",{className:"flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3",children:[t("div",{children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:B(_)}),t("p",{className:"text-sm text-gray-600",children:[T.billets," billets Â·"," ",e("span",{className:"font-medium",children:Fn(T.ca)})," ","Â· Guichet ",T.guichet," â€” En ligne ",T.enLigne]})]}),t("div",{className:"flex items-center gap-2",children:[t("button",{onClick:W,className:"flex items-center px-3 py-1 rounded-full text-sm border bg-white hover:bg-gray-50",children:[e(Cr,{className:"mr-2"}),"Exporter (agrÃ©gÃ©)"]}),t("button",{onClick:()=>window.print(),className:"flex items-center px-3 py-1 rounded-full text-sm",style:{backgroundColor:i.colors.primary,color:"#fff"},children:[e(Sr,{className:"mr-2"}),"Imprimer"]})]})]})}),e("div",{className:"overflow-x-auto",children:t("table",{className:"min-w-full divide-y divide-gray-200",children:[e("thead",{className:"bg-white/60 backdrop-blur",children:t("tr",{children:[e("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Trajet"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Billets"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Guichet"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"En ligne"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"CA"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"DerniÃ¨re vente"})]})}),e("tbody",{className:"bg-white/40 backdrop-blur divide-y divide-gray-100",children:z.length===0?e("tr",{children:e("td",{colSpan:6,className:"px-6 py-8 text-center text-gray-500",children:"Aucune donnÃ©e pour cette agence et ces filtres."})}):z.map(q=>t("tr",{className:"hover:bg-white/60",children:[e("td",{className:"px-6 py-3 text-sm font-medium text-gray-900",children:q.trajet}),e("td",{className:"px-6 py-3 text-sm text-right",children:q.billets}),e("td",{className:"px-6 py-3 text-sm text-right",children:q.guichet}),e("td",{className:"px-6 py-3 text-sm text-right",children:q.enLigne}),e("td",{className:"px-6 py-3 text-sm text-right",children:Fn(q.ca)}),e("td",{className:"px-6 py-3 text-sm text-right text-gray-600",children:q.lastSale?q.lastSale.toLocaleDateString("fr-FR"):"â€”"})]},q.trajet))})]})}),V.length>10&&t("div",{className:"px-6 py-4 border-t flex items-center justify-between bg-white/60 backdrop-blur",children:[t("button",{onClick:()=>U(q=>Math.max(1,q-1)),disabled:v===1,className:"flex items-center px-3 py-1 border rounded-full text-sm bg-white hover:bg-gray-50 disabled:opacity-50",children:[e(Ql,{className:"mr-1"}),"PrÃ©cÃ©dent"]}),t("span",{className:"text-sm text-gray-700",children:["Page ",v," sur ",K]}),t("button",{onClick:()=>U(q=>q+1),disabled:v===K,className:"flex items-center px-3 py-1 border rounded-full text-sm bg-white hover:bg-gray-50 disabled:opacity-50",children:["Suivant",e(Zl,{className:"ml-1"})]})]})]})]})]})}):t("div",{className:"p-6",children:[e("h1",{className:"text-xl font-semibold mb-2",children:"RÃ©servations"}),e("p",{className:"text-sm text-muted-foreground",children:"Impossible d'identifier la compagnie (companyId manquant)."})]})},_p=Object.freeze(Object.defineProperty({__proto__:null,default:zm},Symbol.toStringTag,{value:"Module"})),dn=a=>new Intl.NumberFormat("fr-FR").format(a||0),ls=(a=new Date)=>new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0,0),en=(a=new Date)=>new Date(a.getFullYear(),a.getMonth(),a.getDate(),23,59,59,999),Vm=(a,n)=>{const r=new Date(a);return r.setDate(r.getDate()+n),r},is=(a=new Date)=>new Date(a.getFullYear(),a.getMonth(),1,0,0,0,0),Hm=()=>{const{user:a}=Pe(),n=Be(),r=Qe(),[s,i]=l.useState("dashboard"),[u,o]=l.useState("mois"),[c,m]=l.useState(""),[h,d]=l.useState(""),[p,f]=l.useState(!1),[x,b]=l.useState(null),[P,C]=l.useState([]),[j,L]=l.useState([]),[M,_]=l.useState([]),[F,D]=l.useState([]),[k,S]=l.useState([]),[O,I]=l.useState(null),[$,R]=l.useState(null),[w,N]=l.useState("company_viewer"),{from:g,to:v,label:U}=l.useMemo(()=>{const T=new Date;if(u==="jour")return{from:ls(T),to:en(T),label:"Aujourd'hui"};if(u==="semaine")return{from:ls(Vm(T,-6)),to:en(T),label:"7 derniers jours"};if(u==="mois")return{from:is(T),to:en(T),label:"Mois en cours"};const W=c?new Date(`${c}T00:00:00`):is(T),q=h?new Date(`${h}T23:59:59`):en(T);return{from:W,to:q,label:"PÃ©riode personnalisÃ©e"}},[u,c,h]);l.useEffect(()=>{if(!a)return;const T=a.roles||[];T.includes("ceo")?N("ceo"):T.includes("financial_director")?N("financial_director"):T.includes("company_accountant")?N("company_accountant"):T.includes("company_viewer")&&N("company_viewer"),["ceo","financial_director","company_accountant","company_viewer"].includes(w)||n("/unauthorized")},[a,w,n]),l.useEffect(()=>{(async()=>{if(a!=null&&a.companyId)try{const W=(await ee(Q(G,"companies",a.companyId,"agences"))).docs.map(q=>{const H=q.data();return{id:q.id,nom:H.nomAgence||H.nom||"Agence",ville:H.ville||H.city||""}});C(W)}catch(T){console.error("Erreur chargement agences:",T)}})()},[a==null?void 0:a.companyId]);const E=l.useCallback(async()=>{if(a!=null&&a.companyId){f(!0);try{const T=[];for(const W of P){const q=Q(G,"companies",a.companyId,"agences",W.id,"reservations"),H=ce(q,ne("createdAt",">=",fe.fromDate(g)),ne("createdAt","<=",fe.fromDate(v))),le=Q(G,"companies",a.companyId,"agences",W.id,"cashReceipts"),te=ce(le,ne("createdAt",">=",fe.fromDate(g)),ne("createdAt","<=",fe.fromDate(v))),ae=Q(G,"companies",a.companyId,"agences",W.id,"cashMovements"),de=ce(ae,ne("createdAt",">=",fe.fromDate(g)),ne("createdAt","<=",fe.fromDate(v))),[re,pe,he]=await Promise.all([ee(H),ee(te),ee(de)]);let y=0,A=0,J=0,se=0;re.forEach(at=>{const Ge=at.data(),qe=String(Ge.canal||"").toLowerCase(),pt=Number(Ge.montant||0),Nt=(Ge.seatsGo||0)+(Ge.seatsReturn||0);J+=1,se+=Nt,qe==="guichet"||qe===""?y+=pt:qe==="en_ligne"&&(A+=pt)});let ye=0,X=0,ge=0;pe.forEach(at=>{const Ge=at.data();ye+=Number(Ge.cashReceived||0),X+=Number(Ge.mmExpected||0)});let Ee=0,Ne=0;he.forEach(at=>{const Ge=at.data(),qe=String(Ge.kind||""),pt=Number(Ge.amount||0);qe==="entree_manual"?Ee+=pt:(qe==="depense"||qe==="transfert_banque")&&(Ne+=pt)});const ie=y+A,Ie=ye+Ee-Ne,Me=y-ye;let Ke="ok";Math.abs(Me)>1e4&&(Ke="warning"),(Math.abs(Me)>5e4||Ie<0)&&(Ke="danger");const Ue=Math.abs(Me)>5e4||Ie<0||ie===0&&P.length>1;T.push({agenceId:W.id,agenceNom:W.nom,ville:W.ville,ventesGuichet:y,ventesEnLigne:A,ventesTotal:ie,especesRecues:ye,mobileMoneyRecu:X,onlineRecu:A,entreesManuelles:Ee,sortiesAgence:Ne,soldeCaisse:Ie,ecartEspeces:Me,statutCaisse:Ke,nbReservations:J,nbBillets:se,hasAlert:Ue})}L(T),V(T)}catch(T){console.error("Erreur chargement performance:",T)}finally{f(!1)}}},[a==null?void 0:a.companyId,P,g,v]),B=l.useCallback(async()=>{if(a!=null&&a.companyId)try{const T=Q(G,"companies",a.companyId,"companyMovements"),W=ce(T,ne("createdAt",">=",fe.fromDate(g)),ne("createdAt","<=",fe.fromDate(v)),ot("createdAt","desc")),H=(await ee(W)).docs.map(le=>({id:le.id,...le.data()}));_(H)}catch(T){console.error("Erreur chargement mouvements compagnie:",T)}},[a==null?void 0:a.companyId,g,v]),V=T=>{const W=[],q=fe.now();T.forEach(H=>{Math.abs(H.ecartEspeces)>5e4&&W.push({id:`${H.agenceId}-ecart`,type:"caisse",severity:"high",title:"Ã‰cart espÃ¨ces Ã©levÃ©",message:`Ã‰cart de ${r(H.ecartEspeces)} entre ventes et caisse`,agencyId:H.agenceId,agencyName:H.agenceNom,createdAt:q}),H.soldeCaisse<0&&W.push({id:`${H.agenceId}-solde`,type:"caisse",severity:"high",title:"Solde caisse nÃ©gatif",message:`Caisse en nÃ©gatif de ${r(Math.abs(H.soldeCaisse))}`,agencyId:H.agenceId,agencyName:H.agenceNom,createdAt:q}),H.ventesTotal===0&&P.length>1&&W.push({id:`${H.agenceId}-ventes`,type:"ventes",severity:"medium",title:"Aucune vente aujourd'hui",message:`L'agence ${H.agenceNom} n'a enregistrÃ© aucune vente`,agencyId:H.agenceId,agencyName:H.agenceNom,createdAt:q})}),D(W)},K=l.useCallback(async T=>{if(a!=null&&a.companyId){b(T),I(T);try{const W=P.find(q=>q.id===T);if(!W)return;R({...W,performance:j.find(q=>q.agenceId===T)})}catch(W){console.error("Erreur chargement dÃ©tails agence:",W)}finally{b(null)}}},[a==null?void 0:a.companyId,P,j]),z=l.useMemo(()=>j.length===0?{ventesTotal:0,ventesGuichet:0,ventesEnLigne:0,especesRecues:0,mobileMoneyRecu:0,onlineRecu:0,soldeTotalCaisse:0,ecartTotalEspeces:0,nbReservations:0,nbBillets:0}:j.reduce((T,W)=>({ventesTotal:T.ventesTotal+W.ventesTotal,ventesGuichet:T.ventesGuichet+W.ventesGuichet,ventesEnLigne:T.ventesEnLigne+W.ventesEnLigne,especesRecues:T.especesRecues+W.especesRecues,mobileMoneyRecu:T.mobileMoneyRecu+W.mobileMoneyRecu,onlineRecu:T.onlineRecu+W.onlineRecu,soldeTotalCaisse:T.soldeTotalCaisse+W.soldeCaisse,ecartTotalEspeces:T.ecartTotalEspeces+W.ecartEspeces,nbReservations:T.nbReservations+W.nbReservations,nbBillets:T.nbBillets+W.nbBillets}),{ventesTotal:0,ventesGuichet:0,ventesEnLigne:0,especesRecues:0,mobileMoneyRecu:0,onlineRecu:0,soldeTotalCaisse:0,ecartTotalEspeces:0,nbReservations:0,nbBillets:0}),[j]);return l.useEffect(()=>{a!=null&&a.companyId&&P.length>0&&(E(),B())},[a==null?void 0:a.companyId,P,g,v,E,B]),t("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100",children:[e("div",{className:"sticky top-0 z-30 bg-white/95 backdrop-blur-sm border-b",children:e("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 py-4",children:t("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center",children:e(St,{className:"h-5 w-5 text-white"})}),t("div",{children:[e("h1",{className:"text-xl font-bold text-gray-900",children:"ContrÃ´le & Audit"}),t("p",{className:"text-sm text-gray-600",children:["Sessions Â· RÃ©conciliations Â· Validations CEO Â· Anomalies â€” ",U]})]}),e("div",{className:"ml-4 px-3 py-1 rounded-full bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100",children:e("span",{className:"text-xs font-medium text-blue-700 capitalize",children:w.replace("_"," ")})})]}),t("div",{className:"flex items-center gap-3",children:[t("div",{className:"flex items-center gap-2 bg-gray-100 rounded-lg p-1",children:[e("button",{className:`px-3 py-1.5 rounded text-sm font-medium ${u==="jour"?"bg-white shadow-sm text-gray-900":"text-gray-600 hover:text-gray-900"}`,onClick:()=>o("jour"),children:"Jour"}),e("button",{className:`px-3 py-1.5 rounded text-sm font-medium ${u==="semaine"?"bg-white shadow-sm text-gray-900":"text-gray-600 hover:text-gray-900"}`,onClick:()=>o("semaine"),children:"Semaine"}),e("button",{className:`px-3 py-1.5 rounded text-sm font-medium ${u==="mois"?"bg-white shadow-sm text-gray-900":"text-gray-600 hover:text-gray-900"}`,onClick:()=>o("mois"),children:"Mois"}),e("button",{className:`px-3 py-1.5 rounded text-sm font-medium ${u==="custom"?"bg-white shadow-sm text-gray-900":"text-gray-600 hover:text-gray-900"}`,onClick:()=>o("custom"),children:"Perso"})]}),u==="custom"&&t("div",{className:"flex items-center gap-2",children:[e("input",{type:"date",className:"border rounded-lg px-3 py-1.5 text-sm",value:c,onChange:T=>m(T.target.value)}),e("span",{className:"text-gray-400",children:"â†’"}),e("input",{type:"date",className:"border rounded-lg px-3 py-1.5 text-sm",value:h,onChange:T=>d(T.target.value)})]}),e("button",{onClick:E,disabled:p,className:"p-2 rounded-lg border hover:bg-gray-50",children:e(kt,{className:`h-4 w-4 ${p?"animate-spin":""}`})})]})]})})}),e("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 py-4",children:e("div",{className:"flex overflow-x-auto pb-2",children:t("nav",{className:"flex space-x-1",children:[e(pa,{active:s==="dashboard",onClick:()=>i("dashboard"),icon:e(Da,{className:"h-4 w-4"}),label:"Tableau de bord"}),e(pa,{active:s==="reconciliation",onClick:()=>i("reconciliation"),icon:e(Ht,{className:"h-4 w-4"}),label:"RÃ©conciliation"}),e(pa,{active:s==="agencies",onClick:()=>i("agencies"),icon:e(St,{className:"h-4 w-4"}),label:"Agences"}),["ceo","financial_director","company_accountant"].includes(w)&&e(pa,{active:s==="movements",onClick:()=>i("movements"),icon:e(Gi,{className:"h-4 w-4"}),label:"Mouvements"}),e(pa,{active:s==="reports",onClick:()=>i("reports"),icon:e(ft,{className:"h-4 w-4"}),label:"Rapports"}),["ceo","financial_director"].includes(w)&&e(pa,{active:s==="audit",onClick:()=>i("audit"),icon:e(qt,{className:"h-4 w-4"}),label:"Audit"})]})})}),t("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 pb-8",children:[s==="dashboard"&&e(Ym,{totals:z,performanceData:j,alerts:F,loading:p,userRole:w,onSelectAgency:K}),s==="reconciliation"&&e(Km,{performanceData:j,loading:p,userRole:w}),s==="agencies"&&e(Wm,{agencies:P,performanceData:j,loading:p,onSelectAgency:K}),s==="movements"&&e(Jm,{movements:M,userRole:w}),s==="reports"&&e(Xm,{performanceData:j,totals:z,range:u,from:g,to:v,label:U}),s==="audit"&&e(Qm,{userRole:w})]}),O&&$&&e(Zm,{agency:$,onClose:()=>{I(null),R(null)}})]})},pa=({active:a,onClick:n,icon:r,label:s})=>t("button",{className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${a?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-sm":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,onClick:n,children:[r,e("span",{children:s})]}),Ym=({totals:a,performanceData:n,alerts:r,loading:s,userRole:i,onSelectAgency:u})=>{const o=Qe();return t("div",{className:"space-y-6",children:[t("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e(tn,{icon:e(Rt,{className:"h-5 w-5"}),label:"Chiffre d'affaires",value:o(a.ventesTotal),sublabel:`${o(a.ventesGuichet)} guichet + ${o(a.ventesEnLigne)} ligne`,trend:"up"}),e(tn,{icon:e(ia,{className:"h-5 w-5"}),label:"Argent en caisse",value:o(a.especesRecues),sublabel:`Solde total: ${o(a.soldeTotalCaisse)}`,trend:a.soldeTotalCaisse>=0?"up":"down"}),e(tn,{icon:e(wt,{className:"h-5 w-5"}),label:"Argent compagnie",value:o(a.mobileMoneyRecu+a.onlineRecu),sublabel:`${o(a.mobileMoneyRecu)} MM + ${o(a.onlineRecu)} ligne`,trend:"up"}),e(tn,{icon:e(nt,{className:"h-5 w-5"}),label:"Ã‰cart total",value:o(a.ecartTotalEspeces),sublabel:Math.abs(a.ecartTotalEspeces)<1e3?"OK":"Ã€ vÃ©rifier",trend:Math.abs(a.ecartTotalEspeces)<1e3?"up":"down"})]}),r.length>0&&t("div",{className:"bg-gradient-to-r from-red-50 to-orange-50 border border-red-100 rounded-xl p-4",children:[t("div",{className:"flex items-center justify-between mb-3",children:[t("div",{className:"flex items-center gap-2",children:[e(nt,{className:"h-5 w-5 text-red-600"}),t("h3",{className:"font-semibold text-red-800",children:["Alertes (",r.length,")"]})]}),e("button",{className:"text-sm text-red-600 hover:text-red-800",children:"Tout marquer comme vu"})]}),t("div",{className:"space-y-2",children:[r.slice(0,3).map(c=>t("div",{className:"flex items-center justify-between p-3 bg-white rounded-lg border",children:[t("div",{children:[e("div",{className:"font-medium text-gray-900",children:c.title}),e("div",{className:"text-sm text-gray-600",children:c.message}),c.agencyName&&t("div",{className:"text-xs text-gray-500 mt-1",children:["Agence: ",c.agencyName]})]}),e("div",{className:`px-2 py-1 rounded text-xs font-medium ${c.severity==="high"?"bg-red-100 text-red-700":c.severity==="medium"?"bg-orange-100 text-orange-700":"bg-yellow-100 text-yellow-700"}`,children:c.severity==="high"?"Critique":c.severity==="medium"?"Important":"Info"})]},c.id)),r.length>3&&e("div",{className:"text-center pt-2",children:t("button",{className:"text-sm text-blue-600 hover:text-blue-800",children:["Voir les ",r.length-3," autres alertes"]})})]})]}),t("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e("div",{className:"px-6 py-4 border-b",children:t("div",{className:"flex items-center justify-between",children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:"Performance par agence"}),t("span",{className:"text-sm text-gray-600",children:[n.length," agence",n.length>1?"s":""]})]})}),s?t("div",{className:"p-8 text-center",children:[e("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"}),e("p",{className:"mt-2 text-gray-600",children:"Chargement des donnÃ©es..."})]}):n.length===0?e("div",{className:"p-8 text-center text-gray-500",children:"Aucune donnÃ©e disponible pour la pÃ©riode sÃ©lectionnÃ©e"}):e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full",children:[e("thead",{className:"bg-gray-50",children:t("tr",{children:[e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Agence"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"CA Total"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"CA Guichet"}),e("th",{className:"px6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"CA Ligne"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Solde Caisse"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Ã‰cart"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Statut"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:n.map(c=>t("tr",{className:"hover:bg-gray-50",children:[t("td",{className:"px-6 py-4",children:[e("div",{className:"font-medium text-gray-900",children:c.agenceNom}),c.ville&&e("div",{className:"text-sm text-gray-500",children:c.ville})]}),t("td",{className:"px-6 py-4",children:[e("div",{className:"font-semibold text-gray-900",children:o(c.ventesTotal)}),t("div",{className:"text-sm text-gray-500",children:[c.nbReservations," rÃ©servations"]})]}),e("td",{className:"px-6 py-4",children:e("div",{className:"font-medium",children:o(c.ventesGuichet)})}),e("td",{className:"px-6 py-4",children:e("div",{className:"font-medium",children:o(c.ventesEnLigne)})}),e("td",{className:"px-6 py-4",children:e("div",{className:`font-semibold ${c.soldeCaisse>=0?"text-green-700":"text-red-700"}`,children:o(c.soldeCaisse)})}),e("td",{className:"px-6 py-4",children:e("div",{className:`font-medium ${Math.abs(c.ecartEspeces)<1e3?"text-gray-700":c.ecartEspeces>0?"text-orange-700":"text-red-700"}`,children:o(c.ecartEspeces)})}),t("td",{className:"px-6 py-4",children:[e("div",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${c.statutCaisse==="ok"?"bg-green-100 text-green-800":c.statutCaisse==="warning"?"bg-orange-100 text-orange-800":"bg-red-100 text-red-800"}`,children:c.statutCaisse==="ok"?"OK":c.statutCaisse==="warning"?"Attention":"ProblÃ¨me"}),c.hasAlert&&e(nt,{className:"h-4 w-4 text-red-500 ml-1 inline"})]}),e("td",{className:"px-6 py-4",children:t("div",{className:"flex items-center gap-2",children:[e("button",{onClick:()=>u(c.agenceId),className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"DÃ©tail"}),["ceo","financial_director"].includes(i)&&e("button",{className:"text-gray-600 hover:text-gray-800 text-sm",children:"Exporter"})]})})]},c.agenceId))}),e("tfoot",{className:"bg-gray-50",children:t("tr",{children:[e("th",{className:"px-6 py-3 text-left font-semibold text-gray-900",children:"TOTAL"}),e("th",{className:"px-6 py-3 text-left font-semibold text-gray-900",children:o(a.ventesTotal)}),e("th",{className:"px-6 py-3 text-left font-semibold text-gray-900",children:o(a.ventesGuichet)}),e("th",{className:"px-6 py-3 text-left font-semibold text-gray-900",children:o(a.ventesEnLigne)}),e("th",{className:"px-6 py-3 text-left font-semibold text-gray-900",children:o(a.soldeTotalCaisse)}),e("th",{className:"px-6 py-3 text-left font-semibold text-gray-900",children:o(a.ecartTotalEspeces)}),t("th",{colSpan:2,className:"px-6 py-3 text-left font-semibold text-gray-900",children:[n.filter(c=>c.statutCaisse==="ok").length," / ",n.length," OK"]})]})})]})})]})]})},Km=({performanceData:a,loading:n,userRole:r})=>{const s=Qe(),[i,u]=l.useState(null),o=async c=>{["ceo","financial_director","company_accountant"].includes(r)&&(u(c),await new Promise(m=>setTimeout(m,1e3)),u(null))};return t("div",{className:"space-y-6",children:[t("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-6",children:[t("div",{className:"flex items-center gap-3 mb-4",children:[e(Ht,{className:"h-6 w-6 text-blue-600"}),t("div",{children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:"VÃ©rification d'Ã©quilibre"}),e("p",{className:"text-sm text-gray-600",children:"Compare les ventes dÃ©clarÃ©es avec l'argent rÃ©ellement encaissÃ©"})]})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t("div",{className:"bg-white p-4 rounded-lg border",children:[e("div",{className:"text-sm text-gray-500 mb-1",children:"Ventes totales agences"}),e("div",{className:"text-2xl font-bold text-gray-900",children:s(a.reduce((c,m)=>c+m.ventesTotal,0))})]}),t("div",{className:"bg-white p-4 rounded-lg border",children:[e("div",{className:"text-sm text-gray-500 mb-1",children:"Argent en caisse"}),e("div",{className:"text-2xl font-bold text-gray-900",children:s(a.reduce((c,m)=>c+m.especesRecues,0))})]}),t("div",{className:`p-4 rounded-lg ${Math.abs(a.reduce((c,m)=>c+m.ecartEspeces,0))<1e3?"bg-gradient-to-r from-green-50 to-emerald-50 border border-green-100":"bg-gradient-to-r from-red-50 to-orange-50 border border-red-100"}`,children:[e("div",{className:"text-sm text-gray-500 mb-1",children:"Ã‰cart global"}),e("div",{className:`text-2xl font-bold ${Math.abs(a.reduce((c,m)=>c+m.ecartEspeces,0))<1e3?"text-green-700":"text-red-700"}`,children:s(a.reduce((c,m)=>c+m.ecartEspeces,0))}),e("div",{className:"text-sm mt-1",children:Math.abs(a.reduce((c,m)=>c+m.ecartEspeces,0))<1e3?"âœ“ Ã‰quilibre respectÃ©":"âš ï¸ DÃ©sÃ©quilibre dÃ©tectÃ©"})]})]})]}),t("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e("div",{className:"px-6 py-4 border-b",children:t("div",{className:"flex items-center justify-between",children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:"RÃ©conciliation par agence"}),["ceo","financial_director"].includes(r)&&e(je,{variant:"primary",className:"text-sm",children:"Valider toute la pÃ©riode"})]})}),n?e("div",{className:"p-8 text-center",children:e("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"})}):e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full",children:[e("thead",{className:"bg-gray-50",children:t("tr",{children:[e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Agence"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Ventes Guichet"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"EspÃ¨ces Attendues"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"EspÃ¨ces ReÃ§ues"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Ã‰cart"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Statut"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Validation"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:a.map(c=>t("tr",{children:[e("td",{className:"px-6 py-4",children:e("div",{className:"font-medium text-gray-900",children:c.agenceNom})}),e("td",{className:"px-6 py-4",children:e("div",{className:"font-medium",children:s(c.ventesGuichet)})}),e("td",{className:"px-6 py-4",children:e("div",{className:"font-medium",children:s(c.ventesGuichet)})}),e("td",{className:"px-6 py-4",children:e("div",{className:"font-medium",children:s(c.especesRecues)})}),e("td",{className:"px-6 py-4",children:e("div",{className:`font-semibold ${Math.abs(c.ecartEspeces)<1e3?"text-gray-700":c.ecartEspeces>0?"text-orange-700":"text-red-700"}`,children:s(c.ecartEspeces)})}),e("td",{className:"px-6 py-4",children:e("div",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${Math.abs(c.ecartEspeces)<1e3?"bg-green-100 text-green-800":Math.abs(c.ecartEspeces)<1e4?"bg-orange-100 text-orange-800":"bg-red-100 text-red-800"}`,children:Math.abs(c.ecartEspeces)<1e3?"OK":Math.abs(c.ecartEspeces)<1e4?"Attention":"ProblÃ¨me"})}),e("td",{className:"px-6 py-4",children:["ceo","financial_director","company_accountant"].includes(r)?e("button",{onClick:()=>o(c.agenceId),disabled:i===c.agenceId,className:`px-4 py-2 rounded-lg text-sm font-medium ${Math.abs(c.ecartEspeces)<1e3?"bg-green-100 text-green-700 hover:bg-green-200":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:i===c.agenceId?"Validation...":"Valider"}):e("span",{className:"text-gray-500 text-sm",children:"Lecture seule"})})]},c.agenceId))})]})})]})]})},Wm=({agencies:a,performanceData:n,loading:r,onSelectAgency:s})=>{const i=Qe();return e("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:a.map(u=>{const o=n.find(c=>c.agenceId===u.id);return t("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden hover:shadow-md transition-shadow",children:[t("div",{className:"p-6",children:[t("div",{className:"flex items-start justify-between mb-4",children:[t("div",{children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:u.nom}),u.ville&&e("p",{className:"text-sm text-gray-600",children:u.ville})]}),e("div",{className:`h-10 w-10 rounded-lg flex items-center justify-center ${(o==null?void 0:o.statutCaisse)==="ok"?"bg-green-100":(o==null?void 0:o.statutCaisse)==="warning"?"bg-orange-100":"bg-red-100"}`,children:e(St,{className:`h-5 w-5 ${(o==null?void 0:o.statutCaisse)==="ok"?"text-green-600":(o==null?void 0:o.statutCaisse)==="warning"?"text-orange-600":"text-red-600"}`})})]}),o?t("div",{className:"space-y-4",children:[t("div",{className:"grid grid-cols-2 gap-4",children:[t("div",{children:[e("div",{className:"text-sm text-gray-500",children:"Chiffre d'affaires"}),e("div",{className:"font-semibold text-gray-900",children:i(o.ventesTotal)})]}),t("div",{children:[e("div",{className:"text-sm text-gray-500",children:"Solde caisse"}),e("div",{className:`font-semibold ${o.soldeCaisse>=0?"text-green-700":"text-red-700"}`,children:i(o.soldeCaisse)})]})]}),t("div",{children:[e("div",{className:"text-sm text-gray-500",children:"Ã‰cart espÃ¨ces"}),e("div",{className:`font-medium ${Math.abs(o.ecartEspeces)<1e3?"text-gray-700":o.ecartEspeces>0?"text-orange-700":"text-red-700"}`,children:i(o.ecartEspeces)})]}),e("div",{className:"pt-4 border-t",children:t("div",{className:"flex items-center justify-between text-sm",children:[t("span",{className:"text-gray-600",children:[o.nbReservations," rÃ©servations"]}),t("span",{className:"text-gray-600",children:[o.nbBillets," billets"]})]})})]}):r?e("div",{className:"py-8 text-center",children:e("div",{className:"inline-block h-6 w-6 animate-spin rounded-full border-2 border-solid border-gray-400 border-r-transparent"})}):e("div",{className:"py-8 text-center text-gray-500",children:"Aucune donnÃ©e disponible"})]}),e("div",{className:"px-6 py-4 bg-gray-50 border-t",children:e("button",{onClick:()=>s(u.id),className:"w-full px-4 py-2 bg-white border rounded-lg text-gray-700 hover:bg-gray-50 font-medium",children:"Voir le dÃ©tail"})})]},u.id)})})},Jm=({movements:a,userRole:n})=>{const r=Qe(),s=Jn(),[i,u]=l.useState(!1),[o,c]=l.useState({type:"depense",category:"",amount:"",label:"",method:"cash",note:""}),m=["ceo","financial_director","company_accountant"].includes(n);return t("div",{className:"space-y-6",children:[m&&t("div",{className:"bg-white rounded-xl border shadow-sm p-6",children:[t("div",{className:"flex items-center justify-between mb-6",children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:"Nouveau mouvement"}),e(je,{variant:"primary",onClick:()=>u(!i),className:"text-sm",children:i?"Annuler":"Ajouter un mouvement"})]}),i&&t("div",{className:"space-y-4",children:[t("div",{className:"grid grid-cols-2 gap-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Type"}),t("select",{className:"w-full border rounded-lg px-3 py-2",value:o.type,onChange:h=>c({...o,type:h.target.value}),children:[e("option",{value:"depense",children:"DÃ©pense"}),e("option",{value:"entree",children:"EntrÃ©e"})]})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Moyen de paiement"}),t("select",{className:"w-full border rounded-lg px-3 py-2",value:o.method,onChange:h=>c({...o,method:h.target.value}),children:[e("option",{value:"cash",children:"EspÃ¨ces"}),e("option",{value:"bank",children:"Virement bancaire"}),e("option",{value:"cheque",children:"ChÃ¨que"}),e("option",{value:"mobile_money",children:"Mobile Money"})]})]})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"LibellÃ©"}),e("input",{type:"text",className:"w-full border rounded-lg px-3 py-2",placeholder:"Ex: Achat fournitures bureau",value:o.label,onChange:h=>c({...o,label:h.target.value})})]}),t("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Montant (",s,")"]}),e("input",{type:"number",className:"w-full border rounded-lg px-3 py-2",placeholder:"0",value:o.amount,onChange:h=>c({...o,amount:h.target.value})})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Note (facultatif)"}),e("textarea",{className:"w-full border rounded-lg px-3 py-2",rows:3,placeholder:"Informations complÃ©mentaires...",value:o.note,onChange:h=>c({...o,note:h.target.value})})]}),t("div",{className:"flex justify-end gap-3",children:[e("button",{onClick:()=>u(!1),className:"px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50",children:"Annuler"}),e(je,{variant:"primary",onClick:()=>{u(!1),c({type:"depense",category:"",amount:"",label:"",method:"cash",note:""})},children:"Enregistrer"})]})]})]}),t("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e("div",{className:"px-6 py-4 border-b",children:e("h3",{className:"text-lg font-semibold text-gray-900",children:"Historique des mouvements"})}),a.length===0?e("div",{className:"p-8 text-center text-gray-500",children:"Aucun mouvement enregistrÃ©"}):e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full",children:[e("thead",{className:"bg-gray-50",children:t("tr",{children:[e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Type"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"LibellÃ©"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Moyen"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Montant"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"CrÃ©Ã© par"}),e("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Statut"})]})}),e("tbody",{className:"divide-y divide-gray-200",children:a.map(h=>{var d,p;return t("tr",{children:[e("td",{className:"px-6 py-4",children:e("div",{className:"text-sm text-gray-900",children:((p=(d=h.createdAt)==null?void 0:d.toDate)==null?void 0:p.call(d).toLocaleDateString("fr-FR"))||"â€”"})}),e("td",{className:"px-6 py-4",children:e("div",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${h.type==="entree"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:h.type==="entree"?"EntrÃ©e":"DÃ©pense"})}),t("td",{className:"px-6 py-4",children:[e("div",{className:"font-medium text-gray-900",children:h.label}),h.note&&e("div",{className:"text-sm text-gray-500",children:h.note})]}),e("td",{className:"px-6 py-4",children:e("div",{className:"text-sm text-gray-900",children:h.method==="cash"?"EspÃ¨ces":h.method==="bank"?"Banque":h.method==="cheque"?"ChÃ¨que":"Mobile Money"})}),e("td",{className:"px-6 py-4",children:e("div",{className:`font-semibold ${h.type==="entree"?"text-green-700":"text-red-700"}`,children:r(h.amount)})}),e("td",{className:"px-6 py-4",children:e("div",{className:"text-sm text-gray-900",children:h.createdByName})}),e("td",{className:"px-6 py-4",children:h.validated?e("div",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"ValidÃ©"}):e("div",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800",children:"En attente"})})]},h.id)})})]})})]})]})},Xm=({performanceData:a,totals:n,range:r,from:s,to:i,label:u})=>{const o=Qe();return t("div",{className:"space-y-6",children:[t("div",{className:"bg-white rounded-xl border shadow-sm p-6",children:[t("div",{className:"flex items-center justify-between mb-6",children:[t("div",{children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:"Rapports financiers"}),e("p",{className:"text-sm text-gray-600",children:"GÃ©nÃ©rez des rapports dÃ©taillÃ©s pour la pÃ©riode"})]}),t("div",{className:"flex items-center gap-3",children:[t(je,{variant:"primary",onClick:()=>{const h=a.map(d=>({Agence:d.agenceNom,"CA Total":d.ventesTotal,"CA Guichet":d.ventesGuichet,"CA Ligne":d.ventesEnLigne,"EspÃ¨ces ReÃ§ues":d.especesRecues,"Solde Caisse":d.soldeCaisse,Ã‰cart:d.ecartEspeces,Statut:d.statutCaisse==="ok"?"OK":d.statutCaisse==="warning"?"Attention":"ProblÃ¨me"}));console.log("DonnÃ©es Ã  exporter:",h),alert("Export Excel Ã  implÃ©menter")},className:"text-sm",children:[e(Ca,{className:"h-4 w-4 inline mr-2"}),"Export Excel"]}),t(je,{variant:"danger",onClick:()=>{alert("Export PDF Ã  implÃ©menter")},className:"text-sm",children:[e(ft,{className:"h-4 w-4 inline mr-2"}),"Export PDF"]})]})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e(On,{title:"Rapport financier complet",description:"SynthÃ¨se dÃ©taillÃ©e de l'ensemble des donnÃ©es financiÃ¨res",icon:e(Da,{className:"h-6 w-6"}),onGenerate:()=>console.log("GÃ©nÃ©rer rapport complet")}),e(On,{title:"RÃ©conciliation par agence",description:"VÃ©rification dÃ©taillÃ©e des Ã©carts par agence",icon:e(Ht,{className:"h-6 w-6"}),onGenerate:()=>console.log("GÃ©nÃ©rer rapport rÃ©conciliation")}),e(On,{title:"Analyse des performances",description:"Tendances et comparaisons pÃ©riodiques",icon:e(Rt,{className:"h-6 w-6"}),onGenerate:()=>console.log("GÃ©nÃ©rer analyse performances")})]})]}),t("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e("div",{className:"px-6 py-4 border-b",children:e("h3",{className:"text-lg font-semibold text-gray-900",children:"AperÃ§u des donnÃ©es"})}),e("div",{className:"p-6",children:t("div",{className:"space-y-4",children:[t("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[t("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e("div",{className:"text-sm text-gray-500",children:"PÃ©riode"}),e("div",{className:"font-medium text-gray-900",children:u})]}),t("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e("div",{className:"text-sm text-gray-500",children:"Nombre d'agences"}),e("div",{className:"font-medium text-gray-900",children:a.length})]}),t("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e("div",{className:"text-sm text-gray-500",children:"RÃ©servations totales"}),e("div",{className:"font-medium text-gray-900",children:dn(n.nbReservations)})]}),t("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e("div",{className:"text-sm text-gray-500",children:"Billets vendus"}),e("div",{className:"font-medium text-gray-900",children:dn(n.nbBillets)})]})]}),t("div",{className:"pt-4 border-t",children:[e("h4",{className:"font-medium text-gray-900 mb-3",children:"RÃ©sumÃ© financier"}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t("div",{className:"space-y-2",children:[t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"Chiffre d'affaires total:"}),e("span",{className:"font-medium",children:o(n.ventesTotal)})]}),t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"Argent en caisse agences:"}),e("span",{className:"font-medium",children:o(n.especesRecues)})]}),t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"Argent compagnie (MM + ligne):"}),e("span",{className:"font-medium",children:o(n.mobileMoneyRecu+n.onlineRecu)})]})]}),t("div",{className:"space-y-2",children:[t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"Solde total des caisses:"}),e("span",{className:`font-medium ${n.soldeTotalCaisse>=0?"text-green-700":"text-red-700"}`,children:o(n.soldeTotalCaisse)})]}),t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"Ã‰cart total espÃ¨ces:"}),e("span",{className:`font-medium ${Math.abs(n.ecartTotalEspeces)<1e3?"text-gray-700":"text-orange-700"}`,children:o(n.ecartTotalEspeces)})]}),t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"Agences avec alertes:"}),t("span",{className:"font-medium",children:[a.filter(h=>h.hasAlert).length," / ",a.length]})]})]})]})]})]})})]})]})},Qm=({userRole:a})=>["ceo","financial_director"].includes(a)?t("div",{className:"space-y-6",children:[t("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-6",children:[t("div",{className:"flex items-center gap-3 mb-4",children:[e(qt,{className:"h-6 w-6 text-blue-600"}),t("div",{children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:"Audit et traÃ§abilitÃ©"}),e("p",{className:"text-sm text-gray-600",children:"Historique complet des actions et modifications"})]})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t("div",{className:"bg-white p-4 rounded-lg border",children:[e("div",{className:"text-sm text-gray-500 mb-1",children:"Validations rÃ©centes"}),e("div",{className:"text-2xl font-bold text-gray-900",children:"12"}),e("div",{className:"text-sm text-gray-600 mt-1",children:"7 derniers jours"})]}),t("div",{className:"bg-white p-4 rounded-lg border",children:[e("div",{className:"text-sm text-gray-500 mb-1",children:"Modifications"}),e("div",{className:"text-2xl font-bold text-gray-900",children:"47"}),e("div",{className:"text-sm text-gray-600 mt-1",children:"Ce mois"})]}),t("div",{className:"bg-white p-4 rounded-lg border",children:[e("div",{className:"text-sm text-gray-500 mb-1",children:"Connexions suspectes"}),e("div",{className:"text-2xl font-bold text-gray-900",children:"0"}),e("div",{className:"text-sm text-green-600 mt-1",children:"âœ“ Aucune alerte"})]})]})]}),t("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:[e("div",{className:"px-6 py-4 border-b",children:e("h3",{className:"text-lg font-semibold text-gray-900",children:"Journal d'audit"})}),e("div",{className:"p-6",children:e("div",{className:"space-y-4",children:[1,2,3,4,5].map(n=>t("div",{className:"flex items-start gap-4 p-4 border rounded-lg hover:bg-gray-50",children:[e("div",{className:"h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:e(qt,{className:"h-5 w-5 text-blue-600"})}),t("div",{className:"flex-1",children:[t("div",{className:"flex items-center justify-between mb-1",children:[e("div",{className:"font-medium text-gray-900",children:"Validation de rÃ©conciliation"}),t("div",{className:"text-sm text-gray-500",children:["Il y a ",n," heures"]})]}),e("p",{className:"text-sm text-gray-600 mb-2",children:`La rÃ©conciliation de l'agence "Dakar Plateau" a Ã©tÃ© validÃ©e par Jean Dupont.`}),t("div",{className:"flex items-center gap-4 text-xs text-gray-500",children:[e("span",{children:"Utilisateur: Jean Dupont"}),t("span",{children:["IP: 192.168.1.",n]}),e("span",{children:"Navigateur: Chrome"})]})]})]},n))})})]})]}):t("div",{className:"bg-white rounded-xl border shadow-sm p-8 text-center",children:[e(qt,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"AccÃ¨s restreint"}),e("p",{className:"text-gray-600",children:"Cette section est rÃ©servÃ©e aux directeurs financiers et CEO."})]}),tn=({icon:a,label:n,value:r,sublabel:s,trend:i="neutral"})=>t("div",{className:"bg-white rounded-xl border shadow-sm p-6 hover:shadow-md transition-shadow",children:[t("div",{className:"flex items-start justify-between mb-4",children:[e("div",{className:"text-sm font-medium text-gray-500",children:n}),e("div",{className:`h-10 w-10 rounded-lg flex items-center justify-center ${i==="up"?"bg-green-100":i==="down"?"bg-red-100":"bg-gray-100"}`,children:e("span",{className:i==="up"?"text-green-600":i==="down"?"text-red-600":"text-gray-600",children:a})})]}),t("div",{className:"space-y-1",children:[e("div",{className:"text-2xl font-bold text-gray-900",children:r}),s&&e("div",{className:"text-sm text-gray-600",children:s})]})]}),On=({title:a,description:n,icon:r,onGenerate:s})=>t("div",{className:"bg-gray-50 rounded-lg border p-6 hover:bg-gray-100 transition-colors",children:[t("div",{className:"flex items-center gap-3 mb-4",children:[e("div",{className:"h-10 w-10 rounded-lg bg-white border flex items-center justify-center",children:r}),t("div",{children:[e("h4",{className:"font-semibold text-gray-900",children:a}),e("p",{className:"text-sm text-gray-600",children:n})]})]}),e("button",{onClick:s,className:"w-full px-4 py-2 bg-white border rounded-lg text-gray-700 hover:bg-gray-50 font-medium",children:"GÃ©nÃ©rer le rapport"})]}),Zm=({agency:a,onClose:n})=>{const r=Qe();return t("div",{className:"fixed inset-0 z-50",children:[e("div",{className:"absolute inset-0 bg-black/50",onClick:n}),e("div",{className:"absolute right-0 top-0 h-full w-full max-w-2xl bg-white shadow-xl",children:t("div",{className:"h-full flex flex-col",children:[t("div",{className:"px-6 py-4 border-b flex items-center justify-between",children:[t("div",{children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:a.nom}),a.ville&&e("p",{className:"text-sm text-gray-600",children:a.ville})]}),e("button",{onClick:n,className:"p-2 hover:bg-gray-100 rounded-lg",children:"Ã—"})]}),e("div",{className:"flex-1 overflow-auto p-6",children:a.performance?t("div",{className:"space-y-6",children:[t("div",{className:"grid grid-cols-2 gap-4",children:[t("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e("div",{className:"text-sm text-gray-500",children:"Chiffre d'affaires"}),e("div",{className:"text-2xl font-bold text-gray-900",children:r(a.performance.ventesTotal)})]}),t("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e("div",{className:"text-sm text-gray-500",children:"Solde caisse"}),e("div",{className:`text-2xl font-bold ${a.performance.soldeCaisse>=0?"text-green-700":"text-red-700"}`,children:r(a.performance.soldeCaisse)})]})]}),t("div",{className:"space-y-4",children:[e("h4",{className:"font-medium text-gray-900",children:"DÃ©tails financiers"}),t("div",{className:"space-y-2",children:[t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"Ventes guichet:"}),e("span",{className:"font-medium",children:r(a.performance.ventesGuichet)})]}),t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"Ventes en ligne:"}),e("span",{className:"font-medium",children:r(a.performance.ventesEnLigne)})]}),t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"EspÃ¨ces reÃ§ues:"}),e("span",{className:"font-medium",children:r(a.performance.especesRecues)})]}),t("div",{className:"flex justify-between",children:[e("span",{className:"text-gray-600",children:"Ã‰cart espÃ¨ces:"}),e("span",{className:`font-medium ${Math.abs(a.performance.ecartEspeces)<1e3?"text-gray-700":"text-orange-700"}`,children:r(a.performance.ecartEspeces)})]})]})]}),t("div",{className:"space-y-4",children:[e("h4",{className:"font-medium text-gray-900",children:"Statistiques"}),t("div",{className:"grid grid-cols-2 gap-4",children:[t("div",{className:"bg-white border rounded-lg p-4",children:[e("div",{className:"text-sm text-gray-500",children:"RÃ©servations"}),e("div",{className:"text-xl font-bold text-gray-900",children:dn(a.performance.nbReservations)})]}),t("div",{className:"bg-white border rounded-lg p-4",children:[e("div",{className:"text-sm text-gray-500",children:"Billets vendus"}),e("div",{className:"text-xl font-bold text-gray-900",children:dn(a.performance.nbBillets)})]})]})]})]}):e("div",{className:"text-center py-12 text-gray-500",children:"Aucune donnÃ©e disponible"})}),e("div",{className:"px-6 py-4 border-t bg-gray-50",children:t("div",{className:"flex items-center justify-end gap-3",children:[e("button",{onClick:n,className:"px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50",children:"Fermer"}),e(je,{variant:"primary",children:"Exporter rapport"})]})})]})})]})},Tp=Object.freeze(Object.defineProperty({__proto__:null,default:Hm},Symbol.toStringTag,{value:"Module"})),eu=()=>{const{user:a,company:n}=Pe(),{companyId:r}=De(),s=r??(a==null?void 0:a.companyId),i=lt(n),{setHeader:u,resetHeader:o}=ut(),[c,m]=l.useState([]),[h,d]=l.useState([]),[p,f]=l.useState(""),[x,b]=l.useState(!0);l.useEffect(()=>{if(!s)return;b(!0);const M=ce(Q(G,"companies",s,"avis"),ne("visible","==",!1)),_=st(M,F=>{const D=F.docs.map(k=>({id:k.id,...k.data()}));m(D),b(!1)},F=>{console.error("Erreur Ã©coute avis:",F),b(!1)});return()=>_()},[s]),l.useEffect(()=>{s&&ee(Q(G,"companies",s,"agences")).then(M=>{d(M.docs.map(_=>({id:_.id,nom:_.data().nom??_.id})))})},[s]);const P=l.useMemo(()=>p?c.filter(M=>M.agencyId===p):c,[c,p]),C=l.useMemo(()=>P.length===0?null:(P.reduce((_,F)=>_+F.note,0)/P.length).toFixed(1),[P]);l.useEffect(()=>(u({title:"Avis clients",subtitle:c.length?`${c.length} avis en attente`:"Aucun avis en attente",bg:`linear-gradient(90deg, ${i.colors.primary} 0%, ${i.colors.secondary} 100%)`,fg:"#fff"}),()=>o()),[c.length,i.colors.primary,i.colors.secondary]);const j=async(M,_)=>{if(!s)return;const F=me(G,"companies",s,"avis",M);await He(F,{visible:!_})},L=async M=>{if(!s)return;const _=me(G,"companies",s,"avis",M);await $a(_)};return t("div",{className:"max-w-7xl mx-auto p-6",children:[h.length>0&&t("div",{className:"mb-4 flex flex-wrap items-center gap-2",children:[e("label",{className:"text-sm font-medium text-gray-700",children:"Agence :"}),t("select",{className:"border rounded px-3 py-1.5 text-sm",value:p,onChange:M=>f(M.target.value),children:[e("option",{value:"",children:"Toutes les agences"}),h.map(M=>e("option",{value:M.id,children:M.nom},M.id))]}),C!=null&&t("span",{className:"text-sm text-gray-600",children:["Note moyenne : ",e("strong",{children:C})," / 5 (",P.length," avis)"]})]}),x&&c.length===0&&e("p",{children:"Chargement des avis..."}),!x&&P.length===0&&e("p",{children:"Aucun avis en attente pour lâ€™instant âœ…"}),e("ul",{className:"space-y-4",children:P.map(M=>t("li",{className:"border p-4 rounded-xl shadow-sm bg-white flex flex-col gap-2",children:[t("div",{className:"flex justify-between items-center",children:[t("h4",{className:"font-semibold",children:[M.nom," â€” â­ ",M.note]}),t("div",{className:"flex gap-2",children:[e("button",{onClick:()=>j(M.id,M.visible),className:"text-sm px-3 py-1 rounded bg-green-100 text-green-700",children:"Publier"}),e("button",{onClick:()=>L(M.id),className:"text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded",children:"Supprimer"})]})]}),e("p",{className:"text-sm text-gray-600 italic",children:M.commentaire})]},M.id))})]})},Pp=Object.freeze(Object.defineProperty({__proto__:null,default:eu},Symbol.toStringTag,{value:"Module"})),an="revenus",nn="liquidites";function tu(){const{user:a,company:n}=Pe(),{companyId:r}=De(),[s,i]=wi(),u=r??(a==null?void 0:a.companyId)??"",o=s.get("tab")===nn?nn:an,[c,m]=l.useState(o);Je.useEffect(()=>{m(o)},[o]);const[h,d]=Je.useState(n??null);Je.useEffect(()=>{u&&Se(me(G,"companies",u)).then(C=>{C.exists()&&d({id:C.id,...C.data()})}).catch(()=>{})},[u]);const p=lt(h??n??null),{setHeader:f,resetHeader:x}=ut();Je.useEffect(()=>(f({title:"Revenus & LiquiditÃ©s"}),()=>x()),[f,x]);const b=C=>{m(C),i({tab:C},{replace:!0})},P=l.useMemo(()=>[{key:an,label:"Revenus",icon:Fa,description:"CA, ventes, Ã©volution (sessions validÃ©es)"},{key:nn,label:"LiquiditÃ©s",icon:ia,description:"Cash rÃ©el, validÃ©, en attente, trÃ©sorerie nette"}],[]);return u?t("div",{className:"space-y-4 p-4 md:p-6 max-w-6xl mx-auto",children:[e("div",{className:"flex flex-wrap gap-2 border-b border-gray-200 pb-3",children:P.map(({key:C,label:j,icon:L,description:M})=>{const _=c===C;return t("button",{type:"button",onClick:()=>b(C),className:["inline-flex items-center gap-2 px-4 py-2.5 rounded-t-lg text-sm font-medium transition-all",_?"bg-white border border-b-0 border-gray-200 shadow-sm -mb-px":"text-gray-600 hover:bg-gray-50 border border-transparent"].join(" "),style:_?{borderBottomColor:"white",color:p.colors.primary}:{},children:[e(L,{className:"w-4 h-4"}),j]},C)})}),e("p",{className:"text-xs text-gray-500 -mt-2",children:c===an?"Revenus = chiffre d'affaires et ventes (sessions validÃ©es). Les montants peuvent diffÃ©rer des encaissements rÃ©els.":"LiquiditÃ©s = argent rÃ©ellement disponible (caisses, banques, mobile money). Les entrÃ©es/sorties sont enregistrÃ©es au fil de l'eau."}),c===an&&e(ml,{}),c===nn&&e(ul,{})]}):e("div",{className:"p-6",children:e("p",{className:"text-gray-500",children:"Compagnie introuvable."})})}const Dp=Object.freeze(Object.defineProperty({__proto__:null,default:tu},Symbol.toStringTag,{value:"Module"}));function au(a){const n=a.getFullYear(),r=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${n}-${r}-${s}`}function nu(){const{user:a}=Pe(),n=Tt(),{companyId:r}=De(),s=Be(),i=r??(a==null?void 0:a.companyId)??"",{setHeader:u,resetHeader:o}=ut();l.useEffect(()=>(u({title:"OpÃ©rations & Flotte"}),()=>o()),[u,o]);const[c,m]=l.useState(null),[h,d]=l.useState(null),[p,f]=l.useState(0),[x,b]=l.useState(0),[P,C]=l.useState(!0),[j,L]=l.useState(null),[M,_]=l.useState(0);l.useEffect(()=>{if(!i){C(!1);return}const D=au(new Date),k=fe.fromDate(new Date(`${D}T00:00:00`)),S=fe.fromDate(new Date(`${D}T23:59:59`));(async()=>{C(!0),L(null);try{const I=(await ee(Q(G,"companies",i,"agences"))).docs.map(E=>E.id);let $=0,R=0;for(const E of I){const B=Q(G,"companies",i,"agences",E,"reservations"),V=ce(B,ne("createdAt",">=",k),ne("createdAt","<=",S),Re(500)),K=await ee(V);$+=K.size;const z=Q(G,"companies",i,"agences",E,"shifts"),T=ce(z,ne("status","in",["active","paused"]),Re(20)),W=await ee(T);R+=W.size}m($),d(R);const w=Q(G,"companies",i,"fleetVehicles"),g=(await ee(ce(w,Re(500)))).docs.map(E=>E.data()),v=g.length,U=g.filter(E=>(E.status==="garage"||E.status==="arrived"||E.status==="assigned")&&E.status!=="maintenance").length;f(v),b(U)}catch(O){console.error("OperationsFlotteLandingPage load:",O),L(n?"Erreur lors du chargement de la synthÃ¨se opÃ©rationnelle.":"Connexion indisponible. Impossible de charger la synthÃ¨se opÃ©rationnelle.")}finally{C(!1)}})()},[i,n,M]);const F=`/compagnie/${i}`;return t("div",{className:"space-y-6 p-4 md:p-6 max-w-4xl mx-auto",children:[!n&&e(Xn,{message:"Connexion instable: certaines mÃ©triques peuvent Ãªtre incomplÃ¨tes."}),j&&e(ys,{message:j,onRetry:()=>_(D=>D+1)}),e("p",{className:"text-sm text-gray-600",children:"Vue d'ensemble opÃ©rationnelle. AccÃ©dez aux rÃ©servations et Ã  la flotte ci-dessous."}),t("section",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[t("div",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[t("div",{className:"flex items-center gap-2 text-gray-600 mb-1",children:[e(dt,{className:"w-4 h-4"}),e("span",{className:"text-xs font-medium",children:"RÃ©servations aujourd'hui"})]}),e("div",{className:"text-2xl font-bold text-gray-900",children:P?"â€”":c??"â€”"})]}),t("div",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[t("div",{className:"flex items-center gap-2 text-gray-600 mb-1",children:[e(Oa,{className:"w-4 h-4"}),e("span",{className:"text-xs font-medium",children:"Sessions ouvertes"})]}),e("div",{className:"text-2xl font-bold text-gray-900",children:P?"â€”":h??"â€”"})]}),t("div",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[t("div",{className:"flex items-center gap-2 text-gray-600 mb-1",children:[e(xa,{className:"w-4 h-4"}),e("span",{className:"text-xs font-medium",children:"VÃ©hicules disponibles"})]}),e("div",{className:"text-2xl font-bold text-gray-900",children:P?"â€”":`${x} / ${p}`})]}),e("div",{className:"bg-white rounded-xl border p-4 shadow-sm sm:col-span-2 lg:col-span-1",children:t("div",{className:"text-xs text-gray-500",children:["Flotte totale : ",e("strong",{children:p})," vÃ©hicules"]})})]}),t("section",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t("button",{type:"button",onClick:()=>s(`${F}/reservations`),className:"flex items-center justify-between p-5 rounded-xl border-2 border-gray-200 hover:border-indigo-300 hover:bg-indigo-50/50 transition text-left group",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center",children:e(zi,{className:"w-6 h-6 text-indigo-600"})}),t("div",{children:[e("div",{className:"font-semibold text-gray-900",children:"RÃ©servations"}),e("div",{className:"text-sm text-gray-500",children:"Voir et gÃ©rer toutes les rÃ©servations"})]})]}),e(_a,{className:"w-5 h-5 text-gray-400 group-hover:text-indigo-600"})]}),t("button",{type:"button",onClick:()=>s(`${F}/fleet`),className:"flex items-center justify-between p-5 rounded-xl border-2 border-gray-200 hover:border-teal-300 hover:bg-teal-50/50 transition text-left group",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"w-12 h-12 rounded-lg bg-teal-100 flex items-center justify-center",children:e(xa,{className:"w-6 h-6 text-teal-600"})}),t("div",{children:[e("div",{className:"font-semibold text-gray-900",children:"Flotte"}),e("div",{className:"text-sm text-gray-500",children:"Supervision des vÃ©hicules et affectations"})]})]}),e(_a,{className:"w-5 h-5 text-gray-400 group-hover:text-teal-600"})]})]})]})}const Mp=Object.freeze(Object.defineProperty({__proto__:null,default:nu},Symbol.toStringTag,{value:"Module"})),Ia=yt(new Date,"yyyy-MM-dd");function ru(){const a=Tt(),{user:n}=Pe(),{companyId:r}=De(),s=r??(n==null?void 0:n.companyId)??"",i=Be(),{setHeader:u,resetHeader:o}=ut(),[c,m]=l.useState([]),[h,d]=l.useState(!0),[p,f]=l.useState(Ia),[x,b]=l.useState(!1),[P,C]=l.useState(null),[j,L]=l.useState(!1),[M,_]=l.useState(null),[F,D]=l.useState(0),[k,S]=l.useState({tripId:"",agencyId:(n==null?void 0:n.agencyId)??"",date:Ia,fuelCost:0,driverCost:0,assistantCost:0,tollCost:0,maintenanceCost:0,otherOperationalCost:0}),O=(n==null?void 0:n.role)==="chefAgence",I=g=>g===Ia,$=l.useCallback(async()=>{if(s){d(!0),_(null);try{const g=await Hc(s,{date:p,agencyId:O&&(n!=null&&n.agencyId)?n.agencyId:void 0,limitCount:200});m(g)}catch(g){console.error("listTripCosts:",g),m([]),_(a?"Erreur lors du chargement des coÃ»ts trajet.":"Connexion indisponible. Impossible de charger les coÃ»ts trajet.")}finally{d(!1)}}},[s,p,O,n==null?void 0:n.agencyId,a]);l.useEffect(()=>(u({title:"CoÃ»ts par trajet"}),()=>o()),[u,o]),l.useEffect(()=>{$()},[$,F]);const R=async g=>{if(g.preventDefault(),!(!s||!(n!=null&&n.uid))){L(!0);try{await zc(s,{...k,agencyId:k.agencyId||(n.agencyId??"")},n.uid),S({...k,tripId:"",fuelCost:0,driverCost:0,assistantCost:0,tollCost:0,maintenanceCost:0,otherOperationalCost:0}),b(!1),await $()}catch(v){console.error(v)}finally{L(!1)}}},w=async(g,v)=>{if(g.preventDefault(),!!s){L(!0);try{const U=c.find(E=>E.id===v);if(!U||U.date!==Ia)return;await Vc(s,v,{fuelCost:k.fuelCost,driverCost:k.driverCost,assistantCost:k.assistantCost,tollCost:k.tollCost,maintenanceCost:k.maintenanceCost,otherOperationalCost:k.otherOperationalCost}),C(null),await $()}catch(U){console.error(U)}finally{L(!1)}}},N=g=>{I(g.date)&&(S({tripId:g.tripId,agencyId:g.agencyId,date:g.date,fuelCost:Number(g.fuelCost)||0,driverCost:Number(g.driverCost)||0,assistantCost:Number(g.assistantCost)||0,tollCost:Number(g.tollCost)||0,maintenanceCost:Number(g.maintenanceCost)||0,otherOperationalCost:Number(g.otherOperationalCost)||0}),C(g.id))};return s?t("div",{className:"space-y-4 p-4 md:p-6 max-w-5xl mx-auto",children:[!a&&e(Xn,{message:"Connexion instable: lâ€™historique des coÃ»ts peut Ãªtre incomplet."}),M&&e(ys,{message:M,onRetry:()=>D(g=>g+1)}),t("div",{className:"flex items-center justify-between gap-4 flex-wrap",children:[t("button",{type:"button",onClick:()=>i(-1),className:"inline-flex items-center gap-1 text-sm text-gray-600 hover:text-gray-900",children:[e(Es,{className:"w-4 h-4"})," Retour"]}),t("div",{className:"flex items-center gap-2",children:[e("label",{className:"text-sm text-gray-600",children:"Date"}),e("input",{type:"date",value:p,onChange:g=>f(g.target.value),className:"border rounded px-2 py-1 text-sm"})]})]}),!x&&!P&&t("button",{type:"button",onClick:()=>{S({tripId:"",agencyId:(n==null?void 0:n.agencyId)??"",date:Ia,fuelCost:0,driverCost:0,assistantCost:0,tollCost:0,maintenanceCost:0,otherOperationalCost:0}),b(!0)},className:"inline-flex items-center gap-1 px-3 py-2 bg-orange-600 text-white rounded-lg text-sm hover:bg-orange-700",children:[e(vn,{className:"w-4 h-4"})," Nouveau coÃ»t trajet"]}),x&&t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[e("h2",{className:"text-lg font-semibold mb-3",children:"CrÃ©er un coÃ»t trajet"}),t("form",{onSubmit:R,className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e("input",{type:"text",placeholder:"ID trajet",value:k.tripId,onChange:g=>S(v=>({...v,tripId:g.target.value})),className:"border rounded px-3 py-2 text-sm",required:!0}),!O&&e("input",{type:"text",placeholder:"ID agence",value:k.agencyId,onChange:g=>S(v=>({...v,agencyId:g.target.value})),className:"border rounded px-3 py-2 text-sm"}),e("input",{type:"date",value:k.date,onChange:g=>S(v=>({...v,date:g.target.value})),className:"border rounded px-3 py-2 text-sm"}),e("input",{type:"number",placeholder:"Carburant",value:k.fuelCost||"",onChange:g=>S(v=>({...v,fuelCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"Chauffeur",value:k.driverCost||"",onChange:g=>S(v=>({...v,driverCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"Convoyeur",value:k.assistantCost||"",onChange:g=>S(v=>({...v,assistantCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"PÃ©age",value:k.tollCost||"",onChange:g=>S(v=>({...v,tollCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"Maintenance",value:k.maintenanceCost||"",onChange:g=>S(v=>({...v,maintenanceCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"Autre opÃ©rationnel",value:k.otherOperationalCost||"",onChange:g=>S(v=>({...v,otherOperationalCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),t("div",{className:"md:col-span-2 flex gap-2",children:[e("button",{type:"submit",disabled:j,className:"px-4 py-2 bg-orange-600 text-white rounded-lg text-sm disabled:opacity-50",children:j?"Enregistrementâ€¦":"Enregistrer"}),e("button",{type:"button",onClick:()=>b(!1),className:"px-4 py-2 border rounded-lg text-sm",children:"Annuler"})]})]})]}),P&&t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[e("h2",{className:"text-lg font-semibold mb-3",children:"Modifier (mÃªme jour uniquement)"}),t("form",{onSubmit:g=>w(g,P),className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e("input",{type:"number",placeholder:"Carburant",value:k.fuelCost||"",onChange:g=>S(v=>({...v,fuelCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"Chauffeur",value:k.driverCost||"",onChange:g=>S(v=>({...v,driverCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"Convoyeur",value:k.assistantCost||"",onChange:g=>S(v=>({...v,assistantCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"PÃ©age",value:k.tollCost||"",onChange:g=>S(v=>({...v,tollCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"Maintenance",value:k.maintenanceCost||"",onChange:g=>S(v=>({...v,maintenanceCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),e("input",{type:"number",placeholder:"Autre opÃ©rationnel",value:k.otherOperationalCost||"",onChange:g=>S(v=>({...v,otherOperationalCost:Number(g.target.value)||0})),className:"border rounded px-3 py-2 text-sm",min:0,step:.01}),t("div",{className:"md:col-span-2 flex gap-2",children:[e("button",{type:"submit",disabled:j,className:"px-4 py-2 bg-orange-600 text-white rounded-lg text-sm disabled:opacity-50",children:j?"Enregistrementâ€¦":"Enregistrer"}),e("button",{type:"button",onClick:()=>C(null),className:"px-4 py-2 border rounded-lg text-sm",children:"Annuler"})]})]})]}),t("section",{className:"bg-white rounded-xl border p-4 shadow-sm",children:[e("h2",{className:"text-lg font-semibold mb-3",children:"Historique"}),h?t("div",{className:"space-y-3 animate-fadein",children:[e("div",{className:"h-10 rounded-lg skeleton"}),e("div",{className:"h-10 rounded-lg skeleton"}),e("div",{className:"h-10 rounded-lg skeleton"})]}):c.length===0?e("p",{className:"text-sm text-gray-500",children:"Aucun coÃ»t enregistrÃ© pour cette date."}):e("div",{className:"overflow-x-auto",children:t("table",{className:"w-full text-sm",children:[e("thead",{children:t("tr",{className:"border-b",children:[e("th",{className:"text-left py-2",children:"Trajet"}),e("th",{className:"text-left py-2",children:"Agence"}),e("th",{className:"text-left py-2",children:"Date"}),e("th",{className:"text-right py-2",children:"Carburant"}),e("th",{className:"text-right py-2",children:"Chauffeur"}),e("th",{className:"text-right py-2",children:"Convoyeur"}),e("th",{className:"text-right py-2",children:"PÃ©age"}),e("th",{className:"text-right py-2",children:"Maint."}),e("th",{className:"text-right py-2",children:"Autre"}),e("th",{className:"text-right py-2",children:"Total"}),e("th",{className:"text-left py-2",children:"Action"})]})}),e("tbody",{children:c.map(g=>t("tr",{className:"border-b",children:[e("td",{className:"py-2",children:g.tripId}),e("td",{className:"py-2",children:g.agencyId}),e("td",{className:"py-2",children:g.date}),e("td",{className:"py-2 text-right",children:Number(g.fuelCost||0).toLocaleString("fr-FR")}),e("td",{className:"py-2 text-right",children:Number(g.driverCost||0).toLocaleString("fr-FR")}),e("td",{className:"py-2 text-right",children:Number(g.assistantCost||0).toLocaleString("fr-FR")}),e("td",{className:"py-2 text-right",children:Number(g.tollCost||0).toLocaleString("fr-FR")}),e("td",{className:"py-2 text-right",children:Number(g.maintenanceCost||0).toLocaleString("fr-FR")}),e("td",{className:"py-2 text-right",children:Number(g.otherOperationalCost||0).toLocaleString("fr-FR")}),e("td",{className:"py-2 text-right font-medium",children:Bc(g).toLocaleString("fr-FR")}),e("td",{className:"py-2",children:I(g.date)?t("button",{type:"button",onClick:()=>N(g),className:"text-orange-600 hover:underline inline-flex items-center gap-0.5",children:[e(rr,{className:"w-3.5 h-3.5"})," Modifier"]}):e("span",{className:"text-gray-400",children:"â€”"})})]},g.id))})]})})]})]}):t("div",{className:"p-6",children:[e("p",{className:"text-gray-500",children:"Compagnie introuvable."}),e("button",{type:"button",onClick:()=>i(-1),className:"mt-2 text-sm text-blue-600",children:"Retour"})]})}const $p=Object.freeze(Object.defineProperty({__proto__:null,default:ru},Symbol.toStringTag,{value:"Module"})),su=({suggestions:a,loading:n=!1,offline:r=!1,company:s,onSelect:i})=>{const u=Qe(),{t:o}=mt(),c=s.couleurPrimaire||"#2563eb",m=s.couleurSecondaire||"#f3f4f6",h=d=>!d||d.length===0?"":d.length===7?o("dailyDepartures"):o("departuresPerWeek",{count:d.length});return e("section",{className:"px-3 pt-4 pb-6 dark:bg-neutral-950/70",children:t("div",{className:"max-w-5xl mx-auto",children:[t("div",{className:"flex items-center justify-center gap-2 mb-5",children:[e(Cn,{size:20,style:{color:c}}),e("h2",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:!text-white drop-shadow-[0_1px_6px_rgba(0,0,0,0.25)]",children:o("destinationsPopular")})]}),e("div",{className:"grid grid-cols-2 gap-4",children:n?Array.from({length:4}).map((d,p)=>t("div",{className:"bg-white dark:bg-neutral-800 rounded-xl p-4 border border-gray-200 dark:border-neutral-700",style:{borderColor:`${c}20`,boxShadow:`0 4px 15px ${c}08`},children:[e("div",{className:"h-4 w-3/4 rounded skeleton mb-3"}),e("div",{className:"h-5 w-1/3 rounded-full skeleton mb-3"}),e("div",{className:"h-3 w-1/2 rounded skeleton mb-4"}),e("div",{className:"h-11 w-full rounded-lg skeleton"})]},`skeleton-${p}`)):a.slice(0,4).map((d,p)=>t("div",{className:"bg-white dark:bg-neutral-800 rounded-xl p-4 border border-gray-200 dark:border-neutral-700 text-center",style:{borderColor:`${c}30`,boxShadow:`0 4px 15px ${c}12`},children:[t("div",{className:"font-semibold text-sm leading-snug text-gray-900 dark:text-gray-100",children:[d.departure," â†’"," ",e("span",{style:{color:c},children:d.arrival})]}),d.price!==void 0&&e("div",{className:"mt-3 inline-block text-xs font-bold px-3 py-1 rounded-full",style:{backgroundColor:`${m}20`,color:c},children:u(d.price)}),h(d.days)&&e("div",{className:"text-[11px] text-gray-500 dark:text-gray-300 mt-2",children:h(d.days)}),e("button",{onClick:()=>i(d.departure,d.arrival),className:"mt-4 w-full min-h-[44px] py-2 rounded-lg text-white text-sm font-semibold",style:{background:`linear-gradient(90deg, ${c}, ${m})`},children:o("reserveNowArrow")})]},p))}),!n&&a.length===0&&e("div",{className:"mt-4 rounded-xl border border-dashed border-gray-300 dark:border-neutral-700 bg-white/80 dark:bg-neutral-900/70 p-4 text-center",children:e("p",{className:"text-sm text-gray-700 dark:text-gray-200",children:r?"Connexion indisponible : impossible de charger les destinations pour le moment.":"Aucune destination populaire disponible pour le moment."})})]})})},lu=({companyName:a,primaryColor:n,secondaryColor:r,heroImageUrl:s,onSearch:i})=>{const[u,o]=l.useState(""),[c,m]=l.useState(""),{t:h}=mt(),d=x=>{x.preventDefault();const b=u.trim(),P=c.trim();!b||!P||b.toLowerCase()===P.toLowerCase()||i(b,P)},p=!u||!c||u.toLowerCase()===c.toLowerCase();return e("section",{className:"relative w-full pt-[72px]",children:t("div",{className:"relative h-[390px] sm:h-[560px] md:h-[600px] overflow-hidden",children:[!!s?t(Ae,{children:[e("img",{src:s,className:"absolute inset-0 w-full h-full object-cover",alt:"","aria-hidden":!0}),e("div",{className:"absolute inset-0 bg-black/45 dark:bg-black/60 z-0","aria-hidden":!0})]}):e("div",{className:"absolute inset-0 bg-neutral-900","aria-hidden":!0}),t("div",{className:"relative z-10 max-w-4xl mx-auto text-center px-4 pt-16 sm:pt-20",children:[e("h1",{className:"text-2xl sm:text-3xl font-bold text-white drop-shadow-[0_2px_8px_rgba(0,0,0,0.45)]",children:h("heroTitleWith")}),e("h2",{className:"mt-2 text-3xl sm:text-4xl font-extrabold truncate text-[color:var(--hero-company-color)] dark:!text-white drop-shadow-[0_2px_8px_rgba(0,0,0,0.45)]",style:{"--hero-company-color":r},children:a||h("ourCompany")}),e("form",{onSubmit:d,className:"mt-8 mx-auto max-w-3xl rounded-2xl bg-white/20 dark:bg-neutral-900/65 backdrop-blur-md border border-white/30 dark:border-white/15 shadow-2xl p-4 sm:p-5 md:p-6",children:t("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[e(Gn,{value:u,onChange:o,placeholder:h("departureCity")}),e(Gn,{value:c,onChange:m,placeholder:h("arrivalCity")}),e("div",{className:"sm:col-span-2",children:t("button",{type:"submit",disabled:p,className:"w-full min-h-[44px] inline-flex items-center justify-center px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-60 disabled:cursor-not-allowed hover:opacity-90",style:{backgroundColor:p?"rgba(120,120,120,0.7)":r},children:[e(fn,{className:"h-5 w-5 mr-2 shrink-0",style:{color:n}}),h("searchTrip")]})})]})})]})]})})},os={wifi:{label:"Wi-Fi Ã  bord",icon:ks},climatisation:{label:"Bus climatisÃ©",icon:Is},usb:{label:"Prise USB",icon:lr},boisson:{label:"Boisson offerte",icon:Rs},sieges_confort:{label:"SiÃ¨ges confort",icon:_s},tv:{label:"Ã‰cran / TV",icon:Ts},eau_fraiche:{label:"Eau fraÃ®che",icon:Ps}},iu=({services:a,primaryColor:n,secondaryColor:r})=>{const{t:s}=mt();if(!(a!=null&&a.length))return null;const i=a.filter(u=>os[u]);return i.length?e("section",{className:"py-6 px-4 bg-[color:var(--section-bg)] dark:bg-neutral-950/70",style:{"--section-bg":`${r}08`},children:t("div",{className:"max-w-5xl mx-auto",children:[t("div",{className:"flex items-center justify-center gap-2 mb-4",children:[e(Cn,{size:18,style:{color:n}}),e("h2",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:!text-white drop-shadow-[0_1px_6px_rgba(0,0,0,0.25)]",children:s("onBoardServices")})]}),e("div",{className:"rounded-2xl overflow-hidden bg-white dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700",style:{boxShadow:`0 6px 18px ${n}12`},children:e("div",{className:"grid grid-cols-2 sm:grid-cols-3",style:{borderTop:`1px solid ${n}10`,borderLeft:`1px solid ${n}10`},children:i.map(u=>{const{icon:o,label:c}=os[u];return t("div",{className:"p-4 flex items-center gap-3",style:{borderRight:`1px solid ${n}10`,borderBottom:`1px solid ${n}10`},children:[e("div",{className:"w-9 h-9 rounded-full flex items-center justify-center",style:{backgroundColor:`${r}15`},children:e(o,{size:16,style:{color:r}})}),e("span",{className:"text-sm font-medium text-gray-800 dark:text-gray-100",children:c})]},u)})})})]})}):null},ou={clock:xt,shield:er,bus:Cn,star:wn},cu=({companyName:a,items:n,primaryColor:r,secondaryColor:s="#0063ff"})=>{if(!n||n.length===0)return null;const{t:i}=mt();return e("section",{className:"py-6 px-4 bg-[color:var(--section-bg)] dark:bg-neutral-950/70",style:{"--section-bg":`${s}08`},children:t("div",{className:"max-w-5xl mx-auto",children:[t("div",{className:"flex items-center justify-center gap-2 mb-4",children:[e(Cn,{size:18,style:{color:r}}),e("h2",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:!text-white text-center drop-shadow-[0_1px_6px_rgba(0,0,0,0.25)]",children:i("whyChooseCompany",{companyName:a})})]}),e("div",{className:"rounded-2xl overflow-hidden bg-white dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700",style:{boxShadow:`0 6px 18px ${r}12`},children:e("div",{className:"grid grid-cols-2",style:{borderTop:`1px solid ${r}10`,borderLeft:`1px solid ${r}10`},children:n.slice(0,4).map((u,o)=>{const c=ou[u.icon||""]||er;return t("div",{className:"p-3 flex items-center gap-3",style:{borderRight:`1px solid ${r}10`,borderBottom:`1px solid ${r}10`},children:[e("div",{className:"w-9 h-9 rounded-full flex items-center justify-center",style:{backgroundColor:`${s}15`},children:e(c,{size:16,style:{color:s}})}),t("div",{children:[e("p",{className:"text-sm font-medium text-gray-800 dark:text-gray-100 leading-tight",children:u.label}),u.description&&e("p",{className:"text-xs text-gray-500 dark:text-gray-300 mt-1 leading-tight",children:u.description})]})]},o)})})})]})})};async function du(a,n){const r=Q(G,"companies",a,"avis");await Na(r,{nom:n.nom,note:n.note,commentaire:n.commentaire,visible:!1,createdAt:Oe()})}function mu(){const[a,n]=l.useState(!1),[r,s]=l.useState(null);return{addReview:l.useCallback(async(u,o)=>{n(!0),s(null);try{await du(u,o)}catch(c){throw s(c instanceof Error?c:new Error(String(c))),c}finally{n(!1)}},[]),loading:a,error:r}}const uu=({companyId:a,primaryColor:n})=>{const{addReview:r,loading:s}=mu(),[i,u]=l.useState(""),[o,c]=l.useState(0),[m,h]=l.useState(""),[d,p]=l.useState(!1),f=async x=>{if(x.preventDefault(),!(!i.trim()||o<1||!m.trim())&&a)try{await r(a,{nom:i.trim(),note:o,commentaire:m.trim()}),p(!0)}catch(b){console.error("Erreur envoi avis:",b)}};return d?t("div",{className:"p-6 rounded-2xl text-center space-y-3",style:{background:"rgba(16,185,129,0.12)",border:"1px solid rgba(16,185,129,0.4)"},children:[e(rt,{size:42,style:{color:"#10b981"},className:"mx-auto"}),e("h4",{className:"text-lg font-semibold text-white",children:"Merci pour votre avis !"})]}):t("form",{onSubmit:f,className:"space-y-5",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-white mb-1",children:"Votre nom"}),e("input",{type:"text",value:i,onChange:x=>u(x.target.value),className:"w-full px-3 py-2 rounded-lg bg-gray-100 text-gray-900 border border-gray-300",required:!0})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-white mb-2",children:"Votre note"}),e("div",{className:"flex gap-2",children:[1,2,3,4,5].map(x=>e(wn,{onClick:()=>c(x),className:"h-7 w-7 cursor-pointer",style:{color:x<=o?n:"#64748b",fill:x<=o?n:"none"}},x))})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-white mb-1",children:"Votre avis"}),e("textarea",{value:m,onChange:x=>h(x.target.value),rows:4,className:"w-full px-3 py-2 rounded-lg bg-gray-100 text-gray-900 border border-gray-300",required:!0})]}),e("button",{type:"submit",disabled:s,className:"w-full text-white font-semibold py-2.5 rounded-lg",style:{background:`linear-gradient(135deg, ${n}, ${n}CC)`},children:s?"Envoi en cours...":"Envoyer mon avis"})]})},pu=({company:a})=>{const[n,r]=l.useState(!1),{t:s}=mt(),i=new Date().getFullYear(),{id:u,slug:o,nom:c,couleurPrimaire:m="#3B82F6",couleurSecondaire:h="#22D3EE",description:d,email:p,telephone:f,adresse:x,horaires:b,socialMedia:P={},footerConfig:C={}}=a,{showAbout:j=!0,showContact:L=!0,showSocial:M=!0,showTestimonials:_=!0,showLegalLinks:F=!0,customLinks:D=[]}=C;return t("footer",{className:"relative w-full overflow-hidden text-white",style:{background:"linear-gradient(180deg, #0f172a 0%, #0b1220 100%)"},children:[e("div",{className:"absolute top-0 left-0 right-0 h-1",style:{background:`linear-gradient(90deg, ${m}, ${h})`}}),t("div",{className:"relative z-10 max-w-7xl mx-auto px-6 py-14 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10",children:[j&&t(Ve.div,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},transition:{duration:.5},children:[t("div",{className:"flex items-center gap-2 mb-4",children:[e(sa,{className:"h-5 w-5",style:{color:h}}),e("h3",{className:"text-lg font-semibold tracking-wide",children:s("about")})]}),e("p",{className:"text-sm text-gray-300 leading-relaxed",children:d||s("defaultAbout")})]}),L&&t(Ve.div,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},transition:{duration:.5,delay:.1},children:[t("div",{className:"flex items-center gap-2 mb-4",children:[e(Wt,{className:"h-5 w-5",style:{color:h}}),e("h3",{className:"text-lg font-semibold tracking-wide",children:s("contact")})]}),t("ul",{className:"space-y-3 text-sm text-gray-300",children:[f&&t("li",{className:"flex items-center gap-2 hover:text-white transition",children:[e(Wt,{className:"h-4 w-4 text-gray-400"}),e("a",{href:`tel:${f}`,children:f})]}),p&&t("li",{className:"flex items-center gap-2 hover:text-white transition",children:[e(Ms,{className:"h-4 w-4 text-gray-400"}),e("a",{href:`mailto:${p}`,children:p})]}),x&&t("li",{className:"flex items-center gap-2",children:[e(Kt,{className:"h-4 w-4 text-gray-400"}),x]}),b&&t("li",{className:"flex items-center gap-2",children:[e(xt,{className:"h-4 w-4 text-gray-400"}),b]})]})]}),M&&Object.values(P).some(Boolean)&&t(Ve.div,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},transition:{duration:.5,delay:.2},children:[t("div",{className:"flex items-center gap-2 mb-4",children:[e(_r,{className:"h-5 w-5",style:{color:h}}),e("h3",{className:"text-lg font-semibold tracking-wide",children:s("followUs")})]}),t("div",{className:"flex gap-4",children:[P.facebook&&e("a",{href:P.facebook,target:"_blank",rel:"noopener noreferrer",className:"hover:scale-110 transition",children:e(Vi,{className:"h-6 w-6 text-gray-300 hover:text-white"})}),P.instagram&&e("a",{href:P.instagram,target:"_blank",rel:"noopener noreferrer",className:"hover:scale-110 transition",children:e(Hi,{className:"h-6 w-6 text-gray-300 hover:text-white"})}),P.twitter&&e("a",{href:P.twitter,target:"_blank",rel:"noopener noreferrer",className:"hover:scale-110 transition",children:e(Yi,{className:"h-6 w-6 text-gray-300 hover:text-white"})}),P.linkedin&&e("a",{href:P.linkedin,target:"_blank",rel:"noopener noreferrer",className:"hover:scale-110 transition",children:e(Ki,{className:"h-6 w-6 text-gray-300 hover:text-white"})}),P.youtube&&e("a",{href:P.youtube,target:"_blank",rel:"noopener noreferrer",className:"hover:scale-110 transition",children:e(Wi,{className:"h-6 w-6 text-gray-300 hover:text-white"})})]})]}),_&&t(Ve.div,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},transition:{duration:.5,delay:.3},children:[t("div",{className:"flex items-center gap-2 mb-4",children:[e(_r,{className:"h-5 w-5",style:{color:h}}),e("h3",{className:"text-lg font-semibold tracking-wide",children:s("customerReviews")})]}),t(Ve.button,{onClick:()=>r(!n),className:"w-full flex items-center justify-between px-5 py-3 rounded-xl text-sm font-semibold transition-all",style:{background:`linear-gradient(135deg, ${m}, ${h})`,boxShadow:`0 10px 25px ${m}40`},whileHover:{scale:1.03},whileTap:{scale:.97},children:[e("span",{children:s("leaveReview")}),n?e(Ta,{size:16}):e(ya,{size:16})]}),n&&e("div",{className:"mt-5",children:e(uu,{companyId:u,primaryColor:m})})]})]}),(F||D.length>0)&&e("div",{className:"border-t border-white/10 mt-8 pt-6 pb-8 text-center text-sm text-gray-400",children:t("div",{className:"max-w-7xl mx-auto px-6 space-y-4",children:[t("div",{className:"flex flex-wrap justify-center gap-5",children:[F&&t(Ae,{children:[e("a",{href:`/${o}/mentions-legales`,className:"hover:text-white transition",children:s("legalNotice")}),e("a",{href:`/${o}/confidentialite`,className:"hover:text-white transition",children:s("privacyPolicy")}),e("a",{href:`/${o}/conditions`,className:"hover:text-white transition",children:s("termsConditions")}),e("a",{href:`/${o}/cookies`,className:"hover:text-white transition",children:s("cookiePolicy")})]}),D.map((k,S)=>e("a",{href:k.url,target:k.external?"_blank":"_self",rel:k.external?"noopener noreferrer":"",className:"hover:text-white transition",children:k.label},S))]}),t("p",{className:"text-gray-500",children:["Â© ",i," ",c||s("ourCompany")," â€” ",s("allRightsReserved")]})]})})]})},gu=({agence:a,primaryColor:n})=>t(Ve.div,{initial:{opacity:0,y:-5},animate:{opacity:1,y:0},transition:{duration:.2},className:"p-5 my-3 rounded-xl shadow-sm hover:shadow-md transition-all",style:{backgroundColor:"#ffffff",borderLeft:`4px solid ${n}`,boxShadow:"0 2px 12px rgba(0,0,0,0.05)"},children:[t("div",{className:"flex justify-between items-start",children:[e("h3",{className:"font-bold text-lg mb-2",style:{color:n},children:a.nomAgence}),a.latitude&&a.longitude&&t("a",{href:`https://www.google.com/maps/dir/?api=1&destination=${a.latitude},${a.longitude}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-1 text-sm px-2 py-1 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors",children:[e(Ji,{className:"h-3 w-3"}),e("span",{children:"Maps"})]})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 text-sm",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 rounded-full bg-gray-100",children:e(wa,{className:"h-4 w-4",style:{color:n}})}),e("span",{className:"text-gray-700",children:a.pays})]}),a.quartier&&t("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 rounded-full bg-gray-100",children:e(Kt,{className:"h-4 w-4",style:{color:n}})}),e("span",{className:"text-gray-700",children:a.quartier})]}),a.telephone&&t("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 rounded-full bg-gray-100",children:e(Wt,{className:"h-4 w-4",style:{color:n}})}),e("a",{href:`tel:${a.telephone}`,className:"text-gray-700 hover:underline hover:text-gray-900 transition-colors",children:a.telephone})]})]})]}),hu=({groupedByVille:a,openVilles:n,toggleVille:r,onClose:s,primaryColor:i,classes:u,t:o})=>e(Ve.section,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4",onClick:s,children:t(Ve.div,{className:"relative w-full max-w-3xl max-h-[85vh] overflow-y-auto rounded-2xl",initial:{scale:.96,y:20},animate:{scale:1,y:0},exit:{scale:.96,y:20},transition:{type:"spring",damping:25},onClick:c=>c.stopPropagation(),style:{backgroundColor:"#ffffff",boxShadow:"0 10px 30px rgba(0,0,0,0.15)"},children:[t("div",{className:"sticky top-0 p-5 flex justify-between items-center z-10 border-b border-gray-100",style:{backdropFilter:"blur(12px)",backgroundColor:"rgba(255,255,255,0.85)"},children:[e("h2",{className:"text-2xl font-bold",style:{color:i},children:o("ourAgencies")}),e("button",{onClick:s,className:"p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":o("close"),children:e(cn,{className:"h-6 w-6 text-gray-600"})})]}),e("div",{className:"p-5",children:Object.entries(a).map(([c,m])=>t("div",{className:"mb-5",children:[t(Ve.button,{onClick:()=>r(c),className:"w-full text-left py-4 px-5 rounded-xl flex justify-between items-center transition-colors",whileHover:{backgroundColor:"rgba(0,0,0,0.03)"},style:{backgroundColor:n[c]?"rgba(0,0,0,0.02)":"transparent",color:"#333"},children:[t("div",{className:"flex items-center gap-3",children:[e("span",{className:"font-semibold text-lg",children:c}),t("span",{className:"text-sm px-2 py-1 rounded-full",style:{backgroundColor:`${i}20`,color:i},children:[m.length," ",m.length>1?o("agencies"):o("agency")]})]}),n[c]?e(Ta,{className:"h-5 w-5 text-gray-500"}):e(ya,{className:"h-5 w-5 text-gray-500"})]}),e(va,{children:n[c]&&e(Ve.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.25,ease:"easeInOut"},className:"overflow-hidden pl-5 ml-2 border-l-2",style:{borderColor:`${i}40`},children:m.map((h,d)=>e(gu,{agence:h,primaryColor:i},`${h.id}-${d}`))})})]},c))})]})}),fu=({companyId:a,primaryColor:n,secondaryColor:r})=>{const[s,i]=l.useState([]),{t:u}=mt();return l.useEffect(()=>{if(!a)return;(async()=>{var c;try{const m=ce(Q(G,`companies/${a}/avis`),ne("visible","==",!0),ot("createdAt","desc"),Re(5)),d=(await ee(m)).docs.map(p=>{const f=p.data();return{id:p.id,nom:f.nom,note:f.note,commentaire:f.commentaire}});i(d)}catch(m){((m==null?void 0:m.code)==="permission-denied"||(c=m==null?void 0:m.message)!=null&&c.includes("permissions"))&&console.warn("AvisListePublic: lecture avis refusÃ©e (rÃ¨gles Firestore ou index manquant). DÃ©ployer firestore.rules et firestore.indexes.json."),i([])}})()},[a]),s.length===0?null:e("section",{className:"py-5 px-4",style:{backgroundColor:`${r}08`},children:t("div",{className:"max-w-5xl mx-auto",children:[t("div",{className:"flex items-center justify-center gap-2 mb-4",children:[e($s,{size:18,style:{color:n}}),e("h2",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-white text-center",children:u("customerReviews")})]}),e("div",{className:"rounded-2xl border border-gray-200 dark:border-neutral-700 overflow-hidden bg-white dark:bg-neutral-800",style:{borderColor:`${n}30`,boxShadow:`0 4px 15px ${n}10`},children:e("div",{className:"grid sm:grid-cols-2 md:grid-cols-3 divide-x divide-y",children:s.map(o=>t("div",{className:"p-4 flex flex-col",children:[e("div",{className:"flex gap-1 mb-2",children:[...Array(5)].map((c,m)=>e(wn,{size:14,style:{color:m<o.note?r:"#e5e7eb",fill:m<o.note?r:"none"}},m))}),t("p",{className:"text-sm text-gray-700 dark:text-gray-200 italic mb-3 line-clamp-3",children:["â€œ",o.commentaire,"â€"]}),e("p",{className:"text-sm font-medium mt-auto",style:{color:n},children:o.nom})]},o.id))})})]})})},yu=({primaryColor:a="#334155",secondaryColor:n="#6366f1"})=>{const{i18n:r}=mt(),i=(r.language||"fr").toLowerCase().split("-")[0]==="fr",u="text-white",o="text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-neutral-800",c=()=>{r.changeLanguage("fr")},m=()=>{r.changeLanguage("en")};return t("div",{className:"flex items-center gap-1",style:{"--teliya-primary":a,"--teliya-secondary":n},children:[e("button",{type:"button",onClick:c,className:`min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg text-lg transition ${i?u:o}`,style:i?{backgroundColor:"var(--teliya-secondary)"}:void 0,"aria-label":"FranÃ§ais",title:"FranÃ§ais",children:"ðŸ‡«ðŸ‡·"}),e("button",{type:"button",onClick:m,className:`min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg text-lg transition ${i?o:u}`,style:i?void 0:{backgroundColor:"var(--teliya-secondary)"},"aria-label":"English",title:"English",children:"ðŸ‡¬ðŸ‡§"})]})},bu="public-theme-dark",xu="#FF6600",vu=({company:a,slug:n,colors:r,navigate:s,t:i})=>{const u=r.primary||xu,[o,c]=l.useState(()=>typeof document>"u"?!1:document.documentElement.classList.contains("dark"));l.useEffect(()=>{if(!(a!=null&&a.logoUrl))return;const p=new Image;p.src=a.logoUrl},[a==null?void 0:a.logoUrl]);const m=()=>{const p=document.documentElement.classList.contains("dark");document.documentElement.classList.toggle("dark");const f=!p;c(f);try{localStorage.setItem(bu,String(f))}catch{}},h=(a==null?void 0:a.nom)||i("ourCompany",{defaultValue:"Notre compagnie"}),d=({name:p})=>{const f=(p||"C").trim().charAt(0).toUpperCase();return e("div",{className:"h-10 w-10 rounded-full flex items-center justify-center text-white font-bold",style:{backgroundColor:u},children:f})};return e("header",{className:"fixed top-0 left-0 right-0 h-[72px] z-50 bg-white/80 dark:bg-neutral-900/80 backdrop-blur-md border-b border-gray-200 dark:border-neutral-800",style:{"--teliya-primary":u,"--teliya-secondary":r.secondary||u},children:t("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 h-full flex items-center justify-between",children:[t("button",{onClick:()=>s("/"),className:"flex items-center gap-3 min-w-0 select-none","aria-label":h,children:[e("div",{className:"h-10 w-10 rounded-full bg-white overflow-hidden grid place-items-center shadow-sm shrink-0",style:{border:`2px solid ${u}`},children:a!=null&&a.logoUrl?e("img",{src:a.logoUrl,alt:`Logo ${h}`,className:"w-full h-full object-contain",loading:"eager",decoding:"async"}):e(d,{name:h})}),e("span",{className:"text-lg md:text-xl font-bold tracking-tight truncate max-w-[140px] sm:max-w-[200px] md:max-w-none text-[var(--teliya-primary)] dark:!text-white",children:h})]}),t("div",{className:"flex items-center gap-2 sm:gap-3 shrink-0 text-gray-900 dark:text-white",children:[e(yu,{primaryColor:u,secondaryColor:r.secondary||u}),e("button",{type:"button",onClick:m,className:"inline-flex items-center justify-center min-h-[44px] min-w-[44px] rounded-full hover:bg-black/10 dark:hover:bg-white/10 transition","aria-label":i(o?"themeLight":"themeDark"),style:{color:u},children:o?e(Ss,{className:"h-5 w-5"}):e(As,{className:"h-5 w-5"})}),e("button",{onClick:()=>s("/login"),className:"inline-flex items-center justify-center min-h-[44px] min-w-[44px] rounded-full bg-black/10 dark:bg-white/20 ring-1 ring-black/10 dark:ring-white/30 hover:opacity-90 transition","aria-label":i("login"),style:{color:u},children:e(xn,{className:"h-5 w-5"})})]})]})})},cs=({message:a="La page demandÃ©e est introuvable.",primaryColor:n,buttonLabel:r="Retour Ã  l'accueil"})=>{const s=Be();return e("div",{className:"min-h-screen flex items-center justify-center bg-black text-white p-6",children:t(Ve.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"text-center max-w-md",children:[e(Ct,{className:"mx-auto mb-4 h-16 w-16 text-red-500"}),e("h1",{className:"text-3xl font-bold mb-2",children:"Erreur 404"}),e("p",{className:"mb-6 text-gray-300",children:a}),e("button",{onClick:()=>s("/"),className:"px-6 py-3 rounded-lg font-semibold text-white transition shadow-lg",style:{backgroundColor:n},children:r})]})})},Nu=new Map;function wu(a){return Nu.get(a)}const vl="public-company-suggestions:",Nl=new Map;function Cu(a){const n=Nl.get(a);if(n&&n.length>0)return n;try{const r=sessionStorage.getItem(`${vl}${a}`);if(!r)return null;const s=JSON.parse(r);return Array.isArray(s)?s.slice(0,6):null}catch{return null}}function Su(a,n){const r=n.slice(0,6);Nl.set(a,r);try{sessionStorage.setItem(`${vl}${a}`,JSON.stringify(r))}catch{}}const Au=({company:a})=>{var R,w;const{slug:n=""}=De(),r=Be(),{t:s}=mt(),i=Tt(),u=wu(n),[o,c]=l.useState(a||u),{colors:m,config:h}=lt(o),[d,p]=l.useState([]),[f,x]=l.useState([]),[b,P]=l.useState(!1),[C,j]=l.useState(!1),[L,M]=l.useState(null),[_,F]=l.useState({}),D=N=>{F(g=>({...g,[N]:!g[N]}))},k=l.useMemo(()=>d.reduce((N,g)=>(N[g.ville]||(N[g.ville]=[]),N[g.ville].push(g),N),{}),[d]);l.useEffect(()=>{o||!n||(async()=>{try{const N=ce(Q(G,"companies"),ne("slug","==",n),Re(1)),g=await ee(N);g.empty?M("notFound"):c({id:g.docs[0].id,...g.docs[0].data()})}catch(N){console.warn("PublicCompanyPage â–º fetch company",N),M(s("loadingError"))}})()},[n]),l.useEffect(()=>{if(!(o!=null&&o.id))return;let N=!1;const g=o.id,v=Cu(g);return v&&v.length>0&&x(v),(async()=>{P(!(v&&v.length>0));try{const E=await ee(Q(G,"companies",g,"agences"));if(N)return;const B=E.docs.map(T=>({id:T.id,...T.data()}));if(p(B),E.empty){x([]);return}const V=await Promise.all(E.docs.map(T=>ee(Q(G,"companies",g,"agences",T.id,"weeklyTrips"))));if(N)return;const K=new Map;for(const T of V){for(const W of T.docs){const q=W.data(),H=q.depart||q.departure,le=q.arrivee||q.arrival,te=q.price??q.prix??0;if(!H||!le)continue;const ae=`${H}_${le}`;if(!K.has(ae)&&(K.set(ae,{departure:H,arrival:le,price:te}),K.size>=6))break}if(K.size>=6)break}const z=Array.from(K.values());x(z),Su(g,z)}catch(E){console.warn("Suggestions/agences error:",E),N||(v&&v.length>0||x([]),p([]))}finally{N||P(!1)}})(),()=>{N=!0}},[o==null?void 0:o.id]);const S=!!(o!=null&&o.publicPageEnabled),O=S&&!!(o!=null&&o.onlineBookingEnabled);if(L==="notFound")return e(cs,{primaryColor:m.primary||"#FF6600"});if(!o||!S)return e(cs,{primaryColor:m.primary||"#FF6600"});const I=N=>{var v;const g=[];if((v=N.createdAt)!=null&&v.toDate){const U=N.createdAt.toDate().getFullYear(),B=new Date().getFullYear()-U;B>0&&g.push({label:s("yearsExperience",{count:B}),icon:"award"})}return N.onlineBookingEnabled&&g.push({label:s("fastOnlineBooking"),icon:"clock"}),N.services&&N.services.length>0&&g.push({label:s("modernOnBoardServices"),icon:"bus"}),g.push({label:s("safeTrips"),icon:"shield"}),g.slice(0,4)},$=(R=o==null?void 0:o.whyChooseUs)!=null&&R.items&&o.whyChooseUs.items.length>0?o.whyChooseUs.items:I(o);return t("div",{className:`min-h-screen flex flex-col ${h.typography}`,style:{backgroundColor:m.background||"#ffffff",color:m.text},children:[e(vu,{company:o,colors:m,slug:n,navigate:r,t:s}),t("div",{className:`${O?"pt-0":"pt-[72px]"} flex flex-col flex-grow min-h-0`,children:[t("main",{className:"flex-grow",children:[O&&t(Ae,{children:[e(lu,{companyName:(o==null?void 0:o.nom)??"",primaryColor:m.primary,secondaryColor:m.secondary,heroImageUrl:(o==null?void 0:o.banniereUrl)??((w=o==null?void 0:o.imagesSlider)==null?void 0:w[0]),onSearch:(N,g)=>{r(`/${n}/booking?departure=${encodeURIComponent(N)}&arrival=${encodeURIComponent(g)}`)}}),e(su,{suggestions:f,loading:b,offline:!i,company:o,onSelect:(N,g)=>{r(`/${n}/booking?departure=${encodeURIComponent(N)}&arrival=${encodeURIComponent(g)}`)}})]}),$.length>0&&e(cu,{companyName:o.nom,items:$,primaryColor:m.primary}),Array.isArray(o.services)&&o.services.length>0&&e(iu,{services:o.services,primaryColor:m.primary,secondaryColor:m.secondary}),e(fu,{companyId:o.id,primaryColor:m.primary,secondaryColor:m.secondary}),e(va,{children:C&&e(hu,{groupedByVille:k,openVilles:_,toggleVille:D,onClose:()=>j(!1),primaryColor:m.primary,t:s,classes:void 0})})]}),e(pu,{company:o})]})]})},Eu=Object.freeze(Object.defineProperty({__proto__:null,default:Au},Symbol.toStringTag,{value:"Module"})),ku=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],ga=(a,n=1)=>{const r=parseInt(a.slice(1,3),16),s=parseInt(a.slice(3,5),16),i=parseInt(a.slice(5,7),16);return`rgba(${r}, ${s}, ${i}, ${n})`},ds=a=>{if(a.length<7)return"#000000";const n=parseInt(a.slice(1,3),16),r=parseInt(a.slice(3,5),16),s=parseInt(a.slice(5,7),16);return(.299*n+.587*r+.114*s)/255>.5?"#000000":"#ffffff"},Iu=({company:a})=>{var g;const{t:n}=mt(),r=Xt(),s=Be(),i=Qe(),u=new URLSearchParams(r.search),o=u.get("departure")||"",c=u.get("arrival")||"",[m,h]=l.useState([]),[d,p]=l.useState(""),[f,x]=l.useState(""),[b,P]=l.useState(!0),[C,j]=l.useState(null),[L,M]=l.useState(0),_=Tt(),F=l.useMemo(()=>{const v=a.couleurPrimaire||"#3b82f6",U=a.couleurSecondaire||"#93c5fd";return{colors:{primary:v,secondary:U,text:ds(v),textOnPrimary:ds(v),background:"#ffffff"},classes:{card:"bg-white rounded-xl shadow-sm border border-gray-200",button:"transition-all hover:scale-105 active:scale-95",animations:"transition-all duration-300 ease-in-out",header:"sticky top-0 z-50 px-4 py-3"}}},[a]),{colors:D,classes:k}=F,S=l.useMemo(()=>{const v=new Date;return Array.from({length:8},(U,E)=>{const B=new Date(v);return B.setDate(B.getDate()+E),B.toISOString().split("T")[0]})},[]),O=l.useMemo(()=>m.filter(v=>v.date===d),[m,d]);l.useEffect(()=>{(async()=>{var U;if(!a.id||!o||!c){P(!1),j("Informations de recherche incomplÃ¨tes.");return}P(!0),j(null);try{const B=(await ee(Q(G,"companies",a.id,"agences"))).docs.map(z=>({id:z.id})),V=[];for(const z of B){const W=(await ee(ce(Q(G,"companies",a.id,"agences",z.id,"weeklyTrips"),ne("active","==",!0)))).docs.map(le=>({id:le.id,...le.data()})),H=(await ee(Q(G,"companies",a.id,"agences",z.id,"reservations"))).docs.map(le=>le.data());for(const le of S){const te=new Date(le),ae=ku[te.getDay()];for(const de of W){if(de.departure.toLowerCase()!==o.toLowerCase()||de.arrival.toLowerCase()!==c.toLowerCase())continue;const re=((U=de.horaires)==null?void 0:U[ae])||[];for(const pe of re){const he=`${de.id}_${le}_${pe}`,y=H.filter(J=>J.trajetId===he&&pn(J.statut)==="paye"),A=(de.places||30)-y.reduce((J,se)=>J+se.seatsGo,0);A>0&&V.push({id:he,date:le,time:pe,departure:de.departure,arrival:de.arrival,price:de.price,places:de.places||30,remainingSeats:A,agencyId:z.id})}}}}h(V);const K=[...new Set(V.map(z=>z.date))];p(K[0]||"")}catch(E){console.error("Erreur Firestore:",E),j("Erreur lors du chargement des trajets")}finally{P(!1)}})()},[a.id,S,o,c,L]),l.useEffect(()=>{var v;if(O.length>0){const U=[...O].sort((E,B)=>E.time.localeCompare(B.time));x(((v=U[0])==null?void 0:v.time)||"")}},[d,O]);const I=v=>{p(v)},$=v=>{x(v)},R=()=>{const v=O.find(U=>U.time===f);v&&s(`/${a.slug}/booking`,{state:{tripData:{...v,companyId:a.id,agencyId:v.agencyId,compagnieNom:a.nom,logoUrl:a.logoUrl},companyInfo:{id:a.id,slug:a.slug,nom:a.nom,logoUrl:a.logoUrl,primaryColor:D.primary}}})},w=v=>new Date(v).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"}),N=(v,U)=>new Date(`${v}T${U}`).getTime()<new Date().getTime();return b?e("div",{className:"min-h-screen p-4 sm:p-6",style:{background:D.background},children:e("div",{className:"max-w-4xl mx-auto",children:e(gn,{blocks:3})})}):C?e("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",style:{background:D.background},children:t("div",{className:`p-4 rounded-lg max-w-md ${k.card}`,children:[e("h2",{className:"text-xl font-bold mb-2 text-gray-900",children:"Erreur"}),e("p",{className:"text-gray-700",children:C}),!_&&e("p",{className:"text-sm text-amber-700 mt-2",children:"Vous semblez hors ligne. VÃ©rifiez votre connexion puis rÃ©essayez."}),e("button",{onClick:()=>M(v=>v+1),className:`mt-4 px-4 py-2 rounded ${k.button}`,style:{backgroundColor:D.secondary,color:"#111827"},children:"RÃ©essayer"}),e("button",{onClick:()=>s(`/${a.slug}`),className:`mt-2 px-4 py-2 rounded ${k.button}`,style:{backgroundColor:D.primary,color:D.textOnPrimary},children:"Retour Ã  la compagnie"})]})}):t("div",{className:"min-h-screen",style:{background:D.background,color:D.text},children:[e("header",{className:k.header,style:{backgroundColor:ga(D.primary,.95),color:D.textOnPrimary,backdropFilter:"blur(10px)"},children:t("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e("button",{onClick:()=>s(`/${a.slug}`),className:"p-2 rounded-full hover:bg-white/10 transition",style:{color:D.textOnPrimary},children:e(At,{className:"h-5 w-5"})}),t("div",{className:"flex items-center gap-2",children:[a.logoUrl&&e(Vn.LazyLoadImage,{src:a.logoUrl,alt:`Logo ${a.nom}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:D.textOnPrimary,backgroundColor:ga(D.primary,.2)}}),t("div",{children:[e("h1",{className:"text-lg font-bold",children:"RÃ©sultats de recherche"}),t("p",{className:"text-xs opacity-80",children:[o," â†’ ",c]})]})]})]})}),t("main",{className:"max-w-4xl mx-auto p-4 sm:p-6 pb-24",children:[t("div",{className:`p-4 rounded-xl mb-6 ${k.card}`,children:[e("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2",children:t("span",{children:[o," â†’ ",c]})}),t("div",{className:"mb-4",children:[t("h3",{className:"text-lg font-semibold mb-3 flex items-center gap-2 text-gray-800",children:[e(dt,{className:"h-5 w-5",style:{color:D.primary}}),"Choisissez votre date de dÃ©part"]}),e("div",{className:"flex gap-2 overflow-x-auto pb-4 scrollbar-hide",children:S.map(v=>t("button",{onClick:()=>I(v),className:`flex flex-col items-center min-w-[90px] p-3 rounded-xl border transition-all flex-shrink-0 ${d===v?"shadow-md":"bg-white hover:bg-gray-50 border-gray-200 text-gray-800"}`,style:{backgroundColor:d===v?D.primary:void 0,borderColor:d===v?D.primary:void 0,color:d===v?D.textOnPrimary:void 0},children:[e("span",{className:"text-xs font-medium",children:w(v)}),e("span",{className:"text-sm mt-1",children:new Date(v).toLocaleDateString("fr-FR",{day:"numeric"})})]},v))})]}),O.length===0?t("div",{className:`p-6 rounded-xl text-center ${k.card} text-gray-800`,children:[e("div",{className:"bg-gray-100 p-4 rounded-full inline-flex mb-3",children:e(xt,{className:"h-6 w-6 text-gray-500"})}),e("h3",{className:"text-lg font-medium mb-1",children:"Aucun trajet disponible pour cette date"}),e("p",{className:"text-sm opacity-80",children:"Veuillez choisir une autre date"})]}):e("div",{className:"space-y-4",children:t("div",{className:`rounded-xl overflow-hidden ${k.card}`,children:[t("div",{className:"p-4 border-b",style:{borderColor:ga(D.primary,.1)},children:[t("h3",{className:"font-semibold flex items-center gap-2 mb-3 text-gray-800",children:[e(xt,{className:"h-5 w-5",style:{color:D.primary}}),"Choisissez votre heure de dÃ©part"]}),e("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2",children:O.sort((v,U)=>v.time.localeCompare(U.time)).map(v=>t("button",{onClick:()=>$(v.time),disabled:N(v.date,v.time),className:`p-3 rounded-lg border flex flex-col items-center transition ${f===v.time?"bg-blue-50 text-blue-600":N(v.date,v.time)?"bg-gray-50 text-gray-400":"border-gray-200 hover:border-blue-300 hover:bg-blue-50 text-gray-800"}`,style:{borderColor:f===v.time?D.primary:void 0,backgroundColor:f===v.time?ga(D.primary,.1):void 0},children:[e("span",{className:"font-medium",children:v.time}),t("span",{className:"text-xs mt-1",children:[v.remainingSeats," places"]})]},v.id))})]}),O.filter(v=>v.time===f&&!N(v.date,v.time)).map(v=>e("div",{className:"p-4",children:t("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 text-gray-800",children:[t("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 rounded-full",style:{backgroundColor:ga(D.primary,.1),color:D.primary},children:e(hn,{className:"h-5 w-5"})}),t("div",{children:[e("h3",{className:"text-sm font-medium opacity-80",children:"Prix"}),e("p",{className:"text-lg font-bold text-gray-900",children:i(v.price)})]})]}),t("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 rounded-full",style:{backgroundColor:ga(D.primary,.1),color:D.primary},children:e(Oa,{className:"h-5 w-5"})}),t("div",{children:[e("h3",{className:"text-sm font-medium opacity-90",children:"Places disponibles"}),e("p",{className:`text-lg font-bold ${v.remainingSeats===0?"text-red-600":v.remainingSeats<=10?"text-yellow-600":"text-green-600"}`,children:v.remainingSeats})]})]})]})},v.id))]})})]}),f&&e("div",{className:"fixed bottom-0 left-0 right-0 bg-white shadow-lg p-4 border-t border-gray-200",children:t("div",{className:"max-w-xl mx-auto flex justify-between items-center",children:[t("div",{children:[e("p",{className:"text-sm text-gray-600",children:"Total"}),e("p",{className:"text-xl font-bold text-gray-900",children:i(((g=O.find(v=>v.time===f))==null?void 0:g.price)??0)})]}),e("button",{onClick:R,disabled:!f,className:`px-6 py-3 rounded-lg font-bold ${k.button} ${f?"":"opacity-50 cursor-not-allowed"}`,style:{backgroundColor:D.primary,color:D.textOnPrimary},children:n("reserveNow")})]})})]})]})},Ru=Object.freeze(Object.defineProperty({__proto__:null,default:Iu},Symbol.toStringTag,{value:"Module"}));function _u(a,n){const r=(a??"").toLowerCase();return r==="guichet"?"Paiement en espÃ¨ces":n&&n.trim()?n.trim():r==="en_ligne"?"Paiement en ligne":"Paiement"}const Tu=({companyName:a,logoUrl:n,primaryColor:r,secondaryColor:s,agencyName:i,receiptNumber:u,statut:o="CONFIRMÃ‰",nomClient:c,telephone:m,depart:h,arrivee:d,date:p,heure:f,seats:x,canal:b="EN LIGNE",montant:P,qrValue:C,emissionDate:j,paymentMethod:L})=>{const M=Qe(),_=tt(r),F=s||r,k=(I=>I.toLowerCase().split(" ").map($=>$.charAt(0).toUpperCase()+$.slice(1)).join(" "))(c),S=_u(b,L),O=xi(o);return t("div",{className:"ticket-force-light w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg overflow-hidden text-sm",children:[e("div",{className:"px-4 py-3",style:{backgroundColor:r,color:_},children:t("div",{className:"flex items-center justify-between",children:[t("div",{className:"flex items-center gap-2",children:[n&&e("img",{src:n,alt:a,className:"h-8 w-8 rounded-full object-cover border",style:{borderColor:_}}),t("div",{children:[e("h1",{className:"font-bold uppercase text-sm leading-tight",children:a}),i&&e("p",{className:"text-[10px] opacity-90",children:i})]})]}),t("div",{className:"text-right text-[10px] font-mono",children:[e("p",{children:u}),e("p",{children:j})]})]})}),t("div",{className:"px-4 py-1.5 flex justify-between items-center bg-gray-50 border-b text-[10px]",children:[e("span",{className:"font-bold px-2 py-0.5 rounded-full",style:{backgroundColor:F,color:tt(F)},children:o}),e("span",{className:"uppercase tracking-wide text-gray-600",children:b})]}),e("div",{className:"px-4 py-3 border-b",children:t("div",{className:"flex justify-between items-center",children:[t("div",{className:"flex items-center gap-2",children:[e(xn,{size:14,style:{color:F}}),e("span",{className:"font-semibold",children:k})]}),t("div",{className:"flex items-center gap-2",children:[e(Wt,{size:14,style:{color:F}}),e("span",{children:m})]})]})}),t("div",{className:"px-4 py-4",children:[t("div",{className:"flex items-center justify-center gap-2 text-base font-bold uppercase mb-3",children:[e("span",{children:h}),e(Nn,{size:16,style:{color:F}}),e("span",{children:d})]}),t("div",{className:"grid grid-cols-3 gap-2 text-[11px] rounded-xl p-2",style:{backgroundColor:`${F}15`},children:[t("div",{className:"flex flex-col items-center gap-1",children:[e(dt,{size:14,style:{color:F}}),e("span",{className:"font-semibold",children:p})]}),t("div",{className:"flex flex-col items-center gap-1",children:[e(xt,{size:14,style:{color:F}}),e("span",{className:"font-semibold",children:f})]}),t("div",{className:"flex flex-col items-center gap-1",children:[e(Oa,{size:14,style:{color:F}}),e("span",{className:"font-semibold",children:x})]})]})]}),e("div",{className:"px-4 py-3 border-t border-b bg-gray-50",children:t("div",{className:"flex justify-between items-center",children:[e("p",{className:"text-lg font-bold",style:{color:r},children:M(P)}),e("span",{className:"text-[10px] text-gray-600 uppercase",children:S})]})}),e("div",{className:"px-4 py-4 text-center",children:O?t(Ae,{children:[e("p",{className:"text-[10px] uppercase mb-2 font-semibold",style:{color:F},children:"Code dâ€™embarquement"}),e("div",{className:"inline-block bg-white p-2 rounded-xl shadow",children:e(ai,{value:C,size:95,fgColor:"#000000",bgColor:"#ffffff",level:"H"})}),e("p",{className:"text-[10px] font-mono mt-2 font-semibold",children:u})]}):e("p",{className:"text-[10px] text-gray-500 italic",children:"Code dâ€™embarquement disponible aprÃ¨s confirmation du paiement."})}),t("div",{className:"px-4 py-3 text-center text-[10px] text-gray-600 border-t space-y-1",children:[e("p",{className:"font-semibold",children:Ga.control}),e("p",{children:Ga.validity}),t("p",{children:["Merci dâ€™avoir choisi ",a]}),e("p",{className:"italic",children:Ga.arrival}),e("p",{children:Ga.keep})]})]})},Pu=()=>{const a=De(),n=Xt(),r=Be(),s=l.useMemo(()=>n.pathname.split("/").filter(Boolean),[n.pathname]),i=a.slug??s[0]??"",u=a.id??(s[1]==="receipt"?s[2]:void 0),{companyInfo:o,reservation:c,companyId:m,agencyId:h}=n.state||{},[d,p]=l.useState(c??null),[f,x]=l.useState(o??null),[b,P]=l.useState("Agence"),[C,j]=l.useState(!c),[L,M]=l.useState(!1),[_,F]=l.useState(""),[D,k]=l.useState(0),S=Tt(),O=l.useRef(null),I=(f==null?void 0:f.couleurPrimaire)??"#8b3a2f",$=(f==null?void 0:f.couleurSecondaire)??"#f59e0b",R=tt(I);l.useEffect(()=>{if(!u){j(!1),M(!0);return}if((c==null?void 0:c.id)===u){j(!1);return}const B=m??(d==null?void 0:d.companyId),V=h??(d==null?void 0:d.agencyId);(async()=>{var T,W;j(!0),M(!1),F("");const z=B&&V?`companies/${B}/agences/${V}/reservations/${u}`:null;console.log("[ReceiptEnLignePage] load",{id:u,companyId:B,agencyId:V,firestorePath:z});try{if(B&&V){const H=me(G,"companies",B,"agences",V,"reservations",u),le=await Se(H);if(console.log("[ReceiptEnLignePage] getDoc path",H.path,"exists:",le.exists()),le.exists()){const te=le.data();p({id:le.id,companyId:B,agencyId:V,companySlug:te.companySlug??"",nomClient:te.nomClient??te.clientNom??"",telephone:te.telephone??"",depart:te.depart??te.departure??"",arrivee:te.arrivee??te.arrival??"",date:typeof te.date=="string"?te.date:(T=te.date)!=null&&T.seconds?new Date(te.date.seconds*1e3).toISOString().slice(0,10):"",heure:te.heure??"",montant:Number(te.montant??te.montant_total??0),referenceCode:te.referenceCode,statut:te.statut,canal:te.canal??"en_ligne",seatsGo:Number(te.seatsGo??te.nombre_places??te.seats??1),createdAt:te.createdAt,nomAgence:te.nomAgence,agencyNom:te.agencyNom,agenceNom:te.agenceNom,modePaiement:te.modePaiement,preuveVia:te.preuveVia,remboursement:te.remboursement}),j(!1);return}}let q=await ee(ce(Dt(G,"reservations"),ne("referenceCode","==",u),Re(1)));if(q.empty&&(q=await ee(ce(Dt(G,"reservations"),ne("__name__","==",u),Re(1)))),q.empty)M(!0);else{const H=q.docs[0],te=H.ref.path.split("/"),ae=te[1],de=te[3],re=H.data();p({...re,id:H.id,companyId:ae,agencyId:de,companySlug:re.companySlug??"",nomClient:re.nomClient??re.clientNom??"",telephone:re.telephone??"",depart:re.depart??re.departure??"",arrivee:re.arrivee??re.arrival??"",date:typeof re.date=="string"?re.date:(W=re.date)!=null&&W.seconds?new Date(re.date.seconds*1e3).toISOString().slice(0,10):"",heure:re.heure??"",montant:Number(re.montant??re.montant_total??0),seatsGo:Number(re.seatsGo??re.nombre_places??re.seats??1)})}}catch(q){console.error("[ReceiptEnLignePage] load error",q),F(S?"Erreur de chargement du reÃ§u. Veuillez rÃ©essayer.":"Connexion indisponible. Impossible de charger le reÃ§u.")}finally{j(!1)}})()},[u,m,h,c==null?void 0:c.id,S,D]),l.useEffect(()=>{if(!(d!=null&&d.companyId)||f)return;(async()=>{try{const V=await Se(me(G,"companies",d.companyId));if(!V.exists())return;const K=V.data();x({id:V.id,name:K.nom||K.name,couleurPrimaire:K.couleurPrimaire||K.primaryColor,couleurSecondaire:K.couleurSecondaire||K.secondaryColor,logoUrl:K.logoUrl,slug:K.slug,telephone:K.telephone})}catch{F(S?"Erreur lors du chargement des informations de la compagnie.":"Connexion indisponible. Impossible de charger les infos compagnie.")}finally{j(!1)}})()},[d==null?void 0:d.companyId,f,S]),l.useEffect(()=>{const B=(d==null?void 0:d.nomAgence)||(d==null?void 0:d.agencyNom)||(d==null?void 0:d.agenceNom);B&&P(B.toString().trim())},[d]);const w=(d==null?void 0:d.referenceCode)??(d==null?void 0:d.id)??"BIL-INCONNU",N=l.useMemo(()=>`${window.location.origin}/r/${encodeURIComponent(w)}`,[w]),g=l.useMemo(()=>{const B=d==null?void 0:d.createdAt;let V;return B?B instanceof Date?V=B:B!=null&&B.seconds?V=new Date(B.seconds*1e3):V=new Date:V=new Date,yt(V,"dd/MM/yyyy",{locale:Yt})},[d==null?void 0:d.createdAt]),v=d!=null&&d.date?yt(fa(d.date),"dd/MM/yyyy",{locale:Yt}):"",U=l.useMemo(()=>{var V;if(!d)return;if((ln(d)??d.statut)==="rembourse"&&((V=d.remboursement)!=null&&V.mode)){const K=d.remboursement.mode.toLowerCase();return K==="especes"||K==="espÃ¨ces"?"RemboursÃ© (espÃ¨ces)":K.includes("mobile")||K==="mobile_money"?"RemboursÃ© (Mobile Money)":`RemboursÃ© (${d.remboursement.mode})`}return(d.canal??"").toLowerCase()==="guichet"?d.modePaiement?`Paiement ${d.modePaiement}`:void 0:d.preuveVia??void 0},[d]),E=l.useCallback(()=>{if(!O.current)return;const B={margin:2,filename:`recu-${w}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:[81,200],orientation:"portrait"}};ni().set(B).from(O.current).save()},[w]);return C?e("div",{className:"min-h-screen p-6 bg-gray-50",children:e("div",{className:"max-w-md mx-auto",children:e(gn,{})})}):_?t("div",{className:"flex flex-col items-center justify-center min-h-screen p-6",children:[e("h1",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Erreur de chargement"}),e("p",{className:"text-gray-500 text-center mb-4",children:_}),e("button",{type:"button",onClick:()=>k(B=>B+1),className:"px-4 py-2 rounded-lg font-medium text-white",style:{backgroundColor:I},children:"RÃ©essayer"})]}):L||!u?t("div",{className:"flex flex-col items-center justify-center min-h-screen p-6",children:[e("h1",{className:"text-xl font-semibold text-gray-800 mb-2",children:"RÃ©servation introuvable"}),e("p",{className:"text-gray-500 text-center mb-4",children:"Ce reÃ§u nâ€™existe pas ou le lien est incorrect."}),e("button",{type:"button",onClick:()=>r(i?`/${i}`:"/"),className:"px-4 py-2 rounded-lg font-medium text-white",style:{backgroundColor:I},children:"Retour Ã  lâ€™accueil"})]}):!d||!f?e("div",{className:"flex items-center justify-center min-h-screen",children:"Chargement du reÃ§u..."}):t("div",{className:"min-h-screen bg-gray-50",children:[e("header",{className:"sticky top-0 z-20 px-4 py-2 shadow-sm",style:{backgroundColor:I,color:R},children:t("div",{className:"flex items-center justify-between max-w-md mx-auto",children:[e("button",{onClick:()=>r(-1),className:"p-2 rounded-full",children:e(At,{size:22})}),e("h1",{className:"font-bold text-lg",children:"ReÃ§u de rÃ©servation"}),e("div",{className:"w-8"})]})}),e("main",{className:"max-w-md mx-auto px-4 py-6",children:e("div",{ref:O,children:e(Tu,{companyName:f.name,logoUrl:f.logoUrl,primaryColor:I,secondaryColor:$,agencyName:b,receiptNumber:w,statut:ln(d)??d.statut,nomClient:d.nomClient,telephone:d.telephone,depart:d.depart,arrivee:d.arrivee,date:v,heure:d.heure,seats:d.seatsGo,canal:d.canal||"en_ligne",montant:d.montant,qrValue:N,emissionDate:g,paymentMethod:U})})}),t("div",{className:"fixed bottom-0 left-0 right-0 bg-white border-t py-3 px-4 grid grid-cols-3 gap-2",children:[t("button",{onClick:E,className:"py-2 rounded-lg font-medium flex items-center justify-center gap-1",style:{backgroundColor:I,color:R},children:[e(Ca,{size:16}),"TÃ©lÃ©charger"]}),t("button",{onClick:()=>window.print(),className:"py-2 rounded-lg font-medium flex items-center justify-center gap-1",style:{backgroundColor:$,color:tt($)},children:[e(Ns,{size:16}),"Imprimer"]}),t("button",{onClick:()=>r(`/${i}`),className:"py-2 rounded-lg bg-gray-200 text-gray-800 flex items-center justify-center gap-1",children:[e(bs,{size:16}),"Retour"]})]})]})},Du=Object.freeze(Object.defineProperty({__proto__:null,default:Pu},Symbol.toStringTag,{value:"Module"})),Mu=({message:a="Chargement...",colors:n})=>t("div",{className:"flex items-center justify-center min-h-screen text-lg",style:{backgroundColor:n.background,color:n.text},children:[e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 mr-4",style:{borderColor:n.primary}}),a]}),rn="[UploadPreuvePage]",et={info:(...a)=>console.log(rn,...a),warn:(...a)=>console.warn(rn,...a),error:(...a)=>console.error(rn,...a),group:a=>console.group(`${rn} ${a}`),groupEnd:()=>console.groupEnd()},$u=()=>{const a=Be(),n=Xt(),{slug:r,id:s}=De();Qe();const i=Tt(),{draft:u,companyInfo:o}=n.state||{},[c,m]=l.useState(null),[h,d]=l.useState(null),[p,f]=l.useState(!0),[x,b]=l.useState(null),[P,C]=l.useState(""),[j,L]=l.useState(null),[M,_]=l.useState(!1),[F,D]=l.useState(null),[k,S]=l.useState(!1),O=l.useCallback(async()=>{et.group("loadInitialData");try{f(!0);let N=null;if(u&&o)et.info("Init from location.state"),N=o,m(u);else{const g=sessionStorage.getItem("reservationDraft"),v=sessionStorage.getItem("companyInfo");if(et.info("Init from sessionStorage",{hasDraft:!!g,hasCompany:!!v}),g&&v){const U=JSON.parse(g);if(N=JSON.parse(v),!(U!=null&&U.depart)||!(U!=null&&U.arrivee))throw new Error("DonnÃ©es de rÃ©servation incomplÃ¨tes");m(U)}else throw new Error("Aucune donnÃ©e de rÃ©servation valide trouvÃ©e")}if(N!=null&&N.id){const g=await ee(ce(Q(G,"paymentMethods"),ne("companyId","==",N.id))),v={};g.forEach(B=>{const V=B.data();V.name&&(v[V.name]={logoUrl:V.logoUrl||"",url:V.defaultPaymentUrl||"",ussdPattern:V.ussdPattern||"",merchantNumber:V.merchantNumber||""})}),et.info("Payment methods",Object.keys(v));const U=me(G,"companies",N.id),E=await Se(U);if(E.exists()){const B=E.data();d({...N,paymentMethods:v,primaryColor:B.primaryColor||B.couleurPrimaire||"#3b82f6",secondaryColor:B.secondaryColor||B.couleurSecondaire||"#93c5fd",logoUrl:B.logoUrl||""}),et.info("Company info merged",{styles:{primary:B.couleurPrimaire,secondary:B.couleurSecondaire}});return}else throw new Error("Compagnie introuvable dans Firestore")}throw new Error("Impossible de rÃ©cupÃ©rer les infos de la compagnie")}catch(N){et.error("loadInitialData error",N),D(N instanceof Error?N.message:"Erreur inconnue")}finally{f(!1),et.groupEnd()}},[u,o,a,r,s]);l.useEffect(()=>{O()},[O]);const I=N=>{try{if(!N.target.files||!N.target.files[0]){b(null);return}const g=N.target.files[0],v=["image/jpeg","image/png","application/pdf"],U=5*1024*1024;if(!v.includes(g.type))throw new Error("Type de fichier non supportÃ© (JPEG, PNG ou PDF uniquement)");if(g.size>U)throw new Error("Le fichier est trop volumineux (max 5MB)");b(g),D(null),et.info("File selected",{name:g.name,size:g.size,type:g.type})}catch(g){D(g instanceof Error?g.message:"Erreur lors de la sÃ©lection du fichier"),b(null),et.warn("handleFileChange error",g)}},$=N=>{var g,v,U;try{const E=(g=h==null?void 0:h.paymentMethods)==null?void 0:g[N];if(!E)throw new Error("MÃ©thode de paiement non disponible");if(L(N),D(null),et.info("Payment method selected",N),c){const B=(U=(v=E.ussdPattern)==null?void 0:v.replace("MERCHANT",E.merchantNumber||""))==null?void 0:U.replace("AMOUNT",c.montant.toString());E.url?(window.open(E.url,"_blank","noopener,noreferrer"),et.info("Open payment URL",E.url)):B&&(window.open(`tel:${B}`,"_blank","noopener,noreferrer"),et.info("Open USSD",B))}}catch(E){D(E instanceof Error?E.message:"Erreur de sÃ©lection du paiement"),et.warn("handlePaymentMethodSelect error",E)}},R=async()=>{if(!c||!c.id){D("RÃ©servation introuvable.");return}if(!j){D("Veuillez sÃ©lectionner un moyen de paiement.");return}if(!P&&!x){D("Veuillez fournir une preuve ou un message.");return}_(!0),D(null),et.group("handleUpload");try{let N=null;if(x){const v=x.name.split(".").pop(),U=`preuves/preuve_${Date.now()}.${v}`,E=di(vi,U),B=await mi(E,x);N=await ui(B.ref),et.info("File uploaded",{filename:U,preuveUrl:N})}const g={nomClient:c.nomClient,telephone:c.telephone,depart:c.depart,arrivee:c.arrivee,date:c.date,heure:c.heure,montant:c.montant,seatsGo:c.seatsGo,seatsReturn:c.seatsReturn||0,tripType:c.tripType,statut:"preuve_recue",canal:"en_ligne",preuveVia:j,preuveMessage:P.trim(),preuveUrl:N||null,companyId:c.companyId||"",companySlug:c.companySlug||"",auditLog:Jt(hs(c.statut??"en_attente_paiement","preuve_recue",{userId:"client_anonymous",userRole:"client"})),updatedAt:new Date};et.info("Update payload (no ref code write)",g),await He(me(G,"companies",c.companyId,"agences",c.agencyId,"reservations",c.id),g),sessionStorage.removeItem("reservationDraft"),sessionStorage.removeItem("companyInfo"),S(!0),et.info("Upload success â†’ setSuccess(true)")}catch(N){et.error("handleUpload error",N),D("Une erreur est survenue lors de l'envoi.")}finally{_(!1),et.groupEnd()}};if(p){const N={colors:{primary:(h==null?void 0:h.couleurPrimaire)||"#3b82f6",text:h!=null&&h.couleurPrimaire?tt(h.couleurPrimaire):"#ffffff",background:"#f9fafb"}};return e(Mu,{colors:N.colors})}if(!c||!h)return e("div",{className:"min-h-screen flex items-center justify-center p-4 bg-white",children:t("div",{className:"max-w-md w-full rounded-xl border border-gray-200 p-6 text-center",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Impossible de charger les donnÃ©es"}),e("p",{className:"text-sm text-gray-600 mb-4",children:F||"Une erreur est survenue pendant le chargement."}),!i&&e("p",{className:"text-xs text-amber-700 mb-4",children:"Connexion indisponible. VÃ©rifiez le rÃ©seau puis rÃ©essayez."}),t("div",{className:"flex items-center justify-center gap-2",children:[e("button",{type:"button",onClick:O,className:"px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50",children:"RÃ©essayer"}),e("button",{type:"button",onClick:()=>a(`/${r||""}`),className:"px-4 py-2 rounded-lg text-white bg-gray-800 hover:bg-gray-700",children:"Retour"})]})]})});if(k)return e(Lu,{reservationDraft:c,companyInfo:h,slug:r});const w={colors:{primary:h.primaryColor||h.couleurPrimaire||"#3b82f6",secondary:h.secondaryColor||h.couleurSecondaire||"#93c5fd",text:h.primaryColor?tt(h.primaryColor):"#ffffff"}};return t("div",{className:"min-h-screen bg-gray-50",children:[!i&&e("div",{className:"max-w-4xl mx-auto px-4 pt-4",children:e("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800",children:"Connexion instable: lâ€™envoi de la preuve peut Ã©chouer."})}),e(ju,{companyInfo:h,themeConfig:w,onBack:()=>a(-1)}),t("main",{className:"max-w-4xl mx-auto p-4 space-y-6 pb-24",children:[e(Fu,{reservationDraft:c,primaryColor:w.colors.primary}),e("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:t("div",{className:"p-6 space-y-6",children:[e(qu,{amount:c.montant,primaryColor:w.colors.primary}),t("div",{children:[t("h3",{className:"text-sm font-medium text-gray-700 mb-3 flex items-center gap-2",children:[e(yn,{className:"w-5 h-5",style:{color:w.colors.primary}}),e("span",{children:"Moyen de paiement"})]}),e(Ou,{paymentMethod:j,onPaymentMethodSelect:$,companyInfo:h,reservationAmount:c.montant,primaryColor:w.colors.primary,secondaryColor:w.colors.secondary})]}),e(Uu,{message:P,setMessage:C,primaryColor:w.colors.primary}),e(Bu,{handleFileChange:I,file:x,primaryColor:w.colors.primary}),F&&e(Gu,{error:F})]})})]}),e(zu,{onClick:R,disabled:M||!P.trim()||!j,themeConfig:w,uploading:M})]})},Lu=({reservationDraft:a,companyInfo:n,slug:r})=>{const s=Be(),i={colors:{primary:n.primaryColor||n.couleurPrimaire||"#3b82f6",text:n.primaryColor?tt(n.primaryColor):"#ffffff"}};return l.useEffect(()=>{const u=setTimeout(()=>{s(`/${r}/reservation/${a.id}`,{state:{slug:r,companyInfo:n,reservation:{...a,id:a.id,statut:"preuve_recue",preuveMessage:a.preuveMessage||""}}})},1200);return()=>clearTimeout(u)},[s,a,n,r]),e("div",{className:"min-h-screen flex items-center justify-center p-4 bg-white",children:t("div",{className:"text-center max-w-md",children:[e("div",{className:"mx-auto mb-4 flex items-center justify-center",children:e("div",{className:"p-3 rounded-full",style:{backgroundColor:Fe(i.colors.primary,.1)},children:e(rt,{className:"h-10 w-10",style:{color:i.colors.primary}})})}),e("h1",{className:"text-xl font-bold text-gray-900 mb-2",children:"Preuve envoyÃ©e avec succÃ¨s !"}),e("p",{className:"text-gray-600",children:"Vous allez Ãªtre redirigÃ© vers votre rÃ©servation..."})]})})},ju=({companyInfo:a,themeConfig:n,onBack:r})=>e("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm",style:{backgroundColor:n.colors.primary,color:n.colors.text},children:t("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e("button",{onClick:r,className:"p-2 rounded-full hover:bg-white/10 transition",children:e(At,{className:"h-5 w-5"})}),t("div",{className:"flex items-center gap-3",children:[(a==null?void 0:a.logoUrl)&&e(Vn.LazyLoadImage,{src:a.logoUrl,alt:`Logo ${a.name}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:n.colors.text}}),e("h1",{className:"text-lg font-bold",children:"Envoyer la preuve de paiement"})]})]})}),Fu=({reservationDraft:a,primaryColor:n})=>{const r=a.tripType==="aller_retour",s=a.date?yt(fa(a.date),"EEEE d MMMM yyyy",{locale:Yt}):a.date;return t("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e("div",{className:"px-6 py-4 border-b",style:{backgroundColor:Fe(n,.05),borderColor:Fe(n,.2)},children:e("h3",{className:"text-lg font-semibold",style:{color:n},children:"RÃ©capitulatif de votre rÃ©servation"})}),e("div",{className:"p-6 space-y-4 text-sm",children:t("div",{className:"flex items-start gap-4",children:[t("div",{className:"flex-1",children:[t("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:Fe(n,.1)},children:e(Kt,{className:"w-5 h-5",style:{color:n}})}),t("div",{children:[e("p",{className:"text-gray-500",children:"Trajet"}),t("p",{className:"font-semibold text-gray-900",children:[a.depart," ",e(Nn,{className:"inline mx-1 w-4 h-4 text-gray-400"})," ",a.arrivee]})]})]}),t("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:Fe(n,.1)},children:e(dt,{className:"w-5 h-5",style:{color:n}})}),t("div",{children:[e("p",{className:"text-gray-500",children:"Date et heure"}),t("p",{className:"font-semibold text-gray-900",children:[s," Ã  ",a.heure]})]})]})]}),t("div",{className:"flex-1",children:[t("div",{className:"flex items-center gap-3 mb-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:Fe(n,.1)},children:e(xn,{className:"w-5 h-5",style:{color:n}})}),t("div",{children:[e("p",{className:"text-gray-500",children:"Passager"}),e("p",{className:"font-semibold text-gray-900",children:a.nomClient})]})]}),t("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 rounded-lg",style:{backgroundColor:Fe(n,.1)},children:e(Oa,{className:"w-5 h-5",style:{color:n}})}),t("div",{children:[e("p",{className:"text-gray-500",children:"Places"}),t("p",{className:"font-semibold text-gray-900",children:[a.seatsGo," ",r&&`+ ${a.seatsReturn} retour`]})]})]})]})]})})]})},Ou=({paymentMethod:a,onPaymentMethodSelect:n,companyInfo:r,reservationAmount:s,primaryColor:i,secondaryColor:u})=>{var c,m,h,d,p;const o=(r==null?void 0:r.paymentMethods)||{};return Object.keys(o).length===0?e("div",{className:"border-l-4 p-4 rounded-lg",style:{backgroundColor:Fe("#f59e0b",.05),borderColor:"#f59e0b"},children:t("div",{className:"flex items-start gap-3",children:[e(sa,{className:"h-5 w-5 mt-0.5",style:{color:"#f59e0b"}}),e("p",{className:"text-sm",style:{color:"#92400e"},children:"Aucun moyen de paiement configurÃ© pour cette compagnie. Veuillez contacter l'agence."})]})}):t("div",{children:[e("div",{className:"space-y-3",children:Object.entries(o).filter(([f,x])=>x).map(([f,x])=>x?t("button",{onClick:()=>n(f),className:`w-full flex items-center gap-4 p-4 rounded-lg border transition-all ${a===f?"border-blue-500 shadow-sm":"border-gray-200 hover:border-gray-300"}`,style:{backgroundColor:a===f?Fe(u,.2):"white"},children:[x.logoUrl?e("img",{src:x.logoUrl,alt:f,className:"h-10 w-10 object-contain rounded-lg"}):e("div",{className:"h-10 w-10 rounded-lg flex items-center justify-center",style:{backgroundColor:Fe(i,.1),color:i},children:e(yn,{className:"w-5 h-5"})}),t("div",{className:"text-left flex-1",children:[e("div",{className:"font-medium capitalize",children:f.replace(/_/g," ")}),x.merchantNumber&&t("div",{className:"text-xs text-gray-500",children:["NumÃ©ro: ",x.merchantNumber]})]}),a===f&&e("div",{className:"ml-auto",children:e("div",{className:"w-5 h-5 rounded-full flex items-center justify-center",style:{backgroundColor:i,color:tt(i)},children:e(rt,{className:"w-3 h-3"})})})]},f):null)}),a&&((c=o[a])==null?void 0:c.ussdPattern)&&t("div",{className:"mt-4 p-4 rounded-lg",style:{backgroundColor:Fe(i,.05),border:`1px solid ${Fe(i,.2)}`},children:[e("p",{className:"text-sm font-medium mb-2",style:{color:i},children:"Code USSD gÃ©nÃ©rÃ© :"}),e("div",{className:"p-3 rounded-lg font-mono text-center text-sm break-all",style:{backgroundColor:Fe(i,.1)},children:(p=(d=(m=o[a])==null?void 0:m.ussdPattern)==null?void 0:d.replace("MERCHANT",((h=o[a])==null?void 0:h.merchantNumber)||""))==null?void 0:p.replace("AMOUNT",s.toString())}),e("p",{className:"text-xs mt-2 text-gray-500",children:"Ce code sera automatiquement utilisÃ© si l'application n'est pas disponible"})]})]})},qu=({amount:a,primaryColor:n})=>{const r=Qe();return t("div",{children:[e("h3",{className:"text-sm font-medium text-gray-700 mb-2",children:"Montant Ã  payer"}),e("div",{className:"text-3xl font-bold py-3 px-4 rounded-lg",style:{backgroundColor:Fe(n,.1),color:n},children:r(a)})]})},Uu=({message:a,setMessage:n,primaryColor:r})=>t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"DÃ©tails du paiement *"}),e("textarea",{placeholder:"Coller les dÃ©tails du paiement (ex: ID de transaction, rÃ©fÃ©rence, numÃ©ro MTN/Moov...)",value:a,onChange:s=>n(s.target.value),className:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:outline-none",style:{borderColor:Fe(r,.3)},rows:4,required:!0}),e("p",{className:"text-xs text-gray-500 mt-1",children:'Exemple: "Paiement MTN Mobile Money - RÃ©f: 5X8T9K - 05/07/2024"'})]}),Bu=({handleFileChange:a,file:n,primaryColor:r})=>t("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Capture d'Ã©cran (optionnel)"}),e("div",{className:"flex items-center justify-center w-full",children:t("label",{className:"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer transition-all hover:border-gray-400",style:{borderColor:n?r:Fe(r,.3),backgroundColor:n?Fe(r,.05):"white"},children:[e("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:n?t(Ae,{children:[e(rt,{className:"h-8 w-8 mb-2",style:{color:r}}),e("p",{className:"text-sm font-medium",style:{color:r},children:n.name}),e("p",{className:"text-xs text-gray-500 mt-1",children:"Cliquez pour changer de fichier"})]}):t(Ae,{children:[e(Zn,{className:"h-8 w-8 text-gray-400 mb-2"}),e("p",{className:"text-sm text-gray-500",children:"Cliquez pour sÃ©lectionner un fichier"}),e("p",{className:"text-xs text-gray-400 mt-1",children:"PNG, JPG, PDF (max. 5MB)"})]})}),e("input",{type:"file",className:"hidden",onChange:a,accept:".png,.jpg,.jpeg,.pdf"})]})})]}),Gu=({error:a})=>e("div",{className:"border-l-4 p-4 rounded-lg",style:{backgroundColor:Fe("#ef4444",.05),borderColor:"#ef4444"},children:t("div",{className:"flex items-start gap-3",children:[e(Ot,{className:"h-5 w-5 mt-0.5",style:{color:"#ef4444"}}),e("p",{className:"text-sm",style:{color:"#991b1b"},children:a})]})}),zu=({onClick:a,disabled:n,themeConfig:r,uploading:s})=>e("div",{className:"fixed bottom-0 left-0 w-full z-50 border-t border-gray-200 bg-white px-4 py-3 shadow-lg",children:e("div",{className:"max-w-4xl mx-auto",children:e("button",{onClick:a,disabled:n,className:"w-full py-3 px-4 rounded-lg font-medium transition-all hover:opacity-90",style:{backgroundColor:n?"#9ca3af":r.colors.primary,color:r.colors.text},children:s?t("span",{className:"flex items-center justify-center gap-2",children:[e(Ft,{className:"h-5 w-5 animate-spin"}),"Envoi en cours..."]}):t("span",{className:"flex items-center justify-center gap-2",children:[e(rt,{className:"h-5 w-5"}),"Confirmer l'envoi"]})})})}),Vu=Object.freeze(Object.defineProperty({__proto__:null,default:$u},Symbol.toStringTag,{value:"Module"}));function Hu({company:a}){const{slug:n}=De(),r=Be(),{t:s}=mt(),i=(a==null?void 0:a.couleurPrimaire)??"#ea580c";return t("div",{className:"min-h-screen bg-gray-50 pb-24 md:pb-0",children:[e("header",{className:"sticky top-0 z-10 border-b bg-white",style:{borderColor:"#e5e7eb"},children:t("div",{className:"max-w-3xl mx-auto px-3 py-3 flex items-center gap-2",children:[e("button",{onClick:()=>r(n?`/${n}`:"/"),className:"p-2 rounded-lg hover:bg-gray-100","aria-label":s("backToHome"),children:e(At,{className:"w-5 h-5 text-gray-700"})}),e("h1",{className:"font-semibold text-gray-900",children:s("helpTitle")})]})}),t("main",{className:"max-w-3xl mx-auto p-4 space-y-6",children:[t("div",{className:"flex items-center gap-3 p-4 rounded-xl bg-white border border-gray-200",children:[e("div",{className:"p-2 rounded-full",style:{backgroundColor:`${i}20`},children:e(xs,{className:"w-6 h-6",style:{color:i}})}),t("div",{children:[e("h2",{className:"font-semibold text-gray-900",children:s("helpSubtitle",{companyName:(a==null?void 0:a.nom)??s("ourCompany")})}),e("p",{className:"text-sm text-gray-600 mt-0.5",children:s("helpComingSoon")})]})]}),t("section",{className:"rounded-xl bg-white border border-gray-200 overflow-hidden",children:[e("h3",{className:"px-4 py-3 text-sm font-medium text-gray-500 border-b border-gray-100",children:s("contact")}),t("div",{className:"divide-y divide-gray-100",children:[(a==null?void 0:a.telephone)&&t("a",{href:`tel:${a.telephone}`,className:"flex items-center gap-3 px-4 py-3 text-gray-900 hover:bg-gray-50",children:[e(Wt,{className:"w-5 h-5 text-gray-400"}),e("span",{children:a.telephone})]}),(a==null?void 0:a.email)&&t("a",{href:`mailto:${a.email}`,className:"flex items-center gap-3 px-4 py-3 text-gray-900 hover:bg-gray-50",children:[e(Ms,{className:"w-5 h-5 text-gray-400"}),e("span",{children:a.email})]}),!(a!=null&&a.telephone)&&!(a!=null&&a.email)&&t("div",{className:"px-4 py-3 flex items-center gap-3 text-gray-500",children:[e($s,{className:"w-5 h-5"}),e("span",{className:"text-sm",children:s("contactToConfigure")})]})]})]})]})]})}const Yu=Object.freeze(Object.defineProperty({__proto__:null,default:Hu},Symbol.toStringTag,{value:"Module"}));export{Ap as $,It as A,np as B,Mt as C,rp as D,oc as E,pc as F,xc as G,ip as H,$o as I,op as J,cp as K,dp as L,xo as M,bp as N,we as O,js as P,vp as Q,ep as R,sp as S,xe as T,Pm as U,Gn as V,Np as W,wp as X,Cp as Y,Sp as Z,vt as _,fm as a,Ep as a0,kp as a1,Ip as a2,Rp as a3,_p as a4,Tp as a5,Pp as a6,Dp as a7,Mp as a8,$p as a9,dd as b,sl as c,gp as d,mp as e,fp as f,hp as g,la as h,Jc as i,jm as j,xp as k,Zc as l,Xc as m,pp as n,up as o,yp as p,Lt as q,il as r,$t as s,jt as t,lp as u,ut as v,No as w,tp as x,ap as y,To as z};
