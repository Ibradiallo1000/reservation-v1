import{b as te,u as ae,r as l,j as r,a as s,C as se,h as oe,i as le,q as A,T as ie,k as ne}from"./react-DgrrIcw2.js";import{l as $,k as D,q as ce,w as de}from"./firebase-eGIzIftJ.js";import{d as T}from"../index-p6Te0bSg.js";import"./vendor-BHjJ2Hjk.js";const me=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],y=(t,v=1)=>{const u=parseInt(t.slice(1,3),16),x=parseInt(t.slice(3,5),16),c=parseInt(t.slice(5,7),16);return`rgba(${u}, ${x}, ${c}, ${v})`},z=t=>{if(t.length<7)return"#000000";const v=parseInt(t.slice(1,3),16),u=parseInt(t.slice(3,5),16),x=parseInt(t.slice(5,7),16);return(.299*v+.587*u+.114*x)/255>.5?"#000000":"#ffffff"},xe=({company:t})=>{var F;const v=te(),u=ae(),x=new URLSearchParams(v.search),c=x.get("departure")||"",N=x.get("arrival")||"",[j,q]=l.useState([]),[g,I]=l.useState(""),[i,L]=l.useState(""),[M,P]=l.useState(!0),[E,_]=l.useState(null),G=l.useMemo(()=>{const e=t.couleurPrimaire||"#3b82f6",o=t.couleurSecondaire||"#93c5fd";return{colors:{primary:e,secondary:o,text:z(e),textOnPrimary:z(e),background:"#ffffff"},classes:{card:"bg-white rounded-xl shadow-sm border border-gray-200",button:"transition-all hover:scale-105 active:scale-95",animations:"transition-all duration-300 ease-in-out",header:"sticky top-0 z-50 px-4 py-3"}}},[t]),{colors:a,classes:h}=G,C=l.useMemo(()=>{const e=new Date;return Array.from({length:8},(o,p)=>{const f=new Date(e);return f.setDate(f.getDate()+p),f.toISOString().split("T")[0]})},[]),d=l.useMemo(()=>j.filter(e=>e.date===g),[j,g]);l.useEffect(()=>{(async()=>{var o;if(!(!t.id||!c||!N)){P(!0);try{const f=(await $(D(T,"companies",t.id,"agences"))).docs.map(b=>({id:b.id})),S=[];for(const b of f){const K=(await $(ce(D(T,"companies",t.id,"agences",b.id,"weeklyTrips"),de("active","==",!0)))).docs.map(m=>({id:m.id,...m.data()})),Q=(await $(D(T,"companies",t.id,"agences",b.id,"reservations"))).docs.map(m=>m.data());for(const m of C){const W=new Date(m),X=me[W.getDay()];for(const n of K){if(n.departure.toLowerCase()!==c.toLowerCase()||n.arrival.toLowerCase()!==N.toLowerCase())continue;const Z=((o=n.horaires)==null?void 0:o[X])||[];for(const O of Z){const R=`${n.id}_${m}_${O}`,ee=Q.filter(w=>w.trajetId===R&&w.statut==="payé"),U=(n.places||30)-ee.reduce((w,re)=>w+re.seatsGo,0);U>0&&S.push({id:R,date:m,time:O,departure:n.departure,arrival:n.arrival,price:n.price,places:n.places||30,remainingSeats:U,agencyId:b.id})}}}}q(S);const J=[...new Set(S.map(b=>b.date))];I(J[0]||"")}catch(p){console.error("Erreur Firestore:",p),_("Erreur lors du chargement des trajets")}finally{P(!1)}}})()},[t.id,C,c,N]),l.useEffect(()=>{var e;if(d.length>0){const o=[...d].sort((p,f)=>p.time.localeCompare(f.time));L(((e=o[0])==null?void 0:e.time)||"")}},[g,d]);const B=e=>{I(e)},V=e=>{L(e)},Y=()=>{const e=d.find(o=>o.time===i);e&&u(`/${t.slug}/booking`,{state:{tripData:{...e,companyId:t.id,agencyId:e.agencyId,compagnieNom:t.nom,logoUrl:t.logoUrl},companyInfo:{id:t.id,slug:t.slug,nom:t.nom,logoUrl:t.logoUrl,primaryColor:a.primary}}})},H=e=>new Date(e).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"}),k=(e,o)=>new Date(`${e}T${o}`).getTime()<new Date().getTime();return M?r("div",{className:"flex items-center justify-center min-h-screen",style:{background:a.background},children:r("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2",style:{borderColor:a.primary}})}):E?r("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",style:{background:a.background},children:s("div",{className:`p-4 rounded-lg max-w-md ${h.card}`,children:[r("h2",{className:"text-xl font-bold mb-2 text-gray-900",children:"Erreur"}),r("p",{className:"text-gray-700",children:E}),r("button",{onClick:()=>u(`/${t.slug}`),className:`mt-4 px-4 py-2 rounded ${h.button}`,style:{backgroundColor:a.primary,color:a.textOnPrimary},children:"Retour à la compagnie"})]})}):s("div",{className:"min-h-screen",style:{background:a.background,color:a.text},children:[r("header",{className:h.header,style:{backgroundColor:y(a.primary,.95),color:a.textOnPrimary,backdropFilter:"blur(10px)"},children:s("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[r("button",{onClick:()=>u(`/${t.slug}`),className:"p-2 rounded-full hover:bg-white/10 transition",style:{color:a.textOnPrimary},children:r(se,{className:"h-5 w-5"})}),s("div",{className:"flex items-center gap-2",children:[t.logoUrl&&r(oe.LazyLoadImage,{src:t.logoUrl,alt:`Logo ${t.nom}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:a.textOnPrimary,backgroundColor:y(a.primary,.2)}}),s("div",{children:[r("h1",{className:"text-lg font-bold",children:"Résultats de recherche"}),s("p",{className:"text-xs opacity-80",children:[c," → ",N]})]})]})]})}),s("main",{className:"max-w-4xl mx-auto p-4 sm:p-6 pb-24",children:[s("div",{className:`p-4 rounded-xl mb-6 ${h.card}`,children:[r("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2",children:s("span",{children:[c," → ",N]})}),s("div",{className:"mb-4",children:[s("h3",{className:"text-lg font-semibold mb-3 flex items-center gap-2 text-gray-800",children:[r(le,{className:"h-5 w-5",style:{color:a.primary}}),"Choisissez votre date de départ"]}),r("div",{className:"flex gap-2 overflow-x-auto pb-4 scrollbar-hide",children:C.map(e=>s("button",{onClick:()=>B(e),className:`flex flex-col items-center min-w-[90px] p-3 rounded-xl border transition-all flex-shrink-0 ${g===e?"shadow-md":"bg-white hover:bg-gray-50 border-gray-200 text-gray-800"}`,style:{backgroundColor:g===e?a.primary:void 0,borderColor:g===e?a.primary:void 0,color:g===e?a.textOnPrimary:void 0},children:[r("span",{className:"text-xs font-medium",children:H(e)}),r("span",{className:"text-sm mt-1",children:new Date(e).toLocaleDateString("fr-FR",{day:"numeric"})})]},e))})]}),d.length===0?s("div",{className:`p-6 rounded-xl text-center ${h.card} text-gray-800`,children:[r("div",{className:"bg-gray-100 p-4 rounded-full inline-flex mb-3",children:r(A,{className:"h-6 w-6 text-gray-500"})}),r("h3",{className:"text-lg font-medium mb-1",children:"Aucun trajet disponible pour cette date"}),r("p",{className:"text-sm opacity-80",children:"Veuillez choisir une autre date"})]}):r("div",{className:"space-y-4",children:s("div",{className:`rounded-xl overflow-hidden ${h.card}`,children:[s("div",{className:"p-4 border-b",style:{borderColor:y(a.primary,.1)},children:[s("h3",{className:"font-semibold flex items-center gap-2 mb-3 text-gray-800",children:[r(A,{className:"h-5 w-5",style:{color:a.primary}}),"Choisissez votre heure de départ"]}),r("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2",children:d.sort((e,o)=>e.time.localeCompare(o.time)).map(e=>s("button",{onClick:()=>V(e.time),disabled:k(e.date,e.time),className:`p-3 rounded-lg border flex flex-col items-center transition ${i===e.time?"bg-blue-50 text-blue-600":k(e.date,e.time)?"bg-gray-50 text-gray-400":"border-gray-200 hover:border-blue-300 hover:bg-blue-50 text-gray-800"}`,style:{borderColor:i===e.time?a.primary:void 0,backgroundColor:i===e.time?y(a.primary,.1):void 0},children:[r("span",{className:"font-medium",children:e.time}),s("span",{className:"text-xs mt-1",children:[e.remainingSeats," places"]})]},e.id))})]}),d.filter(e=>e.time===i&&!k(e.date,e.time)).map(e=>r("div",{className:"p-4",children:s("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 text-gray-800",children:[s("div",{className:"flex items-center gap-3",children:[r("div",{className:"p-2 rounded-full",style:{backgroundColor:y(a.primary,.1),color:a.primary},children:r(ie,{className:"h-5 w-5"})}),s("div",{children:[r("h3",{className:"text-sm font-medium opacity-80",children:"Prix"}),s("p",{className:"text-lg font-bold text-gray-900",children:[e.price.toLocaleString()," FCFA"]})]})]}),s("div",{className:"flex items-center gap-3",children:[r("div",{className:"p-2 rounded-full",style:{backgroundColor:y(a.primary,.1),color:a.primary},children:r(ne,{className:"h-5 w-5"})}),s("div",{children:[r("h3",{className:"text-sm font-medium opacity-90",children:"Places disponibles"}),r("p",{className:`text-lg font-bold ${e.remainingSeats===0?"text-red-600":e.remainingSeats<=10?"text-yellow-600":"text-green-600"}`,children:e.remainingSeats})]})]})]})},e.id))]})})]}),i&&r("div",{className:"fixed bottom-0 left-0 right-0 bg-white shadow-lg p-4 border-t border-gray-200",children:s("div",{className:"max-w-xl mx-auto flex justify-between items-center",children:[s("div",{children:[r("p",{className:"text-sm text-gray-600",children:"Total"}),s("p",{className:"text-xl font-bold text-gray-900",children:[((F=d.find(e=>e.time===i))==null?void 0:F.price.toLocaleString())||"0"," FCFA"]})]}),r("button",{onClick:Y,disabled:!i,className:`px-6 py-3 rounded-lg font-bold ${h.button} ${i?"":"opacity-50 cursor-not-allowed"}`,style:{backgroundColor:a.primary,color:a.textOnPrimary},children:"Réserver maintenant"})]})})]})]})};export{xe as default};
