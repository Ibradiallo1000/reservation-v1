import{a as s,j as t,T as ee,a6 as te,a0 as ae,M as se,n as H,a9 as ne,aO as re,L as O,X as ce,s as le,a4 as ie,r as h,k as oe,J as de,aP as me,aQ as ue}from"./react-DB_4kGOy.js";import{z as pe,x as X,w as fe,J as ge,B as he,y as G,A as xe,T as V,G as ye,o as S,C as J,q as K,H as be}from"./firebase-lLzYRzUk.js";import{u as we,c as Ne,d as x,m as W}from"../index-Bkmir__O.js";import{c as ve}from"./utils-CmftarAw.js";import"./vendor-C-DAJou6.js";function Ae(e){const n=typeof e=="number"?e:0;return new Intl.NumberFormat("fr-FR",{style:"currency",currency:"XOF",maximumFractionDigits:0}).format(n)}function Q(e){try{if(e!=null&&e.toDate)return new Date(e.toDate()).toLocaleString("fr-FR");if(e instanceof Date)return e.toLocaleString("fr-FR");if(typeof e=="number")return new Date(e).toLocaleString("fr-FR");if(typeof e=="string")return new Date(e).toLocaleString("fr-FR")}catch{}return"—"}function Ce(e){const n=(e||"").toLowerCase();return n==="payé"||n==="paye"||n==="payé"?{label:"Payé",cls:"bg-emerald-100 text-emerald-700 border-emerald-300"}:n==="preuve_recue"||n==="preuve reçue"?{label:"Preuve reçue",cls:"bg-amber-100 text-amber-700 border-amber-300"}:n==="refusé"||n==="refuse"?{label:"Refusé",cls:"bg-rose-100 text-rose-700 border-rose-300"}:n==="annulé"||n==="annule"?{label:"Annulé",cls:"bg-gray-200 text-gray-700 border-gray-300"}:{label:e||"—",cls:"bg-slate-100 text-slate-700 border-slate-300"}}const Re=e=>!!e&&/\.(png|jpe?g|webp|gif)$/i.test(e||""),Se=({reservation:e,onValider:n,onRefuser:m,onSupprimer:o,isLoading:l})=>{var a,r,c;const w=e.referenceCode||e.ref||`#${e.id.slice(0,6).toUpperCase()}`,D=[e.nomClient,e.clientNom].filter(Boolean).join(" ").trim()||[e.prenomClient,e.clientPrenom,e.clientNom].filter(Boolean).join(" ").trim()||"Client",P=e.telephone||e.clientTel||"",y=e.email||"",E=e.depart||e.departVille||e.departNom||"—",R=e.arrivee||e.arriveeVille||e.arriveeNom||"—",b=e.statut||"",k=Ce(b),N=e.montant??e.total??e.price??0,v=Q(e.createdAt),I=Q(e.dateVoyage),u=((a=e.preuve)==null?void 0:a.url)??e.preuveUrl??null,A=((r=e.preuve)==null?void 0:r.message)??e.preuveMessage??"",d=((c=e.preuve)==null?void 0:c.via)??e.preuveVia??e.paymentHint??"";return s("div",{className:"bg-white border rounded-xl shadow-sm hover:shadow-md transition-shadow",children:[t("div",{className:"h-1.5 rounded-t-xl bg-gradient-to-r from-blue-600 to-indigo-600"}),s("div",{className:"p-4 space-y-3",children:[s("div",{className:"flex items-start justify-between gap-3",children:[s("div",{className:"flex items-center gap-2 min-w-0",children:[t(ee,{className:"w-4 h-4 text-slate-500 shrink-0"}),t("span",{className:"font-semibold text-slate-900 truncate",children:w})]}),t("span",{className:ve("px-2 py-0.5 text-xs rounded-full border",k.cls),children:k.label})]}),s("div",{className:"space-y-1",children:[t("div",{className:"text-sm font-medium text-slate-900 truncate",children:D}),s("div",{className:"flex items-center gap-4 text-xs text-slate-600",children:[P&&s("span",{className:"inline-flex items-center gap-1",children:[t(te,{className:"w-3.5 h-3.5"}),P]}),y&&s("span",{className:"inline-flex items-center gap-1",children:[t(ae,{className:"w-3.5 h-3.5"}),y]})]})]}),s("div",{className:"flex items-center gap-2 text-sm text-slate-700",children:[t(se,{className:"w-4 h-4 text-slate-500"}),s("span",{className:"truncate",children:[E," → ",R]})]}),s("div",{className:"grid grid-cols-2 gap-2 text-xs text-slate-600",children:[s("div",{className:"inline-flex items-center gap-1 min-w-0",children:[t(H,{className:"w-3.5 h-3.5 shrink-0"}),s("span",{className:"truncate",children:["Créée: ",v]})]}),s("div",{className:"inline-flex items-center gap-1 min-w-0",children:[t(H,{className:"w-3.5 h-3.5 shrink-0"}),s("span",{className:"truncate",children:["Voyage: ",I]})]})]}),s("div",{className:"text-right",children:[t("div",{className:"text-xs text-slate-500",children:"Montant"}),t("div",{className:"text-lg font-semibold text-slate-900",children:Ae(N)})]}),(u||A)&&s("div",{className:"mt-2 rounded-lg border border-amber-200 bg-amber-50/50 p-3",children:[s("div",{className:"text-xs font-semibold text-amber-700 mb-1",children:["Preuve de paiement",d?` · ${String(d).replace(/_/g," ")}`:""]}),A&&t("p",{className:"text-xs text-gray-800 mb-2 break-words",children:A}),u&&t("div",{className:"flex items-center gap-3",children:Re(u)?t("a",{href:u,target:"_blank",rel:"noopener noreferrer",className:"block",title:"Ouvrir la preuve",children:t("img",{src:u,alt:"Preuve de paiement",className:"h-20 w-20 object-cover rounded border"})}):s("a",{href:u,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 text-xs px-2 py-1.5 rounded border border-gray-300 hover:bg-gray-50",children:[t(ne,{className:"w-4 h-4"}),"Voir la preuve (document)",t(re,{className:"w-3.5 h-3.5"})]})})]}),s("div",{className:"flex items-center justify-end gap-2 pt-1",children:[m&&s("button",{onClick:m,disabled:l,className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-md border hover:bg-rose-50 text-rose-700 border-rose-200 disabled:opacity-60",title:"Refuser",children:[l?t(O,{className:"w-4 h-4 animate-spin"}):t(ce,{className:"w-4 h-4"}),"Refuser"]}),o&&s("button",{onClick:o,disabled:l,className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-md border hover:bg-slate-50 text-slate-700 border-slate-200 disabled:opacity-60",title:"Supprimer",children:[t(le,{className:"w-4 h-4"}),"Supprimer"]}),n&&s("button",{onClick:n,disabled:l,className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-md text-white bg-emerald-600 hover:bg-emerald-700 disabled:opacity-60",title:"Valider",children:[l?t(O,{className:"w-4 h-4 animate-spin"}):t(ie,{className:"w-4 h-4"}),"Valider"]})]})]})]})},$=(e="")=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),De=(e="",n="CMP")=>{const m=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9\s]/g," ").trim();if(!m)return n;const o=m.split(/\s+/).filter(Boolean);return o.length===1?o[0].slice(0,3).toUpperCase():o.slice(0,3).map(l=>l[0]).join("").toUpperCase()},Pe=(e="",n="A")=>(e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"").trim()[0]||n).toUpperCase();async function Ee(e,n,m){var N,v,I,u,A;const o=await K(S(x,"companies",e)),l=((N=o.data())==null?void 0:N.name)||((v=o.data())==null?void 0:v.nom)||"",w=await K(S(x,"companies",e,"agences",n)),D=((I=w.data())==null?void 0:I.nomAgence)||((u=w.data())==null?void 0:u.nom)||((A=w.data())==null?void 0:A.name)||"",P=De(l,"CMP"),y=Pe(D,"A"),R=S(x,"companies",e,"agences",n,"sequences","WEB"),b=S(x,"companies",e,"agences",n,"reservations",m);return await be(x,async d=>{var j,_;const a=await d.get(b);if(!a.exists())throw new Error("Reservation not found");const r=(j=a.data())==null?void 0:j.referenceCode;if(r)return r;const c=await d.get(R);let i=0;c.exists()?i=((_=c.data())==null?void 0:_.last)||0:d.set(R,{last:0,updatedAt:new Date});const f=i+1;d.set(R,{last:f,updatedAt:new Date},{merge:!0});const C=String(f).padStart(4,"0"),T=`${P}-${y}-WEB-${C}`;return d.update(b,{referenceCode:T}),T})}const Z=8,Te=()=>{const{user:e}=we(),{setHeader:n,resetHeader:m}=Ne(),[o,l]=h.useState([]),[w,D]=h.useState(!1),[P,y]=h.useState(null),[E,R]=h.useState(""),[b,k]=h.useState("preuve_recue"),N=h.useRef(null),v=h.useRef(0);h.useEffect(()=>(n({title:"Réservations en ligne",subtitle:"Preuves de paiement"}),()=>m()),[n,m]),h.useEffect(()=>{if(!(e!=null&&e.companyId))return;D(!0);let a=[],r=!1;return(async()=>{const i=(await pe(X(x,"companies",e.companyId,"agences"))).docs.map(C=>C.id),f=new Map;i.forEach(C=>{const T=fe(X(x,"companies",e.companyId,"agences",C,"reservations"),b?G("statut","==",b):G("statut","in",["preuve_recue","payé","annulé","refusé"]),he("createdAt","desc"),ge(Z)),j=xe(T,_=>{let L=v.current;_.docChanges().forEach(g=>{const p=g.doc.data(),F={id:g.doc.id,...p,agencyId:p.agencyId||p.agenceId||C},B=`${F.agencyId}_${F.id}`;if(g.type==="removed")f.delete(B);else{f.set(B,F);const M=p.createdAt instanceof V?p.createdAt.toMillis():0;M&&M>L&&(L=M)}}),L>0&&L>v.current&&(Date.now()-L<1e4&&N.current&&N.current.play().catch(()=>{}),v.current=L);const Y=Array.from(f.values()).sort((g,p)=>{var M,U,q,z;const F=g.createdAt instanceof V?g.createdAt.toMillis():g.createdAt?((U=(M=g.createdAt).toMillis)==null?void 0:U.call(M))??new Date(g.createdAt).getTime():0;return(p.createdAt instanceof V?p.createdAt.toMillis():p.createdAt?((z=(q=p.createdAt).toMillis)==null?void 0:z.call(q))??new Date(p.createdAt).getTime():0)-F}).slice(0,Z);l(Y),r||(r=!0,D(!1))});a.push(j)})})(),()=>{a.forEach(c=>c())}},[e==null?void 0:e.companyId,b]);const I=async(a,r)=>{if(!r||!(e!=null&&e.companyId))return alert("Aucune agence associée à cette réservation");try{y(a),await Ee(e.companyId,r,a),await J(S(x,"companies",e.companyId,"agences",r,"reservations",a),{statut:"payé",validatedAt:new Date,validatedBy:e.uid}),l(c=>c.filter(i=>i.id!==a))}catch(c){console.error(c),alert("Une erreur est survenue lors de la validation ❌")}finally{y(null)}},u=async(a,r)=>{if(!r||!(e!=null&&e.companyId))return alert("Aucune agence associée à cette réservation");const c=window.prompt("Raison du refus ?")||"Non spécifié";try{y(a),await J(S(x,"companies",e.companyId,"agences",r,"reservations",a),{statut:"refusé",refusalReason:c,refusedAt:new Date,refusedBy:e.uid}),l(i=>i.filter(f=>f.id!==a))}catch(i){console.error(i),alert("Erreur lors du refus ❌")}finally{y(null)}},A=async(a,r)=>{if(!r||!(e!=null&&e.companyId))return alert("Aucune agence associée à cette réservation");if(window.confirm("Supprimer cette réservation ?"))try{await ye(S(x,"companies",e.companyId,"agences",r,"reservations",a)),l(c=>c.filter(i=>i.id!==a))}catch{alert("Erreur lors de la suppression ❌")}},d=h.useMemo(()=>{const a=$(E);return a?o.filter(r=>{const c=$(r.nomClient||""),i=(r.telephone||"").toLowerCase(),f=$(r.referenceCode||""),C=$(r.email||"");return c.includes(a)||i.includes(a)||f.includes(a)||C.includes(a)}):o},[o,E]);return s("div",{className:"p-4 md:p-6 max-w-7xl mx-auto",children:[s("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6",children:[s("div",{className:"flex items-center gap-3",children:[(e==null?void 0:e.companyLogo)&&t(oe.LazyLoadImage,{src:e.companyLogo,alt:"Logo",effect:"blur",className:"h-10 w-10 rounded border object-cover"}),s("div",{children:[t("h1",{className:"text-2xl font-bold text-gray-900",children:"Réservations en ligne"}),t("p",{className:"text-sm text-gray-500",children:"Preuves de paiement"})]})]}),s("div",{className:"flex flex-col sm:flex-row gap-3 w-full md:w-auto",children:[s("div",{className:"relative flex-1",children:[t("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:t(de,{className:"w-4 h-4 text-gray-400"})}),t("input",{type:"text",placeholder:"Rechercher par nom, téléphone, référence…",className:"pl-10 pr-4 py-2 border border-gray-300 rounded-lg w-full",value:E,onChange:a=>R(a.target.value)})]}),s("select",{value:b,onChange:a=>k(a.target.value),className:"border border-gray-300 rounded-lg px-3 py-2 min-w-[180px]",children:[t("option",{value:"",children:"Tous les statuts"}),t("option",{value:"preuve_recue",children:"Preuve reçue"}),t("option",{value:"payé",children:"Payé"}),t("option",{value:"annulé",children:"Annulé"}),t("option",{value:"refusé",children:"Refusé"})]})]})]}),w&&d.length===0&&t("div",{className:"flex justify-center py-8",children:t(W.div,{animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"},children:t(me,{className:"h-8 w-8 text-blue-600"})})}),!w&&d.length===0&&s(W.div,{initial:{opacity:0},animate:{opacity:1},className:"bg-white rounded-xl border p-8 text-center",children:[t(ue,{className:"mx-auto h-12 w-12 text-gray-400"}),t("h3",{className:"mt-4 text-lg font-medium text-gray-900",children:"Aucune réservation trouvée"})]}),t("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:d.map(a=>t(Se,{reservation:a,onValider:()=>I(a.id,a.agencyId),onRefuser:()=>u(a.id,a.agencyId),onSupprimer:()=>A(a.id,a.agencyId),isLoading:P===a.id},`${a.agencyId||"ag"}_${a.id}`))}),t("audio",{ref:N,src:"/sounds/new.mp3",preload:"auto"})]})};export{Te as default};
