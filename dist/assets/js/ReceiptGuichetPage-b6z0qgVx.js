import{j as e,aQ as H,b as G,u as I,a as O,r as o,d as Q,M as B,P as J,f as V,aR as Y,aw as _,aS as K,aT as W}from"./react-BKlva80Y.js";import{d as A,e as $}from"./firebase-1zyXmG6H.js";import{d as M,s as U,h as w}from"../index-B9wHCq4m.js";import{h as X}from"./html2pdf-BJ88HccC.js";import{p as Z,J as ee,a5 as te}from"./vendor-CZDa83Cj.js";import"./jspdf.es.min-DYVIpWt1.js";import"./html2canvas-Ce3uWMAu.js";const se=({fullScreen:d=!1,className:c=""})=>e.jsx("div",{className:`flex items-center justify-center ${d?"min-h-screen":""} ${c}`,children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}),re=({message:d,onRetry:c,onHome:m})=>e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:e.jsx("div",{className:"p-6 rounded-lg max-w-md bg-white shadow-sm border border-red-200",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(H,{className:"h-12 w-12 text-red-500 mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2 text-red-600",children:"Erreur"}),e.jsx("p",{className:"mb-6 text-gray-700",children:d}),e.jsxs("div",{className:"flex gap-3",children:[c&&e.jsx("button",{onClick:c,className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition",children:"Réessayer"}),m&&e.jsx("button",{onClick:m,className:"px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300 transition",children:"Accueil"})]})]})})}),me=()=>{var P;const{id:d,slug:c}=G(),m=I(),T=O(),{companyInfo:g,reservation:j,from:f}=T.state||{},[t,C]=o.useState(null),[a,R]=o.useState(null),[q,h]=o.useState(!0),[k,x]=o.useState(null),y=o.useRef(null),D=o.useCallback((s,i)=>{try{let r;return typeof s=="string"?r=Z(s):s instanceof Date?r=s:r=new Date(s.seconds*1e3),ee(r,i,{locale:te})}catch{return"Date invalide"}},[]),b=o.useCallback(()=>{if(!t)return"AGC-000000";const i=(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt.seconds*1e3)).getFullYear(),r=t.id.slice(0,6).toUpperCase();return`AGC-${i}-${r}`},[t]),E=o.useCallback(async()=>{if(!d)return x("ID de réservation manquant"),h(!1),null;try{const s=A(M,"reservations",d),i=await $(s);if(!i.exists())throw new Error("Réservation introuvable");const r=i.data();if(c&&r.companySlug!==c)throw new Error("URL invalide pour cette réservation");return{...r,id:i.id,createdAt:r.createdAt instanceof Date?r.createdAt:new Date(r.createdAt.seconds*1e3)}}catch(s){return x(s instanceof Error?s.message:"Erreur inconnue"),null}},[d,c]),S=o.useCallback(async s=>{var i,r;try{const u=A(M,"companies",s),v=await $(u);if(!v.exists())throw new Error("Compagnie non trouvée");const l=v.data();return{id:v.id,nom:l.nom,logoUrl:l.logoUrl,couleurPrimaire:((i=l.theme)==null?void 0:i.primary)||l.couleurPrimaire||"#3b82f6",couleurSecondaire:((r=l.theme)==null?void 0:r.secondary)||l.couleurSecondaire||"#93c5fd",slug:l.slug,telephone:l.telephone,banniereUrl:l.banniereUrl}}catch(u){return x(u instanceof Error?u.message:"Erreur lors du chargement de la compagnie"),null}},[]);o.useEffect(()=>{(async()=>{h(!0),x(null);try{if(j&&g){C(j),R(g),h(!1);return}const i=await E();if(!i)return;const r=await S(i.compagnieId);if(!r)return;C(i),R(r)}catch(i){x(i instanceof Error?i.message:"Erreur inconnue")}finally{h(!1)}})()},[d,c,g,j,E,S]);const F=o.useCallback(()=>{if(y.current){const s={margin:2,filename:`recu-${b()}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,letterRendering:!0,width:340},jsPDF:{unit:"mm",format:[58,200],orientation:"portrait"}};X().set(s).from(y.current).save()}},[b]),z=o.useCallback(()=>{m(f||-1)},[f,m]);if(q||!a)return e.jsx(se,{fullScreen:!0});if(k||!t||!a)return e.jsx(re,{message:k||"Erreur de chargement",onRetry:()=>window.location.reload(),onHome:()=>m("/")});const L=`${window.location.origin}/compagnie/${a.slug}/receipt/${t.id}`,n=a.couleurPrimaire,N=a.couleurSecondaire,p=U(n);return e.jsxs("div",{className:"min-h-screen bg-gray-50 print:bg-white",style:{"--primary":n,"--secondary":N,"--text-on-primary":p},children:[e.jsx("style",{children:`
        @media print {
          body, html {
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            background: white !important;
            width: 58mm !important;
          }
          .receipt-container {
            width: 58mm !important;
            max-width: 58mm !important;
            padding: 2mm !important;
            font-size: 10px !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            border: none !important;
            page-break-after: avoid !important;
          }
          .compact-section {
            margin-bottom: 2px !important;
            padding: 2px !important;
          }
          .qr-code-container {
            width: 70px !important;
            height: 70px !important;
            margin: 0 auto !important;
          }
          .print-text-sm {
            font-size: 9px !important;
          }
          .print-py-1 {
            padding-top: 1px !important;
            padding-bottom: 1px !important;
          }
          .no-print {
            display: none !important;
          }
          .print-border-top {
            border-top: 4px solid var(--primary) !important;
          }
        }
      `}),e.jsx("header",{className:"sticky top-0 z-50 px-4 py-3 shadow-sm no-print",style:{backgroundColor:n,color:p},children:e.jsxs("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:[e.jsx("button",{onClick:z,className:"p-2 rounded-full hover:bg-white/10 transition","aria-label":"Retour",children:e.jsx(Q,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-3",children:[a.logoUrl&&e.jsx("img",{src:a.logoUrl,alt:`Logo ${a.nom}`,className:"h-10 w-10 rounded-full object-cover border-2",style:{borderColor:p,backgroundColor:w(n,.2)},onError:s=>{s.target.src="/default-company.png"}}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h1",{className:"text-sm font-bold",children:"Reçu de voyage"}),e.jsx("p",{className:"text-xs opacity-90",children:a.nom})]})]})]})}),e.jsxs("div",{className:"max-w-xs mx-auto p-2 print:p-0 print:max-w-none",children:[e.jsxs("div",{ref:y,className:"receipt-container bg-white rounded-lg shadow-sm overflow-hidden print-border-top",style:{width:"58mm",margin:"0 auto"},children:[e.jsxs("div",{className:"p-2 print:p-1 flex justify-between items-center print-py-1",style:{backgroundColor:n,color:p},children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-sm font-bold print-text-sm",children:a.nom}),t.agenceNom&&e.jsxs("div",{className:"flex items-center gap-1 text-xs opacity-90 print-text-sm",children:[e.jsx(B,{className:"h-3 w-3"}),e.jsx("span",{children:t.agenceNom})]}),(t.agenceTelephone||a.telephone)&&e.jsxs("div",{className:"flex items-center gap-1 text-xs opacity-90 print-text-sm",children:[e.jsx(J,{className:"h-3 w-3"}),e.jsx("span",{children:t.agenceTelephone||a.telephone})]})]}),a.logoUrl&&e.jsx("img",{src:a.logoUrl,alt:a.nom,className:"h-8 w-8 object-contain bg-white p-1 rounded-full print:h-6 print:w-6",onError:s=>{s.target.src="/default-company.png"}})]}),e.jsxs("div",{className:"p-2 print:p-1 print-py-1",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2 pb-1 border-b border-gray-200 compact-section",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs text-gray-500 print-text-sm",children:["N° ",b()]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500 print-text-sm",children:[e.jsx(V,{className:"h-3 w-3"}),e.jsx("span",{children:D(t.createdAt,"dd/MM/yyyy à HH:mm")})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium print-text-sm",style:{backgroundColor:w(n,.15),color:n},children:t.statut})})]}),e.jsxs("div",{className:"mb-2 compact-section",children:[e.jsx("h3",{className:"text-xs font-semibold mb-1",style:{color:n},children:"Client"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-xs print-text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Nom"}),e.jsx("p",{className:"truncate",children:t.nomClient})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Téléphone"}),e.jsx("p",{children:t.telephone})]}),t.email&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Email"}),e.jsx("p",{className:"truncate",children:t.email})]}),t.referenceCode&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Référence"}),e.jsx("p",{className:"font-mono text-xs",children:t.referenceCode})]})]})]}),e.jsxs("div",{className:"mb-2 compact-section",children:[e.jsx("h3",{className:"text-xs font-semibold mb-1 print-text-sm",style:{color:n},children:"Voyage"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-xs print-text-sm",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Trajet"}),e.jsxs("p",{className:"font-medium",children:[t.depart," → ",t.arrivee]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Date"}),e.jsx("p",{children:D(t.date,"dd/MM/yyyy")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Heure"}),e.jsx("p",{children:t.heure})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Places"}),e.jsxs("p",{children:[t.seatsGo," ",t.seatsReturn?`(+${t.seatsReturn} retour)`:""]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Canal"}),e.jsx("p",{className:"capitalize",children:t.canal})]})]})]}),e.jsxs("div",{className:"mb-2 compact-section",children:[e.jsx("h3",{className:"text-xs font-semibold mb-1 print-text-sm",style:{color:n},children:"Paiement"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 text-xs print-text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Montant"}),e.jsxs("p",{className:"font-bold",style:{color:n},children:[(P=t.montant)==null?void 0:P.toLocaleString("fr-FR")," FCFA"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xs text-gray-600 print-text-sm",children:"Méthode"}),e.jsx("p",{className:"capitalize",children:t.paiement})]})]})]}),e.jsxs("div",{className:"mt-2 p-1 rounded border border-gray-200 flex flex-col items-center compact-section",children:[e.jsx("h3",{className:"text-xs font-semibold mb-1 print-text-sm",style:{color:n},children:"Code d'embarquement"}),e.jsx("div",{className:"bg-white p-1 rounded border qr-code-container",style:{borderColor:n},children:e.jsx(Y,{value:L,size:70,fgColor:n,level:"H"})}),e.jsx("p",{className:"text-2xs text-gray-500 mt-1 text-center print-text-sm",children:"Présentez ce code QR au chauffeur"})]}),e.jsxs("div",{className:"mt-1 pt-1 border-t border-gray-200 text-center text-2xs text-gray-500 compact-section print-text-sm",children:[e.jsx("p",{children:"Reçu valable uniquement pour le trajet indiqué"}),e.jsxs("p",{className:"mt-0.5",children:["Merci d'avoir choisi ",a.nom]})]})]})]}),e.jsxs("div",{className:"no-print mt-3 grid grid-cols-1 gap-2",children:[e.jsxs("button",{onClick:F,className:"flex items-center justify-center gap-2 px-4 py-2 rounded-lg shadow transition-colors text-xs",style:{backgroundColor:n,color:p},children:[e.jsx(_,{className:"h-4 w-4"}),"Télécharger"]}),e.jsxs("button",{onClick:()=>window.print(),className:"flex items-center justify-center gap-2 px-4 py-2 rounded-lg shadow transition-colors text-xs",style:{backgroundColor:N||w(n,.8),color:U(N||n)},children:[e.jsx(K,{className:"h-4 w-4"}),"Imprimer"]}),e.jsxs("button",{onClick:()=>m(`/compagnie/${a.slug}`),className:"flex items-center justify-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow hover:bg-gray-300 transition-colors text-xs",children:[e.jsx(W,{className:"h-4 w-4"}),"Retour à la compagnie"]})]})]})]})};export{me as default};
