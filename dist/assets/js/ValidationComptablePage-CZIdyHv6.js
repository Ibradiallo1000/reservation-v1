import{r as d,a,j as t}from"./vendor-Bq-8_m9i.js";import{t as f,u as v,r as w,w as C,I,G as A,o as D,y as k,T as R}from"./firebase-CURBI7X6.js";import{b as j,e as $,d as x,O as m}from"./agence-Bsj2lp2X.js";import{a9 as E,V as B,_ as F}from"./icons-C0JHUK9Z.js";import"./compagnie-DiuZFnHS.js";import"./router-DoGdw-3y.js";import"./courier-CoQgRaHG.js";function y(e){var l;if(!e)return"—";const n=(l=e==null?void 0:e.toDate)!=null&&l.call(e)?e.toDate():new Date(e);return isNaN(n.getTime())?"—":n.toLocaleString("fr-FR")}const P=()=>{const{user:e,company:n}=j(),l=$(n)||{primary:"#EA580C",secondary:"#F97316"},[h,b]=d.useState([]),[p,g]=d.useState(!1),r=d.useCallback(async()=>{if(!(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))){g(!0);try{const s=f(x,`companies/${e.companyId}/agences/${e.agencyId}/shiftReports`),i=await v(w(s,C("status","==","awaiting_accountant"),I("endAt","desc"),A(50)));b(i.docs.map(o=>o.data()))}finally{g(!1)}}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId]);d.useEffect(()=>{r()},[r]);const u=async s=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const i=D(x,`companies/${e.companyId}/agences/${e.agencyId}/shiftReports/${s.shiftId}`);await k(i,{status:"awaiting_manager",accountantValidatedAt:R.now()}),await r()};return a("div",{className:"max-w-6xl mx-auto p-4",children:[a("header",{className:"flex items-center justify-between mb-4",children:[a("div",{className:"flex items-center gap-2",children:[t("div",{className:"h-10 w-10 rounded bg-gray-100 grid place-items-center border",children:t(E,{className:"h-5 w-5 text-gray-600"})}),t("h1",{className:"text-xl font-bold",children:"Validations – Comptabilité"})]}),t("button",{onClick:r,className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",children:"Actualiser"})]}),p&&t("div",{className:"text-sm text-gray-600",children:"Chargement…"}),!p&&h.length===0&&t("div",{className:"text-sm text-gray-600",children:"Aucun rapport en attente de validation comptable."}),t("div",{className:"space-y-4",children:h.map(s=>a("div",{className:"rounded-2xl border bg-white p-5 shadow-sm",children:[a("div",{className:"flex items-center justify-between",children:[a("div",{children:[a("div",{className:"text-lg font-semibold",children:["Session #",s.shiftId.slice(0,6)," – Guichetier ",s.guichetierCode||s.guichetierId]}),a("div",{className:"text-xs text-gray-500",children:["Début : ",y(s.startAt)," • Fin : ",y(s.endAt)]})]}),t("span",{className:"px-3 py-1 rounded-full text-xs font-semibold",style:{background:"#FEF3C7",color:"#92400E"},children:"En attente de validation comptable"})]}),a("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4",children:[a("div",{className:"rounded-xl border p-4 bg-gray-50",children:[t("div",{className:"text-sm text-gray-500",children:"Réservations"}),t("div",{className:"text-2xl font-bold",children:s.reservationsCount})]}),a("div",{className:"rounded-xl border p-4 bg-gray-50",children:[t("div",{className:"text-sm text-gray-500",children:"Billets"}),t("div",{className:"text-2xl font-bold",children:s.ticketsCount})]}),a("div",{className:"rounded-xl border p-4 bg-gray-50",children:[t("div",{className:"text-sm text-gray-500",children:"Montant"}),t("div",{className:"text-2xl font-bold",children:m(s.amountTotal)})]})]}),a("div",{className:"mt-4",children:[t("div",{className:"font-semibold mb-2",children:"Détails par trajet"}),Array.isArray(s.byRoute)&&s.byRoute.length>0?s.byRoute.map((i,o)=>a("div",{className:"mb-3 rounded-lg border overflow-hidden",children:[a("div",{className:"px-3 py-2 bg-gray-50 flex items-center justify-between",children:[a("div",{className:"font-medium",children:[i.depart," → ",i.arrivee]}),a("div",{className:"text-sm",children:[t("b",{children:i.totalBillets})," billets • ",t("b",{children:m(i.totalMontant)})]})]}),a("table",{className:"w-full text-sm",children:[t("thead",{className:"bg-white",children:a("tr",{children:[t("th",{className:"px-3 py-2 text-left",children:"Date"}),t("th",{className:"px-3 py-2 text-left",children:"Heure"}),t("th",{className:"px-3 py-2 text-right",children:"Billets"}),t("th",{className:"px-3 py-2 text-right",children:"Montant"})]})}),t("tbody",{children:i.trips.map((c,N)=>a("tr",{className:"border-t",children:[t("td",{className:"px-3 py-2",children:c.date}),t("td",{className:"px-3 py-2",children:c.heure}),t("td",{className:"px-3 py-2 text-right",children:c.billets}),t("td",{className:"px-3 py-2 text-right",children:m(c.montant)})]},N))})]})]},o)):t("div",{className:"text-gray-500 text-sm",children:"Aucune vente."})]}),a("div",{className:"mt-4 flex gap-2",children:[a("button",{className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",onClick:()=>window.print(),children:[t(B,{className:"h-4 w-4 inline mr-1"})," Imprimer"]}),a("button",{onClick:()=>u(s),className:"px-3 py-2 rounded-lg text-white",style:{background:`linear-gradient(90deg, ${l.primary}, ${l.secondary})`},children:[t(F,{className:"h-4 w-4 inline mr-1"})," Valider (envoyer au chef d’agence)"]})]})]},s.shiftId))})]})};export{P as default};
