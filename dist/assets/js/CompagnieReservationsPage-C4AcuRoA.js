import{c as I,d as pe,r as g,a as n,j as e,b2 as be,F as _,b3 as ae,b4 as ne,b5 as fe,b6 as xe}from"./react-KXT1Riez.js";import{t as re,r as ye,w as se,T as le,D as ve,u as we}from"./firebase-DYTOaTLw.js";import{u as Ne,c as ke,e as Ce,d as oe}from"../index-CBC3XRHi.js";import"./vendor-B27hBV_J.js";var ce={exports:{}};(function(x,T){(function(D,m){m()})(I,function(){function D(r,s){return typeof s>"u"?s={autoBom:!1}:typeof s!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),s={autoBom:!s}),s.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(r.type)?new Blob(["\uFEFF",r],{type:r.type}):r}function m(r,s,y){var o=new XMLHttpRequest;o.open("GET",r),o.responseType="blob",o.onload=function(){h(o.response,s,y)},o.onerror=function(){console.error("could not download file")},o.send()}function u(r){var s=new XMLHttpRequest;s.open("HEAD",r,!1);try{s.send()}catch{}return 200<=s.status&&299>=s.status}function N(r){try{r.dispatchEvent(new MouseEvent("click"))}catch{var s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),r.dispatchEvent(s)}}var b=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof I=="object"&&I.global===I?I:void 0,C=b.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),h=b.saveAs||(typeof window!="object"||window!==b?function(){}:"download"in HTMLAnchorElement.prototype&&!C?function(r,s,y){var o=b.URL||b.webkitURL,p=document.createElement("a");s=s||r.name||"download",p.download=s,p.rel="noopener",typeof r=="string"?(p.href=r,p.origin===location.origin?N(p):u(p.href)?m(r,s,y):N(p,p.target="_blank")):(p.href=o.createObjectURL(r),setTimeout(function(){o.revokeObjectURL(p.href)},4e4),setTimeout(function(){N(p)},0))}:"msSaveOrOpenBlob"in navigator?function(r,s,y){if(s=s||r.name||"download",typeof r!="string")navigator.msSaveOrOpenBlob(D(r,y),s);else if(u(r))m(r,s,y);else{var o=document.createElement("a");o.href=r,o.target="_blank",setTimeout(function(){N(o)})}}:function(r,s,y,o){if(o=o||open("","_blank"),o&&(o.document.title=o.document.body.innerText="downloading..."),typeof r=="string")return m(r,s,y);var p=r.type==="application/octet-stream",M=/constructor/i.test(b.HTMLElement)||b.safari,L=/CriOS\/[\d]+/.test(navigator.userAgent);if((L||p&&M||C)&&typeof FileReader<"u"){var E=new FileReader;E.onloadend=function(){var w=E.result;w=L?w:w.replace(/^data:[^;]*;/,"data:attachment/file;"),o?o.location.href=w:location=w,o=null},E.readAsDataURL(r)}else{var S=b.URL||b.webkitURL,R=S.createObjectURL(r);o?o.location=R:location.href=R,o=null,setTimeout(function(){S.revokeObjectURL(R)},4e4)}});b.saveAs=h.saveAs=h,x.exports=h})})(ce);var Se=ce.exports;const Y=x=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"XOF",maximumFractionDigits:0}).format(x),ie=(...x)=>x.filter(Boolean).join(" ");function Fe(x,T,D){const m=new Date,u=new Date(m.getFullYear(),m.getMonth(),m.getDate(),23,59,59,999);if(x==="day")return{start:new Date(m.getFullYear(),m.getMonth(),m.getDate(),0,0,0,0),end:u,label:"Aujourd’hui"};if(x==="week"){const h=new Date(m),r=(h.getDay()+6)%7,s=new Date(h);return s.setDate(h.getDate()-r),s.setHours(0,0,0,0),{start:s,end:u,label:"Cette semaine"}}if(x==="month"){const h=new Date(m.getFullYear(),m.getMonth(),1,0,0,0,0),r=new Intl.DateTimeFormat("fr-FR",{month:"long",year:"numeric"}).format(h);return{start:h,end:u,label:r}}const N=new Date(`${T}T00:00:00`),b=new Date(`${D}T23:59:59`),C=`${N.toLocaleDateString("fr-FR")} → ${b.toLocaleDateString("fr-FR")}`;return{start:N,end:b,label:C}}const Le=()=>{const{user:x,company:T}=Ne(),{companyId:D}=pe(),m=D??(x==null?void 0:x.companyId)??"",u=ke(T),{setHeader:N,resetHeader:b}=Ce(),C="week",[h,r]=g.useState(C),[s,y]=g.useState(""),[o,p]=g.useState(""),{start:M,end:L,label:E}=g.useMemo(()=>Fe(h,s,o),[h,s,o]),[S,R]=g.useState([]),[w,de]=g.useState([]),[f,K]=g.useState(null),[V,B]=g.useState({agences:!0,reservations:!0}),[z,me]=g.useState(!1),[O,ue]=g.useState(""),[P,ge]=g.useState(""),[U,he]=g.useState("tous"),[$,F]=g.useState(1);g.useEffect(()=>{if(!m)return;(async()=>{B(d=>({...d,agences:!0}));const i=(await we(re(oe,"companies",m,"agences"))).docs.map(d=>({id:d.id,nom:d.data().nomAgence||d.data().nom||d.data().ville||"Agence",ville:d.data().ville,pays:d.data().pays}));R(i),B(d=>({...d,agences:!1}))})()},[m]),g.useEffect(()=>{if(!m||S.length===0)return;B(i=>({...i,reservations:!0}));const t=[],a={};return S.forEach(i=>{const d=re(oe,"companies",m,"agences",i.id,"reservations"),v=ye(d,se("createdAt",">=",le.fromDate(M)),se("createdAt","<=",le.fromDate(L))),c=ve(v,l=>{const A=l.docs.map(j=>{var q,te;const k=j.data();return{id:j.id,agencyId:i.id,nomClient:k.nomClient,telephone:k.telephone,montant:k.montant||0,canal:(k.canal||"").toLowerCase().includes("ligne")?"en ligne":"guichet",statut:k.statut,depart:k.depart||"",arrivee:k.arrivee||"",createdAt:((te=(q=k.createdAt)==null?void 0:q.toDate)==null?void 0:te.call(q))||null}});a[i.id]=A;const X=Object.keys(a).map(j=>({agencyId:j,reservations:a[j]}));de(X),B(j=>({...j,reservations:!1}))});t.push(c)}),()=>{t.forEach(i=>i())}},[m,S,M,L]);const W=t=>S.find(a=>a.id===t)||null,J=t=>{const a=W(t||null);if(!a)return"Agence inconnue";const i=a.ville&&a.pays?` · ${a.ville}, ${a.pays}`:a.ville?` · ${a.ville}`:"";return`${a.nom}${i}`},G=g.useMemo(()=>{var v;let a=((v=w.find(c=>c.agencyId===f))==null?void 0:v.reservations)||[];O&&(a=a.filter(c=>(c.depart||"").toLowerCase().includes(O.toLowerCase()))),P&&(a=a.filter(c=>(c.arrivee||"").toLowerCase().includes(P.toLowerCase()))),U!=="tous"&&(a=a.filter(c=>(c.canal||"").toLowerCase()===U));const i={};for(const c of a){const l=`${c.depart||"?"} → ${c.arrivee||"?"}`;i[l]||(i[l]={trajet:l,billets:0,ca:0,guichet:0,enLigne:0,lastSale:null}),i[l].billets+=1,i[l].ca+=c.montant||0,c.canal==="guichet"?i[l].guichet+=1:i[l].enLigne+=1,(!i[l].lastSale||c.createdAt&&c.createdAt>i[l].lastSale)&&(i[l].lastSale=c.createdAt||null)}return Object.values(i).sort((c,l)=>l.ca-c.ca)},[w,f,O,P,U]),Q=Math.ceil(G.length/10),Z=G.slice(($-1)*10,$*10),H=g.useMemo(()=>{var c;const t=((c=w.find(l=>l.agencyId===f))==null?void 0:c.reservations)||[],a=t.reduce((l,A)=>l+(A.montant||0),0),i=t.length,d=t.filter(l=>l.canal==="guichet").length,v=t.filter(l=>l.canal==="en ligne").length;return{ca:a,billets:i,guichet:d,enLigne:v}},[w,f]),ee=()=>{var c;const t=G;if(t.length===0)return;const a=`Trajet,Billets,Guichet,En ligne,CA
`,i=t.map(l=>[`"${l.trajet}"`,l.billets,l.guichet,l.enLigne,l.ca].join(",")).join(`
`),d=new Blob([a+i],{type:"text/csv;charset=utf-8;"}),v=((c=W(f||""))==null?void 0:c.nom)||"agence";Se.saveAs(d,`reservations-agregees-${v}-${new Date().toISOString().slice(0,10)}.csv`)};return g.useEffect(()=>{const t=n(_,{children:[["day","week","month"].map(a=>e("button",{onClick:()=>{r(a),F(1),K(null)},className:ie("px-3 py-1 rounded-full text-sm border transition",h===a?"bg-white text-gray-900":"bg-white/10 backdrop-blur text-white border-white/30 hover:bg-white/20"),children:a==="day"?"Aujourd'hui":a==="week"?"Semaine":"Mois"},a)),n("button",{onClick:()=>me(a=>!a),className:"ml-2 flex items-center px-3 py-1 rounded-full text-sm border bg-white/10 text-white hover:bg-white/20 border-white/30",title:"Filtres & période personnalisée",children:[e(be,{className:"mr-2"}),"Filtres"]}),f&&n(_,{children:[n("button",{onClick:ee,className:"flex items-center px-3 py-1 rounded-full text-sm border bg-white/10 text-white hover:bg-white/20 border-white/30",children:[e(ae,{className:"mr-2"}),"Exporter"]}),n("button",{onClick:()=>window.print(),className:"flex items-center px-3 py-1 rounded-full text-sm bg-white text-gray-900 hover:bg-gray-100",children:[e(ne,{className:"mr-2"}),"Imprimer"]})]})]});return N({title:`Réservations — ${E}`,subtitle:f?J(f):"",actions:t,bg:`linear-gradient(90deg, ${u.colors.primary} 0%, ${u.colors.secondary} 100%)`,fg:"#fff"}),()=>b()},[E,f,h,z,u.colors.primary,u.colors.secondary]),m?e("div",{className:"min-h-screen p-4 md:p-8",style:{background:"linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%)"},children:n("div",{className:"max-w-7xl mx-auto",children:[z&&n("div",{className:"rounded-2xl p-4 mb-6 border shadow-sm",style:{background:"rgba(255,255,255,0.55)",backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",borderColor:"rgba(0,0,0,0.08)"},children:[n("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[n("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Période perso — Début"}),e("input",{type:"date",value:s,onChange:t=>y(t.target.value),className:"w-full p-2 border rounded-md bg-white/70"})]}),n("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Période perso — Fin"}),e("input",{type:"date",value:o,onChange:t=>p(t.target.value),className:"w-full p-2 border rounded-md bg-white/70"})]}),n("div",{className:"lg:col-span-2 flex items-end gap-2",children:[e("button",{className:"px-3 py-2 rounded-md border bg-white hover:bg-gray-50",onClick:()=>r("custom"),disabled:!s||!o,children:"Appliquer"}),e("button",{className:"px-3 py-2 rounded-md border bg-white hover:bg-gray-50",onClick:()=>{y(""),p(""),r(C)},children:"Réinitialiser"})]})]}),f&&n(_,{children:[e("hr",{className:"my-4"}),n("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[n("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Départ"}),e("input",{placeholder:"ex: Bamako",value:O,onChange:t=>{ue(t.target.value),F(1)},className:"w-full p-2 border rounded-md bg-white/70"})]}),n("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Arrivée"}),e("input",{placeholder:"ex: Ségou",value:P,onChange:t=>{ge(t.target.value),F(1)},className:"w-full p-2 border rounded-md bg-white/70"})]}),n("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Canal"}),n("select",{value:U,onChange:t=>{he(t.target.value),F(1)},className:"w-full p-2 border rounded-md bg-white/70",children:[e("option",{value:"tous",children:"Tous"}),e("option",{value:"guichet",children:"Guichet"}),e("option",{value:"en ligne",children:"En ligne"})]})]})]})]})]}),V.agences||V.reservations?e("div",{className:"flex justify-center items-center h-64",children:e("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):n(_,{children:[e("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 mb-8",children:w.map(t=>{const a=W(t.agencyId),i=t.reservations.reduce((A,X)=>A+(X.montant||0),0),d=t.reservations.length,v=t.reservations.filter(A=>A.canal==="guichet").length,c=d-v,l=d?Math.round(v/d*100):0;return n("div",{onClick:()=>{K(f===t.agencyId?null:t.agencyId),F(1)},className:ie("relative p-6 rounded-2xl cursor-pointer transition-all","border shadow-sm hover:shadow-lg"),style:{background:"rgba(255,255,255,0.58)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderColor:f===t.agencyId?u.colors.secondary:"rgba(0,0,0,0.08)"},children:[e("div",{className:"absolute left-0 right-0 top-0 h-1.5 rounded-t-2xl",style:{background:`linear-gradient(90deg, ${u.colors.secondary}, ${u.colors.accent})`}}),n("div",{className:"flex items-start justify-between",children:[n("div",{children:[e("h2",{className:"text-base font-semibold text-gray-900",children:(a==null?void 0:a.nom)||"Agence"}),n("p",{className:"text-xs text-gray-500",children:[a!=null&&a.ville?a.ville:""," ",a!=null&&a.pays?`• ${a.pays}`:""]})]}),n("span",{className:"text-xs px-2 py-0.5 rounded-full",style:{backgroundColor:`${u.colors.secondary}15`,color:u.colors.secondary},children:[d," billets"]})]}),n("div",{className:"mt-4",children:[e("div",{className:"text-2xl font-bold",children:Y(i)}),e("p",{className:"text-xs text-gray-500",children:"CA sur la période"})]}),n("div",{className:"mt-4",children:[n("div",{className:"flex justify-between text-xs text-gray-600 mb-1",children:[e("span",{children:"Guichet"}),n("span",{children:[v,"/",d," (",l,"%)"]})]}),e("div",{className:"w-full h-2 bg-gray-200/70 rounded-full overflow-hidden",children:e("div",{className:"h-full",style:{width:`${l}%`,background:`linear-gradient(90deg, ${u.colors.primary}, ${u.colors.secondary})`}})}),n("div",{className:"flex justify-between text-xs text-gray-600 mt-1",children:[e("span",{children:"En ligne"}),n("span",{children:[c,"/",d," (",100-l,"%)"]})]})]})]},t.agencyId)})}),f&&n("div",{className:"rounded-2xl border shadow-sm overflow-hidden",style:{background:"rgba(255,255,255,0.58)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderColor:"rgba(0,0,0,0.08)"},children:[e("div",{className:"p-6 border-b",children:n("div",{className:"flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3",children:[n("div",{children:[e("h3",{className:"text-lg font-semibold text-gray-900",children:J(f)}),n("p",{className:"text-sm text-gray-600",children:[H.billets," billets ·"," ",e("span",{className:"font-medium",children:Y(H.ca)})," ","· Guichet ",H.guichet," — En ligne ",H.enLigne]})]}),n("div",{className:"flex items-center gap-2",children:[n("button",{onClick:ee,className:"flex items-center px-3 py-1 rounded-full text-sm border bg-white hover:bg-gray-50",children:[e(ae,{className:"mr-2"}),"Exporter (agrégé)"]}),n("button",{onClick:()=>window.print(),className:"flex items-center px-3 py-1 rounded-full text-sm",style:{backgroundColor:u.colors.primary,color:"#fff"},children:[e(ne,{className:"mr-2"}),"Imprimer"]})]})]})}),e("div",{className:"overflow-x-auto",children:n("table",{className:"min-w-full divide-y divide-gray-200",children:[e("thead",{className:"bg-white/60 backdrop-blur",children:n("tr",{children:[e("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Trajet"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Billets"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Guichet"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"En ligne"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"CA"}),e("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wide",children:"Dernière vente"})]})}),e("tbody",{className:"bg-white/40 backdrop-blur divide-y divide-gray-100",children:Z.length===0?e("tr",{children:e("td",{colSpan:6,className:"px-6 py-8 text-center text-gray-500",children:"Aucune donnée pour cette agence et ces filtres."})}):Z.map(t=>n("tr",{className:"hover:bg-white/60",children:[e("td",{className:"px-6 py-3 text-sm font-medium text-gray-900",children:t.trajet}),e("td",{className:"px-6 py-3 text-sm text-right",children:t.billets}),e("td",{className:"px-6 py-3 text-sm text-right",children:t.guichet}),e("td",{className:"px-6 py-3 text-sm text-right",children:t.enLigne}),e("td",{className:"px-6 py-3 text-sm text-right",children:Y(t.ca)}),e("td",{className:"px-6 py-3 text-sm text-right text-gray-600",children:t.lastSale?t.lastSale.toLocaleDateString("fr-FR"):"—"})]},t.trajet))})]})}),G.length>10&&n("div",{className:"px-6 py-4 border-t flex items-center justify-between bg-white/60 backdrop-blur",children:[n("button",{onClick:()=>F(t=>Math.max(1,t-1)),disabled:$===1,className:"flex items-center px-3 py-1 border rounded-full text-sm bg-white hover:bg-gray-50 disabled:opacity-50",children:[e(fe,{className:"mr-1"}),"Précédent"]}),n("span",{className:"text-sm text-gray-700",children:["Page ",$," sur ",Q]}),n("button",{onClick:()=>F(t=>t+1),disabled:$===Q,className:"flex items-center px-3 py-1 border rounded-full text-sm bg-white hover:bg-gray-50 disabled:opacity-50",children:["Suivant",e(xe,{className:"ml-1"})]})]})]})]})]})}):n("div",{className:"p-6",children:[e("h1",{className:"text-xl font-semibold mb-2",children:"Réservations"}),e("p",{className:"text-sm text-muted-foreground",children:"Impossible d'identifier la compagnie (companyId manquant)."})]})};export{Le as default};
