import{b as Jt,r as l,a as s,j as t,B as Qt,M as Xt,aj as Zt,T as gt,b3 as Je,b4 as ht,b0 as ea,b5 as ft,b6 as ta,b7 as aa,b8 as na,aw as sa,a9 as yt,a4 as ca,b9 as vt,a8 as bt,ao as ia,F as oa,ap as la}from"./react-DB_4kGOy.js";import{q as me,o as V,x as J,A as xt,w as le,y as K,z as ue,H as Nt,T as Q,C as Qe,B as ye,I as ra,F as da}from"./firebase-lLzYRzUk.js";import{u as ma,b as ua,d as C}from"../index-Bkmir__O.js";import"./vendor-C-DAJou6.js";const O=d=>`${(d||0).toLocaleString("fr-FR")} FCFA`,pa=d=>new Date(d.getFullYear(),d.getMonth(),1,0,0,0,0),ga=d=>new Date(d.getFullYear(),d.getMonth()+1,1,0,0,0,0),pe=d=>d?d.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—",ha=d=>d?new Date(d).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}):"—",Ca=()=>{const d=Jt(),{user:e,company:E,logout:D}=ma(),y=ua(E)||{primary:"#EA580C",secondary:"#F97316"},[ae,Y]=l.useState(null),[U,b]=l.useState("Compagnie"),[xe,Oe]=l.useState("Agence"),[z,B]=l.useState("controle"),[w,qe]=l.useState(null),[Z,Pe]=l.useState("ACCOUNT"),[Ne,we]=l.useState([]),[q,Ie]=l.useState([]),[P,wt]=l.useState([]),[ne,It]=l.useState([]),[Ce,Ct]=l.useState([]),[va,ba]=l.useState(10),[ge,Ze]=l.useState([]),[St,et]=l.useState(!1),[Ve,kt]=l.useState(""),[Se,tt]=l.useState(0),[Ue,at]=l.useState({}),[Ge,_e]=l.useState({}),[re,Rt]=l.useState({}),[ke,At]=l.useState({}),ee=l.useRef({}),[ze,Tt]=l.useState({}),[he,Dt]=l.useState(!1),[He,$t]=l.useState(()=>{const a=new Date;return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`}),[Re,Et]=l.useState(""),[Ae,Mt]=l.useState(""),[We,Bt]=l.useState([]),[nt,Ft]=l.useState(0),[st,Lt]=l.useState(0),[jt,ct]=l.useState(!1),[Ot,Ke]=l.useState(!1),[F,se]=l.useState({kind:"depense",montant:"",libelle:"",banque:"",note:""});l.useEffect(()=>{(async()=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const a=await me(V(C,"companies",e.companyId));if(a.exists()){const c=a.data();Y(c.logoUrl||c.logo||null),b(c.nom||c.name||"Compagnie")}const n=await me(V(C,`companies/${e.companyId}/agences/${e.agencyId}`));if(n.exists()){const c=n.data(),o=(c==null?void 0:c.ville)||(c==null?void 0:c.city)||(c==null?void 0:c.nomVille)||(c==null?void 0:c.villeDepart)||"";Oe((c==null?void 0:c.nomAgence)||(c==null?void 0:c.nom)||o||"Agence")}const u=await me(V(C,"users",e.uid));if(u.exists()){const c=u.data(),o={id:e.uid,displayName:c.displayName||e.displayName||"",email:c.email||e.email||"",staffCode:c.staffCode,codeCourt:c.codeCourt,code:c.code};qe(o),Pe(c.staffCode||c.codeCourt||c.code||"ACCOUNT")}})().catch(console.error)},[e==null?void 0:e.uid,e==null?void 0:e.companyId,e==null?void 0:e.agencyId]);const qt=(a,n)=>({id:a,userId:n.userId||n.openedById||"",userName:n.userName||n.openedByName||n.userEmail||"",userEmail:n.userEmail||"",userCode:n.userCode||n.openedByCode||"",companyId:n.companyId,agencyId:n.agencyId,status:n.status,startTime:n.startTime||n.openedAt,endTime:n.endTime||n.closedAt,totalTickets:n.totalTickets,totalReservations:n.totalReservations,totalAmount:n.totalAmount,payBy:n.payBy,accountantId:n.accountantId,accountantCode:n.accountantCode,accountantName:n.accountantName,validatedAt:n.validatedAt,cashExpected:n.cashExpected,cashReceived:n.cashReceived,mmExpected:n.mmExpected,mmReceived:n.mmReceived,comptable:n.comptable});l.useEffect(()=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const a=J(C,`companies/${e.companyId}/agences/${e.agencyId}/shifts`),n=xt(a,async u=>{const c=u.docs.map(i=>qt(i.id,i.data())),o=Array.from(new Set(c.map(i=>i.userId).filter(i=>!!i&&!re[i])));if(o.length){const i=await Promise.all(o.map(async m=>{const g=await me(V(C,"users",m));if(!g.exists())return[m,{}];const p=g.data();return[m,{name:p.displayName||p.nom||p.email||"",email:p.email||"",code:p.staffCode||p.codeCourt||p.code||""}]}));Rt(m=>Object.fromEntries([...Object.entries(m),...i]))}const r=i=>{var m,g,p,v,x,A;return(((g=(m=i.validatedAt)==null?void 0:m.toMillis)==null?void 0:g.call(m))??0)||(((v=(p=i.endTime)==null?void 0:p.toMillis)==null?void 0:v.call(p))??0)||(((A=(x=i.startTime)==null?void 0:x.toMillis)==null?void 0:A.call(x))??0)};we(c.filter(i=>i.status==="pending").sort((i,m)=>r(m)-r(i))),Ie(c.filter(i=>i.status==="active").sort((i,m)=>r(m)-r(i))),wt(c.filter(i=>i.status==="paused").sort((i,m)=>r(m)-r(i))),It(c.filter(i=>i.status==="closed").sort((i,m)=>r(m)-r(i))),Ct(c.filter(i=>i.status==="validated").sort((i,m)=>r(m)-r(i)))});return()=>n()},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId]),l.useEffect(()=>{var n,u;if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const a=J(C,`companies/${e.companyId}/agences/${e.agencyId}/reservations`);for(const c of Object.keys(ee.current))!![...q,...P].find(r=>r.id===c)||((u=(n=ee.current)[c])==null||u.call(n),delete ee.current[c]);for(const c of[...q,...P]){if(ee.current[c.id])continue;const o=le(a,K("shiftId","==",c.id),K("canal","==","guichet")),r=xt(o,i=>{let m=0,g=0,p=0;i.forEach(v=>{const x=v.data();m+=1,g+=(x.seatsGo||0)+(x.seatsReturn||0),p+=x.montant||0}),At(v=>({...v,[c.id]:{reservations:m,tickets:g,amount:p}}))});ee.current[c.id]=r}return()=>{var c,o;for(const r of Object.keys(ee.current))(o=(c=ee.current)[r])==null||o.call(c);ee.current={}}},[q,P,e==null?void 0:e.companyId,e==null?void 0:e.agencyId]),l.useEffect(()=>{(async()=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const a=J(C,`companies/${e.companyId}/agences/${e.agencyId}/reservations`),n={};for(const u of ne){const c=await ue(le(a,K("shiftId","==",u.id)));let o=0,r=0,i=0,m=0;c.forEach(g=>{const p=g.data();o+=1,r+=(p.seatsGo||0)+(p.seatsReturn||0),i+=p.montant||0,String(p.paiement||"").toLowerCase().includes("esp")&&(m+=p.montant||0)}),n[u.id]={reservations:o,tickets:r,amount:i,cashExpected:m,mmExpected:0}}Tt(n)})().catch(a=>console.error("[Compta] Erreur agrégats réceptions:",a))},[ne,e==null?void 0:e.companyId,e==null?void 0:e.agencyId]);const Pt=l.useCallback(async a=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!w)return;const n=`companies/${e.companyId}/agences/${e.agencyId}`,u=V(C,`${n}/shifts/${a}`),c=V(C,`${n}/shiftReports/${a}`);await Nt(C,async o=>{const r=await o.get(u);if(!r.exists())throw new Error("Poste introuvable");const i=r.data(),m=Q.now(),g=i.startTime||i.openedAt||m;o.update(u,{status:"active",startTime:i.startTime??m}),o.set(c,{companyId:e.companyId,agencyId:e.agencyId,userId:i.userId||i.openedById||"",userName:i.userName||i.userEmail||"",userCode:i.userCode||i.openedByCode||"",startAt:g,updatedAt:m},{merge:!0})})},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,w]),Vt=l.useCallback(async a=>{!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||await Qe(V(C,`companies/${e.companyId}/agences/${e.agencyId}/shifts/${a}`),{status:"paused"})},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId]),Ut=l.useCallback(async a=>{!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||await Qe(V(C,`companies/${e.companyId}/agences/${e.agencyId}/shifts/${a}`),{status:"active"})},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId]),it=l.useCallback(async(a,n)=>{var h,I,$,H;if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const u=`companies/${e.companyId}/agences/${e.agencyId}`,c=V(C,`${u}/shifts/${a}`),o=J(C,`${u}/reservations`),r=await me(c);if(!r.exists()){alert("Poste introuvable");return}const i=r.data(),m=Q.now();if(await Qe(c,{status:"closed",endTime:m}),!(n!=null&&n.forcedByAccountant))return;const g=((I=(h=i.startTime)==null?void 0:h.toDate)==null?void 0:I.call(h))??((H=($=i.openedAt)==null?void 0:$.toDate)==null?void 0:H.call($))??new Date,p=m.toDate(),v=new Date(g.getTime()-5*60*1e3),x=new Date(p.getTime()+6*60*60*1e3),A=i.userId||i.openedById||"",S=i.userCode||i.openedByCode||"",R=le(o,K("createdAt",">=",Q.fromDate(v)),K("createdAt","<=",Q.fromDate(x)),ye("createdAt","asc")),T=(await ue(R)).docs.filter(G=>{const W=G.data();if(W.shiftId)return!1;const ie=String(W.canal||"").toLowerCase(),De=ie==="guichet"||ie===""&&String(W.paiement||"").toLowerCase().includes("esp"),de=!!A&&W.guichetierId===A||!!S&&W.guichetierCode===S;return De&&de});if(T.length){const G=ra(C);T.forEach(W=>G.update(W.ref,{shiftId:a})),await G.commit()}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId]),Gt=(a,n)=>at(u=>({...u,[a]:{cashReceived:n}})),_t=l.useCallback(async a=>{var S,R;if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!w||Ge[a.id])return;_e(f=>({...f,[a.id]:!0}));const n=Ue[a.id]||{cashReceived:"0"},c=(f=>{const T=(f||"").replace(/[^\d.,]/g,"").replace(",","."),h=Number(T);return Number.isFinite(h)&&h>=0?h:NaN})(n.cashReceived||"");if(!Number.isFinite(c)){alert("Montant espèces reçu invalide."),_e(f=>({...f,[a.id]:!1}));return}const o=0,r=V(C,`companies/${e.companyId}/agences/${e.agencyId}/shifts/${a.id}`),i=J(C,`companies/${e.companyId}/agences/${e.agencyId}/cashReceipts`),m=V(C,`companies/${e.companyId}/agences/${e.agencyId}/shiftReports/${a.id}`),g=ze[a.id],p=(g==null?void 0:g.cashExpected)??a.cashExpected??((S=a.payBy)==null?void 0:S.espèces)??0,v=(g==null?void 0:g.mmExpected)??a.mmExpected??((R=a.payBy)==null?void 0:R.mobile_money)??0,x=V(i),A=x.id;try{await Nt(C,async f=>{const T=await f.get(r);if(!T.exists())throw new Error("Poste introuvable.");const h=T.data();if(h.status!=="closed"&&h.status!=="validated")throw new Error("Seuls les postes clôturés peuvent être validés.");const I=Q.now(),$=h.startTime||h.openedAt||I,H=h.endTime||I,G={shiftId:a.id,userId:a.userId,userCode:a.userCode||"",companyId:e.companyId,agencyId:e.agencyId,totalAmount:(g==null?void 0:g.amount)??(h.totalAmount||0),cashExpected:p||0,cashReceived:c,mmExpected:v||0,mmReceived:o,accountantId:w.id,accountantName:w.displayName||w.email||"",accountantCode:Z,createdAt:I,type:"reception_caisse",note:"Réception espèces validée."};f.set(x,G),f.update(r,{status:"closed",endTime:H,accountantId:w.id,accountantName:w.displayName||w.email||"",accountantCode:Z,validatedAt:I,cashReceived:c,mmReceived:o,cashExpected:p||0,mmExpected:v||0,comptable:{...h.comptable||{},validated:!0,at:I,by:{id:w.id,name:w.displayName||w.email||""},note:"Réception espèces validée (comptabilité)"}}),f.set(m,{startAt:$,endAt:H,accountantValidated:!0,accountantValidatedAt:I,cashExpected:p||0,cashReceived:c,mmExpected:v||0,mmReceived:o,accountantStamp:{by:{id:w.id,code:Z,name:w.displayName||w.email||""},at:I,note:"Réception espèces validée (comptabilité)"},updatedAt:I},{merge:!0})}),at(f=>({...f,[a.id]:{cashReceived:""}})),alert("Réception enregistrée ✓"),A&&d(`/agence/receipt/${A}`)}catch(f){alert((f==null?void 0:f.message)||"Erreur lors de la validation.")}finally{_e(f=>({...f,[a.id]:!1}))}},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,w,Z,Ue,ze,d,Ge]),ot=l.useCallback(async a=>{var G,W,ie,De,de,rt,$e,dt,Ee,mt,Me,ut;if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId)||!a){Ze([]),tt(0);return}et(!0),kt(a);const n=`companies/${e.companyId}/agences/${e.agencyId}`,u=J(C,`${n}/reservations`),c=V(C,`${n}/shifts/${a}`),o=await me(c),r=o.exists()?o.data():{},i=((W=(G=r.startTime)==null?void 0:G.toDate)==null?void 0:W.call(G))??((De=(ie=r.openedAt)==null?void 0:ie.toDate)==null?void 0:De.call(ie))??null,m=((rt=(de=r.endTime)==null?void 0:de.toDate)==null?void 0:rt.call(de))??((dt=($e=r.closedAt)==null?void 0:$e.toDate)==null?void 0:dt.call($e))??null,g=r.userId||r.openedById||"",p=r.userCode||r.openedByCode||"",v=i?new Date(i.getTime()-5*60*1e3):null,x=m?new Date(m.getTime()+6*60*60*1e3):null,A=await ue(le(u,K("shiftId","==",a),K("canal","==","guichet"),ye("createdAt","asc")));let S=[];v&&x&&(S=(await ue(le(u,K("createdAt",">=",Q.fromDate(v)),ye("createdAt","asc")))).docs.filter(k=>{var Be,pt;const M=k.data(),oe=((pt=(Be=M.createdAt)==null?void 0:Be.toDate)==null?void 0:pt.call(Be))??new Date(0),te=oe>=v&&oe<=x,fe=String(M.canal||"").toLowerCase(),Wt=fe==="guichet"||fe===""&&String(M.paiement||"").toLowerCase().includes("esp"),Kt=!!g&&M.guichetierId===g||!!p&&M.guichetierCode===p,Yt=!M.shiftId||M.shiftId==="";return te&&Wt&&Kt&&Yt}));const R=N=>{const k=N.data();return{id:N.id,referenceCode:k.referenceCode,date:k.date,heure:k.heure,depart:k.depart,arrivee:k.arrivee,nomClient:k.nomClient,telephone:k.telephone,seatsGo:k.seatsGo||1,seatsReturn:k.seatsReturn||0,montant:k.montant||0,paiement:k.paiement,createdAt:k.createdAt,guichetierCode:k.guichetierCode||"",canal:k.canal}},T=[...A.docs,...S].map(R).filter(N=>String(N.canal||"").toLowerCase()==="guichet"||String(N.canal||"")===""&&String(N.paiement||"").toLowerCase().includes("esp")),h=N=>String(N||"").normalize("NFKC").replace(/\s+/g," ").trim().toLowerCase(),I=N=>N.referenceCode&&h(N.referenceCode)||[h(N.date),h(N.heure),h(N.depart),h(N.arrivee),h(N.nomClient),h(N.telephone)].join("|"),$=new Map;for(const N of T){const k=I(N),M=$.get(k);if(!M)$.set(k,N);else{const oe=((mt=(Ee=M.createdAt)==null?void 0:Ee.toMillis)==null?void 0:mt.call(Ee))??0,te=((ut=(Me=N.createdAt)==null?void 0:Me.toMillis)==null?void 0:ut.call(Me))??0;$.set(k,te>=oe?N:M)}}const H=[...$.values()].sort((N,k)=>{var M,oe,te,fe;return(((oe=(M=N.createdAt)==null?void 0:M.toMillis)==null?void 0:oe.call(M))??0)-(((fe=(te=k.createdAt)==null?void 0:te.toMillis)==null?void 0:fe.call(te))??0)});Ze(H),tt(T.length-H.length),et(!1)},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId]),lt=l.useMemo(()=>{const a={billets:0,montant:0};for(const n of ge){const u=(n.seatsGo||0)+(n.seatsReturn||0);a.billets+=u,a.montant+=n.montant||0}return a},[ge]),Ye=l.useMemo(()=>{let a=0,n=0,u=0;for(const c of[...q,...P]){const o=ke[c.id];o&&(a+=o.reservations,n+=o.tickets,u+=o.amount)}return{reservations:a,tickets:n,amount:u}},[q,P,ke]),ce=l.useMemo(()=>{if(he&&Re&&Ae){const c=new Date(Re);c.setHours(0,0,0,0);const o=new Date(Ae);return o.setHours(24,0,0,0),{from:c,to:o}}const[a,n]=He.split("-").map(Number),u=new Date(a,(n||1)-1,1);return{from:pa(u),to:ga(u)}},[he,Re,Ae,He]),Te=l.useCallback(async()=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;ct(!0);const a=J(C,`companies/${e.companyId}/agences/${e.agencyId}/cashReceipts`),n=J(C,`companies/${e.companyId}/agences/${e.agencyId}/cashMovements`),u=le(a,K("createdAt",">=",Q.fromDate(ce.from)),ye("createdAt","asc")),c=le(n,K("createdAt",">=",Q.fromDate(ce.from)),ye("createdAt","asc")),[o,r]=await Promise.all([ue(u),ue(c)]),i={};o.forEach(A=>{var h,I;const S=A.data(),R=((I=(h=S.createdAt)==null?void 0:h.toDate)==null?void 0:I.call(h))??new Date;if(R<ce.from||R>=ce.to)return;const f=R.toISOString().split("T")[0],T=Number(S.cashReceived||0);i[f]||(i[f]={in:0,out:0}),i[f].in+=Math.max(0,T)}),r.forEach(A=>{var I,$;const S=A.data(),R=(($=(I=S.createdAt)==null?void 0:I.toDate)==null?void 0:$.call(I))??new Date;if(R<ce.from||R>=ce.to)return;const f=R.toISOString().split("T")[0],T=String(S.kind||""),h=Number(S.amount||0);i[f]||(i[f]={in:0,out:0}),T==="depense"||T==="transfert_banque"?i[f].out+=Math.max(0,h):T==="entree_manual"&&(i[f].in+=Math.max(0,h))});const m=Object.keys(i).sort();let g=0;const p=[];let v=0,x=0;for(const A of m){const S=i[A].in||0,R=i[A].out||0;S===0&&R===0||(g+=S-R,v+=S,x+=R,p.push({dateISO:A,entrees:S,sorties:R,solde:g}))}Bt(p),Ft(v),Lt(x),ct(!1)},[e==null?void 0:e.companyId,e==null?void 0:e.agencyId,ce]);l.useEffect(()=>{Te()},[Te]);const zt=async()=>{if(!(e!=null&&e.companyId)||!(e!=null&&e.agencyId))return;const a=Number(F.montant||0);if(!Number.isFinite(a)||a<=0){alert("Montant invalide");return}const n={kind:F.kind,amount:a,label:F.libelle||(F.kind==="transfert_banque"?"Transfert vers banque":"Dépense"),bankName:F.kind==="transfert_banque"&&F.banque||"",note:F.note||"",companyId:e.companyId,agencyId:e.agencyId,accountantId:(w==null?void 0:w.id)||null,accountantCode:Z,createdAt:Q.now()};await da(J(C,`companies/${e.companyId}/agences/${e.agencyId}/cashMovements`),n),Ke(!1),se({kind:"depense",montant:"",libelle:"",banque:"",note:""}),await Te()},Ht=l.useCallback(a=>[...q,...P,...ne,...Ce].find(n=>n.id===a),[q,P,ne,Ce]);return s("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100",children:[t("div",{className:"sticky top-0 z-10 border-b bg-white/85 backdrop-blur supports-[backdrop-filter]:bg-white/65",children:t("div",{className:"max-w-7xl mx-auto px-4 py-3",children:s("div",{className:"flex flex-wrap items-center gap-3",children:[s("div",{className:"flex items-center gap-3 min-w-0",children:[ae?t("img",{src:ae,alt:"logo",className:"h-10 w-10 rounded-xl object-contain border bg-white p-1 flex-shrink-0"}):t("div",{className:"h-10 w-10 rounded-xl bg-gray-200 grid place-items-center flex-shrink-0",children:t(Qt,{className:"h-5 w-5 text-gray-600"})}),s("div",{className:"min-w-0",children:[t("div",{className:"text-lg font-extrabold tracking-tight truncate",style:{background:`linear-gradient(90deg, ${y.primary}, ${y.secondary})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},title:U,children:U}),s("div",{className:"text-xs text-gray-600 flex items-center gap-1 truncate",children:[t(Xt,{className:"h-3.5 w-3.5 flex-shrink-0"}),t("span",{className:"truncate",children:xe})]})]})]}),t("div",{className:"order-3 md:order-none w-full md:w-auto",children:s("div",{className:"inline-flex rounded-2xl p-1 bg-slate-100 shadow-inner w-full md:w-auto",children:[t(Fe,{active:z==="controle",onClick:()=>B("controle"),label:"Contrôle des postes",theme:y}),t(Fe,{active:z==="receptions",onClick:()=>B("receptions"),label:"Réceptions de caisse",theme:y}),t(Fe,{active:z==="rapports",onClick:()=>B("rapports"),label:"Rapports",theme:y}),t(Fe,{active:z==="caisse",onClick:()=>B("caisse"),label:"Caisse agence",theme:y})]})}),s("div",{className:"ml-auto flex items-center gap-2 flex-wrap",children:[w&&s("span",{className:"px-3 py-1 rounded-lg text-xs font-medium bg-indigo-50 text-indigo-700 shadow-sm",children:["Comptable • ",w.displayName||w.email||"—"," (",Z||"—",")"]}),s("button",{onClick:async()=>{await D(),d("/login")},className:"inline-flex items-center gap-1 px-3 py-2 text-sm rounded-lg border bg-white hover:bg-slate-50 shadow-sm",title:"Déconnexion",children:[t(Zt,{className:"h-4 w-4"})," ",t("span",{className:"hidden sm:inline",children:"Déconnexion"})]})]})]})})}),s("div",{className:"max-w-7xl mx-auto px-4 py-6 space-y-6",children:[z==="controle"&&s("div",{className:"space-y-6",children:[s("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[t(X,{icon:t(gt,{className:"h-5 w-5"}),label:"Billets (en direct)",value:Ye.tickets.toString(),theme:y}),t(X,{icon:t(Je,{className:"h-5 w-5"}),label:"Montant (en direct)",value:O(Ye.amount),theme:y}),t(X,{icon:t(ht,{className:"h-5 w-5"}),label:"Réservations (en direct)",value:Ye.reservations.toString(),theme:y})]}),s("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-3",children:[t(be,{tone:"indigo",label:"En attente",value:Ne.length}),t(be,{tone:"green",label:"En service",value:q.length}),t(be,{tone:"amber",label:"En pause",value:P.length}),t(be,{tone:"rose",label:"Clôturés",value:ne.length}),t(be,{tone:"slate",label:"Validés",value:Ce.length})]}),t(Xe,{title:"Postes en attente d’activation",hint:"Le guichetier est connecté mais ne peut pas vendre tant que vous n’activez pas.",icon:t(ea,{className:"h-5 w-5"}),list:Ne,usersCache:re,liveStats:{},theme:y,actions:a=>t(ve,{onClick:()=>Pt(a.id),theme:y,children:"Activer"})}),t(Xe,{title:"Postes en service",hint:"Statistiques mises à jour en direct.",icon:t(aa,{className:"h-5 w-5"}),list:q,usersCache:re,liveStats:ke,theme:y,actions:a=>s("div",{className:"flex gap-2",children:[s(Le,{onClick:()=>Vt(a.id),children:[t(ft,{className:"h-4 w-4 mr-1 inline"})," Pause"]}),s(ve,{onClick:()=>{confirm("Clôturer ce poste maintenant ?")&&it(a.id,{forcedByAccountant:!0})},theme:y,children:[t(ta,{className:"h-4 w-4 mr-1 inline"})," Clôturer"]})]})}),t(Xe,{title:"Postes en pause",hint:"Peuvent être remis en service.",icon:t(ft,{className:"h-5 w-5"}),list:P,usersCache:re,liveStats:ke,theme:y,actions:a=>s("div",{className:"flex gap-2",children:[t(ve,{onClick:()=>Ut(a.id),theme:y,children:"Continuer"}),t(Le,{onClick:()=>{confirm("Clôturer ce poste ?")&&it(a.id,{forcedByAccountant:!0})},children:"Clôturer"})]})})]}),z==="receptions"&&s("div",{className:"space-y-4",children:[t(fa,{icon:t(na,{className:"h-5 w-5"}),title:"Réceptions à valider",subtitle:"Validez la remise d’espèces des postes clôturés."}),(()=>{const a=ne.filter(n=>{var u;return!((u=n.comptable)!=null&&u.validated)});return a.length===0?t(je,{children:" Aucune clôture en attente."}):t("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:a.map(n=>{var T,h,I,$;const u=n.payBy||{},c=Ue[n.id]||{cashReceived:""},o=ze[n.id],r=(o==null?void 0:o.reservations)??n.totalReservations??0,i=(o==null?void 0:o.tickets)??n.totalTickets??0,m=(o==null?void 0:o.amount)??n.totalAmount??0,g=(o==null?void 0:o.cashExpected)??u.espèces??n.cashExpected??0,p=(o==null?void 0:o.mmExpected)??u.mobile_money??n.mmExpected??0,v=Number((c.cashReceived||"").replace(/[^\d.]/g,"")),x=(Number.isFinite(v)?v:0)-(g||0),A=!Number.isFinite(v)||v<0,S=re[n.userId]||{},R=S.name||n.userName||n.userEmail||n.userId,f=S.code||n.userCode||"—";return s("div",{className:"rounded-2xl border bg-white p-4 shadow-sm hover:shadow-md transition-shadow",children:[s("div",{className:"flex items-start justify-between gap-3",children:[s("div",{children:[t("div",{className:"text-xs text-gray-500",children:"Guichetier"}),s("div",{className:"font-semibold",children:[R," ",s("span",{className:"text-gray-500 text-xs",children:["(",f,")"]})]})]}),s("div",{className:"text-right",children:[t("div",{className:"text-xs text-gray-500",children:"Poste"}),t("div",{className:"font-medium text-gray-400",children:" "})]})]}),s("div",{className:"grid grid-cols-2 gap-3 mt-3 text-sm",children:[t(_,{label:"Début",value:n.startTime?pe(new Date(((h=(T=n.startTime).toDate)==null?void 0:h.call(T))??n.startTime)):"—"}),t(_,{label:"Fin",value:n.endTime?pe(new Date((($=(I=n.endTime).toDate)==null?void 0:$.call(I))??n.endTime)):"—"}),t(_,{label:"Réservations",value:r.toString()}),t(_,{label:"Billets",value:i.toString()}),t(_,{label:"Montant total",value:O(m)}),t(_,{label:"Espèces (attendu)",value:O(g)}),t(_,{label:"Mobile Money (info)",value:O(p)})]}),p>0&&s("div",{className:"mt-2 flex items-start gap-2 text-xs text-slate-700 bg-slate-50 border border-slate-100 p-2 rounded",children:[t(sa,{className:"h-4 w-4 mt-[1px]"}),t("span",{children:"Mobile Money : paiements en ligne (non remis par le guichetier)."})]}),s("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[s("div",{className:"col-span-2 sm:col-span-1",children:[t("div",{className:"text-xs text-gray-600 mb-1",children:"Espèces reçues"}),t("input",{type:"number",min:"0",inputMode:"numeric",className:"w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2",style:{outlineColor:y.primary},placeholder:"0",value:c.cashReceived,onChange:H=>Gt(n.id,H.target.value)})]}),s("div",{className:"col-span-2 sm:col-span-1",children:[t("div",{className:"text-xs text-gray-600 mb-1",children:"Écart (reçu - attendu)"}),t("div",{className:`w-full border rounded-lg px-3 py-2 bg-gray-50 ${x===0?"text-gray-700":x>0?"text-green-700":"text-red-700"}`,children:Number.isFinite(x)?O(x):"—"})]})]}),s("div",{className:"mt-3 flex items-center justify-between",children:[s(Le,{onClick:()=>{B("rapports"),ot(n.id)},children:[t(yt,{className:"h-4 w-4 inline mr-1"})," Voir détails"]}),s(ve,{disabled:A||!!Ge[n.id],onClick:()=>_t(n),theme:y,children:[t(ca,{className:"h-4 w-4 inline mr-1"})," Valider la réception"]})]})]},n.id)})})})()]}),z==="rapports"&&s("div",{className:"space-y-4",children:[s("div",{className:"rounded-2xl border shadow-sm p-4 bg-white",children:[s("div",{className:"flex items-center justify-between gap-3",children:[s("div",{className:"flex items-center gap-2 text-lg font-bold",children:[t(yt,{className:"h-5 w-5"})," Rapports par poste"]}),s("select",{className:"border rounded-lg px-3 py-2 text-sm bg-white shadow-sm",value:Ve,onChange:a=>ot(a.target.value),children:[t("option",{value:"",children:"— Choisir un poste —"}),[...q,...P,...ne,...Ce].map(a=>{var g,p,v,x;const n=re[a.userId]||{},u=n.name||a.userName||a.userEmail||a.userId,c=n.code||a.userCode||"—",o=a.startTime?new Date(((p=(g=a.startTime).toDate)==null?void 0:p.call(g))??a.startTime):null,r=a.endTime?new Date(((x=(v=a.endTime).toDate)==null?void 0:x.call(v))??a.endTime):null,i=a.status==="active"?"En service":a.status==="paused"?"En pause":a.status==="closed"?"Clôturé":a.status==="validated"?"Validé":"En attente",m=`${pe(o)} → ${pe(r)}`;return t("option",{value:a.id,children:`${u} (${c}) — ${m} — ${i}`},a.id)})]})]}),s("div",{className:"text-sm text-gray-500 mt-1",children:["Sélectionnez un poste pour lister ses réservations guichet (paiement espèces).",Se>0&&s("span",{className:"ml-2 text-xs text-slate-500",children:[Se," doublon",Se>1?"s":""," consolidé",Se>1?"s":"","."]})]}),Ve&&(()=>{var c,o,r,i;const a=Ht(Ve),n=a!=null&&a.startTime?new Date(((o=(c=a.startTime).toDate)==null?void 0:o.call(c))??a.startTime):null,u=a!=null&&a.endTime?new Date(((i=(r=a.endTime).toDate)==null?void 0:i.call(r))??a.endTime):null;return s("div",{className:"mt-1 text-xs text-slate-500",children:["Période du poste : ",pe(n)," → ",pe(u)]})})()]}),s("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[t(X,{icon:t(gt,{className:"h-5 w-5"}),label:"Billets",value:lt.billets.toString(),theme:y}),t(X,{icon:t(Je,{className:"h-5 w-5"}),label:"Montant",value:O(lt.montant),theme:y}),t(X,{icon:t(ht,{className:"h-5 w-5"}),label:"Réservations",value:ge.length.toString(),theme:y})]}),s("div",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[t("div",{className:"font-semibold mb-3",children:"Détails des réservations"}),St?t("div",{className:"text-gray-500",children:"Chargement…"}):ge.length?t("div",{className:"overflow-hidden rounded-lg border",children:s("table",{className:"w-full text-sm",children:[t("thead",{className:"bg-slate-50",children:s("tr",{children:[t(L,{children:"Date"}),t(L,{children:"Heure"}),t(L,{children:"Trajet"}),t(L,{children:"Client"}),t(L,{children:"Tél."}),t(L,{align:"right",children:"Billets"}),t(L,{align:"right",children:"Montant"}),t(L,{align:"right",children:"Paiement"}),t(L,{align:"right",children:"Vendeur"}),t(L,{align:"right",children:"Réf."})]})}),t("tbody",{children:ge.map(a=>s("tr",{className:"border-t",children:[t(j,{children:ha(a.date)}),t(j,{children:a.heure}),s(j,{children:[a.depart," → ",a.arrivee]}),t(j,{children:a.nomClient}),t(j,{children:a.telephone||""}),t(j,{align:"right",children:(a.seatsGo||0)+(a.seatsReturn||0)}),t(j,{align:"right",children:O(a.montant)}),t(j,{align:"right",children:a.paiement||""}),t(j,{align:"right",children:a.guichetierCode||""}),t(j,{align:"right",children:t("span",{className:"text-xs text-gray-500",children:a.referenceCode||a.id})})]},a.id))})]})}):t(je,{children:"Aucune donnée pour ce poste."})]})]}),z==="caisse"&&s("div",{className:"space-y-4",children:[s("div",{className:"rounded-2xl border shadow-sm p-4 bg-white",children:[s("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[s("div",{className:"flex items-center gap-2 text-lg font-bold",children:[t(vt,{className:"h-5 w-5"})," Caisse agence"]}),s("div",{className:"flex items-center gap-2",children:[s("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-slate-50",onClick:()=>Ke(!0),children:[t(bt,{className:"h-4 w-4 inline mr-1"})," Nouveau transfert / dépense"]}),s("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-slate-50",onClick:()=>ya(We),title:"Exporter CSV",children:[t(ia,{className:"h-4 w-4 inline mr-1"})," Export CSV"]})]})]}),s("div",{className:"mt-3 flex flex-wrap items-center gap-3",children:[s("label",{className:"flex items-center gap-2 text-sm",children:[t("input",{type:"checkbox",checked:he,onChange:a=>Dt(a.target.checked)}),"Période personnalisée"]}),!he&&s("div",{className:"flex items-center gap-2",children:[t("span",{className:"text-sm text-gray-600",children:"Mois :"}),t("input",{type:"month",className:"border rounded-lg px-3 py-2 text-sm",value:He,onChange:a=>$t(a.target.value)})]}),he&&s(oa,{children:[s("div",{className:"flex items-center gap-2",children:[t("span",{className:"text-sm text-gray-600",children:"Du"}),t("input",{type:"date",className:"border rounded-lg px-3 py-2 text-sm",value:Re,onChange:a=>Et(a.target.value)})]}),s("div",{className:"flex items-center gap-2",children:[t("span",{className:"text-sm text-gray-600",children:"Au"}),t("input",{type:"date",className:"border rounded-lg px-3 py-2 text-sm",value:Ae,onChange:a=>Mt(a.target.value)})]})]}),t("button",{className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-slate-50",onClick:Te,children:"Actualiser"})]})]}),s("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[t(X,{icon:t(Je,{className:"h-5 w-5"}),label:"Entrées (période)",value:O(nt),theme:y}),t(X,{icon:t(la,{className:"h-5 w-5"}),label:"Sorties (période)",value:O(st),theme:y}),t(X,{icon:t(vt,{className:"h-5 w-5"}),label:"Solde (période)",value:O(nt-st),theme:y})]}),s("div",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[t("div",{className:"font-semibold mb-3",children:"Journal (jours avec mouvements)"}),jt?t("div",{className:"text-gray-500",children:"Chargement…"}):We.length===0?t(je,{children:"Aucun mouvement sur la période."}):t("div",{className:"overflow-hidden rounded-lg border",children:s("table",{className:"w-full text-sm",children:[t("thead",{className:"bg-slate-50",children:s("tr",{children:[t(L,{children:"Date"}),t(L,{align:"right",children:"Entrées"}),t(L,{align:"right",children:"Sorties"}),t(L,{align:"right",children:"Solde"})]})}),t("tbody",{children:We.map(a=>s("tr",{className:"border-t",children:[t(j,{children:new Date(a.dateISO).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}),t(j,{align:"right",children:O(a.entrees)}),t(j,{align:"right",children:O(a.sorties)}),t(j,{align:"right",children:O(a.solde)})]},a.dateISO))})]})})]})]})]}),Ot&&t("div",{className:"fixed inset-0 bg-black/40 grid place-items-center z-20",children:s("div",{className:"w-[520px] max-w-[95vw] bg-white rounded-2xl p-4 shadow-lg",children:[t("div",{className:"text-lg font-bold mb-3",children:"Nouveau transfert / dépense"}),s("div",{className:"space-y-3",children:[s("div",{className:"grid grid-cols-2 gap-2",children:[s("label",{className:"text-sm flex items-center gap-2",children:[t("input",{type:"radio",name:"kind",checked:F.kind==="depense",onChange:()=>se(a=>({...a,kind:"depense"}))})," Dépense"]}),s("label",{className:"text-sm flex items-center gap-2",children:[t("input",{type:"radio",name:"kind",checked:F.kind==="transfert_banque",onChange:()=>se(a=>({...a,kind:"transfert_banque"}))})," Transfert banque"]})]}),t("input",{className:"w-full border rounded-lg px-3 py-2",placeholder:"Libellé",value:F.libelle,onChange:a=>se(n=>({...n,libelle:a.target.value}))}),F.kind==="transfert_banque"&&t("input",{className:"w-full border rounded-lg px-3 py-2",placeholder:"Banque / Compte",value:F.banque,onChange:a=>se(n=>({...n,banque:a.target.value}))}),t("input",{type:"number",min:"0",inputMode:"numeric",className:"w-full border rounded-lg px-3 py-2",placeholder:"Montant",value:F.montant,onChange:a=>se(n=>({...n,montant:a.target.value}))}),t("textarea",{className:"w-full border rounded-lg px-3 py-2",placeholder:"Note (facultatif)",value:F.note,onChange:a=>se(n=>({...n,note:a.target.value}))})]}),s("div",{className:"mt-4 flex justify-end gap-2",children:[t(Le,{onClick:()=>Ke(!1),children:"Annuler"}),s(ve,{onClick:zt,theme:y,children:[t(bt,{className:"h-4 w-4 inline mr-1"})," Enregistrer"]})]})]})})]})},Fe=({active:d,onClick:e,label:E,theme:D})=>t("button",{className:`px-4 py-2 rounded-2xl text-sm font-medium transition-all ${d?"text-white shadow":"hover:bg-white"}`,onClick:e,style:d?{background:`linear-gradient(90deg, ${D.primary}, ${D.secondary})`}:{},children:E}),ve=({theme:d,className:e="",...E})=>t("button",{...E,className:`px-3 py-2 rounded-lg text-white text-sm shadow-sm disabled:opacity-50 ${e}`,style:{background:`linear-gradient(90deg, ${d.primary}, ${d.secondary})`}}),Le=d=>t("button",{...d,className:"px-3 py-2 rounded-lg border text-sm bg-white hover:bg-slate-50 shadow-sm"}),X=({icon:d,label:e,value:E,theme:D})=>s("div",{className:"rounded-2xl border p-4 bg-white shadow-sm hover:shadow-md transition-shadow",children:[s("div",{className:"flex items-center justify-between",children:[t("div",{className:"text-sm text-gray-500",children:e}),t("div",{className:"h-8 w-8 rounded-lg grid place-items-center",style:{background:`linear-gradient(45deg, ${D.primary}22, ${D.secondary}22)`},children:t("span",{className:"text-gray-700",children:d})})]}),t("div",{className:"text-2xl font-extrabold mt-1",children:E})]}),be=({tone:d,label:e,value:E})=>{const D={indigo:["bg-indigo-50","text-indigo-700"],green:["bg-green-50","text-green-700"],amber:["bg-amber-50","text-amber-700"],rose:["bg-rose-50","text-rose-700"],slate:["bg-slate-50","text-slate-700"]};return s("div",{className:"rounded-2xl border p-4 bg-white shadow-sm",children:[t("div",{className:`inline-flex px-2 py-0.5 rounded ${D[d][0]} text-xs ${D[d][1]}`,children:e}),t("div",{className:"text-2xl font-bold mt-1",children:E})]})},fa=({icon:d,title:e,subtitle:E})=>s("div",{className:"rounded-2xl border shadow-sm p-4 bg-white",children:[s("div",{className:"flex items-center gap-2 text-lg font-bold",children:[d," ",e]}),E&&t("div",{className:"text-sm text-gray-500 mt-1",children:E})]}),Xe=({title:d,hint:e,icon:E,list:D,usersCache:y,liveStats:ae,actions:Y,theme:U})=>s("div",{className:"rounded-2xl border shadow-sm p-4 bg-white",children:[s("div",{className:"flex items-center justify-between",children:[s("div",{className:"flex items-center gap-2 text-lg font-bold",children:[E,t("span",{children:d})]}),s("div",{className:"text-xs font-medium px-2 py-1 rounded bg-slate-100 text-slate-700 shadow-inner",children:[D.length," poste",D.length>1?"s":""]})]}),e&&t("div",{className:"text-sm text-gray-500 mt-1",children:e}),D.length===0?t(je,{children:"Aucun poste."}):t("div",{className:`\r
          grid gap-3 mt-3\r
          [grid-template-columns:repeat(auto-fit,minmax(280px,1fr))]\r
        `,children:D.map(b=>{var we,q,Ie,P;const xe=y[b.userId]||{},Oe=xe.name||b.userName||b.userEmail||b.userId,z=xe.code||b.userCode||"—",B=ae[b.id],w=(B==null?void 0:B.reservations)??b.totalReservations??0,qe=(B==null?void 0:B.tickets)??b.totalTickets??0,Z=(B==null?void 0:B.amount)??b.totalAmount??0,Pe=b.status==="active"?"En service":b.status==="paused"?"En pause":b.status==="closed"?"Clôturé":b.status==="pending"?"En attente":"Validé",Ne=b.status==="active"?"bg-green-50 text-green-700 ring-green-200":b.status==="paused"?"bg-amber-50 text-amber-700 ring-amber-200":b.status==="closed"?"bg-rose-50 text-rose-700 ring-rose-200":b.status==="pending"?"bg-indigo-50 text-indigo-700 ring-indigo-200":"bg-slate-50 text-slate-700 ring-slate-200";return s("div",{className:`\r
                group relative rounded-2xl\r
                ring-1 ring-slate-200 bg-white\r
                hover:ring-slate-300 hover:shadow-md\r
                transition-all`,children:[t("div",{className:"absolute inset-0 rounded-2xl pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity",style:{background:`linear-gradient(135deg, ${U.primary}22, ${U.secondary}22)`}}),s("div",{className:"relative p-4",children:[s("div",{className:"flex items-start justify-between gap-3",children:[s("div",{className:"min-w-0",children:[t("div",{className:"text-xs text-gray-500",children:"Guichetier"}),s("div",{className:"font-semibold truncate",children:[Oe," ",s("span",{className:"text-gray-500 text-xs",children:["(",z,")"]})]})]}),t("span",{className:`px-2 py-0.5 rounded-lg text-xs font-medium ring-1 ${Ne}`,children:Pe})]}),s("div",{className:"grid grid-cols-2 gap-3 mt-3 text-sm",children:[t(_,{label:"Début",value:b.startTime?new Date(((q=(we=b.startTime).toDate)==null?void 0:q.call(we))??b.startTime).toLocaleString("fr-FR"):"—"}),t(_,{label:"Fin",value:b.endTime?new Date(((P=(Ie=b.endTime).toDate)==null?void 0:P.call(Ie))??b.endTime).toLocaleString("fr-FR"):"—"}),t(_,{label:"Réservations",value:w.toString()}),t(_,{label:"Billets",value:qe.toString()})]}),s("div",{className:"mt-3 p-3 rounded-xl bg-slate-50/60 ring-1 ring-slate-100 flex items-center justify-between",children:[t("div",{className:"text-xs text-slate-600",children:"Montant"}),t("div",{className:"text-lg font-extrabold",style:{color:U.primary},children:O(Z)})]}),t("div",{className:"mt-3 flex items-center justify-end gap-2",children:Y(b)})]})]},b.id)})})]}),_=({label:d,value:e})=>s("div",{children:[t("div",{className:"text-xs text-gray-500",children:d}),t("div",{className:"font-medium",children:e})]}),je=({children:d})=>t("div",{className:"text-gray-500 rounded-2xl border bg-white p-6 text-center shadow-sm",children:d}),L=({children:d,align:e="left"})=>t("th",{className:`px-3 py-2 ${e==="right"?"text-right":"text-left"} font-semibold text-slate-700`,children:d}),j=({children:d,align:e="left"})=>t("td",{className:`px-3 py-2 ${e==="right"?"text-right":"text-left"}`,children:d});function ya(d){if(!d.length){alert("Aucune donnée à exporter");return}const e=["Date","Entrees","Sorties","Solde"],E=d.map(U=>[new Date(U.dateISO).toLocaleDateString("fr-FR"),U.entrees,U.sorties,U.solde].join(",")),D=[e.join(","),...E].join(`
`),y=new Blob([D],{type:"text/csv;charset=utf-8;"}),ae=URL.createObjectURL(y),Y=document.createElement("a");Y.href=ae,Y.download="caisse.csv",document.body.appendChild(Y),Y.click(),Y.remove(),URL.revokeObjectURL(ae)}export{Ca as default};
