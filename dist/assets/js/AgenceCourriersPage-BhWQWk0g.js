import{u as P,r as o,j as e}from"./react-Bg_vEni-.js";import{h as j,f as b,q,w as C}from"./firebase-C3aZpI0W.js";import{u as G,d as f}from"../index-Dgt8Lr4V.js";import{h as z}from"./html2pdf-DbS8s3Ae.js";import{u as w,w as Q}from"./xlsx-5rFX-EW9.js";import"./vendor-D_4iK-Jm.js";import"./jspdf.es.min-3c6yj3HK.js";import"./html2canvas-BsqIyKfB.js";const Z=()=>{const{user:a}=G(),I=P(),g=o.useRef(null),[h,E]=o.useState(""),[x,T]=o.useState(""),[c,y]=o.useState(""),[v,k]=o.useState([]),[S,D]=o.useState([]),[p,m]=o.useState(""),[u,N]=o.useState([]),[U,R]=o.useState(null),n=t=>t.trim().toLowerCase(),_=()=>{const t=new Date;return Array.from({length:8},(d,l)=>{const s=new Date(t);return s.setDate(t.getDate()+l),s.toISOString().split("T")[0]})},A=async()=>{if(!h||!x||!(a!=null&&a.companyId))return;const l=(await j(b(f,"dailyTrips"))).docs.map(r=>({id:r.id,...r.data()})).filter(r=>n(r.departure)===n(h)&&n(r.arrival)===n(x)&&r.companyId===a.companyId),s=Array.from(new Set(l.map(r=>r.date))).filter(r=>_().includes(r));k(s),s.length>0?y(s[0]):(y(""),D([]),m(""),N([]))},F=async()=>{if(!c||!(a!=null&&a.companyId))return;const l=(await j(b(f,"dailyTrips"))).docs.map(s=>({id:s.id,...s.data()})).filter(s=>n(s.departure)===n(h)&&n(s.arrival)===n(x)&&s.date===c&&s.companyId===a.companyId).filter(s=>s.time).map(s=>s.time);D(l),l.length>0?m(l[0]):(m(""),N([]))},$=async()=>{if(!p||!(a!=null&&a.companyId))return;const d=(await j(b(f,"dailyTrips"))).docs.map(i=>({id:i.id,...i.data()})).filter(i=>n(i.departure)===n(h)&&n(i.arrival)===n(x)&&i.date===c&&i.time===p&&i.companyId===a.companyId);if(d.length===0)return;const l=d[0].id;R(d[0]);const s=q(b(f,"courriers"),C("trajetId","==",l),C("statut","==","payé")),O=(await j(s)).docs.map(i=>({id:i.id,...i.data()}));N(O)},L=()=>{g.current&&z().from(g.current).save(`Courriers_${c}_${p}.pdf`)},H=()=>{const t=u.map((s,r)=>({"#":r+1,Expéditeur:s.expediteur,Téléphone:s.telephone,Destinataire:s.destinataire,Lieux:`${s.depart} → ${s.arrivee}`,Référence:s.id,Type:s.canal==="guichet"?"Guichet":"En ligne"})),d=w.json_to_sheet(t),l=w.book_new();w.book_append_sheet(l,d,"Courriers"),Q(l,`Courriers_${c}_${p}.xlsx`)};return o.useEffect(()=>{c&&F()},[c]),o.useEffect(()=>{p&&$()},[p]),e.jsxs("div",{className:"p-6 bg-white min-h-screen",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Liste de Courriers"}),e.jsxs("div",{className:"flex gap-3 mb-4",children:[e.jsx("input",{type:"text",value:h,onChange:t=>E(t.target.value),placeholder:"Départ",className:"border p-2 rounded"}),e.jsx("input",{type:"text",value:x,onChange:t=>T(t.target.value),placeholder:"Arrivée",className:"border p-2 rounded"}),e.jsx("button",{onClick:A,className:"bg-yellow-500 text-white px-4 py-2 rounded",children:"Rechercher"})]}),v.length>0&&e.jsx("div",{className:"flex gap-2 flex-wrap mb-4",children:v.map(t=>e.jsx("button",{onClick:()=>y(t),className:`px-3 py-1 rounded-full text-sm border ${c===t?"bg-yellow-600 text-white":"bg-yellow-100 text-yellow-800"}`,children:t},t))}),S.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Choisir une heure :"}),e.jsx("select",{value:p,onChange:t=>m(t.target.value),className:"border p-2 rounded",children:S.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"mb-4 flex justify-between gap-3 flex-wrap",children:[e.jsx("button",{onClick:()=>I(-1),className:"text-sm text-blue-500 underline",children:"← Retour"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:L,className:"bg-green-600 text-white px-4 py-2 rounded",children:"📄 Télécharger PDF"}),e.jsx("button",{onClick:H,className:"bg-purple-600 text-white px-4 py-2 rounded",children:"📊 Exporter Excel"})]})]}),e.jsxs("div",{className:"border rounded-xl p-4",ref:g,children:[e.jsx("h2",{className:"text-center font-bold text-lg mb-2",children:"LISTE DE COLIS / COURRIERS"}),e.jsxs("div",{className:"text-center text-sm text-gray-600 mb-4",children:[c&&p&&e.jsxs("span",{children:[c," • ",p," • ",h," → ",x]}),e.jsx("br",{}),e.jsxs("span",{children:[u.length," colis"]})]}),e.jsxs("table",{className:"w-full text-sm border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border p-2",children:"#"}),e.jsx("th",{className:"border p-2",children:"Expéditeur"}),e.jsx("th",{className:"border p-2",children:"Téléphone"}),e.jsx("th",{className:"border p-2",children:"Destinataire"}),e.jsx("th",{className:"border p-2",children:"Référence"}),e.jsx("th",{className:"border p-2",children:"Type"})]})}),e.jsx("tbody",{children:u.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center p-4 text-gray-500",children:"Aucun courrier pour ce trajet."})}):u.map((t,d)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-2 text-center",children:d+1}),e.jsx("td",{className:"border p-2",children:t.expediteur}),e.jsx("td",{className:"border p-2",children:t.telephone}),e.jsx("td",{className:"border p-2",children:t.destinataire}),e.jsx("td",{className:"border p-2",children:t.id.slice(0,6)}),e.jsx("td",{className:"border p-2 text-center",children:t.canal==="guichet"?"🧾 Guichet":"🌐 En ligne"})]},t.id))})]}),e.jsx("div",{className:"mt-6 text-right text-sm italic",children:"Signature et cachet de la compagnie"})]})]})};export{Z as default};
