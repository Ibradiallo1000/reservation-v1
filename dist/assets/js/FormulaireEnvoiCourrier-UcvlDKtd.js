import{b as V,u as J,d as O,r as c,j as e,a as t,o as j,C as _,h as G,i as B,q as H,U as Q,aQ as W,aR as K}from"./react-DgrrIcw2.js";import{d as E,f as X,t as Y}from"./firebase-eGIzIftJ.js";import{d as F}from"../index-p6Te0bSg.js";import{v as Z}from"./v4-C6aID195.js";import"./vendor-BHjJ2Hjk.js";const v=(l,p=1)=>{const g=parseInt(l.slice(1,3),16),y=parseInt(l.slice(3,5),16),a=parseInt(l.slice(5,7),16);return`rgba(${g}, ${y}, ${a}, ${p})`},ee=l=>{if(l.length<7)return"#000000";const p=parseInt(l.slice(1,3),16),g=parseInt(l.slice(3,5),16),y=parseInt(l.slice(5,7),16);return(.299*p+.587*g+.114*y)/255>.5?"#000000":"#ffffff"},le=({company:l})=>{const p=V(),g=J(),{slug:y}=O(),[a,L]=c.useState(null),[d,R]=c.useState(l),[C,D]=c.useState(!1),[I,x]=c.useState(null),[h,A]=c.useState({fullName:"",phone:"",email:""}),[m,T]=c.useState(1),[q]=c.useState("aller_simple");c.useEffect(()=>{const o=async()=>{var r;try{if((r=p.state)!=null&&r.tripData){n(p.state.tripData);return}const u=sessionStorage.getItem("reservationDraft");if(u){const i=JSON.parse(u);i!=null&&i.tripData&&n(i.tripData)}if(!(l!=null&&l.id)){const i=sessionStorage.getItem("companyInfo");i&&R(f=>({...f,...JSON.parse(i)}))}}catch(u){console.error("Erreur de chargement initial:",u),x("Erreur de chargement des données")}},n=r=>{var f;const i=["id","companyId","agencyId","departure","arrival","date","time","price","places"].filter(N=>!r[N]);if(i.length>0){x(`Données de trajet incomplètes. Champs manquants: ${i.join(", ")}`);return}L({id:r.id,companyId:r.companyId,agencyId:r.agencyId,departure:r.departure,arrival:r.arrival,date:r.date,time:r.time,price:Number(r.price),places:Number(r.places),remainingSeats:Number(r.remainingSeats)||void 0}),sessionStorage.setItem("reservationDraft",JSON.stringify({tripData:r,companyInfo:((f=p.state)==null?void 0:f.companyInfo)||l}))};o()},[p.state,l]);const w=c.useMemo(()=>(a==null?void 0:a.price)||0,[a]),k=c.useMemo(()=>w*m,[w,m]),P=c.useMemo(()=>{const o=d.couleurPrimaire||"#3b82f6",n=d.couleurSecondaire||"#93c5fd";return{colors:{primary:o,secondary:n,text:ee(o),background:"#ffffff"},classes:{card:"bg-white rounded-xl shadow-sm border border-gray-200",button:"transition-all hover:scale-105 active:scale-95",animations:"transition-all duration-300 ease-in-out",header:"sticky top-0 z-50 px-4 py-3"}}},[d]),{colors:s,classes:b}=P,S=o=>{const{name:n,value:r}=o.target;A(u=>({...u,[n]:r}))},$=o=>{const n=Math.max(1,Math.min(10,o));T(n)},z=async o=>{o.preventDefault(),D(!0),x(null);try{if(!a||!a.id||!a.companyId||!a.agencyId)throw new Error("Données de trajet incomplètes. Veuillez recommencer.");if(!h.fullName||!h.phone)throw new Error("Veuillez remplir tous les champs obligatoires");if(a.remainingSeats!==void 0&&a.remainingSeats<m)throw new Error(`Il ne reste que ${a.remainingSeats} place(s) disponible(s).`);const n=Z(),r=`RES-${Date.now()}`,u=E(F,"companies",a.companyId,"agences",a.agencyId),i=await X(u),f=i.exists()?i.data():{},N={id:n,nomClient:h.fullName,telephone:h.phone,email:h.email,depart:a.departure,arrivee:a.arrival,date:a.date,heure:a.time,montant:k,seatsGo:m,seatsReturn:0,tripType:q,canal:"en_ligne",statut:"en_attente",companyId:a.companyId,agencyId:a.agencyId,agencyNom:f.nomAgence||f.nom||"",agencyTelephone:f.telephone||"",trajetId:a.id,referenceCode:r,companySlug:y,companyName:d.nom,primaryColor:d.couleurPrimaire,secondaryColor:d.couleurSecondaire,tripData:a,createdAt:new Date,updatedAt:new Date},U=E(F,"companies",a.companyId,"agences",a.agencyId,"reservations",n);await Y(U,N),sessionStorage.setItem("reservationDraft",JSON.stringify(N)),g(`/${y}/upload-preuve/${n}`,{state:{companyInfo:d,reservation:N}})}catch(n){console.error("Erreur réservation:",n),x(n.message||"Une erreur est survenue")}finally{D(!1)}},M=o=>{try{return new Date(o).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}catch{return o}};return!a||!a.id?e("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 text-center",children:t("div",{className:`p-6 rounded-lg max-w-md ${b.card}`,children:[e(j,{className:"h-12 w-12 mx-auto text-red-500 mb-4"}),e("h2",{className:"text-xl font-bold mb-2 text-gray-900",children:"Données manquantes"}),e("p",{className:"text-gray-700 mb-4",children:I||"Les informations du trajet sont introuvables. Veuillez recommencer votre recherche."}),e("button",{onClick:()=>g(`/${y}`),className:`mt-4 px-4 py-2 rounded ${b.button}`,style:{backgroundColor:s.primary,color:s.text},children:"Retour à l'accueil"})]})}):t("div",{className:"min-h-screen",style:{background:s.background},children:[e("header",{className:b.header,style:{backgroundColor:v(s.primary,.95),color:s.text,backdropFilter:"blur(10px)"},children:t("div",{className:"flex items-center gap-4 max-w-7xl mx-auto",children:[e("button",{onClick:()=>g(-1),className:"p-2 rounded-full hover:bg-white/10 transition",children:e(_,{className:"h-5 w-5"})}),t("div",{className:"flex items-center gap-2",children:[d.logoUrl&&e(G.LazyLoadImage,{src:d.logoUrl,alt:`Logo ${d.nom}`,effect:"blur",className:"h-8 w-8 rounded-full object-cover border-2",style:{borderColor:s.text}}),e("h1",{className:"text-lg font-bold",children:"Réservation"})]})]})}),t("main",{className:"max-w-4xl mx-auto p-4",children:[I&&e("div",{className:`p-4 mb-4 rounded-lg bg-red-50 text-red-600 ${b.card}`,children:t("div",{className:"flex items-center gap-2",children:[e(j,{className:"h-5 w-5"}),e("span",{children:I})]})}),e("div",{className:`p-4 rounded-xl mb-4 ${b.card}`,children:t("div",{className:"flex flex-row flex-wrap items-center justify-between gap-4",children:[t("div",{children:[t("h1",{className:"text-lg font-bold",style:{color:s.primary},children:[a.departure," → ",a.arrival]}),t("div",{className:"flex items-center gap-2 text-sm mt-1",children:[e(B,{className:"h-4 w-4 opacity-70"}),e("span",{children:M(a.date)}),e(H,{className:"h-4 w-4 opacity-70 ml-2"}),e("span",{children:a.time})]})]}),t("div",{className:"text-right",children:[e("div",{className:"text-sm opacity-80",children:"Prix unitaire"}),t("div",{className:"font-bold",children:[w.toLocaleString()," FCFA"]})]})]})}),e("div",{className:`rounded-xl overflow-hidden ${b.card}`,children:t("div",{className:"p-4",children:[e("h2",{className:"text-lg font-bold mb-4",style:{color:s.primary},children:"Informations du passager"}),t("form",{onSubmit:z,className:"space-y-4",children:[t("div",{className:"space-y-3",children:[t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Nom complet *"}),t("div",{className:"relative",children:[e(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-70"}),e("input",{type:"text",name:"fullName",value:h.fullName,onChange:S,className:"w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none",style:{borderColor:v(s.primary,.3)},required:!0,minLength:2})]})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Téléphone *"}),t("div",{className:"relative",children:[e(W,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-70"}),e("input",{type:"tel",name:"phone",value:h.phone,onChange:S,className:"w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none",style:{borderColor:v(s.primary,.3)},required:!0,pattern:"[0-9]{10,15}"})]})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Email"}),t("div",{className:"relative",children:[e(K,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-70"}),e("input",{type:"email",name:"email",value:h.email,onChange:S,className:"w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none",style:{borderColor:v(s.primary,.3)}})]})]})]}),t("div",{className:"pt-4",children:[e("h3",{className:"text-sm font-medium mb-2",children:"Nombre de places"}),e("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:t("div",{children:[e("label",{className:"block text-xs mb-1 opacity-80",children:"Aller"}),t("div",{className:"flex items-center gap-2",children:[e("button",{type:"button",onClick:()=>$(m-1),disabled:m<=1,className:"p-1 w-8 h-8 rounded-lg border hover:bg-gray-50 flex items-center justify-center disabled:opacity-50",style:{borderColor:v(s.primary,.3)},children:"-"}),e("div",{className:"flex-1 text-center font-medium py-1 border rounded-lg",style:{borderColor:v(s.primary,.2)},children:m}),e("button",{type:"button",onClick:()=>$(m+1),disabled:m>=10,className:"p-1 w-8 h-8 rounded-lg border hover:bg-gray-50 flex items-center justify-center disabled:opacity-50",style:{borderColor:v(s.primary,.3)},children:"+"})]})]})})]}),t("div",{className:"pt-4",children:[t("div",{className:"flex justify-between items-center mb-1",children:[e("span",{className:"font-medium",children:"Total:"}),t("span",{className:"text-lg font-bold",children:[k.toLocaleString()," FCFA"]})]}),t("div",{className:"text-xs text-gray-500 mb-3",children:[w.toLocaleString()," FCFA × ",m," place(s)"]}),e("button",{type:"submit",className:`w-full py-3 px-4 rounded-lg font-medium ${b.button}`,style:{backgroundColor:s.primary,color:s.text},disabled:C,children:C?t("span",{className:"flex items-center justify-center gap-2",children:[t("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Traitement..."]}):"Réserver maintenant"})]})]})]})})]})]})};export{le as default};
