import{r as s,j as e,a,F as E}from"./vendor-Bq-8_m9i.js";import{m as K,O as C,P as z,w as D,G as Q,B as w,d as x}from"./agence-Bsj2lp2X.js";import{F as I,o as A,r as U,I as _,t as H,y as J,x as V}from"./firebase-CURBI7X6.js";import{d as W,a as X}from"./router-DoGdw-3y.js";import{l as f}from"./icons-C0JHUK9Z.js";import"./compagnie-DiuZFnHS.js";import"./courier-CoQgRaHG.js";const Y=new Intl.NumberFormat("fr-FR"),Z={basic:"Basic",standard:"Standard",priority:"Prioritaire",premium:"Premium",enterprise:"Enterprise"};function le(){const c=K(),{companyId:i}=W(),b=X(),[B,u]=s.useState(!0),[y,v]=s.useState(!1),[N,g]=s.useState(null),[L,q]=s.useState(0),[m,P]=s.useState(null),[G,R]=s.useState([]),[h,M]=s.useState({}),[r,S]=s.useState(""),t=s.useMemo(()=>r?h[r]??null:null,[r,h]);s.useEffect(()=>{if(!i)return;u(!0),g(null);const n=[],T=I(A(x,"companies",i),l=>{if(l.exists()){const o={id:l.id,...l.data()};P(o),S(d=>d||o.planId||"")}else P(null);u(!1)},()=>{g(c?"Erreur lors du chargement de la compagnie.":"Connexion indisponible. Impossible de charger la compagnie."),u(!1)});n.push(T);const j=U(H(x,"plans"),_("priceMonthly","asc")),k=I(j,l=>{const o=[],d={};l.docs.forEach(p=>{const F=p.data();o.push({id:p.id,name:F.name||p.id}),d[p.id]=F}),R(o),M(d)},()=>{g(c?"Erreur lors du chargement des plans.":"Connexion indisponible. Impossible de charger les plans.")});return n.push(k),()=>n.forEach(l=>l())},[i,c,L]);async function O(){if(!i||!r)return;const n=h[r];if(n){v(!0);try{await J(A(x,"companies",i),{planId:r,plan:n.name,publicPageEnabled:!0,onlineBookingEnabled:!0,guichetEnabled:!0,digitalFeePercent:Number(n.digitalFeePercent||0),supportLevel:n.supportLevel||"basic",planType:n.isTrial?"trial":"paid",feeGuichet:Number(n.feeGuichet||0),minimumMonthly:Number(n.minimumMonthly||0),maxAgences:Number(n.maxAgences||0),updatedAt:V()}),alert("Plan appliqué à la compagnie ✅"),b(-1)}finally{v(!1)}}}return B||!m?e(z,{}):a("div",{className:"p-4 md:p-6 max-w-7xl mx-auto space-y-6",children:[!c&&e(D,{message:"Connexion instable: les données de plan peuvent être incomplètes."}),N&&e(Q,{message:N,onRetry:()=>q(n=>n+1)}),a("h1",{className:"text-2xl font-bold text-gray-900",children:["Plan & options — ",m.nom||"Compagnie"]}),a("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a("div",{children:[e("label",{className:"text-sm font-medium text-gray-700",children:"Plan (modèle)"}),a("select",{value:r,onChange:n=>S(n.target.value),className:"mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-[var(--btn-primary,#FF6600)] focus:outline-none focus:ring-2 focus:ring-[var(--btn-primary,#FF6600)]/20",children:[e("option",{value:"",children:"— Sélectionner —"}),G.map(n=>e("option",{value:n.id,children:n.name},n.id))]})]}),a("div",{children:[e("label",{className:"text-sm font-medium text-gray-700",children:"Plan actuel"}),e("div",{className:"mt-1 px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 text-sm",children:m.plan?m.plan:"—"})]})]}),t&&a("div",{className:"rounded-xl border border-gray-200 shadow-sm p-5 bg-white space-y-4",children:[a("div",{className:"flex items-center justify-between",children:[a("h3",{className:"text-lg font-semibold text-gray-900",children:["Aperçu : ",t.name]}),a("div",{className:"flex items-center gap-2",children:[t.isTrial&&e("span",{className:"inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700",children:"Essai"}),e("span",{className:"inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-700 capitalize",children:Z[t.supportLevel]??"Basic"})]})]}),a("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm",children:[a("div",{className:"rounded-lg border border-gray-200 p-3",children:[e("div",{className:"text-gray-500",children:"Prix mensuel"}),e("div",{className:"text-xl font-bold",children:t.priceMonthly===0?e("span",{className:"text-green-600",children:"Gratuit"}):e(E,{children:C(t.priceMonthly)})})]}),a("div",{className:"rounded-lg border border-gray-200 p-3",children:[e("div",{className:"text-gray-500",children:"Agences max"}),e("div",{className:"font-bold text-lg",children:(t.maxAgences??0)===0?"Illimité":t.maxAgences}),e("div",{className:"text-gray-500 mt-2",children:"Quota réservations"}),e("div",{className:"font-bold",children:(t.quotaReservations??0)===0?"Illimité":Y.format(t.quotaReservations??0)})]}),a("div",{className:"rounded-lg border border-gray-200 p-3",children:[e("div",{className:"text-gray-500",children:"Frais canal digital"}),a("div",{className:"font-bold text-lg text-[var(--btn-primary,#FF6600)]",children:[t.digitalFeePercent??0,"%"]}),(t.feeGuichet??0)>0&&a(E,{children:[e("div",{className:"text-gray-500 mt-2",children:"Frais guichet"}),a("div",{className:"font-bold",children:[C(t.feeGuichet),"/billet"]})]})]})]}),a("div",{className:"flex flex-wrap gap-2 pt-2 border-t border-gray-100",children:[a("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[e(f,{className:"h-3 w-3"})," Page publique"]}),a("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[e(f,{className:"h-3 w-3"})," Réservation en ligne"]}),a("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs text-green-700",children:[e(f,{className:"h-3 w-3"})," Guichet"]})]})]}),a("div",{className:"flex gap-3",children:[e(w,{variant:"secondary",onClick:()=>b(-1),children:"Annuler"}),e(w,{onClick:O,disabled:!r||y,variant:"primary",children:y?"Application…":"Appliquer ce plan"})]})]})}export{le as default};
